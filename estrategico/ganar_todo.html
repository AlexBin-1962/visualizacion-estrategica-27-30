
<!-- saved from url=(0090)https://alexbin-1962.github.io/visualizacion-estrategica-27-30/estrategico/ganar_todo.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="color-scheme" content="light dark"></head><body><div class="line-gutter-backdrop"></div><form autocomplete="off"><label class="line-wrap-control">Ajuste de línea<input type="checkbox" aria-label="Ajuste de línea"></label></form><table><tbody><tr><td class="line-number" value="1"></td><td class="line-content"><span class="html-doctype">&lt;!DOCTYPE html&gt;</span></td></tr><tr><td class="line-number" value="2"></td><td class="line-content"><span class="html-tag">&lt;html <span class="html-attribute-name">lang</span>="<span class="html-attribute-value">es</span>"&gt;</span></td></tr><tr><td class="line-number" value="3"></td><td class="line-content"><span class="html-tag">&lt;head&gt;</span></td></tr><tr><td class="line-number" value="4"></td><td class="line-content">  <span class="html-tag">&lt;meta <span class="html-attribute-name">charset</span>="<span class="html-attribute-value">utf-8</span>"/&gt;</span></td></tr><tr><td class="line-number" value="5"></td><td class="line-content">  <span class="html-tag">&lt;meta <span class="html-attribute-name">name</span>="<span class="html-attribute-value">viewport</span>" <span class="html-attribute-name">content</span>="<span class="html-attribute-value">width=device-width, initial-scale=1.0</span>"/&gt;</span></td></tr><tr><td class="line-number" value="6"></td><td class="line-content">  <span class="html-tag">&lt;title&gt;</span>Ganar Todo<span class="html-tag">&lt;/title&gt;</span></td></tr><tr><td class="line-number" value="7"></td><td class="line-content">  <span class="html-tag">&lt;link <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-resource-link" target="_blank" href="https://unpkg.com/leaflet/dist/leaflet.css" rel="noreferrer noopener">https://unpkg.com/leaflet/dist/leaflet.css</a>" <span class="html-attribute-name">rel</span>="<span class="html-attribute-value">stylesheet</span>"/&gt;</span></td></tr><tr><td class="line-number" value="8"></td><td class="line-content">  <span class="html-tag">&lt;script <span class="html-attribute-name">src</span>="<a class="html-attribute-value html-resource-link" target="_blank" href="https://unpkg.com/leaflet/dist/leaflet.js" rel="noreferrer noopener">https://unpkg.com/leaflet/dist/leaflet.js</a>"&gt;</span><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="9"></td><td class="line-content">  <span class="html-tag">&lt;script <span class="html-attribute-name">src</span>="<a class="html-attribute-value html-resource-link" target="_blank" href="https://cdn.jsdelivr.net/npm/chart.js" rel="noreferrer noopener">https://cdn.jsdelivr.net/npm/chart.js</a>"&gt;</span><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="10"></td><td class="line-content">  <span class="html-tag">&lt;script <span class="html-attribute-name">src</span>="<a class="html-attribute-value html-resource-link" target="_blank" href="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" rel="noreferrer noopener">https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js</a>"&gt;</span><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="11"></td><td class="line-content">  <span class="html-tag">&lt;script <span class="html-attribute-name">src</span>="<a class="html-attribute-value html-resource-link" target="_blank" href="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" rel="noreferrer noopener">https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js</a>"&gt;</span><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="12"></td><td class="line-content">  <span class="html-tag">&lt;script <span class="html-attribute-name">src</span>="<a class="html-attribute-value html-resource-link" target="_blank" href="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels" rel="noreferrer noopener">https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels</a>"&gt;</span><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="13"></td><td class="line-content">  <span class="html-tag">&lt;script <span class="html-attribute-name">src</span>="<a class="html-attribute-value html-resource-link" target="_blank" href="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js" rel="noreferrer noopener">https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js</a>"&gt;</span><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="14"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="15"></td><td class="line-content">  <span class="html-tag">&lt;style&gt;</span></td></tr><tr><td class="line-number" value="16"></td><td class="line-content">        html, body { margin:0; padding:0; height:100%; width:100%; font-family:'Segoe UI', Arial, sans-serif; background:#f4f4f4; }</td></tr><tr><td class="line-number" value="17"></td><td class="line-content">        :root{ --sidebar-w:320px; }</td></tr><tr><td class="line-number" value="18"></td><td class="line-content">        #panel-lateral{</td></tr><tr><td class="line-number" value="19"></td><td class="line-content">          position:absolute;</td></tr><tr><td class="line-number" value="20"></td><td class="line-content">          left:0; top:0; bottom:0; width:var(--sidebar-w); height:100%;</td></tr><tr><td class="line-number" value="21"></td><td class="line-content">          background: linear-gradient(180deg, #8ea3ad 0%, #dfe6e9 100%);</td></tr><tr><td class="line-number" value="22"></td><td class="line-content">          color:#2c3e50; border-right:1px solid #b2bec3;</td></tr><tr><td class="line-number" value="23"></td><td class="line-content">          display:flex; flex-direction:column; </td></tr><tr><td class="line-number" value="24"></td><td class="line-content">          box-shadow:2px 0 5px rgba(0,0,0,0.1); box-sizing:border-box; align-items:stretch;</td></tr><tr><td class="line-number" value="25"></td><td class="line-content">          z-index:2000;</td></tr><tr><td class="line-number" value="26"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="27"></td><td class="line-content">        #panel-header{ background:#b2bec3; color:#2c3e50; padding:12px 15px; display:flex; align-items:center; font-size:18px; font-weight:bold; }</td></tr><tr><td class="line-number" value="28"></td><td class="line-content">        #panel-header img{ height:32px; margin-right:10px; }</td></tr><tr><td class="line-number" value="29"></td><td class="line-content">        #map{ position:absolute; top:0; left:var(--sidebar-w); width:calc(100% - var(--sidebar-w)); height:100%; }</td></tr><tr><td class="line-number" value="30"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="31"></td><td class="line-content">        #sec-search    { position: relative; }                /* contenedor del buscador */</td></tr><tr><td class="line-number" value="32"></td><td class="line-content">        #sec-suggest   { z-index: 3000; } </td></tr><tr><td class="line-number" value="33"></td><td class="line-content">        #sec-suggest {</td></tr><tr><td class="line-number" value="34"></td><td class="line-content">          position: absolute;</td></tr><tr><td class="line-number" value="35"></td><td class="line-content">          left: 12px; right: 12px;</td></tr><tr><td class="line-number" value="36"></td><td class="line-content">          top: 46px;           /* ajusta según tu input */</td></tr><tr><td class="line-number" value="37"></td><td class="line-content">          max-height: 220px;</td></tr><tr><td class="line-number" value="38"></td><td class="line-content">          overflow: auto;</td></tr><tr><td class="line-number" value="39"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="40"></td><td class="line-content">          /* la lista queda clickeable */</td></tr><tr><td class="line-number" value="41"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="42"></td><td class="line-content">    /* Etiqueta de la SECCIÓN seleccionada (rosa tenue) */</td></tr><tr><td class="line-number" value="43"></td><td class="line-content">    .sec-label{</td></tr><tr><td class="line-number" value="44"></td><td class="line-content">      background: rgba(255, 235, 238, 0.96);  /* #ffebee */</td></tr><tr><td class="line-number" value="45"></td><td class="line-content">      border: 1px solid #e91e63;</td></tr><tr><td class="line-number" value="46"></td><td class="line-content">      color: #880e4f;</td></tr><tr><td class="line-number" value="47"></td><td class="line-content">      padding: 2px 6px;</td></tr><tr><td class="line-number" value="48"></td><td class="line-content">      border-radius: 8px;</td></tr><tr><td class="line-number" value="49"></td><td class="line-content">      font-size: 12px;</td></tr><tr><td class="line-number" value="50"></td><td class="line-content">      font-weight: 700;</td></tr><tr><td class="line-number" value="51"></td><td class="line-content">      pointer-events: none;</td></tr><tr><td class="line-number" value="52"></td><td class="line-content">      white-space: nowrap;</td></tr><tr><td class="line-number" value="53"></td><td class="line-content">      box-shadow: 0 2px 6px rgba(0,0,0,.15);</td></tr><tr><td class="line-number" value="54"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="55"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="56"></td><td class="line-content">    /* Etiquetas de SECCIONES ADYACENTES (azul/gris tenue) */</td></tr><tr><td class="line-number" value="57"></td><td class="line-content">    .sec-label-adj{</td></tr><tr><td class="line-number" value="58"></td><td class="line-content">      background: rgba(227, 242, 253, 0.94);  /* #e3f2fd */</td></tr><tr><td class="line-number" value="59"></td><td class="line-content">      border: 1px solid #64b5f6;</td></tr><tr><td class="line-number" value="60"></td><td class="line-content">      color: #0d47a1;</td></tr><tr><td class="line-number" value="61"></td><td class="line-content">      padding: 1px 5px;</td></tr><tr><td class="line-number" value="62"></td><td class="line-content">      border-radius: 8px;</td></tr><tr><td class="line-number" value="63"></td><td class="line-content">      font-size: 11px;</td></tr><tr><td class="line-number" value="64"></td><td class="line-content">      font-weight: 600;</td></tr><tr><td class="line-number" value="65"></td><td class="line-content">      pointer-events: none;</td></tr><tr><td class="line-number" value="66"></td><td class="line-content">      white-space: nowrap;</td></tr><tr><td class="line-number" value="67"></td><td class="line-content">      box-shadow: 0 1px 4px rgba(0,0,0,.12);</td></tr><tr><td class="line-number" value="68"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="69"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="70"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="71"></td><td class="line-content">    /* Panel flotante sección */</td></tr><tr><td class="line-number" value="72"></td><td class="line-content">    #sec-info {</td></tr><tr><td class="line-number" value="73"></td><td class="line-content">      position: absolute;</td></tr><tr><td class="line-number" value="74"></td><td class="line-content">      right: 16px; bottom: 16px;</td></tr><tr><td class="line-number" value="75"></td><td class="line-content">      width: 320px; max-width: 38vw; min-width: 260px;</td></tr><tr><td class="line-number" value="76"></td><td class="line-content">      background: #ffffff;</td></tr><tr><td class="line-number" value="77"></td><td class="line-content">      border: 1px solid #cfd8dc;</td></tr><tr><td class="line-number" value="78"></td><td class="line-content">      border-radius: 10px;</td></tr><tr><td class="line-number" value="79"></td><td class="line-content">      box-shadow: 0 10px 24px rgba(0,0,0,.15);</td></tr><tr><td class="line-number" value="80"></td><td class="line-content">      resize: both; overflow: auto; z-index: 4000;</td></tr><tr><td class="line-number" value="81"></td><td class="line-content">      display: none;</td></tr><tr><td class="line-number" value="82"></td><td class="line-content">      pointer-events: auto;</td></tr><tr><td class="line-number" value="83"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="84"></td><td class="line-content">    #sec-info .hdr {</td></tr><tr><td class="line-number" value="85"></td><td class="line-content">      cursor: move;</td></tr><tr><td class="line-number" value="86"></td><td class="line-content">      display:flex; align-items:center; justify-content:space-between;</td></tr><tr><td class="line-number" value="87"></td><td class="line-content">      background: linear-gradient(180deg,#eceff1,#e3f2fd);</td></tr><tr><td class="line-number" value="88"></td><td class="line-content">      padding: 8px 12px;</td></tr><tr><td class="line-number" value="89"></td><td class="line-content">      border-bottom: 1px solid #cfd8dc;</td></tr><tr><td class="line-number" value="90"></td><td class="line-content">      font-weight: 700; color: #263238;</td></tr><tr><td class="line-number" value="91"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="92"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="93"></td><td class="line-content">    #sec-info .hdr .btn-close{</td></tr><tr><td class="line-number" value="94"></td><td class="line-content">      cursor: pointer;</td></tr><tr><td class="line-number" value="95"></td><td class="line-content">      border: none; outline: none;</td></tr><tr><td class="line-number" value="96"></td><td class="line-content">      background: #ffcdd2;         /* rosa tenue */</td></tr><tr><td class="line-number" value="97"></td><td class="line-content">      color: #880e4f;</td></tr><tr><td class="line-number" value="98"></td><td class="line-content">      width: 24px; height: 24px; line-height: 24px;</td></tr><tr><td class="line-number" value="99"></td><td class="line-content">      border-radius: 6px;</td></tr><tr><td class="line-number" value="100"></td><td class="line-content">      font-size: 16px; font-weight: 800;</td></tr><tr><td class="line-number" value="101"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="102"></td><td class="line-content">    #sec-info .hdr .btn-close:hover{ background:#ef9a9a; }</td></tr><tr><td class="line-number" value="103"></td><td class="line-content">    #sec-info .body { padding: 10px 12px; color: #37474f; }</td></tr><tr><td class="line-number" value="104"></td><td class="line-content">    #sec-info .row  { display:flex; justify-content:space-between; margin:6px 0; }</td></tr><tr><td class="line-number" value="105"></td><td class="line-content">    #sec-info .k    { color:#607d8b; }</td></tr><tr><td class="line-number" value="106"></td><td class="line-content">    #sec-info .v    { font-weight:600; }</td></tr><tr><td class="line-number" value="107"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="108"></td><td class="line-content">    /* Toolbar básica (igual look &amp; feel) */</td></tr><tr><td class="line-number" value="109"></td><td class="line-content">    .ttb{backdrop-filter: blur(6px); background: rgba(255,255,255,.92); border-radius:12px; </td></tr><tr><td class="line-number" value="110"></td><td class="line-content">        box-shadow: 0 8px 24px rgba(0,0,0,.12); border: 1px solid #e5e7eb;}</td></tr><tr><td class="line-number" value="111"></td><td class="line-content">    .ttb-wrap{display:flex; align-items:center; gap:6px; padding:6px;}</td></tr><tr><td class="line-number" value="112"></td><td class="line-content">    .ttb-btn{background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:6px 10px; cursor:pointer;}</td></tr><tr><td class="line-number" value="113"></td><td class="line-content">    .ttb-btn:hover{background:#f8fafc}</td></tr><tr><td class="line-number" value="114"></td><td class="line-content">    .ttb-btn[disabled]{opacity:.45; cursor:not-allowed;}</td></tr><tr><td class="line-number" value="115"></td><td class="line-content">    .ttb-sep{width:1px; height:24px; background:#e5e7eb; margin:0 4px;}</td></tr><tr><td class="line-number" value="116"></td><td class="line-content">    .ttb-help{background:#eef2ff; border-color:#c7d2fe}</td></tr><tr><td class="line-number" value="117"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="118"></td><td class="line-content">    .leaflet-tooltip.at27-tt{</td></tr><tr><td class="line-number" value="119"></td><td class="line-content">      background: rgba(255,255,255,.95);</td></tr><tr><td class="line-number" value="120"></td><td class="line-content">      color:#111; border:1px solid #e5e7eb;</td></tr><tr><td class="line-number" value="121"></td><td class="line-content">      border-radius:8px; padding:6px 8px;</td></tr><tr><td class="line-number" value="122"></td><td class="line-content">      box-shadow:0 6px 18px rgba(0,0,0,.12);</td></tr><tr><td class="line-number" value="123"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="124"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="125"></td><td class="line-content">    .leaflet-tooltip.at27-tt{</td></tr><tr><td class="line-number" value="126"></td><td class="line-content">      background: rgba(255,255,255,.95);</td></tr><tr><td class="line-number" value="127"></td><td class="line-content">      color:#111; border:1px solid #e5e7eb;</td></tr><tr><td class="line-number" value="128"></td><td class="line-content">      border-radius:8px; padding:6px 8px;</td></tr><tr><td class="line-number" value="129"></td><td class="line-content">      box-shadow:0 6px 18px rgba(0,0,0,.12);</td></tr><tr><td class="line-number" value="130"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="131"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="132"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="133"></td><td class="line-content">  <span class="html-tag">&lt;/style&gt;</span></td></tr><tr><td class="line-number" value="134"></td><td class="line-content"><span class="html-tag">&lt;/head&gt;</span></td></tr><tr><td class="line-number" value="135"></td><td class="line-content"><span class="html-tag">&lt;body&gt;</span></td></tr><tr><td class="line-number" value="136"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="137"></td><td class="line-content">  </td></tr><tr><td class="line-number" value="138"></td><td class="line-content">    <span class="html-comment">&lt;!-- Barra superior --&gt;</span></td></tr><tr><td class="line-number" value="139"></td><td class="line-content">    <span class="html-tag">&lt;div <span class="html-attribute-name">id</span>="<span class="html-attribute-value">top-toolbar</span>" <span class="html-attribute-name">class</span>="<span class="html-attribute-value">ttb</span>" <span class="html-attribute-name">style</span>="<span class="html-attribute-value">position:absolute; top:12px; right:10px; z-index:5200;</span>"&gt;</span></td></tr><tr><td class="line-number" value="140"></td><td class="line-content">      <span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">ttb-wrap</span>"&gt;</span></td></tr><tr><td class="line-number" value="141"></td><td class="line-content">        <span class="html-tag">&lt;button <span class="html-attribute-name">id</span>="<span class="html-attribute-value">btn-gt-part</span>" <span class="html-attribute-name">class</span>="<span class="html-attribute-value">ttb-btn</span>" <span class="html-attribute-name">title</span>="<span class="html-attribute-value">Participación 21/24/27*</span>" <span class="html-attribute-name">type</span>="<span class="html-attribute-value">button</span>"&gt;</span></td></tr><tr><td class="line-number" value="142"></td><td class="line-content">          <span class="html-tag">&lt;span <span class="html-attribute-name">class</span>="<span class="html-attribute-value">ico</span>"&gt;</span>🗳️<span class="html-tag">&lt;/span&gt;</span><span class="html-tag">&lt;span <span class="html-attribute-name">class</span>="<span class="html-attribute-value">txt</span>"&gt;</span>Part. 21/24/27*<span class="html-tag">&lt;/span&gt;</span></td></tr><tr><td class="line-number" value="143"></td><td class="line-content">        <span class="html-tag">&lt;/button&gt;</span></td></tr><tr><td class="line-number" value="144"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="145"></td><td class="line-content">        <span class="html-tag">&lt;button <span class="html-attribute-name">id</span>="<span class="html-attribute-value">btn-estabilidad</span>" <span class="html-attribute-name">class</span>="<span class="html-attribute-value">ttb-btn</span>" <span class="html-attribute-name">title</span>="<span class="html-attribute-value">Estabilidad 2018–2024</span>" <span class="html-attribute-name">type</span>="<span class="html-attribute-value">button</span>"&gt;</span></td></tr><tr><td class="line-number" value="146"></td><td class="line-content">          <span class="html-tag">&lt;span <span class="html-attribute-name">class</span>="<span class="html-attribute-value">ico</span>"&gt;</span>🧭<span class="html-tag">&lt;/span&gt;</span><span class="html-tag">&lt;span <span class="html-attribute-name">class</span>="<span class="html-attribute-value">txt</span>"&gt;</span>Estabilidad 18–24<span class="html-tag">&lt;/span&gt;</span></td></tr><tr><td class="line-number" value="147"></td><td class="line-content">        <span class="html-tag">&lt;/button&gt;</span></td></tr><tr><td class="line-number" value="148"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="149"></td><td class="line-content">        <span class="html-tag">&lt;button <span class="html-attribute-name">id</span>="<span class="html-attribute-value">btn-gt-metas</span>" <span class="html-attribute-name">class</span>="<span class="html-attribute-value">ttb-btn</span>" <span class="html-attribute-name">title</span>="<span class="html-attribute-value">Metas de participación 2027*</span>" <span class="html-attribute-name">type</span>="<span class="html-attribute-value">button</span>"&gt;</span></td></tr><tr><td class="line-number" value="150"></td><td class="line-content">          <span class="html-tag">&lt;span <span class="html-attribute-name">class</span>="<span class="html-attribute-value">ico</span>"&gt;</span>🎯<span class="html-tag">&lt;/span&gt;</span><span class="html-tag">&lt;span <span class="html-attribute-name">class</span>="<span class="html-attribute-value">txt</span>"&gt;</span>Meta 2027*<span class="html-tag">&lt;/span&gt;</span></td></tr><tr><td class="line-number" value="151"></td><td class="line-content">        <span class="html-tag">&lt;/button&gt;</span></td></tr><tr><td class="line-number" value="152"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="153"></td><td class="line-content">        <span class="html-tag">&lt;button <span class="html-attribute-name">id</span>="<span class="html-attribute-value">btn-gt-ganar</span>" <span class="html-attribute-name">class</span>="<span class="html-attribute-value">ttb-btn</span>" <span class="html-attribute-name">title</span>="<span class="html-attribute-value">¿Qué se requiere para ganar todo?</span>" <span class="html-attribute-name">type</span>="<span class="html-attribute-value">button</span>"&gt;</span></td></tr><tr><td class="line-number" value="154"></td><td class="line-content">          <span class="html-tag">&lt;span <span class="html-attribute-name">class</span>="<span class="html-attribute-value">ico</span>"&gt;</span>🏆<span class="html-tag">&lt;/span&gt;</span><span class="html-tag">&lt;span <span class="html-attribute-name">class</span>="<span class="html-attribute-value">txt</span>"&gt;</span>Ganar todo<span class="html-tag">&lt;/span&gt;</span></td></tr><tr><td class="line-number" value="155"></td><td class="line-content">        <span class="html-tag">&lt;/button&gt;</span></td></tr><tr><td class="line-number" value="156"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="157"></td><td class="line-content">        <span class="html-tag">&lt;button <span class="html-attribute-name">id</span>="<span class="html-attribute-value">btn-recentrar</span>" <span class="html-attribute-name">class</span>="<span class="html-attribute-value">ttb-btn</span>" <span class="html-attribute-name">title</span>="<span class="html-attribute-value">Recentrar universo (R)</span>" <span class="html-attribute-name">type</span>="<span class="html-attribute-value">button</span>"&gt;</span></td></tr><tr><td class="line-number" value="158"></td><td class="line-content">          Recentrar</td></tr><tr><td class="line-number" value="159"></td><td class="line-content">        <span class="html-tag">&lt;/button&gt;</span></td></tr><tr><td class="line-number" value="160"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="161"></td><td class="line-content">        <span class="html-tag">&lt;button <span class="html-attribute-name">id</span>="<span class="html-attribute-value">btn-prob-volteo</span>" <span class="html-attribute-name">class</span>="<span class="html-attribute-value">ttb-btn</span>" <span class="html-attribute-name">title</span>="<span class="html-attribute-value">Probabilidad de voltear 2027</span>"&gt;</span></td></tr><tr><td class="line-number" value="162"></td><td class="line-content">          Voltear 2027</td></tr><tr><td class="line-number" value="163"></td><td class="line-content">        <span class="html-tag">&lt;/button&gt;</span></td></tr><tr><td class="line-number" value="164"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="165"></td><td class="line-content">        <span class="html-tag">&lt;button <span class="html-attribute-name">id</span>="<span class="html-attribute-value">btn-plan-mayoria</span>" <span class="html-attribute-name">class</span>="<span class="html-attribute-value">ttb-btn</span>" <span class="html-attribute-name">title</span>="<span class="html-attribute-value">Mínimo de votos para mayoría</span>"&gt;</span></td></tr><tr><td class="line-number" value="166"></td><td class="line-content">          Plan mayoría</td></tr><tr><td class="line-number" value="167"></td><td class="line-content">        <span class="html-tag">&lt;/button&gt;</span></td></tr><tr><td class="line-number" value="168"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="169"></td><td class="line-content">        <span class="html-tag">&lt;button <span class="html-attribute-name">id</span>="<span class="html-attribute-value">btn-eficiencia-voto</span>" <span class="html-attribute-name">class</span>="<span class="html-attribute-value">ttb-btn</span>" <span class="html-attribute-name">title</span>="<span class="html-attribute-value">Eficiencia del voto (votos ociosos)</span>"&gt;</span></td></tr><tr><td class="line-number" value="170"></td><td class="line-content">          Eficiencia voto</td></tr><tr><td class="line-number" value="171"></td><td class="line-content">        <span class="html-tag">&lt;/button&gt;</span></td></tr><tr><td class="line-number" value="172"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="173"></td><td class="line-content">        <span class="html-tag">&lt;button <span class="html-attribute-name">id</span>="<span class="html-attribute-value">btn-corredores-volteo</span>" <span class="html-attribute-name">class</span>="<span class="html-attribute-value">ttb-btn</span>" <span class="html-attribute-name">title</span>="<span class="html-attribute-value">Corredores de volteo (clusters)</span>"&gt;</span></td></tr><tr><td class="line-number" value="174"></td><td class="line-content">          Corredores</td></tr><tr><td class="line-number" value="175"></td><td class="line-content">        <span class="html-tag">&lt;/button&gt;</span></td></tr><tr><td class="line-number" value="176"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="177"></td><td class="line-content">        <span class="html-tag">&lt;button <span class="html-attribute-name">id</span>="<span class="html-attribute-value">btn-alertas-riesgo</span>" <span class="html-attribute-name">class</span>="<span class="html-attribute-value">ttb-btn</span>" <span class="html-attribute-name">title</span>="<span class="html-attribute-value">Alertas de riesgo (bastiones en caída)</span>"&gt;</span></td></tr><tr><td class="line-number" value="178"></td><td class="line-content">          Alertas</td></tr><tr><td class="line-number" value="179"></td><td class="line-content">        <span class="html-tag">&lt;/button&gt;</span></td></tr><tr><td class="line-number" value="180"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="181"></td><td class="line-content">        <span class="html-tag">&lt;button <span class="html-attribute-name">id</span>="<span class="html-attribute-value">btn-simulador-impulso</span>" <span class="html-attribute-name">class</span>="<span class="html-attribute-value">ttb-btn</span>" <span class="html-attribute-name">title</span>="<span class="html-attribute-value">Simulador de impulso</span>"&gt;</span></td></tr><tr><td class="line-number" value="182"></td><td class="line-content">          Impulso</td></tr><tr><td class="line-number" value="183"></td><td class="line-content">        <span class="html-tag">&lt;/button&gt;</span></td></tr><tr><td class="line-number" value="184"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="185"></td><td class="line-content">        <span class="html-tag">&lt;button <span class="html-attribute-name">id</span>="<span class="html-attribute-value">btn-brecha</span>" <span class="html-attribute-name">class</span>="<span class="html-attribute-value">ttb-btn</span>" <span class="html-attribute-name">title</span>="<span class="html-attribute-value">Mapa de brecha (pp / votos)</span>"&gt;</span></td></tr><tr><td class="line-number" value="186"></td><td class="line-content">          Brecha pp/votos</td></tr><tr><td class="line-number" value="187"></td><td class="line-content">        <span class="html-tag">&lt;/button&gt;</span></td></tr><tr><td class="line-number" value="188"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="189"></td><td class="line-content">        <span class="html-tag">&lt;button <span class="html-attribute-name">id</span>="<span class="html-attribute-value">btn-sensibilidad-participacion</span>" <span class="html-attribute-name">class</span>="<span class="html-attribute-value">ttb-btn</span>" <span class="html-attribute-name">title</span>="<span class="html-attribute-value">Sensibilidad a participación (±pp)</span>"&gt;</span></td></tr><tr><td class="line-number" value="190"></td><td class="line-content">          Sensibilidad p%</td></tr><tr><td class="line-number" value="191"></td><td class="line-content">        <span class="html-tag">&lt;/button&gt;</span></td></tr><tr><td class="line-number" value="192"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="193"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="194"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="195"></td><td class="line-content">        <span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">ttb-sep</span>"&gt;</span><span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="196"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="197"></td><td class="line-content">        <span class="html-tag">&lt;button <span class="html-attribute-name">id</span>="<span class="html-attribute-value">btn-ayuda</span>" <span class="html-attribute-name">class</span>="<span class="html-attribute-value">ttb-btn ttb-help</span>" <span class="html-attribute-name">title</span>="<span class="html-attribute-value">Ayuda (?)</span>" <span class="html-attribute-name">type</span>="<span class="html-attribute-value">button</span>"&gt;</span></td></tr><tr><td class="line-number" value="198"></td><td class="line-content">          <span class="html-tag">&lt;span <span class="html-attribute-name">class</span>="<span class="html-attribute-value">ico</span>"&gt;</span>❓<span class="html-tag">&lt;/span&gt;</span><span class="html-tag">&lt;span <span class="html-attribute-name">class</span>="<span class="html-attribute-value">txt</span>"&gt;</span>Ayuda<span class="html-tag">&lt;/span&gt;</span></td></tr><tr><td class="line-number" value="199"></td><td class="line-content">        <span class="html-tag">&lt;/button&gt;</span></td></tr><tr><td class="line-number" value="200"></td><td class="line-content">      <span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="201"></td><td class="line-content">    <span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="202"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="203"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="204"></td><td class="line-content">  <span class="html-tag">&lt;div <span class="html-attribute-name">id</span>="<span class="html-attribute-value">panel-lateral</span>"&gt;</span></td></tr><tr><td class="line-number" value="205"></td><td class="line-content">    <span class="html-tag">&lt;div <span class="html-attribute-name">id</span>="<span class="html-attribute-value">panel-header</span>"&gt;</span></td></tr><tr><td class="line-number" value="206"></td><td class="line-content">      <span class="html-comment">&lt;!-- &lt;img src="assets/img/logo.png" alt="Logo"/&gt; --&gt;</span></td></tr><tr><td class="line-number" value="207"></td><td class="line-content">      <span class="html-tag">&lt;span&gt;</span>Ganar Todo<span class="html-tag">&lt;/span&gt;</span></td></tr><tr><td class="line-number" value="208"></td><td class="line-content">    <span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="209"></td><td class="line-content">    <span class="html-comment">&lt;!-- Aquí va el contenido del panel lateral --&gt;</span></td></tr><tr><td class="line-number" value="210"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="211"></td><td class="line-content">    <span class="html-comment">&lt;!-- Buscador de secciones --&gt;</span></td></tr><tr><td class="line-number" value="212"></td><td class="line-content">    <span class="html-tag">&lt;div <span class="html-attribute-name">id</span>="<span class="html-attribute-value">sec-search</span>" <span class="html-attribute-name">style</span>="<span class="html-attribute-value">padding:10px 12px; border-top:1px solid #cbd5e1; background:#eef2f7</span>"&gt;</span></td></tr><tr><td class="line-number" value="213"></td><td class="line-content">      <span class="html-tag">&lt;div <span class="html-attribute-name">style</span>="<span class="html-attribute-value">display:flex; gap:8px; align-items:center;</span>"&gt;</span></td></tr><tr><td class="line-number" value="214"></td><td class="line-content">        <span class="html-tag">&lt;input <span class="html-attribute-name">id</span>="<span class="html-attribute-value">sec-q</span>" <span class="html-attribute-name">type</span>="<span class="html-attribute-value">text</span>" <span class="html-attribute-name">placeholder</span>="<span class="html-attribute-value">Buscar sección (ej. 1234 o '1234 León')</span>" <span class="html-attribute-name">autocomplete</span>="<span class="html-attribute-value">off</span>" <span class="html-attribute-name">autocorrect</span>="<span class="html-attribute-value">off</span>" <span class="html-attribute-name">spellcheck</span>="<span class="html-attribute-value">false</span>" <span class="html-attribute-name">enterkeyhint</span>="<span class="html-attribute-value">search</span>"</span></td></tr><tr><td class="line-number" value="215"></td><td class="line-content">              <span class="html-attribute-name">style</span>="<span class="html-attribute-value">flex:1; padding:6px 8px; border:1px solid #94a3b8; border-radius:6px;</span>"&gt;</td></tr><tr><td class="line-number" value="216"></td><td class="line-content">        <span class="html-tag">&lt;label <span class="html-attribute-name">style</span>="<span class="html-attribute-value">white-space:nowrap; font-size:12px;</span>"&gt;</span></td></tr><tr><td class="line-number" value="217"></td><td class="line-content">          <span class="html-tag">&lt;input <span class="html-attribute-name">id</span>="<span class="html-attribute-value">sec-global</span>" <span class="html-attribute-name">type</span>="<span class="html-attribute-value">checkbox</span>"&gt;</span> Todo el estado</td></tr><tr><td class="line-number" value="218"></td><td class="line-content">        <span class="html-tag">&lt;/label&gt;</span></td></tr><tr><td class="line-number" value="219"></td><td class="line-content">      <span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="220"></td><td class="line-content">      <span class="html-tag">&lt;ul <span class="html-attribute-name">id</span>="<span class="html-attribute-value">sec-suggest</span>" <span class="html-attribute-name">style</span>="<span class="html-attribute-value">margin:8px 0 0 0; padding:0; list-style:none; max-height:180px; overflow:auto;</span></span></td></tr><tr><td class="line-number" value="221"></td><td class="line-content"><span class="html-tag"><span class="html-attribute-value">                                  border:1px solid #cbd5e1; border-radius:6px; background:#fff; display:none;</span>"&gt;</span><span class="html-tag">&lt;/ul&gt;</span></td></tr><tr><td class="line-number" value="222"></td><td class="line-content">    <span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="223"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="224"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="225"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="226"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="227"></td><td class="line-content">    <span class="html-comment">&lt;!-- Panel flotante de info de sección --&gt;</span></td></tr><tr><td class="line-number" value="228"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="229"></td><td class="line-content">    <span class="html-tag">&lt;div <span class="html-attribute-name">id</span>="<span class="html-attribute-value">mini-universe</span>" <span class="html-attribute-name">style</span>="<span class="html-attribute-value">padding:12px 12px 6px 12px; background:#eef2f7; border-top:1px solid #cbd5e1</span>"&gt;</span></td></tr><tr><td class="line-number" value="230"></td><td class="line-content">        <span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">row</span>" <span class="html-attribute-name">style</span>="<span class="html-attribute-value">margin-bottom:8px</span>"&gt;</span></td></tr><tr><td class="line-number" value="231"></td><td class="line-content">            <span class="html-tag">&lt;label&gt;</span><span class="html-tag">&lt;input <span class="html-attribute-name">type</span>="<span class="html-attribute-value">checkbox</span>" <span class="html-attribute-name">id</span>="<span class="html-attribute-value">mini-all-state</span>"&gt;</span> Estado completo<span class="html-tag">&lt;/label&gt;</span></td></tr><tr><td class="line-number" value="232"></td><td class="line-content">        <span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="233"></td><td class="line-content">        <span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">row</span>" <span class="html-attribute-name">style</span>="<span class="html-attribute-value">margin-bottom:8px</span>"&gt;</span></td></tr><tr><td class="line-number" value="234"></td><td class="line-content">            <span class="html-tag">&lt;label&gt;</span>Municipio<span class="html-tag">&lt;/label&gt;</span></td></tr><tr><td class="line-number" value="235"></td><td class="line-content">            <span class="html-tag">&lt;select <span class="html-attribute-name">id</span>="<span class="html-attribute-value">mini-sel-mun</span>" <span class="html-attribute-name">style</span>="<span class="html-attribute-value">width:100%;padding:6px</span>"&gt;</span><span class="html-tag">&lt;option <span class="html-attribute-name">value</span>=""&gt;</span>— Ninguno —<span class="html-tag">&lt;/option&gt;</span><span class="html-tag">&lt;/select&gt;</span></td></tr><tr><td class="line-number" value="236"></td><td class="line-content">        <span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="237"></td><td class="line-content">        <span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">row</span>" <span class="html-attribute-name">style</span>="<span class="html-attribute-value">margin-bottom:8px</span>"&gt;</span></td></tr><tr><td class="line-number" value="238"></td><td class="line-content">            <span class="html-tag">&lt;label&gt;</span>Distrito Federal<span class="html-tag">&lt;/label&gt;</span></td></tr><tr><td class="line-number" value="239"></td><td class="line-content">            <span class="html-tag">&lt;select <span class="html-attribute-name">id</span>="<span class="html-attribute-value">mini-sel-df</span>" <span class="html-attribute-name">style</span>="<span class="html-attribute-value">width:100%;padding:6px</span>"&gt;</span><span class="html-tag">&lt;option <span class="html-attribute-name">value</span>=""&gt;</span>— Ninguno —<span class="html-tag">&lt;/option&gt;</span><span class="html-tag">&lt;/select&gt;</span></td></tr><tr><td class="line-number" value="240"></td><td class="line-content">        <span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="241"></td><td class="line-content">        <span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">row</span>" <span class="html-attribute-name">style</span>="<span class="html-attribute-value">margin-bottom:8px</span>"&gt;</span></td></tr><tr><td class="line-number" value="242"></td><td class="line-content">            <span class="html-tag">&lt;label&gt;</span>Distrito Local<span class="html-tag">&lt;/label&gt;</span></td></tr><tr><td class="line-number" value="243"></td><td class="line-content">            <span class="html-tag">&lt;select <span class="html-attribute-name">id</span>="<span class="html-attribute-value">mini-sel-dl</span>" <span class="html-attribute-name">style</span>="<span class="html-attribute-value">width:100%;padding:6px</span>"&gt;</span><span class="html-tag">&lt;option <span class="html-attribute-name">value</span>=""&gt;</span>— Ninguno —<span class="html-tag">&lt;/option&gt;</span><span class="html-tag">&lt;/select&gt;</span></td></tr><tr><td class="line-number" value="244"></td><td class="line-content">        <span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="245"></td><td class="line-content">        <span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">hint</span>" <span class="html-attribute-name">style</span>="<span class="html-attribute-value">font-size:12px;color:#64748b</span>"&gt;</span>Elige solo uno. Al cambiar, el mapa se actualiza.<span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="246"></td><td class="line-content">    <span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="247"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="248"></td><td class="line-content">  <span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="249"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="250"></td><td class="line-content">  <span class="html-tag">&lt;div <span class="html-attribute-name">id</span>="<span class="html-attribute-value">gt-consultas</span>" <span class="html-attribute-name">style</span>="<span class="html-attribute-value">padding:12px; border-top:1px solid #cbd5e1; background:#f8fafc</span>"&gt;</span></td></tr><tr><td class="line-number" value="251"></td><td class="line-content">    <span class="html-tag">&lt;div <span class="html-attribute-name">style</span>="<span class="html-attribute-value">font-weight:700; margin-bottom:8px;</span>"&gt;</span>Ganar Todo · Consultas<span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="252"></td><td class="line-content">    <span class="html-tag">&lt;button <span class="html-attribute-name">id</span>="<span class="html-attribute-value">btn-gt-part</span>" <span class="html-attribute-name">style</span>="<span class="html-attribute-value">width:100%; padding:8px; border:1px solid #cbd5e1; border-radius:8px; background:#fff; cursor:pointer;</span>"&gt;</span></td></tr><tr><td class="line-number" value="253"></td><td class="line-content">      🗳️ Participación 21/24/27*</td></tr><tr><td class="line-number" value="254"></td><td class="line-content">    <span class="html-tag">&lt;/button&gt;</span></td></tr><tr><td class="line-number" value="255"></td><td class="line-content">  <span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="256"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="257"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="258"></td><td class="line-content">  <span class="html-tag">&lt;div <span class="html-attribute-name">id</span>="<span class="html-attribute-value">map</span>"&gt;</span><span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="259"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="260"></td><td class="line-content">  <span class="html-comment">&lt;!-- === SCRIPT ÚNICO === --&gt;</span></td></tr><tr><td class="line-number" value="261"></td><td class="line-content">  <span class="html-tag">&lt;script&gt;</span></td></tr><tr><td class="line-number" value="262"></td><td class="line-content">  // ===== 0) Campos (ajusta si tus nombres son distintos) =====</td></tr><tr><td class="line-number" value="263"></td><td class="line-content">  // DL = Distrito Local, DF = Distrito Federal</td></tr><tr><td class="line-number" value="264"></td><td class="line-content">    const FIELD_KEYS = { mun: 'MUNICIPIO', dl: 'DISTRITO_L', df: 'DISTRITO_F' };</td></tr><tr><td class="line-number" value="265"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="266"></td><td class="line-content">    const paths = JSON.parse(localStorage.getItem('AT_PATHS')||'{}');</td></tr><tr><td class="line-number" value="267"></td><td class="line-content">    const urlGeo = paths.geo || 'data/geo/secciones.geojson';</td></tr><tr><td class="line-number" value="268"></td><td class="line-content">    const catUrl = paths.catalog || 'data/catalogo_territorial.json';</td></tr><tr><td class="line-number" value="269"></td><td class="line-content">    const ELP = paths.electoral?.P || 'data/electoral/P.json';</td></tr><tr><td class="line-number" value="270"></td><td class="line-content">  // ...</td></tr><tr><td class="line-number" value="271"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="272"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="273"></td><td class="line-content">  // Adapter: usa tus JSON electorales del propio archivo</td></tr><tr><td class="line-number" value="274"></td><td class="line-content">  window.loadPuesto = window.loadPuesto || getElectData;</td></tr><tr><td class="line-number" value="275"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="276"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="277"></td><td class="line-content">  // ===== 1) Mapa único y chequeo =====</td></tr><tr><td class="line-number" value="278"></td><td class="line-content">  function ensureLeafletMap() {</td></tr><tr><td class="line-number" value="279"></td><td class="line-content">    if (window.__AT_MAP &amp;&amp; window.__AT_MAP instanceof L.Map) return window.__AT_MAP;</td></tr><tr><td class="line-number" value="280"></td><td class="line-content">    const m = L.map('map', { zoomControl:true }).setView([21.0, -101.3], 7);</td></tr><tr><td class="line-number" value="281"></td><td class="line-content">    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'© OSM' }).addTo(m);</td></tr><tr><td class="line-number" value="282"></td><td class="line-content">    window.__AT_MAP = m;</td></tr><tr><td class="line-number" value="283"></td><td class="line-content">    return m;</td></tr><tr><td class="line-number" value="284"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="285"></td><td class="line-content">  function assertIsLeafletMap(m) {</td></tr><tr><td class="line-number" value="286"></td><td class="line-content">    if (!(m instanceof L.Map) || typeof m.addLayer !== 'function') {</td></tr><tr><td class="line-number" value="287"></td><td class="line-content">      throw new Error('[AT] addTo(): destino no es un Leaflet Map. Revisa variables llamadas "map" o dobles inicializaciones.');</td></tr><tr><td class="line-number" value="288"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="289"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="290"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="291"></td><td class="line-content">  function closeSecInfoPanel(){</td></tr><tr><td class="line-number" value="292"></td><td class="line-content">    const box = document.getElementById('sec-info');</td></tr><tr><td class="line-number" value="293"></td><td class="line-content">    if (box) box.style.display = 'none';</td></tr><tr><td class="line-number" value="294"></td><td class="line-content">    // Si quieres limpiar resaltado y etiquetas al cerrar:</td></tr><tr><td class="line-number" value="295"></td><td class="line-content">    if (typeof clearSectionOverlays === 'function') clearSectionOverlays();</td></tr><tr><td class="line-number" value="296"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="297"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="298"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="299"></td><td class="line-content">  function ensureSecInfoPanelWired(){</td></tr><tr><td class="line-number" value="300"></td><td class="line-content">  const box = document.getElementById('sec-info');</td></tr><tr><td class="line-number" value="301"></td><td class="line-content">  const hdr = box?.querySelector('.hdr');</td></tr><tr><td class="line-number" value="302"></td><td class="line-content">  if (!box || !hdr || box.__wired) return;</td></tr><tr><td class="line-number" value="303"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="304"></td><td class="line-content">  // Bloquear propagación al mapa (no “parpadea” al arrastrar)</td></tr><tr><td class="line-number" value="305"></td><td class="line-content">  if (window.L &amp;&amp; L.DomEvent){</td></tr><tr><td class="line-number" value="306"></td><td class="line-content">    L.DomEvent.disableClickPropagation(box);</td></tr><tr><td class="line-number" value="307"></td><td class="line-content">    L.DomEvent.disableScrollPropagation(box);</td></tr><tr><td class="line-number" value="308"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="309"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="310"></td><td class="line-content">  // Drag del panel</td></tr><tr><td class="line-number" value="311"></td><td class="line-content">  let dragging = false, sx=0, sy=0, bx=0, by=0;</td></tr><tr><td class="line-number" value="312"></td><td class="line-content">  hdr.addEventListener('mousedown', (e)=&gt;{</td></tr><tr><td class="line-number" value="313"></td><td class="line-content">    if (e.target.closest('.btn-close')) return; // no iniciar drag si clic en "×"</td></tr><tr><td class="line-number" value="314"></td><td class="line-content">    e.preventDefault(); e.stopPropagation();</td></tr><tr><td class="line-number" value="315"></td><td class="line-content">    dragging = true;</td></tr><tr><td class="line-number" value="316"></td><td class="line-content">    const r = box.getBoundingClientRect();</td></tr><tr><td class="line-number" value="317"></td><td class="line-content">    sx = e.clientX; sy = e.clientY; bx = r.left; by = r.top;</td></tr><tr><td class="line-number" value="318"></td><td class="line-content">    box.style.position = 'absolute'; box.style.right='auto'; box.style.bottom='auto';</td></tr><tr><td class="line-number" value="319"></td><td class="line-content">    document.body.style.userSelect = 'none';</td></tr><tr><td class="line-number" value="320"></td><td class="line-content">  });</td></tr><tr><td class="line-number" value="321"></td><td class="line-content">  window.addEventListener('mousemove', (e)=&gt;{</td></tr><tr><td class="line-number" value="322"></td><td class="line-content">    if (!dragging) return;</td></tr><tr><td class="line-number" value="323"></td><td class="line-content">    e.preventDefault(); e.stopPropagation();</td></tr><tr><td class="line-number" value="324"></td><td class="line-content">    const dx = e.clientX - sx, dy = e.clientY - sy;</td></tr><tr><td class="line-number" value="325"></td><td class="line-content">    box.style.left = (bx + dx) + 'px';</td></tr><tr><td class="line-number" value="326"></td><td class="line-content">    box.style.top  = (by + dy) + 'px';</td></tr><tr><td class="line-number" value="327"></td><td class="line-content">  });</td></tr><tr><td class="line-number" value="328"></td><td class="line-content">  window.addEventListener('mouseup', ()=&gt;{</td></tr><tr><td class="line-number" value="329"></td><td class="line-content">    if (!dragging) return;</td></tr><tr><td class="line-number" value="330"></td><td class="line-content">    dragging = false; document.body.style.userSelect = '';</td></tr><tr><td class="line-number" value="331"></td><td class="line-content">  });</td></tr><tr><td class="line-number" value="332"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="333"></td><td class="line-content">  // Botón “×”</td></tr><tr><td class="line-number" value="334"></td><td class="line-content">  const btn = document.getElementById('sec-close');</td></tr><tr><td class="line-number" value="335"></td><td class="line-content">  if (btn &amp;&amp; !btn.__wired){</td></tr><tr><td class="line-number" value="336"></td><td class="line-content">    btn.addEventListener('click', (e)=&gt;{ e.preventDefault(); e.stopPropagation(); closeSecInfoPanel(); });</td></tr><tr><td class="line-number" value="337"></td><td class="line-content">    btn.__wired = true;</td></tr><tr><td class="line-number" value="338"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="339"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="340"></td><td class="line-content">  box.__wired = true;</td></tr><tr><td class="line-number" value="341"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="342"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="343"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="344"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="345"></td><td class="line-content">  // ===== 2) Filtrado por universo =====</td></tr><tr><td class="line-number" value="346"></td><td class="line-content">  function toComp(v){ if(v==null) return ''; const s=String(v).trim(); return (isFinite(s) &amp;&amp; s!=='') ? Number(s) : s.toUpperCase(); }</td></tr><tr><td class="line-number" value="347"></td><td class="line-content">  function matches(props, u){</td></tr><tr><td class="line-number" value="348"></td><td class="line-content">    if(u.scope==='ALL') return true;</td></tr><tr><td class="line-number" value="349"></td><td class="line-content">    const keyField = u.scope==='MUN' ? FIELD_KEYS.mun : (u.scope==='DL' ? FIELD_KEYS.dl : FIELD_KEYS.df);</td></tr><tr><td class="line-number" value="350"></td><td class="line-content">    return toComp(props?.[keyField]) === toComp(u.key);</td></tr><tr><td class="line-number" value="351"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="352"></td><td class="line-content">  function filterGeojson(geojson, u){</td></tr><tr><td class="line-number" value="353"></td><td class="line-content">    if(u.scope==='ALL') return geojson;</td></tr><tr><td class="line-number" value="354"></td><td class="line-content">    const features = (geojson.features || []).filter(f =&gt; matches(f.properties, u));</td></tr><tr><td class="line-number" value="355"></td><td class="line-content">    return { ...geojson, features };</td></tr><tr><td class="line-number" value="356"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="357"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="358"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="359"></td><td class="line-content">  // ====== CARGA ELECTORAL (para obtener 24DL_LN) ======</td></tr><tr><td class="line-number" value="360"></td><td class="line-content">  function getPaths(){ try{ return JSON.parse(localStorage.getItem('AT_PATHS')||'{}'); }catch{ return {}; } }</td></tr><tr><td class="line-number" value="361"></td><td class="line-content">  function getPuestoPath(p){ const paths = getPaths(); return paths?.electoral?.[p] || `data/electoral/${p}.json`; }</td></tr><tr><td class="line-number" value="362"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="363"></td><td class="line-content">  window.AT_ELECT = window.AT_ELECT || {};</td></tr><tr><td class="line-number" value="364"></td><td class="line-content">  async function getElectData(puesto){</td></tr><tr><td class="line-number" value="365"></td><td class="line-content">    if (window.AT_ELECT[puesto]) return window.AT_ELECT[puesto];</td></tr><tr><td class="line-number" value="366"></td><td class="line-content">    const res = await fetch(getPuestoPath(puesto));</td></tr><tr><td class="line-number" value="367"></td><td class="line-content">    if (!res.ok) throw new Error(`HTTP ${res.status} en ${puesto}`);</td></tr><tr><td class="line-number" value="368"></td><td class="line-content">    const js = await res.json();</td></tr><tr><td class="line-number" value="369"></td><td class="line-content">    window.AT_ELECT[puesto] = js;</td></tr><tr><td class="line-number" value="370"></td><td class="line-content">    return js;</td></tr><tr><td class="line-number" value="371"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="372"></td><td class="line-content">  // LN para 2024 desde DL; si no hay, intenta P (fallback)</td></tr><tr><td class="line-number" value="373"></td><td class="line-content">  async function getLN24DL(sec){</td></tr><tr><td class="line-number" value="374"></td><td class="line-content">    const key = String(sec);</td></tr><tr><td class="line-number" value="375"></td><td class="line-content">    try {</td></tr><tr><td class="line-number" value="376"></td><td class="line-content">      const dl = await getElectData('DL');</td></tr><tr><td class="line-number" value="377"></td><td class="line-content">      const ln = dl?.secciones?.[key]?.["2024"]?.LN;</td></tr><tr><td class="line-number" value="378"></td><td class="line-content">      if (typeof ln === 'number') return ln;</td></tr><tr><td class="line-number" value="379"></td><td class="line-content">    } catch(_){}</td></tr><tr><td class="line-number" value="380"></td><td class="line-content">    try {</td></tr><tr><td class="line-number" value="381"></td><td class="line-content">      const p = await getElectData('P');</td></tr><tr><td class="line-number" value="382"></td><td class="line-content">      const ln = p?.secciones?.[key]?.["2024"]?.LN;</td></tr><tr><td class="line-number" value="383"></td><td class="line-content">      if (typeof ln === 'number') return ln;</td></tr><tr><td class="line-number" value="384"></td><td class="line-content">    } catch(_){}</td></tr><tr><td class="line-number" value="385"></td><td class="line-content">    return null;</td></tr><tr><td class="line-number" value="386"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="387"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="388"></td><td class="line-content">  // ====== ADYACENCIAS (Turf) ======</td></tr><tr><td class="line-number" value="389"></td><td class="line-content">  function bboxIntersects(b1, b2){</td></tr><tr><td class="line-number" value="390"></td><td class="line-content">    return !(b2[0] &gt; b1[2] || b2[2] &lt; b1[0] || b2[1] &gt; b1[3] || b2[3] &lt; b1[1]);</td></tr><tr><td class="line-number" value="391"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="392"></td><td class="line-content">  function getAdjacents(feat){</td></tr><tr><td class="line-number" value="393"></td><td class="line-content">    const all = (window.AT_DATA?.features)</td></tr><tr><td class="line-number" value="394"></td><td class="line-content">            || (window.AT_CTX?.layer?.toGeoJSON?.()?.features)</td></tr><tr><td class="line-number" value="395"></td><td class="line-content">            || [];</td></tr><tr><td class="line-number" value="396"></td><td class="line-content">    if (!all.length) return [];</td></tr><tr><td class="line-number" value="397"></td><td class="line-content">    const b1 = turf.bbox(feat);</td></tr><tr><td class="line-number" value="398"></td><td class="line-content">    const out = [];</td></tr><tr><td class="line-number" value="399"></td><td class="line-content">    const sec1 = feat.properties?.SECCION;</td></tr><tr><td class="line-number" value="400"></td><td class="line-content">    for (const f of all){</td></tr><tr><td class="line-number" value="401"></td><td class="line-content">      const p = f.properties || {};</td></tr><tr><td class="line-number" value="402"></td><td class="line-content">      if (p.SECCION === sec1) continue;</td></tr><tr><td class="line-number" value="403"></td><td class="line-content">      const b2 = turf.bbox(f);</td></tr><tr><td class="line-number" value="404"></td><td class="line-content">      if (!bboxIntersects(b1,b2)) continue;</td></tr><tr><td class="line-number" value="405"></td><td class="line-content">      try {</td></tr><tr><td class="line-number" value="406"></td><td class="line-content">        if (turf.booleanTouches(feat, f) || turf.booleanOverlap(feat, f) || turf.booleanIntersects(feat, f)){</td></tr><tr><td class="line-number" value="407"></td><td class="line-content">          out.push(f);</td></tr><tr><td class="line-number" value="408"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="409"></td><td class="line-content">      } catch(_){}</td></tr><tr><td class="line-number" value="410"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="411"></td><td class="line-content">    return out.slice(0, 25); // cota de seguridad</td></tr><tr><td class="line-number" value="412"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="413"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="414"></td><td class="line-content">  // ====== LABELS SOBRE EL MAPA ======</td></tr><tr><td class="line-number" value="415"></td><td class="line-content">  function addLabelForFeature(feat, className, text){</td></tr><tr><td class="line-number" value="416"></td><td class="line-content">    try {</td></tr><tr><td class="line-number" value="417"></td><td class="line-content">      const c = turf.centerOfMass(feat).geometry.coordinates; // [lon, lat]</td></tr><tr><td class="line-number" value="418"></td><td class="line-content">      const m = L.marker([c[1], c[0]], { icon: L.divIcon({ className, html: text, iconSize:[0,0] }) });</td></tr><tr><td class="line-number" value="419"></td><td class="line-content">      window.__SEC_LABELS = window.__SEC_LABELS || L.layerGroup().addTo(ensureLeafletMap());</td></tr><tr><td class="line-number" value="420"></td><td class="line-content">      window.__SEC_LABELS.addLayer(m);</td></tr><tr><td class="line-number" value="421"></td><td class="line-content">      return m;</td></tr><tr><td class="line-number" value="422"></td><td class="line-content">    } catch(_){}</td></tr><tr><td class="line-number" value="423"></td><td class="line-content">    return null;</td></tr><tr><td class="line-number" value="424"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="425"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="426"></td><td class="line-content">  function clearSectionOverlays(){</td></tr><tr><td class="line-number" value="427"></td><td class="line-content">    const atMap = ensureLeafletMap();</td></tr><tr><td class="line-number" value="428"></td><td class="line-content">    if (window.__SEC_HL){ try{ atMap.removeLayer(__SEC_HL); }catch(_){ } window.__SEC_HL = null; }</td></tr><tr><td class="line-number" value="429"></td><td class="line-content">    if (window.__SEC_ADJ){ try{ atMap.removeLayer(__SEC_ADJ); }catch(_){ } window.__SEC_ADJ = null; }</td></tr><tr><td class="line-number" value="430"></td><td class="line-content">    if (window.__SEC_LABELS){ try{ atMap.removeLayer(__SEC_LABELS); }catch(_){ } window.__SEC_LABELS = null; }</td></tr><tr><td class="line-number" value="431"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="432"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="433"></td><td class="line-content">  // Dibuja selección + adyacentes + labels</td></tr><tr><td class="line-number" value="434"></td><td class="line-content">  function paintSelectionAndAdj(feat){</td></tr><tr><td class="line-number" value="435"></td><td class="line-content">    const atMap = ensureLeafletMap();</td></tr><tr><td class="line-number" value="436"></td><td class="line-content">    clearSectionOverlays();</td></tr><tr><td class="line-number" value="437"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="438"></td><td class="line-content">    // resaltado principal</td></tr><tr><td class="line-number" value="439"></td><td class="line-content">    window.__SEC_HL = L.geoJSON(feat, { style:{ color:'#e91e63', weight:3, fillOpacity:0.25 } }).addTo(atMap);</td></tr><tr><td class="line-number" value="440"></td><td class="line-content">    try { atMap.fitBounds(window.__SEC_HL.getBounds(), { padding:[28,28] }); } catch(_){}</td></tr><tr><td class="line-number" value="441"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="442"></td><td class="line-content">    // adyacentes</td></tr><tr><td class="line-number" value="443"></td><td class="line-content">    const adj = getAdjacents(feat);</td></tr><tr><td class="line-number" value="444"></td><td class="line-content">    if (adj.length){</td></tr><tr><td class="line-number" value="445"></td><td class="line-content">      window.__SEC_ADJ = L.geoJSON({type:'FeatureCollection', features:adj}, { style:{ color:'#90a4ae', weight:1.2, dashArray:'4,4', fillOpacity:0.05 } }).addTo(atMap);</td></tr><tr><td class="line-number" value="446"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="447"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="448"></td><td class="line-content">    // labels</td></tr><tr><td class="line-number" value="449"></td><td class="line-content">    const sec = feat.properties?.SECCION ?? '—';</td></tr><tr><td class="line-number" value="450"></td><td class="line-content">    addLabelForFeature(feat, 'sec-label', `Sección ${sec}`);</td></tr><tr><td class="line-number" value="451"></td><td class="line-content">    for (const f of adj){</td></tr><tr><td class="line-number" value="452"></td><td class="line-content">      const s2 = f.properties?.SECCION ?? '—';</td></tr><tr><td class="line-number" value="453"></td><td class="line-content">      addLabelForFeature(f, 'sec-label-adj', s2);</td></tr><tr><td class="line-number" value="454"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="455"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="456"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="457"></td><td class="line-content">  // ====== PANEL FLOTANTE (drag + datos) ======</td></tr><tr><td class="line-number" value="458"></td><td class="line-content">  (function wireSecInfoPanel(){</td></tr><tr><td class="line-number" value="459"></td><td class="line-content">    const box = document.getElementById('sec-info');</td></tr><tr><td class="line-number" value="460"></td><td class="line-content">    const hdr = box?.querySelector('.hdr');</td></tr><tr><td class="line-number" value="461"></td><td class="line-content">    if (!box || !hdr || box.__wired) return;</td></tr><tr><td class="line-number" value="462"></td><td class="line-content">    let dragging = false, sx=0, sy=0, bx=0, by=0;</td></tr><tr><td class="line-number" value="463"></td><td class="line-content">    hdr.addEventListener('mousedown', (e)=&gt;{</td></tr><tr><td class="line-number" value="464"></td><td class="line-content">      dragging=true; sx=e.clientX; sy=e.clientY;</td></tr><tr><td class="line-number" value="465"></td><td class="line-content">      const r = box.getBoundingClientRect(); bx=r.left; by=r.top;</td></tr><tr><td class="line-number" value="466"></td><td class="line-content">      document.body.style.userSelect='none';</td></tr><tr><td class="line-number" value="467"></td><td class="line-content">    });</td></tr><tr><td class="line-number" value="468"></td><td class="line-content">    window.addEventListener('mousemove', (e)=&gt;{</td></tr><tr><td class="line-number" value="469"></td><td class="line-content">      if (!dragging) return;</td></tr><tr><td class="line-number" value="470"></td><td class="line-content">      const dx = e.clientX - sx, dy = e.clientY - sy;</td></tr><tr><td class="line-number" value="471"></td><td class="line-content">      box.style.left = (bx + dx) + 'px';</td></tr><tr><td class="line-number" value="472"></td><td class="line-content">      box.style.top  = (by + dy) + 'px';</td></tr><tr><td class="line-number" value="473"></td><td class="line-content">      box.style.right = 'auto'; box.style.bottom='auto';</td></tr><tr><td class="line-number" value="474"></td><td class="line-content">      box.style.position = 'absolute';</td></tr><tr><td class="line-number" value="475"></td><td class="line-content">    });</td></tr><tr><td class="line-number" value="476"></td><td class="line-content">    window.addEventListener('mouseup', ()=&gt;{ dragging=false; document.body.style.userSelect=''; });</td></tr><tr><td class="line-number" value="477"></td><td class="line-content">    box.__wired = true;</td></tr><tr><td class="line-number" value="478"></td><td class="line-content">  })();</td></tr><tr><td class="line-number" value="479"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="480"></td><td class="line-content">  async function showSectionInfo(feat){</td></tr><tr><td class="line-number" value="481"></td><td class="line-content">    ensureSecInfoPanelWired();</td></tr><tr><td class="line-number" value="482"></td><td class="line-content">    const p = feat.properties || {};</td></tr><tr><td class="line-number" value="483"></td><td class="line-content">    const sec = p.SECCION ?? '—';</td></tr><tr><td class="line-number" value="484"></td><td class="line-content">    const df  = p[FIELD_KEYS.df] ?? '—';</td></tr><tr><td class="line-number" value="485"></td><td class="line-content">    const dl  = p[FIELD_KEYS.dl] ?? '—';</td></tr><tr><td class="line-number" value="486"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="487"></td><td class="line-content">    // LN 24DL_LN</td></tr><tr><td class="line-number" value="488"></td><td class="line-content">    let ln = await getLN24DL(sec);</td></tr><tr><td class="line-number" value="489"></td><td class="line-content">    if (ln==null) ln = '—';</td></tr><tr><td class="line-number" value="490"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="491"></td><td class="line-content">    // Pintar</td></tr><tr><td class="line-number" value="492"></td><td class="line-content">    const box = document.getElementById('sec-info');</td></tr><tr><td class="line-number" value="493"></td><td class="line-content">    box.querySelector('.hdr').textContent = `Sección ${sec}`;</td></tr><tr><td class="line-number" value="494"></td><td class="line-content">    document.getElementById('si-sec').textContent = sec;</td></tr><tr><td class="line-number" value="495"></td><td class="line-content">    document.getElementById('si-df').textContent  = df;</td></tr><tr><td class="line-number" value="496"></td><td class="line-content">    document.getElementById('si-dl').textContent  = dl;</td></tr><tr><td class="line-number" value="497"></td><td class="line-content">    document.getElementById('si-ln').textContent  = ln;</td></tr><tr><td class="line-number" value="498"></td><td class="line-content">    box.style.display = 'block';</td></tr><tr><td class="line-number" value="499"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="500"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="501"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="502"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="503"></td><td class="line-content">  // ENTER + CLIC + ULTIMO TOKEN</td></tr><tr><td class="line-number" value="504"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="505"></td><td class="line-content">    function currentNeedle(q){</td></tr><tr><td class="line-number" value="506"></td><td class="line-content">      if (!q) return '';</td></tr><tr><td class="line-number" value="507"></td><td class="line-content">      const parts = String(q).split(/[,;\s]+/).filter(Boolean);</td></tr><tr><td class="line-number" value="508"></td><td class="line-content">      return parts.length ? parts[parts.length-1] : '';</td></tr><tr><td class="line-number" value="509"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="510"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="511"></td><td class="line-content">// ===== Mini-selector de universo dentro del módulo =====</td></tr><tr><td class="line-number" value="512"></td><td class="line-content">    let __mini = { selMun:null, selDf:null, selDl:null, all:null };</td></tr><tr><td class="line-number" value="513"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="514"></td><td class="line-content">    function uniqueSorted(values){</td></tr><tr><td class="line-number" value="515"></td><td class="line-content">    const arr = values.map(v =&gt; String(v ?? '').trim()).filter(Boolean);</td></tr><tr><td class="line-number" value="516"></td><td class="line-content">    const set = Array.from(new Set(arr));</td></tr><tr><td class="line-number" value="517"></td><td class="line-content">    return set.sort((a,b) =&gt; (isFinite(a)&amp;&amp;isFinite(b)) ? Number(a)-Number(b) : a.localeCompare(b,'es'));</td></tr><tr><td class="line-number" value="518"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="519"></td><td class="line-content">    function buildMiniOptions(raw){</td></tr><tr><td class="line-number" value="520"></td><td class="line-content">    const feats = raw.features || [];</td></tr><tr><td class="line-number" value="521"></td><td class="line-content">    const grab = k =&gt; uniqueSorted(feats.map(f =&gt; f.properties?.[k]));</td></tr><tr><td class="line-number" value="522"></td><td class="line-content">    return { mun: grab(FIELD_KEYS.mun), df: grab(FIELD_KEYS.df), dl: grab(FIELD_KEYS.dl) };</td></tr><tr><td class="line-number" value="523"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="524"></td><td class="line-content">    function fillSelect(sel, arr){</td></tr><tr><td class="line-number" value="525"></td><td class="line-content">    sel.innerHTML = '&lt;option value=""&gt;— Ninguno —&lt;/option&gt;' + arr.map(v=&gt;`&lt;option value="${v}"&gt;${v}&lt;/option&gt;`).join('');</td></tr><tr><td class="line-number" value="526"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="527"></td><td class="line-content">    function getMiniUniverse(){</td></tr><tr><td class="line-number" value="528"></td><td class="line-content">    const { selMun, selDf, selDl, all } = __mini;</td></tr><tr><td class="line-number" value="529"></td><td class="line-content">    if(all.checked) return { scope:'ALL', key:null, label:'Estado completo' };</td></tr><tr><td class="line-number" value="530"></td><td class="line-content">    if(selMun.value) return { scope:'MUN', key: selMun.value, label:`Municipio ${selMun.options[selMun.selectedIndex].text}` };</td></tr><tr><td class="line-number" value="531"></td><td class="line-content">    if(selDf.value)  return { scope:'DF',  key: selDf.value,  label:`Distrito Federal ${selDf.value}` };</td></tr><tr><td class="line-number" value="532"></td><td class="line-content">    if(selDl.value)  return { scope:'DL',  key: selDl.value,  label:`Distrito Local ${selDl.value}` };</td></tr><tr><td class="line-number" value="533"></td><td class="line-content">    return null;</td></tr><tr><td class="line-number" value="534"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="535"></td><td class="line-content">    function miniExclusivity(which){</td></tr><tr><td class="line-number" value="536"></td><td class="line-content">    const { selMun, selDf, selDl, all } = __mini;</td></tr><tr><td class="line-number" value="537"></td><td class="line-content">    if(which==='ALL'){ selMun.value=''; selDf.value=''; selDl.value=''; }</td></tr><tr><td class="line-number" value="538"></td><td class="line-content">    if(which==='MUN'){ selDf.value=''; selDl.value=''; all.checked=false; }</td></tr><tr><td class="line-number" value="539"></td><td class="line-content">    if(which==='DF'){  selMun.value=''; selDl.value=''; all.checked=false; }</td></tr><tr><td class="line-number" value="540"></td><td class="line-content">    if(which==='DL'){  selMun.value=''; selDf.value=''; all.checked=false; }</td></tr><tr><td class="line-number" value="541"></td><td class="line-content">    applyMiniUniverse();</td></tr><tr><td class="line-number" value="542"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="543"></td><td class="line-content">    function applyMiniUniverse(){</td></tr><tr><td class="line-number" value="544"></td><td class="line-content">    const u2 = getMiniUniverse();</td></tr><tr><td class="line-number" value="545"></td><td class="line-content">    if(!u2) return;</td></tr><tr><td class="line-number" value="546"></td><td class="line-content">    // 1) Persistir</td></tr><tr><td class="line-number" value="547"></td><td class="line-content">    localStorage.setItem('AT_UNIVERSE', JSON.stringify({ ...u2, ts:Date.now() }));</td></tr><tr><td class="line-number" value="548"></td><td class="line-content">    // 2) Redibujar con el nuevo universo usando el raw ya cargado</td></tr><tr><td class="line-number" value="549"></td><td class="line-content">    const atMap = ensureLeafletMap();</td></tr><tr><td class="line-number" value="550"></td><td class="line-content">    const filtered2 = filterGeojson(window.AT_DATA, u2);</td></tr><tr><td class="line-number" value="551"></td><td class="line-content">    if (window.AT_CTX?.layer) { atMap.removeLayer(AT_CTX.layer); }</td></tr><tr><td class="line-number" value="552"></td><td class="line-content">    const layer2 = L.geoJSON(filtered2, { style:{ color:'#7d0025', weight:1.2, fillOpacity:0.15 } }).addTo(atMap);</td></tr><tr><td class="line-number" value="553"></td><td class="line-content">    try { atMap.fitBounds(layer2.getBounds(), { padding:[20,20] }); } catch(e){}</td></tr><tr><td class="line-number" value="554"></td><td class="line-content">    window.AT_CTX = { ...(window.AT_CTX||{}), universe: u2, layer: layer2 };</td></tr><tr><td class="line-number" value="555"></td><td class="line-content">    // 3) Header</td></tr><tr><td class="line-number" value="556"></td><td class="line-content">    const hdr = document.querySelector('#panel-header span');</td></tr><tr><td class="line-number" value="557"></td><td class="line-content">    if(hdr){ hdr.textContent = `Análisis Territorial · ${u2.label}`; }</td></tr><tr><td class="line-number" value="558"></td><td class="line-content">      refreshSectionSearch(u2);</td></tr><tr><td class="line-number" value="559"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="560"></td><td class="line-content">    function initMiniSelector(raw, u){</td></tr><tr><td class="line-number" value="561"></td><td class="line-content">    // Guardar el geojson bruto para futuros re-filtros</td></tr><tr><td class="line-number" value="562"></td><td class="line-content">    window.AT_DATA = raw;</td></tr><tr><td class="line-number" value="563"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="564"></td><td class="line-content">    __mini.selMun = document.getElementById('mini-sel-mun');</td></tr><tr><td class="line-number" value="565"></td><td class="line-content">    labelMunicipiosFromCatalog('#mini-sel-mun');</td></tr><tr><td class="line-number" value="566"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="567"></td><td class="line-content">    __mini.selDf  = document.getElementById('mini-sel-df');</td></tr><tr><td class="line-number" value="568"></td><td class="line-content">    __mini.selDl  = document.getElementById('mini-sel-dl');</td></tr><tr><td class="line-number" value="569"></td><td class="line-content">    __mini.all    = document.getElementById('mini-all-state');</td></tr><tr><td class="line-number" value="570"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="571"></td><td class="line-content">    const opt = buildMiniOptions(raw);</td></tr><tr><td class="line-number" value="572"></td><td class="line-content">    fillSelect(__mini.selMun, opt.mun);</td></tr><tr><td class="line-number" value="573"></td><td class="line-content">    fillSelect(__mini.selDf,  opt.df);</td></tr><tr><td class="line-number" value="574"></td><td class="line-content">    fillSelect(__mini.selDl,  opt.dl);</td></tr><tr><td class="line-number" value="575"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="576"></td><td class="line-content">    // Reflejar el universo actual</td></tr><tr><td class="line-number" value="577"></td><td class="line-content">    if(u.scope==='ALL'){ __mini.all.checked = true; }</td></tr><tr><td class="line-number" value="578"></td><td class="line-content">    if(u.scope==='MUN'){ __mini.selMun.value = String(u.key); }</td></tr><tr><td class="line-number" value="579"></td><td class="line-content">    if(u.scope==='DF'){  __mini.selDf.value  = String(u.key); }</td></tr><tr><td class="line-number" value="580"></td><td class="line-content">    if(u.scope==='DL'){  __mini.selDl.value  = String(u.key); }</td></tr><tr><td class="line-number" value="581"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="582"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="583"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="584"></td><td class="line-content">        async function labelMunicipiosFromCatalog(selectId){</td></tr><tr><td class="line-number" value="585"></td><td class="line-content">        const sel = document.querySelector(selectId);</td></tr><tr><td class="line-number" value="586"></td><td class="line-content">        if (!sel) return;</td></tr><tr><td class="line-number" value="587"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="588"></td><td class="line-content">        // 1) Ruta del catálogo desde el Portal (AT_PATHS) o fallback</td></tr><tr><td class="line-number" value="589"></td><td class="line-content">        let catUrl = 'data/catalogo_territorial.json';</td></tr><tr><td class="line-number" value="590"></td><td class="line-content">        try {</td></tr><tr><td class="line-number" value="591"></td><td class="line-content">            const paths = JSON.parse(localStorage.getItem('AT_PATHS') || '{}');</td></tr><tr><td class="line-number" value="592"></td><td class="line-content">            if (paths?.catalog) catUrl = paths.catalog;</td></tr><tr><td class="line-number" value="593"></td><td class="line-content">        } catch {}</td></tr><tr><td class="line-number" value="594"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="595"></td><td class="line-content">        // 2) Cargar catálogo</td></tr><tr><td class="line-number" value="596"></td><td class="line-content">        let cat = null;</td></tr><tr><td class="line-number" value="597"></td><td class="line-content">        try {</td></tr><tr><td class="line-number" value="598"></td><td class="line-content">            const r = await fetch(catUrl);</td></tr><tr><td class="line-number" value="599"></td><td class="line-content">            if (!r.ok) throw new Error('HTTP '+r.status);</td></tr><tr><td class="line-number" value="600"></td><td class="line-content">            cat = await r.json();</td></tr><tr><td class="line-number" value="601"></td><td class="line-content">        } catch (e) {</td></tr><tr><td class="line-number" value="602"></td><td class="line-content">            console.warn('[AT] No se pudo cargar el catálogo:', e);</td></tr><tr><td class="line-number" value="603"></td><td class="line-content">            return; // salimos sin tocar etiquetas</td></tr><tr><td class="line-number" value="604"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="605"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="606"></td><td class="line-content">        const mapa = cat?.municipios || {};</td></tr><tr><td class="line-number" value="607"></td><td class="line-content">        // helper: si el catálogo trae ceros a la izquierda en las llaves</td></tr><tr><td class="line-number" value="608"></td><td class="line-content">        const getName = (code) =&gt; {</td></tr><tr><td class="line-number" value="609"></td><td class="line-content">            const s = String(code);</td></tr><tr><td class="line-number" value="610"></td><td class="line-content">            return mapa[s] || mapa[s.padStart(2,'0')] || mapa[s.padStart(3,'0')] || s;</td></tr><tr><td class="line-number" value="611"></td><td class="line-content">        };</td></tr><tr><td class="line-number" value="612"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="613"></td><td class="line-content">        // 3) Reetiquetar opciones (sin cambiar value)</td></tr><tr><td class="line-number" value="614"></td><td class="line-content">        for (const opt of sel.options) {</td></tr><tr><td class="line-number" value="615"></td><td class="line-content">            if (!opt.value) continue; // deja "— Ninguno —"</td></tr><tr><td class="line-number" value="616"></td><td class="line-content">            const name = getName(opt.value);</td></tr><tr><td class="line-number" value="617"></td><td class="line-content">            opt.text = `${opt.value} — ${name}`;</td></tr><tr><td class="line-number" value="618"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="619"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="620"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="621"></td><td class="line-content">   </td></tr><tr><td class="line-number" value="622"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="623"></td><td class="line-content">    // Eventos (auto-ejecuta)</td></tr><tr><td class="line-number" value="624"></td><td class="line-content">    __mini.selMun.addEventListener('change', ()=&gt; miniExclusivity('MUN'));</td></tr><tr><td class="line-number" value="625"></td><td class="line-content">    __mini.selDf .addEventListener('change', ()=&gt; miniExclusivity('DF'));</td></tr><tr><td class="line-number" value="626"></td><td class="line-content">    __mini.selDl .addEventListener('change', ()=&gt; miniExclusivity('DL'));</td></tr><tr><td class="line-number" value="627"></td><td class="line-content">    __mini.all   .addEventListener('change', ()=&gt; miniExclusivity('ALL'));</td></tr><tr><td class="line-number" value="628"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="629"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="630"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="631"></td><td class="line-content">    // Nombre fijo del campo (texto) del municipio</td></tr><tr><td class="line-number" value="632"></td><td class="line-content">    const MUN_NAME_KEY = 'MUNICIPIO';</td></tr><tr><td class="line-number" value="633"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="634"></td><td class="line-content">    // Detecta automáticamente el campo de CÓDIGO de municipio (si no, usa el nombre)</td></tr><tr><td class="line-number" value="635"></td><td class="line-content">    function detectMunCodeKey(raw){</td></tr><tr><td class="line-number" value="636"></td><td class="line-content">    const feats = raw.features || [];</td></tr><tr><td class="line-number" value="637"></td><td class="line-content">    const candidates = ['MUN','CVE_MUN','CLV_MUN','ID_MUN','MUNICIPIO_ID','MUNICIPIO_CVE','CVE_MUNICIPIO','CVE_MPIO'];</td></tr><tr><td class="line-number" value="638"></td><td class="line-content">    for (const k of candidates) {</td></tr><tr><td class="line-number" value="639"></td><td class="line-content">        const ok = feats.some(f =&gt; {</td></tr><tr><td class="line-number" value="640"></td><td class="line-content">        const v = f.properties?.[k];</td></tr><tr><td class="line-number" value="641"></td><td class="line-content">        return v != null &amp;&amp; String(v).trim() !== '' &amp;&amp; String(v).toUpperCase() !== 'NULL';</td></tr><tr><td class="line-number" value="642"></td><td class="line-content">        });</td></tr><tr><td class="line-number" value="643"></td><td class="line-content">        if (ok) return k;</td></tr><tr><td class="line-number" value="644"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="645"></td><td class="line-content">    return null; // fallback será MUN_NAME_KEY</td></tr><tr><td class="line-number" value="646"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="647"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="648"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="649"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="650"></td><td class="line-content">      // —— Utils de texto ——</td></tr><tr><td class="line-number" value="651"></td><td class="line-content">      function _norm(s){</td></tr><tr><td class="line-number" value="652"></td><td class="line-content">        if (s==null) return '';</td></tr><tr><td class="line-number" value="653"></td><td class="line-content">        return String(s).normalize('NFD').replace(/[\u0300-\u036f]/g,'').toUpperCase().trim();</td></tr><tr><td class="line-number" value="654"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="655"></td><td class="line-content">      function _isDigits(s){ return /^[0-9]+$/.test(String(s||'')); }</td></tr><tr><td class="line-number" value="656"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="657"></td><td class="line-content">      // —— Nombre de municipio desde catálogo (si existe) ——</td></tr><tr><td class="line-number" value="658"></td><td class="line-content">      function getMunNameFromCatalog(code){</td></tr><tr><td class="line-number" value="659"></td><td class="line-content">        const cat = window.AT_CATALOG;</td></tr><tr><td class="line-number" value="660"></td><td class="line-content">        if (!cat?.municipios) return String(code ?? '');</td></tr><tr><td class="line-number" value="661"></td><td class="line-content">        const s = String(code);</td></tr><tr><td class="line-number" value="662"></td><td class="line-content">        // maneja posibles ceros a la izquierda</td></tr><tr><td class="line-number" value="663"></td><td class="line-content">        return cat.municipios[s] || cat.municipios[s.padStart(2,'0')] || cat.municipios[s.padStart(3,'0')] || s;</td></tr><tr><td class="line-number" value="664"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="665"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="666"></td><td class="line-content">      // —— Índice de secciones ——</td></tr><tr><td class="line-number" value="667"></td><td class="line-content">      let __SEC_INDEX = { items: [], global: false };</td></tr><tr><td class="line-number" value="668"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="669"></td><td class="line-content">      function buildSectionIndex(raw, universe, useGlobal){</td></tr><tr><td class="line-number" value="670"></td><td class="line-content">        const feats = (raw?.features || []);</td></tr><tr><td class="line-number" value="671"></td><td class="line-content">        const munKey = (window.AT_KEYS?.munCode) || FIELD_KEYS.mun;</td></tr><tr><td class="line-number" value="672"></td><td class="line-content">        const items = [];</td></tr><tr><td class="line-number" value="673"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="674"></td><td class="line-content">        // dataset base: global = todas, local = filtradas por universo</td></tr><tr><td class="line-number" value="675"></td><td class="line-content">        const base = useGlobal ? feats : (filterGeojson(raw, universe).features || []);</td></tr><tr><td class="line-number" value="676"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="677"></td><td class="line-content">        for(const f of base){</td></tr><tr><td class="line-number" value="678"></td><td class="line-content">          const p = f.properties || {};</td></tr><tr><td class="line-number" value="679"></td><td class="line-content">          const sec = p.SECCION ?? p.Seccion ?? p.seccion ?? null;</td></tr><tr><td class="line-number" value="680"></td><td class="line-content">          if (sec == null) continue;</td></tr><tr><td class="line-number" value="681"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="682"></td><td class="line-content">          const munCode = p[munKey];</td></tr><tr><td class="line-number" value="683"></td><td class="line-content">          const munName = getMunNameFromCatalog(munCode);</td></tr><tr><td class="line-number" value="684"></td><td class="line-content">          const df = p[FIELD_KEYS.df];</td></tr><tr><td class="line-number" value="685"></td><td class="line-content">          const dl = p[FIELD_KEYS.dl];</td></tr><tr><td class="line-number" value="686"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="687"></td><td class="line-content">          // texto para búsqueda</td></tr><tr><td class="line-number" value="688"></td><td class="line-content">          const text = `${sec} ${munCode ?? ''} ${munName ?? ''} ${df ?? ''} ${dl ?? ''}`;</td></tr><tr><td class="line-number" value="689"></td><td class="line-content">          // bounds (si multiparte, Leaflet lo resuelve)</td></tr><tr><td class="line-number" value="690"></td><td class="line-content">          let bounds = null;</td></tr><tr><td class="line-number" value="691"></td><td class="line-content">          try { bounds = L.geoJSON(f).getBounds(); } catch(_){}</td></tr><tr><td class="line-number" value="692"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="693"></td><td class="line-content">          items.push({</td></tr><tr><td class="line-number" value="694"></td><td class="line-content">            sec: String(sec).trim(),</td></tr><tr><td class="line-number" value="695"></td><td class="line-content">            munCode: munCode,</td></tr><tr><td class="line-number" value="696"></td><td class="line-content">            munName: munName,</td></tr><tr><td class="line-number" value="697"></td><td class="line-content">            df, dl, feature: f, textNorm: _norm(text), bounds</td></tr><tr><td class="line-number" value="698"></td><td class="line-content">          });</td></tr><tr><td class="line-number" value="699"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="700"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="701"></td><td class="line-content">        __SEC_INDEX = { items, global: !!useGlobal };</td></tr><tr><td class="line-number" value="702"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="703"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="704"></td><td class="line-content">      function searchSections(query, limit=15){</td></tr><tr><td class="line-number" value="705"></td><td class="line-content">        const q = _norm(query);</td></tr><tr><td class="line-number" value="706"></td><td class="line-content">        if (!q) return [];</td></tr><tr><td class="line-number" value="707"></td><td class="line-content">        const ds = __SEC_INDEX.items;</td></tr><tr><td class="line-number" value="708"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="709"></td><td class="line-content">        // Heurística sencilla:</td></tr><tr><td class="line-number" value="710"></td><td class="line-content">        // - si es numérico puro: prioridad a SECCION que empiece con q</td></tr><tr><td class="line-number" value="711"></td><td class="line-content">        // - si no: contiene tokens</td></tr><tr><td class="line-number" value="712"></td><td class="line-content">        if (_isDigits(q)){</td></tr><tr><td class="line-number" value="713"></td><td class="line-content">          const starts = ds.filter(it =&gt; _norm(it.sec).startsWith(q));</td></tr><tr><td class="line-number" value="714"></td><td class="line-content">          if (starts.length &gt;= limit) return starts.slice(0, limit);</td></tr><tr><td class="line-number" value="715"></td><td class="line-content">          const contains = ds.filter(it =&gt; _norm(it.sec).includes(q));</td></tr><tr><td class="line-number" value="716"></td><td class="line-content">          return [...starts, ...contains].slice(0, limit);</td></tr><tr><td class="line-number" value="717"></td><td class="line-content">        } else {</td></tr><tr><td class="line-number" value="718"></td><td class="line-content">          const tokens = q.split(/\s+/).filter(Boolean);</td></tr><tr><td class="line-number" value="719"></td><td class="line-content">          return ds.filter(it =&gt; tokens.every(t =&gt; it.textNorm.includes(t))).slice(0, limit);</td></tr><tr><td class="line-number" value="720"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="721"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="722"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="723"></td><td class="line-content">      // —— UI de sugerencias ——</td></tr><tr><td class="line-number" value="724"></td><td class="line-content">      let __SEC_HIGHLIGHT = null;</td></tr><tr><td class="line-number" value="725"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="726"></td><td class="line-content">      function renderSecSuggestions(list){</td></tr><tr><td class="line-number" value="727"></td><td class="line-content">        const ul = document.getElementById('sec-suggest');</td></tr><tr><td class="line-number" value="728"></td><td class="line-content">        if (!ul) return;</td></tr><tr><td class="line-number" value="729"></td><td class="line-content">        if (!list.length){ ul.style.display='none'; ul.innerHTML=''; return; }</td></tr><tr><td class="line-number" value="730"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="731"></td><td class="line-content">        ul.innerHTML = list.map(it =&gt; {</td></tr><tr><td class="line-number" value="732"></td><td class="line-content">          const label = `${it.sec} — ${it.munName || it.munCode || ''}`.replace(/\s+-\s+$/, '');</td></tr><tr><td class="line-number" value="733"></td><td class="line-content">          const meta  = [];</td></tr><tr><td class="line-number" value="734"></td><td class="line-content">          if (it.dl!=null) meta.push(`DL ${it.dl}`);</td></tr><tr><td class="line-number" value="735"></td><td class="line-content">          if (it.df!=null) meta.push(`DF ${it.df}`);</td></tr><tr><td class="line-number" value="736"></td><td class="line-content">          const sub = meta.length ? `&lt;small style="color:#64748b"&gt;${meta.join(' · ')}&lt;/small&gt;` : '';</td></tr><tr><td class="line-number" value="737"></td><td class="line-content">          return `&lt;li data-sec="${it.sec}" style="padding:6px 8px; border-bottom:1px solid #e5e7eb; cursor:pointer"&gt;</td></tr><tr><td class="line-number" value="738"></td><td class="line-content">                    &lt;div&gt;${label}&lt;/div&gt;${sub}</td></tr><tr><td class="line-number" value="739"></td><td class="line-content">                  &lt;/li&gt;`;</td></tr><tr><td class="line-number" value="740"></td><td class="line-content">        }).join('');</td></tr><tr><td class="line-number" value="741"></td><td class="line-content">        ul.style.display = 'block';</td></tr><tr><td class="line-number" value="742"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="743"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="744"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="745"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="746"></td><td class="line-content">    function gotoSection(item){</td></tr><tr><td class="line-number" value="747"></td><td class="line-content">      const atMap = (window.AT_CTX?.map) || ensureLeafletMap();</td></tr><tr><td class="line-number" value="748"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="749"></td><td class="line-content">      // 1) Resolver el feature de la sección</td></tr><tr><td class="line-number" value="750"></td><td class="line-content">      const sec = String(item.sec ?? item.SECCION ?? '');</td></tr><tr><td class="line-number" value="751"></td><td class="line-content">      let feat = item.feature;</td></tr><tr><td class="line-number" value="752"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="753"></td><td class="line-content">      if (!feat) {</td></tr><tr><td class="line-number" value="754"></td><td class="line-content">        const feats =</td></tr><tr><td class="line-number" value="755"></td><td class="line-content">          (window.AT_CTX?.layer?.toGeoJSON?.().features) ||</td></tr><tr><td class="line-number" value="756"></td><td class="line-content">          (window.AT_DATA?.features) || [];</td></tr><tr><td class="line-number" value="757"></td><td class="line-content">        feat = feats.find(f =&gt; String(f.properties?.SECCION) === sec);</td></tr><tr><td class="line-number" value="758"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="759"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="760"></td><td class="line-content">      if (!feat) {</td></tr><tr><td class="line-number" value="761"></td><td class="line-content">        console.warn('[AT] No encontré el feature para la sección', sec, item);</td></tr><tr><td class="line-number" value="762"></td><td class="line-content">        return;</td></tr><tr><td class="line-number" value="763"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="764"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="765"></td><td class="line-content">      // 2) Pintar selección + adyacentes + labels (esto limpia overlays previos)</td></tr><tr><td class="line-number" value="766"></td><td class="line-content">      paintSelectionAndAdj(feat);</td></tr><tr><td class="line-number" value="767"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="768"></td><td class="line-content">      // 3) Mostrar panel con DF, DL y LN (24DL_LN)</td></tr><tr><td class="line-number" value="769"></td><td class="line-content">      showSectionInfo(feat);</td></tr><tr><td class="line-number" value="770"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="771"></td><td class="line-content">      // 4) Feedback visual (parpadeo leve sobre el highlight actual)</td></tr><tr><td class="line-number" value="772"></td><td class="line-content">      const hl = window.__SEC_HL;</td></tr><tr><td class="line-number" value="773"></td><td class="line-content">      if (hl &amp;&amp; typeof hl.setStyle === 'function') {</td></tr><tr><td class="line-number" value="774"></td><td class="line-content">        try {</td></tr><tr><td class="line-number" value="775"></td><td class="line-content">          hl.setStyle({ weight: 4 });</td></tr><tr><td class="line-number" value="776"></td><td class="line-content">          setTimeout(() =&gt; { try { hl.setStyle({ weight: 3 }); } catch(_){} }, 220);</td></tr><tr><td class="line-number" value="777"></td><td class="line-content">        } catch(_){}</td></tr><tr><td class="line-number" value="778"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="779"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="780"></td><td class="line-content">      // 5) Oculta la lista de sugerencias (si está visible)</td></tr><tr><td class="line-number" value="781"></td><td class="line-content">      const ul = document.getElementById('sec-suggest');</td></tr><tr><td class="line-number" value="782"></td><td class="line-content">      if (ul) ul.style.display = 'none';</td></tr><tr><td class="line-number" value="783"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="784"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="785"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="786"></td><td class="line-content">      // Delegación de clic en las sugerencias (una sola vez)</td></tr><tr><td class="line-number" value="787"></td><td class="line-content">    (function wireSectionSearchEventsOnce(){</td></tr><tr><td class="line-number" value="788"></td><td class="line-content">      const ul = document.getElementById('sec-suggest');</td></tr><tr><td class="line-number" value="789"></td><td class="line-content">      const input = document.getElementById('sec-q');</td></tr><tr><td class="line-number" value="790"></td><td class="line-content">      if (!ul || !input) return;</td></tr><tr><td class="line-number" value="791"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="792"></td><td class="line-content">       // Si está dentro de un form, evita submit al Enter</td></tr><tr><td class="line-number" value="793"></td><td class="line-content">      const form = input.closest('form');</td></tr><tr><td class="line-number" value="794"></td><td class="line-content">      form?.addEventListener('submit', e =&gt; e.preventDefault());</td></tr><tr><td class="line-number" value="795"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="796"></td><td class="line-content">      // Clic en cualquier &lt;li data-sec="..."&gt;</td></tr><tr><td class="line-number" value="797"></td><td class="line-content">      if (!ul.__wiredClick){</td></tr><tr><td class="line-number" value="798"></td><td class="line-content">        ul.addEventListener('click', (ev)=&gt;{</td></tr><tr><td class="line-number" value="799"></td><td class="line-content">          const li = ev.target.closest('li[data-sec]');</td></tr><tr><td class="line-number" value="800"></td><td class="line-content">          if (!li) return;</td></tr><tr><td class="line-number" value="801"></td><td class="line-content">          const sec = li.getAttribute('data-sec');</td></tr><tr><td class="line-number" value="802"></td><td class="line-content">          const item = (__SEC_INDEX?.items||[]).find(x =&gt; String(x.sec) === String(sec));</td></tr><tr><td class="line-number" value="803"></td><td class="line-content">          if (item) gotoSection(item);</td></tr><tr><td class="line-number" value="804"></td><td class="line-content">          ul.style.display = 'none';</td></tr><tr><td class="line-number" value="805"></td><td class="line-content">        });</td></tr><tr><td class="line-number" value="806"></td><td class="line-content">        ul.__wiredClick = true;</td></tr><tr><td class="line-number" value="807"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="808"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="809"></td><td class="line-content">      // Enter en el input = ir al primer resultado</td></tr><tr><td class="line-number" value="810"></td><td class="line-content">      if (!input.__wiredKey){</td></tr><tr><td class="line-number" value="811"></td><td class="line-content">        input.addEventListener('keydown', (ev)=&gt;{</td></tr><tr><td class="line-number" value="812"></td><td class="line-content">          if (ev.key === 'Enter'){</td></tr><tr><td class="line-number" value="813"></td><td class="line-content">            ev.preventDefault(); // &lt;- evita submit/autocomplete</td></tr><tr><td class="line-number" value="814"></td><td class="line-content">            const results = searchSections(input.value, 1);</td></tr><tr><td class="line-number" value="815"></td><td class="line-content">        const needle = currentNeedle(input.value);</td></tr><tr><td class="line-number" value="816"></td><td class="line-content">        const [first] = searchSections(needle, 1);</td></tr><tr><td class="line-number" value="817"></td><td class="line-content">        if (first) gotoSection(first);</td></tr><tr><td class="line-number" value="818"></td><td class="line-content">        ul.style.display = 'none';</td></tr><tr><td class="line-number" value="819"></td><td class="line-content">       }</td></tr><tr><td class="line-number" value="820"></td><td class="line-content">          if (ev.key === 'Escape'){</td></tr><tr><td class="line-number" value="821"></td><td class="line-content">            ul.style.display = 'none';</td></tr><tr><td class="line-number" value="822"></td><td class="line-content">          }</td></tr><tr><td class="line-number" value="823"></td><td class="line-content">        });</td></tr><tr><td class="line-number" value="824"></td><td class="line-content">        input.__wiredKey = true;</td></tr><tr><td class="line-number" value="825"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="826"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="827"></td><td class="line-content">      // Input: recalcula sugerencias usando el "último token"</td></tr><tr><td class="line-number" value="828"></td><td class="line-content">      if (!input.__wiredInput){</td></tr><tr><td class="line-number" value="829"></td><td class="line-content">        input.addEventListener('input', ()=&gt;{</td></tr><tr><td class="line-number" value="830"></td><td class="line-content">          const needle = currentNeedle(input.value);</td></tr><tr><td class="line-number" value="831"></td><td class="line-content">          renderSecSuggestions(searchSections(needle, 15));</td></tr><tr><td class="line-number" value="832"></td><td class="line-content">        });</td></tr><tr><td class="line-number" value="833"></td><td class="line-content">        input.__wiredInput = true;</td></tr><tr><td class="line-number" value="834"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="835"></td><td class="line-content">    })();</td></tr><tr><td class="line-number" value="836"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="837"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="838"></td><td class="line-content">      // —— Inicializar Buscador en el módulo ——</td></tr><tr><td class="line-number" value="839"></td><td class="line-content">      function initSectionSearch(raw, universe){</td></tr><tr><td class="line-number" value="840"></td><td class="line-content">        const input   = document.getElementById('sec-q');</td></tr><tr><td class="line-number" value="841"></td><td class="line-content">        const list    = document.getElementById('sec-suggest');</td></tr><tr><td class="line-number" value="842"></td><td class="line-content">        const globalC = document.getElementById('sec-global');</td></tr><tr><td class="line-number" value="843"></td><td class="line-content">        if (!input || !list) return;</td></tr><tr><td class="line-number" value="844"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="845"></td><td class="line-content">        // construir índice (por universo actual)</td></tr><tr><td class="line-number" value="846"></td><td class="line-content">        buildSectionIndex(raw, universe, !!globalC?.checked);</td></tr><tr><td class="line-number" value="847"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="848"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="849"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="850"></td><td class="line-content">        // Cambiar ámbito (global / universo actual)</td></tr><tr><td class="line-number" value="851"></td><td class="line-content">        globalC?.addEventListener('change', () =&gt; {</td></tr><tr><td class="line-number" value="852"></td><td class="line-content">          buildSectionIndex(raw, universe, !!globalC.checked);</td></tr><tr><td class="line-number" value="853"></td><td class="line-content">          // refresca sugerencias con la query actual</td></tr><tr><td class="line-number" value="854"></td><td class="line-content">          if (input.value){</td></tr><tr><td class="line-number" value="855"></td><td class="line-content">            renderSecSuggestions(searchSections(input.value, 15));</td></tr><tr><td class="line-number" value="856"></td><td class="line-content">          }</td></tr><tr><td class="line-number" value="857"></td><td class="line-content">        });</td></tr><tr><td class="line-number" value="858"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="859"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="860"></td><td class="line-content">      // —— Cuando cambies de universo con tu mini-selector, reindexa ——</td></tr><tr><td class="line-number" value="861"></td><td class="line-content">      function refreshSectionSearch(universe){</td></tr><tr><td class="line-number" value="862"></td><td class="line-content">        const input   = document.getElementById('sec-q');</td></tr><tr><td class="line-number" value="863"></td><td class="line-content">        const globalC = document.getElementById('sec-global');</td></tr><tr><td class="line-number" value="864"></td><td class="line-content">        if (!window.AT_DATA || !input) return;</td></tr><tr><td class="line-number" value="865"></td><td class="line-content">        buildSectionIndex(window.AT_DATA, universe, !!globalC?.checked);</td></tr><tr><td class="line-number" value="866"></td><td class="line-content">        if (input.value){</td></tr><tr><td class="line-number" value="867"></td><td class="line-content">          renderSecSuggestions(searchSections(input.value, 15));</td></tr><tr><td class="line-number" value="868"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="869"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="870"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="871"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="872"></td><td class="line-content">      function getRawForIndex(){</td></tr><tr><td class="line-number" value="873"></td><td class="line-content">        // Usa el dataset completo si ya lo cacheaste</td></tr><tr><td class="line-number" value="874"></td><td class="line-content">        if (window.AT_DATA) return window.AT_DATA;</td></tr><tr><td class="line-number" value="875"></td><td class="line-content">        // Si no, al menos usa lo ya pintado en el mapa</td></tr><tr><td class="line-number" value="876"></td><td class="line-content">        const lyr = window.AT_CTX?.layer;</td></tr><tr><td class="line-number" value="877"></td><td class="line-content">        return (lyr &amp;&amp; typeof lyr.toGeoJSON === 'function') ? lyr.toGeoJSON() : null;</td></tr><tr><td class="line-number" value="878"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="879"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="880"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="881"></td><td class="line-content">  // ===== 3) Boot =====</td></tr><tr><td class="line-number" value="882"></td><td class="line-content">  document.addEventListener('DOMContentLoaded', async () =&gt; {</td></tr><tr><td class="line-number" value="883"></td><td class="line-content">    // a) Leer universo y rutas puestos en el PORTAL</td></tr><tr><td class="line-number" value="884"></td><td class="line-content">    const u     = JSON.parse(localStorage.getItem('AT_UNIVERSE') || 'null');</td></tr><tr><td class="line-number" value="885"></td><td class="line-content">    const paths = JSON.parse(localStorage.getItem('AT_PATHS') || '{"geo":""}');</td></tr><tr><td class="line-number" value="886"></td><td class="line-content">    if (!u) {</td></tr><tr><td class="line-number" value="887"></td><td class="line-content">      const hdr = document.querySelector('#panel-header span');</td></tr><tr><td class="line-number" value="888"></td><td class="line-content">      hdr &amp;&amp; (hdr.textContent += ' · selecciona el universo en el Portal');</td></tr><tr><td class="line-number" value="889"></td><td class="line-content">      setTimeout(()=&gt;{ location.href = 'portal.html'; }, 600);</td></tr><tr><td class="line-number" value="890"></td><td class="line-content">      return;</td></tr><tr><td class="line-number" value="891"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="892"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="893"></td><td class="line-content">    // b) Etiqueta del universo</td></tr><tr><td class="line-number" value="894"></td><td class="line-content">    const hdr = document.querySelector('#panel-header span');</td></tr><tr><td class="line-number" value="895"></td><td class="line-content">    hdr &amp;&amp; (hdr.textContent += ` · ${u.label}`);</td></tr><tr><td class="line-number" value="896"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="897"></td><td class="line-content">    // c) Mapa único</td></tr><tr><td class="line-number" value="898"></td><td class="line-content">    const atMap = ensureLeafletMap();</td></tr><tr><td class="line-number" value="899"></td><td class="line-content">    assertIsLeafletMap(atMap);</td></tr><tr><td class="line-number" value="900"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="901"></td><td class="line-content">    // d) Cargar y filtrar GeoJSON</td></tr><tr><td class="line-number" value="902"></td><td class="line-content">    const url = paths.geo || 'data/geo/secciones.geojson'; // &lt;-- ajusta si tu ruta difiere</td></tr><tr><td class="line-number" value="903"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="904"></td><td class="line-content">    // Cargar catálogo territorial (para nombres visibles)</td></tr><tr><td class="line-number" value="905"></td><td class="line-content">    const catUrl = (paths.catalog &amp;&amp; paths.catalog.trim()) || '/data/catalogo_territorial.json';</td></tr><tr><td class="line-number" value="906"></td><td class="line-content">    let catalog = window.AT_CATALOG || null;</td></tr><tr><td class="line-number" value="907"></td><td class="line-content">    if (!catalog) {</td></tr><tr><td class="line-number" value="908"></td><td class="line-content">    try {</td></tr><tr><td class="line-number" value="909"></td><td class="line-content">        const rc = await fetch(catUrl);</td></tr><tr><td class="line-number" value="910"></td><td class="line-content">        if (!rc.ok) throw new Error(`HTTP ${rc.status} al cargar catálogo ${catUrl}`);</td></tr><tr><td class="line-number" value="911"></td><td class="line-content">        catalog = await rc.json();</td></tr><tr><td class="line-number" value="912"></td><td class="line-content">        window.AT_CATALOG = catalog;</td></tr><tr><td class="line-number" value="913"></td><td class="line-content">    } catch (err) {</td></tr><tr><td class="line-number" value="914"></td><td class="line-content">        console.warn('[AT] No se pudo cargar el catálogo de nombres:', err);</td></tr><tr><td class="line-number" value="915"></td><td class="line-content">        window.AT_CATALOG = catalog = null; // seguimos sin nombres amigables</td></tr><tr><td class="line-number" value="916"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="917"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="918"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="919"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="920"></td><td class="line-content"> let raw = window.AT_DATA || null; // usa caché si ya existe</td></tr><tr><td class="line-number" value="921"></td><td class="line-content">if (!raw) {</td></tr><tr><td class="line-number" value="922"></td><td class="line-content">  try {</td></tr><tr><td class="line-number" value="923"></td><td class="line-content">    const res = await fetch(url);</td></tr><tr><td class="line-number" value="924"></td><td class="line-content">    if (!res.ok) throw new Error(`HTTP ${res.status} al cargar ${url}`);</td></tr><tr><td class="line-number" value="925"></td><td class="line-content">    raw = await res.json();       // ✅ solo una vez</td></tr><tr><td class="line-number" value="926"></td><td class="line-content">    window.AT_DATA = raw;         // ✅ guarda en caché aquí</td></tr><tr><td class="line-number" value="927"></td><td class="line-content">  } catch (err) {</td></tr><tr><td class="line-number" value="928"></td><td class="line-content">    console.error('[AT] Error cargando GeoJSON:', err);</td></tr><tr><td class="line-number" value="929"></td><td class="line-content">    alert('No se pudo cargar el GeoJSON');</td></tr><tr><td class="line-number" value="930"></td><td class="line-content">    return;</td></tr><tr><td class="line-number" value="931"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="932"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="933"></td><td class="line-content">// a partir de aquí, usa 'raw'</td></tr><tr><td class="line-number" value="934"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="935"></td><td class="line-content">    const filtered = filterGeojson(raw, u);</td></tr><tr><td class="line-number" value="936"></td><td class="line-content">    console.log('[AT] Universo:', u, 'Total:', raw.features?.length||0, 'Filtradas:', filtered.features?.length||0);</td></tr><tr><td class="line-number" value="937"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="938"></td><td class="line-content">    if(!filtered.features || filtered.features.length===0){</td></tr><tr><td class="line-number" value="939"></td><td class="line-content">      console.warn('[AT] No hay geometrías para el universo seleccionado:', u);</td></tr><tr><td class="line-number" value="940"></td><td class="line-content">      alert('No hay datos para el universo seleccionado');</td></tr><tr><td class="line-number" value="941"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="942"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="943"></td><td class="line-content">    // Nombre fijo del campo (texto) del municipio</td></tr><tr><td class="line-number" value="944"></td><td class="line-content">        const MUN_NAME_KEY = 'MUNICIPIO';</td></tr><tr><td class="line-number" value="945"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="946"></td><td class="line-content">    // Detecta campo de CÓDIGO (si existe); si no, usa el de nombre</td></tr><tr><td class="line-number" value="947"></td><td class="line-content">        function detectMunCodeKey(raw){</td></tr><tr><td class="line-number" value="948"></td><td class="line-content">        const feats = raw.features || [];</td></tr><tr><td class="line-number" value="949"></td><td class="line-content">        const candidates = ['MUN','CVE_MUN','CLV_MUN','ID_MUN','MUNICIPIO_ID','MUNICIPIO_CVE','CVE_MUNICIPIO','CVE_MPIO'];</td></tr><tr><td class="line-number" value="950"></td><td class="line-content">        for (const k of candidates) {</td></tr><tr><td class="line-number" value="951"></td><td class="line-content">            if (feats.some(f =&gt; (f.properties?.[k] ?? '') !== '')) return k;</td></tr><tr><td class="line-number" value="952"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="953"></td><td class="line-content">        return null;</td></tr><tr><td class="line-number" value="954"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="955"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="956"></td><td class="line-content">        const munCodeKey = detectMunCodeKey(raw) || MUN_NAME_KEY; // fallback: nombre</td></tr><tr><td class="line-number" value="957"></td><td class="line-content">        FIELD_KEYS.mun = munCodeKey;</td></tr><tr><td class="line-number" value="958"></td><td class="line-content">        window.AT_KEYS = { munCode: munCodeKey, munName: MUN_NAME_KEY };</td></tr><tr><td class="line-number" value="959"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="960"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="961"></td><td class="line-content">    // e) Dibujar capa</td></tr><tr><td class="line-number" value="962"></td><td class="line-content">        const layer = L.geoJSON(filtered, {</td></tr><tr><td class="line-number" value="963"></td><td class="line-content">      style: { color:'#000000', weight:1.2, fillOpacity:0.15 },</td></tr><tr><td class="line-number" value="964"></td><td class="line-content">      onEachFeature: (feat, lyr) =&gt; {</td></tr><tr><td class="line-number" value="965"></td><td class="line-content">        const p = feat.properties || {};</td></tr><tr><td class="line-number" value="966"></td><td class="line-content">        const muni = p[FIELD_KEYS.mun] ?? '—';</td></tr><tr><td class="line-number" value="967"></td><td class="line-content">        const dl   = p[FIELD_KEYS.dl]  ?? '—';</td></tr><tr><td class="line-number" value="968"></td><td class="line-content">        const df   = p[FIELD_KEYS.df]  ?? '—';</td></tr><tr><td class="line-number" value="969"></td><td class="line-content">        lyr.bindPopup(`&lt;b&gt;Sección&lt;/b&gt;: ${p.SECCION ?? '—'}&lt;br&gt;&lt;b&gt;Mun&lt;/b&gt;: ${muni}&lt;br&gt;&lt;b&gt;DL&lt;/b&gt;: ${dl}&lt;br&gt;&lt;b&gt;DF&lt;/b&gt;: ${df}`);</td></tr><tr><td class="line-number" value="970"></td><td class="line-content">        lyr.on('mouseover', () =&gt; lyr.setStyle({weight:2}));</td></tr><tr><td class="line-number" value="971"></td><td class="line-content">        lyr.on('mouseout',  () =&gt; lyr.setStyle({weight:1.2}));</td></tr><tr><td class="line-number" value="972"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="973"></td><td class="line-content">    }).addTo(atMap);</td></tr><tr><td class="line-number" value="974"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="975"></td><td class="line-content">    try { atMap.fitBounds(layer.getBounds(), { padding:[20,20] }); } catch(e){}</td></tr><tr><td class="line-number" value="976"></td><td class="line-content">    window.AT_CTX = { universe: u, paths, map: atMap, layer };</td></tr><tr><td class="line-number" value="977"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="978"></td><td class="line-content">    function getMunNameFromCatalog(code){</td></tr><tr><td class="line-number" value="979"></td><td class="line-content">      const cat = window.AT_CATALOG;</td></tr><tr><td class="line-number" value="980"></td><td class="line-content">      if (!cat?.municipios) return String(code ?? '');</td></tr><tr><td class="line-number" value="981"></td><td class="line-content">      return cat.municipios[String(code)] || String(code ?? '');</td></tr><tr><td class="line-number" value="982"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="983"></td><td class="line-content">    function getDfListFromCatalog(feats){</td></tr><tr><td class="line-number" value="984"></td><td class="line-content">      return (window.AT_CATALOG?.distritos_federales &amp;&amp; window.AT_CATALOG.distritos_federales.length)</td></tr><tr><td class="line-number" value="985"></td><td class="line-content">        ? window.AT_CATALOG.distritos_federales</td></tr><tr><td class="line-number" value="986"></td><td class="line-content">        : uniqSorted(feats.map(f =&gt; f.properties?.[FIELD_KEYS.df]));</td></tr><tr><td class="line-number" value="987"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="988"></td><td class="line-content">    function getDlListFromCatalog(feats){</td></tr><tr><td class="line-number" value="989"></td><td class="line-content">      return (window.AT_CATALOG?.distritos_locales &amp;&amp; window.AT_CATALOG.distritos_locales.length)</td></tr><tr><td class="line-number" value="990"></td><td class="line-content">        ? window.AT_CATALOG.distritos_locales</td></tr><tr><td class="line-number" value="991"></td><td class="line-content">        : uniqSorted(feats.map(f =&gt; f.properties?.[FIELD_KEYS.dl]));</td></tr><tr><td class="line-number" value="992"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="993"></td><td class="line-content">        initMiniSelector(raw, u);</td></tr><tr><td class="line-number" value="994"></td><td class="line-content">        initSectionSearch(window.AT_DATA || raw, u);  </td></tr><tr><td class="line-number" value="995"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="996"></td><td class="line-content">    });</td></tr><tr><td class="line-number" value="997"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="998"></td><td class="line-content">    document.getElementById('btn-gt-part')?.addEventListener('click', () =&gt; {</td></tr><tr><td class="line-number" value="999"></td><td class="line-content">      AT27_GT_PART_ejecutar('A','2024');</td></tr><tr><td class="line-number" value="1000"></td><td class="line-content">    });</td></tr><tr><td class="line-number" value="1001"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1002"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1003"></td><td class="line-content">  (function wireATHotkeys(){</td></tr><tr><td class="line-number" value="1004"></td><td class="line-content">      if (window.__AT_HOTKEYS) return;</td></tr><tr><td class="line-number" value="1005"></td><td class="line-content">      window.__AT_HOTKEYS = true;</td></tr><tr><td class="line-number" value="1006"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1007"></td><td class="line-content">      window.addEventListener('keydown', (e)=&gt;{</td></tr><tr><td class="line-number" value="1008"></td><td class="line-content">        // Esc: cerrar panel</td></tr><tr><td class="line-number" value="1009"></td><td class="line-content">        if (e.key === 'Escape'){</td></tr><tr><td class="line-number" value="1010"></td><td class="line-content">          if (document.getElementById('sec-info')?.style.display !== 'none'){</td></tr><tr><td class="line-number" value="1011"></td><td class="line-content">            e.preventDefault();</td></tr><tr><td class="line-number" value="1012"></td><td class="line-content">            closeSecInfoPanel();</td></tr><tr><td class="line-number" value="1013"></td><td class="line-content">          }</td></tr><tr><td class="line-number" value="1014"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1015"></td><td class="line-content">        // Ctrl+K (o Cmd+K en Mac): enfocar buscador de secciones</td></tr><tr><td class="line-number" value="1016"></td><td class="line-content">        if ((e.ctrlKey || e.metaKey) &amp;&amp; e.key.toLowerCase() === 'k'){</td></tr><tr><td class="line-number" value="1017"></td><td class="line-content">          e.preventDefault();</td></tr><tr><td class="line-number" value="1018"></td><td class="line-content">          document.getElementById('sec-q')?.focus();</td></tr><tr><td class="line-number" value="1019"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1020"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="1021"></td><td class="line-content">    })();</td></tr><tr><td class="line-number" value="1022"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1023"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1024"></td><td class="line-content">  <span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="1025"></td><td class="line-content">  <span class="html-tag">&lt;div <span class="html-attribute-name">id</span>="<span class="html-attribute-value">sec-info</span>"&gt;</span></td></tr><tr><td class="line-number" value="1026"></td><td class="line-content">    <span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">hdr</span>"&gt;</span></td></tr><tr><td class="line-number" value="1027"></td><td class="line-content">    <span class="html-tag">&lt;span <span class="html-attribute-name">class</span>="<span class="html-attribute-value">ttl</span>"&gt;</span>Sección<span class="html-tag">&lt;/span&gt;</span></td></tr><tr><td class="line-number" value="1028"></td><td class="line-content">    <span class="html-tag">&lt;button <span class="html-attribute-name">id</span>="<span class="html-attribute-value">sec-close</span>" <span class="html-attribute-name">class</span>="<span class="html-attribute-value">btn-close</span>" <span class="html-attribute-name">aria-label</span>="<span class="html-attribute-value">Cerrar</span>"&gt;</span>×<span class="html-tag">&lt;/button&gt;</span></td></tr><tr><td class="line-number" value="1029"></td><td class="line-content">  <span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="1030"></td><td class="line-content">  <span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">body</span>"&gt;</span></td></tr><tr><td class="line-number" value="1031"></td><td class="line-content">    <span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">row</span>"&gt;</span><span class="html-tag">&lt;span <span class="html-attribute-name">class</span>="<span class="html-attribute-value">k</span>"&gt;</span>Sección<span class="html-tag">&lt;/span&gt;</span>        <span class="html-tag">&lt;span <span class="html-attribute-name">class</span>="<span class="html-attribute-value">v</span>" <span class="html-attribute-name">id</span>="<span class="html-attribute-value">si-sec</span>"&gt;</span>—<span class="html-tag">&lt;/span&gt;</span><span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="1032"></td><td class="line-content">    <span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">row</span>"&gt;</span><span class="html-tag">&lt;span <span class="html-attribute-name">class</span>="<span class="html-attribute-value">k</span>"&gt;</span>Distrito Federal<span class="html-tag">&lt;/span&gt;</span><span class="html-tag">&lt;span <span class="html-attribute-name">class</span>="<span class="html-attribute-value">v</span>" <span class="html-attribute-name">id</span>="<span class="html-attribute-value">si-df</span>"&gt;</span>—<span class="html-tag">&lt;/span&gt;</span><span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="1033"></td><td class="line-content">    <span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">row</span>"&gt;</span><span class="html-tag">&lt;span <span class="html-attribute-name">class</span>="<span class="html-attribute-value">k</span>"&gt;</span>Distrito Local<span class="html-tag">&lt;/span&gt;</span>  <span class="html-tag">&lt;span <span class="html-attribute-name">class</span>="<span class="html-attribute-value">v</span>" <span class="html-attribute-name">id</span>="<span class="html-attribute-value">si-dl</span>"&gt;</span>—<span class="html-tag">&lt;/span&gt;</span><span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="1034"></td><td class="line-content">    <span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">row</span>"&gt;</span><span class="html-tag">&lt;span <span class="html-attribute-name">class</span>="<span class="html-attribute-value">k</span>"&gt;</span>LN (2024)<span class="html-tag">&lt;/span&gt;</span>    <span class="html-tag">&lt;span <span class="html-attribute-name">class</span>="<span class="html-attribute-value">v</span>" <span class="html-attribute-name">id</span>="<span class="html-attribute-value">si-ln</span>"&gt;</span>—<span class="html-tag">&lt;/span&gt;</span><span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="1035"></td><td class="line-content">  <span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="1036"></td><td class="line-content"><span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="1037"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1038"></td><td class="line-content"><span class="html-tag">&lt;script&gt;</span></td></tr><tr><td class="line-number" value="1039"></td><td class="line-content">  /* ========== MOD: GANAR TODO · PARTICIPACIÓN (AT27_GT_PART_) ========== */</td></tr><tr><td class="line-number" value="1040"></td><td class="line-content">    const AT27_GT_PART_PUESTOS = { A:'Ayuntamiento', DL:'Diputado Local', DF:'Diputado Federal', G:'Gobernador', S:'Senador', P:'Presidente' };</td></tr><tr><td class="line-number" value="1041"></td><td class="line-content">    const AT27_GT_PART_COLORS  = { LOW:'#ef4444', MID:'#facc15', HIGH:'#22c55e' };</td></tr><tr><td class="line-number" value="1042"></td><td class="line-content">    const AT27_GT_PART_sec  = s =&gt; String(s??'').replace(/\D+/g,'');</td></tr><tr><td class="line-number" value="1043"></td><td class="line-content">    const AT27_GT_PART_yearsFor = p =&gt; (['G','S','P'].includes(p) ? ['2018','2024','2027*'] : ['2018','2021','2024','2027*']);</td></tr><tr><td class="line-number" value="1044"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1045"></td><td class="line-content">    function AT27_GT_PART_getUniverseSecIds(){</td></tr><tr><td class="line-number" value="1046"></td><td class="line-content">      const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];</td></tr><tr><td class="line-number" value="1047"></td><td class="line-content">      const ids = [];</td></tr><tr><td class="line-number" value="1048"></td><td class="line-content">      for (const f of feats){</td></tr><tr><td class="line-number" value="1049"></td><td class="line-content">        const p = f.properties||{};</td></tr><tr><td class="line-number" value="1050"></td><td class="line-content">        const id = AT27_GT_PART_sec(p.ID ?? p.Seccion ?? p.SECCION ?? p.seccion ?? p.id ?? p.SECCION);</td></tr><tr><td class="line-number" value="1051"></td><td class="line-content">        if (id) ids.push(id);</td></tr><tr><td class="line-number" value="1052"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="1053"></td><td class="line-content">      return [...new Set(ids)];</td></tr><tr><td class="line-number" value="1054"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1055"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1056"></td><td class="line-content">    function AT27_GT_PART_partPct(row){</td></tr><tr><td class="line-number" value="1057"></td><td class="line-content">      if (!row) return null;</td></tr><tr><td class="line-number" value="1058"></td><td class="line-content">      const ln = Number(row.LN||0); if (!ln) return null;</td></tr><tr><td class="line-number" value="1059"></td><td class="line-content">      let votos = (row.VOTOS!=null) ? Number(row.VOTOS||0) : 0;</td></tr><tr><td class="line-number" value="1060"></td><td class="line-content">      if (row.VOTOS==null){ for (const [k,v] of Object.entries(row)){ if (k!=='LN'&amp;&amp;k!=='VOTOS') votos += Number(v||0); } }</td></tr><tr><td class="line-number" value="1061"></td><td class="line-content">      const pct = (votos/ln)*100;</td></tr><tr><td class="line-number" value="1062"></td><td class="line-content">      return Math.max(0, Math.min(100, pct));</td></tr><tr><td class="line-number" value="1063"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1064"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1065"></td><td class="line-content">    // Proyección 2027 (ver explicación en el mensaje)</td></tr><tr><td class="line-number" value="1066"></td><td class="line-content">    function AT27_GT_PART_project2027(slot, puesto){</td></tr><tr><td class="line-number" value="1067"></td><td class="line-content">      const p18 = AT27_GT_PART_partPct(slot['2018']);</td></tr><tr><td class="line-number" value="1068"></td><td class="line-content">      const p21 = AT27_GT_PART_partPct(slot['2021']);</td></tr><tr><td class="line-number" value="1069"></td><td class="line-content">      const p24 = AT27_GT_PART_partPct(slot['2024']);</td></tr><tr><td class="line-number" value="1070"></td><td class="line-content">      const vals = [p18,p21,p24].filter(v=&gt;typeof v==='number'&amp;&amp;isFinite(v));</td></tr><tr><td class="line-number" value="1071"></td><td class="line-content">      if (vals.length===0) return null;</td></tr><tr><td class="line-number" value="1072"></td><td class="line-content">      if (['G','S','P'].includes(puesto)){</td></tr><tr><td class="line-number" value="1073"></td><td class="line-content">        const a = (typeof p18==='number')?p18:p24, b = (typeof p24==='number')?p24:p18;</td></tr><tr><td class="line-number" value="1074"></td><td class="line-content">        const slopePerYear = (b-a)/6;</td></tr><tr><td class="line-number" value="1075"></td><td class="line-content">        return Math.max(0, Math.min(100, b + 0.6*slopePerYear*3));</td></tr><tr><td class="line-number" value="1076"></td><td class="line-content">      } else {</td></tr><tr><td class="line-number" value="1077"></td><td class="line-content">        const pts=[]; if (typeof p18==='number') pts.push({t:0,y:p18,w:1.0}); if (typeof p21==='number') pts.push({t:3,y:p21,w:1.5}); if (typeof p24==='number') pts.push({t:6,y:p24,w:2.0});</td></tr><tr><td class="line-number" value="1078"></td><td class="line-content">        const W=pts.reduce((a,p)=&gt;a+p.w,0), tbar=pts.reduce((a,p)=&gt;a+p.w*p.t,0)/W, ybar=pts.reduce((a,p)=&gt;a+p.w*p.y,0)/W;</td></tr><tr><td class="line-number" value="1079"></td><td class="line-content">        const num=pts.reduce((a,p)=&gt;a+p.w*(p.t-tbar)*(p.y-ybar),0), den=pts.reduce((a,p)=&gt;a+p.w*(p.t-tbar)*(p.t-tbar),0)||1e-9;</td></tr><tr><td class="line-number" value="1080"></td><td class="line-content">        const b1=num/den, b0=ybar-b1*tbar;</td></tr><tr><td class="line-number" value="1081"></td><td class="line-content">        return Math.max(0, Math.min(100, b0 + b1*9));</td></tr><tr><td class="line-number" value="1082"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="1083"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1084"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1085"></td><td class="line-content">    function AT27_GT_PART_compute(js, secIds, puesto, year){</td></tr><tr><td class="line-number" value="1086"></td><td class="line-content">      const perSec = {}; const bins={LOW:0,MID:0,HIGH:0};</td></tr><tr><td class="line-number" value="1087"></td><td class="line-content">      let lnW=0, partW=0;</td></tr><tr><td class="line-number" value="1088"></td><td class="line-content">      for (const sec of secIds){</td></tr><tr><td class="line-number" value="1089"></td><td class="line-content">        const slot = js?.secciones?.[sec]; if (!slot) continue;</td></tr><tr><td class="line-number" value="1090"></td><td class="line-content">        const pct = (year==='2027*') ? AT27_GT_PART_project2027(slot, puesto) : AT27_GT_PART_partPct(slot[year]);</td></tr><tr><td class="line-number" value="1091"></td><td class="line-content">        if (pct==null || !isFinite(pct)) continue;</td></tr><tr><td class="line-number" value="1092"></td><td class="line-content">        perSec[sec]=pct;</td></tr><tr><td class="line-number" value="1093"></td><td class="line-content">        if (pct&lt;30) bins.LOW++; else if (pct&lt;50) bins.MID++; else bins.HIGH++;</td></tr><tr><td class="line-number" value="1094"></td><td class="line-content">        const rowForLN = (year==='2027*' ? slot['2024'] : slot[year]) || {};</td></tr><tr><td class="line-number" value="1095"></td><td class="line-content">        const ln = Number(rowForLN?.LN||0); if (ln&gt;0){ lnW += ln; partW += pct*ln; }</td></tr><tr><td class="line-number" value="1096"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="1097"></td><td class="line-content">      const avg = lnW&gt;0 ? (partW/lnW) : NaN;</td></tr><tr><td class="line-number" value="1098"></td><td class="line-content">      return { perSec, bins, avg };</td></tr><tr><td class="line-number" value="1099"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1100"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1101"></td><td class="line-content">    function AT27_GT_PART_clearOverlay(){</td></tr><tr><td class="line-number" value="1102"></td><td class="line-content">      const map = window.AT_CTX?.map || window.map; if (!map) return;</td></tr><tr><td class="line-number" value="1103"></td><td class="line-content">      if (window.AT27_GT_PART_LAYER){ try{ map.removeLayer(AT27_GT_PART_LAYER); }catch(_){ } window.AT27_GT_PART_LAYER=null; }</td></tr><tr><td class="line-number" value="1104"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1105"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1106"></td><td class="line-content">    function AT27_GT_PART_buildOverlay(perSec){</td></tr><tr><td class="line-number" value="1107"></td><td class="line-content">      const map = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="1108"></td><td class="line-content">      const base = window.AT_CTX?.layer?.toGeoJSON?.() || window.AT_DATA;</td></tr><tr><td class="line-number" value="1109"></td><td class="line-content">      if (!map || !base?.features) return;</td></tr><tr><td class="line-number" value="1110"></td><td class="line-content">      if (map.createPane &amp;&amp; !map.getPane('at27_gt_part_pane')){</td></tr><tr><td class="line-number" value="1111"></td><td class="line-content">        map.createPane('at27_gt_part_pane'); map.getPane('at27_gt_part_pane').style.zIndex=660; map.getPane('at27_gt_part_pane').style.pointerEvents='none';</td></tr><tr><td class="line-number" value="1112"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="1113"></td><td class="line-content">      const geo = { type:'FeatureCollection', features: base.features.filter(f=&gt;{</td></tr><tr><td class="line-number" value="1114"></td><td class="line-content">        const id = AT27_GT_PART_sec(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);</td></tr><tr><td class="line-number" value="1115"></td><td class="line-content">        return perSec[id]!=null;</td></tr><tr><td class="line-number" value="1116"></td><td class="line-content">      })};</td></tr><tr><td class="line-number" value="1117"></td><td class="line-content">      const layer = L.geoJSON(geo, {</td></tr><tr><td class="line-number" value="1118"></td><td class="line-content">        pane:'at27_gt_part_pane',</td></tr><tr><td class="line-number" value="1119"></td><td class="line-content">        style:f=&gt;{</td></tr><tr><td class="line-number" value="1120"></td><td class="line-content">          const id = AT27_GT_PART_sec(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);</td></tr><tr><td class="line-number" value="1121"></td><td class="line-content">          const pct = perSec[id];</td></tr><tr><td class="line-number" value="1122"></td><td class="line-content">          const col = (pct&lt;30)?AT27_GT_PART_COLORS.LOW: (pct&lt;50?AT27_GT_PART_COLORS.MID:AT27_GT_PART_COLORS.HIGH);</td></tr><tr><td class="line-number" value="1123"></td><td class="line-content">          return { color:col, weight:1, opacity:.9, fillColor:col, fillOpacity:.45 };</td></tr><tr><td class="line-number" value="1124"></td><td class="line-content">        },</td></tr><tr><td class="line-number" value="1125"></td><td class="line-content">        interactive:false</td></tr><tr><td class="line-number" value="1126"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="1127"></td><td class="line-content">      AT27_GT_PART_clearOverlay(); layer.addTo(map); window.AT27_GT_PART_LAYER=layer;</td></tr><tr><td class="line-number" value="1128"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1129"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1130"></td><td class="line-content">    function AT27_GT_PART_getOrCreatePanel(){</td></tr><tr><td class="line-number" value="1131"></td><td class="line-content">      let panel=document.getElementById('AT27_GT_PART_panel'); if (panel) return panel;</td></tr><tr><td class="line-number" value="1132"></td><td class="line-content">      panel=document.createElement('div');</td></tr><tr><td class="line-number" value="1133"></td><td class="line-content">      Object.assign(panel.style,{position:'fixed',right:'32px',top:'32px',zIndex:9999,width:'360px',height:'230px',background:'#fff',border:'1px solid #e5e7eb',borderRadius:'14px',boxShadow:'0 18px 40px rgba(0,0,0,.18)',overflow:'hidden',resize:'both',fontFamily:'system-ui, Segoe UI, Roboto, Arial'});</td></tr><tr><td class="line-number" value="1134"></td><td class="line-content">      panel.id='AT27_GT_PART_panel';</td></tr><tr><td class="line-number" value="1135"></td><td class="line-content">      panel.innerHTML=`</td></tr><tr><td class="line-number" value="1136"></td><td class="line-content">        &lt;div id="AT27_GT_PART_hdr" style="cursor:move; user-select:none; background:#efefef; color:#111; padding:10px 12px; display:flex; gap:10px; align-items:center;"&gt;</td></tr><tr><td class="line-number" value="1137"></td><td class="line-content">          &lt;div style="font-weight:800;"&gt;Participación por sección&lt;/div&gt;</td></tr><tr><td class="line-number" value="1138"></td><td class="line-content">          &lt;select id="AT27_GT_PART_selYear"   style="margin-left:auto; background:#fff; color:#111827; border-radius:8px; padding:4px 8px; border:none; outline:none;"&gt;&lt;/select&gt;</td></tr><tr><td class="line-number" value="1139"></td><td class="line-content">          &lt;select id="AT27_GT_PART_selPuesto" style="background:#fff; color:#111827; border-radius:8px; padding:4px 8px; border:none; outline:none;"&gt;</td></tr><tr><td class="line-number" value="1140"></td><td class="line-content">            ${Object.entries(AT27_GT_PART_PUESTOS).map(([k,v])=&gt;`&lt;option value="${k}"&gt;${v}&lt;/option&gt;`).join('')}</td></tr><tr><td class="line-number" value="1141"></td><td class="line-content">          &lt;/select&gt;</td></tr><tr><td class="line-number" value="1142"></td><td class="line-content">          &lt;button id="AT27_GT_PART_close" title="Cerrar" style="background:transparent;color:#111;border:none;font-size:18px;cursor:pointer;"&gt;×&lt;/button&gt;</td></tr><tr><td class="line-number" value="1143"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="1144"></td><td class="line-content">        &lt;div id="AT27_GT_PART_body" style="padding:10px 12px; height: calc(100% - 50px); overflow:auto;"&gt;</td></tr><tr><td class="line-number" value="1145"></td><td class="line-content">          &lt;div style="margin-bottom:8px;"&gt;</td></tr><tr><td class="line-number" value="1146"></td><td class="line-content">            &lt;div style="font-weight:700;"&gt;Leyenda&lt;/div&gt;</td></tr><tr><td class="line-number" value="1147"></td><td class="line-content">            &lt;div style="display:flex; gap:10px; margin-top:6px; font-size:13px;"&gt;</td></tr><tr><td class="line-number" value="1148"></td><td class="line-content">              &lt;div style="display:flex; align-items:center; gap:6px;"&gt;&lt;span style="display:inline-block;width:12px;height:12px;background:${AT27_GT_PART_COLORS.LOW};border:1px solid rgba(0,0,0,.2);border-radius:3px;"&gt;&lt;/span&gt; &lt; 30%&lt;/div&gt;</td></tr><tr><td class="line-number" value="1149"></td><td class="line-content">              &lt;div style="display:flex; align-items:center; gap:6px;"&gt;&lt;span style="display:inline-block;width:12px;height:12px;background:${AT27_GT_PART_COLORS.MID};border:1px solid rgba(0,0,0,.2);border-radius:3px;"&gt;&lt;/span&gt; 30–50%&lt;/div&gt;</td></tr><tr><td class="line-number" value="1150"></td><td class="line-content">              &lt;div style="display:flex; align-items:center; gap:6px;"&gt;&lt;span style="display:inline-block;width:12px;height:12px;background:${AT27_GT_PART_COLORS.HIGH};border:1px solid rgba(0,0,0,.2);border-radius:3px;"&gt;&lt;/span&gt; &gt; 50%&lt;/div&gt;</td></tr><tr><td class="line-number" value="1151"></td><td class="line-content">            &lt;/div&gt;</td></tr><tr><td class="line-number" value="1152"></td><td class="line-content">          &lt;/div&gt;</td></tr><tr><td class="line-number" value="1153"></td><td class="line-content">          &lt;div id="AT27_GT_PART_stats" style="font-size:13px;color:#334155;"&gt;&lt;/div&gt;</td></tr><tr><td class="line-number" value="1154"></td><td class="line-content">        &lt;/div&gt;`;</td></tr><tr><td class="line-number" value="1155"></td><td class="line-content">      document.body.appendChild(panel);</td></tr><tr><td class="line-number" value="1156"></td><td class="line-content">      panel.querySelector('#AT27_GT_PART_close').onclick=()=&gt;{ AT27_GT_PART_clearOverlay(); panel.remove(); };</td></tr><tr><td class="line-number" value="1157"></td><td class="line-content">      (function drag(panel,handle){ let drag=false,sx=0,sy=0,bx=0,by=0; handle.addEventListener('mousedown',e=&gt;{drag=true;sx=e.clientX;sy=e.clientY;const r=panel.getBoundingClientRect();bx=r.left;by=r.top;document.body.style.userSelect='none';}); window.addEventListener('mousemove',e=&gt;{if(!drag)return; const dx=e.clientX-sx, dy=e.clientY-sy; panel.style.left=(bx+dx)+'px'; panel.style.top=(by+dy)+'px'; panel.style.right='auto';}); window.addEventListener('mouseup',()=&gt;{drag=false;document.body.style.userSelect='';});})(panel, panel.querySelector('#AT27_GT_PART_hdr'));</td></tr><tr><td class="line-number" value="1158"></td><td class="line-content">      return panel;</td></tr><tr><td class="line-number" value="1159"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1160"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1161"></td><td class="line-content">    function AT27_GT_PART_populateYears(puesto){</td></tr><tr><td class="line-number" value="1162"></td><td class="line-content">      const panel=AT27_GT_PART_getOrCreatePanel(); const selY=panel.querySelector('#AT27_GT_PART_selYear');</td></tr><tr><td class="line-number" value="1163"></td><td class="line-content">      const years=AT27_GT_PART_yearsFor(puesto); selY.innerHTML=years.map(y=&gt;`&lt;option value="${y}"&gt;${y}&lt;/option&gt;`).join(''); if (years.includes('2024')) selY.value='2024';</td></tr><tr><td class="line-number" value="1164"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1165"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1166"></td><td class="line-content">    async function AT27_GT_PART_update(){</td></tr><tr><td class="line-number" value="1167"></td><td class="line-content">      const panel=AT27_GT_PART_getOrCreatePanel(); const selY=panel.querySelector('#AT27_GT_PART_selYear'); const selP=panel.querySelector('#AT27_GT_PART_selPuesto');</td></tr><tr><td class="line-number" value="1168"></td><td class="line-content">      const puesto=selP.value, year=selY.value;</td></tr><tr><td class="line-number" value="1169"></td><td class="line-content">      const secIds=AT27_GT_PART_getUniverseSecIds();</td></tr><tr><td class="line-number" value="1170"></td><td class="line-content">      const js=await loadPuesto(puesto);</td></tr><tr><td class="line-number" value="1171"></td><td class="line-content">      const { perSec, bins, avg }=AT27_GT_PART_compute(js, secIds, puesto, year);</td></tr><tr><td class="line-number" value="1172"></td><td class="line-content">      AT27_GT_PART_buildOverlay(perSec);</td></tr><tr><td class="line-number" value="1173"></td><td class="line-content">      const total=secIds.length, stats = `</td></tr><tr><td class="line-number" value="1174"></td><td class="line-content">        &lt;div&gt;Universo: &lt;b&gt;${total}&lt;/b&gt; secciones · Puesto &lt;b&gt;${AT27_GT_PART_PUESTOS[puesto]||puesto}&lt;/b&gt; · Año &lt;b&gt;${year}&lt;/b&gt;&lt;/div&gt;</td></tr><tr><td class="line-number" value="1175"></td><td class="line-content">        &lt;div style="margin-top:4px;"&gt;Promedio del universo (ponderado por LN): &lt;b&gt;${isFinite(avg)?avg.toFixed(1):'—'}%&lt;/b&gt;&lt;/div&gt;</td></tr><tr><td class="line-number" value="1176"></td><td class="line-content">        &lt;div style="margin-top:6px; display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px;"&gt;</td></tr><tr><td class="line-number" value="1177"></td><td class="line-content">          &lt;div&gt;&lt;span style="color:${AT27_GT_PART_COLORS.LOW};font-weight:700;"&gt;${bins.LOW}&lt;/span&gt; &lt;span style="color:#64748b;"&gt;(&lt; 30%)&lt;/span&gt;&lt;/div&gt;</td></tr><tr><td class="line-number" value="1178"></td><td class="line-content">          &lt;div&gt;&lt;span style="color:#b45309;font-weight:700;"&gt;${bins.MID}&lt;/span&gt; &lt;span style="color:#64748b;"&gt;(30–50%)&lt;/span&gt;&lt;/div&gt;</td></tr><tr><td class="line-number" value="1179"></td><td class="line-content">          &lt;div&gt;&lt;span style="color:${AT27_GT_PART_COLORS.HIGH};font-weight:700;"&gt;${bins.HIGH}&lt;/span&gt; &lt;span style="color:#64748b;"&gt;(&gt; 50%)&lt;/span&gt;&lt;/div&gt;</td></tr><tr><td class="line-number" value="1180"></td><td class="line-content">        &lt;/div&gt;`;</td></tr><tr><td class="line-number" value="1181"></td><td class="line-content">      panel.querySelector('#AT27_GT_PART_stats').innerHTML=stats;</td></tr><tr><td class="line-number" value="1182"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1183"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1184"></td><td class="line-content">    async function AT27_GT_PART_ejecutar(puestoInicial='A', yearInicial='2024'){</td></tr><tr><td class="line-number" value="1185"></td><td class="line-content">      const panel=AT27_GT_PART_getOrCreatePanel(); const selY=panel.querySelector('#AT27_GT_PART_selYear'); const selP=panel.querySelector('#AT27_GT_PART_selPuesto');</td></tr><tr><td class="line-number" value="1186"></td><td class="line-content">      selP.value=puestoInicial; AT27_GT_PART_populateYears(puestoInicial); if ([...selY.options].some(o=&gt;o.value===yearInicial)) selY.value=yearInicial;</td></tr><tr><td class="line-number" value="1187"></td><td class="line-content">      selP.onchange=()=&gt;{ AT27_GT_PART_populateYears(selP.value); AT27_GT_PART_update(); };</td></tr><tr><td class="line-number" value="1188"></td><td class="line-content">      selY.onchange=()=&gt; AT27_GT_PART_update();</td></tr><tr><td class="line-number" value="1189"></td><td class="line-content">      await AT27_GT_PART_update();</td></tr><tr><td class="line-number" value="1190"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1191"></td><td class="line-content">    /* ============================ FIN MOD ============================ */</td></tr><tr><td class="line-number" value="1192"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1193"></td><td class="line-content"><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="1194"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1195"></td><td class="line-content"><span class="html-tag">&lt;script&gt;</span></td></tr><tr><td class="line-number" value="1196"></td><td class="line-content">  // Usa tu loader de JSON electorales si no existe loadPuesto</td></tr><tr><td class="line-number" value="1197"></td><td class="line-content">  window.loadPuesto = window.loadPuesto || window.getElectData;</td></tr><tr><td class="line-number" value="1198"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1199"></td><td class="line-content">  // Evita que la barra “coma” los clicks/scroll del mapa y cablea el botón</td></tr><tr><td class="line-number" value="1200"></td><td class="line-content">  (function wireTopBarGT(){</td></tr><tr><td class="line-number" value="1201"></td><td class="line-content">    const bar = document.getElementById('top-toolbar');</td></tr><tr><td class="line-number" value="1202"></td><td class="line-content">    if (!bar || bar.__wired) return;</td></tr><tr><td class="line-number" value="1203"></td><td class="line-content">    if (window.L &amp;&amp; L.DomEvent){</td></tr><tr><td class="line-number" value="1204"></td><td class="line-content">      L.DomEvent.disableClickPropagation(bar);</td></tr><tr><td class="line-number" value="1205"></td><td class="line-content">      L.DomEvent.disableScrollPropagation(bar);</td></tr><tr><td class="line-number" value="1206"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1207"></td><td class="line-content">    document.getElementById('btn-gt-part')?.addEventListener('click', () =&gt; {</td></tr><tr><td class="line-number" value="1208"></td><td class="line-content">      // Lanza el panel flotante de Participación (el overlay se pinta en el mapa)</td></tr><tr><td class="line-number" value="1209"></td><td class="line-content">      AT27_GT_PART_ejecutar('A','2024');</td></tr><tr><td class="line-number" value="1210"></td><td class="line-content">    });</td></tr><tr><td class="line-number" value="1211"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1212"></td><td class="line-content">    document.getElementById('btn-estabilidad')?.addEventListener('click', () =&gt; {</td></tr><tr><td class="line-number" value="1213"></td><td class="line-content">      AT27_EP_ejecutar(); // puesto fijo 'A'</td></tr><tr><td class="line-number" value="1214"></td><td class="line-content">    });</td></tr><tr><td class="line-number" value="1215"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1216"></td><td class="line-content">    document.getElementById('btn-ayuda')?.addEventListener('click', ()=&gt;{</td></tr><tr><td class="line-number" value="1217"></td><td class="line-content">      document.getElementById('mini-ayuda-GT')?.scrollIntoView({behavior:'smooth', block:'start'});</td></tr><tr><td class="line-number" value="1218"></td><td class="line-content">    });</td></tr><tr><td class="line-number" value="1219"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1220"></td><td class="line-content">    document.getElementById('btn-gt-metas')?.addEventListener('click', () =&gt; {</td></tr><tr><td class="line-number" value="1221"></td><td class="line-content">      AT27_GT_META_ejecutar('A', 50, 3); // puesto A, meta 50%, tolerancia 3 pp</td></tr><tr><td class="line-number" value="1222"></td><td class="line-content">    });</td></tr><tr><td class="line-number" value="1223"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1224"></td><td class="line-content">    document.getElementById('btn-gt-ganar')?.addEventListener('click', () =&gt; {</td></tr><tr><td class="line-number" value="1225"></td><td class="line-content">      AT27_GT_GANAR_ejecutar('A','PAN'); // abre con Ayuntamiento + PAN</td></tr><tr><td class="line-number" value="1226"></td><td class="line-content">    });</td></tr><tr><td class="line-number" value="1227"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1228"></td><td class="line-content">    document.getElementById('btn-recentrar')?.addEventListener('click', () =&gt; {</td></tr><tr><td class="line-number" value="1229"></td><td class="line-content">      AT27_fitUniverseBounds();</td></tr><tr><td class="line-number" value="1230"></td><td class="line-content">    });</td></tr><tr><td class="line-number" value="1231"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="1232"></td><td class="line-content">        /* ====== Cableado del botón de la barra (añade un botón con id="btn-prob-volteo") ====== */</td></tr><tr><td class="line-number" value="1233"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="1234"></td><td class="line-content">      document.getElementById('btn-prob-volteo')?.addEventListener('click',() =&gt;{</td></tr><tr><td class="line-number" value="1235"></td><td class="line-content">         AT27_PV_open();</td></tr><tr><td class="line-number" value="1236"></td><td class="line-content">          });</td></tr><tr><td class="line-number" value="1237"></td><td class="line-content">          // Atajo de teclado: R</td></tr><tr><td class="line-number" value="1238"></td><td class="line-content">          document.addEventListener('keydown', (e)=&gt;{</td></tr><tr><td class="line-number" value="1239"></td><td class="line-content">            if (e.key === 'R' || e.key === 'r'){</td></tr><tr><td class="line-number" value="1240"></td><td class="line-content">              e.preventDefault();</td></tr><tr><td class="line-number" value="1241"></td><td class="line-content">              AT27_fitUniverseBounds();</td></tr><tr><td class="line-number" value="1242"></td><td class="line-content">            }</td></tr><tr><td class="line-number" value="1243"></td><td class="line-content">          });</td></tr><tr><td class="line-number" value="1244"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1245"></td><td class="line-content">      /* ====== Cableado botón de la barra ====== */</td></tr><tr><td class="line-number" value="1246"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="1247"></td><td class="line-content">      document.getElementById('btn-plan-mayoria')?.addEventListener('click',() =&gt;{</td></tr><tr><td class="line-number" value="1248"></td><td class="line-content">         AT27_PM_open();</td></tr><tr><td class="line-number" value="1249"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="1250"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1251"></td><td class="line-content">          /* ====== Cableado botón de la barra ====== */</td></tr><tr><td class="line-number" value="1252"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="1253"></td><td class="line-content">      document.getElementById('btn-eficiencia-voto')?.addEventListener('click',() =&gt;{</td></tr><tr><td class="line-number" value="1254"></td><td class="line-content">        AT27_EV_open();</td></tr><tr><td class="line-number" value="1255"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="1256"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1257"></td><td class="line-content">          /* ====== Cableado botón de la barra ====== */</td></tr><tr><td class="line-number" value="1258"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="1259"></td><td class="line-content">      document.getElementById('btn-corredores-volteo')?.addEventListener('click',() =&gt;{</td></tr><tr><td class="line-number" value="1260"></td><td class="line-content">         AT27_CV_open();</td></tr><tr><td class="line-number" value="1261"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="1262"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1263"></td><td class="line-content">      document.getElementById('btn-alertas-riesgo')?.addEventListener('click',() =&gt;{</td></tr><tr><td class="line-number" value="1264"></td><td class="line-content">        AT27_AR_open();</td></tr><tr><td class="line-number" value="1265"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="1266"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1267"></td><td class="line-content">          /* ====== Cableado botón ====== */</td></tr><tr><td class="line-number" value="1268"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1269"></td><td class="line-content">      document.getElementById('btn-simulador-impulso')?.addEventListener('click',() =&gt;{</td></tr><tr><td class="line-number" value="1270"></td><td class="line-content">         AT27_SI_open();</td></tr><tr><td class="line-number" value="1271"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="1272"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1273"></td><td class="line-content">          /* ====== Cableado botón ====== */</td></tr><tr><td class="line-number" value="1274"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="1275"></td><td class="line-content">      document.getElementById('btn-brecha')?.addEventListener('click',() =&gt;{</td></tr><tr><td class="line-number" value="1276"></td><td class="line-content">         AT27_BR_open();</td></tr><tr><td class="line-number" value="1277"></td><td class="line-content">    });</td></tr><tr><td class="line-number" value="1278"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1279"></td><td class="line-content">        /* ====== Cableado botón ====== */</td></tr><tr><td class="line-number" value="1280"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1281"></td><td class="line-content">      document.getElementById('btn-sensibilidad-participacion')?.addEventListener('click',() =&gt;{</td></tr><tr><td class="line-number" value="1282"></td><td class="line-content">         AT27_SP_open();</td></tr><tr><td class="line-number" value="1283"></td><td class="line-content">    });</td></tr><tr><td class="line-number" value="1284"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1285"></td><td class="line-content">    bar.__wired = true;</td></tr><tr><td class="line-number" value="1286"></td><td class="line-content">  })();</td></tr><tr><td class="line-number" value="1287"></td><td class="line-content"><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="1288"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1289"></td><td class="line-content"><span class="html-tag">&lt;script&gt;</span></td></tr><tr><td class="line-number" value="1290"></td><td class="line-content">  /* ====== ESTABILIDAD POLÍTICA 2018–2024 con upgrades (AT27_EP_) ====== */</td></tr><tr><td class="line-number" value="1291"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1292"></td><td class="line-content">const AT27_EP_COLORS = { HIGH:'#22c55e', MED:'#facc15', LOW:'#ef4444' }; // verde, amarillo, rojo</td></tr><tr><td class="line-number" value="1293"></td><td class="line-content">const AT27_EP_PUESTOS = { A:'Ayuntamiento', DL:'Diputado Local', DF:'Diputado Federal', G:'Gobernador', S:'Senador', P:'Presidente' };</td></tr><tr><td class="line-number" value="1294"></td><td class="line-content">const AT27_EP_sec = s =&gt; String(s??'').replace(/\D+/g,'');</td></tr><tr><td class="line-number" value="1295"></td><td class="line-content">const AT27_EP_yearsFor = p =&gt; (['G','S','P'].includes(p) ? ['2018','2024'] : ['2018','2021','2024']);</td></tr><tr><td class="line-number" value="1296"></td><td class="line-content">let   AT27_EP_FILL_OPACITY = 0.45; // slider</td></tr><tr><td class="line-number" value="1297"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1298"></td><td class="line-content">// Universo actual → ids</td></tr><tr><td class="line-number" value="1299"></td><td class="line-content">function AT27_EP_getUniverseSecIds(){</td></tr><tr><td class="line-number" value="1300"></td><td class="line-content">  const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];</td></tr><tr><td class="line-number" value="1301"></td><td class="line-content">  const ids=[]; for (const f of feats){ const p=f.properties||{}; const id=AT27_EP_sec(p.ID??p.Seccion??p.SECCION??p.seccion??p.id); if(id) ids.push(id); }</td></tr><tr><td class="line-number" value="1302"></td><td class="line-content">  return [...new Set(ids)];</td></tr><tr><td class="line-number" value="1303"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="1304"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1305"></td><td class="line-content">// ganador por fila (excluye LN/VOTOS)</td></tr><tr><td class="line-number" value="1306"></td><td class="line-content">function AT27_EP_winner(row){</td></tr><tr><td class="line-number" value="1307"></td><td class="line-content">  if (!row) return null;</td></tr><tr><td class="line-number" value="1308"></td><td class="line-content">  let best=null, max=-1;</td></tr><tr><td class="line-number" value="1309"></td><td class="line-content">  for (const [k,v] of Object.entries(row)){</td></tr><tr><td class="line-number" value="1310"></td><td class="line-content">    if (k==='LN'||k==='VOTOS') continue;</td></tr><tr><td class="line-number" value="1311"></td><td class="line-content">    const vv=Number(v||0); if (vv&gt;max){max=vv; best=k.toUpperCase();}</td></tr><tr><td class="line-number" value="1312"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="1313"></td><td class="line-content">  return best;</td></tr><tr><td class="line-number" value="1314"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="1315"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1316"></td><td class="line-content">// cálculo por sección (generalizado a 2 o 3 elecciones)</td></tr><tr><td class="line-number" value="1317"></td><td class="line-content">function AT27_EP_compute(js, secIds, years){</td></tr><tr><td class="line-number" value="1318"></td><td class="line-content">  const perSec = {}; // sec -&gt; {cat, winners:{year:party}}</td></tr><tr><td class="line-number" value="1319"></td><td class="line-content">  const counts = { HIGH:0, MED:0, LOW:0 };</td></tr><tr><td class="line-number" value="1320"></td><td class="line-content">  let analyzed = 0;</td></tr><tr><td class="line-number" value="1321"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1322"></td><td class="line-content">  for (const sec of secIds){</td></tr><tr><td class="line-number" value="1323"></td><td class="line-content">    const slot = js?.secciones?.[sec]; if (!slot) continue;</td></tr><tr><td class="line-number" value="1324"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1325"></td><td class="line-content">    const winners = {};</td></tr><tr><td class="line-number" value="1326"></td><td class="line-content">    for (const y of years){ winners[y] = AT27_EP_winner(slot[y]); }</td></tr><tr><td class="line-number" value="1327"></td><td class="line-content">    const vals = years.map(y=&gt;winners[y]).filter(Boolean);</td></tr><tr><td class="line-number" value="1328"></td><td class="line-content">    if (vals.length &lt; Math.min(2, years.length)) continue; // requiere &gt;=2 datos</td></tr><tr><td class="line-number" value="1329"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1330"></td><td class="line-content">    const uniq = new Set(vals).size;</td></tr><tr><td class="line-number" value="1331"></td><td class="line-content">    let cat;</td></tr><tr><td class="line-number" value="1332"></td><td class="line-content">    if (years.length === 3){</td></tr><tr><td class="line-number" value="1333"></td><td class="line-content">      // 2018–2021–2024: Alta=1 partido, Media=2 partidos, Baja=3 partidos</td></tr><tr><td class="line-number" value="1334"></td><td class="line-content">      cat = (uniq===1) ? 'HIGH' : (uniq===2 ? 'MED' : 'LOW');</td></tr><tr><td class="line-number" value="1335"></td><td class="line-content">    }else{</td></tr><tr><td class="line-number" value="1336"></td><td class="line-content">      // sexenales (2018,2024): Alta=igual, Media=diferente (no hay "LOW")</td></tr><tr><td class="line-number" value="1337"></td><td class="line-content">      cat = (uniq===1) ? 'HIGH' : 'MED';</td></tr><tr><td class="line-number" value="1338"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1339"></td><td class="line-content">    perSec[sec] = { cat, winners };</td></tr><tr><td class="line-number" value="1340"></td><td class="line-content">    counts[cat]++; analyzed++;</td></tr><tr><td class="line-number" value="1341"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="1342"></td><td class="line-content">  return { perSec, counts, analyzed };</td></tr><tr><td class="line-number" value="1343"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="1344"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1345"></td><td class="line-content">// limpiar / construir overlay</td></tr><tr><td class="line-number" value="1346"></td><td class="line-content">function AT27_EP_clearOverlay(){</td></tr><tr><td class="line-number" value="1347"></td><td class="line-content">  const map = window.AT_CTX?.map || window.map; if (!map) return;</td></tr><tr><td class="line-number" value="1348"></td><td class="line-content">  if (window.AT27_EP_LAYER){ try{ map.removeLayer(AT27_EP_LAYER); }catch(_){ } window.AT27_EP_LAYER=null; }</td></tr><tr><td class="line-number" value="1349"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="1350"></td><td class="line-content">function AT27_EP_buildOverlay(perSec, years){</td></tr><tr><td class="line-number" value="1351"></td><td class="line-content">  const map  = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="1352"></td><td class="line-content">  const base = window.AT_CTX?.layer?.toGeoJSON?.() || window.AT_DATA;</td></tr><tr><td class="line-number" value="1353"></td><td class="line-content">  if (!map || !base?.features) return;</td></tr><tr><td class="line-number" value="1354"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1355"></td><td class="line-content">  if (map.createPane &amp;&amp; !map.getPane('at27_ep_pane')){</td></tr><tr><td class="line-number" value="1356"></td><td class="line-content">    map.createPane('at27_ep_pane');</td></tr><tr><td class="line-number" value="1357"></td><td class="line-content">    map.getPane('at27_ep_pane').style.zIndex = 665;</td></tr><tr><td class="line-number" value="1358"></td><td class="line-content">    map.getPane('at27_ep_pane').style.pointerEvents = 'auto'; // permitir hover</td></tr><tr><td class="line-number" value="1359"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="1360"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1361"></td><td class="line-content">  const features = base.features.filter(f=&gt;{</td></tr><tr><td class="line-number" value="1362"></td><td class="line-content">    const id = AT27_EP_sec(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);</td></tr><tr><td class="line-number" value="1363"></td><td class="line-content">    return perSec[id]!=null;</td></tr><tr><td class="line-number" value="1364"></td><td class="line-content">  });</td></tr><tr><td class="line-number" value="1365"></td><td class="line-content">  const geo = { type:'FeatureCollection', features };</td></tr><tr><td class="line-number" value="1366"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1367"></td><td class="line-content">  const layer = L.geoJSON(geo, {</td></tr><tr><td class="line-number" value="1368"></td><td class="line-content">    pane: 'at27_ep_pane',</td></tr><tr><td class="line-number" value="1369"></td><td class="line-content">    style: f=&gt;{</td></tr><tr><td class="line-number" value="1370"></td><td class="line-content">      const id  = AT27_EP_sec(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);</td></tr><tr><td class="line-number" value="1371"></td><td class="line-content">      const cat = perSec[id]?.cat; const col = AT27_EP_COLORS[cat] || '#94a3b8';</td></tr><tr><td class="line-number" value="1372"></td><td class="line-content">      return { color: col, weight: 1, opacity: .9, fillColor: col, fillOpacity: AT27_EP_FILL_OPACITY };</td></tr><tr><td class="line-number" value="1373"></td><td class="line-content">    },</td></tr><tr><td class="line-number" value="1374"></td><td class="line-content">    onEachFeature: (feature, lyr)=&gt;{</td></tr><tr><td class="line-number" value="1375"></td><td class="line-content">      const id = AT27_EP_sec(feature.properties?.ID ?? feature.properties?.SECCION ?? feature.properties?.id);</td></tr><tr><td class="line-number" value="1376"></td><td class="line-content">      const info = perSec[id]; if (!info) return;</td></tr><tr><td class="line-number" value="1377"></td><td class="line-content">      const seq = years.map(y =&gt; `${y}: &lt;b&gt;${info.winners[y]||'—'}&lt;/b&gt;`).join(' &amp;nbsp;→&amp;nbsp; ');</td></tr><tr><td class="line-number" value="1378"></td><td class="line-content">      lyr.bindTooltip(`&lt;div style="font-size:12px;"&gt;${seq}&lt;/div&gt;`, {sticky:true, opacity:0.95, direction:'top', className:'at27-tt'});</td></tr><tr><td class="line-number" value="1379"></td><td class="line-content">      lyr.on('mouseover', ()=&gt; lyr.setStyle({weight:2}));</td></tr><tr><td class="line-number" value="1380"></td><td class="line-content">      lyr.on('mouseout',  ()=&gt; lyr.setStyle({weight:1}));</td></tr><tr><td class="line-number" value="1381"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1382"></td><td class="line-content">  });</td></tr><tr><td class="line-number" value="1383"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1384"></td><td class="line-content">  AT27_EP_clearOverlay();</td></tr><tr><td class="line-number" value="1385"></td><td class="line-content">  layer.addTo(map);</td></tr><tr><td class="line-number" value="1386"></td><td class="line-content">  window.AT27_EP_LAYER = layer;</td></tr><tr><td class="line-number" value="1387"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="1388"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1389"></td><td class="line-content">// actualizar opacidad en caliente</td></tr><tr><td class="line-number" value="1390"></td><td class="line-content">function AT27_EP_updateOpacity(){</td></tr><tr><td class="line-number" value="1391"></td><td class="line-content">  if (!window.AT27_EP_LAYER) return;</td></tr><tr><td class="line-number" value="1392"></td><td class="line-content">  window.AT27_EP_LAYER.setStyle({ fillOpacity: AT27_EP_FILL_OPACITY });</td></tr><tr><td class="line-number" value="1393"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="1394"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1395"></td><td class="line-content">// Panel flotante (con puesto, opacidad y export)</td></tr><tr><td class="line-number" value="1396"></td><td class="line-content">function AT27_EP_getOrCreatePanel(){</td></tr><tr><td class="line-number" value="1397"></td><td class="line-content">  let panel = document.getElementById('AT27_EP_panel');</td></tr><tr><td class="line-number" value="1398"></td><td class="line-content">  if (panel) return panel;</td></tr><tr><td class="line-number" value="1399"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1400"></td><td class="line-content">  panel = document.createElement('div');</td></tr><tr><td class="line-number" value="1401"></td><td class="line-content">  panel.id = 'AT27_EP_panel';</td></tr><tr><td class="line-number" value="1402"></td><td class="line-content">  Object.assign(panel.style,{</td></tr><tr><td class="line-number" value="1403"></td><td class="line-content">    position:'fixed', right:'32px', top:'32px', zIndex:9999,</td></tr><tr><td class="line-number" value="1404"></td><td class="line-content">    width:'380px', background:'#fff', border:'1px solid #e5e7eb',</td></tr><tr><td class="line-number" value="1405"></td><td class="line-content">    borderRadius:'14px', boxShadow:'0 18px 40px rgba(0,0,0,.18)', overflow:'hidden',</td></tr><tr><td class="line-number" value="1406"></td><td class="line-content">    fontFamily:'system-ui, Segoe UI, Roboto, Arial'</td></tr><tr><td class="line-number" value="1407"></td><td class="line-content">  });</td></tr><tr><td class="line-number" value="1408"></td><td class="line-content">  panel.innerHTML = `</td></tr><tr><td class="line-number" value="1409"></td><td class="line-content">    &lt;div id="AT27_EP_hdr" style="cursor:move; user-select:none; background:#e0e7ff; color:#111; padding:10px 12px; display:flex; gap:10px; align-items:center;"&gt;</td></tr><tr><td class="line-number" value="1410"></td><td class="line-content">      &lt;div style="font-weight:800;"&gt;Estabilidad Política 2018–2024&lt;/div&gt;</td></tr><tr><td class="line-number" value="1411"></td><td class="line-content">      &lt;select id="AT27_EP_selPuesto" style="margin-left:auto;background:#fff;color:#111827;border-radius:8px;padding:4px 8px;border:none;outline:none;"&gt;</td></tr><tr><td class="line-number" value="1412"></td><td class="line-content">        ${Object.entries(AT27_EP_PUESTOS).map(([k,v])=&gt;`&lt;option value="${k}"&gt;${v}&lt;/option&gt;`).join('')}</td></tr><tr><td class="line-number" value="1413"></td><td class="line-content">      &lt;/select&gt;</td></tr><tr><td class="line-number" value="1414"></td><td class="line-content">      &lt;button id="AT27_EP_close" title="Cerrar" style="background:transparent;color:#111;border:none;font-size:18px;cursor:pointer;"&gt;×&lt;/button&gt;</td></tr><tr><td class="line-number" value="1415"></td><td class="line-content">    &lt;/div&gt;</td></tr><tr><td class="line-number" value="1416"></td><td class="line-content">    &lt;div id="AT27_EP_body" style="padding:12px 14px;"&gt;</td></tr><tr><td class="line-number" value="1417"></td><td class="line-content">      &lt;div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;"&gt;</td></tr><tr><td class="line-number" value="1418"></td><td class="line-content">        &lt;div style="font-size:12px;color:#334155;"&gt;Opacidad&lt;/div&gt;</td></tr><tr><td class="line-number" value="1419"></td><td class="line-content">        &lt;input id="AT27_EP_opacity" type="range" min="0.1" max="0.9" step="0.05" value="${AT27_EP_FILL_OPACITY}" style="flex:1;"&gt;</td></tr><tr><td class="line-number" value="1420"></td><td class="line-content">        &lt;button id="AT27_EP_export" class="ttb-btn" style="margin-left:6px;"&gt;Exportar PNG&lt;/button&gt;</td></tr><tr><td class="line-number" value="1421"></td><td class="line-content">      &lt;/div&gt;</td></tr><tr><td class="line-number" value="1422"></td><td class="line-content">      &lt;div style="font-weight:700;margin-bottom:6px;"&gt;Leyenda&lt;/div&gt;</td></tr><tr><td class="line-number" value="1423"></td><td class="line-content">      &lt;div id="AT27_EP_legend" style="display:grid; grid-template-columns: 1fr; gap:6px; font-size:13px;"&gt;&lt;/div&gt;</td></tr><tr><td class="line-number" value="1424"></td><td class="line-content">      &lt;div id="AT27_EP_totalBox" style="margin-top:10px; font-weight:800;"&gt;&lt;/div&gt;</td></tr><tr><td class="line-number" value="1425"></td><td class="line-content">    &lt;/div&gt;</td></tr><tr><td class="line-number" value="1426"></td><td class="line-content">  `;</td></tr><tr><td class="line-number" value="1427"></td><td class="line-content">  document.body.appendChild(panel);</td></tr><tr><td class="line-number" value="1428"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1429"></td><td class="line-content">  panel.querySelector('#AT27_EP_close').onclick = ()=&gt;{ AT27_EP_clearOverlay(); panel.remove(); };</td></tr><tr><td class="line-number" value="1430"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1431"></td><td class="line-content">  // drag</td></tr><tr><td class="line-number" value="1432"></td><td class="line-content">  (function drag(panel, handle){</td></tr><tr><td class="line-number" value="1433"></td><td class="line-content">    let sx=0, sy=0, ox=0, oy=0, dragging=false;</td></tr><tr><td class="line-number" value="1434"></td><td class="line-content">    handle.addEventListener('mousedown', e=&gt;{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panel.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });</td></tr><tr><td class="line-number" value="1435"></td><td class="line-content">    window.addEventListener('mousemove', e=&gt;{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panel.style.left=(ox+dx)+'px'; panel.style.top=(oy+dy)+'px'; panel.style.right='auto'; });</td></tr><tr><td class="line-number" value="1436"></td><td class="line-content">    window.addEventListener('mouseup', ()=&gt;{ dragging=false; document.body.style.userSelect=''; });</td></tr><tr><td class="line-number" value="1437"></td><td class="line-content">  })(panel, panel.querySelector('#AT27_EP_hdr'));</td></tr><tr><td class="line-number" value="1438"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1439"></td><td class="line-content">  // listeners del panel</td></tr><tr><td class="line-number" value="1440"></td><td class="line-content">  panel.querySelector('#AT27_EP_opacity').addEventListener('input', (e)=&gt;{ AT27_EP_FILL_OPACITY = Number(e.target.value); AT27_EP_updateOpacity(); });</td></tr><tr><td class="line-number" value="1441"></td><td class="line-content">  panel.querySelector('#AT27_EP_export').addEventListener('click', AT27_EP_exportPNG);</td></tr><tr><td class="line-number" value="1442"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1443"></td><td class="line-content">  return panel;</td></tr><tr><td class="line-number" value="1444"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="1445"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1446"></td><td class="line-content">// Rellena leyenda dinámicamente (en sexenales no hay "LOW")</td></tr><tr><td class="line-number" value="1447"></td><td class="line-content">function AT27_EP_renderLegend(counts, analyzed, years){</td></tr><tr><td class="line-number" value="1448"></td><td class="line-content">  const LBL = {</td></tr><tr><td class="line-number" value="1449"></td><td class="line-content">    HIGH: years.length===3 ? 'Alta (mismo partido 3 elecciones)' : 'Alta (mismo partido en todas)',</td></tr><tr><td class="line-number" value="1450"></td><td class="line-content">    MED : years.length===3 ? 'Estabilidad Media (1 cambio)'      : 'Media (cambio)',</td></tr><tr><td class="line-number" value="1451"></td><td class="line-content">    LOW : 'Inestabilidad Alta (3 partidos)'</td></tr><tr><td class="line-number" value="1452"></td><td class="line-content">  };</td></tr><tr><td class="line-number" value="1453"></td><td class="line-content">  const rows = ['HIGH','MED','LOW'].map(k=&gt;{</td></tr><tr><td class="line-number" value="1454"></td><td class="line-content">    const hide = (k==='LOW' &amp;&amp; years.length===2); // no aplica en 2 elecciones</td></tr><tr><td class="line-number" value="1455"></td><td class="line-content">    const pct  = analyzed&gt;0 ? ` (${(counts[k]*100/analyzed).toFixed(1)}%)` : '';</td></tr><tr><td class="line-number" value="1456"></td><td class="line-content">    return hide ? '' : `</td></tr><tr><td class="line-number" value="1457"></td><td class="line-content">      &lt;div style="display:flex;align-items:center;gap:8px;"&gt;</td></tr><tr><td class="line-number" value="1458"></td><td class="line-content">        &lt;span style="width:12px;height:12px;border-radius:3px;background:${AT27_EP_COLORS[k]};border:1px solid rgba(0,0,0,.15)"&gt;&lt;/span&gt;</td></tr><tr><td class="line-number" value="1459"></td><td class="line-content">        ${LBL[k]}: &lt;b style="margin-left:4px;"&gt;${counts[k]}&lt;/b&gt;</td></tr><tr><td class="line-number" value="1460"></td><td class="line-content">        &lt;span style="color:#64748b;margin-left:4px;"&gt;${pct}&lt;/span&gt;</td></tr><tr><td class="line-number" value="1461"></td><td class="line-content">      &lt;/div&gt;`;</td></tr><tr><td class="line-number" value="1462"></td><td class="line-content">  }).join('');</td></tr><tr><td class="line-number" value="1463"></td><td class="line-content">  return rows || '&lt;i style="color:#64748b;"&gt;Sin datos suficientes.&lt;/i&gt;';</td></tr><tr><td class="line-number" value="1464"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="1465"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1466"></td><td class="line-content">function AT27_EP_render({puesto, counts, analyzed, years}){</td></tr><tr><td class="line-number" value="1467"></td><td class="line-content">  const panel = AT27_EP_getOrCreatePanel();</td></tr><tr><td class="line-number" value="1468"></td><td class="line-content">  panel.querySelector('#AT27_EP_selPuesto').value = puesto;</td></tr><tr><td class="line-number" value="1469"></td><td class="line-content">  panel.querySelector('#AT27_EP_legend').innerHTML = AT27_EP_renderLegend(counts, analyzed, years);</td></tr><tr><td class="line-number" value="1470"></td><td class="line-content">  panel.querySelector('#AT27_EP_totalBox').innerHTML = `Total secciones analizadas: &lt;span&gt;${analyzed}&lt;/span&gt;`;</td></tr><tr><td class="line-number" value="1471"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="1472"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1473"></td><td class="line-content">// Exportar PNG (mapa + lo que se vea encima)</td></tr><tr><td class="line-number" value="1474"></td><td class="line-content">async function AT27_EP_exportPNG(){</td></tr><tr><td class="line-number" value="1475"></td><td class="line-content">  const mapEl = (window.AT_CTX?.map?._container) || document.querySelector('.leaflet-container,#map,#mapid');</td></tr><tr><td class="line-number" value="1476"></td><td class="line-content">  if (!mapEl){ alert('No encontré el contenedor del mapa.'); return; }</td></tr><tr><td class="line-number" value="1477"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1478"></td><td class="line-content">  // Carga html2canvas si no está</td></tr><tr><td class="line-number" value="1479"></td><td class="line-content">  async function ensureHtml2Canvas(){</td></tr><tr><td class="line-number" value="1480"></td><td class="line-content">    if (window.html2canvas) return;</td></tr><tr><td class="line-number" value="1481"></td><td class="line-content">    await new Promise((resolve, reject)=&gt;{</td></tr><tr><td class="line-number" value="1482"></td><td class="line-content">      const s=document.createElement('script');</td></tr><tr><td class="line-number" value="1483"></td><td class="line-content">      s.src='https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';</td></tr><tr><td class="line-number" value="1484"></td><td class="line-content">      s.onload=resolve; s.onerror=()=&gt;reject(new Error('No pude cargar html2canvas'));</td></tr><tr><td class="line-number" value="1485"></td><td class="line-content">      document.head.appendChild(s);</td></tr><tr><td class="line-number" value="1486"></td><td class="line-content">    });</td></tr><tr><td class="line-number" value="1487"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="1488"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1489"></td><td class="line-content">  try{</td></tr><tr><td class="line-number" value="1490"></td><td class="line-content">    await ensureHtml2Canvas();</td></tr><tr><td class="line-number" value="1491"></td><td class="line-content">    const canvas = await window.html2canvas(mapEl, {useCORS:true, backgroundColor:null, logging:false});</td></tr><tr><td class="line-number" value="1492"></td><td class="line-content">    const link = document.createElement('a');</td></tr><tr><td class="line-number" value="1493"></td><td class="line-content">    link.download = `estabilidad_${Date.now()}.png`;</td></tr><tr><td class="line-number" value="1494"></td><td class="line-content">    link.href = canvas.toDataURL('image/png');</td></tr><tr><td class="line-number" value="1495"></td><td class="line-content">    link.click();</td></tr><tr><td class="line-number" value="1496"></td><td class="line-content">  }catch(e){</td></tr><tr><td class="line-number" value="1497"></td><td class="line-content">    console.error(e);</td></tr><tr><td class="line-number" value="1498"></td><td class="line-content">    alert('No pude exportar PNG (CORS o bloqueo de librería).');</td></tr><tr><td class="line-number" value="1499"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="1500"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="1501"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1502"></td><td class="line-content">// API pública</td></tr><tr><td class="line-number" value="1503"></td><td class="line-content">async function AT27_EP_ejecutar(puestoInicial='A'){</td></tr><tr><td class="line-number" value="1504"></td><td class="line-content">  try{</td></tr><tr><td class="line-number" value="1505"></td><td class="line-content">    const panel = AT27_EP_getOrCreatePanel();</td></tr><tr><td class="line-number" value="1506"></td><td class="line-content">    const sel   = panel.querySelector('#AT27_EP_selPuesto');</td></tr><tr><td class="line-number" value="1507"></td><td class="line-content">    sel.value = puestoInicial;</td></tr><tr><td class="line-number" value="1508"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1509"></td><td class="line-content">    sel.onchange = async ()=&gt;{</td></tr><tr><td class="line-number" value="1510"></td><td class="line-content">      const p = sel.value;</td></tr><tr><td class="line-number" value="1511"></td><td class="line-content">      const years = AT27_EP_yearsFor(p);</td></tr><tr><td class="line-number" value="1512"></td><td class="line-content">      const ids   = AT27_EP_getUniverseSecIds();</td></tr><tr><td class="line-number" value="1513"></td><td class="line-content">      if (!ids.length) return alert('No hay secciones en el universo actual.');</td></tr><tr><td class="line-number" value="1514"></td><td class="line-content">      const js    = await (window.loadPuesto ? loadPuesto(p) : getElectData(p));</td></tr><tr><td class="line-number" value="1515"></td><td class="line-content">      const { perSec, counts, analyzed } = AT27_EP_compute(js, ids, years);</td></tr><tr><td class="line-number" value="1516"></td><td class="line-content">      AT27_EP_buildOverlay(perSec, years);</td></tr><tr><td class="line-number" value="1517"></td><td class="line-content">      AT27_EP_render({puesto:p, counts, analyzed, years});</td></tr><tr><td class="line-number" value="1518"></td><td class="line-content">    };</td></tr><tr><td class="line-number" value="1519"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1520"></td><td class="line-content">    // primer render</td></tr><tr><td class="line-number" value="1521"></td><td class="line-content">    const p     = sel.value;</td></tr><tr><td class="line-number" value="1522"></td><td class="line-content">    const years = AT27_EP_yearsFor(p);</td></tr><tr><td class="line-number" value="1523"></td><td class="line-content">    const ids   = AT27_EP_getUniverseSecIds();</td></tr><tr><td class="line-number" value="1524"></td><td class="line-content">    if (!ids.length) return alert('No hay secciones en el universo actual.');</td></tr><tr><td class="line-number" value="1525"></td><td class="line-content">    const js    = await (window.loadPuesto ? loadPuesto(p) : getElectData(p));</td></tr><tr><td class="line-number" value="1526"></td><td class="line-content">    const { perSec, counts, analyzed } = AT27_EP_compute(js, ids, years);</td></tr><tr><td class="line-number" value="1527"></td><td class="line-content">    AT27_EP_buildOverlay(perSec, years);</td></tr><tr><td class="line-number" value="1528"></td><td class="line-content">    AT27_EP_render({puesto:p, counts, analyzed, years});</td></tr><tr><td class="line-number" value="1529"></td><td class="line-content">  }catch(e){</td></tr><tr><td class="line-number" value="1530"></td><td class="line-content">    console.error('AT27_EP_ejecutar error:', e);</td></tr><tr><td class="line-number" value="1531"></td><td class="line-content">    alert('No pude calcular la estabilidad política.');</td></tr><tr><td class="line-number" value="1532"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="1533"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="1534"></td><td class="line-content">/* ====================== FIN upgrades ESTABILIDAD POLÍTICA ====================== */</td></tr><tr><td class="line-number" value="1535"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1536"></td><td class="line-content"><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="1537"></td><td class="line-content"><span class="html-tag">&lt;script&gt;</span></td></tr><tr><td class="line-number" value="1538"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1539"></td><td class="line-content">    /* ========== GANAR TODO · METAS DE PARTICIPACIÓN 2027* (AT27_GT_META_) ========== */</td></tr><tr><td class="line-number" value="1540"></td><td class="line-content">    /* Universos desde AT_CTX.layer; datos con loadPuesto(puesto)</td></tr><tr><td class="line-number" value="1541"></td><td class="line-content">      Colorea por sección según p2027* vs meta:</td></tr><tr><td class="line-number" value="1542"></td><td class="line-content">      - PASS (verde): p2027 ≥ meta</td></tr><tr><td class="line-number" value="1543"></td><td class="line-content">      - NEAR (amarillo): 0 &lt; meta - p2027 ≤ tolerancia</td></tr><tr><td class="line-number" value="1544"></td><td class="line-content">      - FAIL (rojo): p2027 &lt; meta - tolerancia</td></tr><tr><td class="line-number" value="1545"></td><td class="line-content">      Panel con puesto, meta, tolerancia, opacidad, resumen y Top-20 brechas, export PNG. */</td></tr><tr><td class="line-number" value="1546"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1547"></td><td class="line-content">    const AT27_GT_META_PUESTOS = { A:'Ayuntamiento', DL:'Diputado Local', DF:'Diputado Federal', G:'Gobernador', S:'Senador', P:'Presidente' };</td></tr><tr><td class="line-number" value="1548"></td><td class="line-content">    const AT27_GT_META_COLS   = { PASS:'#22c55e', NEAR:'#f59e0b', FAIL:'#ef4444' };</td></tr><tr><td class="line-number" value="1549"></td><td class="line-content">    const AT27_GT_META_sec    = s =&gt; String(s??'').replace(/\D+/g,'');</td></tr><tr><td class="line-number" value="1550"></td><td class="line-content">    const AT27_GT_META_yearsFor = p =&gt; (['G','S','P'].includes(p) ? ['2018','2024'] : ['2018','2021','2024']);</td></tr><tr><td class="line-number" value="1551"></td><td class="line-content">    let   AT27_GT_META_FILL   = 0.45;  // opacidad overlay</td></tr><tr><td class="line-number" value="1552"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1553"></td><td class="line-content">    // -------- Helpers universo / datos --------</td></tr><tr><td class="line-number" value="1554"></td><td class="line-content">    function AT27_GT_META_getUniverseSecIds(){</td></tr><tr><td class="line-number" value="1555"></td><td class="line-content">      const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];</td></tr><tr><td class="line-number" value="1556"></td><td class="line-content">      const ids=[]; for (const f of feats){ const p=f.properties||{}; const id=AT27_GT_META_sec(p.ID??p.Seccion??p.SECCION??p.seccion??p.id); if(id) ids.push(id); }</td></tr><tr><td class="line-number" value="1557"></td><td class="line-content">      return [...new Set(ids)];</td></tr><tr><td class="line-number" value="1558"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1559"></td><td class="line-content">    function AT27_GT_META_partPct(row){</td></tr><tr><td class="line-number" value="1560"></td><td class="line-content">      if (!row) return null;</td></tr><tr><td class="line-number" value="1561"></td><td class="line-content">      const ln = Number(row.LN||0); if (!ln) return null;</td></tr><tr><td class="line-number" value="1562"></td><td class="line-content">      let votos = (row.VOTOS!=null) ? Number(row.VOTOS||0) : 0;</td></tr><tr><td class="line-number" value="1563"></td><td class="line-content">      if (row.VOTOS==null){ for (const [k,v] of Object.entries(row)){ if (k!=='LN' &amp;&amp; k!=='VOTOS') votos += Number(v||0); } }</td></tr><tr><td class="line-number" value="1564"></td><td class="line-content">      return Math.max(0, Math.min(100, (votos/ln)*100));</td></tr><tr><td class="line-number" value="1565"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1566"></td><td class="line-content">    function AT27_GT_META_project2027(slot, puesto){</td></tr><tr><td class="line-number" value="1567"></td><td class="line-content">      const p18 = AT27_GT_META_partPct(slot['2018']);</td></tr><tr><td class="line-number" value="1568"></td><td class="line-content">      const p21 = AT27_GT_META_partPct(slot['2021']);</td></tr><tr><td class="line-number" value="1569"></td><td class="line-content">      const p24 = AT27_GT_META_partPct(slot['2024']);</td></tr><tr><td class="line-number" value="1570"></td><td class="line-content">      const vals = [p18,p21,p24].filter(v=&gt;typeof v==='number'&amp;&amp;isFinite(v));</td></tr><tr><td class="line-number" value="1571"></td><td class="line-content">      if (vals.length===0) return null;</td></tr><tr><td class="line-number" value="1572"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1573"></td><td class="line-content">      if (['G','S','P'].includes(puesto)){</td></tr><tr><td class="line-number" value="1574"></td><td class="line-content">        const a = (typeof p18==='number')?p18:p24, b=(typeof p24==='number')?p24:p18;</td></tr><tr><td class="line-number" value="1575"></td><td class="line-content">        const slopePerYear = (b-a)/6;  // 2018→2024</td></tr><tr><td class="line-number" value="1576"></td><td class="line-content">        return Math.max(0, Math.min(100, b + 0.6*slopePerYear*3)); // conservador 60%</td></tr><tr><td class="line-number" value="1577"></td><td class="line-content">      }else{</td></tr><tr><td class="line-number" value="1578"></td><td class="line-content">        // 2018=0, 2021=3, 2024=6 → 2027=9; pesos 1,1.5,2</td></tr><tr><td class="line-number" value="1579"></td><td class="line-content">        const pts=[]; if (typeof p18==='number') pts.push({t:0,y:p18,w:1.0}); if (typeof p21==='number') pts.push({t:3,y:p21,w:1.5}); if (typeof p24==='number') pts.push({t:6,y:p24,w:2.0});</td></tr><tr><td class="line-number" value="1580"></td><td class="line-content">        const W=pts.reduce((a,p)=&gt;a+p.w,0), tbar=pts.reduce((a,p)=&gt;a+p.w*p.t,0)/W, ybar=pts.reduce((a,p)=&gt;a+p.w*p.y,0)/W;</td></tr><tr><td class="line-number" value="1581"></td><td class="line-content">        const num=pts.reduce((a,p)=&gt;a+p.w*(p.t-tbar)*(p.y-ybar),0), den=pts.reduce((a,p)=&gt;a+p.w*(p.t-tbar)*(p.t-tbar),0)||1e-9;</td></tr><tr><td class="line-number" value="1582"></td><td class="line-content">        const b1=num/den, b0=ybar-b1*tbar;</td></tr><tr><td class="line-number" value="1583"></td><td class="line-content">        return Math.max(0, Math.min(100, b0 + b1*9));</td></tr><tr><td class="line-number" value="1584"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="1585"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1586"></td><td class="line-content">    function AT27_GT_META_winner(row){</td></tr><tr><td class="line-number" value="1587"></td><td class="line-content">      if (!row) return null;</td></tr><tr><td class="line-number" value="1588"></td><td class="line-content">      let best=null,max=-1; for (const [k,v] of Object.entries(row)){ if (k==='LN'||k==='VOTOS') continue; const vv=Number(v||0); if (vv&gt;max){max=vv; best=k.toUpperCase();} }</td></tr><tr><td class="line-number" value="1589"></td><td class="line-content">      return best;</td></tr><tr><td class="line-number" value="1590"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1591"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1592"></td><td class="line-content">    // -------- Cálculo por sección --------</td></tr><tr><td class="line-number" value="1593"></td><td class="line-content">    function AT27_GT_META_compute(js, secIds, puesto, metaPct, tolPct){</td></tr><tr><td class="line-number" value="1594"></td><td class="line-content">      const perSec = {}; // sec -&gt; {cat, p18,p21,p24,p27, delta}  (delta = p27 - meta)</td></tr><tr><td class="line-number" value="1595"></td><td class="line-content">      const counts = { PASS:0, NEAR:0, FAIL:0 };</td></tr><tr><td class="line-number" value="1596"></td><td class="line-content">      let lnW=0, p27W=0;  // promedio ponderado por LN (usamos LN 2024)</td></tr><tr><td class="line-number" value="1597"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1598"></td><td class="line-content">      for (const sec of secIds){</td></tr><tr><td class="line-number" value="1599"></td><td class="line-content">        const slot = js?.secciones?.[sec]; if (!slot) continue;</td></tr><tr><td class="line-number" value="1600"></td><td class="line-content">        const p27  = AT27_GT_META_project2027(slot, puesto);</td></tr><tr><td class="line-number" value="1601"></td><td class="line-content">        if (p27==null || !isFinite(p27)) continue;</td></tr><tr><td class="line-number" value="1602"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1603"></td><td class="line-content">        const p18 = AT27_GT_META_partPct(slot['2018']);</td></tr><tr><td class="line-number" value="1604"></td><td class="line-content">        const p21 = AT27_GT_META_partPct(slot['2021']);</td></tr><tr><td class="line-number" value="1605"></td><td class="line-content">        const p24 = AT27_GT_META_partPct(slot['2024']);</td></tr><tr><td class="line-number" value="1606"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1607"></td><td class="line-content">        const delta = p27 - metaPct; // + = sobre meta; - = falta</td></tr><tr><td class="line-number" value="1608"></td><td class="line-content">        let cat = 'PASS';</td></tr><tr><td class="line-number" value="1609"></td><td class="line-content">        if (delta &lt; -tolPct) cat = 'FAIL';</td></tr><tr><td class="line-number" value="1610"></td><td class="line-content">        else if (delta &lt; 0)  cat = 'NEAR';</td></tr><tr><td class="line-number" value="1611"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1612"></td><td class="line-content">        perSec[sec] = { cat, p18, p21, p24, p27, delta };</td></tr><tr><td class="line-number" value="1613"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1614"></td><td class="line-content">        counts[cat]++;</td></tr><tr><td class="line-number" value="1615"></td><td class="line-content">        const ln = Number((slot['2024']||{}).LN || 0); if (ln&gt;0){ lnW += ln; p27W += p27*ln; }</td></tr><tr><td class="line-number" value="1616"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="1617"></td><td class="line-content">      const avg = lnW&gt;0 ? (p27W/lnW) : NaN;</td></tr><tr><td class="line-number" value="1618"></td><td class="line-content">      return { perSec, counts, avg };</td></tr><tr><td class="line-number" value="1619"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1620"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1621"></td><td class="line-content">    // -------- Overlay Leaflet --------</td></tr><tr><td class="line-number" value="1622"></td><td class="line-content">    function AT27_GT_META_clearOverlay(){</td></tr><tr><td class="line-number" value="1623"></td><td class="line-content">      const map = window.AT_CTX?.map || window.map; if (!map) return;</td></tr><tr><td class="line-number" value="1624"></td><td class="line-content">      if (window.AT27_GT_META_LAYER){ try{ map.removeLayer(AT27_GT_META_LAYER); }catch(_){ } window.AT27_GT_META_LAYER=null; }</td></tr><tr><td class="line-number" value="1625"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1626"></td><td class="line-content">    function AT27_GT_META_buildOverlay(perSec){</td></tr><tr><td class="line-number" value="1627"></td><td class="line-content">      const map  = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="1628"></td><td class="line-content">      const base = window.AT_CTX?.layer?.toGeoJSON?.() || window.AT_DATA;</td></tr><tr><td class="line-number" value="1629"></td><td class="line-content">      if (!map || !base?.features) return;</td></tr><tr><td class="line-number" value="1630"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1631"></td><td class="line-content">      if (map.createPane &amp;&amp; !map.getPane('at27_gt_meta_pane')){</td></tr><tr><td class="line-number" value="1632"></td><td class="line-content">        map.createPane('at27_gt_meta_pane');</td></tr><tr><td class="line-number" value="1633"></td><td class="line-content">        map.getPane('at27_gt_meta_pane').style.zIndex = 670;</td></tr><tr><td class="line-number" value="1634"></td><td class="line-content">        map.getPane('at27_gt_meta_pane').style.pointerEvents = 'auto'; // hover/click</td></tr><tr><td class="line-number" value="1635"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="1636"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1637"></td><td class="line-content">      const features = base.features.filter(f=&gt;{</td></tr><tr><td class="line-number" value="1638"></td><td class="line-content">        const id = AT27_GT_META_sec(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);</td></tr><tr><td class="line-number" value="1639"></td><td class="line-content">        return perSec[id]!=null;</td></tr><tr><td class="line-number" value="1640"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="1641"></td><td class="line-content">      const geo = { type:'FeatureCollection', features };</td></tr><tr><td class="line-number" value="1642"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1643"></td><td class="line-content">      const layer = L.geoJSON(geo, {</td></tr><tr><td class="line-number" value="1644"></td><td class="line-content">        pane: 'at27_gt_meta_pane',</td></tr><tr><td class="line-number" value="1645"></td><td class="line-content">        style: f=&gt;{</td></tr><tr><td class="line-number" value="1646"></td><td class="line-content">          const id = AT27_GT_META_sec(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);</td></tr><tr><td class="line-number" value="1647"></td><td class="line-content">          const col = AT27_GT_META_COLS[ perSec[id].cat ] || '#94a3b8';</td></tr><tr><td class="line-number" value="1648"></td><td class="line-content">          return { color:col, weight:1, opacity:.9, fillColor:col, fillOpacity:AT27_GT_META_FILL };</td></tr><tr><td class="line-number" value="1649"></td><td class="line-content">        },</td></tr><tr><td class="line-number" value="1650"></td><td class="line-content">        onEachFeature: (feature, lyr)=&gt;{</td></tr><tr><td class="line-number" value="1651"></td><td class="line-content">          const id = AT27_GT_META_sec(feature.properties?.ID ?? feature.properties?.SECCION ?? feature.properties?.id);</td></tr><tr><td class="line-number" value="1652"></td><td class="line-content">          const info = perSec[id]; if (!info) return;</td></tr><tr><td class="line-number" value="1653"></td><td class="line-content">          const p = (x)=&gt; (typeof x==='number' &amp;&amp; isFinite(x)) ? x.toFixed(1)+'%' : '—';</td></tr><tr><td class="line-number" value="1654"></td><td class="line-content">          const deltaTxt = (info.delta&gt;=0?'+':'') + (isFinite(info.delta)?info.delta.toFixed(1):'—') + ' pp';</td></tr><tr><td class="line-number" value="1655"></td><td class="line-content">          const has21 = info.p21!=null &amp;&amp; isFinite(info.p21);</td></tr><tr><td class="line-number" value="1656"></td><td class="line-content">          const seq = has21</td></tr><tr><td class="line-number" value="1657"></td><td class="line-content">            ? `2018 ${p(info.p18)} → 2021 ${p(info.p21)} → 2024 ${p(info.p24)} → &lt;b&gt;2027* ${p(info.p27)}&lt;/b&gt;`</td></tr><tr><td class="line-number" value="1658"></td><td class="line-content">            : `2018 ${p(info.p18)} → 2024 ${p(info.p24)} → &lt;b&gt;2027* ${p(info.p27)}&lt;/b&gt;`;</td></tr><tr><td class="line-number" value="1659"></td><td class="line-content">          lyr.bindTooltip(`&lt;div style="font-size:12px;"&gt;${seq}&lt;br&gt;Δ vs meta: &lt;b&gt;${deltaTxt}&lt;/b&gt;&lt;/div&gt;`, {sticky:true, opacity:0.95, direction:'top', className:'at27-tt'});</td></tr><tr><td class="line-number" value="1660"></td><td class="line-content">          // Click: si tienes manejador de sección, úsalo</td></tr><tr><td class="line-number" value="1661"></td><td class="line-content">          lyr.on('click', ()=&gt;{ if (typeof window.openSeccionPanel==='function'){ window.openSeccionPanel(id); } });</td></tr><tr><td class="line-number" value="1662"></td><td class="line-content">          lyr.on('mouseover', ()=&gt; lyr.setStyle({weight:2}));</td></tr><tr><td class="line-number" value="1663"></td><td class="line-content">          lyr.on('mouseout',  ()=&gt; lyr.setStyle({weight:1}));</td></tr><tr><td class="line-number" value="1664"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1665"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="1666"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1667"></td><td class="line-content">      AT27_GT_META_clearOverlay();</td></tr><tr><td class="line-number" value="1668"></td><td class="line-content">      layer.addTo(map);</td></tr><tr><td class="line-number" value="1669"></td><td class="line-content">      window.AT27_GT_META_LAYER = layer;</td></tr><tr><td class="line-number" value="1670"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1671"></td><td class="line-content">    function AT27_GT_META_updateOpacity(){</td></tr><tr><td class="line-number" value="1672"></td><td class="line-content">      if (window.AT27_GT_META_LAYER) window.AT27_GT_META_LAYER.setStyle({ fillOpacity: AT27_GT_META_FILL });</td></tr><tr><td class="line-number" value="1673"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1674"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1675"></td><td class="line-content">    // -------- Panel UI --------</td></tr><tr><td class="line-number" value="1676"></td><td class="line-content">    function AT27_GT_META_getOrCreatePanel(){</td></tr><tr><td class="line-number" value="1677"></td><td class="line-content">      let panel = document.getElementById('AT27_GT_META_panel');</td></tr><tr><td class="line-number" value="1678"></td><td class="line-content">      if (panel) return panel;</td></tr><tr><td class="line-number" value="1679"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1680"></td><td class="line-content">      panel = document.createElement('div');</td></tr><tr><td class="line-number" value="1681"></td><td class="line-content">      panel.id = 'AT27_GT_META_panel';</td></tr><tr><td class="line-number" value="1682"></td><td class="line-content">      Object.assign(panel.style,{</td></tr><tr><td class="line-number" value="1683"></td><td class="line-content">        position:'fixed', right:'32px', top:'32px', zIndex:9999,</td></tr><tr><td class="line-number" value="1684"></td><td class="line-content">        width:'440px', background:'#fff', border:'1px solid #e5e7eb',</td></tr><tr><td class="line-number" value="1685"></td><td class="line-content">        borderRadius:'14px', boxShadow:'0 18px 40px rgba(0,0,0,.18)',</td></tr><tr><td class="line-number" value="1686"></td><td class="line-content">        overflow:'hidden', fontFamily:'system-ui, Segoe UI, Roboto, Arial',</td></tr><tr><td class="line-number" value="1687"></td><td class="line-content">        resize: 'both',</td></tr><tr><td class="line-number" value="1688"></td><td class="line-content">        minWidth: '360px',</td></tr><tr><td class="line-number" value="1689"></td><td class="line-content">        minHeight: '260px',</td></tr><tr><td class="line-number" value="1690"></td><td class="line-content">        display: 'flex',</td></tr><tr><td class="line-number" value="1691"></td><td class="line-content">        flexDirection: 'column'</td></tr><tr><td class="line-number" value="1692"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="1693"></td><td class="line-content">      panel.innerHTML = `</td></tr><tr><td class="line-number" value="1694"></td><td class="line-content">        &lt;div id="AT27_GT_META_hdr" style="cursor:move; user-select:none; background:#dcfce7; color:#111; padding:10px 12px; display:flex; gap:10px; align-items:center;"&gt;</td></tr><tr><td class="line-number" value="1695"></td><td class="line-content">          &lt;div style="font-weight:800;"&gt;Metas de participación 2027*&lt;/div&gt;</td></tr><tr><td class="line-number" value="1696"></td><td class="line-content">          &lt;select id="AT27_GT_META_selPuesto" style="margin-left:auto;background:#fff;color:#111827;border-radius:8px;padding:4px 8px;border:none;outline:none;"&gt;</td></tr><tr><td class="line-number" value="1697"></td><td class="line-content">            ${Object.entries(AT27_GT_META_PUESTOS).map(([k,v])=&gt;`&lt;option value="${k}"&gt;${v}&lt;/option&gt;`).join('')}</td></tr><tr><td class="line-number" value="1698"></td><td class="line-content">          &lt;/select&gt;</td></tr><tr><td class="line-number" value="1699"></td><td class="line-content">          &lt;button id="AT27_GT_META_close" title="Cerrar" style="background:transparent;color:#111;border:none;font-size:18px;cursor:pointer;"&gt;×&lt;/button&gt;</td></tr><tr><td class="line-number" value="1700"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="1701"></td><td class="line-content">        &lt;div id="AT27_GT_META_body" style="padding:12px 14px;"&gt;</td></tr><tr><td class="line-number" value="1702"></td><td class="line-content">          &lt;div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:10px;"&gt;</td></tr><tr><td class="line-number" value="1703"></td><td class="line-content">            &lt;label style="display:flex;align-items:center;gap:8px;border:1px solid #e5e7eb;border-radius:10px;padding:8px;"&gt;</td></tr><tr><td class="line-number" value="1704"></td><td class="line-content">              &lt;span style="font-size:12px;color:#334155;"&gt;Meta (%)&lt;/span&gt;</td></tr><tr><td class="line-number" value="1705"></td><td class="line-content">              &lt;input id="AT27_GT_META_meta" type="range" min="40" max="70" step="1" value="50" style="flex:1;"&gt;</td></tr><tr><td class="line-number" value="1706"></td><td class="line-content">              &lt;span id="AT27_GT_META_meta_val" style="width:42px;text-align:right;font-variant-numeric:tabular-nums;"&gt;50%&lt;/span&gt;</td></tr><tr><td class="line-number" value="1707"></td><td class="line-content">            &lt;/label&gt;</td></tr><tr><td class="line-number" value="1708"></td><td class="line-content">            &lt;label style="display:flex;align-items:center;gap:8px;border:1px solid #e5e7eb;border-radius:10px;padding:8px;"&gt;</td></tr><tr><td class="line-number" value="1709"></td><td class="line-content">              &lt;span style="font-size:12px;color:#334155;"&gt;Tolerancia (pp)&lt;/span&gt;</td></tr><tr><td class="line-number" value="1710"></td><td class="line-content">              &lt;input id="AT27_GT_META_tol" type="range" min="0" max="5" step="0.5" value="3" style="flex:1;"&gt;</td></tr><tr><td class="line-number" value="1711"></td><td class="line-content">              &lt;span id="AT27_GT_META_tol_val" style="width:42px;text-align:right;font-variant-numeric:tabular-nums;"&gt;3.0&lt;/span&gt;</td></tr><tr><td class="line-number" value="1712"></td><td class="line-content">            &lt;/label&gt;</td></tr><tr><td class="line-number" value="1713"></td><td class="line-content">          &lt;/div&gt;</td></tr><tr><td class="line-number" value="1714"></td><td class="line-content">          &lt;div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;"&gt;</td></tr><tr><td class="line-number" value="1715"></td><td class="line-content">            &lt;div style="font-size:12px;color:#334155;"&gt;Opacidad&lt;/div&gt;</td></tr><tr><td class="line-number" value="1716"></td><td class="line-content">            &lt;input id="AT27_GT_META_opacity" type="range" min="0.1" max="0.9" step="0.05" value="${AT27_GT_META_FILL}" style="flex:1;"&gt;</td></tr><tr><td class="line-number" value="1717"></td><td class="line-content">            &lt;button id="AT27_GT_META_export" class="ttb-btn" style="margin-left:6px;"&gt;Exportar PNG&lt;/button&gt;</td></tr><tr><td class="line-number" value="1718"></td><td class="line-content">          &lt;/div&gt;</td></tr><tr><td class="line-number" value="1719"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1720"></td><td class="line-content">          &lt;div id="AT27_GT_META_summary" style="font-size:13px;color:#334155;margin-bottom:10px;"&gt;&lt;/div&gt;</td></tr><tr><td class="line-number" value="1721"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1722"></td><td class="line-content">          &lt;div style="font-weight:700;margin-bottom:6px;"&gt;Leyenda&lt;/div&gt;</td></tr><tr><td class="line-number" value="1723"></td><td class="line-content">          &lt;div id="AT27_GT_META_legend" style="display:grid; grid-template-columns: 1fr; gap:6px; font-size:13px;"&gt;&lt;/div&gt;</td></tr><tr><td class="line-number" value="1724"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1725"></td><td class="line-content">          &lt;div style="font-weight:700;margin:10px 0 6px;"&gt;Top 20 – Mayor brecha vs meta&lt;/div&gt;</td></tr><tr><td class="line-number" value="1726"></td><td class="line-content">          &lt;div id="AT27_GT_META_top" style="max-height:220px; overflow:auto; border:1px solid #f1f5f9;border-radius:10px;padding:8px;"&gt;&lt;/div&gt;</td></tr><tr><td class="line-number" value="1727"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="1728"></td><td class="line-content">      `;</td></tr><tr><td class="line-number" value="1729"></td><td class="line-content">      document.body.appendChild(panel);</td></tr><tr><td class="line-number" value="1730"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1731"></td><td class="line-content">      panel.querySelector('#AT27_GT_META_close').onclick = ()=&gt;{ AT27_GT_META_clearOverlay(); panel.remove(); };</td></tr><tr><td class="line-number" value="1732"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1733"></td><td class="line-content">      // drag</td></tr><tr><td class="line-number" value="1734"></td><td class="line-content">      (function drag(panel, handle){</td></tr><tr><td class="line-number" value="1735"></td><td class="line-content">        let sx=0, sy=0, ox=0, oy=0, dragging=false;</td></tr><tr><td class="line-number" value="1736"></td><td class="line-content">        handle.addEventListener('mousedown', e=&gt;{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panel.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });</td></tr><tr><td class="line-number" value="1737"></td><td class="line-content">        window.addEventListener('mousemove', e=&gt;{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panel.style.left=(ox+dx)+'px'; panel.style.top=(oy+dy)+'px'; panel.style.right='auto'; });</td></tr><tr><td class="line-number" value="1738"></td><td class="line-content">        window.addEventListener('mouseup', ()=&gt;{ dragging=false; document.body.style.userSelect=''; });</td></tr><tr><td class="line-number" value="1739"></td><td class="line-content">      })(panel, panel.querySelector('#AT27_GT_META_hdr'));</td></tr><tr><td class="line-number" value="1740"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1741"></td><td class="line-content">      // listeners del panel</td></tr><tr><td class="line-number" value="1742"></td><td class="line-content">      const selP = panel.querySelector('#AT27_GT_META_selPuesto');</td></tr><tr><td class="line-number" value="1743"></td><td class="line-content">      const meta = panel.querySelector('#AT27_GT_META_meta');</td></tr><tr><td class="line-number" value="1744"></td><td class="line-content">      const tol  = panel.querySelector('#AT27_GT_META_tol');</td></tr><tr><td class="line-number" value="1745"></td><td class="line-content">      const opa  = panel.querySelector('#AT27_GT_META_opacity');</td></tr><tr><td class="line-number" value="1746"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1747"></td><td class="line-content">      meta.addEventListener('input', ()=&gt;{ panel.querySelector('#AT27_GT_META_meta_val').textContent = meta.value+'%'; AT27_GT_META_update(); });</td></tr><tr><td class="line-number" value="1748"></td><td class="line-content">      tol .addEventListener('input', ()=&gt;{ panel.querySelector('#AT27_GT_META_tol_val').textContent  = Number(tol.value).toFixed(1); AT27_GT_META_update(); });</td></tr><tr><td class="line-number" value="1749"></td><td class="line-content">      opa .addEventListener('input', e=&gt;{ AT27_GT_META_FILL = Number(e.target.value); AT27_GT_META_updateOpacity(); });</td></tr><tr><td class="line-number" value="1750"></td><td class="line-content">      panel.querySelector('#AT27_GT_META_export').addEventListener('click', AT27_GT_META_exportPNG);</td></tr><tr><td class="line-number" value="1751"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1752"></td><td class="line-content">      return panel;</td></tr><tr><td class="line-number" value="1753"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1754"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1755"></td><td class="line-content">    // -------- Render --------</td></tr><tr><td class="line-number" value="1756"></td><td class="line-content">    function AT27_GT_META_render({puesto, metaPct, tolPct, counts, avg, total, worst}){</td></tr><tr><td class="line-number" value="1757"></td><td class="line-content">      const panel = AT27_GT_META_getOrCreatePanel();</td></tr><tr><td class="line-number" value="1758"></td><td class="line-content">      panel.querySelector('#AT27_GT_META_selPuesto').value = puesto;</td></tr><tr><td class="line-number" value="1759"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1760"></td><td class="line-content">      panel.querySelector('#AT27_GT_META_summary').innerHTML =</td></tr><tr><td class="line-number" value="1761"></td><td class="line-content">        `Universo: &lt;b&gt;${total}&lt;/b&gt; secciones · Puesto &lt;b&gt;${AT27_GT_META_PUESTOS[puesto]||puesto}&lt;/b&gt; · ` +</td></tr><tr><td class="line-number" value="1762"></td><td class="line-content">        `Meta: &lt;b&gt;${metaPct}%&lt;/b&gt; · Tolerancia: &lt;b&gt;${tolPct} pp&lt;/b&gt;&lt;br&gt;` +</td></tr><tr><td class="line-number" value="1763"></td><td class="line-content">        `Promedio proyectado 2027* (ponderado LN 2024): &lt;b&gt;${isFinite(avg)?avg.toFixed(1)+'%':'—'}&lt;/b&gt;`;</td></tr><tr><td class="line-number" value="1764"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1765"></td><td class="line-content">      const pct = (n)=&gt; total&gt;0 ? ` (${(n*100/total).toFixed(1)}%)` : '';</td></tr><tr><td class="line-number" value="1766"></td><td class="line-content">      panel.querySelector('#AT27_GT_META_legend').innerHTML = `</td></tr><tr><td class="line-number" value="1767"></td><td class="line-content">        &lt;div style="display:flex;align-items:center;gap:8px;"&gt;</td></tr><tr><td class="line-number" value="1768"></td><td class="line-content">          &lt;span style="width:12px;height:12px;border-radius:3px;background:${AT27_GT_META_COLS.PASS};border:1px solid rgba(0,0,0,.15)"&gt;&lt;/span&gt;</td></tr><tr><td class="line-number" value="1769"></td><td class="line-content">          Cumple meta: &lt;b&gt;${counts.PASS}&lt;/b&gt; &lt;span style="color:#64748b;"&gt;${pct(counts.PASS)}&lt;/span&gt;</td></tr><tr><td class="line-number" value="1770"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="1771"></td><td class="line-content">        &lt;div style="display:flex;align-items:center;gap:8px;"&gt;</td></tr><tr><td class="line-number" value="1772"></td><td class="line-content">          &lt;span style="width:12px;height:12px;border-radius:3px;background:${AT27_GT_META_COLS.NEAR};border:1px solid rgba(0,0,0,.15)"&gt;&lt;/span&gt;</td></tr><tr><td class="line-number" value="1773"></td><td class="line-content">          Cerca de meta (± ${tolPct} pp): &lt;b&gt;${counts.NEAR}&lt;/b&gt; &lt;span style="color:#64748b;"&gt;${pct(counts.NEAR)}&lt;/span&gt;</td></tr><tr><td class="line-number" value="1774"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="1775"></td><td class="line-content">        &lt;div style="display:flex;align-items:center;gap:8px;"&gt;</td></tr><tr><td class="line-number" value="1776"></td><td class="line-content">          &lt;span style="width:12px;height:12px;border-radius:3px;background:${AT27_GT_META_COLS.FAIL};border:1px solid rgba(0,0,0,.15)"&gt;&lt;/span&gt;</td></tr><tr><td class="line-number" value="1777"></td><td class="line-content">          Debajo de meta: &lt;b&gt;${counts.FAIL}&lt;/b&gt; &lt;span style="color:#64748b;"&gt;${pct(counts.FAIL)}&lt;/span&gt;</td></tr><tr><td class="line-number" value="1778"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="1779"></td><td class="line-content">      `;</td></tr><tr><td class="line-number" value="1780"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1781"></td><td class="line-content">      // Top 20 peores brechas</td></tr><tr><td class="line-number" value="1782"></td><td class="line-content">      const rows = worst.slice(0,20).map(w=&gt;{</td></tr><tr><td class="line-number" value="1783"></td><td class="line-content">        const id = w.sec;</td></tr><tr><td class="line-number" value="1784"></td><td class="line-content">        const delta = (w.delta&gt;=0?'+':'') + w.delta.toFixed(1) + ' pp';</td></tr><tr><td class="line-number" value="1785"></td><td class="line-content">        return `</td></tr><tr><td class="line-number" value="1786"></td><td class="line-content">          &lt;div style="display:grid; grid-template-columns: 80px 1fr auto; gap:8px; padding:6px 4px; border-bottom:1px solid #f1f5f9;"&gt;</td></tr><tr><td class="line-number" value="1787"></td><td class="line-content">            &lt;div style="color:#64748b;"&gt;Sección&lt;/div&gt;</td></tr><tr><td class="line-number" value="1788"></td><td class="line-content">            &lt;div style="font-variant-numeric:tabular-nums;"&gt;&lt;b&gt;${id}&lt;/b&gt;&lt;/div&gt;</td></tr><tr><td class="line-number" value="1789"></td><td class="line-content">            &lt;div style="text-align:right; ${w.delta&lt;0?'color:#ef4444;':''}"&gt;${delta}&lt;/div&gt;</td></tr><tr><td class="line-number" value="1790"></td><td class="line-content">            &lt;div&gt;&lt;/div&gt;</td></tr><tr><td class="line-number" value="1791"></td><td class="line-content">            &lt;div style="color:#64748b;"&gt;p2027*&lt;/div&gt;</td></tr><tr><td class="line-number" value="1792"></td><td class="line-content">            &lt;div style="text-align:right; font-variant-numeric:tabular-nums;"&gt;${w.p27.toFixed(1)}%&lt;/div&gt;</td></tr><tr><td class="line-number" value="1793"></td><td class="line-content">          &lt;/div&gt;</td></tr><tr><td class="line-number" value="1794"></td><td class="line-content">        `;</td></tr><tr><td class="line-number" value="1795"></td><td class="line-content">      }).join('') || '&lt;i style="color:#64748b;"&gt;Sin brechas (todas cumplen meta).&lt;/i&gt;';</td></tr><tr><td class="line-number" value="1796"></td><td class="line-content">      panel.querySelector('#AT27_GT_META_top').innerHTML = rows;</td></tr><tr><td class="line-number" value="1797"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1798"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1799"></td><td class="line-content">    // -------- Update loop --------</td></tr><tr><td class="line-number" value="1800"></td><td class="line-content">    async function AT27_GT_META_update(){</td></tr><tr><td class="line-number" value="1801"></td><td class="line-content">      const panel = AT27_GT_META_getOrCreatePanel();</td></tr><tr><td class="line-number" value="1802"></td><td class="line-content">      const selP = panel.querySelector('#AT27_GT_META_selPuesto');</td></tr><tr><td class="line-number" value="1803"></td><td class="line-content">      const meta = panel.querySelector('#AT27_GT_META_meta');</td></tr><tr><td class="line-number" value="1804"></td><td class="line-content">      const tol  = panel.querySelector('#AT27_GT_META_tol');</td></tr><tr><td class="line-number" value="1805"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1806"></td><td class="line-content">      const puesto  = selP.value;</td></tr><tr><td class="line-number" value="1807"></td><td class="line-content">      const metaPct = Number(meta.value);</td></tr><tr><td class="line-number" value="1808"></td><td class="line-content">      const tolPct  = Number(tol.value);</td></tr><tr><td class="line-number" value="1809"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1810"></td><td class="line-content">      const secIds = AT27_GT_META_getUniverseSecIds();</td></tr><tr><td class="line-number" value="1811"></td><td class="line-content">      if (!secIds.length) return alert('No hay secciones en el universo actual.');</td></tr><tr><td class="line-number" value="1812"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1813"></td><td class="line-content">      const js = await (window.loadPuesto ? loadPuesto(puesto) : getElectData(puesto));</td></tr><tr><td class="line-number" value="1814"></td><td class="line-content">      const { perSec, counts, avg } = AT27_GT_META_compute(js, secIds, puesto, metaPct, tolPct);</td></tr><tr><td class="line-number" value="1815"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1816"></td><td class="line-content">      // overlay</td></tr><tr><td class="line-number" value="1817"></td><td class="line-content">      AT27_GT_META_buildOverlay(perSec);</td></tr><tr><td class="line-number" value="1818"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1819"></td><td class="line-content">      // worst (solo las que NO cumplen)</td></tr><tr><td class="line-number" value="1820"></td><td class="line-content">      const worst = Object.entries(perSec)</td></tr><tr><td class="line-number" value="1821"></td><td class="line-content">        .filter(([_,v])=&gt; v.cat!=='PASS')</td></tr><tr><td class="line-number" value="1822"></td><td class="line-content">        .map(([sec,v])=&gt; ({sec, delta:v.delta, p27:v.p27}))</td></tr><tr><td class="line-number" value="1823"></td><td class="line-content">        .sort((a,b)=&gt; (a.delta - b.delta)); // más negativo primero</td></tr><tr><td class="line-number" value="1824"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1825"></td><td class="line-content">      AT27_GT_META_render({puesto, metaPct, tolPct, counts, avg, total:secIds.length, worst});</td></tr><tr><td class="line-number" value="1826"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1827"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1828"></td><td class="line-content">    // -------- Export PNG --------</td></tr><tr><td class="line-number" value="1829"></td><td class="line-content">    async function AT27_GT_META_exportPNG(){</td></tr><tr><td class="line-number" value="1830"></td><td class="line-content">      const mapEl = (window.AT_CTX?.map?._container) || document.querySelector('.leaflet-container,#map,#mapid');</td></tr><tr><td class="line-number" value="1831"></td><td class="line-content">      if (!mapEl){ alert('No encontré el contenedor del mapa.'); return; }</td></tr><tr><td class="line-number" value="1832"></td><td class="line-content">      async function ensureHtml2Canvas(){</td></tr><tr><td class="line-number" value="1833"></td><td class="line-content">        if (window.html2canvas) return;</td></tr><tr><td class="line-number" value="1834"></td><td class="line-content">        await new Promise((resolve, reject)=&gt;{</td></tr><tr><td class="line-number" value="1835"></td><td class="line-content">          const s=document.createElement('script');</td></tr><tr><td class="line-number" value="1836"></td><td class="line-content">          s.src='https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';</td></tr><tr><td class="line-number" value="1837"></td><td class="line-content">          s.onload=resolve; s.onerror=()=&gt;reject(new Error('No pude cargar html2canvas'));</td></tr><tr><td class="line-number" value="1838"></td><td class="line-content">          document.head.appendChild(s);</td></tr><tr><td class="line-number" value="1839"></td><td class="line-content">        });</td></tr><tr><td class="line-number" value="1840"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="1841"></td><td class="line-content">      try{</td></tr><tr><td class="line-number" value="1842"></td><td class="line-content">        await ensureHtml2Canvas();</td></tr><tr><td class="line-number" value="1843"></td><td class="line-content">        const canvas = await window.html2canvas(mapEl, {useCORS:true, backgroundColor:null, logging:false});</td></tr><tr><td class="line-number" value="1844"></td><td class="line-content">        const link = document.createElement('a');</td></tr><tr><td class="line-number" value="1845"></td><td class="line-content">        link.download = `meta_participacion_${Date.now()}.png`;</td></tr><tr><td class="line-number" value="1846"></td><td class="line-content">        link.href = canvas.toDataURL('image/png');</td></tr><tr><td class="line-number" value="1847"></td><td class="line-content">        link.click();</td></tr><tr><td class="line-number" value="1848"></td><td class="line-content">      }catch(e){</td></tr><tr><td class="line-number" value="1849"></td><td class="line-content">        console.error(e);</td></tr><tr><td class="line-number" value="1850"></td><td class="line-content">        alert('No pude exportar PNG (CORS o bloqueo de librería).');</td></tr><tr><td class="line-number" value="1851"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="1852"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1853"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1854"></td><td class="line-content">    // -------- API pública --------</td></tr><tr><td class="line-number" value="1855"></td><td class="line-content">    async function AT27_GT_META_ejecutar(puestoInicial='A', metaInicial=50, tolInicial=3){</td></tr><tr><td class="line-number" value="1856"></td><td class="line-content">      try{</td></tr><tr><td class="line-number" value="1857"></td><td class="line-content">        // crea panel e inicializa controles</td></tr><tr><td class="line-number" value="1858"></td><td class="line-content">        const panel = AT27_GT_META_getOrCreatePanel();</td></tr><tr><td class="line-number" value="1859"></td><td class="line-content">        const selP  = panel.querySelector('#AT27_GT_META_selPuesto');</td></tr><tr><td class="line-number" value="1860"></td><td class="line-content">        const meta  = panel.querySelector('#AT27_GT_META_meta');</td></tr><tr><td class="line-number" value="1861"></td><td class="line-content">        const tol   = panel.querySelector('#AT27_GT_META_tol');</td></tr><tr><td class="line-number" value="1862"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1863"></td><td class="line-content">        selP.value = puestoInicial;</td></tr><tr><td class="line-number" value="1864"></td><td class="line-content">        meta.value = String(metaInicial);</td></tr><tr><td class="line-number" value="1865"></td><td class="line-content">        tol.value  = String(tolInicial);</td></tr><tr><td class="line-number" value="1866"></td><td class="line-content">        panel.querySelector('#AT27_GT_META_meta_val').textContent = meta.value+'%';</td></tr><tr><td class="line-number" value="1867"></td><td class="line-content">        panel.querySelector('#AT27_GT_META_tol_val').textContent  = Number(tol.value).toFixed(1);</td></tr><tr><td class="line-number" value="1868"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1869"></td><td class="line-content">        // cambia puesto → recalc</td></tr><tr><td class="line-number" value="1870"></td><td class="line-content">        selP.onchange = AT27_GT_META_update;</td></tr><tr><td class="line-number" value="1871"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1872"></td><td class="line-content">        // primer render</td></tr><tr><td class="line-number" value="1873"></td><td class="line-content">        await AT27_GT_META_update();</td></tr><tr><td class="line-number" value="1874"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1875"></td><td class="line-content">        // cerrar panel limpia overlay</td></tr><tr><td class="line-number" value="1876"></td><td class="line-content">        panel.querySelector('#AT27_GT_META_close').onclick = ()=&gt;{ AT27_GT_META_clearOverlay(); panel.remove(); };</td></tr><tr><td class="line-number" value="1877"></td><td class="line-content">          }catch(e){</td></tr><tr><td class="line-number" value="1878"></td><td class="line-content">        console.error('AT27_GT_META_ejecutar error:', e);</td></tr><tr><td class="line-number" value="1879"></td><td class="line-content">        alert('No pude calcular las metas de participación.');</td></tr><tr><td class="line-number" value="1880"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="1881"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1882"></td><td class="line-content">    /* ======================== FIN · METAS DE PARTICIPACIÓN 2027* ======================== */</td></tr><tr><td class="line-number" value="1883"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1884"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1885"></td><td class="line-content"><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="1886"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1887"></td><td class="line-content"><span class="html-tag">&lt;script&gt;</span></td></tr><tr><td class="line-number" value="1888"></td><td class="line-content">  // Debounce simple</td></tr><tr><td class="line-number" value="1889"></td><td class="line-content">  function atDebounce(fn, ms=250){ let t; return (...a)=&gt;{ clearTimeout(t); t=setTimeout(()=&gt;fn(...a), ms); }; }</td></tr><tr><td class="line-number" value="1890"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1891"></td><td class="line-content">  // Recalcula cuando el universo (capas visibles) cambia</td></tr><tr><td class="line-number" value="1892"></td><td class="line-content">  function AT27_GG_bindUniverseAutoRecalc(){</td></tr><tr><td class="line-number" value="1893"></td><td class="line-content">    const map = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="1894"></td><td class="line-content">    if (!map || map.__ggAuto) return;</td></tr><tr><td class="line-number" value="1895"></td><td class="line-content">    const recalc = atDebounce(()=&gt;{</td></tr><tr><td class="line-number" value="1896"></td><td class="line-content">      // Si el panel está abierto, vuelve a ejecutar usando el universo actual</td></tr><tr><td class="line-number" value="1897"></td><td class="line-content">      if (document.getElementById('AT27_GG_panel')) AT27_GG_run();</td></tr><tr><td class="line-number" value="1898"></td><td class="line-content">    }, 300);</td></tr><tr><td class="line-number" value="1899"></td><td class="line-content">    map.on('layeradd', recalc);</td></tr><tr><td class="line-number" value="1900"></td><td class="line-content">    map.on('layerremove', recalc);</td></tr><tr><td class="line-number" value="1901"></td><td class="line-content">    map.__ggAuto = true;</td></tr><tr><td class="line-number" value="1902"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="1903"></td><td class="line-content"><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="1904"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1905"></td><td class="line-content"><span class="html-tag">&lt;script&gt;</span></td></tr><tr><td class="line-number" value="1906"></td><td class="line-content">  /* ====== GANAR TODO · ¿Qué se requiere para ganar todo? (AT27_GT_GANAR_) ====== */</td></tr><tr><td class="line-number" value="1907"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1908"></td><td class="line-content">    // Mapa secId -&gt; layer (asegura existencia)</td></tr><tr><td class="line-number" value="1909"></td><td class="line-content">  window.AT27_GG_LAYERS_BY_SEC = window.AT27_GG_LAYERS_BY_SEC || {};</td></tr><tr><td class="line-number" value="1910"></td><td class="line-content">  window.AT27_GG_STATE = window.AT27_GG_STATE || { running:false, autorun:false };</td></tr><tr><td class="line-number" value="1911"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1912"></td><td class="line-content">  function atDebounce(fn, ms=250){ let t; return (...a)=&gt;{ clearTimeout(t); t=setTimeout(()=&gt;fn(...a), ms); }; }</td></tr><tr><td class="line-number" value="1913"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1914"></td><td class="line-content">  function AT27_GG_bindUniverseAutoRecalc(){</td></tr><tr><td class="line-number" value="1915"></td><td class="line-content">    const map = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="1916"></td><td class="line-content">    if (!map || map.__ggBound) return;</td></tr><tr><td class="line-number" value="1917"></td><td class="line-content">    const recalc = atDebounce(()=&gt;{</td></tr><tr><td class="line-number" value="1918"></td><td class="line-content">      // Recalcula SOLO si ya corriste una vez y el panel está abierto</td></tr><tr><td class="line-number" value="1919"></td><td class="line-content">      if (!document.getElementById('AT27_GG_panel')) return;</td></tr><tr><td class="line-number" value="1920"></td><td class="line-content">      if (!window.AT27_GG_STATE.autorun) return;</td></tr><tr><td class="line-number" value="1921"></td><td class="line-content">      if (window.AT27_GG_STATE.running) return;</td></tr><tr><td class="line-number" value="1922"></td><td class="line-content">      AT27_GG_run();</td></tr><tr><td class="line-number" value="1923"></td><td class="line-content">    }, 350);</td></tr><tr><td class="line-number" value="1924"></td><td class="line-content">    map.on('layeradd', recalc);</td></tr><tr><td class="line-number" value="1925"></td><td class="line-content">    map.on('layerremove', recalc);</td></tr><tr><td class="line-number" value="1926"></td><td class="line-content">    map.__ggBound = true;</td></tr><tr><td class="line-number" value="1927"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="1928"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1929"></td><td class="line-content">const AT27_GG_sec = s =&gt; String(s??'').replace(/\D+/g,'');</td></tr><tr><td class="line-number" value="1930"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1931"></td><td class="line-content">  const AT27_GT_GANAR_PUESTOS = { A:'Ayuntamiento', DL:'Diputado Local', DF:'Diputado Federal' };</td></tr><tr><td class="line-number" value="1932"></td><td class="line-content">  const AT27_GT_GANAR_PARTIDOS = ['PAN','PRI','PVEM','MORENA'];</td></tr><tr><td class="line-number" value="1933"></td><td class="line-content">  const AT27_GT_GANAR_COLORS = {</td></tr><tr><td class="line-number" value="1934"></td><td class="line-content">    PAN:'#2563eb', PRI:'#dc2626', PVEM:'#16a34a', MORENA:'#7a1d1d',</td></tr><tr><td class="line-number" value="1935"></td><td class="line-content">    OTHER:'#94a3b8'</td></tr><tr><td class="line-number" value="1936"></td><td class="line-content">  };</td></tr><tr><td class="line-number" value="1937"></td><td class="line-content">  let AT27_GT_GANAR_FILL = 0.45;</td></tr><tr><td class="line-number" value="1938"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1939"></td><td class="line-content">  const AT27_GG_yearsFor = p =&gt; (['A','DL','DF'].includes(p) ? ['2018','2021','2024'] : ['2018','2024']); // por si acaso</td></tr><tr><td class="line-number" value="1940"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1941"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1942"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1943"></td><td class="line-content">  function AT27_GG_getUniverseSecIds(){</td></tr><tr><td class="line-number" value="1944"></td><td class="line-content">    const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];</td></tr><tr><td class="line-number" value="1945"></td><td class="line-content">    const ids=[]; for (const f of feats){ const p=f.properties||{}; const id=AT27_GG_sec(p.ID??p.Seccion??p.SECCION??p.seccion??p.id); if(id) ids.push(id); }</td></tr><tr><td class="line-number" value="1946"></td><td class="line-content">    return [...new Set(ids)];</td></tr><tr><td class="line-number" value="1947"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="1948"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1949"></td><td class="line-content"> function AT27_GG_partPct(row){</td></tr><tr><td class="line-number" value="1950"></td><td class="line-content">    if (!row) return null;</td></tr><tr><td class="line-number" value="1951"></td><td class="line-content">    const ln = Number(row.LN||0); if (!ln) return null;</td></tr><tr><td class="line-number" value="1952"></td><td class="line-content">    let votos = (row.VOTOS!=null) ? Number(row.VOTOS||0) : 0;</td></tr><tr><td class="line-number" value="1953"></td><td class="line-content">    if (row.VOTOS==null){ for (const [k,v] of Object.entries(row)){ if (k!=='LN' &amp;&amp; k!=='VOTOS') votos += Number(v||0); } }</td></tr><tr><td class="line-number" value="1954"></td><td class="line-content">    return Math.max(0, Math.min(100, (votos/ln)*100));</td></tr><tr><td class="line-number" value="1955"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="1956"></td><td class="line-content">  function AT27_GG_project2027(slot, puesto){</td></tr><tr><td class="line-number" value="1957"></td><td class="line-content">    const p18 = AT27_GG_partPct(slot['2018']);</td></tr><tr><td class="line-number" value="1958"></td><td class="line-content">    const p21 = AT27_GG_partPct(slot['2021']);</td></tr><tr><td class="line-number" value="1959"></td><td class="line-content">    const p24 = AT27_GG_partPct(slot['2024']);</td></tr><tr><td class="line-number" value="1960"></td><td class="line-content">    const vals = [p18,p21,p24].filter(v=&gt;typeof v==='number'&amp;&amp;isFinite(v));</td></tr><tr><td class="line-number" value="1961"></td><td class="line-content">    if (vals.length===0) return null;</td></tr><tr><td class="line-number" value="1962"></td><td class="line-content">    if (['G','S','P'].includes(puesto)){</td></tr><tr><td class="line-number" value="1963"></td><td class="line-content">      const a = (typeof p18==='number')?p18:p24, b=(typeof p24==='number')?p24:p18;</td></tr><tr><td class="line-number" value="1964"></td><td class="line-content">      const slopePerYear = (b-a)/6;</td></tr><tr><td class="line-number" value="1965"></td><td class="line-content">      return Math.max(0, Math.min(100, b + 0.6*slopePerYear*3));</td></tr><tr><td class="line-number" value="1966"></td><td class="line-content">    }else{</td></tr><tr><td class="line-number" value="1967"></td><td class="line-content">      const pts=[]; if (typeof p18==='number') pts.push({t:0,y:p18,w:1.0}); if (typeof p21==='number') pts.push({t:3,y:p21,w:1.5}); if (typeof p24==='number') pts.push({t:6,y:p24,w:2.0});</td></tr><tr><td class="line-number" value="1968"></td><td class="line-content">      const W=pts.reduce((a,p)=&gt;a+p.w,0), tbar=pts.reduce((a,p)=&gt;a+p.w*p.t,0)/W, ybar=pts.reduce((a,p)=&gt;a+p.w*p.y,0)/W;</td></tr><tr><td class="line-number" value="1969"></td><td class="line-content">      const num=pts.reduce((a,p)=&gt;a+p.w*(p.t-tbar)*(p.y-ybar),0), den=pts.reduce((a,p)=&gt;a+p.w*(p.t-tbar)*(p.t-tbar),0)||1e-9;</td></tr><tr><td class="line-number" value="1970"></td><td class="line-content">      const b1=num/den, b0=ybar-b1*tbar;</td></tr><tr><td class="line-number" value="1971"></td><td class="line-content">      return Math.max(0, Math.min(100, b0 + b1*9));</td></tr><tr><td class="line-number" value="1972"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1973"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="1974"></td><td class="line-content">  function AT27_GG_shares2024(row24){</td></tr><tr><td class="line-number" value="1975"></td><td class="line-content">    if (!row24) return { total:0, shares:{} };</td></tr><tr><td class="line-number" value="1976"></td><td class="line-content">    let total = (row24.VOTOS!=null) ? Number(row24.VOTOS||0) : 0;</td></tr><tr><td class="line-number" value="1977"></td><td class="line-content">    if (row24.VOTOS==null){ for (const [k,v] of Object.entries(row24)){ if (k!=='LN' &amp;&amp; k!=='VOTOS') total += Number(v||0); } }</td></tr><tr><td class="line-number" value="1978"></td><td class="line-content">    const shares = {};</td></tr><tr><td class="line-number" value="1979"></td><td class="line-content">    if (total&gt;0){</td></tr><tr><td class="line-number" value="1980"></td><td class="line-content">      for (const [k,v] of Object.entries(row24)){</td></tr><tr><td class="line-number" value="1981"></td><td class="line-content">        if (k==='LN'||k==='VOTOS') continue;</td></tr><tr><td class="line-number" value="1982"></td><td class="line-content">        shares[k.toUpperCase()] = Number(v||0)/total;</td></tr><tr><td class="line-number" value="1983"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="1984"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1985"></td><td class="line-content">    return { total, shares };</td></tr><tr><td class="line-number" value="1986"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="1987"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1988"></td><td class="line-content">  function AT27_GG_compute(js, secIds, puesto, partidoSel){</td></tr><tr><td class="line-number" value="1989"></td><td class="line-content">    const perSec = {};</td></tr><tr><td class="line-number" value="1990"></td><td class="line-content">    let votosTotalParaGanar = 0, swingTotal=0, ganadas=0;</td></tr><tr><td class="line-number" value="1991"></td><td class="line-content">    const X = partidoSel.toUpperCase();</td></tr><tr><td class="line-number" value="1992"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1993"></td><td class="line-content">    for (const sec of secIds){</td></tr><tr><td class="line-number" value="1994"></td><td class="line-content">      const slot = js?.secciones?.[sec]; if (!slot) continue;</td></tr><tr><td class="line-number" value="1995"></td><td class="line-content">      const p27 = AT27_GG_project2027(slot, puesto);</td></tr><tr><td class="line-number" value="1996"></td><td class="line-content">      const row24 = slot['2024'];</td></tr><tr><td class="line-number" value="1997"></td><td class="line-content">      if (p27==null || !row24) continue;</td></tr><tr><td class="line-number" value="1998"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1999"></td><td class="line-content">      const ln24 = Number(row24.LN||0);</td></tr><tr><td class="line-number" value="2000"></td><td class="line-content">      if (!ln24) continue;</td></tr><tr><td class="line-number" value="2001"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2002"></td><td class="line-content">      const Vproj = ln24 * (p27/100); // float, más estable</td></tr><tr><td class="line-number" value="2003"></td><td class="line-content">      if (!isFinite(Vproj) || Vproj &lt; 1) continue;</td></tr><tr><td class="line-number" value="2004"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2005"></td><td class="line-content">      const { shares, total:tot24 } = AT27_GG_shares2024(row24);</td></tr><tr><td class="line-number" value="2006"></td><td class="line-content">      if (!Object.keys(shares).length || !tot24) continue;</td></tr><tr><td class="line-number" value="2007"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2008"></td><td class="line-content">      // votos base 2027 por partido (manteniendo shares 2024) en float</td></tr><tr><td class="line-number" value="2009"></td><td class="line-content">      const vBase = {};</td></tr><tr><td class="line-number" value="2010"></td><td class="line-content">      for (const [sigla,sh] of Object.entries(shares)){</td></tr><tr><td class="line-number" value="2011"></td><td class="line-content">        vBase[sigla.toUpperCase()] = sh * Vproj;</td></tr><tr><td class="line-number" value="2012"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="2013"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2014"></td><td class="line-content">      // puntero y tu partido</td></tr><tr><td class="line-number" value="2015"></td><td class="line-content">      let L=null, vL=-1;</td></tr><tr><td class="line-number" value="2016"></td><td class="line-content">      for (const [sig, vv] of Object.entries(vBase)){ if (vv&gt;vL){ vL=vv; L=sig; } }</td></tr><tr><td class="line-number" value="2017"></td><td class="line-content">      const vX = vBase[X] || 0;</td></tr><tr><td class="line-number" value="2018"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2019"></td><td class="line-content">      const faltanFloat = Math.max(0, (vL - vX) + 1);</td></tr><tr><td class="line-number" value="2020"></td><td class="line-content">      const swingFloat  = Math.max(0, faltanFloat / 2);</td></tr><tr><td class="line-number" value="2021"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2022"></td><td class="line-content">      perSec[AT27_GG_sec(sec)] = { winner:L, vL, vX, faltan:faltanFloat, swing:swingFloat, p27, Vproj };</td></tr><tr><td class="line-number" value="2023"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2024"></td><td class="line-content">      if (faltanFloat&lt;=0 &amp;&amp; L===X) ganadas++;</td></tr><tr><td class="line-number" value="2025"></td><td class="line-content">      votosTotalParaGanar += Math.ceil(faltanFloat);</td></tr><tr><td class="line-number" value="2026"></td><td class="line-content">      swingTotal         += Math.ceil(swingFloat);</td></tr><tr><td class="line-number" value="2027"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="2028"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2029"></td><td class="line-content">    return { perSec, resumen: { votosTotalParaGanar, swingTotal, ganadas, total:Object.keys(perSec).length } };</td></tr><tr><td class="line-number" value="2030"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="2031"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2032"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2033"></td><td class="line-content">  // ---------- Overlay ----------</td></tr><tr><td class="line-number" value="2034"></td><td class="line-content">    function AT27_GG_clearOverlay(){</td></tr><tr><td class="line-number" value="2035"></td><td class="line-content">      const map = window.AT_CTX?.map || window.map; if (!map) return;</td></tr><tr><td class="line-number" value="2036"></td><td class="line-content">      if (window.AT27_GG_LAYER){ try{ map.removeLayer(AT27_GG_LAYER); }catch(_){ } window.AT27_GG_LAYER=null; }</td></tr><tr><td class="line-number" value="2037"></td><td class="line-content">      window.AT27_GG_LAYERS_BY_SEC = {}; // reset índice de layers</td></tr><tr><td class="line-number" value="2038"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="2039"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2040"></td><td class="line-content">    function AT27_GG_buildOverlay(perSec){</td></tr><tr><td class="line-number" value="2041"></td><td class="line-content">      const map  = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="2042"></td><td class="line-content">      const base = window.AT_CTX?.layer?.toGeoJSON?.() || window.AT_DATA;</td></tr><tr><td class="line-number" value="2043"></td><td class="line-content">      if (!map || !base?.features) return;</td></tr><tr><td class="line-number" value="2044"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2045"></td><td class="line-content">      AT27_GG_clearOverlay(); // &lt;- evita sobreponer capas</td></tr><tr><td class="line-number" value="2046"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2047"></td><td class="line-content">      if (map.createPane &amp;&amp; !map.getPane('at27_gg_pane')){</td></tr><tr><td class="line-number" value="2048"></td><td class="line-content">        map.createPane('at27_gg_pane');</td></tr><tr><td class="line-number" value="2049"></td><td class="line-content">        const p = map.getPane('at27_gg_pane');</td></tr><tr><td class="line-number" value="2050"></td><td class="line-content">        p.style.zIndex = 675;</td></tr><tr><td class="line-number" value="2051"></td><td class="line-content">        p.style.pointerEvents = 'auto';</td></tr><tr><td class="line-number" value="2052"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="2053"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2054"></td><td class="line-content">      const features = base.features.filter(f=&gt;{</td></tr><tr><td class="line-number" value="2055"></td><td class="line-content">        const id = AT27_GG_sec(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);</td></tr><tr><td class="line-number" value="2056"></td><td class="line-content">        return perSec[id]!=null;</td></tr><tr><td class="line-number" value="2057"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="2058"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2059"></td><td class="line-content">      const layer = L.geoJSON({type:'FeatureCollection', features}, {</td></tr><tr><td class="line-number" value="2060"></td><td class="line-content">        pane:'at27_gg_pane',</td></tr><tr><td class="line-number" value="2061"></td><td class="line-content">        style: f=&gt;{</td></tr><tr><td class="line-number" value="2062"></td><td class="line-content">          const id = AT27_GG_sec(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);</td></tr><tr><td class="line-number" value="2063"></td><td class="line-content">          const win = perSec[id]?.winner || 'OTHER';</td></tr><tr><td class="line-number" value="2064"></td><td class="line-content">          const col = AT27_GT_GANAR_COLORS[win] || AT27_GT_GANAR_COLORS.OTHER;</td></tr><tr><td class="line-number" value="2065"></td><td class="line-content">          return { color:col, weight:1, opacity:.9, fillColor:col, fillOpacity:AT27_GT_GANAR_FILL };</td></tr><tr><td class="line-number" value="2066"></td><td class="line-content">        },</td></tr><tr><td class="line-number" value="2067"></td><td class="line-content">        onEachFeature: (feature, lyr)=&gt;{</td></tr><tr><td class="line-number" value="2068"></td><td class="line-content">          const idRaw = feature.properties?.ID ?? feature.properties?.SECCION ?? feature.properties?.id;</td></tr><tr><td class="line-number" value="2069"></td><td class="line-content">          const id    = AT27_GG_sec(idRaw);</td></tr><tr><td class="line-number" value="2070"></td><td class="line-content">          // indexa con alias (141, 0141, etc.)</td></tr><tr><td class="line-number" value="2071"></td><td class="line-content">          [ id, id.padStart(4,'0'), String(Number(id)) ].forEach(k =&gt; { window.AT27_GG_LAYERS_BY_SEC[k] = lyr; });</td></tr><tr><td class="line-number" value="2072"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2073"></td><td class="line-content">          const info = perSec[id]; if (!info) return;</td></tr><tr><td class="line-number" value="2074"></td><td class="line-content">          const p = (x)=&gt; isFinite(x) ? x.toFixed(1)+'%' : '—';</td></tr><tr><td class="line-number" value="2075"></td><td class="line-content">          const tip = `&lt;div style="font-size:12px;"&gt;</td></tr><tr><td class="line-number" value="2076"></td><td class="line-content">            Sección &lt;b&gt;${id}&lt;/b&gt;&lt;br&gt;</td></tr><tr><td class="line-number" value="2077"></td><td class="line-content">            Proyección 2027*: &lt;b&gt;${p(info.p27)}&lt;/b&gt; · Votos proj: &lt;b&gt;${Math.round(info.Vproj).toLocaleString()}&lt;/b&gt;&lt;br&gt;</td></tr><tr><td class="line-number" value="2078"></td><td class="line-content">            Líder: &lt;b&gt;${info.winner}&lt;/b&gt; ${Math.round(info.vL).toLocaleString()} vs Tú: &lt;b&gt;${Math.round(info.vX).toLocaleString()}&lt;/b&gt;&lt;br&gt;</td></tr><tr><td class="line-number" value="2079"></td><td class="line-content">            Faltan: &lt;b&gt;${Math.max(0, Math.ceil(info.faltan)).toLocaleString()}&lt;/b&gt; · Swing: &lt;b&gt;${Math.max(0, Math.ceil(info.swing)).toLocaleString()}&lt;/b&gt;</td></tr><tr><td class="line-number" value="2080"></td><td class="line-content">          &lt;/div&gt;`;</td></tr><tr><td class="line-number" value="2081"></td><td class="line-content">          lyr.bindTooltip(tip, { sticky:true, opacity:0.95, direction:'top', className:'at27-tt' });</td></tr><tr><td class="line-number" value="2082"></td><td class="line-content">          lyr.on('mouseover', ()=&gt; lyr.setStyle({weight:2}));</td></tr><tr><td class="line-number" value="2083"></td><td class="line-content">          lyr.on('mouseout',  ()=&gt; lyr.setStyle({weight:1}));</td></tr><tr><td class="line-number" value="2084"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="2085"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="2086"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2087"></td><td class="line-content">      layer.addTo(map);</td></tr><tr><td class="line-number" value="2088"></td><td class="line-content">      window.AT27_GG_LAYER = layer;</td></tr><tr><td class="line-number" value="2089"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="2090"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2091"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2092"></td><td class="line-content">  function AT27_GG_updateOpacity(){</td></tr><tr><td class="line-number" value="2093"></td><td class="line-content">    if (window.AT27_GG_LAYER) window.AT27_GG_LAYER.setStyle({ fillOpacity: AT27_GT_GANAR_FILL });</td></tr><tr><td class="line-number" value="2094"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="2095"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2096"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2097"></td><td class="line-content">  function AT27_GG_focusSection(sec){</td></tr><tr><td class="line-number" value="2098"></td><td class="line-content">    const base = AT27_GG_sec(sec);</td></tr><tr><td class="line-number" value="2099"></td><td class="line-content">    const dict = window.AT27_GG_LAYERS_BY_SEC || {};</td></tr><tr><td class="line-number" value="2100"></td><td class="line-content">    const candidates = [ base, base.padStart(4,'0'), String(Number(base)) ];</td></tr><tr><td class="line-number" value="2101"></td><td class="line-content">    let lyr = null;</td></tr><tr><td class="line-number" value="2102"></td><td class="line-content">    for (const k of candidates){ if (dict[k]) { lyr = dict[k]; break; } }</td></tr><tr><td class="line-number" value="2103"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2104"></td><td class="line-content">    const map = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="2105"></td><td class="line-content">    if (!map){ console.warn('No hay mapa'); return; }</td></tr><tr><td class="line-number" value="2106"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2107"></td><td class="line-content">    if (!lyr){</td></tr><tr><td class="line-number" value="2108"></td><td class="line-content">      // Fallback: buscar el feature en el universo y centrarlo</td></tr><tr><td class="line-number" value="2109"></td><td class="line-content">      const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];</td></tr><tr><td class="line-number" value="2110"></td><td class="line-content">      const feat = feats.find(f=&gt;{</td></tr><tr><td class="line-number" value="2111"></td><td class="line-content">        const pid = AT27_GG_sec(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);</td></tr><tr><td class="line-number" value="2112"></td><td class="line-content">        const cands = [ pid, pid.padStart(4,'0'), String(Number(pid)) ];</td></tr><tr><td class="line-number" value="2113"></td><td class="line-content">        return cands.some(x =&gt; candidates.includes(x));</td></tr><tr><td class="line-number" value="2114"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="2115"></td><td class="line-content">      if (feat){</td></tr><tr><td class="line-number" value="2116"></td><td class="line-content">        const tmp = L.geoJSON(feat);</td></tr><tr><td class="line-number" value="2117"></td><td class="line-content">        try{ map.fitBounds(tmp.getBounds(), {maxZoom:16, padding:[20,20]}); }catch(_){}</td></tr><tr><td class="line-number" value="2118"></td><td class="line-content">        return;</td></tr><tr><td class="line-number" value="2119"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="2120"></td><td class="line-content">      console.warn('No encontré layer ni feature para', base);</td></tr><tr><td class="line-number" value="2121"></td><td class="line-content">      return;</td></tr><tr><td class="line-number" value="2122"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="2123"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2124"></td><td class="line-content">    try{ map.fitBounds(lyr.getBounds(), { maxZoom:16, padding:[20,20] }); }catch(_){}</td></tr><tr><td class="line-number" value="2125"></td><td class="line-content">    if (lyr.openTooltip) lyr.openTooltip();</td></tr><tr><td class="line-number" value="2126"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2127"></td><td class="line-content">    // flash</td></tr><tr><td class="line-number" value="2128"></td><td class="line-content">    const orig = AT27_GT_GANAR_FILL;</td></tr><tr><td class="line-number" value="2129"></td><td class="line-content">    lyr.setStyle({ weight:3, fillOpacity:Math.min(0.9, orig+0.25) });</td></tr><tr><td class="line-number" value="2130"></td><td class="line-content">    if (lyr.bringToFront) lyr.bringToFront();</td></tr><tr><td class="line-number" value="2131"></td><td class="line-content">    setTimeout(()=&gt; lyr.setStyle({ weight:1, fillOpacity:orig }), 1200);</td></tr><tr><td class="line-number" value="2132"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="2133"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2134"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2135"></td><td class="line-content">  // ---------- Panel ----------</td></tr><tr><td class="line-number" value="2136"></td><td class="line-content">  function AT27_GG_getOrCreatePanel(){</td></tr><tr><td class="line-number" value="2137"></td><td class="line-content">    let panel = document.getElementById('AT27_GG_panel');</td></tr><tr><td class="line-number" value="2138"></td><td class="line-content">    if (panel) return panel;</td></tr><tr><td class="line-number" value="2139"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2140"></td><td class="line-content">    panel = document.createElement('div');</td></tr><tr><td class="line-number" value="2141"></td><td class="line-content">    panel.id = 'AT27_GG_panel';</td></tr><tr><td class="line-number" value="2142"></td><td class="line-content">    Object.assign(panel.style,{</td></tr><tr><td class="line-number" value="2143"></td><td class="line-content">      position:'fixed', right:'24px', top:'24px', zIndex:9999,</td></tr><tr><td class="line-number" value="2144"></td><td class="line-content">      width: Math.min(480, window.innerWidth - 64) + 'px', background:'#fff',</td></tr><tr><td class="line-number" value="2145"></td><td class="line-content">      border:'1px solid #e5e7eb',</td></tr><tr><td class="line-number" value="2146"></td><td class="line-content">      maxWidth:  'calc(100vw - 48px)',</td></tr><tr><td class="line-number" value="2147"></td><td class="line-content">      maxHeight: 'calc(100vh - 48px)',</td></tr><tr><td class="line-number" value="2148"></td><td class="line-content">      borderRadius:'14px', boxShadow:'0 18px 40px rgba(0,0,0,.18)',</td></tr><tr><td class="line-number" value="2149"></td><td class="line-content">      height:'auto',</td></tr><tr><td class="line-number" value="2150"></td><td class="line-content">      overflow:'hidden', fontFamily:'system-ui, Segoe UI, Roboto, Arial',</td></tr><tr><td class="line-number" value="2151"></td><td class="line-content">      resize:'both', minWidth:'360px', minHeight:'300px', display:'flex',</td></tr><tr><td class="line-number" value="2152"></td><td class="line-content">      flexDirection:'column'</td></tr><tr><td class="line-number" value="2153"></td><td class="line-content">    });</td></tr><tr><td class="line-number" value="2154"></td><td class="line-content">    panel.innerHTML = `</td></tr><tr><td class="line-number" value="2155"></td><td class="line-content">      &lt;div id="AT27_GG_hdr" style="cursor:move; user-select:none; background:#ffe4ef; color:#111; padding:10px 12px; display:flex; gap:10px; align-items:center;"&gt;</td></tr><tr><td class="line-number" value="2156"></td><td class="line-content">        &lt;div style="font-weight:800;"&gt;¿Qué se requiere para ganar todo?&lt;/div&gt;</td></tr><tr><td class="line-number" value="2157"></td><td class="line-content">        &lt;button id="AT27_GG_close" title="Cerrar" style="margin-left:auto;background:transparent;color:#111;border:none;font-size:18px;cursor:pointer;"&gt;×&lt;/button&gt;</td></tr><tr><td class="line-number" value="2158"></td><td class="line-content">      &lt;/div&gt;</td></tr><tr><td class="line-number" value="2159"></td><td class="line-content">      &lt;div id="AT27_GG_body" style="padding:12px 14px; flex:1; overflow:auto;"&gt;</td></tr><tr><td class="line-number" value="2160"></td><td class="line-content">        &lt;div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;"&gt;</td></tr><tr><td class="line-number" value="2161"></td><td class="line-content">          &lt;label style="display:flex;flex-direction:column;gap:6px;"&gt;</td></tr><tr><td class="line-number" value="2162"></td><td class="line-content">            &lt;span style="font-size:12px;color:#334155;"&gt;Puesto&lt;/span&gt;</td></tr><tr><td class="line-number" value="2163"></td><td class="line-content">            &lt;select id="AT27_GG_selPuesto" style="background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:8px;"&gt;</td></tr><tr><td class="line-number" value="2164"></td><td class="line-content">              ${Object.entries(AT27_GT_GANAR_PUESTOS).map(([k,v])=&gt;`&lt;option value="${k}"&gt;${v}&lt;/option&gt;`).join('')}</td></tr><tr><td class="line-number" value="2165"></td><td class="line-content">            &lt;/select&gt;</td></tr><tr><td class="line-number" value="2166"></td><td class="line-content">          &lt;/label&gt;</td></tr><tr><td class="line-number" value="2167"></td><td class="line-content">          &lt;label style="display:flex;flex-direction:column;gap:6px;"&gt;</td></tr><tr><td class="line-number" value="2168"></td><td class="line-content">            &lt;span style="font-size:12px;color:#334155;"&gt;Partido&lt;/span&gt;</td></tr><tr><td class="line-number" value="2169"></td><td class="line-content">            &lt;select id="AT27_GG_selPartido" style="background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:8px;"&gt;</td></tr><tr><td class="line-number" value="2170"></td><td class="line-content">              ${AT27_GT_GANAR_PARTIDOS.map(p=&gt;`&lt;option&gt;${p}&lt;/option&gt;`).join('')}</td></tr><tr><td class="line-number" value="2171"></td><td class="line-content">            &lt;/select&gt;</td></tr><tr><td class="line-number" value="2172"></td><td class="line-content">          &lt;/label&gt;</td></tr><tr><td class="line-number" value="2173"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="2174"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2175"></td><td class="line-content">        &lt;div style="display:flex; align-items:center; gap:10px; margin:12px 0;"&gt;</td></tr><tr><td class="line-number" value="2176"></td><td class="line-content">          &lt;div style="font-size:12px;color:#334155;"&gt;Opacidad&lt;/div&gt;</td></tr><tr><td class="line-number" value="2177"></td><td class="line-content">          &lt;input id="AT27_GG_opacity" type="range" min="0.1" max="0.9" step="0.05" value="${AT27_GT_GANAR_FILL}" style="flex:1;"&gt;</td></tr><tr><td class="line-number" value="2178"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="2179"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2180"></td><td class="line-content">        &lt;button id="AT27_GG_run" class="ttb-btn ttb-primary" style="width:100%; background:#f4a3b9; border-color:#f4a3b9; color:#111; font-weight:700;"&gt;Ejecutar Consulta&lt;/button&gt;</td></tr><tr><td class="line-number" value="2181"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2182"></td><td class="line-content">        &lt;div id="AT27_GG_summary" style="margin-top:10px; font-size:13px; color:#334155;"&gt;&lt;/div&gt;</td></tr><tr><td class="line-number" value="2183"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2184"></td><td class="line-content">        &lt;div style="margin-top:10px; border:1px solid #f1f5f9; border-radius:10px; overflow:hidden;"&gt;</td></tr><tr><td class="line-number" value="2185"></td><td class="line-content">          &lt;table style="width:100%; border-collapse:collapse; font-size:13px;"&gt;</td></tr><tr><td class="line-number" value="2186"></td><td class="line-content">            &lt;thead style="background:#f8fafc;"&gt;</td></tr><tr><td class="line-number" value="2187"></td><td class="line-content">              &lt;tr&gt;</td></tr><tr><td class="line-number" value="2188"></td><td class="line-content">                &lt;th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;"&gt;Sección&lt;/th&gt;</td></tr><tr><td class="line-number" value="2189"></td><td class="line-content">                &lt;th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;"&gt;Partido Ganador&lt;/th&gt;</td></tr><tr><td class="line-number" value="2190"></td><td class="line-content">                &lt;th style="text-align:right; padding:8px; border-bottom:1px solid #e5e7eb;"&gt;Votos&lt;/th&gt;</td></tr><tr><td class="line-number" value="2191"></td><td class="line-content">                &lt;th style="text-align:right; padding:8px; border-bottom:1px solid #e5e7eb;"&gt;Faltan&lt;/th&gt;</td></tr><tr><td class="line-number" value="2192"></td><td class="line-content">              &lt;/tr&gt;</td></tr><tr><td class="line-number" value="2193"></td><td class="line-content">            &lt;/thead&gt;</td></tr><tr><td class="line-number" value="2194"></td><td class="line-content">            &lt;tbody id="AT27_GG_tbody"&gt;&lt;/tbody&gt;</td></tr><tr><td class="line-number" value="2195"></td><td class="line-content">          &lt;/table&gt;</td></tr><tr><td class="line-number" value="2196"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="2197"></td><td class="line-content">      &lt;/div&gt;</td></tr><tr><td class="line-number" value="2198"></td><td class="line-content">    `;</td></tr><tr><td class="line-number" value="2199"></td><td class="line-content">    document.body.appendChild(panel);</td></tr><tr><td class="line-number" value="2200"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2201"></td><td class="line-content">    function clampToViewport(el){</td></tr><tr><td class="line-number" value="2202"></td><td class="line-content">      const vw = window.innerWidth, vh = window.innerHeight;</td></tr><tr><td class="line-number" value="2203"></td><td class="line-content">      const r = el.getBoundingClientRect();</td></tr><tr><td class="line-number" value="2204"></td><td class="line-content">      let left = r.left, top = r.top;</td></tr><tr><td class="line-number" value="2205"></td><td class="line-content">      if (r.right  &gt; vw - 16) left -= (r.right  - (vw - 16));</td></tr><tr><td class="line-number" value="2206"></td><td class="line-content">      if (r.bottom &gt; vh - 16) top  -= (r.bottom - (vh - 16));</td></tr><tr><td class="line-number" value="2207"></td><td class="line-content">      if (left &lt; 16) left = 16;</td></tr><tr><td class="line-number" value="2208"></td><td class="line-content">      if (top  &lt; 16) top  = 16;</td></tr><tr><td class="line-number" value="2209"></td><td class="line-content">      el.style.left = left + 'px';</td></tr><tr><td class="line-number" value="2210"></td><td class="line-content">      el.style.top  = top  + 'px';</td></tr><tr><td class="line-number" value="2211"></td><td class="line-content">      el.style.right = 'auto';</td></tr><tr><td class="line-number" value="2212"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="2213"></td><td class="line-content">    clampToViewport(panel);</td></tr><tr><td class="line-number" value="2214"></td><td class="line-content">    window.addEventListener('resize', ()=&gt;clampToViewport(panel));</td></tr><tr><td class="line-number" value="2215"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2216"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2217"></td><td class="line-content">    panel.querySelector('#AT27_GG_close').onclick = ()=&gt;{ AT27_GG_clearOverlay(); panel.remove(); };</td></tr><tr><td class="line-number" value="2218"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2219"></td><td class="line-content">    // drag</td></tr><tr><td class="line-number" value="2220"></td><td class="line-content">    (function drag(panel, handle){</td></tr><tr><td class="line-number" value="2221"></td><td class="line-content">      let sx=0, sy=0, ox=0, oy=0, dragging=false;</td></tr><tr><td class="line-number" value="2222"></td><td class="line-content">      handle.addEventListener('mousedown', e=&gt;{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panel.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });</td></tr><tr><td class="line-number" value="2223"></td><td class="line-content">      window.addEventListener('mousemove', e=&gt;{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panel.style.left=(ox+dx)+'px'; panel.style.top=(oy+dy)+'px'; panel.style.right='auto'; });</td></tr><tr><td class="line-number" value="2224"></td><td class="line-content">      window.addEventListener('mouseup', ()=&gt;{ dragging=false; document.body.style.userSelect=''; });</td></tr><tr><td class="line-number" value="2225"></td><td class="line-content">    })(panel, panel.querySelector('#AT27_GG_hdr'));</td></tr><tr><td class="line-number" value="2226"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2227"></td><td class="line-content">    // listeners</td></tr><tr><td class="line-number" value="2228"></td><td class="line-content">    panel.querySelector('#AT27_GG_opacity').addEventListener('input', e=&gt;{ AT27_GT_GANAR_FILL = Number(e.target.value); AT27_GG_updateOpacity(); });</td></tr><tr><td class="line-number" value="2229"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2230"></td><td class="line-content">    return panel;</td></tr><tr><td class="line-number" value="2231"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="2232"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2233"></td><td class="line-content">    // ---------- Render tabla + resumen ----------</td></tr><tr><td class="line-number" value="2234"></td><td class="line-content">    function AT27_GG_renderTabla(perSec, partidoSel){</td></tr><tr><td class="line-number" value="2235"></td><td class="line-content">      const tb = document.getElementById('AT27_GG_tbody');</td></tr><tr><td class="line-number" value="2236"></td><td class="line-content">      const party = partidoSel.toUpperCase();</td></tr><tr><td class="line-number" value="2237"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2238"></td><td class="line-content">      const rows = Object.entries(perSec).map(([sec, info])=&gt;{</td></tr><tr><td class="line-number" value="2239"></td><td class="line-content">        return { sec: AT27_GG_sec(sec), winner: info.winner, vL: info.vL, faltan: Math.ceil(info.faltan) };</td></tr><tr><td class="line-number" value="2240"></td><td class="line-content">      }).sort((a,b)=&gt; (a.faltan - b.faltan) || (Number(a.sec) - Number(b.sec)));</td></tr><tr><td class="line-number" value="2241"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2242"></td><td class="line-content">      tb.innerHTML = rows.map(r=&gt;{</td></tr><tr><td class="line-number" value="2243"></td><td class="line-content">        const isWin  = (r.faltan&lt;=0 &amp;&amp; r.winner===party);</td></tr><tr><td class="line-number" value="2244"></td><td class="line-content">        const isLose = (r.winner!==party);</td></tr><tr><td class="line-number" value="2245"></td><td class="line-content">        const bg = isWin ? '#dcfce7' : (isLose ? '#fee2e2' : '');</td></tr><tr><td class="line-number" value="2246"></td><td class="line-content">        return `</td></tr><tr><td class="line-number" value="2247"></td><td class="line-content">          &lt;tr data-sec="${AT27_GG_sec(r.sec)}" style="${bg?`background:${bg};`:''} cursor:pointer;"&gt;</td></tr><tr><td class="line-number" value="2248"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;"&gt;${r.sec}&lt;/td&gt;</td></tr><tr><td class="line-number" value="2249"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;"&gt;${r.winner}&lt;/td&gt;</td></tr><tr><td class="line-number" value="2250"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;"&gt;${Math.round(r.vL).toLocaleString()}&lt;/td&gt;</td></tr><tr><td class="line-number" value="2251"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right; ${r.faltan&gt;0?'color:#dc2626;':''}"&gt;${r.faltan&gt;0 ? r.faltan.toLocaleString() : '0'}&lt;/td&gt;</td></tr><tr><td class="line-number" value="2252"></td><td class="line-content">          &lt;/tr&gt;</td></tr><tr><td class="line-number" value="2253"></td><td class="line-content">        `;</td></tr><tr><td class="line-number" value="2254"></td><td class="line-content">      }).join('');</td></tr><tr><td class="line-number" value="2255"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2256"></td><td class="line-content">      // Delegación: un solo listener, aunque repintes la tabla</td></tr><tr><td class="line-number" value="2257"></td><td class="line-content">      tb.onclick = (e)=&gt;{</td></tr><tr><td class="line-number" value="2258"></td><td class="line-content">        const tr = e.target.closest('tr[data-sec]');</td></tr><tr><td class="line-number" value="2259"></td><td class="line-content">        if (!tr) return;</td></tr><tr><td class="line-number" value="2260"></td><td class="line-content">        const sec = tr.getAttribute('data-sec');</td></tr><tr><td class="line-number" value="2261"></td><td class="line-content">        AT27_GG_focusSection(sec);</td></tr><tr><td class="line-number" value="2262"></td><td class="line-content">      };</td></tr><tr><td class="line-number" value="2263"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="2264"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2265"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2266"></td><td class="line-content">  function AT27_GG_renderResumen(resumen, partidoSel){</td></tr><tr><td class="line-number" value="2267"></td><td class="line-content">    const el = document.getElementById('AT27_GG_summary');</td></tr><tr><td class="line-number" value="2268"></td><td class="line-content">    el.innerHTML = `</td></tr><tr><td class="line-number" value="2269"></td><td class="line-content">      &lt;div&gt;&lt;b&gt;Partido:&lt;/b&gt; ${partidoSel}&lt;/div&gt;</td></tr><tr><td class="line-number" value="2270"></td><td class="line-content">      &lt;div style="display:flex; gap:12px; flex-wrap:wrap; margin-top:6px;"&gt;</td></tr><tr><td class="line-number" value="2271"></td><td class="line-content">        &lt;span&gt;Secciones ya ganadas: &lt;b&gt;${resumen.ganadas}&lt;/b&gt; / ${resumen.total}&lt;/span&gt;</td></tr><tr><td class="line-number" value="2272"></td><td class="line-content">        &lt;span&gt;Votos para ganar todo: &lt;b&gt;${resumen.votosTotalParaGanar.toLocaleString()}&lt;/b&gt;&lt;/span&gt;</td></tr><tr><td class="line-number" value="2273"></td><td class="line-content">        &lt;span&gt;Swing total (equivalente): &lt;b&gt;${resumen.swingTotal.toLocaleString()}&lt;/b&gt;&lt;/span&gt;</td></tr><tr><td class="line-number" value="2274"></td><td class="line-content">      &lt;/div&gt;</td></tr><tr><td class="line-number" value="2275"></td><td class="line-content">    `;</td></tr><tr><td class="line-number" value="2276"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="2277"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2278"></td><td class="line-content">  // ---------- Update (recalcular) ----------</td></tr><tr><td class="line-number" value="2279"></td><td class="line-content">  async function AT27_GG_run(){</td></tr><tr><td class="line-number" value="2280"></td><td class="line-content">    if (window.AT27_GG_STATE.running) return;</td></tr><tr><td class="line-number" value="2281"></td><td class="line-content">    window.AT27_GG_STATE.running = true;</td></tr><tr><td class="line-number" value="2282"></td><td class="line-content">    try{</td></tr><tr><td class="line-number" value="2283"></td><td class="line-content">      const panel   = AT27_GG_getOrCreatePanel();</td></tr><tr><td class="line-number" value="2284"></td><td class="line-content">      const puesto  = panel.querySelector('#AT27_GG_selPuesto').value;</td></tr><tr><td class="line-number" value="2285"></td><td class="line-content">      const partido = panel.querySelector('#AT27_GG_selPartido').value;</td></tr><tr><td class="line-number" value="2286"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2287"></td><td class="line-content">      const secIds = AT27_GG_getUniverseSecIds();</td></tr><tr><td class="line-number" value="2288"></td><td class="line-content">      if (!secIds.length){</td></tr><tr><td class="line-number" value="2289"></td><td class="line-content">        AT27_GG_clearOverlay();</td></tr><tr><td class="line-number" value="2290"></td><td class="line-content">        document.getElementById('AT27_GG_tbody').innerHTML = '';</td></tr><tr><td class="line-number" value="2291"></td><td class="line-content">        document.getElementById('AT27_GG_summary').innerHTML = 'Sin secciones en el universo actual.';</td></tr><tr><td class="line-number" value="2292"></td><td class="line-content">        return;</td></tr><tr><td class="line-number" value="2293"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="2294"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2295"></td><td class="line-content">      const js = await (window.loadPuesto ? loadPuesto(puesto) : getElectData(puesto));</td></tr><tr><td class="line-number" value="2296"></td><td class="line-content">      const { perSec, resumen } = AT27_GG_compute(js, secIds, puesto, partido);</td></tr><tr><td class="line-number" value="2297"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2298"></td><td class="line-content">      AT27_GG_buildOverlay(perSec);            // 1) pinta y reindexa</td></tr><tr><td class="line-number" value="2299"></td><td class="line-content">      AT27_GG_renderResumen(resumen, partido); // 2) resumen</td></tr><tr><td class="line-number" value="2300"></td><td class="line-content">      AT27_GG_renderTabla(perSec, partido);    // 3) tabla (usa índice ya listo)</td></tr><tr><td class="line-number" value="2301"></td><td class="line-content">    }catch(e){</td></tr><tr><td class="line-number" value="2302"></td><td class="line-content">      console.error('AT27_GG_run error:', e);</td></tr><tr><td class="line-number" value="2303"></td><td class="line-content">      alert('No pude ejecutar la consulta de Ganar Todo.');</td></tr><tr><td class="line-number" value="2304"></td><td class="line-content">    }finally{</td></tr><tr><td class="line-number" value="2305"></td><td class="line-content">      window.AT27_GG_STATE.running = false;</td></tr><tr><td class="line-number" value="2306"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="2307"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="2308"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2309"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2310"></td><td class="line-content">  // ---------- API pública ----------</td></tr><tr><td class="line-number" value="2311"></td><td class="line-content">  async function AT27_GT_GANAR_ejecutar(puestoInicial='A', partidoInicial='PAN'){</td></tr><tr><td class="line-number" value="2312"></td><td class="line-content">    const panel = AT27_GG_getOrCreatePanel();</td></tr><tr><td class="line-number" value="2313"></td><td class="line-content">    panel.querySelector('#AT27_GG_selPuesto').value  = puestoInicial;</td></tr><tr><td class="line-number" value="2314"></td><td class="line-content">    panel.querySelector('#AT27_GG_selPartido').value = partidoInicial;</td></tr><tr><td class="line-number" value="2315"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2316"></td><td class="line-content">    // Ejecuta SOLO al presionar el botón</td></tr><tr><td class="line-number" value="2317"></td><td class="line-content">    panel.querySelector('#AT27_GG_run').onclick = ()=&gt;{</td></tr><tr><td class="line-number" value="2318"></td><td class="line-content">      window.AT27_GG_STATE.autorun = true; // desde ahora, si cambias universo, recalc</td></tr><tr><td class="line-number" value="2319"></td><td class="line-content">      AT27_GG_run();</td></tr><tr><td class="line-number" value="2320"></td><td class="line-content">    };</td></tr><tr><td class="line-number" value="2321"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2322"></td><td class="line-content">    // Cambiar selects NO ejecuta automáticamente (tú decides con el botón)</td></tr><tr><td class="line-number" value="2323"></td><td class="line-content">    panel.querySelector('#AT27_GG_selPuesto').onchange  = ()=&gt;{};</td></tr><tr><td class="line-number" value="2324"></td><td class="line-content">    panel.querySelector('#AT27_GG_selPartido').onchange = ()=&gt;{};</td></tr><tr><td class="line-number" value="2325"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2326"></td><td class="line-content">    AT27_GG_bindUniverseAutoRecalc();</td></tr><tr><td class="line-number" value="2327"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="2328"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2329"></td><td class="line-content">  /* ======================= FIN · GANAR TODO / GANAR TODO ======================= */</td></tr><tr><td class="line-number" value="2330"></td><td class="line-content"><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="2331"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2332"></td><td class="line-content"><span class="html-tag">&lt;script&gt;</span></td></tr><tr><td class="line-number" value="2333"></td><td class="line-content">    // Centra el mapa al universo actual (overlay o capa base)</td></tr><tr><td class="line-number" value="2334"></td><td class="line-content">    function AT27_fitUniverseBounds(paddingPx = 24){</td></tr><tr><td class="line-number" value="2335"></td><td class="line-content">      const map = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="2336"></td><td class="line-content">      if (!map) return;</td></tr><tr><td class="line-number" value="2337"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2338"></td><td class="line-content">      // 1) Si hay overlay (ej. capas pintadas), úsalo</td></tr><tr><td class="line-number" value="2339"></td><td class="line-content">      const candidates = [];</td></tr><tr><td class="line-number" value="2340"></td><td class="line-content">      if (window.AT27_GG_LAYER?.getBounds) candidates.push(window.AT27_GG_LAYER.getBounds());</td></tr><tr><td class="line-number" value="2341"></td><td class="line-content">      if (window.AT27_EP_LAYER?.getBounds) candidates.push(window.AT27_EP_LAYER.getBounds()); // (si tienes Estabilidad)</td></tr><tr><td class="line-number" value="2342"></td><td class="line-content">      if (window.AT27_PART_LAYER?.getBounds) candidates.push(window.AT27_PART_LAYER.getBounds()); // (si tienes Participación)</td></tr><tr><td class="line-number" value="2343"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2344"></td><td class="line-content">      // 2) La capa de universo visible (AT_CTX.layer)</td></tr><tr><td class="line-number" value="2345"></td><td class="line-content">      const baseLayer = window.AT_CTX?.layer;</td></tr><tr><td class="line-number" value="2346"></td><td class="line-content">      if (baseLayer?.getBounds) candidates.push(baseLayer.getBounds());</td></tr><tr><td class="line-number" value="2347"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2348"></td><td class="line-content">      // 3) Fallback: calcula bounds desde GeoJSON de universo</td></tr><tr><td class="line-number" value="2349"></td><td class="line-content">      if (!candidates.length){</td></tr><tr><td class="line-number" value="2350"></td><td class="line-content">        const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];</td></tr><tr><td class="line-number" value="2351"></td><td class="line-content">        if (feats.length){</td></tr><tr><td class="line-number" value="2352"></td><td class="line-content">          const tmp = L.geoJSON({type:'FeatureCollection', features:feats});</td></tr><tr><td class="line-number" value="2353"></td><td class="line-content">          candidates.push(tmp.getBounds());</td></tr><tr><td class="line-number" value="2354"></td><td class="line-content">          // no añadimos tmp al mapa, solo usamos sus bounds</td></tr><tr><td class="line-number" value="2355"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="2356"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="2357"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2358"></td><td class="line-content">      // Unir bounds y centrar</td></tr><tr><td class="line-number" value="2359"></td><td class="line-content">      let union = null;</td></tr><tr><td class="line-number" value="2360"></td><td class="line-content">      for (const b of candidates){</td></tr><tr><td class="line-number" value="2361"></td><td class="line-content">        if (!b || !b.isValid()) continue;</td></tr><tr><td class="line-number" value="2362"></td><td class="line-content">        union = union ? union.extend(b) : L.latLngBounds(b.getSouthWest(), b.getNorthEast());</td></tr><tr><td class="line-number" value="2363"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="2364"></td><td class="line-content">      if (union &amp;&amp; union.isValid()){</td></tr><tr><td class="line-number" value="2365"></td><td class="line-content">        map.fitBounds(union, { padding:[paddingPx, paddingPx] });</td></tr><tr><td class="line-number" value="2366"></td><td class="line-content">        requestAnimationFrame(()=&gt; AT27_flashOverlay());</td></tr><tr><td class="line-number" value="2367"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2368"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="2369"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="2370"></td><td class="line-content"><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="2371"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2372"></td><td class="line-content">  <span class="html-tag">&lt;script&gt;</span></td></tr><tr><td class="line-number" value="2373"></td><td class="line-content">  function AT27__eachPath(layer, fn){</td></tr><tr><td class="line-number" value="2374"></td><td class="line-content">    if (!layer) return;</td></tr><tr><td class="line-number" value="2375"></td><td class="line-content">    if (layer.eachLayer) layer.eachLayer(l =&gt; AT27__eachPath(l, fn));</td></tr><tr><td class="line-number" value="2376"></td><td class="line-content">    else if (layer.setStyle) fn(layer);</td></tr><tr><td class="line-number" value="2377"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="2378"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2379"></td><td class="line-content">  // Resalta brevemente los polígonos del overlay (o la capa base si no hay overlay)</td></tr><tr><td class="line-number" value="2380"></td><td class="line-content">  function AT27_flashOverlay(duration=900){</td></tr><tr><td class="line-number" value="2381"></td><td class="line-content">    const overlays = [</td></tr><tr><td class="line-number" value="2382"></td><td class="line-content">      window.AT27_GG_LAYER,   // Ganar Todo</td></tr><tr><td class="line-number" value="2383"></td><td class="line-content">      window.AT27_EP_LAYER,   // Estabilidad (si la tienes)</td></tr><tr><td class="line-number" value="2384"></td><td class="line-content">      window.AT27_PART_LAYER  // Participación (si la tienes)</td></tr><tr><td class="line-number" value="2385"></td><td class="line-content">    ].filter(Boolean);</td></tr><tr><td class="line-number" value="2386"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2387"></td><td class="line-content">    // Si no hay overlay, “flashea” el universo base</td></tr><tr><td class="line-number" value="2388"></td><td class="line-content">    if (!overlays.length &amp;&amp; window.AT_CTX?.layer) overlays.push(window.AT_CTX.layer);</td></tr><tr><td class="line-number" value="2389"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2390"></td><td class="line-content">    overlays.forEach(g=&gt;{</td></tr><tr><td class="line-number" value="2391"></td><td class="line-content">      AT27__eachPath(g, (lyr)=&gt;{</td></tr><tr><td class="line-number" value="2392"></td><td class="line-content">        const origW  = (lyr.options &amp;&amp; lyr.options.weight) || 1;</td></tr><tr><td class="line-number" value="2393"></td><td class="line-content">        const origFO = (lyr.options &amp;&amp; typeof lyr.options.fillOpacity==='number') ? lyr.options.fillOpacity : 0.35;</td></tr><tr><td class="line-number" value="2394"></td><td class="line-content">        try{</td></tr><tr><td class="line-number" value="2395"></td><td class="line-content">          lyr.setStyle({ weight: origW + 2, fillOpacity: Math.min(0.95, origFO + 0.25) });</td></tr><tr><td class="line-number" value="2396"></td><td class="line-content">          setTimeout(()=&gt; lyr.setStyle({ weight: origW, fillOpacity: origFO }), duration);</td></tr><tr><td class="line-number" value="2397"></td><td class="line-content">        }catch(_){}</td></tr><tr><td class="line-number" value="2398"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="2399"></td><td class="line-content">    });</td></tr><tr><td class="line-number" value="2400"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="2401"></td><td class="line-content"><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="2402"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2403"></td><td class="line-content"><span class="html-tag">&lt;script&gt;</span></td></tr><tr><td class="line-number" value="2404"></td><td class="line-content">    // =======================================================</td></tr><tr><td class="line-number" value="2405"></td><td class="line-content">    //  GENIALIDAD #1  · PROBABILIDAD DE VOLTEAR 2027</td></tr><tr><td class="line-number" value="2406"></td><td class="line-content">    //  Panel con pesos (margen 2024, tendencia de participación, estabilidad),</td></tr><tr><td class="line-number" value="2407"></td><td class="line-content">    //  mapa verde/amarillo/rojo por puntaje, tabla ordenable y clic→zoom.</td></tr><tr><td class="line-number" value="2408"></td><td class="line-content">    //  Requiere: loadPuesto(puesto) o getElectData(puesto), AT_CTX.map/layer</td></tr><tr><td class="line-number" value="2409"></td><td class="line-content">    //  y (si existe) AT27_GG_getUniverseSecIds(). Colores partidos estándar.</td></tr><tr><td class="line-number" value="2410"></td><td class="line-content">    // =======================================================</td></tr><tr><td class="line-number" value="2411"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2412"></td><td class="line-content">    /* ====== Estado y constantes ====== */</td></tr><tr><td class="line-number" value="2413"></td><td class="line-content">    window.AT27_PV_STATE  = window.AT27_PV_STATE  || { autorun:false, running:false };</td></tr><tr><td class="line-number" value="2414"></td><td class="line-content">    window.AT27_PV_LAYERS = window.AT27_PV_LAYERS || {};   // sec -&gt; layer</td></tr><tr><td class="line-number" value="2415"></td><td class="line-content">    window.AT27_PV_LAYER  = window.AT27_PV_LAYER  || null;</td></tr><tr><td class="line-number" value="2416"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2417"></td><td class="line-content">    const AT27_PV_COLORS = { ALTA:'#22c55e', MEDIA:'#f59e0b', BAJA:'#ef4444' }; // verde, amarillo, rojo</td></tr><tr><td class="line-number" value="2418"></td><td class="line-content">    const AT27_PARTY_COLORS = { PAN:'#2563eb', PRI:'#ef4444', PVEM:'#16a34a', MORENA:'#7f1d1d', OTROS:'#6b7280' };</td></tr><tr><td class="line-number" value="2419"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2420"></td><td class="line-content">    /* ====== Utilidades ====== */</td></tr><tr><td class="line-number" value="2421"></td><td class="line-content">    const clamp = (x, a, b)=&gt; Math.min(b, Math.max(a, x));</td></tr><tr><td class="line-number" value="2422"></td><td class="line-content">    const fmtpp = (x)=&gt;{</td></tr><tr><td class="line-number" value="2423"></td><td class="line-content">            if (x === null || x === undefined) return '—';</td></tr><tr><td class="line-number" value="2424"></td><td class="line-content">            const n = Number(x);</td></tr><tr><td class="line-number" value="2425"></td><td class="line-content">            return Number.isFinite(n) ? ((n&gt;0?'+':'') + n.toFixed(1) + ' pp') : '—';</td></tr><tr><td class="line-number" value="2426"></td><td class="line-content">          };</td></tr><tr><td class="line-number" value="2427"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2428"></td><td class="line-content">    const fmt   = (x)=&gt; isFinite(x)? Math.round(x).toLocaleString() : '—';</td></tr><tr><td class="line-number" value="2429"></td><td class="line-content">    const sec4  = (s)=&gt; String(s||'').replace(/\D+/g,'').padStart(4,'0');</td></tr><tr><td class="line-number" value="2430"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2431"></td><td class="line-content">    function AT27_PV_getUniverseSecIds(){</td></tr><tr><td class="line-number" value="2432"></td><td class="line-content">      if (typeof AT27_GG_getUniverseSecIds==='function') return AT27_GG_getUniverseSecIds();</td></tr><tr><td class="line-number" value="2433"></td><td class="line-content">      const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];</td></tr><tr><td class="line-number" value="2434"></td><td class="line-content">      return feats.map(f=&gt; sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id));</td></tr><tr><td class="line-number" value="2435"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="2436"></td><td class="line-content">    async function AT27_PV_load(p){ return (window.loadPuesto? loadPuesto(p) : getElectData(p)); }</td></tr><tr><td class="line-number" value="2437"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2438"></td><td class="line-content">    /* ====== Métricas ====== */</td></tr><tr><td class="line-number" value="2439"></td><td class="line-content">    // participación (%) del año (usa VV / LN). Si falta VOTOS, suma partidos.</td></tr><tr><td class="line-number" value="2440"></td><td class="line-content">    function partPct(row){</td></tr><tr><td class="line-number" value="2441"></td><td class="line-content">      if (!row) return null;</td></tr><tr><td class="line-number" value="2442"></td><td class="line-content">      const ln = Number(row.LN||0); if (!ln) return null;</td></tr><tr><td class="line-number" value="2443"></td><td class="line-content">      let vv = (row.VOTOS!=null)? Number(row.VOTOS||0) : 0;</td></tr><tr><td class="line-number" value="2444"></td><td class="line-content">      if (row.VOTOS==null){ for (const [k,v] of Object.entries(row)){ if (k!=='LN' &amp;&amp; k!=='VOTOS') vv += Number(v||0); } }</td></tr><tr><td class="line-number" value="2445"></td><td class="line-content">      return clamp((vv/ln)*100, 0, 100);</td></tr><tr><td class="line-number" value="2446"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="2447"></td><td class="line-content">    // margen vs PARTIDO en 2024, en puntos porcentuales (líder − partido)</td></tr><tr><td class="line-number" value="2448"></td><td class="line-content">    function marginVsPartyPP(row24, partido){</td></tr><tr><td class="line-number" value="2449"></td><td class="line-content">      if (!row24) return null;</td></tr><tr><td class="line-number" value="2450"></td><td class="line-content">      let vv = (row24.VOTOS!=null)? Number(row24.VOTOS||0) : 0;</td></tr><tr><td class="line-number" value="2451"></td><td class="line-content">      if (row24.VOTOS==null){ for (const [k,v] of Object.entries(row24)){ if (k!=='LN' &amp;&amp; k!=='VOTOS') vv += Number(v||0); } }</td></tr><tr><td class="line-number" value="2452"></td><td class="line-content">      const votes = {};</td></tr><tr><td class="line-number" value="2453"></td><td class="line-content">      for (const [k,v] of Object.entries(row24)){</td></tr><tr><td class="line-number" value="2454"></td><td class="line-content">        if (k==='LN'||k==='VOTOS') continue;</td></tr><tr><td class="line-number" value="2455"></td><td class="line-content">        votes[k.toUpperCase()] = Number(v||0);</td></tr><tr><td class="line-number" value="2456"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="2457"></td><td class="line-content">      const vX = votes[partido] || 0;</td></tr><tr><td class="line-number" value="2458"></td><td class="line-content">      let vL = -1, L=null;</td></tr><tr><td class="line-number" value="2459"></td><td class="line-content">      for (const [sig, val] of Object.entries(votes)){ if (val&gt;vL){ vL=val; L=sig; } }</td></tr><tr><td class="line-number" value="2460"></td><td class="line-content">      if (vv&lt;=0) return null;</td></tr><tr><td class="line-number" value="2461"></td><td class="line-content">      return ((vL - vX) / vv) * 100; // puede ser 0 si ya gana ese partido</td></tr><tr><td class="line-number" value="2462"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="2463"></td><td class="line-content">    // estabilidad 2018-2024: devuelve categoría y score invertido (0/50/100)</td></tr><tr><td class="line-number" value="2464"></td><td class="line-content">    function stabilityCat(slot){</td></tr><tr><td class="line-number" value="2465"></td><td class="line-content">      const g = ['2018','2021','2024'].map(y=&gt;{</td></tr><tr><td class="line-number" value="2466"></td><td class="line-content">        const row = slot?.[y]; if (!row) return null;</td></tr><tr><td class="line-number" value="2467"></td><td class="line-content">        // ganador por votos  (si falta VOTOS se suma)</td></tr><tr><td class="line-number" value="2468"></td><td class="line-content">        let vv = (row.VOTOS!=null)? Number(row.VOTOS||0) : 0;</td></tr><tr><td class="line-number" value="2469"></td><td class="line-content">        if (row.VOTOS==null){ for (const [k,v] of Object.entries(row)){ if (k!=='LN' &amp;&amp; k!=='VOTOS') vv += Number(v||0); } }</td></tr><tr><td class="line-number" value="2470"></td><td class="line-content">        let vL = -1, L=null;</td></tr><tr><td class="line-number" value="2471"></td><td class="line-content">        for (const [k,v] of Object.entries(row)){</td></tr><tr><td class="line-number" value="2472"></td><td class="line-content">          if (k==='LN'||k==='VOTOS') continue;</td></tr><tr><td class="line-number" value="2473"></td><td class="line-content">          const z = Number(v||0);</td></tr><tr><td class="line-number" value="2474"></td><td class="line-content">          if (z&gt;vL){ vL=z; L=k.toUpperCase(); }</td></tr><tr><td class="line-number" value="2475"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="2476"></td><td class="line-content">        return L;</td></tr><tr><td class="line-number" value="2477"></td><td class="line-content">      }).filter(Boolean);</td></tr><tr><td class="line-number" value="2478"></td><td class="line-content">      const uniq = Array.from(new Set(g)).length;</td></tr><tr><td class="line-number" value="2479"></td><td class="line-content">      if (uniq&lt;=1) return { cat:'Alta',  invScore:0 };</td></tr><tr><td class="line-number" value="2480"></td><td class="line-content">      if (uniq==2) return { cat:'Media', invScore:50 };</td></tr><tr><td class="line-number" value="2481"></td><td class="line-content">      return { cat:'Baja', invScore:100 };</td></tr><tr><td class="line-number" value="2482"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="2483"></td><td class="line-content">    // normaliza Δ participación 18→24 a 0..100 (−15→0, 0→50, +15→100)</td></tr><tr><td class="line-number" value="2484"></td><td class="line-content">    function trendScore(slot){</td></tr><tr><td class="line-number" value="2485"></td><td class="line-content">      const p18 = partPct(slot?.['2018']);</td></tr><tr><td class="line-number" value="2486"></td><td class="line-content">      const p24 = partPct(slot?.['2024']);</td></tr><tr><td class="line-number" value="2487"></td><td class="line-content">      if (p18==null || p24==null) return 50; // neutro si faltan datos</td></tr><tr><td class="line-number" value="2488"></td><td class="line-content">      const delta = clamp(p24 - p18, -15, 15);</td></tr><tr><td class="line-number" value="2489"></td><td class="line-content">      return ((delta + 15) / 30) * 100;</td></tr><tr><td class="line-number" value="2490"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="2491"></td><td class="line-content">    // score de “volteabilidad” (0..100): margen invertido, tendencia, inestabilidad</td></tr><tr><td class="line-number" value="2492"></td><td class="line-content">    function flipScore(slot, partido){</td></tr><tr><td class="line-number" value="2493"></td><td class="line-content">      const row24 = slot?.['2024'];</td></tr><tr><td class="line-number" value="2494"></td><td class="line-content">      const mpp = marginVsPartyPP(row24, partido);           // pp contra el líder</td></tr><tr><td class="line-number" value="2495"></td><td class="line-content">      const stab = stabilityCat(slot);                       // Alta/Media/Baja</td></tr><tr><td class="line-number" value="2496"></td><td class="line-content">      const tsc = trendScore(slot);                          // 0..100</td></tr><tr><td class="line-number" value="2497"></td><td class="line-content">      // margen invertido: 0pp →100; 20+pp →0</td></tr><tr><td class="line-number" value="2498"></td><td class="line-content">      const mInv = (mpp==null)? 50 : clamp( (20 - clamp(mpp,0,20)) / 20 * 100, 0, 100 );</td></tr><tr><td class="line-number" value="2499"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2500"></td><td class="line-content">      // pesos desde UI</td></tr><tr><td class="line-number" value="2501"></td><td class="line-content">      const w1 = Number(document.getElementById('AT27_PV_w_margen')?.value || 50);</td></tr><tr><td class="line-number" value="2502"></td><td class="line-content">      const w2 = Number(document.getElementById('AT27_PV_w_trend')?.value  || 30);</td></tr><tr><td class="line-number" value="2503"></td><td class="line-content">      const w3 = Number(document.getElementById('AT27_PV_w_stab')?.value   || 20);</td></tr><tr><td class="line-number" value="2504"></td><td class="line-content">      const W  = (w1+w2+w3) || 1;</td></tr><tr><td class="line-number" value="2505"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2506"></td><td class="line-content">      const score = (w1*mInv + w2*tsc + w3*stab.invScore) / W;</td></tr><tr><td class="line-number" value="2507"></td><td class="line-content">      return { score, mpp, trend: (partPct(slot?.['2024'])??0) - (partPct(slot?.['2018'])??0), stabCat: stab.cat };</td></tr><tr><td class="line-number" value="2508"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="2509"></td><td class="line-content">    function classFromScore(s){ return s&gt;=70? 'ALTA' : (s&gt;=40? 'MEDIA' : 'BAJA'); }</td></tr><tr><td class="line-number" value="2510"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2511"></td><td class="line-content">    /* ====== Overlay ====== */</td></tr><tr><td class="line-number" value="2512"></td><td class="line-content">    function AT27_PV_clear(){</td></tr><tr><td class="line-number" value="2513"></td><td class="line-content">      const map = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="2514"></td><td class="line-content">      if (!map) return;</td></tr><tr><td class="line-number" value="2515"></td><td class="line-content">      if (window.AT27_PV_LAYER){ try{ map.removeLayer(AT27_PV_LAYER); }catch(_){} window.AT27_PV_LAYER=null; }</td></tr><tr><td class="line-number" value="2516"></td><td class="line-content">      window.AT27_PV_LAYERS = {};</td></tr><tr><td class="line-number" value="2517"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="2518"></td><td class="line-content">    function AT27_PV_build(perSec, partido){</td></tr><tr><td class="line-number" value="2519"></td><td class="line-content">      const map  = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="2520"></td><td class="line-content">      const base = window.AT_CTX?.layer?.toGeoJSON?.() || window.AT_DATA;</td></tr><tr><td class="line-number" value="2521"></td><td class="line-content">      if (!map || !base?.features) return;</td></tr><tr><td class="line-number" value="2522"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2523"></td><td class="line-content">      AT27_PV_clear();</td></tr><tr><td class="line-number" value="2524"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2525"></td><td class="line-content">      if (map.createPane &amp;&amp; !map.getPane('at27_pv_pane')){</td></tr><tr><td class="line-number" value="2526"></td><td class="line-content">        map.createPane('at27_pv_pane');</td></tr><tr><td class="line-number" value="2527"></td><td class="line-content">        const p = map.getPane('at27_pv_pane');</td></tr><tr><td class="line-number" value="2528"></td><td class="line-content">        p.style.zIndex = 680; p.style.pointerEvents='auto';</td></tr><tr><td class="line-number" value="2529"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="2530"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2531"></td><td class="line-content">      const features = base.features.filter(f=&gt;{</td></tr><tr><td class="line-number" value="2532"></td><td class="line-content">        const id = sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);</td></tr><tr><td class="line-number" value="2533"></td><td class="line-content">        return perSec[id]!=null;</td></tr><tr><td class="line-number" value="2534"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="2535"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2536"></td><td class="line-content">      const layer = L.geoJSON({type:'FeatureCollection', features}, {</td></tr><tr><td class="line-number" value="2537"></td><td class="line-content">        pane:'at27_pv_pane',</td></tr><tr><td class="line-number" value="2538"></td><td class="line-content">        style: f=&gt;{</td></tr><tr><td class="line-number" value="2539"></td><td class="line-content">          const id = sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);</td></tr><tr><td class="line-number" value="2540"></td><td class="line-content">          const cls = perSec[id]?.cls || 'BAJA';</td></tr><tr><td class="line-number" value="2541"></td><td class="line-content">          const col = AT27_PV_COLORS[cls] || '#999';</td></tr><tr><td class="line-number" value="2542"></td><td class="line-content">          return { color: col, weight:1, opacity:.9, fillColor: col, fillOpacity:.35 };</td></tr><tr><td class="line-number" value="2543"></td><td class="line-content">        },</td></tr><tr><td class="line-number" value="2544"></td><td class="line-content">        onEachFeature: (feature, lyr)=&gt;{</td></tr><tr><td class="line-number" value="2545"></td><td class="line-content">          const id = sec4(feature.properties?.ID ?? feature.properties?.SECCION ?? feature.properties?.id);</td></tr><tr><td class="line-number" value="2546"></td><td class="line-content">          window.AT27_PV_LAYERS[id] = lyr;</td></tr><tr><td class="line-number" value="2547"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2548"></td><td class="line-content">          const info = perSec[id]; if (!info) return;</td></tr><tr><td class="line-number" value="2549"></td><td class="line-content">          const tip = `</td></tr><tr><td class="line-number" value="2550"></td><td class="line-content">            &lt;div style="font-size:12px;"&gt;</td></tr><tr><td class="line-number" value="2551"></td><td class="line-content">              Sección &lt;b&gt;${id}&lt;/b&gt;&lt;br&gt;</td></tr><tr><td class="line-number" value="2552"></td><td class="line-content">              Partido analizado: &lt;b&gt;${partido}&lt;/b&gt;&lt;br&gt;</td></tr><tr><td class="line-number" value="2553"></td><td class="line-content">              Margen vs ${partido} (2024): &lt;b&gt;${fmtpp(info.mpp)}&lt;/b&gt;&lt;br&gt;</td></tr><tr><td class="line-number" value="2554"></td><td class="line-content">              Δ participación 2018→2024: &lt;b&gt;${fmtpp(info.trend)}&lt;/b&gt;&lt;br&gt;</td></tr><tr><td class="line-number" value="2555"></td><td class="line-content">              Estabilidad: &lt;b&gt;${info.stabCat}&lt;/b&gt;&lt;br&gt;</td></tr><tr><td class="line-number" value="2556"></td><td class="line-content">              &lt;span style="opacity:.8"&gt;Puntaje:&lt;/span&gt; &lt;b&gt;${info.score.toFixed(0)}/100&lt;/b&gt;</td></tr><tr><td class="line-number" value="2557"></td><td class="line-content">            &lt;/div&gt;`;</td></tr><tr><td class="line-number" value="2558"></td><td class="line-content">          lyr.bindTooltip(tip, {sticky:true, opacity:.95, direction:'top', className:'at27-tt'});</td></tr><tr><td class="line-number" value="2559"></td><td class="line-content">          lyr.on('mouseover', ()=&gt;lyr.setStyle({weight:2}));</td></tr><tr><td class="line-number" value="2560"></td><td class="line-content">          lyr.on('mouseout',  ()=&gt;lyr.setStyle({weight:1}));</td></tr><tr><td class="line-number" value="2561"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="2562"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="2563"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2564"></td><td class="line-content">      layer.addTo(map);</td></tr><tr><td class="line-number" value="2565"></td><td class="line-content">      window.AT27_PV_LAYER = layer;</td></tr><tr><td class="line-number" value="2566"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="2567"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2568"></td><td class="line-content">    /* ====== Tabla y resumen ====== */</td></tr><tr><td class="line-number" value="2569"></td><td class="line-content">    function AT27_PV_renderTabla(perSec){</td></tr><tr><td class="line-number" value="2570"></td><td class="line-content">      const tb = document.getElementById('AT27_PV_tbody');</td></tr><tr><td class="line-number" value="2571"></td><td class="line-content">      const rows = Object.entries(perSec).map(([sec,info])=&gt;({sec, ...info}))</td></tr><tr><td class="line-number" value="2572"></td><td class="line-content">        .sort((a,b)=&gt; b.score - a.score || Number(a.sec)-Number(b.sec));</td></tr><tr><td class="line-number" value="2573"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2574"></td><td class="line-content">      tb.innerHTML = rows.map(r=&gt;{</td></tr><tr><td class="line-number" value="2575"></td><td class="line-content">        const bg = r.cls==='ALTA' ? '#dcfce7' : (r.cls==='MEDIA' ? '#fef9c3' : '#fee2e2');</td></tr><tr><td class="line-number" value="2576"></td><td class="line-content">        return `</td></tr><tr><td class="line-number" value="2577"></td><td class="line-content">          &lt;tr data-sec="${r.sec}" style="background:${bg}; cursor:pointer;"&gt;</td></tr><tr><td class="line-number" value="2578"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;"&gt;${r.sec}&lt;/td&gt;</td></tr><tr><td class="line-number" value="2579"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;"&gt;${Number.isFinite(r.score) ? r.score.toFixed(0) : '—'}&lt;/td&gt;</td></tr><tr><td class="line-number" value="2580"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;"&gt;${r.cls}&lt;/td&gt;</td></tr><tr><td class="line-number" value="2581"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;"&gt;${fmtpp(r.mpp)}&lt;/td&gt;</td></tr><tr><td class="line-number" value="2582"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;"&gt;${fmtpp(r.trend)}&lt;/td&gt;</td></tr><tr><td class="line-number" value="2583"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;"&gt;${r.stabCat}&lt;/td&gt;</td></tr><tr><td class="line-number" value="2584"></td><td class="line-content">          &lt;/tr&gt;</td></tr><tr><td class="line-number" value="2585"></td><td class="line-content">        `;</td></tr><tr><td class="line-number" value="2586"></td><td class="line-content">      }).join('');</td></tr><tr><td class="line-number" value="2587"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2588"></td><td class="line-content">      tb.onclick = (e)=&gt;{</td></tr><tr><td class="line-number" value="2589"></td><td class="line-content">        const tr = e.target.closest('tr[data-sec]'); if (!tr) return;</td></tr><tr><td class="line-number" value="2590"></td><td class="line-content">        AT27_PV_focus(tr.getAttribute('data-sec'));</td></tr><tr><td class="line-number" value="2591"></td><td class="line-content">      };</td></tr><tr><td class="line-number" value="2592"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="2593"></td><td class="line-content">    function AT27_PV_focus(sec){</td></tr><tr><td class="line-number" value="2594"></td><td class="line-content">      const id = sec4(sec);</td></tr><tr><td class="line-number" value="2595"></td><td class="line-content">      const lyr = window.AT27_PV_LAYERS[id];</td></tr><tr><td class="line-number" value="2596"></td><td class="line-content">      const map = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="2597"></td><td class="line-content">      if (!map) return;</td></tr><tr><td class="line-number" value="2598"></td><td class="line-content">      if (lyr){</td></tr><tr><td class="line-number" value="2599"></td><td class="line-content">        try{ map.fitBounds(lyr.getBounds(), {maxZoom:16, padding:[20,20]}); }catch(_){}</td></tr><tr><td class="line-number" value="2600"></td><td class="line-content">        if (lyr.openTooltip) lyr.openTooltip();</td></tr><tr><td class="line-number" value="2601"></td><td class="line-content">        const origFO = lyr.options.fillOpacity ?? .35;</td></tr><tr><td class="line-number" value="2602"></td><td class="line-content">        lyr.setStyle({weight:3, fillOpacity: Math.min(.95, origFO+.25)});</td></tr><tr><td class="line-number" value="2603"></td><td class="line-content">        setTimeout(()=&gt; lyr.setStyle({weight:1, fillOpacity: origFO}), 900);</td></tr><tr><td class="line-number" value="2604"></td><td class="line-content">        return;</td></tr><tr><td class="line-number" value="2605"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="2606"></td><td class="line-content">      // fallback: por si no está indexado</td></tr><tr><td class="line-number" value="2607"></td><td class="line-content">      const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];</td></tr><tr><td class="line-number" value="2608"></td><td class="line-content">      const f = feats.find(ft=&gt; sec4(ft.properties?.ID ?? ft.properties?.SECCION ?? ft.properties?.id)===id);</td></tr><tr><td class="line-number" value="2609"></td><td class="line-content">      if (f){ const tmp=L.geoJSON(f); map.fitBounds(tmp.getBounds(), {maxZoom:16, padding:[20,20]}); }</td></tr><tr><td class="line-number" value="2610"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="2611"></td><td class="line-content">    function AT27_PV_renderResumen(counts, total){</td></tr><tr><td class="line-number" value="2612"></td><td class="line-content">      const el = document.getElementById('AT27_PV_summary');</td></tr><tr><td class="line-number" value="2613"></td><td class="line-content">      const pct = (n)=&gt; total? ((n/total)*100).toFixed(1)+'%' : '—';</td></tr><tr><td class="line-number" value="2614"></td><td class="line-content">      el.innerHTML = `</td></tr><tr><td class="line-number" value="2615"></td><td class="line-content">        &lt;div style="font-size:12px; line-height:1.3;"&gt;</td></tr><tr><td class="line-number" value="2616"></td><td class="line-content">          &lt;div&gt;&lt;span style="display:inline-block;width:10px;height:10px;background:${AT27_PV_COLORS.ALTA};border-radius:2px;"&gt;&lt;/span&gt; Alta: &lt;b&gt;${counts.ALTA}&lt;/b&gt; (${pct(counts.ALTA)})&lt;/div&gt;</td></tr><tr><td class="line-number" value="2617"></td><td class="line-content">          &lt;div&gt;&lt;span style="display:inline-block;width:10px;height:10px;background:${AT27_PV_COLORS.MEDIA};border-radius:2px;"&gt;&lt;/span&gt; Media: &lt;b&gt;${counts.MEDIA}&lt;/b&gt; (${pct(counts.MEDIA)})&lt;/div&gt;</td></tr><tr><td class="line-number" value="2618"></td><td class="line-content">          &lt;div&gt;&lt;span style="display:inline-block;width:10px;height:10px;background:${AT27_PV_COLORS.BAJA};border-radius:2px;"&gt;&lt;/span&gt; Baja: &lt;b&gt;${counts.BAJA}&lt;/b&gt; (${pct(counts.BAJA)})&lt;/div&gt;</td></tr><tr><td class="line-number" value="2619"></td><td class="line-content">          &lt;div style="margin-top:6px;"&gt;&lt;b&gt;Total secciones:&lt;/b&gt; ${total}&lt;/div&gt;</td></tr><tr><td class="line-number" value="2620"></td><td class="line-content">        &lt;/div&gt;`;</td></tr><tr><td class="line-number" value="2621"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="2622"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2623"></td><td class="line-content">    /* ====== RUN principal ====== */</td></tr><tr><td class="line-number" value="2624"></td><td class="line-content">    async function AT27_PV_run(){</td></tr><tr><td class="line-number" value="2625"></td><td class="line-content">      if (window.AT27_PV_STATE.running) return;</td></tr><tr><td class="line-number" value="2626"></td><td class="line-content">      window.AT27_PV_STATE.running = true;</td></tr><tr><td class="line-number" value="2627"></td><td class="line-content">      try{</td></tr><tr><td class="line-number" value="2628"></td><td class="line-content">        const puesto  = document.getElementById('AT27_PV_selPuesto').value;</td></tr><tr><td class="line-number" value="2629"></td><td class="line-content">        const partido = document.getElementById('AT27_PV_selPartido').value.toUpperCase();</td></tr><tr><td class="line-number" value="2630"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2631"></td><td class="line-content">        const secIds = AT27_PV_getUniverseSecIds();</td></tr><tr><td class="line-number" value="2632"></td><td class="line-content">        if (!secIds.length){ AT27_PV_clear(); document.getElementById('AT27_PV_tbody').innerHTML=''; return; }</td></tr><tr><td class="line-number" value="2633"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2634"></td><td class="line-content">        const js = await AT27_PV_load(puesto);</td></tr><tr><td class="line-number" value="2635"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2636"></td><td class="line-content">        const perSec = {};</td></tr><tr><td class="line-number" value="2637"></td><td class="line-content">        for (const sec of secIds){</td></tr><tr><td class="line-number" value="2638"></td><td class="line-content">          const slot = js?.secciones?.[sec4(sec)];</td></tr><tr><td class="line-number" value="2639"></td><td class="line-content">          if (!slot) continue;</td></tr><tr><td class="line-number" value="2640"></td><td class="line-content">          const met = flipScore(slot, partido); // {score, mpp, trend, stabCat}</td></tr><tr><td class="line-number" value="2641"></td><td class="line-content">          const cls = classFromScore(met.score);</td></tr><tr><td class="line-number" value="2642"></td><td class="line-content">          perSec[sec4(sec)] = { ...met, cls };</td></tr><tr><td class="line-number" value="2643"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="2644"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2645"></td><td class="line-content">        // contar</td></tr><tr><td class="line-number" value="2646"></td><td class="line-content">        const total = Object.keys(perSec).length;</td></tr><tr><td class="line-number" value="2647"></td><td class="line-content">        const counts = { ALTA:0, MEDIA:0, BAJA:0 };</td></tr><tr><td class="line-number" value="2648"></td><td class="line-content">        Object.values(perSec).forEach(x=&gt; counts[x.cls]++);</td></tr><tr><td class="line-number" value="2649"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2650"></td><td class="line-content">        // pintar</td></tr><tr><td class="line-number" value="2651"></td><td class="line-content">        AT27_PV_build(perSec, partido);</td></tr><tr><td class="line-number" value="2652"></td><td class="line-content">        AT27_PV_renderResumen(counts, total);</td></tr><tr><td class="line-number" value="2653"></td><td class="line-content">        AT27_PV_renderTabla(perSec);</td></tr><tr><td class="line-number" value="2654"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2655"></td><td class="line-content">      }catch(e){</td></tr><tr><td class="line-number" value="2656"></td><td class="line-content">        console.error('AT27_PV_run', e);</td></tr><tr><td class="line-number" value="2657"></td><td class="line-content">        alert('No pude ejecutar “Probabilidad de voltear 2027”.');</td></tr><tr><td class="line-number" value="2658"></td><td class="line-content">      }finally{</td></tr><tr><td class="line-number" value="2659"></td><td class="line-content">        window.AT27_PV_STATE.running = false;</td></tr><tr><td class="line-number" value="2660"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="2661"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="2662"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2663"></td><td class="line-content">    /* ====== Panel UI ====== */</td></tr><tr><td class="line-number" value="2664"></td><td class="line-content">    function AT27_PV_open(){</td></tr><tr><td class="line-number" value="2665"></td><td class="line-content">      let panel = document.getElementById('AT27_PV_panel');</td></tr><tr><td class="line-number" value="2666"></td><td class="line-content">      if (panel){ panel.style.display='block'; return; }</td></tr><tr><td class="line-number" value="2667"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2668"></td><td class="line-content">      panel = document.createElement('div');</td></tr><tr><td class="line-number" value="2669"></td><td class="line-content">      panel.id = 'AT27_PV_panel';</td></tr><tr><td class="line-number" value="2670"></td><td class="line-content">      Object.assign(panel.style,{</td></tr><tr><td class="line-number" value="2671"></td><td class="line-content">        position:'fixed', right:'20px', top:'20px', zIndex:9998,</td></tr><tr><td class="line-number" value="2672"></td><td class="line-content">        width:'520px', maxWidth:'calc(100vw - 40px)', maxHeight:'calc(100vh - 40px)',</td></tr><tr><td class="line-number" value="2673"></td><td class="line-content">        background:'#fff', border:'1px solid #e5e7eb', borderRadius:'14px',</td></tr><tr><td class="line-number" value="2674"></td><td class="line-content">        boxShadow:'0 18px 40px rgba(0,0,0,.18)', display:'flex', flexDirection:'column',</td></tr><tr><td class="line-number" value="2675"></td><td class="line-content">        overflow:'hidden', resize:'both', minWidth:'380px', minHeight:'280px'</td></tr><tr><td class="line-number" value="2676"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="2677"></td><td class="line-content">      panel.innerHTML = `</td></tr><tr><td class="line-number" value="2678"></td><td class="line-content">        &lt;div id="AT27_PV_hdr" style="cursor:move; user-select:none; background:#eef2ff; color:#111; padding:10px 12px; display:flex; gap:10px; align-items:center;"&gt;</td></tr><tr><td class="line-number" value="2679"></td><td class="line-content">          &lt;div style="font-weight:800;"&gt;Probabilidad de voltear 2027&lt;/div&gt;</td></tr><tr><td class="line-number" value="2680"></td><td class="line-content">          &lt;button id="AT27_PV_center" style="margin-left:auto; background:#eef2ff; border:1px solid #c7d2fe; border-radius:8px; padding:4px 8px; cursor:pointer;"&gt;Recentrar&lt;/button&gt;</td></tr><tr><td class="line-number" value="2681"></td><td class="line-content">          &lt;button id="AT27_PV_close" title="Cerrar" style="background:transparent;border:none;font-size:18px;cursor:pointer;"&gt;×&lt;/button&gt;</td></tr><tr><td class="line-number" value="2682"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="2683"></td><td class="line-content">        &lt;div style="padding:10px 12px; display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:end;"&gt;</td></tr><tr><td class="line-number" value="2684"></td><td class="line-content">          &lt;label style="font-size:12px;"&gt;Puesto&lt;br&gt;</td></tr><tr><td class="line-number" value="2685"></td><td class="line-content">            &lt;select id="AT27_PV_selPuesto" class="ttb-select" style="width:100%;"&gt;</td></tr><tr><td class="line-number" value="2686"></td><td class="line-content">              &lt;option value="A"&gt;Ayuntamiento&lt;/option&gt;</td></tr><tr><td class="line-number" value="2687"></td><td class="line-content">              &lt;option value="DL"&gt;Diputado Local&lt;/option&gt;</td></tr><tr><td class="line-number" value="2688"></td><td class="line-content">              &lt;option value="DF"&gt;Diputado Federal&lt;/option&gt;</td></tr><tr><td class="line-number" value="2689"></td><td class="line-content">            &lt;/select&gt;</td></tr><tr><td class="line-number" value="2690"></td><td class="line-content">          &lt;/label&gt;</td></tr><tr><td class="line-number" value="2691"></td><td class="line-content">          &lt;label style="font-size:12px;"&gt;Partido&lt;br&gt;</td></tr><tr><td class="line-number" value="2692"></td><td class="line-content">            &lt;select id="AT27_PV_selPartido" class="ttb-select" style="width:100%;"&gt;</td></tr><tr><td class="line-number" value="2693"></td><td class="line-content">              &lt;option&gt;PAN&lt;/option&gt;&lt;option&gt;PRI&lt;/option&gt;&lt;option&gt;PVEM&lt;/option&gt;&lt;option&gt;MORENA&lt;/option&gt;</td></tr><tr><td class="line-number" value="2694"></td><td class="line-content">            &lt;/select&gt;</td></tr><tr><td class="line-number" value="2695"></td><td class="line-content">          &lt;/label&gt;</td></tr><tr><td class="line-number" value="2696"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2697"></td><td class="line-content">          &lt;label style="grid-column:1 / span 2; font-size:12px;"&gt;Peso: margen 2024 (invertido) &lt;span id="AT27_PV_lbl_margen" style="opacity:.7;"&gt;50&lt;/span&gt;</td></tr><tr><td class="line-number" value="2698"></td><td class="line-content">            &lt;input id="AT27_PV_w_margen" type="range" min="0" max="100" value="50" style="width:100%;"&gt;</td></tr><tr><td class="line-number" value="2699"></td><td class="line-content">          &lt;/label&gt;</td></tr><tr><td class="line-number" value="2700"></td><td class="line-content">          &lt;label style="grid-column:1 / span 2; font-size:12px;"&gt;Peso: cambio de participación 2018→2024 &lt;span id="AT27_PV_lbl_trend" style="opacity:.7;"&gt;30&lt;/span&gt;</td></tr><tr><td class="line-number" value="2701"></td><td class="line-content">            &lt;input id="AT27_PV_w_trend"  type="range" min="0" max="100" value="30" style="width:100%;"&gt;</td></tr><tr><td class="line-number" value="2702"></td><td class="line-content">          &lt;/label&gt;</td></tr><tr><td class="line-number" value="2703"></td><td class="line-content">          &lt;label style="grid-column:1 / span 2; font-size:12px;"&gt;Peso: inestabilidad política &lt;span id="AT27_PV_lbl_stab" style="opacity:.7;"&gt;20&lt;/span&gt;</td></tr><tr><td class="line-number" value="2704"></td><td class="line-content">            &lt;input id="AT27_PV_w_stab"   type="range" min="0" max="100" value="20" style="width:100%;"&gt;</td></tr><tr><td class="line-number" value="2705"></td><td class="line-content">          &lt;/label&gt;</td></tr><tr><td class="line-number" value="2706"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2707"></td><td class="line-content">          &lt;button id="AT27_PV_run" class="ttb-btn ttb-primary" style="grid-column:1 / span 2;"&gt;Ejecutar&lt;/button&gt;</td></tr><tr><td class="line-number" value="2708"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="2709"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2710"></td><td class="line-content">        &lt;div style="padding:8px 12px;"&gt;</td></tr><tr><td class="line-number" value="2711"></td><td class="line-content">          &lt;div id="AT27_PV_legend" style="font-size:12px; display:flex; gap:12px; align-items:center; margin-bottom:6px;"&gt;</td></tr><tr><td class="line-number" value="2712"></td><td class="line-content">            &lt;span&gt;&lt;span style="display:inline-block;width:10px;height:10px;background:${AT27_PV_COLORS.ALTA};border-radius:2px;"&gt;&lt;/span&gt; Alta&lt;/span&gt;</td></tr><tr><td class="line-number" value="2713"></td><td class="line-content">            &lt;span&gt;&lt;span style="display:inline-block;width:10px;height:10px;background:${AT27_PV_COLORS.MEDIA};border-radius:2px;"&gt;&lt;/span&gt; Media&lt;/span&gt;</td></tr><tr><td class="line-number" value="2714"></td><td class="line-content">            &lt;span&gt;&lt;span style="display:inline-block;width:10px;height:10px;background:${AT27_PV_COLORS.BAJA};border-radius:2px;"&gt;&lt;/span&gt; Baja&lt;/span&gt;</td></tr><tr><td class="line-number" value="2715"></td><td class="line-content">          &lt;/div&gt;</td></tr><tr><td class="line-number" value="2716"></td><td class="line-content">          &lt;div id="AT27_PV_summary" style="font-size:12px; color:#334155;"&gt;&lt;/div&gt;</td></tr><tr><td class="line-number" value="2717"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="2718"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2719"></td><td class="line-content">        &lt;div style="flex:1; overflow:auto;"&gt;</td></tr><tr><td class="line-number" value="2720"></td><td class="line-content">          &lt;table style="width:100%; border-collapse:collapse; font-size:12px;"&gt;</td></tr><tr><td class="line-number" value="2721"></td><td class="line-content">            &lt;thead&gt;</td></tr><tr><td class="line-number" value="2722"></td><td class="line-content">              &lt;tr style="position:sticky; top:0; background:#f8fafc;"&gt;</td></tr><tr><td class="line-number" value="2723"></td><td class="line-content">                &lt;th style="text-align:left; padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Sección&lt;/th&gt;</td></tr><tr><td class="line-number" value="2724"></td><td class="line-content">                &lt;th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Puntaje&lt;/th&gt;</td></tr><tr><td class="line-number" value="2725"></td><td class="line-content">                &lt;th style="text-align:left; padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Clase&lt;/th&gt;</td></tr><tr><td class="line-number" value="2726"></td><td class="line-content">                &lt;th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Margen vs partido&lt;/th&gt;</td></tr><tr><td class="line-number" value="2727"></td><td class="line-content">                &lt;th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Δ participación&lt;/th&gt;</td></tr><tr><td class="line-number" value="2728"></td><td class="line-content">                &lt;th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Estabilidad&lt;/th&gt;</td></tr><tr><td class="line-number" value="2729"></td><td class="line-content">              &lt;/tr&gt;</td></tr><tr><td class="line-number" value="2730"></td><td class="line-content">            &lt;/thead&gt;</td></tr><tr><td class="line-number" value="2731"></td><td class="line-content">            &lt;tbody id="AT27_PV_tbody"&gt;&lt;/tbody&gt;</td></tr><tr><td class="line-number" value="2732"></td><td class="line-content">          &lt;/table&gt;</td></tr><tr><td class="line-number" value="2733"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="2734"></td><td class="line-content">      `;</td></tr><tr><td class="line-number" value="2735"></td><td class="line-content">      document.body.appendChild(panel);</td></tr><tr><td class="line-number" value="2736"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2737"></td><td class="line-content">      // wiring UI</td></tr><tr><td class="line-number" value="2738"></td><td class="line-content">      const $$ = id=&gt; panel.querySelector(id);</td></tr><tr><td class="line-number" value="2739"></td><td class="line-content">      $$('#AT27_PV_close').onclick  = ()=&gt; panel.style.display='none';</td></tr><tr><td class="line-number" value="2740"></td><td class="line-content">      $$('#AT27_PV_center').onclick = ()=&gt; (window.AT27_fitUniverseBounds? AT27_fitUniverseBounds() : null);</td></tr><tr><td class="line-number" value="2741"></td><td class="line-content">      $$('#AT27_PV_run').onclick    = ()=&gt;{ window.AT27_PV_STATE.autorun = true; AT27_PV_run(); };</td></tr><tr><td class="line-number" value="2742"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2743"></td><td class="line-content">      // sliders labels</td></tr><tr><td class="line-number" value="2744"></td><td class="line-content">      const upd = ()=&gt;{ $$('#AT27_PV_lbl_margen').textContent=$$('#AT27_PV_w_margen').value;</td></tr><tr><td class="line-number" value="2745"></td><td class="line-content">                        $$('#AT27_PV_lbl_trend').textContent =$$('#AT27_PV_w_trend').value;</td></tr><tr><td class="line-number" value="2746"></td><td class="line-content">                        $$('#AT27_PV_lbl_stab').textContent  =$$('#AT27_PV_w_stab').value; };</td></tr><tr><td class="line-number" value="2747"></td><td class="line-content">      ['AT27_PV_w_margen','AT27_PV_w_trend','AT27_PV_w_stab'].forEach(id=&gt; $$('#'+id).addEventListener('input', upd)); upd();</td></tr><tr><td class="line-number" value="2748"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2749"></td><td class="line-content">      // draggability</td></tr><tr><td class="line-number" value="2750"></td><td class="line-content">      (function drag(panelEl, handleEl){</td></tr><tr><td class="line-number" value="2751"></td><td class="line-content">        let sx=0, sy=0, ox=0, oy=0, dragging=false;</td></tr><tr><td class="line-number" value="2752"></td><td class="line-content">        handleEl.addEventListener('mousedown', e=&gt;{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panelEl.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });</td></tr><tr><td class="line-number" value="2753"></td><td class="line-content">        window.addEventListener('mousemove', e=&gt;{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panelEl.style.left=(ox+dx)+'px'; panelEl.style.top=(oy+dy)+'px'; panelEl.style.right='auto'; });</td></tr><tr><td class="line-number" value="2754"></td><td class="line-content">        window.addEventListener('mouseup', ()=&gt;{ dragging=false; document.body.style.userSelect=''; });</td></tr><tr><td class="line-number" value="2755"></td><td class="line-content">      })(panel, panel.querySelector('#AT27_PV_hdr'));</td></tr><tr><td class="line-number" value="2756"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2757"></td><td class="line-content">      // evitar que tape al mapa</td></tr><tr><td class="line-number" value="2758"></td><td class="line-content">      if (window.L &amp;&amp; L.DomEvent){ L.DomEvent.disableClickPropagation(panel); L.DomEvent.disableScrollPropagation(panel); }</td></tr><tr><td class="line-number" value="2759"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2760"></td><td class="line-content">      // recálculo automático si cambias el universo (después del primer Run)</td></tr><tr><td class="line-number" value="2761"></td><td class="line-content">      const map = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="2762"></td><td class="line-content">      if (map &amp;&amp; !map.__pvBound){</td></tr><tr><td class="line-number" value="2763"></td><td class="line-content">        const deb = (fn,ms=300)=&gt;{ let t; return (...a)=&gt;{ clearTimeout(t); t=setTimeout(()=&gt;fn(...a),ms); }; };</td></tr><tr><td class="line-number" value="2764"></td><td class="line-content">        map.on('layeradd',    deb(()=&gt;{ if (window.AT27_PV_STATE.autorun) AT27_PV_run(); }, 350));</td></tr><tr><td class="line-number" value="2765"></td><td class="line-content">        map.on('layerremove', deb(()=&gt;{ if (window.AT27_PV_STATE.autorun) AT27_PV_run(); }, 350));</td></tr><tr><td class="line-number" value="2766"></td><td class="line-content">        map.__pvBound = true;</td></tr><tr><td class="line-number" value="2767"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="2768"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="2769"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2770"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2771"></td><td class="line-content"><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="2772"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2773"></td><td class="line-content">  <span class="html-tag">&lt;script&gt;</span></td></tr><tr><td class="line-number" value="2774"></td><td class="line-content">// =======================================================</td></tr><tr><td class="line-number" value="2775"></td><td class="line-content">//  GENIALIDAD #2 · MÍNIMO DE VOTOS PARA MAYORÍA (por DF/DL/Mpio)</td></tr><tr><td class="line-number" value="2776"></td><td class="line-content">//  Usa la línea base 2027 (misma que “Ganar todo”) y ordena por “faltan”.</td></tr><tr><td class="line-number" value="2777"></td><td class="line-content">//  Panel: Puesto, Partido, Meta (% secciones), Umbral opcional “solo cercanas”.</td></tr><tr><td class="line-number" value="2778"></td><td class="line-content">//  Overlay: verde=ya ganada, amarillo=candidata del plan, rojo=resto.</td></tr><tr><td class="line-number" value="2779"></td><td class="line-content">//  Tabla: ordenada por costo; clic → zoom + tooltip.</td></tr><tr><td class="line-number" value="2780"></td><td class="line-content">//  Requiere: AT27_GG_project2027, AT27_GG_shares2024, loadPuesto/getElectData,</td></tr><tr><td class="line-number" value="2781"></td><td class="line-content">//            AT_CTX.map/layer y (si existe) AT27_GG_getUniverseSecIds().</td></tr><tr><td class="line-number" value="2782"></td><td class="line-content">// =======================================================</td></tr><tr><td class="line-number" value="2783"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2784"></td><td class="line-content">/* ====== Estado y utilidades ====== */</td></tr><tr><td class="line-number" value="2785"></td><td class="line-content">window.AT27_PM_STATE  = window.AT27_PM_STATE  || { autorun:false, running:false };</td></tr><tr><td class="line-number" value="2786"></td><td class="line-content">window.AT27_PM_LAYERS = window.AT27_PM_LAYERS || {};   // sec -&gt; layer</td></tr><tr><td class="line-number" value="2787"></td><td class="line-content">window.AT27_PM_LAYER  = window.AT27_PM_LAYER  || null;</td></tr><tr><td class="line-number" value="2788"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2789"></td><td class="line-content">const PM_COLORS = { WIN:'#22c55e', PLAN:'#f59e0b', LOSS:'#ef4444', NA:'#94a3b8' }; // verde, ámbar, rojo, gris</td></tr><tr><td class="line-number" value="2790"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2791"></td><td class="line-content">//const sec4 = (s)=&gt; String(s||'').replace(/\D+/g,'').padStart(4,'0');</td></tr><tr><td class="line-number" value="2792"></td><td class="line-content">//const clamp = (x,a,b)=&gt; Math.min(b, Math.max(a, x));</td></tr><tr><td class="line-number" value="2793"></td><td class="line-content">const fmtInt = (x)=&gt; Number.isFinite(x)? Math.round(x).toLocaleString() : '—';</td></tr><tr><td class="line-number" value="2794"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2795"></td><td class="line-content">function PM_getUniverseSecIds(){</td></tr><tr><td class="line-number" value="2796"></td><td class="line-content">  if (typeof AT27_GG_getUniverseSecIds==='function') return AT27_GG_getUniverseSecIds();</td></tr><tr><td class="line-number" value="2797"></td><td class="line-content">  const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];</td></tr><tr><td class="line-number" value="2798"></td><td class="line-content">  return feats.map(f=&gt; sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id));</td></tr><tr><td class="line-number" value="2799"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2800"></td><td class="line-content">async function PM_load(p){ return (window.loadPuesto? loadPuesto(p) : getElectData(p)); }</td></tr><tr><td class="line-number" value="2801"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2802"></td><td class="line-content">function partPct(row){</td></tr><tr><td class="line-number" value="2803"></td><td class="line-content">  if (!row) return null;</td></tr><tr><td class="line-number" value="2804"></td><td class="line-content">  const ln = Number(row.LN||0); if (!ln) return null;</td></tr><tr><td class="line-number" value="2805"></td><td class="line-content">  let vv = (row.VOTOS!=null)? Number(row.VOTOS||0) : 0;</td></tr><tr><td class="line-number" value="2806"></td><td class="line-content">  if (row.VOTOS==null){ for (const [k,v] of Object.entries(row)){ if (k!=='LN' &amp;&amp; k!=='VOTOS') vv += Number(v||0); } }</td></tr><tr><td class="line-number" value="2807"></td><td class="line-content">  return (vv/ln)*100;</td></tr><tr><td class="line-number" value="2808"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2809"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2810"></td><td class="line-content">/* ====== Cálculo por sección (línea base 2027) ====== */</td></tr><tr><td class="line-number" value="2811"></td><td class="line-content">function PM_computeBySec(js, secIds, puesto, partido){</td></tr><tr><td class="line-number" value="2812"></td><td class="line-content">  const bySec = {};                      // sec -&gt; {winner, vL, vX, faltan, swing, evaluable, Vproj}</td></tr><tr><td class="line-number" value="2813"></td><td class="line-content">  const X = partido.toUpperCase();</td></tr><tr><td class="line-number" value="2814"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2815"></td><td class="line-content">  for (const sec of secIds){</td></tr><tr><td class="line-number" value="2816"></td><td class="line-content">    const slot  = js?.secciones?.[sec4(sec)]; if (!slot){ bySec[sec4(sec)] = { evaluable:false }; continue; }</td></tr><tr><td class="line-number" value="2817"></td><td class="line-content">    const row24 = slot['2024'];          if (!row24){ bySec[sec4(sec)] = { evaluable:false }; continue; }</td></tr><tr><td class="line-number" value="2818"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2819"></td><td class="line-content">    // Proyección de participación 2027*</td></tr><tr><td class="line-number" value="2820"></td><td class="line-content">    const p27 = (typeof AT27_GG_project2027==='function') ? AT27_GG_project2027(slot, puesto) : null;</td></tr><tr><td class="line-number" value="2821"></td><td class="line-content">    const ln24 = Number(row24?.LN||0);</td></tr><tr><td class="line-number" value="2822"></td><td class="line-content">    if (p27==null || !ln24){ bySec[sec4(sec)] = { evaluable:false }; continue; }</td></tr><tr><td class="line-number" value="2823"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2824"></td><td class="line-content">    const Vproj = ln24 * (p27/100);</td></tr><tr><td class="line-number" value="2825"></td><td class="line-content">    if (!Number.isFinite(Vproj) || Vproj &lt; 1){ bySec[sec4(sec)] = { evaluable:false }; continue; }</td></tr><tr><td class="line-number" value="2826"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2827"></td><td class="line-content">    // Shares 2024</td></tr><tr><td class="line-number" value="2828"></td><td class="line-content">    const { shares, total:tot24 } = (typeof AT27_GG_shares2024==='function')</td></tr><tr><td class="line-number" value="2829"></td><td class="line-content">                                    ? AT27_GG_shares2024(row24)</td></tr><tr><td class="line-number" value="2830"></td><td class="line-content">                                    : (function(){</td></tr><tr><td class="line-number" value="2831"></td><td class="line-content">                                        let vv = (row24.VOTOS!=null)? Number(row24.VOTOS||0) : 0;</td></tr><tr><td class="line-number" value="2832"></td><td class="line-content">                                        if (row24.VOTOS==null){ for (const [k,v] of Object.entries(row24)){ if (k!=='LN' &amp;&amp; k!=='VOTOS') vv += Number(v||0); } }</td></tr><tr><td class="line-number" value="2833"></td><td class="line-content">                                        const sh = {};</td></tr><tr><td class="line-number" value="2834"></td><td class="line-content">                                        for (const [k,v] of Object.entries(row24)){</td></tr><tr><td class="line-number" value="2835"></td><td class="line-content">                                          if (k==='LN'||k==='VOTOS') continue;</td></tr><tr><td class="line-number" value="2836"></td><td class="line-content">                                          sh[k.toUpperCase()] = vv? (Number(v||0)/vv) : 0;</td></tr><tr><td class="line-number" value="2837"></td><td class="line-content">                                        }</td></tr><tr><td class="line-number" value="2838"></td><td class="line-content">                                        return { shares:sh, total:vv };</td></tr><tr><td class="line-number" value="2839"></td><td class="line-content">                                      })();</td></tr><tr><td class="line-number" value="2840"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2841"></td><td class="line-content">    if (!Object.keys(shares).length || !tot24){ bySec[sec4(sec)] = { evaluable:false }; continue; }</td></tr><tr><td class="line-number" value="2842"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2843"></td><td class="line-content">    // Votos 2027* por partido (base shares 2024)</td></tr><tr><td class="line-number" value="2844"></td><td class="line-content">    const vBase = {};</td></tr><tr><td class="line-number" value="2845"></td><td class="line-content">    for (const [sig,sh] of Object.entries(shares)){ vBase[sig.toUpperCase()] = sh * Vproj; }</td></tr><tr><td class="line-number" value="2846"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2847"></td><td class="line-content">    // Líder y tu partido</td></tr><tr><td class="line-number" value="2848"></td><td class="line-content">    let L=null, vL=-1;</td></tr><tr><td class="line-number" value="2849"></td><td class="line-content">    for (const [sig, vv] of Object.entries(vBase)){ if (vv&gt;vL){ vL=vv; L=sig; } }</td></tr><tr><td class="line-number" value="2850"></td><td class="line-content">    const vX = vBase[X] || 0;</td></tr><tr><td class="line-number" value="2851"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2852"></td><td class="line-content">    const faltan = Math.max(0, (vL - vX) + 1);</td></tr><tr><td class="line-number" value="2853"></td><td class="line-content">    const swing  = Math.ceil(faltan / 2);</td></tr><tr><td class="line-number" value="2854"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2855"></td><td class="line-content">    bySec[sec4(sec)] = { winner:L, vL, vX, faltan, swing, evaluable:true, Vproj };</td></tr><tr><td class="line-number" value="2856"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="2857"></td><td class="line-content">  return bySec;</td></tr><tr><td class="line-number" value="2858"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2859"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2860"></td><td class="line-content">/* ====== Construcción del plan (mínimo costo) ====== */</td></tr><tr><td class="line-number" value="2861"></td><td class="line-content">function PM_buildPlan(bySec, metaPct){</td></tr><tr><td class="line-number" value="2862"></td><td class="line-content">  const entries = Object.entries(bySec).filter(([,x])=&gt; x &amp;&amp; x.evaluable);</td></tr><tr><td class="line-number" value="2863"></td><td class="line-content">  const totalSecs = entries.length;</td></tr><tr><td class="line-number" value="2864"></td><td class="line-content">  const metaCount = Math.ceil( clamp(metaPct, 1, 100) / 100 * totalSecs );</td></tr><tr><td class="line-number" value="2865"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2866"></td><td class="line-content">  // Secciones ya ganadas (costo 0)</td></tr><tr><td class="line-number" value="2867"></td><td class="line-content">  const wins   = entries.filter(([,x])=&gt; x.faltan&lt;=0 &amp;&amp; x.winner &amp;&amp; Number.isFinite(x.vX) &amp;&amp; x.vX&gt;=x.vL);</td></tr><tr><td class="line-number" value="2868"></td><td class="line-content">  const losses = entries.filter(([,x])=&gt; !(x.faltan&lt;=0 &amp;&amp; x.winner &amp;&amp; Number.isFinite(x.vX) &amp;&amp; x.vX&gt;=x.vL));</td></tr><tr><td class="line-number" value="2869"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2870"></td><td class="line-content">  // Si ya se cumple la meta con wins</td></tr><tr><td class="line-number" value="2871"></td><td class="line-content">  if (wins.length &gt;= metaCount){</td></tr><tr><td class="line-number" value="2872"></td><td class="line-content">    return {</td></tr><tr><td class="line-number" value="2873"></td><td class="line-content">      selected: new Set(wins.map(([sec])=&gt;sec).slice(0, metaCount)),</td></tr><tr><td class="line-number" value="2874"></td><td class="line-content">      planRows: wins.map(([sec,x])=&gt;({sec, estado:'GANADA', faltan:0, swing:0, winner:x.winner, vL:x.vL, vX:x.vX}))</td></tr><tr><td class="line-number" value="2875"></td><td class="line-content">                     .sort((a,b)=&gt; Number(a.sec)-Number(b.sec)),</td></tr><tr><td class="line-number" value="2876"></td><td class="line-content">      totals:{ votos:0, swing:0, metaCount, totalSecs }</td></tr><tr><td class="line-number" value="2877"></td><td class="line-content">    };</td></tr><tr><td class="line-number" value="2878"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="2879"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2880"></td><td class="line-content">  // Ordenar pérdidas por costo ascendente</td></tr><tr><td class="line-number" value="2881"></td><td class="line-content">  losses.sort((a,b)=&gt; (a[1].faltan - b[1].faltan) || (Number(a[0])-Number(b[0])));</td></tr><tr><td class="line-number" value="2882"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2883"></td><td class="line-content">  const selected = new Set(wins.map(([sec])=&gt;sec));</td></tr><tr><td class="line-number" value="2884"></td><td class="line-content">  const planRows = wins.map(([sec,x])=&gt;({sec, estado:'GANADA', faltan:0, swing:0, winner:x.winner, vL:x.vL, vX:x.vX}));</td></tr><tr><td class="line-number" value="2885"></td><td class="line-content">  let votos=0, swing=0;</td></tr><tr><td class="line-number" value="2886"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2887"></td><td class="line-content">  for (const [sec,x] of losses){</td></tr><tr><td class="line-number" value="2888"></td><td class="line-content">    if (selected.size &gt;= metaCount) break;</td></tr><tr><td class="line-number" value="2889"></td><td class="line-content">    selected.add(sec);</td></tr><tr><td class="line-number" value="2890"></td><td class="line-content">    votos += Math.ceil(x.faltan);</td></tr><tr><td class="line-number" value="2891"></td><td class="line-content">    swing += Math.ceil(x.swing);</td></tr><tr><td class="line-number" value="2892"></td><td class="line-content">    planRows.push({ sec, estado:'CANDIDATA', faltan:x.faltan, swing:x.swing, winner:x.winner, vL:x.vL, vX:x.vX });</td></tr><tr><td class="line-number" value="2893"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="2894"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2895"></td><td class="line-content">  // Las restantes (no seleccionadas) por claridad en tabla</td></tr><tr><td class="line-number" value="2896"></td><td class="line-content">  const rest = losses.filter(([sec])=&gt; !selected.has(sec))</td></tr><tr><td class="line-number" value="2897"></td><td class="line-content">                     .map(([sec,x])=&gt;({ sec, estado:'RESTO', faltan:x.faltan, swing:x.swing, winner:x.winner, vL:x.vL, vX:x.vX }));</td></tr><tr><td class="line-number" value="2898"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2899"></td><td class="line-content">  // Orden final: GANADA (id asc) → CANDIDATA (faltan asc) → RESTO (faltan asc)</td></tr><tr><td class="line-number" value="2900"></td><td class="line-content">  const table = [</td></tr><tr><td class="line-number" value="2901"></td><td class="line-content">    ...planRows.filter(r=&gt;r.estado==='GANADA').sort((a,b)=&gt; Number(a.sec)-Number(b.sec)),</td></tr><tr><td class="line-number" value="2902"></td><td class="line-content">    ...planRows.filter(r=&gt;r.estado==='CANDIDATA').sort((a,b)=&gt; a.faltan-b.faltan || Number(a.sec)-Number(b.sec)),</td></tr><tr><td class="line-number" value="2903"></td><td class="line-content">    ...rest.sort((a,b)=&gt; a.faltan-b.faltan || Number(a.sec)-Number(b.sec))</td></tr><tr><td class="line-number" value="2904"></td><td class="line-content">  ];</td></tr><tr><td class="line-number" value="2905"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2906"></td><td class="line-content">  return { selected, planRows: table, totals:{ votos, swing, metaCount, totalSecs } };</td></tr><tr><td class="line-number" value="2907"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2908"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2909"></td><td class="line-content">/* ====== Overlay ====== */</td></tr><tr><td class="line-number" value="2910"></td><td class="line-content">function PM_clear(){</td></tr><tr><td class="line-number" value="2911"></td><td class="line-content">  const map = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="2912"></td><td class="line-content">  if (!map) return;</td></tr><tr><td class="line-number" value="2913"></td><td class="line-content">  if (window.AT27_PM_LAYER){ try{ map.removeLayer(AT27_PM_LAYER); }catch(_){} window.AT27_PM_LAYER=null; }</td></tr><tr><td class="line-number" value="2914"></td><td class="line-content">  window.AT27_PM_LAYERS = {};</td></tr><tr><td class="line-number" value="2915"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2916"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2917"></td><td class="line-content">function PM_buildOverlay(selectedSet, bySec){</td></tr><tr><td class="line-number" value="2918"></td><td class="line-content">  const map  = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="2919"></td><td class="line-content">  const base = window.AT_CTX?.layer?.toGeoJSON?.() || window.AT_DATA;</td></tr><tr><td class="line-number" value="2920"></td><td class="line-content">  if (!map || !base?.features) return;</td></tr><tr><td class="line-number" value="2921"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2922"></td><td class="line-content">  PM_clear();</td></tr><tr><td class="line-number" value="2923"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2924"></td><td class="line-content">  if (map.createPane &amp;&amp; !map.getPane('at27_pm_pane')){</td></tr><tr><td class="line-number" value="2925"></td><td class="line-content">    map.createPane('at27_pm_pane');</td></tr><tr><td class="line-number" value="2926"></td><td class="line-content">    const p = map.getPane('at27_pm_pane'); p.style.zIndex=690; p.style.pointerEvents='auto';</td></tr><tr><td class="line-number" value="2927"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="2928"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2929"></td><td class="line-content">  const feats = base.features.filter(f=&gt;{</td></tr><tr><td class="line-number" value="2930"></td><td class="line-content">    const id = sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);</td></tr><tr><td class="line-number" value="2931"></td><td class="line-content">    return bySec[id]?.evaluable;</td></tr><tr><td class="line-number" value="2932"></td><td class="line-content">  });</td></tr><tr><td class="line-number" value="2933"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2934"></td><td class="line-content">  const layer = L.geoJSON({type:'FeatureCollection', features:feats}, {</td></tr><tr><td class="line-number" value="2935"></td><td class="line-content">    pane:'at27_pm_pane',</td></tr><tr><td class="line-number" value="2936"></td><td class="line-content">    style: f=&gt;{</td></tr><tr><td class="line-number" value="2937"></td><td class="line-content">      const id = sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);</td></tr><tr><td class="line-number" value="2938"></td><td class="line-content">      const info = bySec[id];</td></tr><tr><td class="line-number" value="2939"></td><td class="line-content">      let col = PM_COLORS.NA;</td></tr><tr><td class="line-number" value="2940"></td><td class="line-content">      if (info?.evaluable){</td></tr><tr><td class="line-number" value="2941"></td><td class="line-content">        if (info.faltan&lt;=0 &amp;&amp; info.vX&gt;=info.vL) col = PM_COLORS.WIN;</td></tr><tr><td class="line-number" value="2942"></td><td class="line-content">        else if (selectedSet.has(id))          col = PM_COLORS.PLAN;</td></tr><tr><td class="line-number" value="2943"></td><td class="line-content">        else                                   col = PM_COLORS.LOSS;</td></tr><tr><td class="line-number" value="2944"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="2945"></td><td class="line-content">      return { color: col, weight:1, opacity:.9, fillColor: col, fillOpacity:.35 };</td></tr><tr><td class="line-number" value="2946"></td><td class="line-content">    },</td></tr><tr><td class="line-number" value="2947"></td><td class="line-content">    onEachFeature: (feature, lyr)=&gt;{</td></tr><tr><td class="line-number" value="2948"></td><td class="line-content">      const id = sec4(feature.properties?.ID ?? feature.properties?.SECCION ?? feature.properties?.id);</td></tr><tr><td class="line-number" value="2949"></td><td class="line-content">      window.AT27_PM_LAYERS[id] = lyr;</td></tr><tr><td class="line-number" value="2950"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2951"></td><td class="line-content">      const x = bySec[id] || {};</td></tr><tr><td class="line-number" value="2952"></td><td class="line-content">      const estado = (x.faltan&lt;=0 &amp;&amp; x.vX&gt;=x.vL) ? 'GANADA' : (selectedSet.has(id) ? 'CANDIDATA' : 'RESTO');</td></tr><tr><td class="line-number" value="2953"></td><td class="line-content">      const tip = `</td></tr><tr><td class="line-number" value="2954"></td><td class="line-content">        &lt;div style="font-size:12px;"&gt;</td></tr><tr><td class="line-number" value="2955"></td><td class="line-content">          Sección &lt;b&gt;${id}&lt;/b&gt;&lt;br&gt;</td></tr><tr><td class="line-number" value="2956"></td><td class="line-content">          Estado: &lt;b&gt;${estado}&lt;/b&gt;&lt;br&gt;</td></tr><tr><td class="line-number" value="2957"></td><td class="line-content">          Ganador base 2027*: &lt;b&gt;${x.winner||'—'}&lt;/b&gt;&lt;br&gt;</td></tr><tr><td class="line-number" value="2958"></td><td class="line-content">          Votos líder: &lt;b&gt;${fmtInt(x.vL)}&lt;/b&gt; · Tus votos: &lt;b&gt;${fmtInt(x.vX)}&lt;/b&gt;&lt;br&gt;</td></tr><tr><td class="line-number" value="2959"></td><td class="line-content">          Faltan: &lt;b&gt;${fmtInt(x.faltan)}&lt;/b&gt; · Swing: &lt;b&gt;${fmtInt(x.swing)}&lt;/b&gt;</td></tr><tr><td class="line-number" value="2960"></td><td class="line-content">        &lt;/div&gt;`;</td></tr><tr><td class="line-number" value="2961"></td><td class="line-content">      lyr.bindTooltip(tip, {sticky:true, opacity:.95, direction:'top', className:'at27-tt'});</td></tr><tr><td class="line-number" value="2962"></td><td class="line-content">      lyr.on('mouseover', ()=&gt;lyr.setStyle({weight:2}));</td></tr><tr><td class="line-number" value="2963"></td><td class="line-content">      lyr.on('mouseout',  ()=&gt;lyr.setStyle({weight:1}));</td></tr><tr><td class="line-number" value="2964"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="2965"></td><td class="line-content">  });</td></tr><tr><td class="line-number" value="2966"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2967"></td><td class="line-content">  layer.addTo(map);</td></tr><tr><td class="line-number" value="2968"></td><td class="line-content">  window.AT27_PM_LAYER = layer;</td></tr><tr><td class="line-number" value="2969"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2970"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2971"></td><td class="line-content">/* ====== Tabla + resumen ====== */</td></tr><tr><td class="line-number" value="2972"></td><td class="line-content">function PM_renderTable(planRows){</td></tr><tr><td class="line-number" value="2973"></td><td class="line-content">  const tb = document.getElementById('AT27_PM_tbody');</td></tr><tr><td class="line-number" value="2974"></td><td class="line-content">  tb.innerHTML = planRows.map(r=&gt;{</td></tr><tr><td class="line-number" value="2975"></td><td class="line-content">    const bg = r.estado==='GANADA' ? '#dcfce7' : (r.estado==='CANDIDATA' ? '#fef9c3' : '#fee2e2');</td></tr><tr><td class="line-number" value="2976"></td><td class="line-content">    return `</td></tr><tr><td class="line-number" value="2977"></td><td class="line-content">      &lt;tr data-sec="${r.sec}" style="background:${bg}; cursor:pointer;"&gt;</td></tr><tr><td class="line-number" value="2978"></td><td class="line-content">        &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;"&gt;${r.sec}&lt;/td&gt;</td></tr><tr><td class="line-number" value="2979"></td><td class="line-content">        &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;"&gt;${r.estado}&lt;/td&gt;</td></tr><tr><td class="line-number" value="2980"></td><td class="line-content">        &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;"&gt;${r.winner||'—'}&lt;/td&gt;</td></tr><tr><td class="line-number" value="2981"></td><td class="line-content">        &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;"&gt;${fmtInt(r.faltan)}&lt;/td&gt;</td></tr><tr><td class="line-number" value="2982"></td><td class="line-content">        &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;"&gt;${fmtInt(r.swing)}&lt;/td&gt;</td></tr><tr><td class="line-number" value="2983"></td><td class="line-content">      &lt;/tr&gt;</td></tr><tr><td class="line-number" value="2984"></td><td class="line-content">    `;</td></tr><tr><td class="line-number" value="2985"></td><td class="line-content">  }).join('');</td></tr><tr><td class="line-number" value="2986"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2987"></td><td class="line-content">  // Zoom al hacer clic</td></tr><tr><td class="line-number" value="2988"></td><td class="line-content">  tb.onclick = (e)=&gt;{</td></tr><tr><td class="line-number" value="2989"></td><td class="line-content">    const tr = e.target.closest('tr[data-sec]'); if (!tr) return;</td></tr><tr><td class="line-number" value="2990"></td><td class="line-content">    PM_focus(tr.getAttribute('data-sec'));</td></tr><tr><td class="line-number" value="2991"></td><td class="line-content">  };</td></tr><tr><td class="line-number" value="2992"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2993"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2994"></td><td class="line-content">function PM_focus(sec){</td></tr><tr><td class="line-number" value="2995"></td><td class="line-content">  const id = sec4(sec);</td></tr><tr><td class="line-number" value="2996"></td><td class="line-content">  const lyr = window.AT27_PM_LAYERS[id];</td></tr><tr><td class="line-number" value="2997"></td><td class="line-content">  const map = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="2998"></td><td class="line-content">  if (!map) return;</td></tr><tr><td class="line-number" value="2999"></td><td class="line-content">  if (lyr){</td></tr><tr><td class="line-number" value="3000"></td><td class="line-content">    try{ map.fitBounds(lyr.getBounds(), {maxZoom:16, padding:[20,20]}); }catch(_){}</td></tr><tr><td class="line-number" value="3001"></td><td class="line-content">    if (lyr.openTooltip) lyr.openTooltip();</td></tr><tr><td class="line-number" value="3002"></td><td class="line-content">    const origFO = lyr.options.fillOpacity ?? .35;</td></tr><tr><td class="line-number" value="3003"></td><td class="line-content">    lyr.setStyle({weight:3, fillOpacity: Math.min(.95, origFO+.25)});</td></tr><tr><td class="line-number" value="3004"></td><td class="line-content">    setTimeout(()=&gt; lyr.setStyle({weight:1, fillOpacity: origFO}), 900);</td></tr><tr><td class="line-number" value="3005"></td><td class="line-content">    return;</td></tr><tr><td class="line-number" value="3006"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="3007"></td><td class="line-content">  // fallback</td></tr><tr><td class="line-number" value="3008"></td><td class="line-content">  const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];</td></tr><tr><td class="line-number" value="3009"></td><td class="line-content">  const f = feats.find(ft=&gt; sec4(ft.properties?.ID ?? ft.properties?.SECCION ?? ft.properties?.id)===id);</td></tr><tr><td class="line-number" value="3010"></td><td class="line-content">  if (f){ const tmp=L.geoJSON(f); map.fitBounds(tmp.getBounds(), {maxZoom:16, padding:[20,20]}); }</td></tr><tr><td class="line-number" value="3011"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="3012"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3013"></td><td class="line-content">function PM_renderSummary(totals){</td></tr><tr><td class="line-number" value="3014"></td><td class="line-content">  const el = document.getElementById('AT27_PM_summary');</td></tr><tr><td class="line-number" value="3015"></td><td class="line-content">  const { votos, swing, metaCount, totalSecs } = totals || {};</td></tr><tr><td class="line-number" value="3016"></td><td class="line-content">  el.innerHTML = `</td></tr><tr><td class="line-number" value="3017"></td><td class="line-content">    &lt;div style="font-size:12px; line-height:1.35;"&gt;</td></tr><tr><td class="line-number" value="3018"></td><td class="line-content">      &lt;div&gt;&lt;span style="display:inline-block;width:10px;height:10px;background:${PM_COLORS.WIN};border-radius:2px;"&gt;&lt;/span&gt; Ya ganadas (costo 0)&lt;/div&gt;</td></tr><tr><td class="line-number" value="3019"></td><td class="line-content">      &lt;div&gt;&lt;span style="display:inline-block;width:10px;height:10px;background:${PM_COLORS.PLAN};border-radius:2px;"&gt;&lt;/span&gt; Candidatas del plan&lt;/div&gt;</td></tr><tr><td class="line-number" value="3020"></td><td class="line-content">      &lt;div&gt;&lt;span style="display:inline-block;width:10px;height:10px;background:${PM_COLORS.LOSS};border-radius:2px;"&gt;&lt;/span&gt; Resto&lt;/div&gt;</td></tr><tr><td class="line-number" value="3021"></td><td class="line-content">      &lt;div style="margin-top:6px;"&gt;&lt;b&gt;Meta de secciones:&lt;/b&gt; ${fmtInt(metaCount)} de ${fmtInt(totalSecs)}&lt;/div&gt;</td></tr><tr><td class="line-number" value="3022"></td><td class="line-content">      &lt;div&gt;&lt;b&gt;Votos mínimos a movilizar:&lt;/b&gt; ${fmtInt(votos)}&lt;/div&gt;</td></tr><tr><td class="line-number" value="3023"></td><td class="line-content">      &lt;div&gt;&lt;b&gt;Swing estimado:&lt;/b&gt; ${fmtInt(swing)}&lt;/div&gt;</td></tr><tr><td class="line-number" value="3024"></td><td class="line-content">    &lt;/div&gt;</td></tr><tr><td class="line-number" value="3025"></td><td class="line-content">  `;</td></tr><tr><td class="line-number" value="3026"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="3027"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3028"></td><td class="line-content">/* ====== RUN principal ====== */</td></tr><tr><td class="line-number" value="3029"></td><td class="line-content">async function AT27_PM_run(){</td></tr><tr><td class="line-number" value="3030"></td><td class="line-content">  if (window.AT27_PM_STATE.running) return;</td></tr><tr><td class="line-number" value="3031"></td><td class="line-content">  window.AT27_PM_STATE.running = true;</td></tr><tr><td class="line-number" value="3032"></td><td class="line-content">  try{</td></tr><tr><td class="line-number" value="3033"></td><td class="line-content">    const puesto  = document.getElementById('AT27_PM_selPuesto').value;</td></tr><tr><td class="line-number" value="3034"></td><td class="line-content">    const partido = document.getElementById('AT27_PM_selPartido').value.toUpperCase();</td></tr><tr><td class="line-number" value="3035"></td><td class="line-content">    const meta    = Number(document.getElementById('AT27_PM_meta').value || 60); // %</td></tr><tr><td class="line-number" value="3036"></td><td class="line-content">    const onlyNear = document.getElementById('AT27_PM_onlyNear').checked;</td></tr><tr><td class="line-number" value="3037"></td><td class="line-content">    const nearMax  = Number(document.getElementById('AT27_PM_nearMax').value || 0);</td></tr><tr><td class="line-number" value="3038"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3039"></td><td class="line-content">    const secIds = PM_getUniverseSecIds();</td></tr><tr><td class="line-number" value="3040"></td><td class="line-content">    if (!secIds.length){ PM_clear(); document.getElementById('AT27_PM_tbody').innerHTML=''; return; }</td></tr><tr><td class="line-number" value="3041"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3042"></td><td class="line-content">    const js = await PM_load(puesto);</td></tr><tr><td class="line-number" value="3043"></td><td class="line-content">    let bySec = PM_computeBySec(js, secIds, puesto, partido);</td></tr><tr><td class="line-number" value="3044"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3045"></td><td class="line-content">    // Filtro "solo cercanas" (opcional)</td></tr><tr><td class="line-number" value="3046"></td><td class="line-content">    if (onlyNear){</td></tr><tr><td class="line-number" value="3047"></td><td class="line-content">      const filtered = {};</td></tr><tr><td class="line-number" value="3048"></td><td class="line-content">      for (const [sec,x] of Object.entries(bySec)){</td></tr><tr><td class="line-number" value="3049"></td><td class="line-content">        if (!x?.evaluable) continue;</td></tr><tr><td class="line-number" value="3050"></td><td class="line-content">        if (x.faltan&lt;=0 || x.faltan&lt;=nearMax) filtered[sec] = x;</td></tr><tr><td class="line-number" value="3051"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="3052"></td><td class="line-content">      bySec = filtered;</td></tr><tr><td class="line-number" value="3053"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="3054"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3055"></td><td class="line-content">    const plan = PM_buildPlan(bySec, meta);</td></tr><tr><td class="line-number" value="3056"></td><td class="line-content">    PM_buildOverlay(plan.selected, bySec);</td></tr><tr><td class="line-number" value="3057"></td><td class="line-content">    PM_renderSummary(plan.totals);</td></tr><tr><td class="line-number" value="3058"></td><td class="line-content">    PM_renderTable(plan.planRows);</td></tr><tr><td class="line-number" value="3059"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3060"></td><td class="line-content">  }catch(e){</td></tr><tr><td class="line-number" value="3061"></td><td class="line-content">    console.error('AT27_PM_run', e);</td></tr><tr><td class="line-number" value="3062"></td><td class="line-content">    alert('No pude ejecutar “Plan de mayoría”.');</td></tr><tr><td class="line-number" value="3063"></td><td class="line-content">  }finally{</td></tr><tr><td class="line-number" value="3064"></td><td class="line-content">    window.AT27_PM_STATE.running = false;</td></tr><tr><td class="line-number" value="3065"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="3066"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="3067"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3068"></td><td class="line-content">/* ====== Panel UI ====== */</td></tr><tr><td class="line-number" value="3069"></td><td class="line-content">function AT27_PM_open(){</td></tr><tr><td class="line-number" value="3070"></td><td class="line-content">  let panel = document.getElementById('AT27_PM_panel');</td></tr><tr><td class="line-number" value="3071"></td><td class="line-content">  if (panel){ panel.style.display='block'; return; }</td></tr><tr><td class="line-number" value="3072"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3073"></td><td class="line-content">  panel = document.createElement('div');</td></tr><tr><td class="line-number" value="3074"></td><td class="line-content">  panel.id = 'AT27_PM_panel';</td></tr><tr><td class="line-number" value="3075"></td><td class="line-content">  Object.assign(panel.style,{</td></tr><tr><td class="line-number" value="3076"></td><td class="line-content">    position:'fixed', right:'24px', top:'24px', zIndex:9998,</td></tr><tr><td class="line-number" value="3077"></td><td class="line-content">    width:'560px', maxWidth:'calc(100vw - 40px)', maxHeight:'calc(100vh - 40px)',</td></tr><tr><td class="line-number" value="3078"></td><td class="line-content">    background:'#fff', border:'1px solid #e5e7eb', borderRadius:'14px',</td></tr><tr><td class="line-number" value="3079"></td><td class="line-content">    boxShadow:'0 18px 40px rgba(0,0,0,.18)', display:'flex', flexDirection:'column',</td></tr><tr><td class="line-number" value="3080"></td><td class="line-content">    overflow:'hidden', resize:'both', minWidth:'380px', minHeight:'280px'</td></tr><tr><td class="line-number" value="3081"></td><td class="line-content">  });</td></tr><tr><td class="line-number" value="3082"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3083"></td><td class="line-content">  panel.innerHTML = `</td></tr><tr><td class="line-number" value="3084"></td><td class="line-content">    &lt;div id="AT27_PM_hdr" style="cursor:move; user-select:none; background:#fffbeb; color:#111; padding:10px 12px; display:flex; gap:10px; align-items:center;"&gt;</td></tr><tr><td class="line-number" value="3085"></td><td class="line-content">      &lt;div style="font-weight:800;"&gt;Mínimo de votos para mayoría&lt;/div&gt;</td></tr><tr><td class="line-number" value="3086"></td><td class="line-content">      &lt;button id="AT27_PM_center" style="margin-left:auto; background:#eef2ff; border:1px solid #c7d2fe; border-radius:8px; padding:4px 8px; cursor:pointer;"&gt;Recentrar&lt;/button&gt;</td></tr><tr><td class="line-number" value="3087"></td><td class="line-content">      &lt;button id="AT27_PM_close" title="Cerrar" style="background:transparent;border:none;font-size:18px;cursor:pointer;"&gt;×&lt;/button&gt;</td></tr><tr><td class="line-number" value="3088"></td><td class="line-content">    &lt;/div&gt;</td></tr><tr><td class="line-number" value="3089"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3090"></td><td class="line-content">    &lt;div style="padding:10px 12px; display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:end;"&gt;</td></tr><tr><td class="line-number" value="3091"></td><td class="line-content">      &lt;label style="font-size:12px;"&gt;Puesto&lt;br&gt;</td></tr><tr><td class="line-number" value="3092"></td><td class="line-content">        &lt;select id="AT27_PM_selPuesto" class="ttb-select" style="width:100%;"&gt;</td></tr><tr><td class="line-number" value="3093"></td><td class="line-content">          &lt;option value="A"&gt;Ayuntamiento&lt;/option&gt;</td></tr><tr><td class="line-number" value="3094"></td><td class="line-content">          &lt;option value="DL"&gt;Diputado Local&lt;/option&gt;</td></tr><tr><td class="line-number" value="3095"></td><td class="line-content">          &lt;option value="DF"&gt;Diputado Federal&lt;/option&gt;</td></tr><tr><td class="line-number" value="3096"></td><td class="line-content">        &lt;/select&gt;</td></tr><tr><td class="line-number" value="3097"></td><td class="line-content">      &lt;/label&gt;</td></tr><tr><td class="line-number" value="3098"></td><td class="line-content">      &lt;label style="font-size:12px;"&gt;Partido&lt;br&gt;</td></tr><tr><td class="line-number" value="3099"></td><td class="line-content">        &lt;select id="AT27_PM_selPartido" class="ttb-select" style="width:100%;"&gt;</td></tr><tr><td class="line-number" value="3100"></td><td class="line-content">          &lt;option&gt;PAN&lt;/option&gt;&lt;option&gt;PRI&lt;/option&gt;&lt;option&gt;PVEM&lt;/option&gt;&lt;option&gt;MORENA&lt;/option&gt;</td></tr><tr><td class="line-number" value="3101"></td><td class="line-content">        &lt;/select&gt;</td></tr><tr><td class="line-number" value="3102"></td><td class="line-content">      &lt;/label&gt;</td></tr><tr><td class="line-number" value="3103"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3104"></td><td class="line-content">      &lt;label style="font-size:12px;"&gt;Meta de secciones (%) &lt;span id="AT27_PM_lblMeta" style="opacity:.7;"&gt;60%&lt;/span&gt;</td></tr><tr><td class="line-number" value="3105"></td><td class="line-content">        &lt;input id="AT27_PM_meta" type="range" min="50" max="80" step="5" value="60" style="width:100%;"&gt;</td></tr><tr><td class="line-number" value="3106"></td><td class="line-content">      &lt;/label&gt;</td></tr><tr><td class="line-number" value="3107"></td><td class="line-content">      &lt;label style="font-size:12px;"&gt;Solo cercanas (≤ votos faltantes)</td></tr><tr><td class="line-number" value="3108"></td><td class="line-content">        &lt;div style="display:flex; gap:8px; align-items:center;"&gt;</td></tr><tr><td class="line-number" value="3109"></td><td class="line-content">          &lt;input id="AT27_PM_onlyNear" type="checkbox"&gt;</td></tr><tr><td class="line-number" value="3110"></td><td class="line-content">          &lt;input id="AT27_PM_nearMax" type="number" min="0" value="300" style="width:100px; padding:4px 6px; border:1px solid #e5e7eb; border-radius:8px;"&gt;</td></tr><tr><td class="line-number" value="3111"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="3112"></td><td class="line-content">      &lt;/label&gt;</td></tr><tr><td class="line-number" value="3113"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3114"></td><td class="line-content">      &lt;button id="AT27_PM_run" class="ttb-btn ttb-primary" style="grid-column:1 / span 2;"&gt;Ejecutar&lt;/button&gt;</td></tr><tr><td class="line-number" value="3115"></td><td class="line-content">    &lt;/div&gt;</td></tr><tr><td class="line-number" value="3116"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3117"></td><td class="line-content">    &lt;div style="padding:8px 12px;"&gt;</td></tr><tr><td class="line-number" value="3118"></td><td class="line-content">      &lt;div id="AT27_PM_legend" style="font-size:12px; display:flex; gap:12px; align-items:center; margin-bottom:6px;"&gt;</td></tr><tr><td class="line-number" value="3119"></td><td class="line-content">        &lt;span&gt;&lt;span style="display:inline-block;width:10px;height:10px;background:${PM_COLORS.WIN};border-radius:2px;"&gt;&lt;/span&gt; Ya ganada&lt;/span&gt;</td></tr><tr><td class="line-number" value="3120"></td><td class="line-content">        &lt;span&gt;&lt;span style="display:inline-block;width:10px;height:10px;background:${PM_COLORS.PLAN};border-radius:2px;"&gt;&lt;/span&gt; Candidata del plan&lt;/span&gt;</td></tr><tr><td class="line-number" value="3121"></td><td class="line-content">        &lt;span&gt;&lt;span style="display:inline-block;width:10px;height:10px;background:${PM_COLORS.LOSS};border-radius:2px;"&gt;&lt;/span&gt; Resto&lt;/span&gt;</td></tr><tr><td class="line-number" value="3122"></td><td class="line-content">      &lt;/div&gt;</td></tr><tr><td class="line-number" value="3123"></td><td class="line-content">      &lt;div id="AT27_PM_summary" style="font-size:12px; color:#334155;"&gt;&lt;/div&gt;</td></tr><tr><td class="line-number" value="3124"></td><td class="line-content">    &lt;/div&gt;</td></tr><tr><td class="line-number" value="3125"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3126"></td><td class="line-content">    &lt;div style="flex:1; overflow:auto;"&gt;</td></tr><tr><td class="line-number" value="3127"></td><td class="line-content">      &lt;table style="width:100%; border-collapse:collapse; font-size:12px;"&gt;</td></tr><tr><td class="line-number" value="3128"></td><td class="line-content">        &lt;thead&gt;</td></tr><tr><td class="line-number" value="3129"></td><td class="line-content">          &lt;tr style="position:sticky; top:0; background:#f8fafc;"&gt;</td></tr><tr><td class="line-number" value="3130"></td><td class="line-content">            &lt;th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Sección&lt;/th&gt;</td></tr><tr><td class="line-number" value="3131"></td><td class="line-content">            &lt;th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Estado&lt;/th&gt;</td></tr><tr><td class="line-number" value="3132"></td><td class="line-content">            &lt;th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Ganador base&lt;/th&gt;</td></tr><tr><td class="line-number" value="3133"></td><td class="line-content">            &lt;th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Faltan&lt;/th&gt;</td></tr><tr><td class="line-number" value="3134"></td><td class="line-content">            &lt;th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Swing&lt;/th&gt;</td></tr><tr><td class="line-number" value="3135"></td><td class="line-content">          &lt;/tr&gt;</td></tr><tr><td class="line-number" value="3136"></td><td class="line-content">        &lt;/thead&gt;</td></tr><tr><td class="line-number" value="3137"></td><td class="line-content">        &lt;tbody id="AT27_PM_tbody"&gt;&lt;/tbody&gt;</td></tr><tr><td class="line-number" value="3138"></td><td class="line-content">      &lt;/table&gt;</td></tr><tr><td class="line-number" value="3139"></td><td class="line-content">    &lt;/div&gt;</td></tr><tr><td class="line-number" value="3140"></td><td class="line-content">  `;</td></tr><tr><td class="line-number" value="3141"></td><td class="line-content">  document.body.appendChild(panel);</td></tr><tr><td class="line-number" value="3142"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3143"></td><td class="line-content">  // Wiring UI</td></tr><tr><td class="line-number" value="3144"></td><td class="line-content">  const $$ = (sel)=&gt; panel.querySelector(sel);</td></tr><tr><td class="line-number" value="3145"></td><td class="line-content">  $$('#AT27_PM_close').onclick  = ()=&gt; panel.style.display='none';</td></tr><tr><td class="line-number" value="3146"></td><td class="line-content">  $$('#AT27_PM_center').onclick = ()=&gt; (window.AT27_fitUniverseBounds? AT27_fitUniverseBounds() : null);</td></tr><tr><td class="line-number" value="3147"></td><td class="line-content">  $$('#AT27_PM_run').onclick    = ()=&gt;{ window.AT27_PM_STATE.autorun = true; AT27_PM_run(); };</td></tr><tr><td class="line-number" value="3148"></td><td class="line-content">  $$('#AT27_PM_meta').addEventListener('input', ()=&gt; $$('#AT27_PM_lblMeta').textContent = $$('#AT27_PM_meta').value + '%');</td></tr><tr><td class="line-number" value="3149"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3150"></td><td class="line-content">  // Drag &amp; evitar que tape al mapa</td></tr><tr><td class="line-number" value="3151"></td><td class="line-content">  (function drag(panelEl, handleEl){</td></tr><tr><td class="line-number" value="3152"></td><td class="line-content">    let sx=0, sy=0, ox=0, oy=0, dragging=false;</td></tr><tr><td class="line-number" value="3153"></td><td class="line-content">    handleEl.addEventListener('mousedown', e=&gt;{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panelEl.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });</td></tr><tr><td class="line-number" value="3154"></td><td class="line-content">    window.addEventListener('mousemove', e=&gt;{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panelEl.style.left=(ox+dx)+'px'; panelEl.style.top=(oy+dy)+'px'; panelEl.style.right='auto'; });</td></tr><tr><td class="line-number" value="3155"></td><td class="line-content">    window.addEventListener('mouseup', ()=&gt;{ dragging=false; document.body.style.userSelect=''; });</td></tr><tr><td class="line-number" value="3156"></td><td class="line-content">  })(panel, panel.querySelector('#AT27_PM_hdr'));</td></tr><tr><td class="line-number" value="3157"></td><td class="line-content">  if (window.L &amp;&amp; L.DomEvent){ L.DomEvent.disableClickPropagation(panel); L.DomEvent.disableScrollPropagation(panel); }</td></tr><tr><td class="line-number" value="3158"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3159"></td><td class="line-content">  // Recalcular si cambias universo (después del primer run)</td></tr><tr><td class="line-number" value="3160"></td><td class="line-content">  const map = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="3161"></td><td class="line-content">  if (map &amp;&amp; !map.__pmBound){</td></tr><tr><td class="line-number" value="3162"></td><td class="line-content">    const deb = (fn,ms=350)=&gt;{ let t; return (...a)=&gt;{ clearTimeout(t); t=setTimeout(()=&gt;fn(...a),ms); }; };</td></tr><tr><td class="line-number" value="3163"></td><td class="line-content">    map.on('layeradd',    deb(()=&gt;{ if (window.AT27_PM_STATE.autorun) AT27_PM_run(); }));</td></tr><tr><td class="line-number" value="3164"></td><td class="line-content">    map.on('layerremove', deb(()=&gt;{ if (window.AT27_PM_STATE.autorun) AT27_PM_run(); }));</td></tr><tr><td class="line-number" value="3165"></td><td class="line-content">    map.__pmBound = true;</td></tr><tr><td class="line-number" value="3166"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="3167"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="3168"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3169"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3170"></td><td class="line-content"><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="3171"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3172"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3173"></td><td class="line-content"><span class="html-tag">&lt;script&gt;</span></td></tr><tr><td class="line-number" value="3174"></td><td class="line-content">    // =======================================================</td></tr><tr><td class="line-number" value="3175"></td><td class="line-content">    // GENIALIDAD #3 · EFICIENCIA DEL VOTO (VOTOS OCIOSOS)</td></tr><tr><td class="line-number" value="3176"></td><td class="line-content">    // 2018–2024 base: usa 2024 real (no proyección). Azul = ociosos si tu partido ganó.</td></tr><tr><td class="line-number" value="3177"></td><td class="line-content">    // Rojo = déficit si tu partido perdió. Modo "votos" o "pp". Tabla y zoom.</td></tr><tr><td class="line-number" value="3178"></td><td class="line-content">    // Requiere: AT_CTX.map/layer y (si existe) AT27_GG_getUniverseSecIds().</td></tr><tr><td class="line-number" value="3179"></td><td class="line-content">    // =======================================================</td></tr><tr><td class="line-number" value="3180"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3181"></td><td class="line-content">    /* ====== Estado y utilidades ====== */</td></tr><tr><td class="line-number" value="3182"></td><td class="line-content">    window.AT27_EV_STATE  = window.AT27_EV_STATE  || { autorun:false, running:false };</td></tr><tr><td class="line-number" value="3183"></td><td class="line-content">    window.AT27_EV_LAYERS = window.AT27_EV_LAYERS || {};   // sec -&gt; layer</td></tr><tr><td class="line-number" value="3184"></td><td class="line-content">    window.AT27_EV_LAYER  = window.AT27_EV_LAYER  || null;</td></tr><tr><td class="line-number" value="3185"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3186"></td><td class="line-content">    const EV_COLORS = { SURPLUS:'#3b82f6', DEFICIT:'#ef4444', NA:'#94a3b8' }; // azul, rojo, gris</td></tr><tr><td class="line-number" value="3187"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3188"></td><td class="line-content">    // const sec4   = s =&gt; String(s||'').replace(/\D+/g,'').padStart(4,'0');</td></tr><tr><td class="line-number" value="3189"></td><td class="line-content">    // const clamp  = (x,a,b)=&gt; Math.min(b, Math.max(a, x));</td></tr><tr><td class="line-number" value="3190"></td><td class="line-content">    // const fmtInt = x =&gt; Number.isFinite(x) ? Math.round(x).toLocaleString() : '—';</td></tr><tr><td class="line-number" value="3191"></td><td class="line-content">    // const fmtpp  = x =&gt; (x===null||x===undefined) ? '—' : (Number.isFinite(+x) ? ((x&gt;0?'+':'')+(+x).toFixed(1)+' pp') : '—');</td></tr><tr><td class="line-number" value="3192"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3193"></td><td class="line-content">    function EV_getUniverseSecIds(){</td></tr><tr><td class="line-number" value="3194"></td><td class="line-content">      if (typeof AT27_GG_getUniverseSecIds==='function') return AT27_GG_getUniverseSecIds();</td></tr><tr><td class="line-number" value="3195"></td><td class="line-content">      const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];</td></tr><tr><td class="line-number" value="3196"></td><td class="line-content">      return feats.map(f=&gt; sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id));</td></tr><tr><td class="line-number" value="3197"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="3198"></td><td class="line-content">    function partVV(row){</td></tr><tr><td class="line-number" value="3199"></td><td class="line-content">      // votos válidos (usa row.VOTOS si existe; si no, suma partidos)</td></tr><tr><td class="line-number" value="3200"></td><td class="line-content">      if (!row) return 0;</td></tr><tr><td class="line-number" value="3201"></td><td class="line-content">      if (row.VOTOS!=null) return Number(row.VOTOS||0);</td></tr><tr><td class="line-number" value="3202"></td><td class="line-content">      let vv = 0; for (const [k,v] of Object.entries(row)){ if (k==='LN'||k==='VOTOS') continue; vv += Number(v||0); }</td></tr><tr><td class="line-number" value="3203"></td><td class="line-content">      return vv;</td></tr><tr><td class="line-number" value="3204"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="3205"></td><td class="line-content">    function EV_load(p){ return (window.loadPuesto? loadPuesto(p) : getElectData(p)); }</td></tr><tr><td class="line-number" value="3206"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3207"></td><td class="line-content">    /* ====== Cálculo por sección (con 2024 real) ====== */</td></tr><tr><td class="line-number" value="3208"></td><td class="line-content">    function EV_computeBySec(js, secIds, partido, modo){</td></tr><tr><td class="line-number" value="3209"></td><td class="line-content">      const X = partido.toUpperCase();</td></tr><tr><td class="line-number" value="3210"></td><td class="line-content">      const perSec = {}; // sec -&gt; { estado:'GANA'|'PIERDE', winner, v1, v2, vX, vv, ociosos, deficit, valor, mppSigned }</td></tr><tr><td class="line-number" value="3211"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3212"></td><td class="line-content">      for (const sec of secIds){</td></tr><tr><td class="line-number" value="3213"></td><td class="line-content">        const slot  = js?.secciones?.[sec4(sec)];</td></tr><tr><td class="line-number" value="3214"></td><td class="line-content">        const row24 = slot?.['2024'];</td></tr><tr><td class="line-number" value="3215"></td><td class="line-content">        if (!row24){ continue; }</td></tr><tr><td class="line-number" value="3216"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3217"></td><td class="line-content">        // votos por partido</td></tr><tr><td class="line-number" value="3218"></td><td class="line-content">        const votes = {};</td></tr><tr><td class="line-number" value="3219"></td><td class="line-content">        for (const [k,v] of Object.entries(row24)){</td></tr><tr><td class="line-number" value="3220"></td><td class="line-content">          if (k==='LN'||k==='VOTOS') continue;</td></tr><tr><td class="line-number" value="3221"></td><td class="line-content">          votes[k.toUpperCase()] = Number(v||0);</td></tr><tr><td class="line-number" value="3222"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="3223"></td><td class="line-content">        const vv = partVV(row24); if (!vv){ continue; }</td></tr><tr><td class="line-number" value="3224"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3225"></td><td class="line-content">        // ordenar para v1 (líder) y v2 (segundo)</td></tr><tr><td class="line-number" value="3226"></td><td class="line-content">        const arr = Object.entries(votes).sort((a,b)=&gt; b[1]-a[1]);</td></tr><tr><td class="line-number" value="3227"></td><td class="line-content">        const [L, v1] = arr[0] || [null,0];</td></tr><tr><td class="line-number" value="3228"></td><td class="line-content">        const v2      = (arr[1]?.[1]) ?? 0;</td></tr><tr><td class="line-number" value="3229"></td><td class="line-content">        const vX      = votes[X] || 0;</td></tr><tr><td class="line-number" value="3230"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3231"></td><td class="line-content">        const gana   = (L===X);</td></tr><tr><td class="line-number" value="3232"></td><td class="line-content">        const ociosos_v   = gana ? Math.max(0, vX - (v2 + 1)) : 0;       // sobrante al ganar</td></tr><tr><td class="line-number" value="3233"></td><td class="line-content">        const deficit_v   = gana ? 0 : Math.max(0, v1 - vX + 1);          // lo que faltó al perder</td></tr><tr><td class="line-number" value="3234"></td><td class="line-content">        const ociosos_pp  = vv? (ociosos_v / vv * 100) : 0;</td></tr><tr><td class="line-number" value="3235"></td><td class="line-content">        const deficit_pp  = vv? (deficit_v / vv * 100) : 0;</td></tr><tr><td class="line-number" value="3236"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3237"></td><td class="line-content">        // valor (para color/intensidad): positivo = ociosos; negativo = déficit</td></tr><tr><td class="line-number" value="3238"></td><td class="line-content">        const valor_v = ociosos_v - deficit_v;   // votos</td></tr><tr><td class="line-number" value="3239"></td><td class="line-content">        const valor_p = ociosos_pp - deficit_pp; // pp</td></tr><tr><td class="line-number" value="3240"></td><td class="line-content">        const valor   = (modo==='pp') ? valor_p : valor_v;</td></tr><tr><td class="line-number" value="3241"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3242"></td><td class="line-content">        // margen firmado vs rival más cercano (pp): + si gana por pp, − si pierde por pp</td></tr><tr><td class="line-number" value="3243"></td><td class="line-content">        const mppSigned = (gana ? (vX - v2) : (vX - v1)) / vv * 100;</td></tr><tr><td class="line-number" value="3244"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3245"></td><td class="line-content">        perSec[sec4(sec)] = {</td></tr><tr><td class="line-number" value="3246"></td><td class="line-content">          estado: gana? 'GANA' : 'PIERDE',</td></tr><tr><td class="line-number" value="3247"></td><td class="line-content">          winner: L, v1, v2, vX, vv,</td></tr><tr><td class="line-number" value="3248"></td><td class="line-content">          ociosos_v, deficit_v, ociosos_pp, deficit_pp,</td></tr><tr><td class="line-number" value="3249"></td><td class="line-content">          valor, mppSigned</td></tr><tr><td class="line-number" value="3250"></td><td class="line-content">        };</td></tr><tr><td class="line-number" value="3251"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="3252"></td><td class="line-content">      return perSec;</td></tr><tr><td class="line-number" value="3253"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="3254"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3255"></td><td class="line-content">    /* ====== Overlay ====== */</td></tr><tr><td class="line-number" value="3256"></td><td class="line-content">    function EV_clear(){</td></tr><tr><td class="line-number" value="3257"></td><td class="line-content">      const map = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="3258"></td><td class="line-content">      if (!map) return;</td></tr><tr><td class="line-number" value="3259"></td><td class="line-content">      if (window.AT27_EV_LAYER){ try{ map.removeLayer(AT27_EV_LAYER); }catch(_){}</td></tr><tr><td class="line-number" value="3260"></td><td class="line-content">        window.AT27_EV_LAYER=null; }</td></tr><tr><td class="line-number" value="3261"></td><td class="line-content">      window.AT27_EV_LAYERS = {};</td></tr><tr><td class="line-number" value="3262"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="3263"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3264"></td><td class="line-content">    function EV_buildOverlay(perSec, modo, cap, umbral){</td></tr><tr><td class="line-number" value="3265"></td><td class="line-content">      const map  = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="3266"></td><td class="line-content">      const base = window.AT_CTX?.layer?.toGeoJSON?.() || window.AT_DATA;</td></tr><tr><td class="line-number" value="3267"></td><td class="line-content">      if (!map || !base?.features) return;</td></tr><tr><td class="line-number" value="3268"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3269"></td><td class="line-content">      EV_clear();</td></tr><tr><td class="line-number" value="3270"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3271"></td><td class="line-content">      if (map.createPane &amp;&amp; !map.getPane('at27_ev_pane')){</td></tr><tr><td class="line-number" value="3272"></td><td class="line-content">        map.createPane('at27_ev_pane');</td></tr><tr><td class="line-number" value="3273"></td><td class="line-content">        const p = map.getPane('at27_ev_pane'); p.style.zIndex=700; p.style.pointerEvents='auto';</td></tr><tr><td class="line-number" value="3274"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="3275"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3276"></td><td class="line-content">      const feats = base.features.filter(f=&gt;{</td></tr><tr><td class="line-number" value="3277"></td><td class="line-content">        const id = sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);</td></tr><tr><td class="line-number" value="3278"></td><td class="line-content">        return perSec[id]!=null;</td></tr><tr><td class="line-number" value="3279"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="3280"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3281"></td><td class="line-content">      const layer = L.geoJSON({type:'FeatureCollection', features:feats}, {</td></tr><tr><td class="line-number" value="3282"></td><td class="line-content">        pane:'at27_ev_pane',</td></tr><tr><td class="line-number" value="3283"></td><td class="line-content">        style: f=&gt;{</td></tr><tr><td class="line-number" value="3284"></td><td class="line-content">          const id = sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);</td></tr><tr><td class="line-number" value="3285"></td><td class="line-content">          const info = perSec[id];</td></tr><tr><td class="line-number" value="3286"></td><td class="line-content">          if (!info) return { color:EV_COLORS.NA, fillColor:EV_COLORS.NA, weight:1, fillOpacity:.2, opacity:.6 };</td></tr><tr><td class="line-number" value="3287"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3288"></td><td class="line-content">          const val  = info.valor; // positivo (ociosos), negativo (déficit)</td></tr><tr><td class="line-number" value="3289"></td><td class="line-content">          const sign = val&gt;=0 ? 1 : -1;</td></tr><tr><td class="line-number" value="3290"></td><td class="line-content">          const mag  = Math.min(1, Math.abs(val) / Math.max(1, cap)); // 0..1</td></tr><tr><td class="line-number" value="3291"></td><td class="line-content">          const col  = sign&gt;0 ? EV_COLORS.SURPLUS : EV_COLORS.DEFICIT;</td></tr><tr><td class="line-number" value="3292"></td><td class="line-content">          const fo   = 0.20 + mag*0.50;</td></tr><tr><td class="line-number" value="3293"></td><td class="line-content">          return { color: col, fillColor: col, weight:1, opacity:.9, fillOpacity: fo };</td></tr><tr><td class="line-number" value="3294"></td><td class="line-content">        },</td></tr><tr><td class="line-number" value="3295"></td><td class="line-content">        onEachFeature: (feature, lyr)=&gt;{</td></tr><tr><td class="line-number" value="3296"></td><td class="line-content">          const id = sec4(feature.properties?.ID ?? feature.properties?.SECCION ?? feature.properties?.id);</td></tr><tr><td class="line-number" value="3297"></td><td class="line-content">          window.AT27_EV_LAYERS[id] = lyr;</td></tr><tr><td class="line-number" value="3298"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3299"></td><td class="line-content">          const x = perSec[id];</td></tr><tr><td class="line-number" value="3300"></td><td class="line-content">          const oTxt = (modo==='pp') ? fmtpp(x?.ociosos_pp) : fmtInt(x?.ociosos_v);</td></tr><tr><td class="line-number" value="3301"></td><td class="line-content">          const dTxt = (modo==='pp') ? fmtpp(x?.deficit_pp) : fmtInt(x?.deficit_v);</td></tr><tr><td class="line-number" value="3302"></td><td class="line-content">          const mTxt = fmtpp(x?.mppSigned);</td></tr><tr><td class="line-number" value="3303"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3304"></td><td class="line-content">          const tip = `</td></tr><tr><td class="line-number" value="3305"></td><td class="line-content">            &lt;div style="font-size:12px;"&gt;</td></tr><tr><td class="line-number" value="3306"></td><td class="line-content">              Sección &lt;b&gt;${id}&lt;/b&gt;&lt;br&gt;</td></tr><tr><td class="line-number" value="3307"></td><td class="line-content">              Estado: &lt;b&gt;${x?.estado||'—'}&lt;/b&gt; · Ganador 2024: &lt;b&gt;${x?.winner||'—'}&lt;/b&gt;&lt;br&gt;</td></tr><tr><td class="line-number" value="3308"></td><td class="line-content">              Ociosos: &lt;b&gt;${oTxt}&lt;/b&gt; · Déficit: &lt;b&gt;${dTxt}&lt;/b&gt;&lt;br&gt;</td></tr><tr><td class="line-number" value="3309"></td><td class="line-content">              Margen firmado (pp): &lt;b&gt;${mTxt}&lt;/b&gt;</td></tr><tr><td class="line-number" value="3310"></td><td class="line-content">            &lt;/div&gt;`;</td></tr><tr><td class="line-number" value="3311"></td><td class="line-content">          lyr.bindTooltip(tip, {sticky:true, opacity:.95, direction:'top', className:'at27-tt'});</td></tr><tr><td class="line-number" value="3312"></td><td class="line-content">          lyr.on('mouseover', ()=&gt;lyr.setStyle({weight:2}));</td></tr><tr><td class="line-number" value="3313"></td><td class="line-content">          lyr.on('mouseout',  ()=&gt;lyr.setStyle({weight:1}));</td></tr><tr><td class="line-number" value="3314"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="3315"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="3316"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3317"></td><td class="line-content">      layer.addTo(map);</td></tr><tr><td class="line-number" value="3318"></td><td class="line-content">      window.AT27_EV_LAYER = layer;</td></tr><tr><td class="line-number" value="3319"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="3320"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3321"></td><td class="line-content">    /* ====== Tabla + resumen ====== */</td></tr><tr><td class="line-number" value="3322"></td><td class="line-content">    function EV_renderSummary(perSec, modo){</td></tr><tr><td class="line-number" value="3323"></td><td class="line-content">      const el = document.getElementById('AT27_EV_summary');</td></tr><tr><td class="line-number" value="3324"></td><td class="line-content">      let sumO=0, sumD=0, n=0, gana=0, pierde=0;</td></tr><tr><td class="line-number" value="3325"></td><td class="line-content">      Object.values(perSec).forEach(x=&gt;{</td></tr><tr><td class="line-number" value="3326"></td><td class="line-content">        if (!x) return;</td></tr><tr><td class="line-number" value="3327"></td><td class="line-content">        n++;</td></tr><tr><td class="line-number" value="3328"></td><td class="line-content">        if (x.estado==='GANA'){ gana++; sumO += (modo==='pp'? x.ociosos_pp : x.ociosos_v); }</td></tr><tr><td class="line-number" value="3329"></td><td class="line-content">        else { pierde++;       sumD += (modo==='pp'? x.deficit_pp : x.deficit_v); }</td></tr><tr><td class="line-number" value="3330"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="3331"></td><td class="line-content">      const unit = (modo==='pp') ? ' pp' : '';</td></tr><tr><td class="line-number" value="3332"></td><td class="line-content">      el.innerHTML = `</td></tr><tr><td class="line-number" value="3333"></td><td class="line-content">        &lt;div style="font-size:12px; line-height:1.35;"&gt;</td></tr><tr><td class="line-number" value="3334"></td><td class="line-content">          &lt;div&gt;&lt;span style="display:inline-block;width:10px;height:10px;background:${EV_COLORS.SURPLUS};border-radius:2px;"&gt;&lt;/span&gt; &lt;b&gt;Ociosos&lt;/b&gt; (se ganó): ${modo==='pp'? fmtpp(sumO) : fmtInt(sumO)}&lt;/div&gt;</td></tr><tr><td class="line-number" value="3335"></td><td class="line-content">          &lt;div&gt;&lt;span style="display:inline-block;width:10px;height:10px;background:${EV_COLORS.DEFICIT};border-radius:2px;"&gt;&lt;/span&gt; &lt;b&gt;Déficit&lt;/b&gt; (se perdió): ${modo==='pp'? fmtpp(sumD) : fmtInt(sumD)}&lt;/div&gt;</td></tr><tr><td class="line-number" value="3336"></td><td class="line-content">          &lt;div style="margin-top:6px;"&gt;Secciones: &lt;b&gt;${n}&lt;/b&gt; · Gana: &lt;b&gt;${gana}&lt;/b&gt; · Pierde: &lt;b&gt;${pierde}&lt;/b&gt;&lt;/div&gt;</td></tr><tr><td class="line-number" value="3337"></td><td class="line-content">        &lt;/div&gt;`;</td></tr><tr><td class="line-number" value="3338"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="3339"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3340"></td><td class="line-content">    function EV_renderTable(perSec, modo){</td></tr><tr><td class="line-number" value="3341"></td><td class="line-content">      const tb = document.getElementById('AT27_EV_tbody');</td></tr><tr><td class="line-number" value="3342"></td><td class="line-content">      const rows = Object.entries(perSec).map(([sec,x])=&gt;{</td></tr><tr><td class="line-number" value="3343"></td><td class="line-content">        const o = (modo==='pp') ? x.ociosos_pp : x.ociosos_v;</td></tr><tr><td class="line-number" value="3344"></td><td class="line-content">        const d = (modo==='pp') ? x.deficit_pp : x.deficit_v;</td></tr><tr><td class="line-number" value="3345"></td><td class="line-content">        return { sec, estado:x.estado, winner:x.winner, o, d, mpp:x.mppSigned };</td></tr><tr><td class="line-number" value="3346"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="3347"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3348"></td><td class="line-content">      // Orden: primero pérdidas por déficit asc (más volteables), luego ganancias por ociosos desc.</td></tr><tr><td class="line-number" value="3349"></td><td class="line-content">      rows.sort((a,b)=&gt;{</td></tr><tr><td class="line-number" value="3350"></td><td class="line-content">        const aKey = (a.estado==='PIERDE') ? 0 : 1;</td></tr><tr><td class="line-number" value="3351"></td><td class="line-content">        const bKey = (b.estado==='PIERDE') ? 0 : 1;</td></tr><tr><td class="line-number" value="3352"></td><td class="line-content">        if (aKey!==bKey) return aKey-bKey;</td></tr><tr><td class="line-number" value="3353"></td><td class="line-content">        return (a.estado==='PIERDE')</td></tr><tr><td class="line-number" value="3354"></td><td class="line-content">          ? (a.d - b.d) || (Number(a.sec)-Number(b.sec))</td></tr><tr><td class="line-number" value="3355"></td><td class="line-content">          : (b.o - a.o) || (Number(a.sec)-Number(b.sec));</td></tr><tr><td class="line-number" value="3356"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="3357"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3358"></td><td class="line-content">      tb.innerHTML = rows.map(r=&gt;{</td></tr><tr><td class="line-number" value="3359"></td><td class="line-content">        const bg = r.estado==='PIERDE' ? '#fee2e2' : '#dbeafe';</td></tr><tr><td class="line-number" value="3360"></td><td class="line-content">        return `</td></tr><tr><td class="line-number" value="3361"></td><td class="line-content">          &lt;tr data-sec="${r.sec}" style="background:${bg}; cursor:pointer;"&gt;</td></tr><tr><td class="line-number" value="3362"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;"&gt;${r.sec}&lt;/td&gt;</td></tr><tr><td class="line-number" value="3363"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;"&gt;${r.estado}&lt;/td&gt;</td></tr><tr><td class="line-number" value="3364"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;"&gt;${r.winner||'—'}&lt;/td&gt;</td></tr><tr><td class="line-number" value="3365"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;"&gt;${modo==='pp'? fmtpp(r.o) : fmtInt(r.o)}&lt;/td&gt;</td></tr><tr><td class="line-number" value="3366"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;"&gt;${modo==='pp'? fmtpp(r.d) : fmtInt(r.d)}&lt;/td&gt;</td></tr><tr><td class="line-number" value="3367"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;"&gt;${fmtpp(r.mpp)}&lt;/td&gt;</td></tr><tr><td class="line-number" value="3368"></td><td class="line-content">          &lt;/tr&gt;`;</td></tr><tr><td class="line-number" value="3369"></td><td class="line-content">      }).join('');</td></tr><tr><td class="line-number" value="3370"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3371"></td><td class="line-content">      tb.onclick = (e)=&gt;{</td></tr><tr><td class="line-number" value="3372"></td><td class="line-content">        const tr = e.target.closest('tr[data-sec]'); if (!tr) return;</td></tr><tr><td class="line-number" value="3373"></td><td class="line-content">        EV_focus(tr.getAttribute('data-sec'));</td></tr><tr><td class="line-number" value="3374"></td><td class="line-content">      };</td></tr><tr><td class="line-number" value="3375"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="3376"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3377"></td><td class="line-content">    function EV_focus(sec){</td></tr><tr><td class="line-number" value="3378"></td><td class="line-content">      const id = sec4(sec);</td></tr><tr><td class="line-number" value="3379"></td><td class="line-content">      const lyr = window.AT27_EV_LAYERS[id];</td></tr><tr><td class="line-number" value="3380"></td><td class="line-content">      const map = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="3381"></td><td class="line-content">      if (!map) return;</td></tr><tr><td class="line-number" value="3382"></td><td class="line-content">      if (lyr){</td></tr><tr><td class="line-number" value="3383"></td><td class="line-content">        try{ map.fitBounds(lyr.getBounds(), {maxZoom:16, padding:[20,20]}); }catch(_){}</td></tr><tr><td class="line-number" value="3384"></td><td class="line-content">        if (lyr.openTooltip) lyr.openTooltip();</td></tr><tr><td class="line-number" value="3385"></td><td class="line-content">        const origFO = lyr.options.fillOpacity ?? .35;</td></tr><tr><td class="line-number" value="3386"></td><td class="line-content">        lyr.setStyle({weight:3, fillOpacity: Math.min(.95, origFO+.25)});</td></tr><tr><td class="line-number" value="3387"></td><td class="line-content">        setTimeout(()=&gt; lyr.setStyle({weight:1, fillOpacity: origFO}), 900);</td></tr><tr><td class="line-number" value="3388"></td><td class="line-content">        return;</td></tr><tr><td class="line-number" value="3389"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="3390"></td><td class="line-content">      // fallback</td></tr><tr><td class="line-number" value="3391"></td><td class="line-content">      const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];</td></tr><tr><td class="line-number" value="3392"></td><td class="line-content">      const f = feats.find(ft=&gt; sec4(ft.properties?.ID ?? ft.properties?.SECCION ?? ft.properties?.id)===id);</td></tr><tr><td class="line-number" value="3393"></td><td class="line-content">      if (f){ const tmp=L.geoJSON(f); map.fitBounds(tmp.getBounds(), {maxZoom:16, padding:[20,20]}); }</td></tr><tr><td class="line-number" value="3394"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="3395"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3396"></td><td class="line-content">    /* ====== RUN principal ====== */</td></tr><tr><td class="line-number" value="3397"></td><td class="line-content">    async function AT27_EV_run(){</td></tr><tr><td class="line-number" value="3398"></td><td class="line-content">      if (window.AT27_EV_STATE.running) return;</td></tr><tr><td class="line-number" value="3399"></td><td class="line-content">      window.AT27_EV_STATE.running = true;</td></tr><tr><td class="line-number" value="3400"></td><td class="line-content">      try{</td></tr><tr><td class="line-number" value="3401"></td><td class="line-content">        const puesto  = document.getElementById('AT27_EV_selPuesto').value;</td></tr><tr><td class="line-number" value="3402"></td><td class="line-content">        const partido = document.getElementById('AT27_EV_selPartido').value.toUpperCase();</td></tr><tr><td class="line-number" value="3403"></td><td class="line-content">        const modo    = document.querySelector('input[name="AT27_EV_modo"]:checked').value; // 'votos' | 'pp'</td></tr><tr><td class="line-number" value="3404"></td><td class="line-content">        const cap     = Number(document.getElementById('AT27_EV_cap').value || (modo==='pp'? 10 : 1000)); // saturación color</td></tr><tr><td class="line-number" value="3405"></td><td class="line-content">        const umbral  = Number(document.getElementById('AT27_EV_umbral').value || 0); // sobrante mínimo para resaltar (solo visual)</td></tr><tr><td class="line-number" value="3406"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3407"></td><td class="line-content">        const secIds = EV_getUniverseSecIds();</td></tr><tr><td class="line-number" value="3408"></td><td class="line-content">        if (!secIds.length){ EV_clear(); document.getElementById('AT27_EV_tbody').innerHTML=''; return; }</td></tr><tr><td class="line-number" value="3409"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3410"></td><td class="line-content">        const js = await EV_load(puesto);</td></tr><tr><td class="line-number" value="3411"></td><td class="line-content">        const perSecAll = EV_computeBySec(js, secIds, partido, modo);</td></tr><tr><td class="line-number" value="3412"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3413"></td><td class="line-content">        // Opcional: "umbral" solo afecta color (suaviza si ociosos &lt; umbral)</td></tr><tr><td class="line-number" value="3414"></td><td class="line-content">        const perSec = {};</td></tr><tr><td class="line-number" value="3415"></td><td class="line-content">        Object.entries(perSecAll).forEach(([k,x])=&gt;{</td></tr><tr><td class="line-number" value="3416"></td><td class="line-content">          if (!x) return;</td></tr><tr><td class="line-number" value="3417"></td><td class="line-content">          let val = x.valor;</td></tr><tr><td class="line-number" value="3418"></td><td class="line-content">          if (modo==='pp'){</td></tr><tr><td class="line-number" value="3419"></td><td class="line-content">            const o = x.ociosos_pp, d = x.deficit_pp;</td></tr><tr><td class="line-number" value="3420"></td><td class="line-content">            if (o&gt;0 &amp;&amp; o &lt; umbral) val = val * 0.25; // suavizar</td></tr><tr><td class="line-number" value="3421"></td><td class="line-content">          }else{</td></tr><tr><td class="line-number" value="3422"></td><td class="line-content">            const o = x.ociosos_v;</td></tr><tr><td class="line-number" value="3423"></td><td class="line-content">            if (o&gt;0 &amp;&amp; o &lt; umbral) val = val * 0.25;</td></tr><tr><td class="line-number" value="3424"></td><td class="line-content">          }</td></tr><tr><td class="line-number" value="3425"></td><td class="line-content">          perSec[k] = { ...x, valor: val };</td></tr><tr><td class="line-number" value="3426"></td><td class="line-content">        });</td></tr><tr><td class="line-number" value="3427"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3428"></td><td class="line-content">        EV_buildOverlay(perSec, modo, cap, umbral);</td></tr><tr><td class="line-number" value="3429"></td><td class="line-content">        EV_renderSummary(perSec, modo);</td></tr><tr><td class="line-number" value="3430"></td><td class="line-content">        EV_renderTable(perSec, modo);</td></tr><tr><td class="line-number" value="3431"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3432"></td><td class="line-content">      }catch(e){</td></tr><tr><td class="line-number" value="3433"></td><td class="line-content">        console.error('AT27_EV_run', e);</td></tr><tr><td class="line-number" value="3434"></td><td class="line-content">        alert('No pude ejecutar “Eficiencia del voto”.');</td></tr><tr><td class="line-number" value="3435"></td><td class="line-content">      }finally{</td></tr><tr><td class="line-number" value="3436"></td><td class="line-content">        window.AT27_EV_STATE.running = false;</td></tr><tr><td class="line-number" value="3437"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="3438"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="3439"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3440"></td><td class="line-content">    /* ====== Panel UI ====== */</td></tr><tr><td class="line-number" value="3441"></td><td class="line-content">    function AT27_EV_open(){</td></tr><tr><td class="line-number" value="3442"></td><td class="line-content">      let panel = document.getElementById('AT27_EV_panel');</td></tr><tr><td class="line-number" value="3443"></td><td class="line-content">      if (panel){ panel.style.display='block'; return; }</td></tr><tr><td class="line-number" value="3444"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3445"></td><td class="line-content">      panel = document.createElement('div');</td></tr><tr><td class="line-number" value="3446"></td><td class="line-content">      panel.id = 'AT27_EV_panel';</td></tr><tr><td class="line-number" value="3447"></td><td class="line-content">      Object.assign(panel.style,{</td></tr><tr><td class="line-number" value="3448"></td><td class="line-content">        position:'fixed', right:'24px', top:'24px', zIndex:9998,</td></tr><tr><td class="line-number" value="3449"></td><td class="line-content">        width:'560px', maxWidth:'calc(100vw - 40px)', maxHeight:'calc(100vh - 40px)',</td></tr><tr><td class="line-number" value="3450"></td><td class="line-content">        background:'#fff', border:'1px solid #e5e7eb', borderRadius:'14px',</td></tr><tr><td class="line-number" value="3451"></td><td class="line-content">        boxShadow:'0 18px 40px rgba(0,0,0,.18)', display:'flex', flexDirection:'column',</td></tr><tr><td class="line-number" value="3452"></td><td class="line-content">        overflow:'hidden', resize:'both', minWidth:'380px', minHeight:'280px'</td></tr><tr><td class="line-number" value="3453"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="3454"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3455"></td><td class="line-content">      panel.innerHTML = `</td></tr><tr><td class="line-number" value="3456"></td><td class="line-content">        &lt;div id="AT27_EV_hdr" style="cursor:move; user-select:none; background:#e0f2fe; color:#111; padding:10px 12px; display:flex; gap:10px; align-items:center;"&gt;</td></tr><tr><td class="line-number" value="3457"></td><td class="line-content">          &lt;div style="font-weight:800;"&gt;Eficiencia del voto (votos ociosos)&lt;/div&gt;</td></tr><tr><td class="line-number" value="3458"></td><td class="line-content">          &lt;button id="AT27_EV_center" style="margin-left:auto; background:#eef2ff; border:1px solid #c7d2fe; border-radius:8px; padding:4px 8px; cursor:pointer;"&gt;Recentrar&lt;/button&gt;</td></tr><tr><td class="line-number" value="3459"></td><td class="line-content">          &lt;button id="AT27_EV_close" title="Cerrar" style="background:transparent;border:none;font-size:18px;cursor:pointer;"&gt;×&lt;/button&gt;</td></tr><tr><td class="line-number" value="3460"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="3461"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3462"></td><td class="line-content">        &lt;div style="padding:10px 12px; display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:end;"&gt;</td></tr><tr><td class="line-number" value="3463"></td><td class="line-content">          &lt;label style="font-size:12px;"&gt;Puesto&lt;br&gt;</td></tr><tr><td class="line-number" value="3464"></td><td class="line-content">            &lt;select id="AT27_EV_selPuesto" class="ttb-select" style="width:100%;"&gt;</td></tr><tr><td class="line-number" value="3465"></td><td class="line-content">              &lt;option value="A"&gt;Ayuntamiento&lt;/option&gt;</td></tr><tr><td class="line-number" value="3466"></td><td class="line-content">              &lt;option value="DL"&gt;Diputado Local&lt;/option&gt;</td></tr><tr><td class="line-number" value="3467"></td><td class="line-content">              &lt;option value="DF"&gt;Diputado Federal&lt;/option&gt;</td></tr><tr><td class="line-number" value="3468"></td><td class="line-content">            &lt;/select&gt;</td></tr><tr><td class="line-number" value="3469"></td><td class="line-content">          &lt;/label&gt;</td></tr><tr><td class="line-number" value="3470"></td><td class="line-content">          &lt;label style="font-size:12px;"&gt;Partido&lt;br&gt;</td></tr><tr><td class="line-number" value="3471"></td><td class="line-content">            &lt;select id="AT27_EV_selPartido" class="ttb-select" style="width:100%;"&gt;</td></tr><tr><td class="line-number" value="3472"></td><td class="line-content">              &lt;option&gt;PAN&lt;/option&gt;&lt;option&gt;PRI&lt;/option&gt;&lt;option&gt;PVEM&lt;/option&gt;&lt;option&gt;MORENA&lt;/option&gt;</td></tr><tr><td class="line-number" value="3473"></td><td class="line-content">            &lt;/select&gt;</td></tr><tr><td class="line-number" value="3474"></td><td class="line-content">          &lt;/label&gt;</td></tr><tr><td class="line-number" value="3475"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3476"></td><td class="line-content">          &lt;div style="grid-column:1 / span 2; display:flex; gap:16px; align-items:center; font-size:12px;"&gt;</td></tr><tr><td class="line-number" value="3477"></td><td class="line-content">            Modo:</td></tr><tr><td class="line-number" value="3478"></td><td class="line-content">            &lt;label&gt;&lt;input type="radio" name="AT27_EV_modo" value="votos" checked&gt; votos&lt;/label&gt;</td></tr><tr><td class="line-number" value="3479"></td><td class="line-content">            &lt;label&gt;&lt;input type="radio" name="AT27_EV_modo" value="pp"&gt; pp&lt;/label&gt;</td></tr><tr><td class="line-number" value="3480"></td><td class="line-content">            &lt;span style="opacity:.7;"&gt;· Cap color&lt;/span&gt;</td></tr><tr><td class="line-number" value="3481"></td><td class="line-content">            &lt;input id="AT27_EV_cap" type="number" value="1000" style="width:90px; padding:4px 6px; border:1px solid #e5e7eb; border-radius:8px;"&gt;</td></tr><tr><td class="line-number" value="3482"></td><td class="line-content">            &lt;span style="opacity:.7;"&gt;· Umbral sobrante&lt;/span&gt;</td></tr><tr><td class="line-number" value="3483"></td><td class="line-content">            &lt;input id="AT27_EV_umbral" type="number" value="50" style="width:90px; padding:4px 6px; border:1px solid #e5e7eb; border-radius:8px;"&gt;</td></tr><tr><td class="line-number" value="3484"></td><td class="line-content">          &lt;/div&gt;</td></tr><tr><td class="line-number" value="3485"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3486"></td><td class="line-content">          &lt;button id="AT27_EV_run" class="ttb-btn ttb-primary" style="grid-column:1 / span 2;"&gt;Ejecutar&lt;/button&gt;</td></tr><tr><td class="line-number" value="3487"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="3488"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3489"></td><td class="line-content">        &lt;div style="padding:8px 12px;"&gt;</td></tr><tr><td class="line-number" value="3490"></td><td class="line-content">          &lt;div id="AT27_EV_legend" style="font-size:12px; display:flex; gap:12px; align-items:center; margin-bottom:6px;"&gt;</td></tr><tr><td class="line-number" value="3491"></td><td class="line-content">            &lt;span&gt;&lt;span style="display:inline-block;width:10px;height:10px;background:${EV_COLORS.SURPLUS};border-radius:2px;"&gt;&lt;/span&gt; Ociosos (ganadas)&lt;/span&gt;</td></tr><tr><td class="line-number" value="3492"></td><td class="line-content">            &lt;span&gt;&lt;span style="display:inline-block;width:10px;height:10px;background:${EV_COLORS.DEFICIT};border-radius:2px;"&gt;&lt;/span&gt; Déficit (perdidas)&lt;/span&gt;</td></tr><tr><td class="line-number" value="3493"></td><td class="line-content">          &lt;/div&gt;</td></tr><tr><td class="line-number" value="3494"></td><td class="line-content">          &lt;div id="AT27_EV_summary" style="font-size:12px; color:#334155;"&gt;&lt;/div&gt;</td></tr><tr><td class="line-number" value="3495"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="3496"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3497"></td><td class="line-content">        &lt;div style="flex:1; overflow:auto;"&gt;</td></tr><tr><td class="line-number" value="3498"></td><td class="line-content">          &lt;table style="width:100%; border-collapse:collapse; font-size:12px;"&gt;</td></tr><tr><td class="line-number" value="3499"></td><td class="line-content">            &lt;thead&gt;</td></tr><tr><td class="line-number" value="3500"></td><td class="line-content">              &lt;tr style="position:sticky; top:0; background:#f8fafc;"&gt;</td></tr><tr><td class="line-number" value="3501"></td><td class="line-content">                &lt;th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Sección&lt;/th&gt;</td></tr><tr><td class="line-number" value="3502"></td><td class="line-content">                &lt;th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Estado&lt;/th&gt;</td></tr><tr><td class="line-number" value="3503"></td><td class="line-content">                &lt;th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Ganador 2024&lt;/th&gt;</td></tr><tr><td class="line-number" value="3504"></td><td class="line-content">                &lt;th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Ociosos&lt;/th&gt;</td></tr><tr><td class="line-number" value="3505"></td><td class="line-content">                &lt;th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Déficit&lt;/th&gt;</td></tr><tr><td class="line-number" value="3506"></td><td class="line-content">                &lt;th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Margen (pp)&lt;/th&gt;</td></tr><tr><td class="line-number" value="3507"></td><td class="line-content">              &lt;/tr&gt;</td></tr><tr><td class="line-number" value="3508"></td><td class="line-content">            &lt;/thead&gt;</td></tr><tr><td class="line-number" value="3509"></td><td class="line-content">            &lt;tbody id="AT27_EV_tbody"&gt;&lt;/tbody&gt;</td></tr><tr><td class="line-number" value="3510"></td><td class="line-content">          &lt;/table&gt;</td></tr><tr><td class="line-number" value="3511"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="3512"></td><td class="line-content">      `;</td></tr><tr><td class="line-number" value="3513"></td><td class="line-content">      document.body.appendChild(panel);</td></tr><tr><td class="line-number" value="3514"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3515"></td><td class="line-content">      // Wiring UI</td></tr><tr><td class="line-number" value="3516"></td><td class="line-content">      const $$ = (sel)=&gt; panel.querySelector(sel);</td></tr><tr><td class="line-number" value="3517"></td><td class="line-content">      $$('#AT27_EV_close').onclick  = ()=&gt; panel.style.display='none';</td></tr><tr><td class="line-number" value="3518"></td><td class="line-content">      $$('#AT27_EV_center').onclick = ()=&gt; (window.AT27_fitUniverseBounds? AT27_fitUniverseBounds() : null);</td></tr><tr><td class="line-number" value="3519"></td><td class="line-content">      $$('#AT27_EV_run').onclick    = ()=&gt;{ window.AT27_EV_STATE.autorun = true; AT27_EV_run(); };</td></tr><tr><td class="line-number" value="3520"></td><td class="line-content">      panel.querySelectorAll('input[name="AT27_EV_modo"]').forEach(r=&gt;{</td></tr><tr><td class="line-number" value="3521"></td><td class="line-content">        r.addEventListener('change', ()=&gt;{</td></tr><tr><td class="line-number" value="3522"></td><td class="line-content">          // Ajuste de cap por modo</td></tr><tr><td class="line-number" value="3523"></td><td class="line-content">          const modo = panel.querySelector('input[name="AT27_EV_modo"]:checked').value;</td></tr><tr><td class="line-number" value="3524"></td><td class="line-content">          if (modo==='pp' &amp;&amp; Number($$('#AT27_EV_cap').value)&gt;50) $$('#AT27_EV_cap').value = 10;</td></tr><tr><td class="line-number" value="3525"></td><td class="line-content">          if (modo==='votos' &amp;&amp; Number($$('#AT27_EV_cap').value)&lt;50) $$('#AT27_EV_cap').value = 1000;</td></tr><tr><td class="line-number" value="3526"></td><td class="line-content">        });</td></tr><tr><td class="line-number" value="3527"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="3528"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3529"></td><td class="line-content">      // Drag &amp; bloquear eventos al mapa</td></tr><tr><td class="line-number" value="3530"></td><td class="line-content">      (function drag(panelEl, handleEl){</td></tr><tr><td class="line-number" value="3531"></td><td class="line-content">        let sx=0, sy=0, ox=0, oy=0, dragging=false;</td></tr><tr><td class="line-number" value="3532"></td><td class="line-content">        handleEl.addEventListener('mousedown', e=&gt;{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panelEl.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });</td></tr><tr><td class="line-number" value="3533"></td><td class="line-content">        window.addEventListener('mousemove', e=&gt;{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panelEl.style.left=(ox+dx)+'px'; panelEl.style.top=(oy+dy)+'px'; panelEl.style.right='auto'; });</td></tr><tr><td class="line-number" value="3534"></td><td class="line-content">        window.addEventListener('mouseup', ()=&gt;{ dragging=false; document.body.style.userSelect=''; });</td></tr><tr><td class="line-number" value="3535"></td><td class="line-content">      })(panel, panel.querySelector('#AT27_EV_hdr'));</td></tr><tr><td class="line-number" value="3536"></td><td class="line-content">      if (window.L &amp;&amp; L.DomEvent){ L.DomEvent.disableClickPropagation(panel); L.DomEvent.disableScrollPropagation(panel); }</td></tr><tr><td class="line-number" value="3537"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3538"></td><td class="line-content">      // Recalcular si cambias universo (tras primer run)</td></tr><tr><td class="line-number" value="3539"></td><td class="line-content">      const map = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="3540"></td><td class="line-content">      if (map &amp;&amp; !map.__evBound){</td></tr><tr><td class="line-number" value="3541"></td><td class="line-content">        const deb = (fn,ms=350)=&gt;{ let t; return (...a)=&gt;{ clearTimeout(t); t=setTimeout(()=&gt;fn(...a),ms); }; };</td></tr><tr><td class="line-number" value="3542"></td><td class="line-content">        map.on('layeradd',    deb(()=&gt;{ if (window.AT27_EV_STATE.autorun) AT27_EV_run(); }));</td></tr><tr><td class="line-number" value="3543"></td><td class="line-content">        map.on('layerremove', deb(()=&gt;{ if (window.AT27_EV_STATE.autorun) AT27_EV_run(); }));</td></tr><tr><td class="line-number" value="3544"></td><td class="line-content">        map.__evBound = true;</td></tr><tr><td class="line-number" value="3545"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="3546"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="3547"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3548"></td><td class="line-content"><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="3549"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3550"></td><td class="line-content"><span class="html-tag">&lt;script&gt;</span></td></tr><tr><td class="line-number" value="3551"></td><td class="line-content">    // =======================================================</td></tr><tr><td class="line-number" value="3552"></td><td class="line-content">    // GENIALIDAD #4 · CORREDORES DE VOLTEO (CLUSTERS CONTIGUOS)</td></tr><tr><td class="line-number" value="3553"></td><td class="line-content">    // Agrupa secciones contiguas con brecha pequeña (por votos o pp) para operarlas en bloque.</td></tr><tr><td class="line-number" value="3554"></td><td class="line-content">    // Requiere: AT27_GG_project2027, AT27_GG_shares2024, loadPuesto/getElectData,</td></tr><tr><td class="line-number" value="3555"></td><td class="line-content">    //           AT_CTX.map, AT_CTX.layer y (si existe) AT27_GG_getUniverseSecIds().</td></tr><tr><td class="line-number" value="3556"></td><td class="line-content">    // =======================================================</td></tr><tr><td class="line-number" value="3557"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3558"></td><td class="line-content">    /* ====== Estado y utilidades ====== */</td></tr><tr><td class="line-number" value="3559"></td><td class="line-content">    window.AT27_CV_STATE   = window.AT27_CV_STATE   || { autorun:false, running:false };</td></tr><tr><td class="line-number" value="3560"></td><td class="line-content">    window.AT27_CV_LAYER   = window.AT27_CV_LAYER   || null;  // layer GeoJSON de clusters</td></tr><tr><td class="line-number" value="3561"></td><td class="line-content">    window.AT27_CV_LAYERS  = window.AT27_CV_LAYERS  || {};    // sec -&gt; layer (por zoom)</td></tr><tr><td class="line-number" value="3562"></td><td class="line-content">    window.AT27_CV_CLUSTERS= window.AT27_CV_CLUSTERS|| [];     // [{id, secs:Set, bounds, sumFaltan, avgPP, maxPP}]</td></tr><tr><td class="line-number" value="3563"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3564"></td><td class="line-content">    //const sec4   = (s)=&gt; String(s||'').replace(/\D+/g,'').padStart(4,'0');</td></tr><tr><td class="line-number" value="3565"></td><td class="line-content">    //const clamp  = (x,a,b)=&gt; Math.min(b, Math.max(a, x));</td></tr><tr><td class="line-number" value="3566"></td><td class="line-content">    //const fmtInt = (x)=&gt; Number.isFinite(x)? Math.round(x).toLocaleString() : '—';</td></tr><tr><td class="line-number" value="3567"></td><td class="line-content">    //const fmtpp  = (x)=&gt; (x===null||x===undefined) ? '—' : (Number.isFinite(+x) ? ((x&gt;0?'+':'')+(+x).toFixed(1)+' pp') : '—');</td></tr><tr><td class="line-number" value="3568"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3569"></td><td class="line-content">    function CV_getUniverseSecIds(){</td></tr><tr><td class="line-number" value="3570"></td><td class="line-content">      if (typeof AT27_GG_getUniverseSecIds==='function') return AT27_GG_getUniverseSecIds();</td></tr><tr><td class="line-number" value="3571"></td><td class="line-content">      const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];</td></tr><tr><td class="line-number" value="3572"></td><td class="line-content">      return feats.map(f=&gt; sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id));</td></tr><tr><td class="line-number" value="3573"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="3574"></td><td class="line-content">    async function CV_load(p){ return (window.loadPuesto? loadPuesto(p) : getElectData(p)); }</td></tr><tr><td class="line-number" value="3575"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3576"></td><td class="line-content">    function getBaseGeoJSON(){</td></tr><tr><td class="line-number" value="3577"></td><td class="line-content">      return window.AT_CTX?.layer?.toGeoJSON?.() || window.AT_DATA || { type:'FeatureCollection', features:[] };</td></tr><tr><td class="line-number" value="3578"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="3579"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3580"></td><td class="line-content">    /* ====== Cálculo por sección (base 2027) ======</td></tr><tr><td class="line-number" value="3581"></td><td class="line-content">      Produce para cada sección:</td></tr><tr><td class="line-number" value="3582"></td><td class="line-content">      - faltan (votos para rebasar),</td></tr><tr><td class="line-number" value="3583"></td><td class="line-content">      - gapPP (pp relativas = (vL − vX)/Vproj * 100),</td></tr><tr><td class="line-number" value="3584"></td><td class="line-content">      - only if pierdes (faltan&gt;0). */</td></tr><tr><td class="line-number" value="3585"></td><td class="line-content">    function CV_computeBySec(js, secIds, puesto, partido){</td></tr><tr><td class="line-number" value="3586"></td><td class="line-content">      const X = partido.toUpperCase();</td></tr><tr><td class="line-number" value="3587"></td><td class="line-content">      const bySec = {}; // sec -&gt; { faltan, gapPP, winner, vL, vX, Vproj }</td></tr><tr><td class="line-number" value="3588"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3589"></td><td class="line-content">      for (const sec of secIds){</td></tr><tr><td class="line-number" value="3590"></td><td class="line-content">        const slot = js?.secciones?.[sec4(sec)];</td></tr><tr><td class="line-number" value="3591"></td><td class="line-content">        const row24 = slot?.['2024']; if (!row24) continue;</td></tr><tr><td class="line-number" value="3592"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3593"></td><td class="line-content">        const p27 = (typeof AT27_GG_project2027==='function') ? AT27_GG_project2027(slot, puesto) : null;</td></tr><tr><td class="line-number" value="3594"></td><td class="line-content">        const ln24 = Number(row24.LN||0);</td></tr><tr><td class="line-number" value="3595"></td><td class="line-content">        if (p27==null || !ln24) continue;</td></tr><tr><td class="line-number" value="3596"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3597"></td><td class="line-content">        const Vproj = ln24 * (p27/100);</td></tr><tr><td class="line-number" value="3598"></td><td class="line-content">        if (!Number.isFinite(Vproj) || Vproj&lt;1) continue;</td></tr><tr><td class="line-number" value="3599"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3600"></td><td class="line-content">        // shares 2024</td></tr><tr><td class="line-number" value="3601"></td><td class="line-content">        const { shares, total:tot24 } = (typeof AT27_GG_shares2024==='function')</td></tr><tr><td class="line-number" value="3602"></td><td class="line-content">          ? AT27_GG_shares2024(row24)</td></tr><tr><td class="line-number" value="3603"></td><td class="line-content">          : (function(){</td></tr><tr><td class="line-number" value="3604"></td><td class="line-content">              let vv = (row24.VOTOS!=null)? Number(row24.VOTOS||0) : 0;</td></tr><tr><td class="line-number" value="3605"></td><td class="line-content">              if (row24.VOTOS==null){ for (const [k,v] of Object.entries(row24)){ if (k==='LN'||k==='VOTOS') continue; vv += Number(v||0); } }</td></tr><tr><td class="line-number" value="3606"></td><td class="line-content">              const sh = {};</td></tr><tr><td class="line-number" value="3607"></td><td class="line-content">              for (const [k,v] of Object.entries(row24)){ if (k==='LN'||k==='VOTOS') continue; sh[k.toUpperCase()] = vv? (Number(v||0)/vv) : 0; }</td></tr><tr><td class="line-number" value="3608"></td><td class="line-content">              return { shares:sh, total:vv };</td></tr><tr><td class="line-number" value="3609"></td><td class="line-content">            })();</td></tr><tr><td class="line-number" value="3610"></td><td class="line-content">        if (!Object.keys(shares).length || !tot24) continue;</td></tr><tr><td class="line-number" value="3611"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3612"></td><td class="line-content">        // votos base 2027 por partido</td></tr><tr><td class="line-number" value="3613"></td><td class="line-content">        const vBase = {};</td></tr><tr><td class="line-number" value="3614"></td><td class="line-content">        for (const [sig,sh] of Object.entries(shares)){ vBase[sig.toUpperCase()] = sh * Vproj; }</td></tr><tr><td class="line-number" value="3615"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3616"></td><td class="line-content">        let L=null, vL=-1; for (const [sig,vv] of Object.entries(vBase)){ if (vv&gt;vL){ vL=vv; L=sig; } }</td></tr><tr><td class="line-number" value="3617"></td><td class="line-content">        const vX = vBase[X] || 0;</td></tr><tr><td class="line-number" value="3618"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3619"></td><td class="line-content">        const faltan = Math.max(0, (vL - vX) + 1);</td></tr><tr><td class="line-number" value="3620"></td><td class="line-content">        if (faltan&lt;=0) continue; // sólo “volteables” (pierdes hoy)</td></tr><tr><td class="line-number" value="3621"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3622"></td><td class="line-content">        const gapPP  = (vL - vX) / Vproj * 100; // &gt; 0 pp</td></tr><tr><td class="line-number" value="3623"></td><td class="line-content">        bySec[sec4(sec)] = { faltan, gapPP, winner:L, vL, vX, Vproj };</td></tr><tr><td class="line-number" value="3624"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="3625"></td><td class="line-content">      return bySec;</td></tr><tr><td class="line-number" value="3626"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="3627"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3628"></td><td class="line-content">    /* ====== Construcción de clusters por contigüidad ======</td></tr><tr><td class="line-number" value="3629"></td><td class="line-content">      Aproximación: dos secciones son vecinas si sus bounding-boxes se intersectan (con epsilon). */</td></tr><tr><td class="line-number" value="3630"></td><td class="line-content">    function bboxOfFeature(f){</td></tr><tr><td class="line-number" value="3631"></td><td class="line-content">      // usa bounds de Leaflet si existe; si no, calcula por coords</td></tr><tr><td class="line-number" value="3632"></td><td class="line-content">      const g = f.geometry;</td></tr><tr><td class="line-number" value="3633"></td><td class="line-content">      let minX=  999, minY=  999, maxX= -999, maxY= -999;</td></tr><tr><td class="line-number" value="3634"></td><td class="line-content">      const walk = (coords)=&gt;{</td></tr><tr><td class="line-number" value="3635"></td><td class="line-content">        for (const pt of coords){</td></tr><tr><td class="line-number" value="3636"></td><td class="line-content">          if (Array.isArray(pt[0])){</td></tr><tr><td class="line-number" value="3637"></td><td class="line-content">            walk(pt);</td></tr><tr><td class="line-number" value="3638"></td><td class="line-content">          }else{</td></tr><tr><td class="line-number" value="3639"></td><td class="line-content">            const [x,y] = pt; // lon, lat</td></tr><tr><td class="line-number" value="3640"></td><td class="line-content">            if (x&lt;minX) minX=x; if (x&gt;maxX) maxX=x;</td></tr><tr><td class="line-number" value="3641"></td><td class="line-content">            if (y&lt;minY) minY=y; if (y&gt;maxY) maxY=y;</td></tr><tr><td class="line-number" value="3642"></td><td class="line-content">          }</td></tr><tr><td class="line-number" value="3643"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="3644"></td><td class="line-content">      };</td></tr><tr><td class="line-number" value="3645"></td><td class="line-content">      if (g) walk(g.coordinates);</td></tr><tr><td class="line-number" value="3646"></td><td class="line-content">      const eps = 1e-5;</td></tr><tr><td class="line-number" value="3647"></td><td class="line-content">      return { minX:minX-eps, minY:minY-eps, maxX:maxX+eps, maxY:maxY+eps };</td></tr><tr><td class="line-number" value="3648"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="3649"></td><td class="line-content">    function bboxIntersects(a,b){</td></tr><tr><td class="line-number" value="3650"></td><td class="line-content">      return !(a.maxX &lt; b.minX || a.minX &gt; b.maxX || a.maxY &lt; b.minY || a.minY &gt; b.maxY);</td></tr><tr><td class="line-number" value="3651"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="3652"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3653"></td><td class="line-content">    function CV_buildClusters(candidatesSet){</td></tr><tr><td class="line-number" value="3654"></td><td class="line-content">      const base = getBaseGeoJSON();</td></tr><tr><td class="line-number" value="3655"></td><td class="line-content">      const feats = base.features.filter(f=&gt;{</td></tr><tr><td class="line-number" value="3656"></td><td class="line-content">        const id = sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);</td></tr><tr><td class="line-number" value="3657"></td><td class="line-content">        return candidatesSet.has(id);</td></tr><tr><td class="line-number" value="3658"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="3659"></td><td class="line-content">      // index rápidos</td></tr><tr><td class="line-number" value="3660"></td><td class="line-content">      const ids   = feats.map(f=&gt; sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id));</td></tr><tr><td class="line-number" value="3661"></td><td class="line-content">      const bboxes= feats.map(bboxOfFeature);</td></tr><tr><td class="line-number" value="3662"></td><td class="line-content">      const id2idx= Object.fromEntries(ids.map((id,i)=&gt;[id,i]));</td></tr><tr><td class="line-number" value="3663"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3664"></td><td class="line-content">      const visited = new Set();</td></tr><tr><td class="line-number" value="3665"></td><td class="line-content">      const clusters = [];</td></tr><tr><td class="line-number" value="3666"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3667"></td><td class="line-content">      for (let i=0;i&lt;feats.length;i++){</td></tr><tr><td class="line-number" value="3668"></td><td class="line-content">        const rootId = ids[i];</td></tr><tr><td class="line-number" value="3669"></td><td class="line-content">        if (visited.has(rootId)) continue;</td></tr><tr><td class="line-number" value="3670"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3671"></td><td class="line-content">        // BFS</td></tr><tr><td class="line-number" value="3672"></td><td class="line-content">        const queue=[i]; visited.add(rootId);</td></tr><tr><td class="line-number" value="3673"></td><td class="line-content">        const secSet = new Set([rootId]);</td></tr><tr><td class="line-number" value="3674"></td><td class="line-content">        let mergedBBox = { ...bboxes[i] };</td></tr><tr><td class="line-number" value="3675"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3676"></td><td class="line-content">        while (queue.length){</td></tr><tr><td class="line-number" value="3677"></td><td class="line-content">          const idx = queue.shift();</td></tr><tr><td class="line-number" value="3678"></td><td class="line-content">          const bb  = bboxes[idx];</td></tr><tr><td class="line-number" value="3679"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3680"></td><td class="line-content">          for (let j=0;j&lt;feats.length;j++){</td></tr><tr><td class="line-number" value="3681"></td><td class="line-content">            const nbrId = ids[j];</td></tr><tr><td class="line-number" value="3682"></td><td class="line-content">            if (visited.has(nbrId)) continue;</td></tr><tr><td class="line-number" value="3683"></td><td class="line-content">            if (bboxIntersects(bb, bboxes[j])){</td></tr><tr><td class="line-number" value="3684"></td><td class="line-content">              // considerar vecino</td></tr><tr><td class="line-number" value="3685"></td><td class="line-content">              visited.add(nbrId);</td></tr><tr><td class="line-number" value="3686"></td><td class="line-content">              queue.push(j);</td></tr><tr><td class="line-number" value="3687"></td><td class="line-content">              secSet.add(nbrId);</td></tr><tr><td class="line-number" value="3688"></td><td class="line-content">              // merge bbox</td></tr><tr><td class="line-number" value="3689"></td><td class="line-content">              mergedBBox = {</td></tr><tr><td class="line-number" value="3690"></td><td class="line-content">                minX: Math.min(mergedBBox.minX, bboxes[j].minX),</td></tr><tr><td class="line-number" value="3691"></td><td class="line-content">                minY: Math.min(mergedBBox.minY, bboxes[j].minY),</td></tr><tr><td class="line-number" value="3692"></td><td class="line-content">                maxX: Math.max(mergedBBox.maxX, bboxes[j].maxX),</td></tr><tr><td class="line-number" value="3693"></td><td class="line-content">                maxY: Math.max(mergedBBox.maxY, bboxes[j].maxY),</td></tr><tr><td class="line-number" value="3694"></td><td class="line-content">              };</td></tr><tr><td class="line-number" value="3695"></td><td class="line-content">            }</td></tr><tr><td class="line-number" value="3696"></td><td class="line-content">          }</td></tr><tr><td class="line-number" value="3697"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="3698"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3699"></td><td class="line-content">        clusters.push({ id: clusters.length+1, secs: secSet, bbox: mergedBBox });</td></tr><tr><td class="line-number" value="3700"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="3701"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3702"></td><td class="line-content">      return clusters;</td></tr><tr><td class="line-number" value="3703"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="3704"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3705"></td><td class="line-content">    /* ====== Overlay ====== */</td></tr><tr><td class="line-number" value="3706"></td><td class="line-content">    function CV_clear(){</td></tr><tr><td class="line-number" value="3707"></td><td class="line-content">      const map = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="3708"></td><td class="line-content">      if (!map) return;</td></tr><tr><td class="line-number" value="3709"></td><td class="line-content">      if (window.AT27_CV_LAYER){ try{ map.removeLayer(AT27_CV_LAYER); }catch(_){} window.AT27_CV_LAYER=null; }</td></tr><tr><td class="line-number" value="3710"></td><td class="line-content">      window.AT27_CV_LAYERS = {};</td></tr><tr><td class="line-number" value="3711"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="3712"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3713"></td><td class="line-content">    function colorFromIndex(i){</td></tr><tr><td class="line-number" value="3714"></td><td class="line-content">      // paleta HSL agradable (12 tonos)</td></tr><tr><td class="line-number" value="3715"></td><td class="line-content">      const H = (i*47) % 360;</td></tr><tr><td class="line-number" value="3716"></td><td class="line-content">      return `hsl(${H} 80% 55%)`;</td></tr><tr><td class="line-number" value="3717"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="3718"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3719"></td><td class="line-content">    function CV_buildOverlay(clusters, bySec){</td></tr><tr><td class="line-number" value="3720"></td><td class="line-content">      const map  = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="3721"></td><td class="line-content">      const base = getBaseGeoJSON();</td></tr><tr><td class="line-number" value="3722"></td><td class="line-content">      if (!map || !base?.features) return;</td></tr><tr><td class="line-number" value="3723"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3724"></td><td class="line-content">      CV_clear();</td></tr><tr><td class="line-number" value="3725"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3726"></td><td class="line-content">      if (map.createPane &amp;&amp; !map.getPane('at27_cv_pane')){</td></tr><tr><td class="line-number" value="3727"></td><td class="line-content">        map.createPane('at27_cv_pane');</td></tr><tr><td class="line-number" value="3728"></td><td class="line-content">        const p = map.getPane('at27_cv_pane'); p.style.zIndex=710; p.style.pointerEvents='auto';</td></tr><tr><td class="line-number" value="3729"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="3730"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3731"></td><td class="line-content">      // mapa sec -&gt; clusterId</td></tr><tr><td class="line-number" value="3732"></td><td class="line-content">      const sec2cid = {};</td></tr><tr><td class="line-number" value="3733"></td><td class="line-content">      clusters.forEach(c=&gt; c.secs.forEach(s=&gt; sec2cid[s]=c.id));</td></tr><tr><td class="line-number" value="3734"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3735"></td><td class="line-content">      const feats = base.features.filter(f=&gt;{</td></tr><tr><td class="line-number" value="3736"></td><td class="line-content">        const id = sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);</td></tr><tr><td class="line-number" value="3737"></td><td class="line-content">        return sec2cid[id]!=null;</td></tr><tr><td class="line-number" value="3738"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="3739"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3740"></td><td class="line-content">      const layer = L.geoJSON({type:'FeatureCollection', features:feats}, {</td></tr><tr><td class="line-number" value="3741"></td><td class="line-content">        pane:'at27_cv_pane',</td></tr><tr><td class="line-number" value="3742"></td><td class="line-content">        style: f=&gt;{</td></tr><tr><td class="line-number" value="3743"></td><td class="line-content">          const id = sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);</td></tr><tr><td class="line-number" value="3744"></td><td class="line-content">          const cid = sec2cid[id];</td></tr><tr><td class="line-number" value="3745"></td><td class="line-content">          const col = colorFromIndex(cid);</td></tr><tr><td class="line-number" value="3746"></td><td class="line-content">          return { color: col, weight:1, opacity:.9, fillColor: col, fillOpacity:.38 };</td></tr><tr><td class="line-number" value="3747"></td><td class="line-content">        },</td></tr><tr><td class="line-number" value="3748"></td><td class="line-content">        onEachFeature: (feature, lyr)=&gt;{</td></tr><tr><td class="line-number" value="3749"></td><td class="line-content">          const id  = sec4(feature.properties?.ID ?? feature.properties?.SECCION ?? feature.properties?.id);</td></tr><tr><td class="line-number" value="3750"></td><td class="line-content">          const cid = sec2cid[id];</td></tr><tr><td class="line-number" value="3751"></td><td class="line-content">          window.AT27_CV_LAYERS[id] = lyr;</td></tr><tr><td class="line-number" value="3752"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3753"></td><td class="line-content">          const x   = bySec[id];</td></tr><tr><td class="line-number" value="3754"></td><td class="line-content">          const tip = `</td></tr><tr><td class="line-number" value="3755"></td><td class="line-content">            &lt;div style="font-size:12px;"&gt;</td></tr><tr><td class="line-number" value="3756"></td><td class="line-content">              Sección &lt;b&gt;${id}&lt;/b&gt; · Corredor &lt;b&gt;#${cid}&lt;/b&gt;&lt;br&gt;</td></tr><tr><td class="line-number" value="3757"></td><td class="line-content">              Faltan: &lt;b&gt;${fmtInt(x?.faltan)}&lt;/b&gt; · Brecha: &lt;b&gt;${fmtpp(x?.gapPP)}&lt;/b&gt;&lt;br&gt;</td></tr><tr><td class="line-number" value="3758"></td><td class="line-content">              Líder: &lt;b&gt;${x?.winner||'—'}&lt;/b&gt; · vL: &lt;b&gt;${fmtInt(x?.vL)}&lt;/b&gt; · Tú: &lt;b&gt;${fmtInt(x?.vX)}&lt;/b&gt;</td></tr><tr><td class="line-number" value="3759"></td><td class="line-content">            &lt;/div&gt;`;</td></tr><tr><td class="line-number" value="3760"></td><td class="line-content">          lyr.bindTooltip(tip, {sticky:true, opacity:.95, direction:'top', className:'at27-tt'});</td></tr><tr><td class="line-number" value="3761"></td><td class="line-content">          lyr.on('mouseover', ()=&gt;lyr.setStyle({weight:2}));</td></tr><tr><td class="line-number" value="3762"></td><td class="line-content">          lyr.on('mouseout',  ()=&gt;lyr.setStyle({weight:1}));</td></tr><tr><td class="line-number" value="3763"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="3764"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="3765"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3766"></td><td class="line-content">      layer.addTo(map);</td></tr><tr><td class="line-number" value="3767"></td><td class="line-content">      window.AT27_CV_LAYER = layer;</td></tr><tr><td class="line-number" value="3768"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="3769"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3770"></td><td class="line-content">    /* ====== Tabla + resumen ====== */</td></tr><tr><td class="line-number" value="3771"></td><td class="line-content">    function CV_renderTable(clusters, bySec){</td></tr><tr><td class="line-number" value="3772"></td><td class="line-content">      const rows = clusters.map(c=&gt;{</td></tr><tr><td class="line-number" value="3773"></td><td class="line-content">        let sumF=0, sumPP=0, maxPP=0, n=0;</td></tr><tr><td class="line-number" value="3774"></td><td class="line-content">        c.secs.forEach(s=&gt;{</td></tr><tr><td class="line-number" value="3775"></td><td class="line-content">          const x = bySec[s]; if (!x) return;</td></tr><tr><td class="line-number" value="3776"></td><td class="line-content">          n++; sumF += Math.ceil(x.faltan); sumPP += x.gapPP; if (x.gapPP&gt;maxPP) maxPP=x.gapPP;</td></tr><tr><td class="line-number" value="3777"></td><td class="line-content">        });</td></tr><tr><td class="line-number" value="3778"></td><td class="line-content">        const avgPP = n? (sumPP/n) : 0;</td></tr><tr><td class="line-number" value="3779"></td><td class="line-content">        return { id:c.id, n, sumF, avgPP, maxPP };</td></tr><tr><td class="line-number" value="3780"></td><td class="line-content">      }).sort((a,b)=&gt; (a.sumF - b.sumF) || (b.n - a.n) || (a.id - b.id));</td></tr><tr><td class="line-number" value="3781"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3782"></td><td class="line-content">      const tb = document.getElementById('AT27_CV_tbody');</td></tr><tr><td class="line-number" value="3783"></td><td class="line-content">      tb.innerHTML = rows.map(r=&gt;`</td></tr><tr><td class="line-number" value="3784"></td><td class="line-content">        &lt;tr data-cid="${r.id}" style="cursor:pointer;"&gt;</td></tr><tr><td class="line-number" value="3785"></td><td class="line-content">          &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;"&gt;#${r.id}&lt;/td&gt;</td></tr><tr><td class="line-number" value="3786"></td><td class="line-content">          &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;"&gt;${r.n}&lt;/td&gt;</td></tr><tr><td class="line-number" value="3787"></td><td class="line-content">          &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;"&gt;${fmtInt(r.sumF)}&lt;/td&gt;</td></tr><tr><td class="line-number" value="3788"></td><td class="line-content">          &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;"&gt;${fmtpp(r.avgPP)}&lt;/td&gt;</td></tr><tr><td class="line-number" value="3789"></td><td class="line-content">          &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;"&gt;${fmtpp(r.maxPP)}&lt;/td&gt;</td></tr><tr><td class="line-number" value="3790"></td><td class="line-content">        &lt;/tr&gt;</td></tr><tr><td class="line-number" value="3791"></td><td class="line-content">      `).join('');</td></tr><tr><td class="line-number" value="3792"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3793"></td><td class="line-content">      tb.onclick = (e)=&gt;{</td></tr><tr><td class="line-number" value="3794"></td><td class="line-content">        const tr = e.target.closest('tr[data-cid]'); if (!tr) return;</td></tr><tr><td class="line-number" value="3795"></td><td class="line-content">        const cid = Number(tr.getAttribute('data-cid'));</td></tr><tr><td class="line-number" value="3796"></td><td class="line-content">        CV_focusCluster(cid);</td></tr><tr><td class="line-number" value="3797"></td><td class="line-content">      };</td></tr><tr><td class="line-number" value="3798"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="3799"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3800"></td><td class="line-content">    function CV_renderSummary(clusters){</td></tr><tr><td class="line-number" value="3801"></td><td class="line-content">      const el = document.getElementById('AT27_CV_summary');</td></tr><tr><td class="line-number" value="3802"></td><td class="line-content">      const total = clusters.reduce((a,c)=&gt; a + c.secs.size, 0);</td></tr><tr><td class="line-number" value="3803"></td><td class="line-content">      const nCorr = clusters.length;</td></tr><tr><td class="line-number" value="3804"></td><td class="line-content">      el.innerHTML = `</td></tr><tr><td class="line-number" value="3805"></td><td class="line-content">        &lt;div style="font-size:12px; line-height:1.35;"&gt;</td></tr><tr><td class="line-number" value="3806"></td><td class="line-content">          Corredores: &lt;b&gt;${nCorr}&lt;/b&gt; · Secciones dentro: &lt;b&gt;${total}&lt;/b&gt;&lt;br&gt;</td></tr><tr><td class="line-number" value="3807"></td><td class="line-content">          Tip: ordena por &lt;i&gt;votos que faltan&lt;/i&gt; para priorizar corredores con mayor retorno.</td></tr><tr><td class="line-number" value="3808"></td><td class="line-content">        &lt;/div&gt;`;</td></tr><tr><td class="line-number" value="3809"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="3810"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3811"></td><td class="line-content">    function CV_focusCluster(cid){</td></tr><tr><td class="line-number" value="3812"></td><td class="line-content">      const map  = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="3813"></td><td class="line-content">      const base = getBaseGeoJSON();</td></tr><tr><td class="line-number" value="3814"></td><td class="line-content">      if (!map || !base?.features) return;</td></tr><tr><td class="line-number" value="3815"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3816"></td><td class="line-content">      const c = (window.AT27_CV_CLUSTERS||[]).find(k=&gt; k.id===cid);</td></tr><tr><td class="line-number" value="3817"></td><td class="line-content">      if (!c) return;</td></tr><tr><td class="line-number" value="3818"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3819"></td><td class="line-content">      // construir bounds del cluster a partir de las capas indexadas (si existen)</td></tr><tr><td class="line-number" value="3820"></td><td class="line-content">      let bounds = null;</td></tr><tr><td class="line-number" value="3821"></td><td class="line-content">      c.secs.forEach(s=&gt;{</td></tr><tr><td class="line-number" value="3822"></td><td class="line-content">        const lyr = window.AT27_CV_LAYERS[s];</td></tr><tr><td class="line-number" value="3823"></td><td class="line-content">        if (lyr){</td></tr><tr><td class="line-number" value="3824"></td><td class="line-content">          const b = lyr.getBounds();</td></tr><tr><td class="line-number" value="3825"></td><td class="line-content">          bounds = bounds ? bounds.extend(b) : L.latLngBounds(b.getSouthWest(), b.getNorthEast());</td></tr><tr><td class="line-number" value="3826"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="3827"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="3828"></td><td class="line-content">      if (bounds){ try{ map.fitBounds(bounds, {maxZoom:15, padding:[24,24]}); }catch(_){} }</td></tr><tr><td class="line-number" value="3829"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="3830"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3831"></td><td class="line-content">    /* ====== RUN principal ====== */</td></tr><tr><td class="line-number" value="3832"></td><td class="line-content">    async function AT27_CV_run(){</td></tr><tr><td class="line-number" value="3833"></td><td class="line-content">      if (window.AT27_CV_STATE.running) return;</td></tr><tr><td class="line-number" value="3834"></td><td class="line-content">      window.AT27_CV_STATE.running = true;</td></tr><tr><td class="line-number" value="3835"></td><td class="line-content">      try{</td></tr><tr><td class="line-number" value="3836"></td><td class="line-content">        const puesto   = document.getElementById('AT27_CV_selPuesto').value;</td></tr><tr><td class="line-number" value="3837"></td><td class="line-content">        const partido  = document.getElementById('AT27_CV_selPartido').value.toUpperCase();</td></tr><tr><td class="line-number" value="3838"></td><td class="line-content">        const modo     = document.querySelector('input[name="AT27_CV_modo"]:checked').value; // 'votos' | 'pp'</td></tr><tr><td class="line-number" value="3839"></td><td class="line-content">        const umbral   = Number(document.getElementById('AT27_CV_umbral').value || (modo==='pp'? 3 : 250));</td></tr><tr><td class="line-number" value="3840"></td><td class="line-content">        const minSize  = Number(document.getElementById('AT27_CV_minSize').value || 2);</td></tr><tr><td class="line-number" value="3841"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3842"></td><td class="line-content">        const secIds = CV_getUniverseSecIds();</td></tr><tr><td class="line-number" value="3843"></td><td class="line-content">        if (!secIds.length){ CV_clear(); document.getElementById('AT27_CV_tbody').innerHTML=''; return; }</td></tr><tr><td class="line-number" value="3844"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3845"></td><td class="line-content">        const js = await CV_load(puesto);</td></tr><tr><td class="line-number" value="3846"></td><td class="line-content">        const bySecAll = CV_computeBySec(js, secIds, puesto, partido);</td></tr><tr><td class="line-number" value="3847"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3848"></td><td class="line-content">        // filtra “Near”: sólo donde pierdes y la brecha es pequeña</td></tr><tr><td class="line-number" value="3849"></td><td class="line-content">        const nearSet = new Set();</td></tr><tr><td class="line-number" value="3850"></td><td class="line-content">        for (const [sec,x] of Object.entries(bySecAll)){</td></tr><tr><td class="line-number" value="3851"></td><td class="line-content">          if (modo==='pp'){</td></tr><tr><td class="line-number" value="3852"></td><td class="line-content">            if (x.gapPP&gt;0 &amp;&amp; x.gapPP &lt;= umbral) nearSet.add(sec);</td></tr><tr><td class="line-number" value="3853"></td><td class="line-content">          }else{</td></tr><tr><td class="line-number" value="3854"></td><td class="line-content">            if (x.faltan&gt;0 &amp;&amp; x.faltan &lt;= umbral) nearSet.add(sec);</td></tr><tr><td class="line-number" value="3855"></td><td class="line-content">          }</td></tr><tr><td class="line-number" value="3856"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="3857"></td><td class="line-content">        if (!nearSet.size){</td></tr><tr><td class="line-number" value="3858"></td><td class="line-content">          CV_clear();</td></tr><tr><td class="line-number" value="3859"></td><td class="line-content">          document.getElementById('AT27_CV_tbody').innerHTML = '';</td></tr><tr><td class="line-number" value="3860"></td><td class="line-content">          document.getElementById('AT27_CV_summary').innerHTML = '&lt;div style="font-size:12px;"&gt;No hay secciones “cercanas” con el umbral actual.&lt;/div&gt;';</td></tr><tr><td class="line-number" value="3861"></td><td class="line-content">          return;</td></tr><tr><td class="line-number" value="3862"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="3863"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3864"></td><td class="line-content">        // clusters por contigüidad (bbox-intersect)</td></tr><tr><td class="line-number" value="3865"></td><td class="line-content">        let clusters = CV_buildClusters(nearSet);</td></tr><tr><td class="line-number" value="3866"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3867"></td><td class="line-content">        // quita clusters pequeños</td></tr><tr><td class="line-number" value="3868"></td><td class="line-content">        clusters = clusters.filter(c=&gt; c.secs.size &gt;= minSize);</td></tr><tr><td class="line-number" value="3869"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3870"></td><td class="line-content">        // calcula métricas de cluster</td></tr><tr><td class="line-number" value="3871"></td><td class="line-content">        clusters.forEach(c=&gt;{</td></tr><tr><td class="line-number" value="3872"></td><td class="line-content">          let sumF=0, sumPP=0, maxPP=0, n=0;</td></tr><tr><td class="line-number" value="3873"></td><td class="line-content">          c.secs.forEach(s=&gt;{</td></tr><tr><td class="line-number" value="3874"></td><td class="line-content">            const x = bySecAll[s]; if (!x) return;</td></tr><tr><td class="line-number" value="3875"></td><td class="line-content">            n++; sumF += Math.ceil(x.faltan); sumPP += x.gapPP; if (x.gapPP&gt;maxPP) maxPP=x.gapPP;</td></tr><tr><td class="line-number" value="3876"></td><td class="line-content">          });</td></tr><tr><td class="line-number" value="3877"></td><td class="line-content">          c.sumF = sumF; c.avgPP = n? (sumPP/n) : 0; c.maxPP = maxPP;</td></tr><tr><td class="line-number" value="3878"></td><td class="line-content">        });</td></tr><tr><td class="line-number" value="3879"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3880"></td><td class="line-content">        window.AT27_CV_CLUSTERS = clusters;</td></tr><tr><td class="line-number" value="3881"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3882"></td><td class="line-content">        CV_buildOverlay(clusters, bySecAll);</td></tr><tr><td class="line-number" value="3883"></td><td class="line-content">        CV_renderSummary(clusters);</td></tr><tr><td class="line-number" value="3884"></td><td class="line-content">        CV_renderTable(clusters, bySecAll);</td></tr><tr><td class="line-number" value="3885"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3886"></td><td class="line-content">      }catch(e){</td></tr><tr><td class="line-number" value="3887"></td><td class="line-content">        console.error('AT27_CV_run', e);</td></tr><tr><td class="line-number" value="3888"></td><td class="line-content">        alert('No pude ejecutar “Corredores de volteo”.');</td></tr><tr><td class="line-number" value="3889"></td><td class="line-content">      }finally{</td></tr><tr><td class="line-number" value="3890"></td><td class="line-content">        window.AT27_CV_STATE.running = false;</td></tr><tr><td class="line-number" value="3891"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="3892"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="3893"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3894"></td><td class="line-content">    /* ====== Panel UI ====== */</td></tr><tr><td class="line-number" value="3895"></td><td class="line-content">    function AT27_CV_open(){</td></tr><tr><td class="line-number" value="3896"></td><td class="line-content">      let panel = document.getElementById('AT27_CV_panel');</td></tr><tr><td class="line-number" value="3897"></td><td class="line-content">      if (panel){ panel.style.display='block'; return; }</td></tr><tr><td class="line-number" value="3898"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3899"></td><td class="line-content">      panel = document.createElement('div');</td></tr><tr><td class="line-number" value="3900"></td><td class="line-content">      panel.id = 'AT27_CV_panel';</td></tr><tr><td class="line-number" value="3901"></td><td class="line-content">      Object.assign(panel.style,{</td></tr><tr><td class="line-number" value="3902"></td><td class="line-content">        position:'fixed', right:'24px', top:'24px', zIndex:9998,</td></tr><tr><td class="line-number" value="3903"></td><td class="line-content">        width:'560px', maxWidth:'calc(100vw - 40px)', maxHeight:'calc(100vh - 40px)',</td></tr><tr><td class="line-number" value="3904"></td><td class="line-content">        background:'#fff', border:'1px solid #e5e7eb', borderRadius:'14px',</td></tr><tr><td class="line-number" value="3905"></td><td class="line-content">        boxShadow:'0 18px 40px rgba(0,0,0,.18)', display:'flex', flexDirection:'column',</td></tr><tr><td class="line-number" value="3906"></td><td class="line-content">        overflow:'hidden', resize:'both', minWidth:'380px', minHeight:'280px'</td></tr><tr><td class="line-number" value="3907"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="3908"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3909"></td><td class="line-content">      panel.innerHTML = `</td></tr><tr><td class="line-number" value="3910"></td><td class="line-content">        &lt;div id="AT27_CV_hdr" style="cursor:move; user-select:none; background:#fdf2f8; color:#111; padding:10px 12px; display:flex; gap:10px; align-items:center;"&gt;</td></tr><tr><td class="line-number" value="3911"></td><td class="line-content">          &lt;div style="font-weight:800;"&gt;Corredores de volteo (clusters contiguos)&lt;/div&gt;</td></tr><tr><td class="line-number" value="3912"></td><td class="line-content">          &lt;button id="AT27_CV_center" style="margin-left:auto; background:#eef2ff; border:1px solid #c7d2fe; border-radius:8px; padding:4px 8px; cursor:pointer;"&gt;Recentrar&lt;/button&gt;</td></tr><tr><td class="line-number" value="3913"></td><td class="line-content">          &lt;button id="AT27_CV_close" title="Cerrar" style="background:transparent;border:none;font-size:18px;cursor:pointer;"&gt;×&lt;/button&gt;</td></tr><tr><td class="line-number" value="3914"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="3915"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3916"></td><td class="line-content">        &lt;div style="padding:10px 12px; display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:end;"&gt;</td></tr><tr><td class="line-number" value="3917"></td><td class="line-content">          &lt;label style="font-size:12px;"&gt;Puesto&lt;br&gt;</td></tr><tr><td class="line-number" value="3918"></td><td class="line-content">            &lt;select id="AT27_CV_selPuesto" class="ttb-select" style="width:100%;"&gt;</td></tr><tr><td class="line-number" value="3919"></td><td class="line-content">              &lt;option value="A"&gt;Ayuntamiento&lt;/option&gt;</td></tr><tr><td class="line-number" value="3920"></td><td class="line-content">              &lt;option value="DL"&gt;Diputado Local&lt;/option&gt;</td></tr><tr><td class="line-number" value="3921"></td><td class="line-content">              &lt;option value="DF"&gt;Diputado Federal&lt;/option&gt;</td></tr><tr><td class="line-number" value="3922"></td><td class="line-content">            &lt;/select&gt;</td></tr><tr><td class="line-number" value="3923"></td><td class="line-content">          &lt;/label&gt;</td></tr><tr><td class="line-number" value="3924"></td><td class="line-content">          &lt;label style="font-size:12px;"&gt;Partido&lt;br&gt;</td></tr><tr><td class="line-number" value="3925"></td><td class="line-content">            &lt;select id="AT27_CV_selPartido" class="ttb-select" style="width:100%;"&gt;</td></tr><tr><td class="line-number" value="3926"></td><td class="line-content">              &lt;option&gt;PAN&lt;/option&gt;&lt;option&gt;PRI&lt;/option&gt;&lt;option&gt;PVEM&lt;/option&gt;&lt;option&gt;MORENA&lt;/option&gt;</td></tr><tr><td class="line-number" value="3927"></td><td class="line-content">            &lt;/select&gt;</td></tr><tr><td class="line-number" value="3928"></td><td class="line-content">          &lt;/label&gt;</td></tr><tr><td class="line-number" value="3929"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3930"></td><td class="line-content">          &lt;div style="grid-column:1 / span 2; display:flex; gap:16px; align-items:center; font-size:12px;"&gt;</td></tr><tr><td class="line-number" value="3931"></td><td class="line-content">            Umbral por:</td></tr><tr><td class="line-number" value="3932"></td><td class="line-content">            &lt;label&gt;&lt;input type="radio" name="AT27_CV_modo" value="votos" checked&gt; votos (faltan ≤)&lt;/label&gt;</td></tr><tr><td class="line-number" value="3933"></td><td class="line-content">            &lt;label&gt;&lt;input type="radio" name="AT27_CV_modo" value="pp"&gt; pp (brecha ≤)&lt;/label&gt;</td></tr><tr><td class="line-number" value="3934"></td><td class="line-content">            &lt;span style="opacity:.7;"&gt;Valor&lt;/span&gt;</td></tr><tr><td class="line-number" value="3935"></td><td class="line-content">            &lt;input id="AT27_CV_umbral" type="number" value="250" style="width:100px; padding:4px 6px; border:1px solid #e5e7eb; border-radius:8px;"&gt;</td></tr><tr><td class="line-number" value="3936"></td><td class="line-content">            &lt;span style="opacity:.7;"&gt;Tamaño mínimo&lt;/span&gt;</td></tr><tr><td class="line-number" value="3937"></td><td class="line-content">            &lt;input id="AT27_CV_minSize" type="number" value="2" min="2" style="width:80px; padding:4px 6px; border:1px solid #e5e7eb; border-radius:8px;"&gt;</td></tr><tr><td class="line-number" value="3938"></td><td class="line-content">          &lt;/div&gt;</td></tr><tr><td class="line-number" value="3939"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3940"></td><td class="line-content">          &lt;button id="AT27_CV_run" class="ttb-btn ttb-primary" style="grid-column:1 / span 2;"&gt;Ejecutar&lt;/button&gt;</td></tr><tr><td class="line-number" value="3941"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="3942"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3943"></td><td class="line-content">        &lt;div style="padding:8px 12px;"&gt;</td></tr><tr><td class="line-number" value="3944"></td><td class="line-content">          &lt;div id="AT27_CV_summary" style="font-size:12px; color:#334155;"&gt;&lt;/div&gt;</td></tr><tr><td class="line-number" value="3945"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="3946"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3947"></td><td class="line-content">        &lt;div style="flex:1; overflow:auto;"&gt;</td></tr><tr><td class="line-number" value="3948"></td><td class="line-content">          &lt;table style="width:100%; border-collapse:collapse; font-size:12px;"&gt;</td></tr><tr><td class="line-number" value="3949"></td><td class="line-content">            &lt;thead&gt;</td></tr><tr><td class="line-number" value="3950"></td><td class="line-content">              &lt;tr style="position:sticky; top:0; background:#f8fafc;"&gt;</td></tr><tr><td class="line-number" value="3951"></td><td class="line-content">                &lt;th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Corredor&lt;/th&gt;</td></tr><tr><td class="line-number" value="3952"></td><td class="line-content">                &lt;th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Secciones&lt;/th&gt;</td></tr><tr><td class="line-number" value="3953"></td><td class="line-content">                &lt;th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Faltan (total)&lt;/th&gt;</td></tr><tr><td class="line-number" value="3954"></td><td class="line-content">                &lt;th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Brecha promedio&lt;/th&gt;</td></tr><tr><td class="line-number" value="3955"></td><td class="line-content">                &lt;th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Brecha máxima&lt;/th&gt;</td></tr><tr><td class="line-number" value="3956"></td><td class="line-content">              &lt;/tr&gt;</td></tr><tr><td class="line-number" value="3957"></td><td class="line-content">            &lt;/thead&gt;</td></tr><tr><td class="line-number" value="3958"></td><td class="line-content">            &lt;tbody id="AT27_CV_tbody"&gt;&lt;/tbody&gt;</td></tr><tr><td class="line-number" value="3959"></td><td class="line-content">          &lt;/table&gt;</td></tr><tr><td class="line-number" value="3960"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="3961"></td><td class="line-content">      `;</td></tr><tr><td class="line-number" value="3962"></td><td class="line-content">      document.body.appendChild(panel);</td></tr><tr><td class="line-number" value="3963"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3964"></td><td class="line-content">      // Wiring UI</td></tr><tr><td class="line-number" value="3965"></td><td class="line-content">      const $$ = (sel)=&gt; panel.querySelector(sel);</td></tr><tr><td class="line-number" value="3966"></td><td class="line-content">      $$('#AT27_CV_close').onclick  = ()=&gt; panel.style.display='none';</td></tr><tr><td class="line-number" value="3967"></td><td class="line-content">      $$('#AT27_CV_center').onclick = ()=&gt; (window.AT27_fitUniverseBounds? AT27_fitUniverseBounds() : null);</td></tr><tr><td class="line-number" value="3968"></td><td class="line-content">      $$('#AT27_CV_run').onclick    = ()=&gt;{ window.AT27_CV_STATE.autorun = true; AT27_CV_run(); };</td></tr><tr><td class="line-number" value="3969"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3970"></td><td class="line-content">      // Drag &amp; bloqueo de eventos al mapa</td></tr><tr><td class="line-number" value="3971"></td><td class="line-content">      (function drag(panelEl, handleEl){</td></tr><tr><td class="line-number" value="3972"></td><td class="line-content">        let sx=0, sy=0, ox=0, oy=0, dragging=false;</td></tr><tr><td class="line-number" value="3973"></td><td class="line-content">        handleEl.addEventListener('mousedown', e=&gt;{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panelEl.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });</td></tr><tr><td class="line-number" value="3974"></td><td class="line-content">        window.addEventListener('mousemove', e=&gt;{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panelEl.style.left=(ox+dx)+'px'; panelEl.style.top=(oy+dy)+'px'; panelEl.style.right='auto'; });</td></tr><tr><td class="line-number" value="3975"></td><td class="line-content">        window.addEventListener('mouseup', ()=&gt;{ dragging=false; document.body.style.userSelect=''; });</td></tr><tr><td class="line-number" value="3976"></td><td class="line-content">      })(panel, panel.querySelector('#AT27_CV_hdr'));</td></tr><tr><td class="line-number" value="3977"></td><td class="line-content">      if (window.L &amp;&amp; L.DomEvent){ L.DomEvent.disableClickPropagation(panel); L.DomEvent.disableScrollPropagation(panel); }</td></tr><tr><td class="line-number" value="3978"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3979"></td><td class="line-content">      // Recalcular si cambias universo (después del primer run)</td></tr><tr><td class="line-number" value="3980"></td><td class="line-content">      const map = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="3981"></td><td class="line-content">      if (map &amp;&amp; !map.__cvBound){</td></tr><tr><td class="line-number" value="3982"></td><td class="line-content">        const deb = (fn,ms=350)=&gt;{ let t; return (...a)=&gt;{ clearTimeout(t); t=setTimeout(()=&gt;fn(...a),ms); }; };</td></tr><tr><td class="line-number" value="3983"></td><td class="line-content">        map.on('layeradd',    deb(()=&gt;{ if (window.AT27_CV_STATE.autorun) AT27_CV_run(); }));</td></tr><tr><td class="line-number" value="3984"></td><td class="line-content">        map.on('layerremove', deb(()=&gt;{ if (window.AT27_CV_STATE.autorun) AT27_CV_run(); }));</td></tr><tr><td class="line-number" value="3985"></td><td class="line-content">        map.__cvBound = true;</td></tr><tr><td class="line-number" value="3986"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="3987"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="3988"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3989"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3990"></td><td class="line-content"><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="3991"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="3992"></td><td class="line-content"><span class="html-tag">&lt;script&gt;</span></td></tr><tr><td class="line-number" value="3993"></td><td class="line-content">    // =======================================================</td></tr><tr><td class="line-number" value="3994"></td><td class="line-content">    // GENIALIDAD #5 · ALERTAS DE RIESGO (BASTIONES EN CAÍDA)</td></tr><tr><td class="line-number" value="3995"></td><td class="line-content">    // Bastión = misma fuerza ganadora en 2018, 2021 y 2024 (estabilidad alta).</td></tr><tr><td class="line-number" value="3996"></td><td class="line-content">    // Riesgo si: Δ participación (2018→2024) &lt; 0  y  p2027* &lt; meta.</td></tr><tr><td class="line-number" value="3997"></td><td class="line-content">    // Vigilar si cumple una de las dos. Verde si ninguna.</td></tr><tr><td class="line-number" value="3998"></td><td class="line-content">    // Requiere: AT_CTX.map/layer, loadPuesto/getElectData, AT27_GG_project2027.</td></tr><tr><td class="line-number" value="3999"></td><td class="line-content">    // =======================================================</td></tr><tr><td class="line-number" value="4000"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4001"></td><td class="line-content">    /* ====== Estado y utilidades ====== */</td></tr><tr><td class="line-number" value="4002"></td><td class="line-content">    window.AT27_AR_STATE  = window.AT27_AR_STATE  || { autorun:false, running:false };</td></tr><tr><td class="line-number" value="4003"></td><td class="line-content">    window.AT27_AR_LAYER  = window.AT27_AR_LAYER  || null;   // overlay</td></tr><tr><td class="line-number" value="4004"></td><td class="line-content">    window.AT27_AR_LAYERS = window.AT27_AR_LAYERS || {};     // sec -&gt; layer</td></tr><tr><td class="line-number" value="4005"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4006"></td><td class="line-content">    const AR_COLORS = { RIESGO:'#ef4444', VIGILAR:'#f59e0b', OK:'#10b981', NA:'#94a3b8' };</td></tr><tr><td class="line-number" value="4007"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4008"></td><td class="line-content">    //const sec4   = (s)=&gt; String(s||'').replace(/\D+/g,'').padStart(4,'0');</td></tr><tr><td class="line-number" value="4009"></td><td class="line-content">    //const fmtInt = (x)=&gt; Number.isFinite(x)? Math.round(x).toLocaleString() : '—';</td></tr><tr><td class="line-number" value="4010"></td><td class="line-content">    //const fmtpp  = (x)=&gt; (x===null||x===undefined) ? '—' : (Number.isFinite(+x) ? ((x&gt;0?'+':'')+(+x).toFixed(1)+' pp') : '—');</td></tr><tr><td class="line-number" value="4011"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4012"></td><td class="line-content">    function AR_getUniverseSecIds(){</td></tr><tr><td class="line-number" value="4013"></td><td class="line-content">      const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];</td></tr><tr><td class="line-number" value="4014"></td><td class="line-content">      return feats.map(f=&gt; sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id));</td></tr><tr><td class="line-number" value="4015"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="4016"></td><td class="line-content">    async function AR_load(p){ return (window.loadPuesto? loadPuesto(p) : getElectData(p)); }</td></tr><tr><td class="line-number" value="4017"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4018"></td><td class="line-content">    function votosValidos(row){</td></tr><tr><td class="line-number" value="4019"></td><td class="line-content">      if (!row) return 0;</td></tr><tr><td class="line-number" value="4020"></td><td class="line-content">      if (row.VOTOS!=null) return Number(row.VOTOS||0);</td></tr><tr><td class="line-number" value="4021"></td><td class="line-content">      let vv = 0; for (const [k,v] of Object.entries(row)){ if (k==='LN'||k==='VOTOS') continue; vv += Number(v||0); }</td></tr><tr><td class="line-number" value="4022"></td><td class="line-content">      return vv;</td></tr><tr><td class="line-number" value="4023"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="4024"></td><td class="line-content">    function participacion(row){ </td></tr><tr><td class="line-number" value="4025"></td><td class="line-content">      const ln = Number(row?.LN||0); const vv = votosValidos(row);</td></tr><tr><td class="line-number" value="4026"></td><td class="line-content">      return (ln&gt;0 &amp;&amp; vv&gt;=0) ? (vv/ln*100) : null;</td></tr><tr><td class="line-number" value="4027"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="4028"></td><td class="line-content">    function ganador(row){</td></tr><tr><td class="line-number" value="4029"></td><td class="line-content">      if (!row) return null;</td></tr><tr><td class="line-number" value="4030"></td><td class="line-content">      let L=null, vL=-1;</td></tr><tr><td class="line-number" value="4031"></td><td class="line-content">      for (const [k,v] of Object.entries(row)){</td></tr><tr><td class="line-number" value="4032"></td><td class="line-content">        if (k==='LN'||k==='VOTOS') continue;</td></tr><tr><td class="line-number" value="4033"></td><td class="line-content">        const kk = k.toUpperCase(), vv = Number(v||0);</td></tr><tr><td class="line-number" value="4034"></td><td class="line-content">        if (vv&gt;vL){ vL=vv; L=kk; }</td></tr><tr><td class="line-number" value="4035"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="4036"></td><td class="line-content">      return L;</td></tr><tr><td class="line-number" value="4037"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="4038"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4039"></td><td class="line-content">    /* ====== Cálculo por sección ======</td></tr><tr><td class="line-number" value="4040"></td><td class="line-content">      - winners 2018/21/24</td></tr><tr><td class="line-number" value="4041"></td><td class="line-content">      - estabilidad (Alta/Media/Baja) -&gt; usamos Alta (bastión).</td></tr><tr><td class="line-number" value="4042"></td><td class="line-content">      - Δp = p2024 - p2018</td></tr><tr><td class="line-number" value="4043"></td><td class="line-content">      - p27 = proyección participación 2027*</td></tr><tr><td class="line-number" value="4044"></td><td class="line-content">      - etiqueta: RIESGO si (Δp&lt; -tol &amp;&amp; p27 &lt; meta), VIGILAR si (Δp&lt; -tol || p27 &lt; meta), OK si no.</td></tr><tr><td class="line-number" value="4045"></td><td class="line-content">    */</td></tr><tr><td class="line-number" value="4046"></td><td class="line-content">    function AR_compute(js, secIds, puesto, metaPct, tolDrop){</td></tr><tr><td class="line-number" value="4047"></td><td class="line-content">      const perSec = {}; // sec -&gt; { bastion:party|null, est:'Alta'|'Media'|'Baja', dP, p27, tag, vv18,vv24 }</td></tr><tr><td class="line-number" value="4048"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4049"></td><td class="line-content">      for (const sec of secIds){</td></tr><tr><td class="line-number" value="4050"></td><td class="line-content">        const slot = js?.secciones?.[sec4(sec)];</td></tr><tr><td class="line-number" value="4051"></td><td class="line-content">        const row18 = slot?.['2018'], row21 = slot?.['2021'], row24 = slot?.['2024'];</td></tr><tr><td class="line-number" value="4052"></td><td class="line-content">        if (!row18 || !row24) continue;</td></tr><tr><td class="line-number" value="4053"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4054"></td><td class="line-content">        const g18 = ganador(row18), g21 = ganador(row21), g24 = ganador(row24);</td></tr><tr><td class="line-number" value="4055"></td><td class="line-content">        const est = (g18 &amp;&amp; g21 &amp;&amp; g24)</td></tr><tr><td class="line-number" value="4056"></td><td class="line-content">                      ? (g18===g21 &amp;&amp; g21===g24 ? 'Alta' : (new Set([g18,g21,g24]).size===3 ? 'Baja' : 'Media'))</td></tr><tr><td class="line-number" value="4057"></td><td class="line-content">                      : null;</td></tr><tr><td class="line-number" value="4058"></td><td class="line-content">        const bastion = (est==='Alta') ? g24 : null;</td></tr><tr><td class="line-number" value="4059"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4060"></td><td class="line-content">        const p18 = participacion(row18);</td></tr><tr><td class="line-number" value="4061"></td><td class="line-content">        const p24 = participacion(row24);</td></tr><tr><td class="line-number" value="4062"></td><td class="line-content">        const dP  = (p18!=null &amp;&amp; p24!=null) ? (p24 - p18) : null;</td></tr><tr><td class="line-number" value="4063"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4064"></td><td class="line-content">        // proyección p2027*</td></tr><tr><td class="line-number" value="4065"></td><td class="line-content">        const p27 = (typeof AT27_GG_project2027==='function') ? AT27_GG_project2027(slot, puesto) : null;</td></tr><tr><td class="line-number" value="4066"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4067"></td><td class="line-content">        // Etiquetado</td></tr><tr><td class="line-number" value="4068"></td><td class="line-content">        let tag='NA';</td></tr><tr><td class="line-number" value="4069"></td><td class="line-content">        if (est==='Alta' &amp;&amp; dP!=null &amp;&amp; p27!=null){</td></tr><tr><td class="line-number" value="4070"></td><td class="line-content">          const cae = (dP &lt; -Math.abs(tolDrop));     // caída verdadera (ej. tol=0 → &lt;0)</td></tr><tr><td class="line-number" value="4071"></td><td class="line-content">          const bajo= (p27 &lt; metaPct);</td></tr><tr><td class="line-number" value="4072"></td><td class="line-content">          tag = (cae &amp;&amp; bajo) ? 'RIESGO' : ((cae || bajo) ? 'VIGILAR' : 'OK');</td></tr><tr><td class="line-number" value="4073"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="4074"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4075"></td><td class="line-content">        perSec[sec4(sec)] = { bastion, est, dP, p27, tag,</td></tr><tr><td class="line-number" value="4076"></td><td class="line-content">                              vv18: votosValidos(row18), vv24: votosValidos(row24) };</td></tr><tr><td class="line-number" value="4077"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="4078"></td><td class="line-content">      return perSec;</td></tr><tr><td class="line-number" value="4079"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="4080"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4081"></td><td class="line-content">    /* ====== Overlay ====== */</td></tr><tr><td class="line-number" value="4082"></td><td class="line-content">    function AR_clear(){</td></tr><tr><td class="line-number" value="4083"></td><td class="line-content">      const map = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="4084"></td><td class="line-content">      if (!map) return;</td></tr><tr><td class="line-number" value="4085"></td><td class="line-content">      if (window.AT27_AR_LAYER){ try{ map.removeLayer(AT27_AR_LAYER); }catch(_){};</td></tr><tr><td class="line-number" value="4086"></td><td class="line-content">        window.AT27_AR_LAYER=null; }</td></tr><tr><td class="line-number" value="4087"></td><td class="line-content">      window.AT27_AR_LAYERS = {};</td></tr><tr><td class="line-number" value="4088"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="4089"></td><td class="line-content">    function AR_buildOverlay(perSec){</td></tr><tr><td class="line-number" value="4090"></td><td class="line-content">      const map  = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="4091"></td><td class="line-content">      const base = window.AT_CTX?.layer?.toGeoJSON?.() || window.AT_DATA;</td></tr><tr><td class="line-number" value="4092"></td><td class="line-content">      if (!map || !base?.features) return;</td></tr><tr><td class="line-number" value="4093"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4094"></td><td class="line-content">      AR_clear();</td></tr><tr><td class="line-number" value="4095"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4096"></td><td class="line-content">      if (map.createPane &amp;&amp; !map.getPane('at27_ar_pane')){</td></tr><tr><td class="line-number" value="4097"></td><td class="line-content">        map.createPane('at27_ar_pane');</td></tr><tr><td class="line-number" value="4098"></td><td class="line-content">        const p = map.getPane('at27_ar_pane'); p.style.zIndex=720; p.style.pointerEvents='auto';</td></tr><tr><td class="line-number" value="4099"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="4100"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4101"></td><td class="line-content">      const feats = base.features.filter(f=&gt;{</td></tr><tr><td class="line-number" value="4102"></td><td class="line-content">        const id = sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);</td></tr><tr><td class="line-number" value="4103"></td><td class="line-content">        return perSec[id]!=null;</td></tr><tr><td class="line-number" value="4104"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="4105"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4106"></td><td class="line-content">      const layer = L.geoJSON({type:'FeatureCollection', features:feats}, {</td></tr><tr><td class="line-number" value="4107"></td><td class="line-content">        pane:'at27_ar_pane',</td></tr><tr><td class="line-number" value="4108"></td><td class="line-content">        style: f=&gt;{</td></tr><tr><td class="line-number" value="4109"></td><td class="line-content">          const id = sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);</td></tr><tr><td class="line-number" value="4110"></td><td class="line-content">          const info = perSec[id];</td></tr><tr><td class="line-number" value="4111"></td><td class="line-content">          let col = AR_COLORS.NA, fo=.20;</td></tr><tr><td class="line-number" value="4112"></td><td class="line-content">          if (info){</td></tr><tr><td class="line-number" value="4113"></td><td class="line-content">            if (info.tag==='RIESGO'){ col = AR_COLORS.RIESGO; fo=.45; }</td></tr><tr><td class="line-number" value="4114"></td><td class="line-content">            else if (info.tag==='VIGILAR'){ col = AR_COLORS.VIGILAR; fo=.35; }</td></tr><tr><td class="line-number" value="4115"></td><td class="line-content">            else if (info.tag==='OK'){ col = AR_COLORS.OK; fo=.28; }</td></tr><tr><td class="line-number" value="4116"></td><td class="line-content">          }</td></tr><tr><td class="line-number" value="4117"></td><td class="line-content">          return { color:col, fillColor:col, weight:1, opacity:.9, fillOpacity:fo };</td></tr><tr><td class="line-number" value="4118"></td><td class="line-content">        },</td></tr><tr><td class="line-number" value="4119"></td><td class="line-content">        onEachFeature: (feature, lyr)=&gt;{</td></tr><tr><td class="line-number" value="4120"></td><td class="line-content">          const id = sec4(feature.properties?.ID ?? feature.properties?.SECCION ?? feature.properties?.id);</td></tr><tr><td class="line-number" value="4121"></td><td class="line-content">          window.AT27_AR_LAYERS[id] = lyr;</td></tr><tr><td class="line-number" value="4122"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4123"></td><td class="line-content">          const x = perSec[id] || {};</td></tr><tr><td class="line-number" value="4124"></td><td class="line-content">          const tip = `</td></tr><tr><td class="line-number" value="4125"></td><td class="line-content">            &lt;div style="font-size:12px;"&gt;</td></tr><tr><td class="line-number" value="4126"></td><td class="line-content">              Sección &lt;b&gt;${id}&lt;/b&gt;&lt;br&gt;</td></tr><tr><td class="line-number" value="4127"></td><td class="line-content">              Estabilidad: &lt;b&gt;${x.est||'—'}&lt;/b&gt; · Bastión: &lt;b&gt;${x.bastion||'—'}&lt;/b&gt;&lt;br&gt;</td></tr><tr><td class="line-number" value="4128"></td><td class="line-content">              Δ participación 18→24: &lt;b&gt;${fmtpp(x.dP)}&lt;/b&gt;&lt;br&gt;</td></tr><tr><td class="line-number" value="4129"></td><td class="line-content">              p2027*: &lt;b&gt;${x.p27!=null ? x.p27.toFixed(1)+'%' : '—'}&lt;/b&gt;&lt;br&gt;</td></tr><tr><td class="line-number" value="4130"></td><td class="line-content">              Alerta: &lt;b&gt;${x.tag||'—'}&lt;/b&gt;</td></tr><tr><td class="line-number" value="4131"></td><td class="line-content">            &lt;/div&gt;`;</td></tr><tr><td class="line-number" value="4132"></td><td class="line-content">          lyr.bindTooltip(tip, {sticky:true, opacity:.95, direction:'top', className:'at27-tt'});</td></tr><tr><td class="line-number" value="4133"></td><td class="line-content">          lyr.on('mouseover', ()=&gt;lyr.setStyle({weight:2}));</td></tr><tr><td class="line-number" value="4134"></td><td class="line-content">          lyr.on('mouseout',  ()=&gt;lyr.setStyle({weight:1}));</td></tr><tr><td class="line-number" value="4135"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="4136"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="4137"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4138"></td><td class="line-content">      layer.addTo(map);</td></tr><tr><td class="line-number" value="4139"></td><td class="line-content">      window.AT27_AR_LAYER = layer;</td></tr><tr><td class="line-number" value="4140"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="4141"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4142"></td><td class="line-content">    /* ====== Tabla + zoom ====== */</td></tr><tr><td class="line-number" value="4143"></td><td class="line-content">    function AR_renderTable(perSec, orden){</td></tr><tr><td class="line-number" value="4144"></td><td class="line-content">      const tb = document.getElementById('AT27_AR_tbody');</td></tr><tr><td class="line-number" value="4145"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4146"></td><td class="line-content">      // a filas</td></tr><tr><td class="line-number" value="4147"></td><td class="line-content">      const rows = Object.entries(perSec).map(([sec,x])=&gt;({</td></tr><tr><td class="line-number" value="4148"></td><td class="line-content">        sec, tag:x.tag, bastion:x.bastion||'—', est:x.est||'—',</td></tr><tr><td class="line-number" value="4149"></td><td class="line-content">        dP:x.dP, p27:x.p27, vv18:x.vv18, vv24:x.vv24</td></tr><tr><td class="line-number" value="4150"></td><td class="line-content">      })).filter(r=&gt; r.est==='Alta'); // solo bastiones</td></tr><tr><td class="line-number" value="4151"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4152"></td><td class="line-content">      // orden: Riesgo primero, luego Vigilar, luego OK. Dentro, por mayor caída y menor p27.</td></tr><tr><td class="line-number" value="4153"></td><td class="line-content">      const catRank = (t)=&gt; t==='RIESGO'?0 : (t==='VIGILAR'?1 : (t==='OK'?2:3));</td></tr><tr><td class="line-number" value="4154"></td><td class="line-content">      rows.sort((a,b)=&gt; (catRank(a.tag) - catRank(b.tag)) ||</td></tr><tr><td class="line-number" value="4155"></td><td class="line-content">                        ((a.dP??0) - (b.dP??0)) || // más negativa primero</td></tr><tr><td class="line-number" value="4156"></td><td class="line-content">                        ((a.p27??999) - (b.p27??999)) ||</td></tr><tr><td class="line-number" value="4157"></td><td class="line-content">                        (Number(a.sec)-Number(b.sec)));</td></tr><tr><td class="line-number" value="4158"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4159"></td><td class="line-content">      tb.innerHTML = rows.map(r=&gt;{</td></tr><tr><td class="line-number" value="4160"></td><td class="line-content">        const bg = r.tag==='RIESGO' ? '#fee2e2' : (r.tag==='VIGILAR' ? '#fef9c3' : '#dcfce7');</td></tr><tr><td class="line-number" value="4161"></td><td class="line-content">        return `</td></tr><tr><td class="line-number" value="4162"></td><td class="line-content">          &lt;tr data-sec="${r.sec}" style="background:${bg}; cursor:pointer;"&gt;</td></tr><tr><td class="line-number" value="4163"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;"&gt;${r.sec}&lt;/td&gt;</td></tr><tr><td class="line-number" value="4164"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;"&gt;${r.bastion}&lt;/td&gt;</td></tr><tr><td class="line-number" value="4165"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;"&gt;${r.est}&lt;/td&gt;</td></tr><tr><td class="line-number" value="4166"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;"&gt;${fmtpp(r.dP)}&lt;/td&gt;</td></tr><tr><td class="line-number" value="4167"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;"&gt;${r.p27!=null ? r.p27.toFixed(1)+'%' : '—'}&lt;/td&gt;</td></tr><tr><td class="line-number" value="4168"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;"&gt;${r.tag}&lt;/td&gt;</td></tr><tr><td class="line-number" value="4169"></td><td class="line-content">          &lt;/tr&gt;`;</td></tr><tr><td class="line-number" value="4170"></td><td class="line-content">      }).join('');</td></tr><tr><td class="line-number" value="4171"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4172"></td><td class="line-content">      // zoom</td></tr><tr><td class="line-number" value="4173"></td><td class="line-content">      tb.onclick = (e)=&gt;{</td></tr><tr><td class="line-number" value="4174"></td><td class="line-content">        const tr = e.target.closest('tr[data-sec]'); if (!tr) return;</td></tr><tr><td class="line-number" value="4175"></td><td class="line-content">        AR_focus(tr.getAttribute('data-sec'));</td></tr><tr><td class="line-number" value="4176"></td><td class="line-content">      };</td></tr><tr><td class="line-number" value="4177"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="4178"></td><td class="line-content">    function AR_focus(sec){</td></tr><tr><td class="line-number" value="4179"></td><td class="line-content">      const id = sec4(sec);</td></tr><tr><td class="line-number" value="4180"></td><td class="line-content">      const lyr = window.AT27_AR_LAYERS[id];</td></tr><tr><td class="line-number" value="4181"></td><td class="line-content">      const map = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="4182"></td><td class="line-content">      if (!map) return;</td></tr><tr><td class="line-number" value="4183"></td><td class="line-content">      if (lyr){</td></tr><tr><td class="line-number" value="4184"></td><td class="line-content">        try{ map.fitBounds(lyr.getBounds(), {maxZoom:16, padding:[20,20]}); }catch(_){}</td></tr><tr><td class="line-number" value="4185"></td><td class="line-content">        if (lyr.openTooltip) lyr.openTooltip();</td></tr><tr><td class="line-number" value="4186"></td><td class="line-content">        const origFO = lyr.options.fillOpacity ?? .3;</td></tr><tr><td class="line-number" value="4187"></td><td class="line-content">        lyr.setStyle({weight:3, fillOpacity: Math.min(.95, origFO+.25)});</td></tr><tr><td class="line-number" value="4188"></td><td class="line-content">        setTimeout(()=&gt; lyr.setStyle({weight:1, fillOpacity: origFO}), 900);</td></tr><tr><td class="line-number" value="4189"></td><td class="line-content">        return;</td></tr><tr><td class="line-number" value="4190"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="4191"></td><td class="line-content">      // fallback (por si el overlay no está)</td></tr><tr><td class="line-number" value="4192"></td><td class="line-content">      const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];</td></tr><tr><td class="line-number" value="4193"></td><td class="line-content">      const f = feats.find(ft=&gt; sec4(ft.properties?.ID ?? ft.properties?.SECCION ?? ft.properties?.id)===id);</td></tr><tr><td class="line-number" value="4194"></td><td class="line-content">      if (f){ const tmp=L.geoJSON(f); map.fitBounds(tmp.getBounds(), {maxZoom:16, padding:[20,20]}); }</td></tr><tr><td class="line-number" value="4195"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="4196"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4197"></td><td class="line-content">    /* ====== Resumen ====== */</td></tr><tr><td class="line-number" value="4198"></td><td class="line-content">    function AR_renderSummary(perSec){</td></tr><tr><td class="line-number" value="4199"></td><td class="line-content">      const el = document.getElementById('AT27_AR_summary');</td></tr><tr><td class="line-number" value="4200"></td><td class="line-content">      let nAlta=0, nRisk=0, nWatch=0, nOk=0;</td></tr><tr><td class="line-number" value="4201"></td><td class="line-content">      Object.values(perSec).forEach(x=&gt;{</td></tr><tr><td class="line-number" value="4202"></td><td class="line-content">        if (x?.est==='Alta'){ nAlta++; if (x.tag==='RIESGO') nRisk++; else if (x.tag==='VIGILAR') nWatch++; else if (x.tag==='OK') nOk++; }</td></tr><tr><td class="line-number" value="4203"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="4204"></td><td class="line-content">      el.innerHTML = `</td></tr><tr><td class="line-number" value="4205"></td><td class="line-content">        &lt;div style="font-size:12px; line-height:1.35;"&gt;</td></tr><tr><td class="line-number" value="4206"></td><td class="line-content">          Bastiones (estabilidad alta): &lt;b&gt;${nAlta}&lt;/b&gt;&lt;br&gt;</td></tr><tr><td class="line-number" value="4207"></td><td class="line-content">          &lt;span style="display:inline-block;width:10px;height:10px;background:${AR_COLORS.RIESGO};border-radius:2px;"&gt;&lt;/span&gt; Riesgo: &lt;b&gt;${nRisk}&lt;/b&gt;</td></tr><tr><td class="line-number" value="4208"></td><td class="line-content">          · &lt;span style="display:inline-block;width:10px;height:10px;background:${AR_COLORS.VIGILAR};border-radius:2px;"&gt;&lt;/span&gt; Vigilar: &lt;b&gt;${nWatch}&lt;/b&gt;</td></tr><tr><td class="line-number" value="4209"></td><td class="line-content">          · &lt;span style="display:inline-block;width:10px;height:10px;background:${AR_COLORS.OK};border-radius:2px;"&gt;&lt;/span&gt; Sano: &lt;b&gt;${nOk}&lt;/b&gt;</td></tr><tr><td class="line-number" value="4210"></td><td class="line-content">        &lt;/div&gt;`;</td></tr><tr><td class="line-number" value="4211"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="4212"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4213"></td><td class="line-content">    /* ====== RUN ====== */</td></tr><tr><td class="line-number" value="4214"></td><td class="line-content">    async function AT27_AR_run(){</td></tr><tr><td class="line-number" value="4215"></td><td class="line-content">      if (window.AT27_AR_STATE.running) return;</td></tr><tr><td class="line-number" value="4216"></td><td class="line-content">      window.AT27_AR_STATE.running = true;</td></tr><tr><td class="line-number" value="4217"></td><td class="line-content">      try{</td></tr><tr><td class="line-number" value="4218"></td><td class="line-content">        const puesto  = document.getElementById('AT27_AR_selPuesto').value;</td></tr><tr><td class="line-number" value="4219"></td><td class="line-content">        const meta    = Number(document.getElementById('AT27_AR_meta').value || 50); // %</td></tr><tr><td class="line-number" value="4220"></td><td class="line-content">        const tolDrop = Number(document.getElementById('AT27_AR_tol').value || 0);   // pp (ej. 0 → cualquier caída)</td></tr><tr><td class="line-number" value="4221"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4222"></td><td class="line-content">        const secIds = AR_getUniverseSecIds();</td></tr><tr><td class="line-number" value="4223"></td><td class="line-content">        if (!secIds.length){ AR_clear(); document.getElementById('AT27_AR_tbody').innerHTML=''; return; }</td></tr><tr><td class="line-number" value="4224"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4225"></td><td class="line-content">        const js   = await AR_load(puesto);</td></tr><tr><td class="line-number" value="4226"></td><td class="line-content">        const per  = AR_compute(js, secIds, puesto, meta, tolDrop);</td></tr><tr><td class="line-number" value="4227"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4228"></td><td class="line-content">        AR_buildOverlay(per);</td></tr><tr><td class="line-number" value="4229"></td><td class="line-content">        AR_renderSummary(per);</td></tr><tr><td class="line-number" value="4230"></td><td class="line-content">        AR_renderTable(per);</td></tr><tr><td class="line-number" value="4231"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4232"></td><td class="line-content">      }catch(e){</td></tr><tr><td class="line-number" value="4233"></td><td class="line-content">        console.error('AT27_AR_run', e);</td></tr><tr><td class="line-number" value="4234"></td><td class="line-content">        alert('No pude ejecutar “Alertas de riesgo”.');</td></tr><tr><td class="line-number" value="4235"></td><td class="line-content">      }finally{</td></tr><tr><td class="line-number" value="4236"></td><td class="line-content">        window.AT27_AR_STATE.running = false;</td></tr><tr><td class="line-number" value="4237"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="4238"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="4239"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4240"></td><td class="line-content">    /* ====== Panel UI ====== */</td></tr><tr><td class="line-number" value="4241"></td><td class="line-content">    function AT27_AR_open(){</td></tr><tr><td class="line-number" value="4242"></td><td class="line-content">      let panel = document.getElementById('AT27_AR_panel');</td></tr><tr><td class="line-number" value="4243"></td><td class="line-content">      if (panel){ panel.style.display='block'; return; }</td></tr><tr><td class="line-number" value="4244"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4245"></td><td class="line-content">      panel = document.createElement('div');</td></tr><tr><td class="line-number" value="4246"></td><td class="line-content">      panel.id = 'AT27_AR_panel';</td></tr><tr><td class="line-number" value="4247"></td><td class="line-content">      Object.assign(panel.style,{</td></tr><tr><td class="line-number" value="4248"></td><td class="line-content">        position:'fixed', right:'24px', top:'24px', zIndex:9998,</td></tr><tr><td class="line-number" value="4249"></td><td class="line-content">        width:'560px', maxWidth:'calc(100vw - 40px)', maxHeight:'calc(100vh - 40px)',</td></tr><tr><td class="line-number" value="4250"></td><td class="line-content">        background:'#fff', border:'1px solid #e5e7eb', borderRadius:'14px',</td></tr><tr><td class="line-number" value="4251"></td><td class="line-content">        boxShadow:'0 18px 40px rgba(0,0,0,.18)', display:'flex', flexDirection:'column',</td></tr><tr><td class="line-number" value="4252"></td><td class="line-content">        overflow:'hidden', resize:'both', minWidth:'380px', minHeight:'280px'</td></tr><tr><td class="line-number" value="4253"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="4254"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4255"></td><td class="line-content">      panel.innerHTML = `</td></tr><tr><td class="line-number" value="4256"></td><td class="line-content">        &lt;div id="AT27_AR_hdr" style="cursor:move; user-select:none; background:#ffe4e6; color:#111; padding:10px 12px; display:flex; gap:10px; align-items:center;"&gt;</td></tr><tr><td class="line-number" value="4257"></td><td class="line-content">          &lt;div style="font-weight:800;"&gt;Alertas de riesgo (bastiones en caída)&lt;/div&gt;</td></tr><tr><td class="line-number" value="4258"></td><td class="line-content">          &lt;button id="AT27_AR_center" style="margin-left:auto; background:#eef2ff; border:1px solid #c7d2fe; border-radius:8px; padding:4px 8px; cursor:pointer;"&gt;Recentrar&lt;/button&gt;</td></tr><tr><td class="line-number" value="4259"></td><td class="line-content">          &lt;button id="AT27_AR_close" title="Cerrar" style="background:transparent;border:none;font-size:18px;cursor:pointer;"&gt;×&lt;/button&gt;</td></tr><tr><td class="line-number" value="4260"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="4261"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4262"></td><td class="line-content">        &lt;div style="padding:10px 12px; display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:end;"&gt;</td></tr><tr><td class="line-number" value="4263"></td><td class="line-content">          &lt;label style="font-size:12px;"&gt;Puesto&lt;br&gt;</td></tr><tr><td class="line-number" value="4264"></td><td class="line-content">            &lt;select id="AT27_AR_selPuesto" class="ttb-select" style="width:100%;"&gt;</td></tr><tr><td class="line-number" value="4265"></td><td class="line-content">              &lt;option value="A"&gt;Ayuntamiento&lt;/option&gt;</td></tr><tr><td class="line-number" value="4266"></td><td class="line-content">              &lt;option value="DL"&gt;Diputado Local&lt;/option&gt;</td></tr><tr><td class="line-number" value="4267"></td><td class="line-content">              &lt;option value="DF"&gt;Diputado Federal&lt;/option&gt;</td></tr><tr><td class="line-number" value="4268"></td><td class="line-content">            &lt;/select&gt;</td></tr><tr><td class="line-number" value="4269"></td><td class="line-content">          &lt;/label&gt;</td></tr><tr><td class="line-number" value="4270"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4271"></td><td class="line-content">          &lt;label style="font-size:12px;"&gt;Meta p2027* (%) &lt;span id="AT27_AR_lblMeta" style="opacity:.7;"&gt;50%&lt;/span&gt;</td></tr><tr><td class="line-number" value="4272"></td><td class="line-content">            &lt;input id="AT27_AR_meta" type="range" min="40" max="70" step="2" value="50" style="width:100%;"&gt;</td></tr><tr><td class="line-number" value="4273"></td><td class="line-content">          &lt;/label&gt;</td></tr><tr><td class="line-number" value="4274"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4275"></td><td class="line-content">          &lt;div style="grid-column:1 / span 2; display:flex; gap:14px; align-items:center; font-size:12px;"&gt;</td></tr><tr><td class="line-number" value="4276"></td><td class="line-content">            Tolerancia a caída (Δ participación &amp;lt; −tol):</td></tr><tr><td class="line-number" value="4277"></td><td class="line-content">            &lt;input id="AT27_AR_tol" type="number" value="0" step="0.5" style="width:90px; padding:4px 6px; border:1px solid #e5e7eb; border-radius:8px;"&gt;</td></tr><tr><td class="line-number" value="4278"></td><td class="line-content">            &lt;button id="AT27_AR_run" class="ttb-btn ttb-primary" style="margin-left:auto;"&gt;Ejecutar&lt;/button&gt;</td></tr><tr><td class="line-number" value="4279"></td><td class="line-content">          &lt;/div&gt;</td></tr><tr><td class="line-number" value="4280"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="4281"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4282"></td><td class="line-content">        &lt;div style="padding:8px 12px;"&gt;</td></tr><tr><td class="line-number" value="4283"></td><td class="line-content">          &lt;div id="AT27_AR_legend" style="font-size:12px; display:flex; gap:12px; align-items:center; margin-bottom:6px;"&gt;</td></tr><tr><td class="line-number" value="4284"></td><td class="line-content">            &lt;span&gt;&lt;span style="display:inline-block;width:10px;height:10px;background:${AR_COLORS.RIESGO};border-radius:2px;"&gt;&lt;/span&gt; Riesgo (cae y bajo meta)&lt;/span&gt;</td></tr><tr><td class="line-number" value="4285"></td><td class="line-content">            &lt;span&gt;&lt;span style="display:inline-block;width:10px;height:10px;background:${AR_COLORS.VIGILAR};border-radius:2px;"&gt;&lt;/span&gt; Vigilar (cae o bajo meta)&lt;/span&gt;</td></tr><tr><td class="line-number" value="4286"></td><td class="line-content">            &lt;span&gt;&lt;span style="display:inline-block;width:10px;height:10px;background:${AR_COLORS.OK};border-radius:2px;"&gt;&lt;/span&gt; Sano&lt;/span&gt;</td></tr><tr><td class="line-number" value="4287"></td><td class="line-content">          &lt;/div&gt;</td></tr><tr><td class="line-number" value="4288"></td><td class="line-content">          &lt;div id="AT27_AR_summary" style="font-size:12px; color:#334155;"&gt;&lt;/div&gt;</td></tr><tr><td class="line-number" value="4289"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="4290"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4291"></td><td class="line-content">        &lt;div style="flex:1; overflow:auto;"&gt;</td></tr><tr><td class="line-number" value="4292"></td><td class="line-content">          &lt;table style="width:100%; border-collapse:collapse; font-size:12px;"&gt;</td></tr><tr><td class="line-number" value="4293"></td><td class="line-content">            &lt;thead&gt;</td></tr><tr><td class="line-number" value="4294"></td><td class="line-content">              &lt;tr style="position:sticky; top:0; background:#f8fafc;"&gt;</td></tr><tr><td class="line-number" value="4295"></td><td class="line-content">                &lt;th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Sección&lt;/th&gt;</td></tr><tr><td class="line-number" value="4296"></td><td class="line-content">                &lt;th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Bastión&lt;/th&gt;</td></tr><tr><td class="line-number" value="4297"></td><td class="line-content">                &lt;th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Estabilidad&lt;/th&gt;</td></tr><tr><td class="line-number" value="4298"></td><td class="line-content">                &lt;th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Δ participación 18→24&lt;/th&gt;</td></tr><tr><td class="line-number" value="4299"></td><td class="line-content">                &lt;th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;p2027*&lt;/th&gt;</td></tr><tr><td class="line-number" value="4300"></td><td class="line-content">                &lt;th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Alerta&lt;/th&gt;</td></tr><tr><td class="line-number" value="4301"></td><td class="line-content">              &lt;/tr&gt;</td></tr><tr><td class="line-number" value="4302"></td><td class="line-content">            &lt;/thead&gt;</td></tr><tr><td class="line-number" value="4303"></td><td class="line-content">            &lt;tbody id="AT27_AR_tbody"&gt;&lt;/tbody&gt;</td></tr><tr><td class="line-number" value="4304"></td><td class="line-content">          &lt;/table&gt;</td></tr><tr><td class="line-number" value="4305"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="4306"></td><td class="line-content">      `;</td></tr><tr><td class="line-number" value="4307"></td><td class="line-content">      document.body.appendChild(panel);</td></tr><tr><td class="line-number" value="4308"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4309"></td><td class="line-content">      const $$ = (sel)=&gt; panel.querySelector(sel);</td></tr><tr><td class="line-number" value="4310"></td><td class="line-content">      $$('#AT27_AR_close').onclick  = ()=&gt; panel.style.display='none';</td></tr><tr><td class="line-number" value="4311"></td><td class="line-content">      $$('#AT27_AR_center').onclick = ()=&gt; (window.AT27_fitUniverseBounds? AT27_fitUniverseBounds() : null);</td></tr><tr><td class="line-number" value="4312"></td><td class="line-content">      $$('#AT27_AR_run').onclick    = ()=&gt;{ window.AT27_AR_STATE.autorun = true; AT27_AR_run(); };</td></tr><tr><td class="line-number" value="4313"></td><td class="line-content">      $$('#AT27_AR_meta').addEventListener('input', ()=&gt; $$('#AT27_AR_lblMeta').textContent = $$('#AT27_AR_meta').value + '%');</td></tr><tr><td class="line-number" value="4314"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4315"></td><td class="line-content">      // Drag y bloqueo de eventos al mapa</td></tr><tr><td class="line-number" value="4316"></td><td class="line-content">      (function drag(panelEl, handleEl){</td></tr><tr><td class="line-number" value="4317"></td><td class="line-content">        let sx=0, sy=0, ox=0, oy=0, dragging=false;</td></tr><tr><td class="line-number" value="4318"></td><td class="line-content">        handleEl.addEventListener('mousedown', e=&gt;{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panelEl.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });</td></tr><tr><td class="line-number" value="4319"></td><td class="line-content">        window.addEventListener('mousemove', e=&gt;{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panelEl.style.left=(ox+dx)+'px'; panelEl.style.top=(oy+dy)+'px'; panelEl.style.right='auto'; });</td></tr><tr><td class="line-number" value="4320"></td><td class="line-content">        window.addEventListener('mouseup', ()=&gt;{ dragging=false; document.body.style.userSelect=''; });</td></tr><tr><td class="line-number" value="4321"></td><td class="line-content">      })(panel, panel.querySelector('#AT27_AR_hdr'));</td></tr><tr><td class="line-number" value="4322"></td><td class="line-content">      if (window.L &amp;&amp; L.DomEvent){ L.DomEvent.disableClickPropagation(panel); L.DomEvent.disableScrollPropagation(panel); }</td></tr><tr><td class="line-number" value="4323"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4324"></td><td class="line-content">      // Recalcular si cambias universo (tras primer run)</td></tr><tr><td class="line-number" value="4325"></td><td class="line-content">      const map = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="4326"></td><td class="line-content">      if (map &amp;&amp; !map.__arBound){</td></tr><tr><td class="line-number" value="4327"></td><td class="line-content">        const deb = (fn,ms=350)=&gt;{ let t; return (...a)=&gt;{ clearTimeout(t); t=setTimeout(()=&gt;fn(...a),ms); }; };</td></tr><tr><td class="line-number" value="4328"></td><td class="line-content">        map.on('layeradd',    deb(()=&gt;{ if (window.AT27_AR_STATE.autorun) AT27_AR_run(); }));</td></tr><tr><td class="line-number" value="4329"></td><td class="line-content">        map.on('layerremove', deb(()=&gt;{ if (window.AT27_AR_STATE.autorun) AT27_AR_run(); }));</td></tr><tr><td class="line-number" value="4330"></td><td class="line-content">        map.__arBound = true;</td></tr><tr><td class="line-number" value="4331"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="4332"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="4333"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4334"></td><td class="line-content"><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="4335"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4336"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4337"></td><td class="line-content"><span class="html-tag">&lt;script&gt;</span></td></tr><tr><td class="line-number" value="4338"></td><td class="line-content">    // =======================================================</td></tr><tr><td class="line-number" value="4339"></td><td class="line-content">    // GENIALIDAD #6 · SIMULADOR DE IMPULSO</td></tr><tr><td class="line-number" value="4340"></td><td class="line-content">    // Suma apoyo a tu partido y estima cuántas secciones adicionales ganas.</td></tr><tr><td class="line-number" value="4341"></td><td class="line-content">    // Modos:</td></tr><tr><td class="line-number" value="4342"></td><td class="line-content">    //   - VOTOS (K global): reparte un presupuesto total de votos K (uniforme / ponderado / solo cercanas).</td></tr><tr><td class="line-number" value="4343"></td><td class="line-content">    //   - PORCENTAJE: incrementa el share del partido en +x% en secciones objetivo.</td></tr><tr><td class="line-number" value="4344"></td><td class="line-content">    // Incluye curva "impulso → secciones ganadas", overlay de flips y tabla clic→zoom.</td></tr><tr><td class="line-number" value="4345"></td><td class="line-content">    // Requiere: AT_CTX.map/layer, loadPuesto/getElectData, AT27_GG_project2027, AT27_GG_shares2024,</td></tr><tr><td class="line-number" value="4346"></td><td class="line-content">    //           y (si existe) AT27_GG_getUniverseSecIds().</td></tr><tr><td class="line-number" value="4347"></td><td class="line-content">    // =======================================================</td></tr><tr><td class="line-number" value="4348"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4349"></td><td class="line-content">    /* ====== Estado y utilidades ====== */</td></tr><tr><td class="line-number" value="4350"></td><td class="line-content">    window.AT27_SI_STATE   = window.AT27_SI_STATE   || { autorun:false, running:false };</td></tr><tr><td class="line-number" value="4351"></td><td class="line-content">    window.AT27_SI_LAYER   = window.AT27_SI_LAYER   || null;   // overlay</td></tr><tr><td class="line-number" value="4352"></td><td class="line-content">    window.AT27_SI_LAYERS  = window.AT27_SI_LAYERS  || {};     // sec -&gt; layer</td></tr><tr><td class="line-number" value="4353"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4354"></td><td class="line-content">    //const sec4   = s =&gt; String(s||'').replace(/\D+/g,'').padStart(4,'0');</td></tr><tr><td class="line-number" value="4355"></td><td class="line-content">    //const clamp  = (x,a,b)=&gt; Math.min(b, Math.max(a, x));</td></tr><tr><td class="line-number" value="4356"></td><td class="line-content">    //const fmtInt = x =&gt; Number.isFinite(x) ? Math.round(x).toLocaleString() : '—';</td></tr><tr><td class="line-number" value="4357"></td><td class="line-content">    //const fmtpp  = x =&gt; (x===null||x===undefined) ? '—' : (Number.isFinite(+x) ? ((x&gt;0?'+':'')+(+x).toFixed(1)+' pp') : '—');</td></tr><tr><td class="line-number" value="4358"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4359"></td><td class="line-content">    function SI_getUniverseSecIds(){</td></tr><tr><td class="line-number" value="4360"></td><td class="line-content">      if (typeof AT27_GG_getUniverseSecIds==='function') return AT27_GG_getUniverseSecIds();</td></tr><tr><td class="line-number" value="4361"></td><td class="line-content">      const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];</td></tr><tr><td class="line-number" value="4362"></td><td class="line-content">      return feats.map(f=&gt; sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id));</td></tr><tr><td class="line-number" value="4363"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="4364"></td><td class="line-content">    async function SI_load(p){ return (window.loadPuesto? loadPuesto(p) : getElectData(p)); }</td></tr><tr><td class="line-number" value="4365"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4366"></td><td class="line-content">    /* ====== Cálculo base 2027 por sección ======</td></tr><tr><td class="line-number" value="4367"></td><td class="line-content">      Construye base por sección:</td></tr><tr><td class="line-number" value="4368"></td><td class="line-content">      - Vproj (votos válidos 2027*), vBase por partido (manteniendo shares 2024),</td></tr><tr><td class="line-number" value="4369"></td><td class="line-content">      - ganador base (L, vL), votos del partido X (vX), faltan base, gap (pp). */</td></tr><tr><td class="line-number" value="4370"></td><td class="line-content">    function SI_baseBySec(js, secIds, puesto, partido){</td></tr><tr><td class="line-number" value="4371"></td><td class="line-content">      const X = partido.toUpperCase();</td></tr><tr><td class="line-number" value="4372"></td><td class="line-content">      const out = {}; // sec -&gt; { Vproj, vBase:{}, vX, vL, L, faltan, gapPP }</td></tr><tr><td class="line-number" value="4373"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4374"></td><td class="line-content">      for (const sec of secIds){</td></tr><tr><td class="line-number" value="4375"></td><td class="line-content">        const slot = js?.secciones?.[sec4(sec)];</td></tr><tr><td class="line-number" value="4376"></td><td class="line-content">        const row24 = slot?.['2024']; if (!row24) continue;</td></tr><tr><td class="line-number" value="4377"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4378"></td><td class="line-content">        const p27 = (typeof AT27_GG_project2027==='function') ? AT27_GG_project2027(slot, puesto) : null;</td></tr><tr><td class="line-number" value="4379"></td><td class="line-content">        const ln24 = Number(row24.LN||0);</td></tr><tr><td class="line-number" value="4380"></td><td class="line-content">        if (p27==null || !ln24) continue;</td></tr><tr><td class="line-number" value="4381"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4382"></td><td class="line-content">        const Vproj = ln24 * (p27/100);</td></tr><tr><td class="line-number" value="4383"></td><td class="line-content">        if (!Number.isFinite(Vproj) || Vproj &lt; 1) continue;</td></tr><tr><td class="line-number" value="4384"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4385"></td><td class="line-content">        // shares 2024</td></tr><tr><td class="line-number" value="4386"></td><td class="line-content">        const { shares, total:tot24 } = (typeof AT27_GG_shares2024==='function')</td></tr><tr><td class="line-number" value="4387"></td><td class="line-content">          ? AT27_GG_shares2024(row24)</td></tr><tr><td class="line-number" value="4388"></td><td class="line-content">          : (function(){</td></tr><tr><td class="line-number" value="4389"></td><td class="line-content">              let vv = (row24.VOTOS!=null)? Number(row24.VOTOS||0) : 0;</td></tr><tr><td class="line-number" value="4390"></td><td class="line-content">              if (row24.VOTOS==null){ for (const [k,v] of Object.entries(row24)){ if (k==='LN'||k==='VOTOS') continue; vv += Number(v||0); } }</td></tr><tr><td class="line-number" value="4391"></td><td class="line-content">              const sh = {};</td></tr><tr><td class="line-number" value="4392"></td><td class="line-content">              for (const [k,v] of Object.entries(row24)){ if (k==='LN'||k==='VOTOS') continue; sh[k.toUpperCase()] = vv? (Number(v||0)/vv) : 0; }</td></tr><tr><td class="line-number" value="4393"></td><td class="line-content">              return { shares:sh, total:vv };</td></tr><tr><td class="line-number" value="4394"></td><td class="line-content">            })();</td></tr><tr><td class="line-number" value="4395"></td><td class="line-content">        if (!Object.keys(shares).length || !tot24) continue;</td></tr><tr><td class="line-number" value="4396"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4397"></td><td class="line-content">        // votos base 2027 (float) por partido</td></tr><tr><td class="line-number" value="4398"></td><td class="line-content">        const vBase = {};</td></tr><tr><td class="line-number" value="4399"></td><td class="line-content">        for (const [sig,sh] of Object.entries(shares)){</td></tr><tr><td class="line-number" value="4400"></td><td class="line-content">          vBase[sig.toUpperCase()] = sh * Vproj;</td></tr><tr><td class="line-number" value="4401"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="4402"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4403"></td><td class="line-content">        let L=null, vL=-1; for (const [sig,vv] of Object.entries(vBase)){ if (vv&gt;vL){ vL=vv; L=sig; } }</td></tr><tr><td class="line-number" value="4404"></td><td class="line-content">        const vX = vBase[X] || 0;</td></tr><tr><td class="line-number" value="4405"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4406"></td><td class="line-content">        const faltan = Math.max(0, (vL - vX) + 1);</td></tr><tr><td class="line-number" value="4407"></td><td class="line-content">        const gapPP  = (vL - vX) / Vproj * 100;</td></tr><tr><td class="line-number" value="4408"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4409"></td><td class="line-content">        out[sec4(sec)] = { Vproj, vBase, vX, vL, L, faltan, gapPP };</td></tr><tr><td class="line-number" value="4410"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="4411"></td><td class="line-content">      return out;</td></tr><tr><td class="line-number" value="4412"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="4413"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4414"></td><td class="line-content">    /* ====== Aplicación del impulso ======</td></tr><tr><td class="line-number" value="4415"></td><td class="line-content">      - modo='votos': repartir K_total entre secciones target según distribución.</td></tr><tr><td class="line-number" value="4416"></td><td class="line-content">      - modo='pct': aumentar vX por factor (1 + x) en secciones target. */</td></tr><tr><td class="line-number" value="4417"></td><td class="line-content">    function SI_applyImpulse(base, partido, modo, K_total, xPct, distrib, nearUmbral){</td></tr><tr><td class="line-number" value="4418"></td><td class="line-content">      const X = partido.toUpperCase();</td></tr><tr><td class="line-number" value="4419"></td><td class="line-content">      const keys = Object.keys(base);</td></tr><tr><td class="line-number" value="4420"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4421"></td><td class="line-content">      // Target set:</td></tr><tr><td class="line-number" value="4422"></td><td class="line-content">      //   - 'solo-cer' → sólo secciones con faltan &lt;= nearUmbral (y que pierdes).</td></tr><tr><td class="line-number" value="4423"></td><td class="line-content">      //   - si no, todas las secciones del universo.</td></tr><tr><td class="line-number" value="4424"></td><td class="line-content">      const target = (distrib==='solo-cer')</td></tr><tr><td class="line-number" value="4425"></td><td class="line-content">        ? keys.filter(s=&gt; base[s].faltan&gt;0 &amp;&amp; base[s].faltan &lt;= nearUmbral)</td></tr><tr><td class="line-number" value="4426"></td><td class="line-content">        : keys.slice();</td></tr><tr><td class="line-number" value="4427"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4428"></td><td class="line-content">      // Pesos para repartir K_total cuando modo=votos</td></tr><tr><td class="line-number" value="4429"></td><td class="line-content">      let weights = null, sumW=0;</td></tr><tr><td class="line-number" value="4430"></td><td class="line-content">      if (modo==='votos'){</td></tr><tr><td class="line-number" value="4431"></td><td class="line-content">        if (distrib==='ponderado'){</td></tr><tr><td class="line-number" value="4432"></td><td class="line-content">          // mayor peso a faltas pequeñas → w = 1 / max(1, faltan)</td></tr><tr><td class="line-number" value="4433"></td><td class="line-content">          weights = {};</td></tr><tr><td class="line-number" value="4434"></td><td class="line-content">          target.forEach(s=&gt;{</td></tr><tr><td class="line-number" value="4435"></td><td class="line-content">            const f = Math.max(1, Math.round(base[s].faltan));</td></tr><tr><td class="line-number" value="4436"></td><td class="line-content">            const w = 1 / f;</td></tr><tr><td class="line-number" value="4437"></td><td class="line-content">            weights[s] = w; sumW += w;</td></tr><tr><td class="line-number" value="4438"></td><td class="line-content">          });</td></tr><tr><td class="line-number" value="4439"></td><td class="line-content">          if (sumW&lt;=0){ weights=null; }</td></tr><tr><td class="line-number" value="4440"></td><td class="line-content">        }else{</td></tr><tr><td class="line-number" value="4441"></td><td class="line-content">          // uniforme (entre target)</td></tr><tr><td class="line-number" value="4442"></td><td class="line-content">          weights = {};</td></tr><tr><td class="line-number" value="4443"></td><td class="line-content">          const w = 1; target.forEach(s=&gt;{ weights[s]=w; }); sumW = w*target.length;</td></tr><tr><td class="line-number" value="4444"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="4445"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="4446"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4447"></td><td class="line-content">      // Resultado por sección con impulso aplicado</td></tr><tr><td class="line-number" value="4448"></td><td class="line-content">      const after = {}; // sec -&gt; { vXp, vLp, Lp, flipped:boolean, asignado:number }</td></tr><tr><td class="line-number" value="4449"></td><td class="line-content">      let flips = 0, used = 0;</td></tr><tr><td class="line-number" value="4450"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4451"></td><td class="line-content">      for (const s of keys){</td></tr><tr><td class="line-number" value="4452"></td><td class="line-content">        const b = base[s];</td></tr><tr><td class="line-number" value="4453"></td><td class="line-content">        let vXp = b.vX, vLp=b.vL, Lp=b.L, asignado=0;</td></tr><tr><td class="line-number" value="4454"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4455"></td><td class="line-content">        if (modo==='votos'){</td></tr><tr><td class="line-number" value="4456"></td><td class="line-content">          if (target.includes(s) &amp;&amp; sumW&gt;0 &amp;&amp; K_total&gt;0){</td></tr><tr><td class="line-number" value="4457"></td><td class="line-content">            const k_i = K_total * (weights[s] / sumW); // votos asignados a la sección s</td></tr><tr><td class="line-number" value="4458"></td><td class="line-content">            asignado = k_i;</td></tr><tr><td class="line-number" value="4459"></td><td class="line-content">            vXp = b.vX + k_i;</td></tr><tr><td class="line-number" value="4460"></td><td class="line-content">          }</td></tr><tr><td class="line-number" value="4461"></td><td class="line-content">        }else{</td></tr><tr><td class="line-number" value="4462"></td><td class="line-content">          // porcentaje: aplicar a target (uniforme); si NO está en target, no se altera</td></tr><tr><td class="line-number" value="4463"></td><td class="line-content">          if (target.includes(s) &amp;&amp; xPct&gt;0){</td></tr><tr><td class="line-number" value="4464"></td><td class="line-content">            vXp = b.vX * (1 + xPct);</td></tr><tr><td class="line-number" value="4465"></td><td class="line-content">          }</td></tr><tr><td class="line-number" value="4466"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="4467"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4468"></td><td class="line-content">        // Recalcular ganador post-impulso (no movemos a los otros partidos)</td></tr><tr><td class="line-number" value="4469"></td><td class="line-content">        if (vXp &gt;= b.vL){ Lp = X; vLp = vXp; }</td></tr><tr><td class="line-number" value="4470"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4471"></td><td class="line-content">        const flipped = (b.L!==X &amp;&amp; Lp===X);</td></tr><tr><td class="line-number" value="4472"></td><td class="line-content">        if (flipped) flips++;</td></tr><tr><td class="line-number" value="4473"></td><td class="line-content">        used += asignado;</td></tr><tr><td class="line-number" value="4474"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4475"></td><td class="line-content">        after[s] = { vXp, Lp, vLp, flipped, asignado };</td></tr><tr><td class="line-number" value="4476"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="4477"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4478"></td><td class="line-content">      return { after, flips, used, targetCount: target.length };</td></tr><tr><td class="line-number" value="4479"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="4480"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4481"></td><td class="line-content">    /* ====== Serie para curva "impulso → secciones ganadas" ====== */</td></tr><tr><td class="line-number" value="4482"></td><td class="line-content">    function SI_makeSeries(base, partido, modo, Kmax, steps, xMax, distrib, nearUmbral){</td></tr><tr><td class="line-number" value="4483"></td><td class="line-content">      const pts = [];</td></tr><tr><td class="line-number" value="4484"></td><td class="line-content">      for (let i=0;i&lt;=steps;i++){</td></tr><tr><td class="line-number" value="4485"></td><td class="line-content">        const t = i/steps;</td></tr><tr><td class="line-number" value="4486"></td><td class="line-content">        const K  = (modo==='votos') ? (t*Kmax) : 0;</td></tr><tr><td class="line-number" value="4487"></td><td class="line-content">        const xp = (modo==='pct')   ? (t*xMax) : 0;</td></tr><tr><td class="line-number" value="4488"></td><td class="line-content">        const { flips } = SI_applyImpulse(base, partido, modo, K, xp, distrib, nearUmbral);</td></tr><tr><td class="line-number" value="4489"></td><td class="line-content">        pts.push({ t, K, x:xp, flips });</td></tr><tr><td class="line-number" value="4490"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="4491"></td><td class="line-content">      return pts;</td></tr><tr><td class="line-number" value="4492"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="4493"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4494"></td><td class="line-content">    /* ====== Overlay ====== */</td></tr><tr><td class="line-number" value="4495"></td><td class="line-content">    function SI_clear(){</td></tr><tr><td class="line-number" value="4496"></td><td class="line-content">      const map = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="4497"></td><td class="line-content">      if (!map) return;</td></tr><tr><td class="line-number" value="4498"></td><td class="line-content">      if (window.AT27_SI_LAYER){ try{ map.removeLayer(AT27_SI_LAYER); }catch(_){};</td></tr><tr><td class="line-number" value="4499"></td><td class="line-content">        window.AT27_SI_LAYER=null; }</td></tr><tr><td class="line-number" value="4500"></td><td class="line-content">      window.AT27_SI_LAYERS = {};</td></tr><tr><td class="line-number" value="4501"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="4502"></td><td class="line-content">    function SI_buildOverlay(base, after, partido){</td></tr><tr><td class="line-number" value="4503"></td><td class="line-content">      const map  = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="4504"></td><td class="line-content">      const baseGeo = window.AT_CTX?.layer?.toGeoJSON?.() || window.AT_DATA;</td></tr><tr><td class="line-number" value="4505"></td><td class="line-content">      if (!map || !baseGeo?.features) return;</td></tr><tr><td class="line-number" value="4506"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4507"></td><td class="line-content">      SI_clear();</td></tr><tr><td class="line-number" value="4508"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4509"></td><td class="line-content">      if (map.createPane &amp;&amp; !map.getPane('at27_si_pane')){</td></tr><tr><td class="line-number" value="4510"></td><td class="line-content">        map.createPane('at27_si_pane');</td></tr><tr><td class="line-number" value="4511"></td><td class="line-content">        const p = map.getPane('at27_si_pane'); p.style.zIndex=730; p.style.pointerEvents='auto';</td></tr><tr><td class="line-number" value="4512"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="4513"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4514"></td><td class="line-content">      const feats = baseGeo.features.filter(f=&gt;{</td></tr><tr><td class="line-number" value="4515"></td><td class="line-content">        const id = sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);</td></tr><tr><td class="line-number" value="4516"></td><td class="line-content">        return base[id]!=null;</td></tr><tr><td class="line-number" value="4517"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="4518"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4519"></td><td class="line-content">      const PARTY_COL = { PAN:'#3b82f6', PRI:'#ef4444', PVEM:'#16a34a', MORENA:'#7f1d1d', OTRO:'#6b7280' };</td></tr><tr><td class="line-number" value="4520"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4521"></td><td class="line-content">      const layer = L.geoJSON({type:'FeatureCollection', features:feats}, {</td></tr><tr><td class="line-number" value="4522"></td><td class="line-content">        pane:'at27_si_pane',</td></tr><tr><td class="line-number" value="4523"></td><td class="line-content">        style: f=&gt;{</td></tr><tr><td class="line-number" value="4524"></td><td class="line-content">          const id = sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);</td></tr><tr><td class="line-number" value="4525"></td><td class="line-content">          const b = base[id], a = after[id];</td></tr><tr><td class="line-number" value="4526"></td><td class="line-content">          const flipped = a?.flipped;</td></tr><tr><td class="line-number" value="4527"></td><td class="line-content">          const color = flipped ? '#22c55e' : '#94a3b8'; // verde = volteada; gris = no</td></tr><tr><td class="line-number" value="4528"></td><td class="line-content">          const fo = flipped ? 0.48 : 0.20;</td></tr><tr><td class="line-number" value="4529"></td><td class="line-content">          return { color, fillColor:color, weight:1, opacity:.9, fillOpacity:fo };</td></tr><tr><td class="line-number" value="4530"></td><td class="line-content">        },</td></tr><tr><td class="line-number" value="4531"></td><td class="line-content">        onEachFeature: (feature, lyr)=&gt;{</td></tr><tr><td class="line-number" value="4532"></td><td class="line-content">          const id = sec4(feature.properties?.ID ?? feature.properties?.SECCION ?? feature.properties?.id);</td></tr><tr><td class="line-number" value="4533"></td><td class="line-content">          window.AT27_SI_LAYERS[id] = lyr;</td></tr><tr><td class="line-number" value="4534"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4535"></td><td class="line-content">          const b = base[id], a= after[id];</td></tr><tr><td class="line-number" value="4536"></td><td class="line-content">          const faltan0 = Math.max(0, Math.ceil(b.vL - b.vX + 1));</td></tr><tr><td class="line-number" value="4537"></td><td class="line-content">          const mpp0    = b.gapPP;</td></tr><tr><td class="line-number" value="4538"></td><td class="line-content">          const flipped = a?.flipped;</td></tr><tr><td class="line-number" value="4539"></td><td class="line-content">          const tip = `</td></tr><tr><td class="line-number" value="4540"></td><td class="line-content">            &lt;div style="font-size:12px;"&gt;</td></tr><tr><td class="line-number" value="4541"></td><td class="line-content">              Sección &lt;b&gt;${id}&lt;/b&gt;&lt;br&gt;</td></tr><tr><td class="line-number" value="4542"></td><td class="line-content">              Base 2027*: líder &lt;b&gt;${b.L}&lt;/b&gt;, tú &lt;b&gt;${fmtInt(b.vX)}&lt;/b&gt;, faltan &lt;b&gt;${fmtInt(faltan0)}&lt;/b&gt;, margen &lt;b&gt;${fmtpp(mpp0)}&lt;/b&gt;&lt;br&gt;</td></tr><tr><td class="line-number" value="4543"></td><td class="line-content">              Con impulso: ${flipped? '&lt;b style="color:#16a34a;"&gt;GANADA&lt;/b&gt;' : '—'}</td></tr><tr><td class="line-number" value="4544"></td><td class="line-content">            &lt;/div&gt;`;</td></tr><tr><td class="line-number" value="4545"></td><td class="line-content">          lyr.bindTooltip(tip, {sticky:true, opacity:.95, direction:'top', className:'at27-tt'});</td></tr><tr><td class="line-number" value="4546"></td><td class="line-content">          lyr.on('mouseover', ()=&gt;lyr.setStyle({weight:2}));</td></tr><tr><td class="line-number" value="4547"></td><td class="line-content">          lyr.on('mouseout',  ()=&gt;lyr.setStyle({weight:1}));</td></tr><tr><td class="line-number" value="4548"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="4549"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="4550"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4551"></td><td class="line-content">      layer.addTo(map);</td></tr><tr><td class="line-number" value="4552"></td><td class="line-content">      window.AT27_SI_LAYER = layer;</td></tr><tr><td class="line-number" value="4553"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="4554"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4555"></td><td class="line-content">    /* ====== Tabla + zoom ====== */</td></tr><tr><td class="line-number" value="4556"></td><td class="line-content">    function SI_renderTable(base, after){</td></tr><tr><td class="line-number" value="4557"></td><td class="line-content">      const tb = document.getElementById('AT27_SI_tbody');</td></tr><tr><td class="line-number" value="4558"></td><td class="line-content">      const rows = Object.entries(base).map(([sec,b])=&gt;{</td></tr><tr><td class="line-number" value="4559"></td><td class="line-content">        const a = after[sec];</td></tr><tr><td class="line-number" value="4560"></td><td class="line-content">        const faltan0 = Math.max(0, Math.ceil(b.vL - b.vX + 1));</td></tr><tr><td class="line-number" value="4561"></td><td class="line-content">        return { sec, faltan0, asignado: a?.asignado||0, flipped: !!a?.flipped };</td></tr><tr><td class="line-number" value="4562"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="4563"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4564"></td><td class="line-content">      rows.sort((A,B)=&gt;{</td></tr><tr><td class="line-number" value="4565"></td><td class="line-content">        if (A.flipped!==B.flipped) return (A.flipped? -1:1); // flipped primero</td></tr><tr><td class="line-number" value="4566"></td><td class="line-content">        return (A.faltan0 - B.faltan0) || (Number(A.sec)-Number(B.sec));</td></tr><tr><td class="line-number" value="4567"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="4568"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4569"></td><td class="line-content">      tb.innerHTML = rows.map(r=&gt;{</td></tr><tr><td class="line-number" value="4570"></td><td class="line-content">        const bg = r.flipped? '#dcfce7' : '';</td></tr><tr><td class="line-number" value="4571"></td><td class="line-content">        return `</td></tr><tr><td class="line-number" value="4572"></td><td class="line-content">          &lt;tr data-sec="${r.sec}" style="cursor:pointer; background:${bg};"&gt;</td></tr><tr><td class="line-number" value="4573"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;"&gt;${r.sec}&lt;/td&gt;</td></tr><tr><td class="line-number" value="4574"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;"&gt;${fmtInt(r.faltan0)}&lt;/td&gt;</td></tr><tr><td class="line-number" value="4575"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;"&gt;${fmtInt(r.asignado)}&lt;/td&gt;</td></tr><tr><td class="line-number" value="4576"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;"&gt;${r.flipped? 'GANADA' : '—'}&lt;/td&gt;</td></tr><tr><td class="line-number" value="4577"></td><td class="line-content">          &lt;/tr&gt;`;</td></tr><tr><td class="line-number" value="4578"></td><td class="line-content">      }).join('');</td></tr><tr><td class="line-number" value="4579"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4580"></td><td class="line-content">      tb.onclick = (e)=&gt;{</td></tr><tr><td class="line-number" value="4581"></td><td class="line-content">        const tr = e.target.closest('tr[data-sec]'); if (!tr) return;</td></tr><tr><td class="line-number" value="4582"></td><td class="line-content">        SI_focus(tr.getAttribute('data-sec'));</td></tr><tr><td class="line-number" value="4583"></td><td class="line-content">      };</td></tr><tr><td class="line-number" value="4584"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="4585"></td><td class="line-content">    function SI_focus(sec){</td></tr><tr><td class="line-number" value="4586"></td><td class="line-content">      const id = sec4(sec);</td></tr><tr><td class="line-number" value="4587"></td><td class="line-content">      const map = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="4588"></td><td class="line-content">      const lyr = window.AT27_SI_LAYERS[id];</td></tr><tr><td class="line-number" value="4589"></td><td class="line-content">      if (!map) return;</td></tr><tr><td class="line-number" value="4590"></td><td class="line-content">      if (lyr){</td></tr><tr><td class="line-number" value="4591"></td><td class="line-content">        try{ map.fitBounds(lyr.getBounds(), {maxZoom:16, padding:[20,20]}); }catch(_){}</td></tr><tr><td class="line-number" value="4592"></td><td class="line-content">        if (lyr.openTooltip) lyr.openTooltip();</td></tr><tr><td class="line-number" value="4593"></td><td class="line-content">        const ofo = lyr.options.fillOpacity ?? .3;</td></tr><tr><td class="line-number" value="4594"></td><td class="line-content">        lyr.setStyle({weight:3, fillOpacity: Math.min(.95, ofo+.25)});</td></tr><tr><td class="line-number" value="4595"></td><td class="line-content">        setTimeout(()=&gt; lyr.setStyle({weight:1, fillOpacity:ofo}), 900);</td></tr><tr><td class="line-number" value="4596"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="4597"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="4598"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4599"></td><td class="line-content">    /* ====== Curva SVG ====== */</td></tr><tr><td class="line-number" value="4600"></td><td class="line-content">    function SI_renderCurve(series, modo, Kmax, xMax){</td></tr><tr><td class="line-number" value="4601"></td><td class="line-content">      const box = document.getElementById('AT27_SI_chart');</td></tr><tr><td class="line-number" value="4602"></td><td class="line-content">      const w = box.clientWidth || 520, h=120, pad=18;</td></tr><tr><td class="line-number" value="4603"></td><td class="line-content">      const maxY = Math.max(1, ...series.map(p=&gt;p.flips));</td></tr><tr><td class="line-number" value="4604"></td><td class="line-content">      const pts = series.map(p=&gt;{</td></tr><tr><td class="line-number" value="4605"></td><td class="line-content">        const x = pad + (w-2*pad) * p.t;</td></tr><tr><td class="line-number" value="4606"></td><td class="line-content">        const y = h - pad - (h-2*pad) * (p.flips/maxY);</td></tr><tr><td class="line-number" value="4607"></td><td class="line-content">        return [x,y];</td></tr><tr><td class="line-number" value="4608"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="4609"></td><td class="line-content">      const d = pts.map((p,i)=&gt; (i? 'L':'M') + p[0].toFixed(1)+','+p[1].toFixed(1)).join(' ');</td></tr><tr><td class="line-number" value="4610"></td><td class="line-content">      const xLabel = (modo==='votos') ? `K (0 → ${fmtInt(Kmax)} votos)` : `Δ share (0 → ${(xMax*100).toFixed(1)}%)`;</td></tr><tr><td class="line-number" value="4611"></td><td class="line-content">      box.innerHTML = `</td></tr><tr><td class="line-number" value="4612"></td><td class="line-content">        &lt;svg width="100%" height="${h}" viewBox="0 0 ${w} ${h}"&gt;</td></tr><tr><td class="line-number" value="4613"></td><td class="line-content">          &lt;rect x="0" y="0" width="${w}" height="${h}" fill="#f8fafc" rx="8"/&gt;</td></tr><tr><td class="line-number" value="4614"></td><td class="line-content">          &lt;path d="${d}" fill="none" stroke="#0ea5e9" stroke-width="2"/&gt;</td></tr><tr><td class="line-number" value="4615"></td><td class="line-content">          &lt;text x="${w/2}" y="${h-4}" text-anchor="middle" font-size="10" fill="#334155"&gt;${xLabel}&lt;/text&gt;</td></tr><tr><td class="line-number" value="4616"></td><td class="line-content">          &lt;text x="${pad}" y="12" font-size="10" fill="#334155"&gt;Secciones ganadas&lt;/text&gt;</td></tr><tr><td class="line-number" value="4617"></td><td class="line-content">        &lt;/svg&gt;`;</td></tr><tr><td class="line-number" value="4618"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="4619"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4620"></td><td class="line-content">    /* ====== RUN ====== */</td></tr><tr><td class="line-number" value="4621"></td><td class="line-content">    async function AT27_SI_run(){</td></tr><tr><td class="line-number" value="4622"></td><td class="line-content">      if (window.AT27_SI_STATE.running) return;</td></tr><tr><td class="line-number" value="4623"></td><td class="line-content">      window.AT27_SI_STATE.running = true;</td></tr><tr><td class="line-number" value="4624"></td><td class="line-content">      try{</td></tr><tr><td class="line-number" value="4625"></td><td class="line-content">        const puesto   = document.getElementById('AT27_SI_selPuesto').value;</td></tr><tr><td class="line-number" value="4626"></td><td class="line-content">        const partido  = document.getElementById('AT27_SI_selPartido').value.toUpperCase();</td></tr><tr><td class="line-number" value="4627"></td><td class="line-content">        const modo     = document.querySelector('input[name="AT27_SI_modo"]:checked').value; // votos|pct</td></tr><tr><td class="line-number" value="4628"></td><td class="line-content">        const distrib  = document.getElementById('AT27_SI_distrib').value; // uniforme|ponderado|solo-cer</td></tr><tr><td class="line-number" value="4629"></td><td class="line-content">        const nearUmbral = Number(document.getElementById('AT27_SI_umbral').value || 250);</td></tr><tr><td class="line-number" value="4630"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4631"></td><td class="line-content">        const Kmax     = Number(document.getElementById('AT27_SI_K').value || 20000);  // voto presupuesto máx</td></tr><tr><td class="line-number" value="4632"></td><td class="line-content">        const steps    = 20; // puntos de la curva</td></tr><tr><td class="line-number" value="4633"></td><td class="line-content">        const xMax     = Number(document.getElementById('AT27_SI_X').value || 0.20);   // 20% share máx</td></tr><tr><td class="line-number" value="4634"></td><td class="line-content">        const Kactual  = Number(document.getElementById('AT27_SI_K_now').value || 0);</td></tr><tr><td class="line-number" value="4635"></td><td class="line-content">        const Xactual  = Number(document.getElementById('AT27_SI_X_now').value || 0);</td></tr><tr><td class="line-number" value="4636"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4637"></td><td class="line-content">        const secIds = SI_getUniverseSecIds();</td></tr><tr><td class="line-number" value="4638"></td><td class="line-content">        if (!secIds.length){ SI_clear(); document.getElementById('AT27_SI_tbody').innerHTML=''; return; }</td></tr><tr><td class="line-number" value="4639"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4640"></td><td class="line-content">        const js   = await SI_load(puesto);</td></tr><tr><td class="line-number" value="4641"></td><td class="line-content">        const base = SI_baseBySec(js, secIds, puesto, partido);</td></tr><tr><td class="line-number" value="4642"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4643"></td><td class="line-content">        // Serie</td></tr><tr><td class="line-number" value="4644"></td><td class="line-content">        const serie = SI_makeSeries(base, partido, modo, Kmax, steps, xMax, distrib, nearUmbral);</td></tr><tr><td class="line-number" value="4645"></td><td class="line-content">        SI_renderCurve(serie, modo, Kmax, xMax);</td></tr><tr><td class="line-number" value="4646"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4647"></td><td class="line-content">        // Resultado puntual (slider actual)</td></tr><tr><td class="line-number" value="4648"></td><td class="line-content">        const { after, flips, used, targetCount } = SI_applyImpulse(</td></tr><tr><td class="line-number" value="4649"></td><td class="line-content">          base, partido, modo,</td></tr><tr><td class="line-number" value="4650"></td><td class="line-content">          (modo==='votos') ? Kactual : 0,</td></tr><tr><td class="line-number" value="4651"></td><td class="line-content">          (modo==='pct')   ? Xactual : 0,</td></tr><tr><td class="line-number" value="4652"></td><td class="line-content">          distrib, nearUmbral</td></tr><tr><td class="line-number" value="4653"></td><td class="line-content">        );</td></tr><tr><td class="line-number" value="4654"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4655"></td><td class="line-content">        // Overlay + tabla + resumen</td></tr><tr><td class="line-number" value="4656"></td><td class="line-content">        SI_buildOverlay(base, after, partido);</td></tr><tr><td class="line-number" value="4657"></td><td class="line-content">        SI_renderTable(base, after);</td></tr><tr><td class="line-number" value="4658"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4659"></td><td class="line-content">        const sum = document.getElementById('AT27_SI_summary');</td></tr><tr><td class="line-number" value="4660"></td><td class="line-content">        // Base ganadas (sin impulso)</td></tr><tr><td class="line-number" value="4661"></td><td class="line-content">        let baseWins=0; Object.values(base).forEach(b=&gt;{ if (b.L===partido) baseWins++; });</td></tr><tr><td class="line-number" value="4662"></td><td class="line-content">        sum.innerHTML = `</td></tr><tr><td class="line-number" value="4663"></td><td class="line-content">          &lt;div style="font-size:12px; line-height:1.4;"&gt;</td></tr><tr><td class="line-number" value="4664"></td><td class="line-content">            Objetivo: &lt;b&gt;${partido}&lt;/b&gt; — Universo: &lt;b&gt;${secIds.length}&lt;/b&gt; secciones · Target: &lt;b&gt;${targetCount}&lt;/b&gt;&lt;br&gt;</td></tr><tr><td class="line-number" value="4665"></td><td class="line-content">            Ganadas base: &lt;b&gt;${baseWins}&lt;/b&gt; · Con impulso: &lt;b&gt;${baseWins+flips}&lt;/b&gt; (&lt;b&gt;+${flips}&lt;/b&gt;)&lt;br&gt;</td></tr><tr><td class="line-number" value="4666"></td><td class="line-content">            ${modo==='votos'</td></tr><tr><td class="line-number" value="4667"></td><td class="line-content">              ? `Presupuesto usado: &lt;b&gt;${fmtInt(used)}&lt;/b&gt; (de ${fmtInt(Kactual)})`</td></tr><tr><td class="line-number" value="4668"></td><td class="line-content">              : `Incremento aplicado: &lt;b&gt;${(Xactual*100).toFixed(1)}%&lt;/b&gt; en secciones objetivo`}</td></tr><tr><td class="line-number" value="4669"></td><td class="line-content">          &lt;/div&gt;`;</td></tr><tr><td class="line-number" value="4670"></td><td class="line-content">      }catch(e){</td></tr><tr><td class="line-number" value="4671"></td><td class="line-content">        console.error('AT27_SI_run', e);</td></tr><tr><td class="line-number" value="4672"></td><td class="line-content">        alert('No pude ejecutar “Simulador de impulso”.');</td></tr><tr><td class="line-number" value="4673"></td><td class="line-content">      }finally{</td></tr><tr><td class="line-number" value="4674"></td><td class="line-content">        window.AT27_SI_STATE.running = false;</td></tr><tr><td class="line-number" value="4675"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="4676"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="4677"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4678"></td><td class="line-content">    /* ====== Panel UI ====== */</td></tr><tr><td class="line-number" value="4679"></td><td class="line-content">    function AT27_SI_open(){</td></tr><tr><td class="line-number" value="4680"></td><td class="line-content">      let panel = document.getElementById('AT27_SI_panel');</td></tr><tr><td class="line-number" value="4681"></td><td class="line-content">      if (panel){ panel.style.display='block'; return; }</td></tr><tr><td class="line-number" value="4682"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4683"></td><td class="line-content">      panel = document.createElement('div');</td></tr><tr><td class="line-number" value="4684"></td><td class="line-content">      panel.id = 'AT27_SI_panel';</td></tr><tr><td class="line-number" value="4685"></td><td class="line-content">      Object.assign(panel.style,{</td></tr><tr><td class="line-number" value="4686"></td><td class="line-content">        position:'fixed', right:'24px', top:'24px', zIndex:9998,</td></tr><tr><td class="line-number" value="4687"></td><td class="line-content">        width:'620px', maxWidth:'calc(100vw - 40px)', maxHeight:'calc(100vh - 40px)',</td></tr><tr><td class="line-number" value="4688"></td><td class="line-content">        background:'#fff', border:'1px solid #e5e7eb', borderRadius:'14px',</td></tr><tr><td class="line-number" value="4689"></td><td class="line-content">        boxShadow:'0 18px 40px rgba(0,0,0,.18)', display:'flex', flexDirection:'column',</td></tr><tr><td class="line-number" value="4690"></td><td class="line-content">        overflow:'hidden', resize:'both', minWidth:'420px', minHeight:'320px'</td></tr><tr><td class="line-number" value="4691"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="4692"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4693"></td><td class="line-content">      panel.innerHTML = `</td></tr><tr><td class="line-number" value="4694"></td><td class="line-content">        &lt;div id="AT27_SI_hdr" style="cursor:move; user-select:none; background:#ecfeff; color:#111; padding:10px 12px; display:flex; gap:10px; align-items:center;"&gt;</td></tr><tr><td class="line-number" value="4695"></td><td class="line-content">          &lt;div style="font-weight:800;"&gt;Simulador de impulso&lt;/div&gt;</td></tr><tr><td class="line-number" value="4696"></td><td class="line-content">          &lt;button id="AT27_SI_center" style="margin-left:auto; background:#eef2ff; border:1px solid #c7d2fe; border-radius:8px; padding:4px 8px; cursor:pointer;"&gt;Recentrar&lt;/button&gt;</td></tr><tr><td class="line-number" value="4697"></td><td class="line-content">          &lt;button id="AT27_SI_close" title="Cerrar" style="background:transparent;border:none;font-size:18px;cursor:pointer;"&gt;×&lt;/button&gt;</td></tr><tr><td class="line-number" value="4698"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="4699"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4700"></td><td class="line-content">        &lt;div style="padding:10px 12px; display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:end;"&gt;</td></tr><tr><td class="line-number" value="4701"></td><td class="line-content">          &lt;label style="font-size:12px;"&gt;Puesto&lt;br&gt;</td></tr><tr><td class="line-number" value="4702"></td><td class="line-content">            &lt;select id="AT27_SI_selPuesto" class="ttb-select" style="width:100%;"&gt;</td></tr><tr><td class="line-number" value="4703"></td><td class="line-content">              &lt;option value="A"&gt;Ayuntamiento&lt;/option&gt;</td></tr><tr><td class="line-number" value="4704"></td><td class="line-content">              &lt;option value="DL"&gt;Diputado Local&lt;/option&gt;</td></tr><tr><td class="line-number" value="4705"></td><td class="line-content">              &lt;option value="DF"&gt;Diputado Federal&lt;/option&gt;</td></tr><tr><td class="line-number" value="4706"></td><td class="line-content">            &lt;/select&gt;</td></tr><tr><td class="line-number" value="4707"></td><td class="line-content">          &lt;/label&gt;</td></tr><tr><td class="line-number" value="4708"></td><td class="line-content">          &lt;label style="font-size:12px;"&gt;Partido&lt;br&gt;</td></tr><tr><td class="line-number" value="4709"></td><td class="line-content">            &lt;select id="AT27_SI_selPartido" class="ttb-select" style="width:100%;"&gt;</td></tr><tr><td class="line-number" value="4710"></td><td class="line-content">              &lt;option&gt;PAN&lt;/option&gt;&lt;option&gt;PRI&lt;/option&gt;&lt;option&gt;PVEM&lt;/option&gt;&lt;option&gt;MORENA&lt;/option&gt;</td></tr><tr><td class="line-number" value="4711"></td><td class="line-content">            &lt;/select&gt;</td></tr><tr><td class="line-number" value="4712"></td><td class="line-content">          &lt;/label&gt;</td></tr><tr><td class="line-number" value="4713"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4714"></td><td class="line-content">          &lt;div style="grid-column:1 / span 2; display:flex; gap:16px; align-items:center; font-size:12px;"&gt;</td></tr><tr><td class="line-number" value="4715"></td><td class="line-content">            Modo:</td></tr><tr><td class="line-number" value="4716"></td><td class="line-content">            &lt;label&gt;&lt;input type="radio" name="AT27_SI_modo" value="votos" checked&gt; votos (K global)&lt;/label&gt;</td></tr><tr><td class="line-number" value="4717"></td><td class="line-content">            &lt;label&gt;&lt;input type="radio" name="AT27_SI_modo" value="pct"&gt; porcentaje (+x% share)&lt;/label&gt;</td></tr><tr><td class="line-number" value="4718"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4719"></td><td class="line-content">            &lt;span style="opacity:.7;"&gt;Distribución:&lt;/span&gt;</td></tr><tr><td class="line-number" value="4720"></td><td class="line-content">            &lt;select id="AT27_SI_distrib" class="ttb-select" style="width:160px;"&gt;</td></tr><tr><td class="line-number" value="4721"></td><td class="line-content">              &lt;option value="uniforme"&gt;Uniforme&lt;/option&gt;</td></tr><tr><td class="line-number" value="4722"></td><td class="line-content">              &lt;option value="ponderado"&gt;Ponderado por brecha&lt;/option&gt;</td></tr><tr><td class="line-number" value="4723"></td><td class="line-content">              &lt;option value="solo-cer"&gt;Solo cercanas&lt;/option&gt;</td></tr><tr><td class="line-number" value="4724"></td><td class="line-content">            &lt;/select&gt;</td></tr><tr><td class="line-number" value="4725"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4726"></td><td class="line-content">            &lt;span style="opacity:.7;"&gt;Cercanas ≤ (faltan)&lt;/span&gt;</td></tr><tr><td class="line-number" value="4727"></td><td class="line-content">            &lt;input id="AT27_SI_umbral" type="number" value="250" style="width:90px; padding:4px 6px; border:1px solid #e5e7eb; border-radius:8px;"&gt;</td></tr><tr><td class="line-number" value="4728"></td><td class="line-content">          &lt;/div&gt;</td></tr><tr><td class="line-number" value="4729"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4730"></td><td class="line-content">          &lt;div id="AT27_SI_ctrlVotos" style="grid-column:1 / span 2; display:flex; gap:12px; align-items:center; font-size:12px;"&gt;</td></tr><tr><td class="line-number" value="4731"></td><td class="line-content">            Presupuesto K (máx)</td></tr><tr><td class="line-number" value="4732"></td><td class="line-content">            &lt;input id="AT27_SI_K" type="number" value="20000" style="width:110px; padding:4px 6px; border:1px solid #e5e7eb; border-radius:8px;"&gt;</td></tr><tr><td class="line-number" value="4733"></td><td class="line-content">            K actual</td></tr><tr><td class="line-number" value="4734"></td><td class="line-content">            &lt;input id="AT27_SI_K_now" type="range" min="0" max="20000" step="200" value="600" style="flex:1;"&gt;</td></tr><tr><td class="line-number" value="4735"></td><td class="line-content">            &lt;span id="AT27_SI_lblK" style="min-width:70px; text-align:right;"&gt;600&lt;/span&gt;</td></tr><tr><td class="line-number" value="4736"></td><td class="line-content">          &lt;/div&gt;</td></tr><tr><td class="line-number" value="4737"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4738"></td><td class="line-content">          &lt;div id="AT27_SI_ctrlPct" style="grid-column:1 / span 2; display:none; gap:12px; align-items:center; font-size:12px;"&gt;</td></tr><tr><td class="line-number" value="4739"></td><td class="line-content">            Δ share (máx)</td></tr><tr><td class="line-number" value="4740"></td><td class="line-content">            &lt;input id="AT27_SI_X" type="number" value="0.20" step="0.01" style="width:90px; padding:4px 6px; border:1px solid #e5e7eb; border-radius:8px;"&gt;</td></tr><tr><td class="line-number" value="4741"></td><td class="line-content">            Δ actual</td></tr><tr><td class="line-number" value="4742"></td><td class="line-content">            &lt;input id="AT27_SI_X_now" type="range" min="0" max="0.20" step="0.005" value="0.02" style="flex:1;"&gt;</td></tr><tr><td class="line-number" value="4743"></td><td class="line-content">            &lt;span id="AT27_SI_lblX" style="min-width:70px; text-align:right;"&gt;2.0%&lt;/span&gt;</td></tr><tr><td class="line-number" value="4744"></td><td class="line-content">          &lt;/div&gt;</td></tr><tr><td class="line-number" value="4745"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4746"></td><td class="line-content">          &lt;button id="AT27_SI_run" class="ttb-btn ttb-primary" style="grid-column:1 / span 2;"&gt;Ejecutar&lt;/button&gt;</td></tr><tr><td class="line-number" value="4747"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="4748"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4749"></td><td class="line-content">        &lt;div style="padding:8px 12px; display:grid; grid-template-columns: 1fr; gap:6px;"&gt;</td></tr><tr><td class="line-number" value="4750"></td><td class="line-content">          &lt;div id="AT27_SI_summary" style="font-size:12px; color:#334155;"&gt;&lt;/div&gt;</td></tr><tr><td class="line-number" value="4751"></td><td class="line-content">          &lt;div id="AT27_SI_chart" style="width:100%; height:120px;"&gt;&lt;/div&gt;</td></tr><tr><td class="line-number" value="4752"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="4753"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4754"></td><td class="line-content">        &lt;div style="flex:1; overflow:auto;"&gt;</td></tr><tr><td class="line-number" value="4755"></td><td class="line-content">          &lt;table style="width:100%; border-collapse:collapse; font-size:12px;"&gt;</td></tr><tr><td class="line-number" value="4756"></td><td class="line-content">            &lt;thead&gt;</td></tr><tr><td class="line-number" value="4757"></td><td class="line-content">              &lt;tr style="position:sticky; top:0; background:#f8fafc;"&gt;</td></tr><tr><td class="line-number" value="4758"></td><td class="line-content">                &lt;th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Sección&lt;/th&gt;</td></tr><tr><td class="line-number" value="4759"></td><td class="line-content">                &lt;th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Faltan base&lt;/th&gt;</td></tr><tr><td class="line-number" value="4760"></td><td class="line-content">                &lt;th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Asignado&lt;/th&gt;</td></tr><tr><td class="line-number" value="4761"></td><td class="line-content">                &lt;th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Estado&lt;/th&gt;</td></tr><tr><td class="line-number" value="4762"></td><td class="line-content">              &lt;/tr&gt;</td></tr><tr><td class="line-number" value="4763"></td><td class="line-content">            &lt;/thead&gt;</td></tr><tr><td class="line-number" value="4764"></td><td class="line-content">            &lt;tbody id="AT27_SI_tbody"&gt;&lt;/tbody&gt;</td></tr><tr><td class="line-number" value="4765"></td><td class="line-content">          &lt;/table&gt;</td></tr><tr><td class="line-number" value="4766"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="4767"></td><td class="line-content">      `;</td></tr><tr><td class="line-number" value="4768"></td><td class="line-content">      document.body.appendChild(panel);</td></tr><tr><td class="line-number" value="4769"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4770"></td><td class="line-content">      // Wire UI</td></tr><tr><td class="line-number" value="4771"></td><td class="line-content">      const $$ = (sel)=&gt; panel.querySelector(sel);</td></tr><tr><td class="line-number" value="4772"></td><td class="line-content">      $$('#AT27_SI_close').onclick  = ()=&gt; panel.style.display='none';</td></tr><tr><td class="line-number" value="4773"></td><td class="line-content">      $$('#AT27_SI_center').onclick = ()=&gt; (window.AT27_fitUniverseBounds? AT27_fitUniverseBounds() : null);</td></tr><tr><td class="line-number" value="4774"></td><td class="line-content">      $$('#AT27_SI_run').onclick    = ()=&gt;{ window.AT27_SI_STATE.autorun = true; AT27_SI_run(); };</td></tr><tr><td class="line-number" value="4775"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4776"></td><td class="line-content">      // Sincronizar sliders/inputs</td></tr><tr><td class="line-number" value="4777"></td><td class="line-content">      const syncK = ()=&gt;{</td></tr><tr><td class="line-number" value="4778"></td><td class="line-content">        const Kmax = Number($$('#AT27_SI_K').value||20000);</td></tr><tr><td class="line-number" value="4779"></td><td class="line-content">        const now  = Number($$('#AT27_SI_K_now').value||0);</td></tr><tr><td class="line-number" value="4780"></td><td class="line-content">        $$('#AT27_SI_K_now').max = String(Kmax);</td></tr><tr><td class="line-number" value="4781"></td><td class="line-content">        if (now&gt;Kmax){ $$('#AT27_SI_K_now').value = String(Kmax); }</td></tr><tr><td class="line-number" value="4782"></td><td class="line-content">        $$('#AT27_SI_lblK').textContent = fmtInt(Number($$('#AT27_SI_K_now').value||0));</td></tr><tr><td class="line-number" value="4783"></td><td class="line-content">      };</td></tr><tr><td class="line-number" value="4784"></td><td class="line-content">      const syncX = ()=&gt;{</td></tr><tr><td class="line-number" value="4785"></td><td class="line-content">        const Xmax = Number($$('#AT27_SI_X').value||0.20);</td></tr><tr><td class="line-number" value="4786"></td><td class="line-content">        const now  = Number($$('#AT27_SI_X_now').value||0);</td></tr><tr><td class="line-number" value="4787"></td><td class="line-content">        $$('#AT27_SI_X_now').max = String(Xmax);</td></tr><tr><td class="line-number" value="4788"></td><td class="line-content">        if (now&gt;Xmax){ $$('#AT27_SI_X_now').value = String(Xmax); }</td></tr><tr><td class="line-number" value="4789"></td><td class="line-content">        $$('#AT27_SI_lblX').textContent = (Number($$('#AT27_SI_X_now').value||0)*100).toFixed(1)+'%';</td></tr><tr><td class="line-number" value="4790"></td><td class="line-content">      };</td></tr><tr><td class="line-number" value="4791"></td><td class="line-content">      $$('#AT27_SI_K').addEventListener('input', syncK);</td></tr><tr><td class="line-number" value="4792"></td><td class="line-content">      $$('#AT27_SI_K_now').addEventListener('input', syncK);</td></tr><tr><td class="line-number" value="4793"></td><td class="line-content">      $$('#AT27_SI_X').addEventListener('input', syncX);</td></tr><tr><td class="line-number" value="4794"></td><td class="line-content">      $$('#AT27_SI_X_now').addEventListener('input', syncX);</td></tr><tr><td class="line-number" value="4795"></td><td class="line-content">      syncK(); syncX();</td></tr><tr><td class="line-number" value="4796"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4797"></td><td class="line-content">      // Toggle controles por modo</td></tr><tr><td class="line-number" value="4798"></td><td class="line-content">      panel.querySelectorAll('input[name="AT27_SI_modo"]').forEach(r=&gt;{</td></tr><tr><td class="line-number" value="4799"></td><td class="line-content">        r.addEventListener('change', ()=&gt;{</td></tr><tr><td class="line-number" value="4800"></td><td class="line-content">          const modo = panel.querySelector('input[name="AT27_SI_modo"]:checked').value;</td></tr><tr><td class="line-number" value="4801"></td><td class="line-content">          $$('#AT27_SI_ctrlVotos').style.display = (modo==='votos')? 'flex':'none';</td></tr><tr><td class="line-number" value="4802"></td><td class="line-content">          $$('#AT27_SI_ctrlPct').style.display   = (modo==='pct')  ? 'flex':'none';</td></tr><tr><td class="line-number" value="4803"></td><td class="line-content">        });</td></tr><tr><td class="line-number" value="4804"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="4805"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4806"></td><td class="line-content">      // Drag y bloqueo de eventos al mapa</td></tr><tr><td class="line-number" value="4807"></td><td class="line-content">      (function drag(panelEl, handleEl){</td></tr><tr><td class="line-number" value="4808"></td><td class="line-content">        let sx=0, sy=0, ox=0, oy=0, dragging=false;</td></tr><tr><td class="line-number" value="4809"></td><td class="line-content">        handleEl.addEventListener('mousedown', e=&gt;{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panelEl.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });</td></tr><tr><td class="line-number" value="4810"></td><td class="line-content">        window.addEventListener('mousemove', e=&gt;{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panelEl.style.left=(ox+dx)+'px'; panelEl.style.top=(oy+dy)+'px'; panelEl.style.right='auto'; });</td></tr><tr><td class="line-number" value="4811"></td><td class="line-content">        window.addEventListener('mouseup', ()=&gt;{ dragging=false; document.body.style.userSelect=''; });</td></tr><tr><td class="line-number" value="4812"></td><td class="line-content">      })(panel, panel.querySelector('#AT27_SI_hdr'));</td></tr><tr><td class="line-number" value="4813"></td><td class="line-content">      if (window.L &amp;&amp; L.DomEvent){ L.DomEvent.disableClickPropagation(panel); L.DomEvent.disableScrollPropagation(panel); }</td></tr><tr><td class="line-number" value="4814"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4815"></td><td class="line-content">      // Recalcular si cambias universo (tras primer run)</td></tr><tr><td class="line-number" value="4816"></td><td class="line-content">      const map = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="4817"></td><td class="line-content">      if (map &amp;&amp; !map.__siBound){</td></tr><tr><td class="line-number" value="4818"></td><td class="line-content">        const deb = (fn,ms=350)=&gt;{ let t; return (...a)=&gt;{ clearTimeout(t); t=setTimeout(()=&gt;fn(...a),ms); }; };</td></tr><tr><td class="line-number" value="4819"></td><td class="line-content">        map.on('layeradd',    deb(()=&gt;{ if (window.AT27_SI_STATE.autorun) AT27_SI_run(); }));</td></tr><tr><td class="line-number" value="4820"></td><td class="line-content">        map.on('layerremove', deb(()=&gt;{ if (window.AT27_SI_STATE.autorun) AT27_SI_run(); }));</td></tr><tr><td class="line-number" value="4821"></td><td class="line-content">        map.__siBound = true;</td></tr><tr><td class="line-number" value="4822"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="4823"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="4824"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4825"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4826"></td><td class="line-content"><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="4827"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4828"></td><td class="line-content"><span class="html-tag">&lt;script&gt;</span></td></tr><tr><td class="line-number" value="4829"></td><td class="line-content">    // =======================================================</td></tr><tr><td class="line-number" value="4830"></td><td class="line-content">    // GENIALIDAD #7 · MAPA DE BRECHA RELATIVA VS. ABSOLUTA</td></tr><tr><td class="line-number" value="4831"></td><td class="line-content">    // Muestra, para cada sección, la brecha:</td></tr><tr><td class="line-number" value="4832"></td><td class="line-content">    //   - ABSOLUTA (votos que faltan para rebasar = faltan)</td></tr><tr><td class="line-number" value="4833"></td><td class="line-content">    //   - RELATIVA (pp = (vL − vX) / Vproj × 100)</td></tr><tr><td class="line-number" value="4834"></td><td class="line-content">    // Colores: Rojo = pierde (intensidad según brecha). Gris tenue = gana.</td></tr><tr><td class="line-number" value="4835"></td><td class="line-content">    // Incluye tabla (clic → zoom) y se recalcula al cambiar universo.</td></tr><tr><td class="line-number" value="4836"></td><td class="line-content">    // Requiere: AT_CTX.map/layer, loadPuesto/getElectData, AT27_GG_project2027, AT27_GG_shares2024.</td></tr><tr><td class="line-number" value="4837"></td><td class="line-content">    // =======================================================</td></tr><tr><td class="line-number" value="4838"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4839"></td><td class="line-content">    /* ====== Estado y utilidades ====== */</td></tr><tr><td class="line-number" value="4840"></td><td class="line-content">    window.AT27_BR_STATE  = window.AT27_BR_STATE  || { autorun:false, running:false };</td></tr><tr><td class="line-number" value="4841"></td><td class="line-content">    window.AT27_BR_LAYER  = window.AT27_BR_LAYER  || null;</td></tr><tr><td class="line-number" value="4842"></td><td class="line-content">    window.AT27_BR_LAYERS = window.AT27_BR_LAYERS || {};   // sec -&gt; layer</td></tr><tr><td class="line-number" value="4843"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4844"></td><td class="line-content">    //const sec4   = s =&gt; String(s||'').replace(/\D+/g,'').padStart(4,'0');</td></tr><tr><td class="line-number" value="4845"></td><td class="line-content">    //const fmtInt = x =&gt; Number.isFinite(x) ? Math.round(x).toLocaleString() : '—';</td></tr><tr><td class="line-number" value="4846"></td><td class="line-content">    //const fmtpp  = x =&gt; (x===null||x===undefined) ? '—' : (Number.isFinite(+x) ? ((x&gt;0?'+':'')+(+x).toFixed(1)+' pp') : '—');</td></tr><tr><td class="line-number" value="4847"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4848"></td><td class="line-content">    const BR_COLORS = { LOSE:'#ef4444', WIN:'#9ca3af', NA:'#cbd5e1' };</td></tr><tr><td class="line-number" value="4849"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4850"></td><td class="line-content">    function BR_getUniverseSecIds(){</td></tr><tr><td class="line-number" value="4851"></td><td class="line-content">      const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];</td></tr><tr><td class="line-number" value="4852"></td><td class="line-content">      return feats.map(f=&gt; sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id));</td></tr><tr><td class="line-number" value="4853"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="4854"></td><td class="line-content">    async function BR_load(p){ return (window.loadPuesto? loadPuesto(p) : getElectData(p)); }</td></tr><tr><td class="line-number" value="4855"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4856"></td><td class="line-content">    /* ====== Base 2027 por sección ====== */</td></tr><tr><td class="line-number" value="4857"></td><td class="line-content">    function BR_baseBySec(js, secIds, puesto, partido){</td></tr><tr><td class="line-number" value="4858"></td><td class="line-content">      const X = partido.toUpperCase();</td></tr><tr><td class="line-number" value="4859"></td><td class="line-content">      const out = {}; // sec -&gt; { Vproj, vX, vL, L, faltan, gapPP }</td></tr><tr><td class="line-number" value="4860"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4861"></td><td class="line-content">      for (const sec of secIds){</td></tr><tr><td class="line-number" value="4862"></td><td class="line-content">        const slot = js?.secciones?.[sec4(sec)];</td></tr><tr><td class="line-number" value="4863"></td><td class="line-content">        const row24 = slot?.['2024']; if (!row24) continue;</td></tr><tr><td class="line-number" value="4864"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4865"></td><td class="line-content">        const p27  = (typeof AT27_GG_project2027==='function') ? AT27_GG_project2027(slot, puesto) : null;</td></tr><tr><td class="line-number" value="4866"></td><td class="line-content">        const ln24 = Number(row24.LN||0);</td></tr><tr><td class="line-number" value="4867"></td><td class="line-content">        if (p27==null || !ln24) continue;</td></tr><tr><td class="line-number" value="4868"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4869"></td><td class="line-content">        const Vproj = ln24 * (p27/100);</td></tr><tr><td class="line-number" value="4870"></td><td class="line-content">        if (!Number.isFinite(Vproj) || Vproj&lt;1) continue;</td></tr><tr><td class="line-number" value="4871"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4872"></td><td class="line-content">        // shares 2024 → votos base 2027</td></tr><tr><td class="line-number" value="4873"></td><td class="line-content">        const { shares, total:tot24 } = (typeof AT27_GG_shares2024==='function')</td></tr><tr><td class="line-number" value="4874"></td><td class="line-content">          ? AT27_GG_shares2024(row24)</td></tr><tr><td class="line-number" value="4875"></td><td class="line-content">          : (function(){</td></tr><tr><td class="line-number" value="4876"></td><td class="line-content">              let vv = (row24.VOTOS!=null)? Number(row24.VOTOS||0) : 0;</td></tr><tr><td class="line-number" value="4877"></td><td class="line-content">              if (row24.VOTOS==null){ for (const [k,v] of Object.entries(row24)){ if (k==='LN'||k==='VOTOS') continue; vv += Number(v||0); } }</td></tr><tr><td class="line-number" value="4878"></td><td class="line-content">              const sh = {};</td></tr><tr><td class="line-number" value="4879"></td><td class="line-content">              for (const [k,v] of Object.entries(row24)){ if (k==='LN'||k==='VOTOS') continue; sh[k.toUpperCase()] = vv? (Number(v||0)/vv) : 0; }</td></tr><tr><td class="line-number" value="4880"></td><td class="line-content">              return { shares:sh, total:vv };</td></tr><tr><td class="line-number" value="4881"></td><td class="line-content">            })();</td></tr><tr><td class="line-number" value="4882"></td><td class="line-content">        if (!Object.keys(shares).length || !tot24) continue;</td></tr><tr><td class="line-number" value="4883"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4884"></td><td class="line-content">        let L=null, vL=-1, vX=0;</td></tr><tr><td class="line-number" value="4885"></td><td class="line-content">        for (const [sig,sh] of Object.entries(shares)){</td></tr><tr><td class="line-number" value="4886"></td><td class="line-content">          const vv = sh * Vproj;</td></tr><tr><td class="line-number" value="4887"></td><td class="line-content">          if (sig.toUpperCase()===X) vX = vv;</td></tr><tr><td class="line-number" value="4888"></td><td class="line-content">          if (vv&gt;vL){ vL=vv; L=sig.toUpperCase(); }</td></tr><tr><td class="line-number" value="4889"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="4890"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4891"></td><td class="line-content">        const faltan = Math.max(0, (vL - vX) + 1);</td></tr><tr><td class="line-number" value="4892"></td><td class="line-content">        const gapPP  = (vL - vX) / Vproj * 100;</td></tr><tr><td class="line-number" value="4893"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4894"></td><td class="line-content">        out[sec4(sec)] = { Vproj, vX, vL, L, faltan, gapPP };</td></tr><tr><td class="line-number" value="4895"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="4896"></td><td class="line-content">      return out;</td></tr><tr><td class="line-number" value="4897"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="4898"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4899"></td><td class="line-content">    /* ====== Overlay ====== */</td></tr><tr><td class="line-number" value="4900"></td><td class="line-content">    function BR_clear(){</td></tr><tr><td class="line-number" value="4901"></td><td class="line-content">      const map = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="4902"></td><td class="line-content">      if (!map) return;</td></tr><tr><td class="line-number" value="4903"></td><td class="line-content">      if (window.AT27_BR_LAYER){ try{ map.removeLayer(AT27_BR_LAYER); }catch(_){};</td></tr><tr><td class="line-number" value="4904"></td><td class="line-content">        window.AT27_BR_LAYER=null; }</td></tr><tr><td class="line-number" value="4905"></td><td class="line-content">      window.AT27_BR_LAYERS = {};</td></tr><tr><td class="line-number" value="4906"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="4907"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4908"></td><td class="line-content">    function BR_buildOverlay(base, modo, cap){</td></tr><tr><td class="line-number" value="4909"></td><td class="line-content">      const map  = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="4910"></td><td class="line-content">      const baseGeo = window.AT_CTX?.layer?.toGeoJSON?.() || window.AT_DATA;</td></tr><tr><td class="line-number" value="4911"></td><td class="line-content">      if (!map || !baseGeo?.features) return;</td></tr><tr><td class="line-number" value="4912"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4913"></td><td class="line-content">      BR_clear();</td></tr><tr><td class="line-number" value="4914"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4915"></td><td class="line-content">      if (map.createPane &amp;&amp; !map.getPane('at27_br_pane')){</td></tr><tr><td class="line-number" value="4916"></td><td class="line-content">        map.createPane('at27_br_pane');</td></tr><tr><td class="line-number" value="4917"></td><td class="line-content">        const p = map.getPane('at27_br_pane'); p.style.zIndex=740; p.style.pointerEvents='auto';</td></tr><tr><td class="line-number" value="4918"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="4919"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4920"></td><td class="line-content">      const feats = baseGeo.features.filter(f=&gt;{</td></tr><tr><td class="line-number" value="4921"></td><td class="line-content">        const id = sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);</td></tr><tr><td class="line-number" value="4922"></td><td class="line-content">        return base[id]!=null;</td></tr><tr><td class="line-number" value="4923"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="4924"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4925"></td><td class="line-content">      const layer = L.geoJSON({type:'FeatureCollection', features:feats}, {</td></tr><tr><td class="line-number" value="4926"></td><td class="line-content">        pane:'at27_br_pane',</td></tr><tr><td class="line-number" value="4927"></td><td class="line-content">        style: f=&gt;{</td></tr><tr><td class="line-number" value="4928"></td><td class="line-content">          const id = sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);</td></tr><tr><td class="line-number" value="4929"></td><td class="line-content">          const b  = base[id];</td></tr><tr><td class="line-number" value="4930"></td><td class="line-content">          if (!b) return { color:BR_COLORS.NA, fillColor:BR_COLORS.NA, weight:1, opacity:.8, fillOpacity:.2 };</td></tr><tr><td class="line-number" value="4931"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4932"></td><td class="line-content">          const losing = (b.faltan&gt;0);</td></tr><tr><td class="line-number" value="4933"></td><td class="line-content">          const metric = (modo==='pp') ? Math.max(0, b.gapPP) : Math.max(0, b.faltan);</td></tr><tr><td class="line-number" value="4934"></td><td class="line-content">          const mag    = Math.min(1, metric / Math.max(1, cap)); // 0..1</td></tr><tr><td class="line-number" value="4935"></td><td class="line-content">          const col    = losing ? BR_COLORS.LOSE : BR_COLORS.WIN;</td></tr><tr><td class="line-number" value="4936"></td><td class="line-content">          const fo     = losing ? (0.22 + mag*0.55) : 0.15;</td></tr><tr><td class="line-number" value="4937"></td><td class="line-content">          return { color:col, fillColor:col, weight:1, opacity:.9, fillOpacity:fo };</td></tr><tr><td class="line-number" value="4938"></td><td class="line-content">        },</td></tr><tr><td class="line-number" value="4939"></td><td class="line-content">        onEachFeature: (feature, lyr)=&gt;{</td></tr><tr><td class="line-number" value="4940"></td><td class="line-content">          const id = sec4(feature.properties?.ID ?? feature.properties?.SECCION ?? feature.properties?.id);</td></tr><tr><td class="line-number" value="4941"></td><td class="line-content">          window.AT27_BR_LAYERS[id] = lyr;</td></tr><tr><td class="line-number" value="4942"></td><td class="line-content">          const b = base[id];</td></tr><tr><td class="line-number" value="4943"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4944"></td><td class="line-content">          const tip = `</td></tr><tr><td class="line-number" value="4945"></td><td class="line-content">            &lt;div style="font-size:12px;"&gt;</td></tr><tr><td class="line-number" value="4946"></td><td class="line-content">              Sección &lt;b&gt;${id}&lt;/b&gt;&lt;br&gt;</td></tr><tr><td class="line-number" value="4947"></td><td class="line-content">              ${b.faltan&gt;0? 'Estado: &lt;b&gt;PIERDE&lt;/b&gt;' : 'Estado: &lt;b&gt;GANA&lt;/b&gt;'}&lt;br&gt;</td></tr><tr><td class="line-number" value="4948"></td><td class="line-content">              Brecha (votos): &lt;b&gt;${fmtInt(b.faltan)}&lt;/b&gt;&lt;br&gt;</td></tr><tr><td class="line-number" value="4949"></td><td class="line-content">              Brecha (pp): &lt;b&gt;${fmtpp(b.gapPP)}&lt;/b&gt;</td></tr><tr><td class="line-number" value="4950"></td><td class="line-content">            &lt;/div&gt;`;</td></tr><tr><td class="line-number" value="4951"></td><td class="line-content">          lyr.bindTooltip(tip, {sticky:true, opacity:.95, direction:'top', className:'at27-tt'});</td></tr><tr><td class="line-number" value="4952"></td><td class="line-content">          lyr.on('mouseover', ()=&gt;lyr.setStyle({weight:2}));</td></tr><tr><td class="line-number" value="4953"></td><td class="line-content">          lyr.on('mouseout',  ()=&gt;lyr.setStyle({weight:1}));</td></tr><tr><td class="line-number" value="4954"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="4955"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="4956"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4957"></td><td class="line-content">      layer.addTo(map);</td></tr><tr><td class="line-number" value="4958"></td><td class="line-content">      window.AT27_BR_LAYER = layer;</td></tr><tr><td class="line-number" value="4959"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="4960"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4961"></td><td class="line-content">    /* ====== Tabla + resumen ====== */</td></tr><tr><td class="line-number" value="4962"></td><td class="line-content">    function BR_renderTable(base, modo){</td></tr><tr><td class="line-number" value="4963"></td><td class="line-content">      const tb = document.getElementById('AT27_BR_tbody');</td></tr><tr><td class="line-number" value="4964"></td><td class="line-content">      const rows = Object.entries(base).map(([sec,b])=&gt;{</td></tr><tr><td class="line-number" value="4965"></td><td class="line-content">        return {</td></tr><tr><td class="line-number" value="4966"></td><td class="line-content">          sec,</td></tr><tr><td class="line-number" value="4967"></td><td class="line-content">          estado: b.faltan&gt;0 ? 'PIERDE' : 'GANA',</td></tr><tr><td class="line-number" value="4968"></td><td class="line-content">          faltan: Math.ceil(Math.max(0,b.faltan)),</td></tr><tr><td class="line-number" value="4969"></td><td class="line-content">          gapPP:  b.gapPP</td></tr><tr><td class="line-number" value="4970"></td><td class="line-content">        };</td></tr><tr><td class="line-number" value="4971"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="4972"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4973"></td><td class="line-content">      // Orden: primero PIERDE por mayor brecha (según modo), luego GANA por menor margen.</td></tr><tr><td class="line-number" value="4974"></td><td class="line-content">      rows.sort((a,b)=&gt;{</td></tr><tr><td class="line-number" value="4975"></td><td class="line-content">        const aKey = (a.estado==='PIERDE')? 0 : 1;</td></tr><tr><td class="line-number" value="4976"></td><td class="line-content">        const bKey = (b.estado==='PIERDE')? 0 : 1;</td></tr><tr><td class="line-number" value="4977"></td><td class="line-content">        if (aKey!==bKey) return aKey-bKey;</td></tr><tr><td class="line-number" value="4978"></td><td class="line-content">        if (a.estado==='PIERDE'){</td></tr><tr><td class="line-number" value="4979"></td><td class="line-content">          return (modo==='pp' ? (b.gapPP - a.gapPP) : (b.faltan - a.faltan)) || (Number(a.sec)-Number(b.sec));</td></tr><tr><td class="line-number" value="4980"></td><td class="line-content">        }else{</td></tr><tr><td class="line-number" value="4981"></td><td class="line-content">          // ganadas: margen menor primero → gapPP asc</td></tr><tr><td class="line-number" value="4982"></td><td class="line-content">          return (a.gapPP - b.gapPP) || (Number(a.sec)-Number(b.sec));</td></tr><tr><td class="line-number" value="4983"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="4984"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="4985"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4986"></td><td class="line-content">      tb.innerHTML = rows.map(r=&gt;{</td></tr><tr><td class="line-number" value="4987"></td><td class="line-content">        const bg = r.estado==='PIERDE' ? '#fee2e2' : '#f1f5f9';</td></tr><tr><td class="line-number" value="4988"></td><td class="line-content">        const metr = (modo==='pp') ? fmtpp(r.gapPP) : fmtInt(r.faltan);</td></tr><tr><td class="line-number" value="4989"></td><td class="line-content">        return `</td></tr><tr><td class="line-number" value="4990"></td><td class="line-content">          &lt;tr data-sec="${r.sec}" style="cursor:pointer; background:${bg};"&gt;</td></tr><tr><td class="line-number" value="4991"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #e5e7eb;"&gt;${r.sec}&lt;/td&gt;</td></tr><tr><td class="line-number" value="4992"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #e5e7eb;"&gt;${r.estado}&lt;/td&gt;</td></tr><tr><td class="line-number" value="4993"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #e5e7eb; text-align:right;"&gt;${metr}&lt;/td&gt;</td></tr><tr><td class="line-number" value="4994"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #e5e7eb; text-align:right;"&gt;${fmtInt(r.faltan)}&lt;/td&gt;</td></tr><tr><td class="line-number" value="4995"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #e5e7eb; text-align:right;"&gt;${fmtpp(r.gapPP)}&lt;/td&gt;</td></tr><tr><td class="line-number" value="4996"></td><td class="line-content">          &lt;/tr&gt;`;</td></tr><tr><td class="line-number" value="4997"></td><td class="line-content">      }).join('');</td></tr><tr><td class="line-number" value="4998"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="4999"></td><td class="line-content">      tb.onclick = (e)=&gt;{</td></tr><tr><td class="line-number" value="5000"></td><td class="line-content">        const tr = e.target.closest('tr[data-sec]'); if (!tr) return;</td></tr><tr><td class="line-number" value="5001"></td><td class="line-content">        BR_focus(tr.getAttribute('data-sec'));</td></tr><tr><td class="line-number" value="5002"></td><td class="line-content">      };</td></tr><tr><td class="line-number" value="5003"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="5004"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5005"></td><td class="line-content">    function BR_renderSummary(base, modo){</td></tr><tr><td class="line-number" value="5006"></td><td class="line-content">      const el = document.getElementById('AT27_BR_summary');</td></tr><tr><td class="line-number" value="5007"></td><td class="line-content">      let pierde=0, gana=0, maxF=0, maxPP=0;</td></tr><tr><td class="line-number" value="5008"></td><td class="line-content">      Object.values(base).forEach(b=&gt;{</td></tr><tr><td class="line-number" value="5009"></td><td class="line-content">        if (b.faltan&gt;0){ pierde++; if (b.faltan&gt;maxF) maxF=b.faltan; if (b.gapPP&gt;maxPP) maxPP=b.gapPP; }</td></tr><tr><td class="line-number" value="5010"></td><td class="line-content">        else { gana++; }</td></tr><tr><td class="line-number" value="5011"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="5012"></td><td class="line-content">      el.innerHTML = `</td></tr><tr><td class="line-number" value="5013"></td><td class="line-content">        &lt;div style="font-size:12px; line-height:1.35;"&gt;</td></tr><tr><td class="line-number" value="5014"></td><td class="line-content">          Secciones: &lt;b&gt;${pierde+gana}&lt;/b&gt; · Pierde: &lt;b&gt;${pierde}&lt;/b&gt; · Gana: &lt;b&gt;${gana}&lt;/b&gt;&lt;br&gt;</td></tr><tr><td class="line-number" value="5015"></td><td class="line-content">          Máxima brecha: &lt;b&gt;${fmtInt(maxF)}&lt;/b&gt; votos · &lt;b&gt;${fmtpp(maxPP)}&lt;/b&gt;</td></tr><tr><td class="line-number" value="5016"></td><td class="line-content">        &lt;/div&gt;`;</td></tr><tr><td class="line-number" value="5017"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="5018"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5019"></td><td class="line-content">    function BR_focus(sec){</td></tr><tr><td class="line-number" value="5020"></td><td class="line-content">      const id = sec4(sec);</td></tr><tr><td class="line-number" value="5021"></td><td class="line-content">      const map = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="5022"></td><td class="line-content">      const lyr = window.AT27_BR_LAYERS[id];</td></tr><tr><td class="line-number" value="5023"></td><td class="line-content">      if (!map) return;</td></tr><tr><td class="line-number" value="5024"></td><td class="line-content">      if (lyr){</td></tr><tr><td class="line-number" value="5025"></td><td class="line-content">        try{ map.fitBounds(lyr.getBounds(), {maxZoom:16, padding:[20,20]}); }catch(_){}</td></tr><tr><td class="line-number" value="5026"></td><td class="line-content">        if (lyr.openTooltip) lyr.openTooltip();</td></tr><tr><td class="line-number" value="5027"></td><td class="line-content">        const ofo = lyr.options.fillOpacity ?? .3;</td></tr><tr><td class="line-number" value="5028"></td><td class="line-content">        lyr.setStyle({weight:3, fillOpacity: Math.min(.95, ofo+.25)});</td></tr><tr><td class="line-number" value="5029"></td><td class="line-content">        setTimeout(()=&gt; lyr.setStyle({weight:1, fillOpacity:ofo}), 900);</td></tr><tr><td class="line-number" value="5030"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="5031"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="5032"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5033"></td><td class="line-content">    /* ====== RUN ====== */</td></tr><tr><td class="line-number" value="5034"></td><td class="line-content">    async function AT27_BR_run(){</td></tr><tr><td class="line-number" value="5035"></td><td class="line-content">      if (window.AT27_BR_STATE.running) return;</td></tr><tr><td class="line-number" value="5036"></td><td class="line-content">      window.AT27_BR_STATE.running = true;</td></tr><tr><td class="line-number" value="5037"></td><td class="line-content">      try{</td></tr><tr><td class="line-number" value="5038"></td><td class="line-content">        const puesto  = document.getElementById('AT27_BR_selPuesto').value;</td></tr><tr><td class="line-number" value="5039"></td><td class="line-content">        const partido = document.getElementById('AT27_BR_selPartido').value.toUpperCase();</td></tr><tr><td class="line-number" value="5040"></td><td class="line-content">        const modo    = document.querySelector('input[name="AT27_BR_modo"]:checked').value; // votos | pp</td></tr><tr><td class="line-number" value="5041"></td><td class="line-content">        const cap     = Number(document.getElementById('AT27_BR_cap').value || (modo==='pp'? 10 : 1000));</td></tr><tr><td class="line-number" value="5042"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5043"></td><td class="line-content">        const secIds = BR_getUniverseSecIds();</td></tr><tr><td class="line-number" value="5044"></td><td class="line-content">        if (!secIds.length){ BR_clear(); document.getElementById('AT27_BR_tbody').innerHTML=''; return; }</td></tr><tr><td class="line-number" value="5045"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5046"></td><td class="line-content">        const js   = await BR_load(puesto);</td></tr><tr><td class="line-number" value="5047"></td><td class="line-content">        const base = BR_baseBySec(js, secIds, puesto, partido);</td></tr><tr><td class="line-number" value="5048"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5049"></td><td class="line-content">        BR_buildOverlay(base, modo, cap);</td></tr><tr><td class="line-number" value="5050"></td><td class="line-content">        BR_renderSummary(base, modo);</td></tr><tr><td class="line-number" value="5051"></td><td class="line-content">        BR_renderTable(base, modo);</td></tr><tr><td class="line-number" value="5052"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5053"></td><td class="line-content">      }catch(e){</td></tr><tr><td class="line-number" value="5054"></td><td class="line-content">        console.error('AT27_BR_run', e);</td></tr><tr><td class="line-number" value="5055"></td><td class="line-content">        alert('No pude ejecutar “Brecha pp/votos”.');</td></tr><tr><td class="line-number" value="5056"></td><td class="line-content">      }finally{</td></tr><tr><td class="line-number" value="5057"></td><td class="line-content">        window.AT27_BR_STATE.running = false;</td></tr><tr><td class="line-number" value="5058"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="5059"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="5060"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5061"></td><td class="line-content">    /* ====== Panel UI ====== */</td></tr><tr><td class="line-number" value="5062"></td><td class="line-content">    function AT27_BR_open(){</td></tr><tr><td class="line-number" value="5063"></td><td class="line-content">      let panel = document.getElementById('AT27_BR_panel');</td></tr><tr><td class="line-number" value="5064"></td><td class="line-content">      if (panel){ panel.style.display='block'; return; }</td></tr><tr><td class="line-number" value="5065"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5066"></td><td class="line-content">      panel = document.createElement('div');</td></tr><tr><td class="line-number" value="5067"></td><td class="line-content">      panel.id = 'AT27_BR_panel';</td></tr><tr><td class="line-number" value="5068"></td><td class="line-content">      Object.assign(panel.style,{</td></tr><tr><td class="line-number" value="5069"></td><td class="line-content">        position:'fixed', right:'24px', top:'24px', zIndex:9998,</td></tr><tr><td class="line-number" value="5070"></td><td class="line-content">        width:'560px', maxWidth:'calc(100vw - 40px)', maxHeight:'calc(100vh - 40px)',</td></tr><tr><td class="line-number" value="5071"></td><td class="line-content">        background:'#fff', border:'1px solid #e5e7eb', borderRadius:'14px',</td></tr><tr><td class="line-number" value="5072"></td><td class="line-content">        boxShadow:'0 18px 40px rgba(0,0,0,.18)', display:'flex', flexDirection:'column',</td></tr><tr><td class="line-number" value="5073"></td><td class="line-content">        overflow:'hidden', resize:'both', minWidth:'380px', minHeight:'280px'</td></tr><tr><td class="line-number" value="5074"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="5075"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5076"></td><td class="line-content">      panel.innerHTML = `</td></tr><tr><td class="line-number" value="5077"></td><td class="line-content">        &lt;div id="AT27_BR_hdr" style="cursor:move; user-select:none; background:#f8fafc; color:#111; padding:10px 12px; display:flex; gap:10px; align-items:center;"&gt;</td></tr><tr><td class="line-number" value="5078"></td><td class="line-content">          &lt;div style="font-weight:800;"&gt;Mapa de brecha (pp / votos)&lt;/div&gt;</td></tr><tr><td class="line-number" value="5079"></td><td class="line-content">          &lt;button id="AT27_BR_center" style="margin-left:auto; background:#eef2ff; border:1px solid #c7d2fe; border-radius:8px; padding:4px 8px; cursor:pointer;"&gt;Recentrar&lt;/button&gt;</td></tr><tr><td class="line-number" value="5080"></td><td class="line-content">          &lt;button id="AT27_BR_close" title="Cerrar" style="background:transparent;border:none;font-size:18px;cursor:pointer;"&gt;×&lt;/button&gt;</td></tr><tr><td class="line-number" value="5081"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="5082"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5083"></td><td class="line-content">        &lt;div style="padding:10px 12px; display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:end;"&gt;</td></tr><tr><td class="line-number" value="5084"></td><td class="line-content">          &lt;label style="font-size:12px;"&gt;Puesto&lt;br&gt;</td></tr><tr><td class="line-number" value="5085"></td><td class="line-content">            &lt;select id="AT27_BR_selPuesto" class="ttb-select" style="width:100%;"&gt;</td></tr><tr><td class="line-number" value="5086"></td><td class="line-content">              &lt;option value="A"&gt;Ayuntamiento&lt;/option&gt;</td></tr><tr><td class="line-number" value="5087"></td><td class="line-content">              &lt;option value="DL"&gt;Diputado Local&lt;/option&gt;</td></tr><tr><td class="line-number" value="5088"></td><td class="line-content">              &lt;option value="DF"&gt;Diputado Federal&lt;/option&gt;</td></tr><tr><td class="line-number" value="5089"></td><td class="line-content">            &lt;/select&gt;</td></tr><tr><td class="line-number" value="5090"></td><td class="line-content">          &lt;/label&gt;</td></tr><tr><td class="line-number" value="5091"></td><td class="line-content">          &lt;label style="font-size:12px;"&gt;Partido&lt;br&gt;</td></tr><tr><td class="line-number" value="5092"></td><td class="line-content">            &lt;select id="AT27_BR_selPartido" class="ttb-select" style="width:100%;"&gt;</td></tr><tr><td class="line-number" value="5093"></td><td class="line-content">              &lt;option&gt;PAN&lt;/option&gt;&lt;option&gt;PRI&lt;/option&gt;&lt;option&gt;PVEM&lt;/option&gt;&lt;option&gt;MORENA&lt;/option&gt;</td></tr><tr><td class="line-number" value="5094"></td><td class="line-content">            &lt;/select&gt;</td></tr><tr><td class="line-number" value="5095"></td><td class="line-content">          &lt;/label&gt;</td></tr><tr><td class="line-number" value="5096"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5097"></td><td class="line-content">          &lt;div style="grid-column:1 / span 2; display:flex; gap:16px; align-items:center; font-size:12px;"&gt;</td></tr><tr><td class="line-number" value="5098"></td><td class="line-content">            Modo:</td></tr><tr><td class="line-number" value="5099"></td><td class="line-content">            &lt;label&gt;&lt;input type="radio" name="AT27_BR_modo" value="votos" checked&gt; votos&lt;/label&gt;</td></tr><tr><td class="line-number" value="5100"></td><td class="line-content">            &lt;label&gt;&lt;input type="radio" name="AT27_BR_modo" value="pp"&gt; pp&lt;/label&gt;</td></tr><tr><td class="line-number" value="5101"></td><td class="line-content">            &lt;span style="opacity:.7;"&gt;· Cap color&lt;/span&gt;</td></tr><tr><td class="line-number" value="5102"></td><td class="line-content">            &lt;input id="AT27_BR_cap" type="number" value="1000" style="width:90px; padding:4px 6px; border:1px solid #e5e7eb; border-radius:8px;"&gt;</td></tr><tr><td class="line-number" value="5103"></td><td class="line-content">          &lt;/div&gt;</td></tr><tr><td class="line-number" value="5104"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5105"></td><td class="line-content">          &lt;button id="AT27_BR_run" class="ttb-btn ttb-primary" style="grid-column:1 / span 2;"&gt;Ejecutar&lt;/button&gt;</td></tr><tr><td class="line-number" value="5106"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="5107"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5108"></td><td class="line-content">        &lt;div style="padding:8px 12px;"&gt;</td></tr><tr><td class="line-number" value="5109"></td><td class="line-content">          &lt;div id="AT27_BR_legend" style="font-size:12px; display:flex; gap:12px; align-items:center; margin-bottom:6px;"&gt;</td></tr><tr><td class="line-number" value="5110"></td><td class="line-content">            &lt;span&gt;&lt;span style="display:inline-block;width:10px;height:10px;background:${BR_COLORS.LOSE};border-radius:2px;"&gt;&lt;/span&gt; Pierde (intensidad = brecha)&lt;/span&gt;</td></tr><tr><td class="line-number" value="5111"></td><td class="line-content">            &lt;span&gt;&lt;span style="display:inline-block;width:10px;height:10px;background:${BR_COLORS.WIN};border-radius:2px;"&gt;&lt;/span&gt; Gana&lt;/span&gt;</td></tr><tr><td class="line-number" value="5112"></td><td class="line-content">          &lt;/div&gt;</td></tr><tr><td class="line-number" value="5113"></td><td class="line-content">          &lt;div id="AT27_BR_summary" style="font-size:12px; color:#334155;"&gt;&lt;/div&gt;</td></tr><tr><td class="line-number" value="5114"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="5115"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5116"></td><td class="line-content">        &lt;div style="flex:1; overflow:auto;"&gt;</td></tr><tr><td class="line-number" value="5117"></td><td class="line-content">          &lt;table style="width:100%; border-collapse:collapse; font-size:12px;"&gt;</td></tr><tr><td class="line-number" value="5118"></td><td class="line-content">            &lt;thead&gt;</td></tr><tr><td class="line-number" value="5119"></td><td class="line-content">              &lt;tr style="position:sticky; top:0; background:#f8fafc;"&gt;</td></tr><tr><td class="line-number" value="5120"></td><td class="line-content">                &lt;th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Sección&lt;/th&gt;</td></tr><tr><td class="line-number" value="5121"></td><td class="line-content">                &lt;th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Estado&lt;/th&gt;</td></tr><tr><td class="line-number" value="5122"></td><td class="line-content">                &lt;th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Brecha (según modo)&lt;/th&gt;</td></tr><tr><td class="line-number" value="5123"></td><td class="line-content">                &lt;th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Faltan (votos)&lt;/th&gt;</td></tr><tr><td class="line-number" value="5124"></td><td class="line-content">                &lt;th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Brecha (pp)&lt;/th&gt;</td></tr><tr><td class="line-number" value="5125"></td><td class="line-content">              &lt;/tr&gt;</td></tr><tr><td class="line-number" value="5126"></td><td class="line-content">            &lt;/thead&gt;</td></tr><tr><td class="line-number" value="5127"></td><td class="line-content">            &lt;tbody id="AT27_BR_tbody"&gt;&lt;/tbody&gt;</td></tr><tr><td class="line-number" value="5128"></td><td class="line-content">          &lt;/table&gt;</td></tr><tr><td class="line-number" value="5129"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="5130"></td><td class="line-content">      `;</td></tr><tr><td class="line-number" value="5131"></td><td class="line-content">      document.body.appendChild(panel);</td></tr><tr><td class="line-number" value="5132"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5133"></td><td class="line-content">      // Wire UI</td></tr><tr><td class="line-number" value="5134"></td><td class="line-content">      const $$ = (sel)=&gt; panel.querySelector(sel);</td></tr><tr><td class="line-number" value="5135"></td><td class="line-content">      $$('#AT27_BR_close').onclick  = ()=&gt; panel.style.display='none';</td></tr><tr><td class="line-number" value="5136"></td><td class="line-content">      $$('#AT27_BR_center').onclick = ()=&gt; (window.AT27_fitUniverseBounds? AT27_fitUniverseBounds() : null);</td></tr><tr><td class="line-number" value="5137"></td><td class="line-content">      $$('#AT27_BR_run').onclick    = ()=&gt;{ window.AT27_BR_STATE.autorun = true; AT27_BR_run(); };</td></tr><tr><td class="line-number" value="5138"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5139"></td><td class="line-content">      // Cambiar cap por modo (sugerencias)</td></tr><tr><td class="line-number" value="5140"></td><td class="line-content">      panel.querySelectorAll('input[name="AT27_BR_modo"]').forEach(r=&gt;{</td></tr><tr><td class="line-number" value="5141"></td><td class="line-content">        r.addEventListener('change', ()=&gt;{</td></tr><tr><td class="line-number" value="5142"></td><td class="line-content">          const modo = panel.querySelector('input[name="AT27_BR_modo"]:checked').value;</td></tr><tr><td class="line-number" value="5143"></td><td class="line-content">          if (modo==='pp' &amp;&amp; Number($$('#AT27_BR_cap').value)&gt;50) $$('#AT27_BR_cap').value = 10;</td></tr><tr><td class="line-number" value="5144"></td><td class="line-content">          if (modo==='votos' &amp;&amp; Number($$('#AT27_BR_cap').value)&lt;50) $$('#AT27_BR_cap').value = 1000;</td></tr><tr><td class="line-number" value="5145"></td><td class="line-content">        });</td></tr><tr><td class="line-number" value="5146"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="5147"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5148"></td><td class="line-content">      // Drag + bloqueo eventos al mapa</td></tr><tr><td class="line-number" value="5149"></td><td class="line-content">      (function drag(panelEl, handleEl){</td></tr><tr><td class="line-number" value="5150"></td><td class="line-content">        let sx=0, sy=0, ox=0, oy=0, dragging=false;</td></tr><tr><td class="line-number" value="5151"></td><td class="line-content">        handleEl.addEventListener('mousedown', e=&gt;{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panelEl.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });</td></tr><tr><td class="line-number" value="5152"></td><td class="line-content">        window.addEventListener('mousemove', e=&gt;{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panelEl.style.left=(ox+dx)+'px'; panelEl.style.top=(oy+dy)+'px'; panelEl.style.right='auto'; });</td></tr><tr><td class="line-number" value="5153"></td><td class="line-content">        window.addEventListener('mouseup', ()=&gt;{ dragging=false; document.body.style.userSelect=''; });</td></tr><tr><td class="line-number" value="5154"></td><td class="line-content">      })(panel, panel.querySelector('#AT27_BR_hdr'));</td></tr><tr><td class="line-number" value="5155"></td><td class="line-content">      if (window.L &amp;&amp; L.DomEvent){ L.DomEvent.disableClickPropagation(panel); L.DomEvent.disableScrollPropagation(panel); }</td></tr><tr><td class="line-number" value="5156"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5157"></td><td class="line-content">      // Recalcular si cambias universo (tras primer run)</td></tr><tr><td class="line-number" value="5158"></td><td class="line-content">      const map = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="5159"></td><td class="line-content">      if (map &amp;&amp; !map.__brBound){</td></tr><tr><td class="line-number" value="5160"></td><td class="line-content">        const deb = (fn,ms=350)=&gt;{ let t; return (...a)=&gt;{ clearTimeout(t); t=setTimeout(()=&gt;fn(...a),ms); }; };</td></tr><tr><td class="line-number" value="5161"></td><td class="line-content">        map.on('layeradd',    deb(()=&gt;{ if (window.AT27_BR_STATE.autorun) AT27_BR_run(); }));</td></tr><tr><td class="line-number" value="5162"></td><td class="line-content">        map.on('layerremove', deb(()=&gt;{ if (window.AT27_BR_STATE.autorun) AT27_BR_run(); }));</td></tr><tr><td class="line-number" value="5163"></td><td class="line-content">        map.__brBound = true;</td></tr><tr><td class="line-number" value="5164"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="5165"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="5166"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5167"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5168"></td><td class="line-content"><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="5169"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5170"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5171"></td><td class="line-content"><span class="html-tag">&lt;script&gt;</span></td></tr><tr><td class="line-number" value="5172"></td><td class="line-content">    // =======================================================</td></tr><tr><td class="line-number" value="5173"></td><td class="line-content">    // GENIALIDAD #8 · SENSIBILIDAD A PARTICIPACIÓN</td></tr><tr><td class="line-number" value="5174"></td><td class="line-content">    // ¿Qué cambia si la participación 2027* sube/baja ±δ pp?</td></tr><tr><td class="line-number" value="5175"></td><td class="line-content">    // Verde: la sección voltea a tu favor | Rojo: voltea en contra | Gris: sin cambio.</td></tr><tr><td class="line-number" value="5176"></td><td class="line-content">    // Requiere: AT_CTX.map/layer, loadPuesto/getElectData, AT27_GG_project2027, AT27_GG_shares2024.</td></tr><tr><td class="line-number" value="5177"></td><td class="line-content">    // (Opcional) AT27_GG_getUniverseSecIds para obtener universo actual.</td></tr><tr><td class="line-number" value="5178"></td><td class="line-content">    // =======================================================</td></tr><tr><td class="line-number" value="5179"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5180"></td><td class="line-content">    /* ====== Estado y utilidades ====== */</td></tr><tr><td class="line-number" value="5181"></td><td class="line-content">    window.AT27_SP_STATE  = window.AT27_SP_STATE  || { autorun:false, running:false };</td></tr><tr><td class="line-number" value="5182"></td><td class="line-content">    window.AT27_SP_LAYER  = window.AT27_SP_LAYER  || null;</td></tr><tr><td class="line-number" value="5183"></td><td class="line-content">    window.AT27_SP_LAYERS = window.AT27_SP_LAYERS || {};   // sec -&gt; layer</td></tr><tr><td class="line-number" value="5184"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5185"></td><td class="line-content">    //const sec4   = s =&gt; String(s||'').replace(/\D+/g,'').padStart(4,'0');</td></tr><tr><td class="line-number" value="5186"></td><td class="line-content">    //const clamp  = (x,a,b)=&gt; Math.min(b, Math.max(a, x));</td></tr><tr><td class="line-number" value="5187"></td><td class="line-content">    //const fmtInt = x =&gt; Number.isFinite(x) ? Math.round(x).toLocaleString() : '—';</td></tr><tr><td class="line-number" value="5188"></td><td class="line-content">    //const fmtpp  = x =&gt; (x===null||x===undefined) ? '—' : (Number.isFinite(+x) ? ((x&gt;0?'+':'')+(+x).toFixed(1)+' pp') : '—');</td></tr><tr><td class="line-number" value="5189"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5190"></td><td class="line-content">    const SP_COL = { FAVOR:'#22c55e', CONTRA:'#ef4444', NC:'#cbd5e1' };</td></tr><tr><td class="line-number" value="5191"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5192"></td><td class="line-content">    function SP_getUniverseSecIds(){</td></tr><tr><td class="line-number" value="5193"></td><td class="line-content">      if (typeof AT27_GG_getUniverseSecIds==='function') return AT27_GG_getUniverseSecIds();</td></tr><tr><td class="line-number" value="5194"></td><td class="line-content">      const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];</td></tr><tr><td class="line-number" value="5195"></td><td class="line-content">      return feats.map(f=&gt; sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id));</td></tr><tr><td class="line-number" value="5196"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="5197"></td><td class="line-content">    async function SP_load(p){ return (window.loadPuesto? loadPuesto(p) : getElectData(p)); }</td></tr><tr><td class="line-number" value="5198"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5199"></td><td class="line-content">    /* ====== Helpers shares 2024 ====== */</td></tr><tr><td class="line-number" value="5200"></td><td class="line-content">    function SHARES_2024(row24){</td></tr><tr><td class="line-number" value="5201"></td><td class="line-content">      if (typeof AT27_GG_shares2024==='function') return AT27_GG_shares2024(row24);</td></tr><tr><td class="line-number" value="5202"></td><td class="line-content">      // fallback simple</td></tr><tr><td class="line-number" value="5203"></td><td class="line-content">      let vv = (row24?.VOTOS!=null)? Number(row24.VOTOS||0) : 0;</td></tr><tr><td class="line-number" value="5204"></td><td class="line-content">      if (row24 &amp;&amp; row24.VOTOS==null){ for (const [k,v] of Object.entries(row24)){ if (k==='LN'||k==='VOTOS') continue; vv += Number(v||0); } }</td></tr><tr><td class="line-number" value="5205"></td><td class="line-content">      const sh = {};</td></tr><tr><td class="line-number" value="5206"></td><td class="line-content">      if (row24){</td></tr><tr><td class="line-number" value="5207"></td><td class="line-content">        for (const [k,v] of Object.entries(row24)){ if (k==='LN'||k==='VOTOS') continue; sh[k.toUpperCase()] = vv? (Number(v||0)/vv) : 0; }</td></tr><tr><td class="line-number" value="5208"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="5209"></td><td class="line-content">      return { shares: sh, total: vv };</td></tr><tr><td class="line-number" value="5210"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="5211"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5212"></td><td class="line-content">    /* ====== Base y escenario con delta ====== */</td></tr><tr><td class="line-number" value="5213"></td><td class="line-content">    function SP_compute(js, secIds, puesto, partido, deltaPP){</td></tr><tr><td class="line-number" value="5214"></td><td class="line-content">      const X = partido.toUpperCase();</td></tr><tr><td class="line-number" value="5215"></td><td class="line-content">      const bySec = {}; // sec -&gt; { L0, vL0, vX0, gap0, p27, p27d, Ld, vLd, vXd, gapd, flip:'FAVOR'|'CONTRA'|'NC' }</td></tr><tr><td class="line-number" value="5216"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5217"></td><td class="line-content">      for (const s of secIds){</td></tr><tr><td class="line-number" value="5218"></td><td class="line-content">        const slot = js?.secciones?.[sec4(s)];</td></tr><tr><td class="line-number" value="5219"></td><td class="line-content">        const row24 = slot?.['2024']; if (!row24) continue;</td></tr><tr><td class="line-number" value="5220"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5221"></td><td class="line-content">        const ln24 = Number(row24.LN||0);</td></tr><tr><td class="line-number" value="5222"></td><td class="line-content">        const p27  = (typeof AT27_GG_project2027==='function') ? AT27_GG_project2027(slot, puesto) : null;</td></tr><tr><td class="line-number" value="5223"></td><td class="line-content">        if (!ln24 || p27==null) continue;</td></tr><tr><td class="line-number" value="5224"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5225"></td><td class="line-content">        const { shares, total:vv24 } = SHARES_2024(row24);</td></tr><tr><td class="line-number" value="5226"></td><td class="line-content">        if (!Object.keys(shares).length || !vv24) continue;</td></tr><tr><td class="line-number" value="5227"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5228"></td><td class="line-content">        // base</td></tr><tr><td class="line-number" value="5229"></td><td class="line-content">        const V0 = ln24 * (p27/100);</td></tr><tr><td class="line-number" value="5230"></td><td class="line-content">        if (!Number.isFinite(V0) || V0&lt;1) continue;</td></tr><tr><td class="line-number" value="5231"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5232"></td><td class="line-content">        let L0=null, vL0=-1, vX0=0;</td></tr><tr><td class="line-number" value="5233"></td><td class="line-content">        for (const [sig,sh] of Object.entries(shares)){</td></tr><tr><td class="line-number" value="5234"></td><td class="line-content">          const v = sh*V0;</td></tr><tr><td class="line-number" value="5235"></td><td class="line-content">          if (sig.toUpperCase()===X) vX0 = v;</td></tr><tr><td class="line-number" value="5236"></td><td class="line-content">          if (v&gt;vL0){ vL0=v; L0=sig.toUpperCase(); }</td></tr><tr><td class="line-number" value="5237"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="5238"></td><td class="line-content">        const gap0 = (vL0 - vX0) / V0 * 100; // pp (&gt;=0 si L0 ≠ X)</td></tr><tr><td class="line-number" value="5239"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5240"></td><td class="line-content">        // escenario con delta (aditivo en puntos a p27)</td></tr><tr><td class="line-number" value="5241"></td><td class="line-content">        const p27d = clamp(p27 + deltaPP, 5, 90);</td></tr><tr><td class="line-number" value="5242"></td><td class="line-content">        const Vd   = ln24 * (p27d/100);</td></tr><tr><td class="line-number" value="5243"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5244"></td><td class="line-content">        let Ld=null, vLd=-1, vXd=0;</td></tr><tr><td class="line-number" value="5245"></td><td class="line-content">        for (const [sig,sh] of Object.entries(shares)){</td></tr><tr><td class="line-number" value="5246"></td><td class="line-content">          const v = sh*Vd;</td></tr><tr><td class="line-number" value="5247"></td><td class="line-content">          if (sig.toUpperCase()===X) vXd = v;</td></tr><tr><td class="line-number" value="5248"></td><td class="line-content">          if (v&gt;vLd){ vLd=v; Ld=sig.toUpperCase(); }</td></tr><tr><td class="line-number" value="5249"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="5250"></td><td class="line-content">        const gapd = (vLd - vXd) / Vd * 100;</td></tr><tr><td class="line-number" value="5251"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5252"></td><td class="line-content">        let flip='NC';</td></tr><tr><td class="line-number" value="5253"></td><td class="line-content">        if (L0!==Ld){</td></tr><tr><td class="line-number" value="5254"></td><td class="line-content">          // cambió de ganador</td></tr><tr><td class="line-number" value="5255"></td><td class="line-content">          flip = (Ld===X) ? 'FAVOR' : (L0===X ? 'CONTRA' : (Ld===X ? 'FAVOR' : 'CONTRA'));</td></tr><tr><td class="line-number" value="5256"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="5257"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5258"></td><td class="line-content">        bySec[sec4(s)] = { L0, vL0, vX0, gap0, p27, p27d, Ld, vLd, vXd, gapd, flip };</td></tr><tr><td class="line-number" value="5259"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="5260"></td><td class="line-content">      return bySec;</td></tr><tr><td class="line-number" value="5261"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="5262"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5263"></td><td class="line-content">    /* ====== Overlay ====== */</td></tr><tr><td class="line-number" value="5264"></td><td class="line-content">    function SP_clear(){</td></tr><tr><td class="line-number" value="5265"></td><td class="line-content">      const map = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="5266"></td><td class="line-content">      if (!map) return;</td></tr><tr><td class="line-number" value="5267"></td><td class="line-content">      if (window.AT27_SP_LAYER){ try{ map.removeLayer(AT27_SP_LAYER); }catch(_){};</td></tr><tr><td class="line-number" value="5268"></td><td class="line-content">        window.AT27_SP_LAYER=null; }</td></tr><tr><td class="line-number" value="5269"></td><td class="line-content">      window.AT27_SP_LAYERS = {};</td></tr><tr><td class="line-number" value="5270"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="5271"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5272"></td><td class="line-content">    function SP_buildOverlay(perSec, filtro){</td></tr><tr><td class="line-number" value="5273"></td><td class="line-content">      const map  = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="5274"></td><td class="line-content">      const base = window.AT_CTX?.layer?.toGeoJSON?.() || window.AT_DATA;</td></tr><tr><td class="line-number" value="5275"></td><td class="line-content">      if (!map || !base?.features) return;</td></tr><tr><td class="line-number" value="5276"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5277"></td><td class="line-content">      SP_clear();</td></tr><tr><td class="line-number" value="5278"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5279"></td><td class="line-content">      if (map.createPane &amp;&amp; !map.getPane('at27_sp_pane')){</td></tr><tr><td class="line-number" value="5280"></td><td class="line-content">        map.createPane('at27_sp_pane');</td></tr><tr><td class="line-number" value="5281"></td><td class="line-content">        const p = map.getPane('at27_sp_pane'); p.style.zIndex=750; p.style.pointerEvents='auto';</td></tr><tr><td class="line-number" value="5282"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="5283"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5284"></td><td class="line-content">      const feats = base.features.filter(f=&gt;{</td></tr><tr><td class="line-number" value="5285"></td><td class="line-content">        const id = sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);</td></tr><tr><td class="line-number" value="5286"></td><td class="line-content">        const x = perSec[id]; if (!x) return false;</td></tr><tr><td class="line-number" value="5287"></td><td class="line-content">        return (filtro==='TODOS') ? true : (x.flip===filtro);</td></tr><tr><td class="line-number" value="5288"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="5289"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5290"></td><td class="line-content">      const layer = L.geoJSON({type:'FeatureCollection', features:feats}, {</td></tr><tr><td class="line-number" value="5291"></td><td class="line-content">        pane:'at27_sp_pane',</td></tr><tr><td class="line-number" value="5292"></td><td class="line-content">        style: f=&gt;{</td></tr><tr><td class="line-number" value="5293"></td><td class="line-content">          const id = sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);</td></tr><tr><td class="line-number" value="5294"></td><td class="line-content">          const x  = perSec[id];</td></tr><tr><td class="line-number" value="5295"></td><td class="line-content">          const col = x.flip==='FAVOR' ? SP_COL.FAVOR : (x.flip==='CONTRA' ? SP_COL.CONTRA : SP_COL.NC);</td></tr><tr><td class="line-number" value="5296"></td><td class="line-content">          const fo  = (x.flip==='NC') ? .18 : .45;</td></tr><tr><td class="line-number" value="5297"></td><td class="line-content">          return { color:col, fillColor:col, weight:1, opacity:.9, fillOpacity:fo };</td></tr><tr><td class="line-number" value="5298"></td><td class="line-content">        },</td></tr><tr><td class="line-number" value="5299"></td><td class="line-content">        onEachFeature: (feature, lyr)=&gt;{</td></tr><tr><td class="line-number" value="5300"></td><td class="line-content">          const id = sec4(feature.properties?.ID ?? feature.properties?.SECCION ?? feature.properties?.id);</td></tr><tr><td class="line-number" value="5301"></td><td class="line-content">          window.AT27_SP_LAYERS[id] = lyr;</td></tr><tr><td class="line-number" value="5302"></td><td class="line-content">          const x = perSec[id];</td></tr><tr><td class="line-number" value="5303"></td><td class="line-content">          const tip = `</td></tr><tr><td class="line-number" value="5304"></td><td class="line-content">            &lt;div style="font-size:12px;"&gt;</td></tr><tr><td class="line-number" value="5305"></td><td class="line-content">              Sección &lt;b&gt;${id}&lt;/b&gt;&lt;br&gt;</td></tr><tr><td class="line-number" value="5306"></td><td class="line-content">              Base: &lt;b&gt;${x.L0}&lt;/b&gt; (margen ${fmtpp(x.gap0)}) · p2027*: &lt;b&gt;${x.p27?.toFixed(1)||'—'}%&lt;/b&gt;&lt;br&gt;</td></tr><tr><td class="line-number" value="5307"></td><td class="line-content">              Con Δp: &lt;b&gt;${x.Ld}&lt;/b&gt; (margen ${fmtpp(x.gapd)}) · p' = &lt;b&gt;${x.p27d?.toFixed(1)||'—'}%&lt;/b&gt;&lt;br&gt;</td></tr><tr><td class="line-number" value="5308"></td><td class="line-content">              Cambio: &lt;b&gt;${x.flip}&lt;/b&gt;</td></tr><tr><td class="line-number" value="5309"></td><td class="line-content">            &lt;/div&gt;`;</td></tr><tr><td class="line-number" value="5310"></td><td class="line-content">          lyr.bindTooltip(tip, {sticky:true, opacity:.95, direction:'top', className:'at27-tt'});</td></tr><tr><td class="line-number" value="5311"></td><td class="line-content">          lyr.on('mouseover', ()=&gt;lyr.setStyle({weight:2}));</td></tr><tr><td class="line-number" value="5312"></td><td class="line-content">          lyr.on('mouseout',  ()=&gt;lyr.setStyle({weight:1}));</td></tr><tr><td class="line-number" value="5313"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="5314"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="5315"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5316"></td><td class="line-content">      layer.addTo(map);</td></tr><tr><td class="line-number" value="5317"></td><td class="line-content">      window.AT27_SP_LAYER = layer;</td></tr><tr><td class="line-number" value="5318"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="5319"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5320"></td><td class="line-content">    /* ====== Tabla + resumen ====== */</td></tr><tr><td class="line-number" value="5321"></td><td class="line-content">    function SP_renderTable(perSec, filtro){</td></tr><tr><td class="line-number" value="5322"></td><td class="line-content">      const tb = document.getElementById('AT27_SP_tbody');</td></tr><tr><td class="line-number" value="5323"></td><td class="line-content">      let rows = Object.entries(perSec).map(([sec,x])=&gt;({</td></tr><tr><td class="line-number" value="5324"></td><td class="line-content">        sec, L0:x.L0, Ld:x.Ld, gap0:x.gap0, gapd:x.gapd, flip:x.flip</td></tr><tr><td class="line-number" value="5325"></td><td class="line-content">      }));</td></tr><tr><td class="line-number" value="5326"></td><td class="line-content">      if (filtro!=='TODOS') rows = rows.filter(r=&gt; r.flip===filtro);</td></tr><tr><td class="line-number" value="5327"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5328"></td><td class="line-content">      // orden: FAVOR primero (por |gapd| más justo), luego CONTRA, luego NC</td></tr><tr><td class="line-number" value="5329"></td><td class="line-content">      const keyRank = t =&gt; t==='FAVOR'?0 : (t==='CONTRA'?1:2);</td></tr><tr><td class="line-number" value="5330"></td><td class="line-content">      rows.sort((a,b)=&gt; (keyRank(a.flip)-keyRank(b.flip))</td></tr><tr><td class="line-number" value="5331"></td><td class="line-content">                        || (Math.abs(a.gapd)-Math.abs(b.gapd))</td></tr><tr><td class="line-number" value="5332"></td><td class="line-content">                        || (Number(a.sec)-Number(b.sec)));</td></tr><tr><td class="line-number" value="5333"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5334"></td><td class="line-content">      tb.innerHTML = rows.map(r=&gt;{</td></tr><tr><td class="line-number" value="5335"></td><td class="line-content">        const bg = r.flip==='FAVOR' ? '#dcfce7' : (r.flip==='CONTRA' ? '#fee2e2' : '');</td></tr><tr><td class="line-number" value="5336"></td><td class="line-content">        return `</td></tr><tr><td class="line-number" value="5337"></td><td class="line-content">          &lt;tr data-sec="${r.sec}" style="cursor:pointer; background:${bg};"&gt;</td></tr><tr><td class="line-number" value="5338"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #e5e7eb;"&gt;${r.sec}&lt;/td&gt;</td></tr><tr><td class="line-number" value="5339"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #e5e7eb;"&gt;${r.L0}&lt;/td&gt;</td></tr><tr><td class="line-number" value="5340"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #e5e7eb;"&gt;${r.Ld}&lt;/td&gt;</td></tr><tr><td class="line-number" value="5341"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #e5e7eb; text-align:right;"&gt;${fmtpp(r.gap0)}&lt;/td&gt;</td></tr><tr><td class="line-number" value="5342"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #e5e7eb; text-align:right;"&gt;${fmtpp(r.gapd)}&lt;/td&gt;</td></tr><tr><td class="line-number" value="5343"></td><td class="line-content">            &lt;td style="padding:6px 8px; border-bottom:1px solid #e5e7eb;"&gt;${r.flip}&lt;/td&gt;</td></tr><tr><td class="line-number" value="5344"></td><td class="line-content">          &lt;/tr&gt;`;</td></tr><tr><td class="line-number" value="5345"></td><td class="line-content">      }).join('');</td></tr><tr><td class="line-number" value="5346"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5347"></td><td class="line-content">      tb.onclick = (e)=&gt;{</td></tr><tr><td class="line-number" value="5348"></td><td class="line-content">        const tr = e.target.closest('tr[data-sec]'); if (!tr) return;</td></tr><tr><td class="line-number" value="5349"></td><td class="line-content">        SP_focus(tr.getAttribute('data-sec'));</td></tr><tr><td class="line-number" value="5350"></td><td class="line-content">      };</td></tr><tr><td class="line-number" value="5351"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="5352"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5353"></td><td class="line-content">    function SP_renderSummary(perSec){</td></tr><tr><td class="line-number" value="5354"></td><td class="line-content">      const el = document.getElementById('AT27_SP_summary');</td></tr><tr><td class="line-number" value="5355"></td><td class="line-content">      let fav=0, contra=0, nc=0;</td></tr><tr><td class="line-number" value="5356"></td><td class="line-content">      Object.values(perSec).forEach(x=&gt;{</td></tr><tr><td class="line-number" value="5357"></td><td class="line-content">        if (x.flip==='FAVOR') fav++;</td></tr><tr><td class="line-number" value="5358"></td><td class="line-content">        else if (x.flip==='CONTRA') contra++;</td></tr><tr><td class="line-number" value="5359"></td><td class="line-content">        else nc++;</td></tr><tr><td class="line-number" value="5360"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="5361"></td><td class="line-content">      el.innerHTML = `</td></tr><tr><td class="line-number" value="5362"></td><td class="line-content">        &lt;div style="font-size:12px; line-height:1.35;"&gt;</td></tr><tr><td class="line-number" value="5363"></td><td class="line-content">          Cambios con Δp: &lt;b&gt;${fav+contra}&lt;/b&gt; · A favor: &lt;b style="color:${SP_COL.FAVOR}"&gt;${fav}&lt;/b&gt;</td></tr><tr><td class="line-number" value="5364"></td><td class="line-content">          · En contra: &lt;b style="color:${SP_COL.CONTRA}"&gt;${contra}&lt;/b&gt; · Sin cambio: &lt;b&gt;${nc}&lt;/b&gt;</td></tr><tr><td class="line-number" value="5365"></td><td class="line-content">        &lt;/div&gt;`;</td></tr><tr><td class="line-number" value="5366"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="5367"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5368"></td><td class="line-content">    function SP_focus(sec){</td></tr><tr><td class="line-number" value="5369"></td><td class="line-content">      const id = sec4(sec);</td></tr><tr><td class="line-number" value="5370"></td><td class="line-content">      const map = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="5371"></td><td class="line-content">      const lyr = window.AT27_SP_LAYERS[id];</td></tr><tr><td class="line-number" value="5372"></td><td class="line-content">      if (!map) return;</td></tr><tr><td class="line-number" value="5373"></td><td class="line-content">      if (lyr){</td></tr><tr><td class="line-number" value="5374"></td><td class="line-content">        try{ map.fitBounds(lyr.getBounds(), {maxZoom:16, padding:[20,20]}); }catch(_){}</td></tr><tr><td class="line-number" value="5375"></td><td class="line-content">        if (lyr.openTooltip) lyr.openTooltip();</td></tr><tr><td class="line-number" value="5376"></td><td class="line-content">        const ofo = lyr.options.fillOpacity ?? .3;</td></tr><tr><td class="line-number" value="5377"></td><td class="line-content">        lyr.setStyle({weight:3, fillOpacity: Math.min(.95, ofo+.25)});</td></tr><tr><td class="line-number" value="5378"></td><td class="line-content">        setTimeout(()=&gt; lyr.setStyle({weight:1, fillOpacity:ofo}), 900);</td></tr><tr><td class="line-number" value="5379"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="5380"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="5381"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5382"></td><td class="line-content">    /* ====== RUN ====== */</td></tr><tr><td class="line-number" value="5383"></td><td class="line-content">    async function AT27_SP_run(){</td></tr><tr><td class="line-number" value="5384"></td><td class="line-content">      if (window.AT27_SP_STATE.running) return;</td></tr><tr><td class="line-number" value="5385"></td><td class="line-content">      window.AT27_SP_STATE.running = true;</td></tr><tr><td class="line-number" value="5386"></td><td class="line-content">      try{</td></tr><tr><td class="line-number" value="5387"></td><td class="line-content">        const puesto  = document.getElementById('AT27_SP_selPuesto').value;</td></tr><tr><td class="line-number" value="5388"></td><td class="line-content">        const partido = document.getElementById('AT27_SP_selPartido').value.toUpperCase();</td></tr><tr><td class="line-number" value="5389"></td><td class="line-content">        const delta   = Number(document.getElementById('AT27_SP_delta').value || 0); // ±pp</td></tr><tr><td class="line-number" value="5390"></td><td class="line-content">        const filtro  = document.getElementById('AT27_SP_filtro').value; // TODOS|FAVOR|CONTRA</td></tr><tr><td class="line-number" value="5391"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5392"></td><td class="line-content">        const secIds = SP_getUniverseSecIds();</td></tr><tr><td class="line-number" value="5393"></td><td class="line-content">        if (!secIds.length){ SP_clear(); document.getElementById('AT27_SP_tbody').innerHTML=''; return; }</td></tr><tr><td class="line-number" value="5394"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5395"></td><td class="line-content">        const js   = await SP_load(puesto);</td></tr><tr><td class="line-number" value="5396"></td><td class="line-content">        const per  = SP_compute(js, secIds, puesto, partido, delta);</td></tr><tr><td class="line-number" value="5397"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5398"></td><td class="line-content">        SP_buildOverlay(per, filtro);</td></tr><tr><td class="line-number" value="5399"></td><td class="line-content">        SP_renderSummary(per);</td></tr><tr><td class="line-number" value="5400"></td><td class="line-content">        SP_renderTable(per, filtro);</td></tr><tr><td class="line-number" value="5401"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5402"></td><td class="line-content">      }catch(e){</td></tr><tr><td class="line-number" value="5403"></td><td class="line-content">        console.error('AT27_SP_run', e);</td></tr><tr><td class="line-number" value="5404"></td><td class="line-content">        alert('No pude ejecutar “Sensibilidad a participación”.');</td></tr><tr><td class="line-number" value="5405"></td><td class="line-content">      }finally{</td></tr><tr><td class="line-number" value="5406"></td><td class="line-content">        window.AT27_SP_STATE.running = false;</td></tr><tr><td class="line-number" value="5407"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="5408"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="5409"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5410"></td><td class="line-content">    /* ====== Panel UI ====== */</td></tr><tr><td class="line-number" value="5411"></td><td class="line-content">    function AT27_SP_open(){</td></tr><tr><td class="line-number" value="5412"></td><td class="line-content">      let panel = document.getElementById('AT27_SP_panel');</td></tr><tr><td class="line-number" value="5413"></td><td class="line-content">      if (panel){ panel.style.display='block'; return; }</td></tr><tr><td class="line-number" value="5414"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5415"></td><td class="line-content">      panel = document.createElement('div');</td></tr><tr><td class="line-number" value="5416"></td><td class="line-content">      panel.id = 'AT27_SP_panel';</td></tr><tr><td class="line-number" value="5417"></td><td class="line-content">      Object.assign(panel.style,{</td></tr><tr><td class="line-number" value="5418"></td><td class="line-content">        position:'fixed', right:'24px', top:'24px', zIndex:9998,</td></tr><tr><td class="line-number" value="5419"></td><td class="line-content">        width:'560px', maxWidth:'calc(100vw - 40px)', maxHeight:'calc(100vh - 40px)',</td></tr><tr><td class="line-number" value="5420"></td><td class="line-content">        background:'#fff', border:'1px solid #e5e7eb', borderRadius:'14px',</td></tr><tr><td class="line-number" value="5421"></td><td class="line-content">        boxShadow:'0 18px 40px rgba(0,0,0,.18)', display:'flex', flexDirection:'column',</td></tr><tr><td class="line-number" value="5422"></td><td class="line-content">        overflow:'hidden', resize:'both', minWidth:'380px', minHeight:'280px'</td></tr><tr><td class="line-number" value="5423"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="5424"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5425"></td><td class="line-content">      panel.innerHTML = `</td></tr><tr><td class="line-number" value="5426"></td><td class="line-content">        &lt;div id="AT27_SP_hdr" style="cursor:move; user-select:none; background:#fff7ed; color:#111; padding:10px 12px; display:flex; gap:10px; align-items:center;"&gt;</td></tr><tr><td class="line-number" value="5427"></td><td class="line-content">          &lt;div style="font-weight:800;"&gt;Sensibilidad a participación (±pp)&lt;/div&gt;</td></tr><tr><td class="line-number" value="5428"></td><td class="line-content">          &lt;button id="AT27_SP_center" style="margin-left:auto; background:#eef2ff; border:1px solid #c7d2fe; border-radius:8px; padding:4px 8px; cursor:pointer;"&gt;Recentrar&lt;/button&gt;</td></tr><tr><td class="line-number" value="5429"></td><td class="line-content">          &lt;button id="AT27_SP_close" title="Cerrar" style="background:transparent;border:none;font-size:18px;cursor:pointer;"&gt;×&lt;/button&gt;</td></tr><tr><td class="line-number" value="5430"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="5431"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5432"></td><td class="line-content">        &lt;div style="padding:10px 12px; display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:end;"&gt;</td></tr><tr><td class="line-number" value="5433"></td><td class="line-content">          &lt;label style="font-size:12px;"&gt;Puesto&lt;br&gt;</td></tr><tr><td class="line-number" value="5434"></td><td class="line-content">            &lt;select id="AT27_SP_selPuesto" class="ttb-select" style="width:100%;"&gt;</td></tr><tr><td class="line-number" value="5435"></td><td class="line-content">              &lt;option value="A"&gt;Ayuntamiento&lt;/option&gt;</td></tr><tr><td class="line-number" value="5436"></td><td class="line-content">              &lt;option value="DL"&gt;Diputado Local&lt;/option&gt;</td></tr><tr><td class="line-number" value="5437"></td><td class="line-content">              &lt;option value="DF"&gt;Diputado Federal&lt;/option&gt;</td></tr><tr><td class="line-number" value="5438"></td><td class="line-content">            &lt;/select&gt;</td></tr><tr><td class="line-number" value="5439"></td><td class="line-content">          &lt;/label&gt;</td></tr><tr><td class="line-number" value="5440"></td><td class="line-content">          &lt;label style="font-size:12px;"&gt;Partido&lt;br&gt;</td></tr><tr><td class="line-number" value="5441"></td><td class="line-content">            &lt;select id="AT27_SP_selPartido" class="ttb-select" style="width:100%;"&gt;</td></tr><tr><td class="line-number" value="5442"></td><td class="line-content">              &lt;option&gt;PAN&lt;/option&gt;&lt;option&gt;PRI&lt;/option&gt;&lt;option&gt;PVEM&lt;/option&gt;&lt;option&gt;MORENA&lt;/option&gt;</td></tr><tr><td class="line-number" value="5443"></td><td class="line-content">            &lt;/select&gt;</td></tr><tr><td class="line-number" value="5444"></td><td class="line-content">          &lt;/label&gt;</td></tr><tr><td class="line-number" value="5445"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5446"></td><td class="line-content">          &lt;div style="grid-column:1 / span 2; display:flex; gap:14px; align-items:center; font-size:12px;"&gt;</td></tr><tr><td class="line-number" value="5447"></td><td class="line-content">            Δ participación (pp) </td></tr><tr><td class="line-number" value="5448"></td><td class="line-content">            &lt;input id="AT27_SP_delta" type="range" min="-8" max="8" step="0.5" value="2" style="flex:1;"&gt;</td></tr><tr><td class="line-number" value="5449"></td><td class="line-content">            &lt;span id="AT27_SP_lblDelta" style="width:60px; text-align:right;"&gt;+2.0 pp&lt;/span&gt;</td></tr><tr><td class="line-number" value="5450"></td><td class="line-content">            &lt;span style="opacity:.7;"&gt;Filtrar:&lt;/span&gt;</td></tr><tr><td class="line-number" value="5451"></td><td class="line-content">            &lt;select id="AT27_SP_filtro" class="ttb-select"&gt;</td></tr><tr><td class="line-number" value="5452"></td><td class="line-content">              &lt;option value="TODOS"&gt;Todos&lt;/option&gt;</td></tr><tr><td class="line-number" value="5453"></td><td class="line-content">              &lt;option value="FAVOR"&gt;Solo a favor&lt;/option&gt;</td></tr><tr><td class="line-number" value="5454"></td><td class="line-content">              &lt;option value="CONTRA"&gt;Solo en contra&lt;/option&gt;</td></tr><tr><td class="line-number" value="5455"></td><td class="line-content">            &lt;/select&gt;</td></tr><tr><td class="line-number" value="5456"></td><td class="line-content">            &lt;button id="AT27_SP_run" class="ttb-btn ttb-primary" style="margin-left:auto;"&gt;Ejecutar&lt;/button&gt;</td></tr><tr><td class="line-number" value="5457"></td><td class="line-content">          &lt;/div&gt;</td></tr><tr><td class="line-number" value="5458"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="5459"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5460"></td><td class="line-content">        &lt;div style="padding:8px 12px;"&gt;</td></tr><tr><td class="line-number" value="5461"></td><td class="line-content">          &lt;div id="AT27_SP_legend" style="font-size:12px; display:flex; gap:12px; align-items:center; margin-bottom:6px;"&gt;</td></tr><tr><td class="line-number" value="5462"></td><td class="line-content">            &lt;span&gt;&lt;span style="display:inline-block;width:10px;height:10px;background:${SP_COL.FAVOR};border-radius:2px;"&gt;&lt;/span&gt; Voltea a tu favor&lt;/span&gt;</td></tr><tr><td class="line-number" value="5463"></td><td class="line-content">            &lt;span&gt;&lt;span style="display:inline-block;width:10px;height:10px;background:${SP_COL.CONTRA};border-radius:2px;"&gt;&lt;/span&gt; Voltea en contra&lt;/span&gt;</td></tr><tr><td class="line-number" value="5464"></td><td class="line-content">            &lt;span&gt;&lt;span style="display:inline-block;width:10px;height:10px;background:${SP_COL.NC};border-radius:2px;"&gt;&lt;/span&gt; Sin cambio&lt;/span&gt;</td></tr><tr><td class="line-number" value="5465"></td><td class="line-content">          &lt;/div&gt;</td></tr><tr><td class="line-number" value="5466"></td><td class="line-content">          &lt;div id="AT27_SP_summary" style="font-size:12px; color:#334155;"&gt;&lt;/div&gt;</td></tr><tr><td class="line-number" value="5467"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="5468"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5469"></td><td class="line-content">        &lt;div style="flex:1; overflow:auto;"&gt;</td></tr><tr><td class="line-number" value="5470"></td><td class="line-content">          &lt;table style="width:100%; border-collapse:collapse; font-size:12px;"&gt;</td></tr><tr><td class="line-number" value="5471"></td><td class="line-content">            &lt;thead&gt;</td></tr><tr><td class="line-number" value="5472"></td><td class="line-content">              &lt;tr style="position:sticky; top:0; background:#f8fafc;"&gt;</td></tr><tr><td class="line-number" value="5473"></td><td class="line-content">                &lt;th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Sección&lt;/th&gt;</td></tr><tr><td class="line-number" value="5474"></td><td class="line-content">                &lt;th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Ganador base&lt;/th&gt;</td></tr><tr><td class="line-number" value="5475"></td><td class="line-content">                &lt;th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Ganador con Δp&lt;/th&gt;</td></tr><tr><td class="line-number" value="5476"></td><td class="line-content">                &lt;th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Margen base&lt;/th&gt;</td></tr><tr><td class="line-number" value="5477"></td><td class="line-content">                &lt;th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Margen Δp&lt;/th&gt;</td></tr><tr><td class="line-number" value="5478"></td><td class="line-content">                &lt;th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;"&gt;Cambio&lt;/th&gt;</td></tr><tr><td class="line-number" value="5479"></td><td class="line-content">              &lt;/tr&gt;</td></tr><tr><td class="line-number" value="5480"></td><td class="line-content">            &lt;/thead&gt;</td></tr><tr><td class="line-number" value="5481"></td><td class="line-content">            &lt;tbody id="AT27_SP_tbody"&gt;&lt;/tbody&gt;</td></tr><tr><td class="line-number" value="5482"></td><td class="line-content">          &lt;/table&gt;</td></tr><tr><td class="line-number" value="5483"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="5484"></td><td class="line-content">      `;</td></tr><tr><td class="line-number" value="5485"></td><td class="line-content">      document.body.appendChild(panel);</td></tr><tr><td class="line-number" value="5486"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5487"></td><td class="line-content">      // Wiring UI</td></tr><tr><td class="line-number" value="5488"></td><td class="line-content">      const $$ = (sel)=&gt; panel.querySelector(sel);</td></tr><tr><td class="line-number" value="5489"></td><td class="line-content">      $$('#AT27_SP_close').onclick  = ()=&gt; panel.style.display='none';</td></tr><tr><td class="line-number" value="5490"></td><td class="line-content">      $$('#AT27_SP_center').onclick = ()=&gt; (window.AT27_fitUniverseBounds? AT27_fitUniverseBounds() : null);</td></tr><tr><td class="line-number" value="5491"></td><td class="line-content">      $$('#AT27_SP_run').onclick    = ()=&gt;{ window.AT27_SP_STATE.autorun = true; AT27_SP_run(); };</td></tr><tr><td class="line-number" value="5492"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5493"></td><td class="line-content">      // Sync etiqueta del slider</td></tr><tr><td class="line-number" value="5494"></td><td class="line-content">      const syncΔ = ()=&gt;{</td></tr><tr><td class="line-number" value="5495"></td><td class="line-content">        const v = Number($$('#AT27_SP_delta').value||0);</td></tr><tr><td class="line-number" value="5496"></td><td class="line-content">        $$('#AT27_SP_lblDelta').textContent = (v&gt;=0? '+' : '') + v.toFixed(1) + ' pp';</td></tr><tr><td class="line-number" value="5497"></td><td class="line-content">      };</td></tr><tr><td class="line-number" value="5498"></td><td class="line-content">      $$('#AT27_SP_delta').addEventListener('input', syncΔ);</td></tr><tr><td class="line-number" value="5499"></td><td class="line-content">      syncΔ();</td></tr><tr><td class="line-number" value="5500"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5501"></td><td class="line-content">      // Drag + bloqueo eventos al mapa</td></tr><tr><td class="line-number" value="5502"></td><td class="line-content">      (function drag(panelEl, handleEl){</td></tr><tr><td class="line-number" value="5503"></td><td class="line-content">        let sx=0, sy=0, ox=0, oy=0, dragging=false;</td></tr><tr><td class="line-number" value="5504"></td><td class="line-content">        handleEl.addEventListener('mousedown', e=&gt;{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panelEl.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });</td></tr><tr><td class="line-number" value="5505"></td><td class="line-content">        window.addEventListener('mousemove', e=&gt;{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panelEl.style.left=(ox+dx)+'px'; panelEl.style.top=(oy+dy)+'px'; panelEl.style.right='auto'; });</td></tr><tr><td class="line-number" value="5506"></td><td class="line-content">        window.addEventListener('mouseup', ()=&gt;{ dragging=false; document.body.style.userSelect=''; });</td></tr><tr><td class="line-number" value="5507"></td><td class="line-content">      })(panel, panel.querySelector('#AT27_SP_hdr'));</td></tr><tr><td class="line-number" value="5508"></td><td class="line-content">      if (window.L &amp;&amp; L.DomEvent){ L.DomEvent.disableClickPropagation(panel); L.DomEvent.disableScrollPropagation(panel); }</td></tr><tr><td class="line-number" value="5509"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5510"></td><td class="line-content">      // Recalcular si cambias universo (tras primer run)</td></tr><tr><td class="line-number" value="5511"></td><td class="line-content">      const map = window.AT_CTX?.map || window.map;</td></tr><tr><td class="line-number" value="5512"></td><td class="line-content">      if (map &amp;&amp; !map.__spBound){</td></tr><tr><td class="line-number" value="5513"></td><td class="line-content">        const deb = (fn,ms=350)=&gt;{ let t; return (...a)=&gt;{ clearTimeout(t); t=setTimeout(()=&gt;fn(...a),ms); }; };</td></tr><tr><td class="line-number" value="5514"></td><td class="line-content">        map.on('layeradd',    deb(()=&gt;{ if (window.AT27_SP_STATE.autorun) AT27_SP_run(); }));</td></tr><tr><td class="line-number" value="5515"></td><td class="line-content">        map.on('layerremove', deb(()=&gt;{ if (window.AT27_SP_STATE.autorun) AT27_SP_run(); }));</td></tr><tr><td class="line-number" value="5516"></td><td class="line-content">        map.__spBound = true;</td></tr><tr><td class="line-number" value="5517"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="5518"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="5519"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5520"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5521"></td><td class="line-content"><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="5522"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5523"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5524"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5525"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5526"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5527"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5528"></td><td class="line-content"><span class="html-tag">&lt;script&gt;</span></td></tr><tr><td class="line-number" value="5529"></td><td class="line-content">  // ========== GANAR TODO · AYUDA (AT27_GT_HELP_) ==========</td></tr><tr><td class="line-number" value="5530"></td><td class="line-content">  function AT27_GT_HELP_open(){</td></tr><tr><td class="line-number" value="5531"></td><td class="line-content">    let panel = document.getElementById('AT27_GT_help');</td></tr><tr><td class="line-number" value="5532"></td><td class="line-content">    if (panel){ panel.style.display='block'; clampToViewport(panel); return; }</td></tr><tr><td class="line-number" value="5533"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5534"></td><td class="line-content">    panel = document.createElement('div');</td></tr><tr><td class="line-number" value="5535"></td><td class="line-content">    panel.id = 'AT27_GT_help';</td></tr><tr><td class="line-number" value="5536"></td><td class="line-content">    Object.assign(panel.style,{</td></tr><tr><td class="line-number" value="5537"></td><td class="line-content">      position:'fixed', right:'24px', top:'24px', zIndex:9999,</td></tr><tr><td class="line-number" value="5538"></td><td class="line-content">      width: Math.min(560, window.innerWidth - 64) + 'px',</td></tr><tr><td class="line-number" value="5539"></td><td class="line-content">      maxWidth:'calc(100vw - 48px)', maxHeight:'calc(100vh - 48px)',</td></tr><tr><td class="line-number" value="5540"></td><td class="line-content">      background:'#fff', border:'1px solid #e5e7eb', borderRadius:'14px',</td></tr><tr><td class="line-number" value="5541"></td><td class="line-content">      boxShadow:'0 18px 40px rgba(0,0,0,.18)', overflow:'hidden',</td></tr><tr><td class="line-number" value="5542"></td><td class="line-content">      display:'flex', flexDirection:'column', resize:'both',</td></tr><tr><td class="line-number" value="5543"></td><td class="line-content">      minWidth:'380px', minHeight:'280px'</td></tr><tr><td class="line-number" value="5544"></td><td class="line-content">    });</td></tr><tr><td class="line-number" value="5545"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5546"></td><td class="line-content">    panel.innerHTML = `</td></tr><tr><td class="line-number" value="5547"></td><td class="line-content">      &lt;div id="AT27_GT_help_hdr" style="cursor:move; user-select:none; background:#f0f9ff; color:#111; padding:10px 12px; display:flex; gap:10px; align-items:center;"&gt;</td></tr><tr><td class="line-number" value="5548"></td><td class="line-content">        &lt;div style="font-weight:800;"&gt;ℹ️ Minimanual — Ganar Todo&lt;/div&gt;</td></tr><tr><td class="line-number" value="5549"></td><td class="line-content">        &lt;button id="AT27_GT_help_close" title="Cerrar" style="margin-left:auto;background:transparent;color:#111;border:none;font-size:18px;cursor:pointer;"&gt;×&lt;/button&gt;</td></tr><tr><td class="line-number" value="5550"></td><td class="line-content">      &lt;/div&gt;</td></tr><tr><td class="line-number" value="5551"></td><td class="line-content">      &lt;div id="AT27_GT_help_body" style="padding:12px 14px; flex:1; overflow:auto; font-family:system-ui,Segoe UI,Roboto,Arial; color:#111;"&gt;</td></tr><tr><td class="line-number" value="5552"></td><td class="line-content">        &lt;p style="margin:0 0 10px; color:#475569; font-size:13px;"&gt;</td></tr><tr><td class="line-number" value="5553"></td><td class="line-content">          Consultas a nivel &lt;b&gt;universo&lt;/b&gt; (estado/municipio/DF/DL) con drill-down a sección. Se recalculan con el universo visible.</td></tr><tr><td class="line-number" value="5554"></td><td class="line-content">        &lt;/p&gt;</td></tr><tr><td class="line-number" value="5555"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5556"></td><td class="line-content">        &lt;details open style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;"&gt;</td></tr><tr><td class="line-number" value="5557"></td><td class="line-content">          &lt;summary style="cursor:pointer; font-weight:700;"&gt;Metas de participación 2027*&lt;/summary&gt;</td></tr><tr><td class="line-number" value="5558"></td><td class="line-content">          &lt;div style="margin-top:8px; font-size:13px; color:#334155;"&gt;</td></tr><tr><td class="line-number" value="5559"></td><td class="line-content">            &lt;b&gt;Qué muestra:&lt;/b&gt; si cada sección &lt;b&gt;cumple&lt;/b&gt; una &lt;b&gt;meta&lt;/b&gt; de participación 2027* (verde), está &lt;b&gt;cerca&lt;/b&gt; (amarillo) o &lt;b&gt;debajo&lt;/b&gt; (rojo).&lt;br&gt;</td></tr><tr><td class="line-number" value="5560"></td><td class="line-content">            &lt;b&gt;Cómputo:&lt;/b&gt; p2027* por regresión ponderada 2018/2021/2024; meta y tolerancia ajustables.&lt;br&gt;</td></tr><tr><td class="line-number" value="5561"></td><td class="line-content">            &lt;b&gt;Cómo leerlo:&lt;/b&gt; prioriza “Near”; revisa promedio ponderado por LN 2024.&lt;br&gt;</td></tr><tr><td class="line-number" value="5562"></td><td class="line-content">            &lt;b&gt;Notas:&lt;/b&gt; proyección conservadora si faltan años.</td></tr><tr><td class="line-number" value="5563"></td><td class="line-content">          &lt;/div&gt;</td></tr><tr><td class="line-number" value="5564"></td><td class="line-content">        &lt;/details&gt;</td></tr><tr><td class="line-number" value="5565"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5566"></td><td class="line-content">        &lt;details style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;"&gt;</td></tr><tr><td class="line-number" value="5567"></td><td class="line-content">          &lt;summary style="cursor:pointer; font-weight:700;"&gt;¿Qué se requiere para ganar todo? (brecha 2027)&lt;/summary&gt;</td></tr><tr><td class="line-number" value="5568"></td><td class="line-content">          &lt;div style="margin-top:8px; font-size:13px; color:#334155;"&gt;</td></tr><tr><td class="line-number" value="5569"></td><td class="line-content">            &lt;b&gt;Qué muestra:&lt;/b&gt; para un &lt;i&gt;partido&lt;/i&gt; y &lt;i&gt;puesto&lt;/i&gt;, colorea por &lt;b&gt;ganador proyectado 2027*&lt;/b&gt; (PAN=azul, PRI=rojo, PVEM=verde, MORENA=guinda) y lista por sección:</td></tr><tr><td class="line-number" value="5570"></td><td class="line-content">            &lt;b&gt;ganador&lt;/b&gt;, &lt;b&gt;votos del líder&lt;/b&gt;, &lt;b&gt;faltan&lt;/b&gt; y &lt;b&gt;swing&lt;/b&gt;.&lt;br&gt;</td></tr><tr><td class="line-number" value="5571"></td><td class="line-content">            &lt;b&gt;Cómputo:&lt;/b&gt; Vproj = LN(2024)×p2027*; votos por partido = share(2024)×Vproj; faltan = max(0, vL−vX+1); swing = ceil(faltan/2).&lt;br&gt;</td></tr><tr><td class="line-number" value="5572"></td><td class="line-content">            &lt;b&gt;Cómo leerlo:&lt;/b&gt; la tabla prioriza por menor “faltan”; clic en fila hace zoom y muestra tooltip.&lt;br&gt;</td></tr><tr><td class="line-number" value="5573"></td><td class="line-content">            &lt;b&gt;Notas:&lt;/b&gt; tras el primer “Ejecutar”, si cambias el universo se recalcula solo.</td></tr><tr><td class="line-number" value="5574"></td><td class="line-content">          &lt;/div&gt;</td></tr><tr><td class="line-number" value="5575"></td><td class="line-content">        &lt;/details&gt;</td></tr><tr><td class="line-number" value="5576"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5577"></td><td class="line-content">        &lt;details style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;"&gt;</td></tr><tr><td class="line-number" value="5578"></td><td class="line-content">          &lt;summary style="cursor:pointer; font-weight:700;"&gt;Estabilidad política 2018–2024&lt;/summary&gt;</td></tr><tr><td class="line-number" value="5579"></td><td class="line-content">          &lt;div style="margin-top:8px; font-size:13px; color:#334155;"&gt;</td></tr><tr><td class="line-number" value="5580"></td><td class="line-content">            &lt;b&gt;Qué muestra:&lt;/b&gt; continuidad/cambio por sección (verde/amarillo/rojo) en el universo actual.&lt;br&gt;</td></tr><tr><td class="line-number" value="5581"></td><td class="line-content">            &lt;b&gt;Uso:&lt;/b&gt; combina con brecha 2027 para decidir estrategia: &lt;i&gt;“near” + baja estabilidad&lt;/i&gt; = oportunidad clara.</td></tr><tr><td class="line-number" value="5582"></td><td class="line-content">          &lt;/div&gt;</td></tr><tr><td class="line-number" value="5583"></td><td class="line-content">        &lt;/details&gt;</td></tr><tr><td class="line-number" value="5584"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5585"></td><td class="line-content">        &lt;details style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;"&gt;</td></tr><tr><td class="line-number" value="5586"></td><td class="line-content">          &lt;summary style="cursor:pointer; font-weight:700;"&gt;Participación 2018/2021/2024 → 2027*&lt;/summary&gt;</td></tr><tr><td class="line-number" value="5587"></td><td class="line-content">          &lt;div style="margin-top:8px; font-size:13px; color:#334155;"&gt;</td></tr><tr><td class="line-number" value="5588"></td><td class="line-content">            &lt;b&gt;Qué muestra:&lt;/b&gt; mapa por participación histórica y proyección 2027* con rangos (&amp;lt;30% rojo, 30–50% amarillo, &amp;gt;50% verde).&lt;br&gt;</td></tr><tr><td class="line-number" value="5589"></td><td class="line-content">            &lt;b&gt;Uso:&lt;/b&gt; detección de secciones estructuralmente bajas (movilización).</td></tr><tr><td class="line-number" value="5590"></td><td class="line-content">          &lt;/div&gt;</td></tr><tr><td class="line-number" value="5591"></td><td class="line-content">        &lt;/details&gt;</td></tr><tr><td class="line-number" value="5592"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5593"></td><td class="line-content">        &lt;!-- Metas de participación 2027* --&gt;</td></tr><tr><td class="line-number" value="5594"></td><td class="line-content">        &lt;details open style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;"&gt;</td></tr><tr><td class="line-number" value="5595"></td><td class="line-content">          &lt;summary style="cursor:pointer; font-weight:700;"&gt;Metas de participación 2027*&lt;/summary&gt;</td></tr><tr><td class="line-number" value="5596"></td><td class="line-content">          &lt;div style="margin-top:8px; font-size:13px; color:#334155;"&gt;</td></tr><tr><td class="line-number" value="5597"></td><td class="line-content">            &lt;b&gt;Qué muestra:&lt;/b&gt; si cada sección &lt;b&gt;cumple&lt;/b&gt; la meta de participación 2027* (verde), está &lt;b&gt;cerca&lt;/b&gt; (amarillo) o &lt;b&gt;debajo&lt;/b&gt; (rojo).&lt;br&gt;</td></tr><tr><td class="line-number" value="5598"></td><td class="line-content">            &lt;b&gt;Cómo leerlo:&lt;/b&gt; prioriza las secciones “cerca” para cerrar la brecha; revisa el promedio del universo.&lt;br&gt;</td></tr><tr><td class="line-number" value="5599"></td><td class="line-content">            &lt;b&gt;Nota:&lt;/b&gt; la proyección se basa en tendencias 2018–2024. Es una &lt;i&gt;línea base&lt;/i&gt; para planear movilización.</td></tr><tr><td class="line-number" value="5600"></td><td class="line-content">          &lt;/div&gt;</td></tr><tr><td class="line-number" value="5601"></td><td class="line-content">        &lt;/details&gt;</td></tr><tr><td class="line-number" value="5602"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5603"></td><td class="line-content">        &lt;!-- ¿Qué se requiere para ganar todo? --&gt;</td></tr><tr><td class="line-number" value="5604"></td><td class="line-content">        &lt;details style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;"&gt;</td></tr><tr><td class="line-number" value="5605"></td><td class="line-content">          &lt;summary style="cursor:pointer; font-weight:700;"&gt;¿Qué se requiere para ganar todo? (brecha 2027)&lt;/summary&gt;</td></tr><tr><td class="line-number" value="5606"></td><td class="line-content">          &lt;div style="margin-top:8px; font-size:13px; color:#334155;"&gt;</td></tr><tr><td class="line-number" value="5607"></td><td class="line-content">            &lt;b&gt;Qué muestra:&lt;/b&gt; para el &lt;i&gt;partido&lt;/i&gt; y &lt;i&gt;puesto&lt;/i&gt; elegidos, pinta por &lt;b&gt;ganador proyectado 2027*&lt;/b&gt; y lista por sección:</td></tr><tr><td class="line-number" value="5608"></td><td class="line-content">            &lt;b&gt;ganador&lt;/b&gt;, &lt;b&gt;votos del líder&lt;/b&gt;, &lt;b&gt;faltan&lt;/b&gt; y &lt;b&gt;swing&lt;/b&gt;.&lt;br&gt;</td></tr><tr><td class="line-number" value="5609"></td><td class="line-content">            &lt;b&gt;Cómo leerlo:&lt;/b&gt; la tabla prioriza por menor “faltan”; clic en una fila centra la sección y muestra detalles.&lt;br&gt;</td></tr><tr><td class="line-number" value="5610"></td><td class="line-content">            &lt;b&gt;Nota:&lt;/b&gt; se asume el reparto de 2024 como escenario base. Úsalo para dimensionar esfuerzos.</td></tr><tr><td class="line-number" value="5611"></td><td class="line-content">          &lt;/div&gt;</td></tr><tr><td class="line-number" value="5612"></td><td class="line-content">        &lt;/details&gt;</td></tr><tr><td class="line-number" value="5613"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5614"></td><td class="line-content">        &lt;!-- Estabilidad política --&gt;</td></tr><tr><td class="line-number" value="5615"></td><td class="line-content">        &lt;details style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;"&gt;</td></tr><tr><td class="line-number" value="5616"></td><td class="line-content">          &lt;summary style="cursor:pointer; font-weight:700;"&gt;Estabilidad política 2018–2024&lt;/summary&gt;</td></tr><tr><td class="line-number" value="5617"></td><td class="line-content">          &lt;div style="margin-top:8px; font-size:13px; color:#334155;"&gt;</td></tr><tr><td class="line-number" value="5618"></td><td class="line-content">            &lt;b&gt;Qué muestra:&lt;/b&gt; continuidad/cambio del partido ganador: &lt;span style="color:#16a34a;"&gt;verde&lt;/span&gt;=alta (3 elecciones),</td></tr><tr><td class="line-number" value="5619"></td><td class="line-content">            &lt;span style="color:#f59e0b;"&gt;amarillo&lt;/span&gt;=media (hubo cambio),</td></tr><tr><td class="line-number" value="5620"></td><td class="line-content">            &lt;span style="color:#ef4444;"&gt;rojo&lt;/span&gt;=baja (tres distintos).&lt;br&gt;</td></tr><tr><td class="line-number" value="5621"></td><td class="line-content">            &lt;b&gt;Cómo leerlo:&lt;/b&gt; zonas estables son bastiones; las inestables son oportunidad o riesgo.</td></tr><tr><td class="line-number" value="5622"></td><td class="line-content">          &lt;/div&gt;</td></tr><tr><td class="line-number" value="5623"></td><td class="line-content">        &lt;/details&gt;</td></tr><tr><td class="line-number" value="5624"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5625"></td><td class="line-content">        &lt;!-- Participación histórica → 2027* (opcional) --&gt;</td></tr><tr><td class="line-number" value="5626"></td><td class="line-content">        &lt;details style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;"&gt;</td></tr><tr><td class="line-number" value="5627"></td><td class="line-content">          &lt;summary style="cursor:pointer; font-weight:700;"&gt;Participación 2018/2021/2024 → 2027*&lt;/summary&gt;</td></tr><tr><td class="line-number" value="5628"></td><td class="line-content">          &lt;div style="margin-top:8px; font-size:13px; color:#334155;"&gt;</td></tr><tr><td class="line-number" value="5629"></td><td class="line-content">            &lt;b&gt;Qué muestra:&lt;/b&gt; mapa por rangos de participación histórica y proyección 2027*:</td></tr><tr><td class="line-number" value="5630"></td><td class="line-content">            &amp;lt;30% rojo, 30–50% amarillo, &amp;gt;50% verde.&lt;br&gt;</td></tr><tr><td class="line-number" value="5631"></td><td class="line-content">            &lt;b&gt;Cómo leerlo:&lt;/b&gt; detecta secciones estructuralmente bajas para reforzar movilización.</td></tr><tr><td class="line-number" value="5632"></td><td class="line-content">          &lt;/div&gt;</td></tr><tr><td class="line-number" value="5633"></td><td class="line-content">        &lt;/details&gt;</td></tr><tr><td class="line-number" value="5634"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5635"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5636"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5637"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5638"></td><td class="line-content">      &lt;!-- 1) Probabilidad de voltear 2027 --&gt;</td></tr><tr><td class="line-number" value="5639"></td><td class="line-content">      &lt;details style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;"&gt;</td></tr><tr><td class="line-number" value="5640"></td><td class="line-content">        &lt;summary style="cursor:pointer; font-weight:700;"&gt;Probabilidad de voltear 2027&lt;/summary&gt;</td></tr><tr><td class="line-number" value="5641"></td><td class="line-content">        &lt;div style="margin-top:8px; font-size:13px; color:#334155;"&gt;</td></tr><tr><td class="line-number" value="5642"></td><td class="line-content">          &lt;b&gt;Qué muestra:&lt;/b&gt; mapa por sección en &lt;b&gt;verde&lt;/b&gt; (alta), &lt;b&gt;amarillo&lt;/b&gt; (media) y &lt;b&gt;rojo&lt;/b&gt; (baja) según la facilidad para cambiar el resultado en 2027.&lt;br&gt;</td></tr><tr><td class="line-number" value="5643"></td><td class="line-content">          &lt;b&gt;Entradas:&lt;/b&gt; Puesto, Partido, pesos para: margen 2024, cambio de participación 2018→2024, estabilidad política.&lt;br&gt;</td></tr><tr><td class="line-number" value="5644"></td><td class="line-content">          &lt;b&gt;Cálculo (resumen):&lt;/b&gt; puntaje = w₁·(margen 2024 invertido) + w₂·(sube/baja la participación) + w₃·(inestabilidad). Se normaliza 0–100 y se clasifica en alto/medio/bajo.&lt;br&gt;</td></tr><tr><td class="line-number" value="5645"></td><td class="line-content">          &lt;b&gt;Cómo leerlo:&lt;/b&gt; prioriza las secciones verdes; las amarillas requieren impulso moderado; las rojas son de alto costo.</td></tr><tr><td class="line-number" value="5646"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="5647"></td><td class="line-content">      &lt;/details&gt;</td></tr><tr><td class="line-number" value="5648"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5649"></td><td class="line-content">      &lt;!-- 2) Mínimo de votos para mayoría (por DF/DL) --&gt;</td></tr><tr><td class="line-number" value="5650"></td><td class="line-content">      &lt;details style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;"&gt;</td></tr><tr><td class="line-number" value="5651"></td><td class="line-content">        &lt;summary style="cursor:pointer; font-weight:700;"&gt;Mínimo de votos para mayoría (por DF/DL)&lt;/summary&gt;</td></tr><tr><td class="line-number" value="5652"></td><td class="line-content">        &lt;div style="margin-top:8px; font-size:13px; color:#334155;"&gt;</td></tr><tr><td class="line-number" value="5653"></td><td class="line-content">          &lt;b&gt;Qué muestra:&lt;/b&gt; cuántos votos adicionales se requieren para lograr una &lt;b&gt;mayoría de secciones&lt;/b&gt; en el ámbito elegido (DF, DL o municipio).&lt;br&gt;</td></tr><tr><td class="line-number" value="5654"></td><td class="line-content">          &lt;b&gt;Entradas:&lt;/b&gt; Puesto, Partido, ámbito y meta de secciones (por ejemplo 60%).&lt;br&gt;</td></tr><tr><td class="line-number" value="5655"></td><td class="line-content">          &lt;b&gt;Cálculo (resumen):&lt;/b&gt; ordena secciones por “&lt;i&gt;faltan&lt;/i&gt;” de menor a mayor y acumula hasta cubrir la meta; reporta total y lista priorizada.&lt;br&gt;</td></tr><tr><td class="line-number" value="5656"></td><td class="line-content">          &lt;b&gt;Cómo leerlo:&lt;/b&gt; es un plan de ataque mínimo: empieza por las secciones con menor costo.</td></tr><tr><td class="line-number" value="5657"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="5658"></td><td class="line-content">      &lt;/details&gt;</td></tr><tr><td class="line-number" value="5659"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5660"></td><td class="line-content">      &lt;!-- 3) Eficiencia del voto (votos ociosos) --&gt;</td></tr><tr><td class="line-number" value="5661"></td><td class="line-content">      &lt;details style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;"&gt;</td></tr><tr><td class="line-number" value="5662"></td><td class="line-content">        &lt;summary style="cursor:pointer; font-weight:700;"&gt;Eficiencia del voto (votos ociosos)&lt;/summary&gt;</td></tr><tr><td class="line-number" value="5663"></td><td class="line-content">        &lt;div style="margin-top:8px; font-size:13px; color:#334155;"&gt;</td></tr><tr><td class="line-number" value="5664"></td><td class="line-content">          &lt;b&gt;Qué muestra:&lt;/b&gt; dónde se “sobraron” votos al ganar por amplia ventaja y dónde faltaron para ganar.&lt;br&gt;</td></tr><tr><td class="line-number" value="5665"></td><td class="line-content">          &lt;b&gt;Entradas:&lt;/b&gt; Puesto, Partido, umbral de sobrante (puntos porcentuales).&lt;br&gt;</td></tr><tr><td class="line-number" value="5666"></td><td class="line-content">          &lt;b&gt;Cálculo (resumen):&lt;/b&gt; si se gana: ociosos = votos del partido − (votos del segundo + 1). Si se pierde: déficit = votos del segundo − votos del partido + 1. Mapa en azules (ocio) y rojos (déficit).&lt;br&gt;</td></tr><tr><td class="line-number" value="5667"></td><td class="line-content">          &lt;b&gt;Cómo leerlo:&lt;/b&gt; baja esfuerzo en secciones con gran sobrante y súbelo en déficits pequeños.</td></tr><tr><td class="line-number" value="5668"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="5669"></td><td class="line-content">      &lt;/details&gt;</td></tr><tr><td class="line-number" value="5670"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5671"></td><td class="line-content">      &lt;!-- 4) Corredores de volteo (grupos contiguos) --&gt;</td></tr><tr><td class="line-number" value="5672"></td><td class="line-content">      &lt;details style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;"&gt;</td></tr><tr><td class="line-number" value="5673"></td><td class="line-content">        &lt;summary style="cursor:pointer; font-weight:700;"&gt;Corredores de volteo (grupos contiguos)&lt;/summary&gt;</td></tr><tr><td class="line-number" value="5674"></td><td class="line-content">        &lt;div style="margin-top:8px; font-size:13px; color:#334155;"&gt;</td></tr><tr><td class="line-number" value="5675"></td><td class="line-content">          &lt;b&gt;Qué muestra:&lt;/b&gt; grupos de secciones vecinas con brecha pequeña para voltearlas en bloque.&lt;br&gt;</td></tr><tr><td class="line-number" value="5676"></td><td class="line-content">          &lt;b&gt;Entradas:&lt;/b&gt; Puesto, Partido, umbral de brecha (por ejemplo “faltan ≤ 3 pp”).&lt;br&gt;</td></tr><tr><td class="line-number" value="5677"></td><td class="line-content">          &lt;b&gt;Cálculo (resumen):&lt;/b&gt; agrupa secciones contiguas que cumplan el umbral; muestra color por grupo y el total de votos necesarios por corredor.&lt;br&gt;</td></tr><tr><td class="line-number" value="5678"></td><td class="line-content">          &lt;b&gt;Cómo leerlo:&lt;/b&gt; enfoca operación territorial por zonas, optimizando logística y comunicación.</td></tr><tr><td class="line-number" value="5679"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="5680"></td><td class="line-content">      &lt;/details&gt;</td></tr><tr><td class="line-number" value="5681"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5682"></td><td class="line-content">      &lt;!-- 5) Alertas de riesgo (bastiones en caída) --&gt;</td></tr><tr><td class="line-number" value="5683"></td><td class="line-content">      &lt;details style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;"&gt;</td></tr><tr><td class="line-number" value="5684"></td><td class="line-content">        &lt;summary style="cursor:pointer; font-weight:700;"&gt;Alertas de riesgo (bastiones en caída)&lt;/summary&gt;</td></tr><tr><td class="line-number" value="5685"></td><td class="line-content">        &lt;div style="margin-top:8px; font-size:13px; color:#334155;"&gt;</td></tr><tr><td class="line-number" value="5686"></td><td class="line-content">          &lt;b&gt;Qué muestra:&lt;/b&gt; bastiones con señales de deterioro: tendencia negativa y proyección de participación por debajo de la meta.&lt;br&gt;</td></tr><tr><td class="line-number" value="5687"></td><td class="line-content">          &lt;b&gt;Entradas:&lt;/b&gt; Puesto, meta de participación (control deslizante).&lt;br&gt;</td></tr><tr><td class="line-number" value="5688"></td><td class="line-content">          &lt;b&gt;Cálculo (resumen):&lt;/b&gt; estabilidad alta + pendiente 2018→2024 a la baja + p2027* menor a la meta → se marca como “Riesgo”.&lt;br&gt;</td></tr><tr><td class="line-number" value="5689"></td><td class="line-content">          &lt;b&gt;Cómo leerlo:&lt;/b&gt; activar pronto defensa y movilización donde la señal sea roja/ámbar.</td></tr><tr><td class="line-number" value="5690"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="5691"></td><td class="line-content">      &lt;/details&gt;</td></tr><tr><td class="line-number" value="5692"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5693"></td><td class="line-content">      &lt;!-- 6) Simulador de impulso --&gt;</td></tr><tr><td class="line-number" value="5694"></td><td class="line-content">      &lt;details style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;"&gt;</td></tr><tr><td class="line-number" value="5695"></td><td class="line-content">        &lt;summary style="cursor:pointer; font-weight:700;"&gt;Simulador de impulso&lt;/summary&gt;</td></tr><tr><td class="line-number" value="5696"></td><td class="line-content">        &lt;div style="margin-top:8px; font-size:13px; color:#334155;"&gt;</td></tr><tr><td class="line-number" value="5697"></td><td class="line-content">          &lt;b&gt;Qué muestra:&lt;/b&gt; qué pasa si se agregan votos al partido (de forma uniforme, por deciles de brecha o solo en secciones “cercanas”).&lt;br&gt;</td></tr><tr><td class="line-number" value="5698"></td><td class="line-content">          &lt;b&gt;Entradas:&lt;/b&gt; Puesto, suma de votos o aumento de porcentaje, opción “solo cercanas”.&lt;br&gt;</td></tr><tr><td class="line-number" value="5699"></td><td class="line-content">          &lt;b&gt;Cálculo (resumen):&lt;/b&gt; ajusta los votos del partido y recalcula cuántas secciones pasan a ganarse; grafica “votos añadidos → secciones ganadas”.&lt;br&gt;</td></tr><tr><td class="line-number" value="5700"></td><td class="line-content">          &lt;b&gt;Cómo leerlo:&lt;/b&gt; estima retornos por tramos de esfuerzo para planear despliegue.</td></tr><tr><td class="line-number" value="5701"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="5702"></td><td class="line-content">      &lt;/details&gt;</td></tr><tr><td class="line-number" value="5703"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5704"></td><td class="line-content">      &lt;!-- 7) Brecha relativa vs. brecha absoluta --&gt;</td></tr><tr><td class="line-number" value="5705"></td><td class="line-content">      &lt;details style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;"&gt;</td></tr><tr><td class="line-number" value="5706"></td><td class="line-content">        &lt;summary style="cursor:pointer; font-weight:700;"&gt;Brecha relativa vs. brecha absoluta&lt;/summary&gt;</td></tr><tr><td class="line-number" value="5707"></td><td class="line-content">        &lt;div style="margin-top:8px; font-size:13px; color:#334155;"&gt;</td></tr><tr><td class="line-number" value="5708"></td><td class="line-content">          &lt;b&gt;Qué muestra:&lt;/b&gt; conmutador de vista entre &lt;b&gt;puntos porcentuales&lt;/b&gt; (relativa) y &lt;b&gt;votos&lt;/b&gt; (absoluta).&lt;br&gt;</td></tr><tr><td class="line-number" value="5709"></td><td class="line-content">          &lt;b&gt;Entradas:&lt;/b&gt; Puesto, Partido, conmutador “pp/votos”.&lt;br&gt;</td></tr><tr><td class="line-number" value="5710"></td><td class="line-content">          &lt;b&gt;Cálculo (resumen):&lt;/b&gt; relativa = (votos del líder − votos del partido) / Vproj · 100; absoluta = “faltan”.&lt;br&gt;</td></tr><tr><td class="line-number" value="5711"></td><td class="line-content">          &lt;b&gt;Cómo leerlo:&lt;/b&gt; usa la relativa para comparar dificultad; usa la absoluta para dimensionar movilización.</td></tr><tr><td class="line-number" value="5712"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="5713"></td><td class="line-content">      &lt;/details&gt;</td></tr><tr><td class="line-number" value="5714"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5715"></td><td class="line-content">      &lt;!-- 8) Sensibilidad a participación --&gt;</td></tr><tr><td class="line-number" value="5716"></td><td class="line-content">      &lt;details style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;"&gt;</td></tr><tr><td class="line-number" value="5717"></td><td class="line-content">        &lt;summary style="cursor:pointer; font-weight:700;"&gt;Sensibilidad a participación&lt;/summary&gt;</td></tr><tr><td class="line-number" value="5718"></td><td class="line-content">        &lt;div style="margin-top:8px; font-size:13px; color:#334155;"&gt;</td></tr><tr><td class="line-number" value="5719"></td><td class="line-content">          &lt;b&gt;Qué muestra:&lt;/b&gt; cómo cambia el ganador por sección si la participación proyectada sube o baja algunos puntos.&lt;br&gt;</td></tr><tr><td class="line-number" value="5720"></td><td class="line-content">          &lt;b&gt;Entradas:&lt;/b&gt; Puesto, Partido, variación de participación (± en puntos).&lt;br&gt;</td></tr><tr><td class="line-number" value="5721"></td><td class="line-content">          &lt;b&gt;Cálculo (resumen):&lt;/b&gt; ajusta p2027* ± δ, recalcula Vproj y resultados; destaca secciones que cambian de ganador.&lt;br&gt;</td></tr><tr><td class="line-number" value="5722"></td><td class="line-content">          &lt;b&gt;Cómo leerlo:&lt;/b&gt; identifica territorios sensibles a la movilización (o al abstencionismo).</td></tr><tr><td class="line-number" value="5723"></td><td class="line-content">        &lt;/div&gt;</td></tr><tr><td class="line-number" value="5724"></td><td class="line-content">      &lt;/details&gt;</td></tr><tr><td class="line-number" value="5725"></td><td class="line-content">    &lt;/div&gt;</td></tr><tr><td class="line-number" value="5726"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5727"></td><td class="line-content">        &lt;p style="margin:10px 0 0; color:#64748b; font-size:12px;"&gt;</td></tr><tr><td class="line-number" value="5728"></td><td class="line-content">          &lt;b&gt;Limitación:&lt;/b&gt; la proyección asume shares 2024 constantes (escenario base). Úsalo como línea base, no como predicción definitiva.</td></tr><tr><td class="line-number" value="5729"></td><td class="line-content">        &lt;/p&gt;</td></tr><tr><td class="line-number" value="5730"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5731"></td><td class="line-content">        &lt;!-- Tips de uso --&gt;</td></tr><tr><td class="line-number" value="5732"></td><td class="line-content">        &lt;p style="margin:10px 0 0; color:#64748b; font-size:12px;"&gt;</td></tr><tr><td class="line-number" value="5733"></td><td class="line-content">          &lt;b&gt;Tips:&lt;/b&gt; usa “Recentrar” para encuadrar todo el universo; el panel se actualiza si cambias el filtro del mapa.</td></tr><tr><td class="line-number" value="5734"></td><td class="line-content">        &lt;/p&gt;</td></tr><tr><td class="line-number" value="5735"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5736"></td><td class="line-content">    `;</td></tr><tr><td class="line-number" value="5737"></td><td class="line-content">    document.body.appendChild(panel);</td></tr><tr><td class="line-number" value="5738"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5739"></td><td class="line-content">    // cerrar</td></tr><tr><td class="line-number" value="5740"></td><td class="line-content">    panel.querySelector('#AT27_GT_help_close').onclick = ()=&gt;{ panel.style.display='none'; };</td></tr><tr><td class="line-number" value="5741"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5742"></td><td class="line-content">    // drag</td></tr><tr><td class="line-number" value="5743"></td><td class="line-content">    (function drag(panelEl, handleEl){</td></tr><tr><td class="line-number" value="5744"></td><td class="line-content">      let sx=0, sy=0, ox=0, oy=0, dragging=false;</td></tr><tr><td class="line-number" value="5745"></td><td class="line-content">      handleEl.addEventListener('mousedown', e=&gt;{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panelEl.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });</td></tr><tr><td class="line-number" value="5746"></td><td class="line-content">      window.addEventListener('mousemove', e=&gt;{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panelEl.style.left=(ox+dx)+'px'; panelEl.style.top=(oy+dy)+'px'; panelEl.style.right='auto'; });</td></tr><tr><td class="line-number" value="5747"></td><td class="line-content">      window.addEventListener('mouseup', ()=&gt;{ dragging=false; document.body.style.userSelect=''; clampToViewport(panelEl); });</td></tr><tr><td class="line-number" value="5748"></td><td class="line-content">    })(panel, panel.querySelector('#AT27_GT_help_hdr'));</td></tr><tr><td class="line-number" value="5749"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5750"></td><td class="line-content">    clampToViewport(panel);</td></tr><tr><td class="line-number" value="5751"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5752"></td><td class="line-content">    // Evita que el panel “tape” interacciones del mapa (propagación)</td></tr><tr><td class="line-number" value="5753"></td><td class="line-content">    if (window.L &amp;&amp; L.DomEvent){</td></tr><tr><td class="line-number" value="5754"></td><td class="line-content">      L.DomEvent.disableClickPropagation(panel);</td></tr><tr><td class="line-number" value="5755"></td><td class="line-content">      L.DomEvent.disableScrollPropagation(panel);</td></tr><tr><td class="line-number" value="5756"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="5757"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="5758"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5759"></td><td class="line-content">  function clampToViewport(el){</td></tr><tr><td class="line-number" value="5760"></td><td class="line-content">    const vw = window.innerWidth, vh = window.innerHeight;</td></tr><tr><td class="line-number" value="5761"></td><td class="line-content">    const r = el.getBoundingClientRect();</td></tr><tr><td class="line-number" value="5762"></td><td class="line-content">    let left = r.left, top = r.top;</td></tr><tr><td class="line-number" value="5763"></td><td class="line-content">    if (r.right  &gt; vw - 16) left -= (r.right  - (vw - 16));</td></tr><tr><td class="line-number" value="5764"></td><td class="line-content">    if (r.bottom &gt; vh - 16) top  -= (r.bottom - (vh - 16));</td></tr><tr><td class="line-number" value="5765"></td><td class="line-content">    if (left &lt; 16) left = 16;</td></tr><tr><td class="line-number" value="5766"></td><td class="line-content">    if (top  &lt; 16) top  = 16;</td></tr><tr><td class="line-number" value="5767"></td><td class="line-content">    el.style.left = left + 'px';</td></tr><tr><td class="line-number" value="5768"></td><td class="line-content">    el.style.top  = top  + 'px';</td></tr><tr><td class="line-number" value="5769"></td><td class="line-content">    el.style.right = 'auto';</td></tr><tr><td class="line-number" value="5770"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="5771"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5772"></td><td class="line-content">  // Cableado del botón de ayuda (por si tu id cambia, intentamos ambos)</td></tr><tr><td class="line-number" value="5773"></td><td class="line-content">  (function wireGT_Help(){</td></tr><tr><td class="line-number" value="5774"></td><td class="line-content">    const btn = document.getElementById('btn-ayuda') || document.getElementById('btn-gt-ayuda');</td></tr><tr><td class="line-number" value="5775"></td><td class="line-content">    if (!btn || btn.__wiredHelp) return;</td></tr><tr><td class="line-number" value="5776"></td><td class="line-content">    btn.addEventListener('click', AT27_GT_HELP_open);</td></tr><tr><td class="line-number" value="5777"></td><td class="line-content">    btn.__wiredHelp = true;</td></tr><tr><td class="line-number" value="5778"></td><td class="line-content">  })();</td></tr><tr><td class="line-number" value="5779"></td><td class="line-content"><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="5780"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5781"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="5782"></td><td class="line-content"><span class="html-tag">&lt;/body&gt;</span></td></tr><tr><td class="line-number" value="5783"></td><td class="line-content"><span class="html-tag">&lt;/html&gt;</span></td></tr><tr><td class="line-number" value="5784"></td><td class="line-content"><span class="html-end-of-file"></span></td></tr></tbody></table></body></html>