<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ganar Todo</title>
  <link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>
        html, body { margin:0; padding:0; height:100%; width:100%; font-family:'Segoe UI', Arial, sans-serif; background:#f4f4f4; }
        :root{ --sidebar-w:320px; }
        #panel-lateral{
          position:absolute;
          left:0; top:0; bottom:0; width:var(--sidebar-w); height:100%;
          background: linear-gradient(180deg, #8ea3ad 0%, #dfe6e9 100%);
          color:#2c3e50; border-right:1px solid #b2bec3;
          display:flex; flex-direction:column; 
          box-shadow:2px 0 5px rgba(0,0,0,0.1); box-sizing:border-box; align-items:stretch;
          z-index:2000;
        }
        #panel-header{ background:#b2bec3; color:#2c3e50; padding:12px 15px; display:flex; align-items:center; font-size:18px; font-weight:bold; }
        #panel-header img{ height:32px; margin-right:10px; }
        #map{ position:absolute; top:0; left:var(--sidebar-w); width:calc(100% - var(--sidebar-w)); height:100%; }

        #sec-search    { position: relative; }                /* contenedor del buscador */
        #sec-suggest   { z-index: 3000; } 
        #sec-suggest {
          position: absolute;
          left: 12px; right: 12px;
          top: 46px;           /* ajusta seg√∫n tu input */
          max-height: 220px;
          overflow: auto;
        }
          /* la lista queda clickeable */

    /* Etiqueta de la SECCI√ìN seleccionada (rosa tenue) */
    .sec-label{
      background: rgba(255, 235, 238, 0.96);  /* #ffebee */
      border: 1px solid #e91e63;
      color: #880e4f;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 700;
      pointer-events: none;
      white-space: nowrap;
      box-shadow: 0 2px 6px rgba(0,0,0,.15);
    }

    /* Etiquetas de SECCIONES ADYACENTES (azul/gris tenue) */
    .sec-label-adj{
      background: rgba(227, 242, 253, 0.94);  /* #e3f2fd */
      border: 1px solid #64b5f6;
      color: #0d47a1;
      padding: 1px 5px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 600;
      pointer-events: none;
      white-space: nowrap;
      box-shadow: 0 1px 4px rgba(0,0,0,.12);
    }


    /* Panel flotante secci√≥n */
    #sec-info {
      position: absolute;
      right: 16px; bottom: 16px;
      width: 320px; max-width: 38vw; min-width: 260px;
      background: #ffffff;
      border: 1px solid #cfd8dc;
      border-radius: 10px;
      box-shadow: 0 10px 24px rgba(0,0,0,.15);
      resize: both; overflow: auto; z-index: 4000;
      display: none;
      pointer-events: auto;
    }
    #sec-info .hdr {
      cursor: move;
      display:flex; align-items:center; justify-content:space-between;
      background: linear-gradient(180deg,#eceff1,#e3f2fd);
      padding: 8px 12px;
      border-bottom: 1px solid #cfd8dc;
      font-weight: 700; color: #263238;
    }

    #sec-info .hdr .btn-close{
      cursor: pointer;
      border: none; outline: none;
      background: #ffcdd2;         /* rosa tenue */
      color: #880e4f;
      width: 24px; height: 24px; line-height: 24px;
      border-radius: 6px;
      font-size: 16px; font-weight: 800;
    }
    #sec-info .hdr .btn-close:hover{ background:#ef9a9a; }
    #sec-info .body { padding: 10px 12px; color: #37474f; }
    #sec-info .row  { display:flex; justify-content:space-between; margin:6px 0; }
    #sec-info .k    { color:#607d8b; }
    #sec-info .v    { font-weight:600; }

    /* Toolbar b√°sica (igual look & feel) */
    .ttb{backdrop-filter: blur(6px); background: rgba(255,255,255,.92); border-radius:12px; 
        box-shadow: 0 8px 24px rgba(0,0,0,.12); border: 1px solid #e5e7eb;}
    .ttb-wrap{display:flex; align-items:center; gap:6px; padding:6px;}
    .ttb-btn{background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:6px 10px; cursor:pointer;}
    .ttb-btn:hover{background:#f8fafc}
    .ttb-btn[disabled]{opacity:.45; cursor:not-allowed;}
    .ttb-sep{width:1px; height:24px; background:#e5e7eb; margin:0 4px;}
    .ttb-help{background:#eef2ff; border-color:#c7d2fe}

    .leaflet-tooltip.at27-tt{
      background: rgba(255,255,255,.95);
      color:#111; border:1px solid #e5e7eb;
      border-radius:8px; padding:6px 8px;
      box-shadow:0 6px 18px rgba(0,0,0,.12);
    }

    .leaflet-tooltip.at27-tt{
      background: rgba(255,255,255,.95);
      color:#111; border:1px solid #e5e7eb;
      border-radius:8px; padding:6px 8px;
      box-shadow:0 6px 18px rgba(0,0,0,.12);
    }



 
  </style>
</head>
<body>

  
    <!-- Barra superior -->
    <div id="top-toolbar" class="ttb" style="position:absolute; top:12px; right:10px; z-index:5200;">
      <div class="ttb-wrap">
        <button id="btn-gt-part" class="ttb-btn" title="Participaci√≥n 21/24/27*" type="button">
          <span class="ico">üó≥Ô∏è</span><span class="txt">Part. 21/24/27*</span>
        </button>

        <button id="btn-estabilidad" class="ttb-btn" title="Estabilidad 2018‚Äì2024" type="button">
          <span class="ico">üß≠</span><span class="txt">Estabilidad 18‚Äì24</span>
        </button>

        <button id="btn-gt-metas" class="ttb-btn" title="Metas de participaci√≥n 2027*" type="button">
          <span class="ico">üéØ</span><span class="txt">Meta 2027*</span>
        </button>

        <button id="btn-gt-ganar" class="ttb-btn" title="¬øQu√© se requiere para ganar todo?" type="button">
          <span class="ico">üèÜ</span><span class="txt">Ganar todo</span>
        </button>

        <button id="btn-recentrar" class="ttb-btn" title="Recentrar universo (R)" type="button">
          Recentrar
        </button>





        <div class="ttb-sep"></div>

        <button id="btn-ayuda" class="ttb-btn ttb-help" title="Ayuda (?)" type="button">
          <span class="ico">‚ùì</span><span class="txt">Ayuda</span>
        </button>
      </div>
    </div>

  <div id="panel-lateral">
    <div id="panel-header">
      <!-- <img src="assets/img/logo.png" alt="Logo"/> -->
      <span>Ganar Todo</span>
    </div>
    <!-- Aqu√≠ va el contenido del panel lateral -->

    <!-- Buscador de secciones -->
    <div id="sec-search" style="padding:10px 12px; border-top:1px solid #cbd5e1; background:#eef2f7">
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="sec-q" type="text" placeholder="Buscar secci√≥n (ej. 1234 o '1234 Le√≥n')" autocomplete="off" autocorrect="off" spellcheck="false" enterkeyhint="search"
              style="flex:1; padding:6px 8px; border:1px solid #94a3b8; border-radius:6px;">
        <label style="white-space:nowrap; font-size:12px;">
          <input id="sec-global" type="checkbox"> Todo el estado
        </label>
      </div>
      <ul id="sec-suggest" style="margin:8px 0 0 0; padding:0; list-style:none; max-height:180px; overflow:auto;
                                  border:1px solid #cbd5e1; border-radius:6px; background:#fff; display:none;"></ul>
    </div>




    <!-- Panel flotante de info de secci√≥n -->

    <div id="mini-universe" style="padding:12px 12px 6px 12px; background:#eef2f7; border-top:1px solid #cbd5e1">
        <div class="row" style="margin-bottom:8px">
            <label><input type="checkbox" id="mini-all-state"> Estado completo</label>
        </div>
        <div class="row" style="margin-bottom:8px">
            <label>Municipio</label>
            <select id="mini-sel-mun" style="width:100%;padding:6px"><option value="">‚Äî Ninguno ‚Äî</option></select>
        </div>
        <div class="row" style="margin-bottom:8px">
            <label>Distrito Federal</label>
            <select id="mini-sel-df" style="width:100%;padding:6px"><option value="">‚Äî Ninguno ‚Äî</option></select>
        </div>
        <div class="row" style="margin-bottom:8px">
            <label>Distrito Local</label>
            <select id="mini-sel-dl" style="width:100%;padding:6px"><option value="">‚Äî Ninguno ‚Äî</option></select>
        </div>
        <div class="hint" style="font-size:12px;color:#64748b">Elige solo uno. Al cambiar, el mapa se actualiza.</div>
    </div>

  </div>

  <div id="gt-consultas" style="padding:12px; border-top:1px solid #cbd5e1; background:#f8fafc">
    <div style="font-weight:700; margin-bottom:8px;">Ganar Todo ¬∑ Consultas</div>
    <button id="btn-gt-part" style="width:100%; padding:8px; border:1px solid #cbd5e1; border-radius:8px; background:#fff; cursor:pointer;">
      üó≥Ô∏è Participaci√≥n 21/24/27*
    </button>
  </div>


  <div id="map"></div>

  <!-- === SCRIPT √öNICO === -->
  <script>
  // ===== 0) Campos (ajusta si tus nombres son distintos) =====
  // DL = Distrito Local, DF = Distrito Federal
    const FIELD_KEYS = { mun: 'MUNICIPIO', dl: 'DISTRITO_L', df: 'DISTRITO_F' };

    const paths = JSON.parse(localStorage.getItem('AT_PATHS')||'{}');
    const urlGeo = paths.geo || 'data/geo/secciones.geojson';
    const catUrl = paths.catalog || 'data/catalogo_territorial.json';
    const ELP = paths.electoral?.P || 'data/electoral/P.json';
  // ...


  // Adapter: usa tus JSON electorales del propio archivo
  window.loadPuesto = window.loadPuesto || getElectData;


  // ===== 1) Mapa √∫nico y chequeo =====
  function ensureLeafletMap() {
    if (window.__AT_MAP && window.__AT_MAP instanceof L.Map) return window.__AT_MAP;
    const m = L.map('map', { zoomControl:true }).setView([21.0, -101.3], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'¬© OSM' }).addTo(m);
    window.__AT_MAP = m;
    return m;
  }
  function assertIsLeafletMap(m) {
    if (!(m instanceof L.Map) || typeof m.addLayer !== 'function') {
      throw new Error('[AT] addTo(): destino no es un Leaflet Map. Revisa variables llamadas "map" o dobles inicializaciones.');
    }
  }

  function closeSecInfoPanel(){
    const box = document.getElementById('sec-info');
    if (box) box.style.display = 'none';
    // Si quieres limpiar resaltado y etiquetas al cerrar:
    if (typeof clearSectionOverlays === 'function') clearSectionOverlays();
  }


  function ensureSecInfoPanelWired(){
  const box = document.getElementById('sec-info');
  const hdr = box?.querySelector('.hdr');
  if (!box || !hdr || box.__wired) return;

  // Bloquear propagaci√≥n al mapa (no ‚Äúparpadea‚Äù al arrastrar)
  if (window.L && L.DomEvent){
    L.DomEvent.disableClickPropagation(box);
    L.DomEvent.disableScrollPropagation(box);
  }

  // Drag del panel
  let dragging = false, sx=0, sy=0, bx=0, by=0;
  hdr.addEventListener('mousedown', (e)=>{
    if (e.target.closest('.btn-close')) return; // no iniciar drag si clic en "√ó"
    e.preventDefault(); e.stopPropagation();
    dragging = true;
    const r = box.getBoundingClientRect();
    sx = e.clientX; sy = e.clientY; bx = r.left; by = r.top;
    box.style.position = 'absolute'; box.style.right='auto'; box.style.bottom='auto';
    document.body.style.userSelect = 'none';
  });
  window.addEventListener('mousemove', (e)=>{
    if (!dragging) return;
    e.preventDefault(); e.stopPropagation();
    const dx = e.clientX - sx, dy = e.clientY - sy;
    box.style.left = (bx + dx) + 'px';
    box.style.top  = (by + dy) + 'px';
  });
  window.addEventListener('mouseup', ()=>{
    if (!dragging) return;
    dragging = false; document.body.style.userSelect = '';
  });

  // Bot√≥n ‚Äú√ó‚Äù
  const btn = document.getElementById('sec-close');
  if (btn && !btn.__wired){
    btn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); closeSecInfoPanel(); });
    btn.__wired = true;
  }

  box.__wired = true;
}



  // ===== 2) Filtrado por universo =====
  function toComp(v){ if(v==null) return ''; const s=String(v).trim(); return (isFinite(s) && s!=='') ? Number(s) : s.toUpperCase(); }
  function matches(props, u){
    if(u.scope==='ALL') return true;
    const keyField = u.scope==='MUN' ? FIELD_KEYS.mun : (u.scope==='DL' ? FIELD_KEYS.dl : FIELD_KEYS.df);
    return toComp(props?.[keyField]) === toComp(u.key);
  }
  function filterGeojson(geojson, u){
    if(u.scope==='ALL') return geojson;
    const features = (geojson.features || []).filter(f => matches(f.properties, u));
    return { ...geojson, features };
  }


  // ====== CARGA ELECTORAL (para obtener 24DL_LN) ======
  function getPaths(){ try{ return JSON.parse(localStorage.getItem('AT_PATHS')||'{}'); }catch{ return {}; } }
  function getPuestoPath(p){ const paths = getPaths(); return paths?.electoral?.[p] || `data/electoral/${p}.json`; }

  window.AT_ELECT = window.AT_ELECT || {};
  async function getElectData(puesto){
    if (window.AT_ELECT[puesto]) return window.AT_ELECT[puesto];
    const res = await fetch(getPuestoPath(puesto));
    if (!res.ok) throw new Error(`HTTP ${res.status} en ${puesto}`);
    const js = await res.json();
    window.AT_ELECT[puesto] = js;
    return js;
  }
  // LN para 2024 desde DL; si no hay, intenta P (fallback)
  async function getLN24DL(sec){
    const key = String(sec);
    try {
      const dl = await getElectData('DL');
      const ln = dl?.secciones?.[key]?.["2024"]?.LN;
      if (typeof ln === 'number') return ln;
    } catch(_){}
    try {
      const p = await getElectData('P');
      const ln = p?.secciones?.[key]?.["2024"]?.LN;
      if (typeof ln === 'number') return ln;
    } catch(_){}
    return null;
  }

  // ====== ADYACENCIAS (Turf) ======
  function bboxIntersects(b1, b2){
    return !(b2[0] > b1[2] || b2[2] < b1[0] || b2[1] > b1[3] || b2[3] < b1[1]);
  }
  function getAdjacents(feat){
    const all = (window.AT_DATA?.features)
            || (window.AT_CTX?.layer?.toGeoJSON?.()?.features)
            || [];
    if (!all.length) return [];
    const b1 = turf.bbox(feat);
    const out = [];
    const sec1 = feat.properties?.SECCION;
    for (const f of all){
      const p = f.properties || {};
      if (p.SECCION === sec1) continue;
      const b2 = turf.bbox(f);
      if (!bboxIntersects(b1,b2)) continue;
      try {
        if (turf.booleanTouches(feat, f) || turf.booleanOverlap(feat, f) || turf.booleanIntersects(feat, f)){
          out.push(f);
        }
      } catch(_){}
    }
    return out.slice(0, 25); // cota de seguridad
  }

  // ====== LABELS SOBRE EL MAPA ======
  function addLabelForFeature(feat, className, text){
    try {
      const c = turf.centerOfMass(feat).geometry.coordinates; // [lon, lat]
      const m = L.marker([c[1], c[0]], { icon: L.divIcon({ className, html: text, iconSize:[0,0] }) });
      window.__SEC_LABELS = window.__SEC_LABELS || L.layerGroup().addTo(ensureLeafletMap());
      window.__SEC_LABELS.addLayer(m);
      return m;
    } catch(_){}
    return null;
  }

  function clearSectionOverlays(){
    const atMap = ensureLeafletMap();
    if (window.__SEC_HL){ try{ atMap.removeLayer(__SEC_HL); }catch(_){ } window.__SEC_HL = null; }
    if (window.__SEC_ADJ){ try{ atMap.removeLayer(__SEC_ADJ); }catch(_){ } window.__SEC_ADJ = null; }
    if (window.__SEC_LABELS){ try{ atMap.removeLayer(__SEC_LABELS); }catch(_){ } window.__SEC_LABELS = null; }
  }

  // Dibuja selecci√≥n + adyacentes + labels
  function paintSelectionAndAdj(feat){
    const atMap = ensureLeafletMap();
    clearSectionOverlays();

    // resaltado principal
    window.__SEC_HL = L.geoJSON(feat, { style:{ color:'#e91e63', weight:3, fillOpacity:0.25 } }).addTo(atMap);
    try { atMap.fitBounds(window.__SEC_HL.getBounds(), { padding:[28,28] }); } catch(_){}

    // adyacentes
    const adj = getAdjacents(feat);
    if (adj.length){
      window.__SEC_ADJ = L.geoJSON({type:'FeatureCollection', features:adj}, { style:{ color:'#90a4ae', weight:1.2, dashArray:'4,4', fillOpacity:0.05 } }).addTo(atMap);
    }

    // labels
    const sec = feat.properties?.SECCION ?? '‚Äî';
    addLabelForFeature(feat, 'sec-label', `Secci√≥n ${sec}`);
    for (const f of adj){
      const s2 = f.properties?.SECCION ?? '‚Äî';
      addLabelForFeature(f, 'sec-label-adj', s2);
    }
  }

  // ====== PANEL FLOTANTE (drag + datos) ======
  (function wireSecInfoPanel(){
    const box = document.getElementById('sec-info');
    const hdr = box?.querySelector('.hdr');
    if (!box || !hdr || box.__wired) return;
    let dragging = false, sx=0, sy=0, bx=0, by=0;
    hdr.addEventListener('mousedown', (e)=>{
      dragging=true; sx=e.clientX; sy=e.clientY;
      const r = box.getBoundingClientRect(); bx=r.left; by=r.top;
      document.body.style.userSelect='none';
    });
    window.addEventListener('mousemove', (e)=>{
      if (!dragging) return;
      const dx = e.clientX - sx, dy = e.clientY - sy;
      box.style.left = (bx + dx) + 'px';
      box.style.top  = (by + dy) + 'px';
      box.style.right = 'auto'; box.style.bottom='auto';
      box.style.position = 'absolute';
    });
    window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; });
    box.__wired = true;
  })();

  async function showSectionInfo(feat){
    ensureSecInfoPanelWired();
    const p = feat.properties || {};
    const sec = p.SECCION ?? '‚Äî';
    const df  = p[FIELD_KEYS.df] ?? '‚Äî';
    const dl  = p[FIELD_KEYS.dl] ?? '‚Äî';

    // LN 24DL_LN
    let ln = await getLN24DL(sec);
    if (ln==null) ln = '‚Äî';

    // Pintar
    const box = document.getElementById('sec-info');
    box.querySelector('.hdr').textContent = `Secci√≥n ${sec}`;
    document.getElementById('si-sec').textContent = sec;
    document.getElementById('si-df').textContent  = df;
    document.getElementById('si-dl').textContent  = dl;
    document.getElementById('si-ln').textContent  = ln;
    box.style.display = 'block';
  }



  // ENTER + CLIC + ULTIMO TOKEN

    function currentNeedle(q){
      if (!q) return '';
      const parts = String(q).split(/[,;\s]+/).filter(Boolean);
      return parts.length ? parts[parts.length-1] : '';
    }

// ===== Mini-selector de universo dentro del m√≥dulo =====
    let __mini = { selMun:null, selDf:null, selDl:null, all:null };

    function uniqueSorted(values){
    const arr = values.map(v => String(v ?? '').trim()).filter(Boolean);
    const set = Array.from(new Set(arr));
    return set.sort((a,b) => (isFinite(a)&&isFinite(b)) ? Number(a)-Number(b) : a.localeCompare(b,'es'));
    }
    function buildMiniOptions(raw){
    const feats = raw.features || [];
    const grab = k => uniqueSorted(feats.map(f => f.properties?.[k]));
    return { mun: grab(FIELD_KEYS.mun), df: grab(FIELD_KEYS.df), dl: grab(FIELD_KEYS.dl) };
    }
    function fillSelect(sel, arr){
    sel.innerHTML = '<option value="">‚Äî Ninguno ‚Äî</option>' + arr.map(v=>`<option value="${v}">${v}</option>`).join('');
    }
    function getMiniUniverse(){
    const { selMun, selDf, selDl, all } = __mini;
    if(all.checked) return { scope:'ALL', key:null, label:'Estado completo' };
    if(selMun.value) return { scope:'MUN', key: selMun.value, label:`Municipio ${selMun.options[selMun.selectedIndex].text}` };
    if(selDf.value)  return { scope:'DF',  key: selDf.value,  label:`Distrito Federal ${selDf.value}` };
    if(selDl.value)  return { scope:'DL',  key: selDl.value,  label:`Distrito Local ${selDl.value}` };
    return null;
    }
    function miniExclusivity(which){
    const { selMun, selDf, selDl, all } = __mini;
    if(which==='ALL'){ selMun.value=''; selDf.value=''; selDl.value=''; }
    if(which==='MUN'){ selDf.value=''; selDl.value=''; all.checked=false; }
    if(which==='DF'){  selMun.value=''; selDl.value=''; all.checked=false; }
    if(which==='DL'){  selMun.value=''; selDf.value=''; all.checked=false; }
    applyMiniUniverse();
    }
    function applyMiniUniverse(){
    const u2 = getMiniUniverse();
    if(!u2) return;
    // 1) Persistir
    localStorage.setItem('AT_UNIVERSE', JSON.stringify({ ...u2, ts:Date.now() }));
    // 2) Redibujar con el nuevo universo usando el raw ya cargado
    const atMap = ensureLeafletMap();
    const filtered2 = filterGeojson(window.AT_DATA, u2);
    if (window.AT_CTX?.layer) { atMap.removeLayer(AT_CTX.layer); }
    const layer2 = L.geoJSON(filtered2, { style:{ color:'#7d0025', weight:1.2, fillOpacity:0.15 } }).addTo(atMap);
    try { atMap.fitBounds(layer2.getBounds(), { padding:[20,20] }); } catch(e){}
    window.AT_CTX = { ...(window.AT_CTX||{}), universe: u2, layer: layer2 };
    // 3) Header
    const hdr = document.querySelector('#panel-header span');
    if(hdr){ hdr.textContent = `An√°lisis Territorial ¬∑ ${u2.label}`; }
      refreshSectionSearch(u2);
    }
    function initMiniSelector(raw, u){
    // Guardar el geojson bruto para futuros re-filtros
    window.AT_DATA = raw;

    __mini.selMun = document.getElementById('mini-sel-mun');
    labelMunicipiosFromCatalog('#mini-sel-mun');

    __mini.selDf  = document.getElementById('mini-sel-df');
    __mini.selDl  = document.getElementById('mini-sel-dl');
    __mini.all    = document.getElementById('mini-all-state');

    const opt = buildMiniOptions(raw);
    fillSelect(__mini.selMun, opt.mun);
    fillSelect(__mini.selDf,  opt.df);
    fillSelect(__mini.selDl,  opt.dl);

    // Reflejar el universo actual
    if(u.scope==='ALL'){ __mini.all.checked = true; }
    if(u.scope==='MUN'){ __mini.selMun.value = String(u.key); }
    if(u.scope==='DF'){  __mini.selDf.value  = String(u.key); }
    if(u.scope==='DL'){  __mini.selDl.value  = String(u.key); }


    
        async function labelMunicipiosFromCatalog(selectId){
        const sel = document.querySelector(selectId);
        if (!sel) return;

        // 1) Ruta del cat√°logo desde el Portal (AT_PATHS) o fallback
        let catUrl = 'data/catalogo_territorial.json';
        try {
            const paths = JSON.parse(localStorage.getItem('AT_PATHS') || '{}');
            if (paths?.catalog) catUrl = paths.catalog;
        } catch {}

        // 2) Cargar cat√°logo
        let cat = null;
        try {
            const r = await fetch(catUrl);
            if (!r.ok) throw new Error('HTTP '+r.status);
            cat = await r.json();
        } catch (e) {
            console.warn('[AT] No se pudo cargar el cat√°logo:', e);
            return; // salimos sin tocar etiquetas
        }

        const mapa = cat?.municipios || {};
        // helper: si el cat√°logo trae ceros a la izquierda en las llaves
        const getName = (code) => {
            const s = String(code);
            return mapa[s] || mapa[s.padStart(2,'0')] || mapa[s.padStart(3,'0')] || s;
        };

        // 3) Reetiquetar opciones (sin cambiar value)
        for (const opt of sel.options) {
            if (!opt.value) continue; // deja "‚Äî Ninguno ‚Äî"
            const name = getName(opt.value);
            opt.text = `${opt.value} ‚Äî ${name}`;
        }
        }

   

    // Eventos (auto-ejecuta)
    __mini.selMun.addEventListener('change', ()=> miniExclusivity('MUN'));
    __mini.selDf .addEventListener('change', ()=> miniExclusivity('DF'));
    __mini.selDl .addEventListener('change', ()=> miniExclusivity('DL'));
    __mini.all   .addEventListener('change', ()=> miniExclusivity('ALL'));
    }


    // Nombre fijo del campo (texto) del municipio
    const MUN_NAME_KEY = 'MUNICIPIO';

    // Detecta autom√°ticamente el campo de C√ìDIGO de municipio (si no, usa el nombre)
    function detectMunCodeKey(raw){
    const feats = raw.features || [];
    const candidates = ['MUN','CVE_MUN','CLV_MUN','ID_MUN','MUNICIPIO_ID','MUNICIPIO_CVE','CVE_MUNICIPIO','CVE_MPIO'];
    for (const k of candidates) {
        const ok = feats.some(f => {
        const v = f.properties?.[k];
        return v != null && String(v).trim() !== '' && String(v).toUpperCase() !== 'NULL';
        });
        if (ok) return k;
    }
    return null; // fallback ser√° MUN_NAME_KEY
    }



      // ‚Äî‚Äî Utils de texto ‚Äî‚Äî
      function _norm(s){
        if (s==null) return '';
        return String(s).normalize('NFD').replace(/[\u0300-\u036f]/g,'').toUpperCase().trim();
      }
      function _isDigits(s){ return /^[0-9]+$/.test(String(s||'')); }

      // ‚Äî‚Äî Nombre de municipio desde cat√°logo (si existe) ‚Äî‚Äî
      function getMunNameFromCatalog(code){
        const cat = window.AT_CATALOG;
        if (!cat?.municipios) return String(code ?? '');
        const s = String(code);
        // maneja posibles ceros a la izquierda
        return cat.municipios[s] || cat.municipios[s.padStart(2,'0')] || cat.municipios[s.padStart(3,'0')] || s;
      }

      // ‚Äî‚Äî √çndice de secciones ‚Äî‚Äî
      let __SEC_INDEX = { items: [], global: false };

      function buildSectionIndex(raw, universe, useGlobal){
        const feats = (raw?.features || []);
        const munKey = (window.AT_KEYS?.munCode) || FIELD_KEYS.mun;
        const items = [];

        // dataset base: global = todas, local = filtradas por universo
        const base = useGlobal ? feats : (filterGeojson(raw, universe).features || []);

        for(const f of base){
          const p = f.properties || {};
          const sec = p.SECCION ?? p.Seccion ?? p.seccion ?? null;
          if (sec == null) continue;

          const munCode = p[munKey];
          const munName = getMunNameFromCatalog(munCode);
          const df = p[FIELD_KEYS.df];
          const dl = p[FIELD_KEYS.dl];

          // texto para b√∫squeda
          const text = `${sec} ${munCode ?? ''} ${munName ?? ''} ${df ?? ''} ${dl ?? ''}`;
          // bounds (si multiparte, Leaflet lo resuelve)
          let bounds = null;
          try { bounds = L.geoJSON(f).getBounds(); } catch(_){}

          items.push({
            sec: String(sec).trim(),
            munCode: munCode,
            munName: munName,
            df, dl, feature: f, textNorm: _norm(text), bounds
          });
        }

        __SEC_INDEX = { items, global: !!useGlobal };
      }

      function searchSections(query, limit=15){
        const q = _norm(query);
        if (!q) return [];
        const ds = __SEC_INDEX.items;

        // Heur√≠stica sencilla:
        // - si es num√©rico puro: prioridad a SECCION que empiece con q
        // - si no: contiene tokens
        if (_isDigits(q)){
          const starts = ds.filter(it => _norm(it.sec).startsWith(q));
          if (starts.length >= limit) return starts.slice(0, limit);
          const contains = ds.filter(it => _norm(it.sec).includes(q));
          return [...starts, ...contains].slice(0, limit);
        } else {
          const tokens = q.split(/\s+/).filter(Boolean);
          return ds.filter(it => tokens.every(t => it.textNorm.includes(t))).slice(0, limit);
        }
      }

      // ‚Äî‚Äî UI de sugerencias ‚Äî‚Äî
      let __SEC_HIGHLIGHT = null;

      function renderSecSuggestions(list){
        const ul = document.getElementById('sec-suggest');
        if (!ul) return;
        if (!list.length){ ul.style.display='none'; ul.innerHTML=''; return; }

        ul.innerHTML = list.map(it => {
          const label = `${it.sec} ‚Äî ${it.munName || it.munCode || ''}`.replace(/\s+-\s+$/, '');
          const meta  = [];
          if (it.dl!=null) meta.push(`DL ${it.dl}`);
          if (it.df!=null) meta.push(`DF ${it.df}`);
          const sub = meta.length ? `<small style="color:#64748b">${meta.join(' ¬∑ ')}</small>` : '';
          return `<li data-sec="${it.sec}" style="padding:6px 8px; border-bottom:1px solid #e5e7eb; cursor:pointer">
                    <div>${label}</div>${sub}
                  </li>`;
        }).join('');
        ul.style.display = 'block';


      }

    function gotoSection(item){
      const atMap = (window.AT_CTX?.map) || ensureLeafletMap();

      // 1) Resolver el feature de la secci√≥n
      const sec = String(item.sec ?? item.SECCION ?? '');
      let feat = item.feature;

      if (!feat) {
        const feats =
          (window.AT_CTX?.layer?.toGeoJSON?.().features) ||
          (window.AT_DATA?.features) || [];
        feat = feats.find(f => String(f.properties?.SECCION) === sec);
      }

      if (!feat) {
        console.warn('[AT] No encontr√© el feature para la secci√≥n', sec, item);
        return;
      }

      // 2) Pintar selecci√≥n + adyacentes + labels (esto limpia overlays previos)
      paintSelectionAndAdj(feat);

      // 3) Mostrar panel con DF, DL y LN (24DL_LN)
      showSectionInfo(feat);

      // 4) Feedback visual (parpadeo leve sobre el highlight actual)
      const hl = window.__SEC_HL;
      if (hl && typeof hl.setStyle === 'function') {
        try {
          hl.setStyle({ weight: 4 });
          setTimeout(() => { try { hl.setStyle({ weight: 3 }); } catch(_){} }, 220);
        } catch(_){}
      }

      // 5) Oculta la lista de sugerencias (si est√° visible)
      const ul = document.getElementById('sec-suggest');
      if (ul) ul.style.display = 'none';
    }


      // Delegaci√≥n de clic en las sugerencias (una sola vez)
    (function wireSectionSearchEventsOnce(){
      const ul = document.getElementById('sec-suggest');
      const input = document.getElementById('sec-q');
      if (!ul || !input) return;

       // Si est√° dentro de un form, evita submit al Enter
      const form = input.closest('form');
      form?.addEventListener('submit', e => e.preventDefault());

      // Clic en cualquier <li data-sec="...">
      if (!ul.__wiredClick){
        ul.addEventListener('click', (ev)=>{
          const li = ev.target.closest('li[data-sec]');
          if (!li) return;
          const sec = li.getAttribute('data-sec');
          const item = (__SEC_INDEX?.items||[]).find(x => String(x.sec) === String(sec));
          if (item) gotoSection(item);
          ul.style.display = 'none';
        });
        ul.__wiredClick = true;
      }

      // Enter en el input = ir al primer resultado
      if (!input.__wiredKey){
        input.addEventListener('keydown', (ev)=>{
          if (ev.key === 'Enter'){
            ev.preventDefault(); // <- evita submit/autocomplete
            const results = searchSections(input.value, 1);
        const needle = currentNeedle(input.value);
        const [first] = searchSections(needle, 1);
        if (first) gotoSection(first);
        ul.style.display = 'none';
       }
          if (ev.key === 'Escape'){
            ul.style.display = 'none';
          }
        });
        input.__wiredKey = true;
      }

      // Input: recalcula sugerencias usando el "√∫ltimo token"
      if (!input.__wiredInput){
        input.addEventListener('input', ()=>{
          const needle = currentNeedle(input.value);
          renderSecSuggestions(searchSections(needle, 15));
        });
        input.__wiredInput = true;
      }
    })();


      // ‚Äî‚Äî Inicializar Buscador en el m√≥dulo ‚Äî‚Äî
      function initSectionSearch(raw, universe){
        const input   = document.getElementById('sec-q');
        const list    = document.getElementById('sec-suggest');
        const globalC = document.getElementById('sec-global');
        if (!input || !list) return;

        // construir √≠ndice (por universo actual)
        buildSectionIndex(raw, universe, !!globalC?.checked);



        // Cambiar √°mbito (global / universo actual)
        globalC?.addEventListener('change', () => {
          buildSectionIndex(raw, universe, !!globalC.checked);
          // refresca sugerencias con la query actual
          if (input.value){
            renderSecSuggestions(searchSections(input.value, 15));
          }
        });
      }

      // ‚Äî‚Äî Cuando cambies de universo con tu mini-selector, reindexa ‚Äî‚Äî
      function refreshSectionSearch(universe){
        const input   = document.getElementById('sec-q');
        const globalC = document.getElementById('sec-global');
        if (!window.AT_DATA || !input) return;
        buildSectionIndex(window.AT_DATA, universe, !!globalC?.checked);
        if (input.value){
          renderSecSuggestions(searchSections(input.value, 15));
        }
      }


      function getRawForIndex(){
        // Usa el dataset completo si ya lo cacheaste
        if (window.AT_DATA) return window.AT_DATA;
        // Si no, al menos usa lo ya pintado en el mapa
        const lyr = window.AT_CTX?.layer;
        return (lyr && typeof lyr.toGeoJSON === 'function') ? lyr.toGeoJSON() : null;
  }


  // ===== 3) Boot =====
  document.addEventListener('DOMContentLoaded', async () => {
    // a) Leer universo y rutas puestos en el PORTAL
    const u     = JSON.parse(localStorage.getItem('AT_UNIVERSE') || 'null');
    const paths = JSON.parse(localStorage.getItem('AT_PATHS') || '{"geo":""}');
    if (!u) {
      const hdr = document.querySelector('#panel-header span');
      hdr && (hdr.textContent += ' ¬∑ selecciona el universo en el Portal');
      setTimeout(()=>{ location.href = 'portal.html'; }, 600);
      return;
    }

    // b) Etiqueta del universo
    const hdr = document.querySelector('#panel-header span');
    hdr && (hdr.textContent += ` ¬∑ ${u.label}`);

    // c) Mapa √∫nico
    const atMap = ensureLeafletMap();
    assertIsLeafletMap(atMap);

    // d) Cargar y filtrar GeoJSON
    const url = paths.geo || 'data/geo/secciones.geojson'; // <-- ajusta si tu ruta difiere

    // Cargar cat√°logo territorial (para nombres visibles)
    const catUrl = (paths.catalog && paths.catalog.trim()) || '/data/catalogo_territorial.json';
    let catalog = window.AT_CATALOG || null;
    if (!catalog) {
    try {
        const rc = await fetch(catUrl);
        if (!rc.ok) throw new Error(`HTTP ${rc.status} al cargar cat√°logo ${catUrl}`);
        catalog = await rc.json();
        window.AT_CATALOG = catalog;
    } catch (err) {
        console.warn('[AT] No se pudo cargar el cat√°logo de nombres:', err);
        window.AT_CATALOG = catalog = null; // seguimos sin nombres amigables
    }
    }


 let raw = window.AT_DATA || null; // usa cach√© si ya existe
if (!raw) {
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status} al cargar ${url}`);
    raw = await res.json();       // ‚úÖ solo una vez
    window.AT_DATA = raw;         // ‚úÖ guarda en cach√© aqu√≠
  } catch (err) {
    console.error('[AT] Error cargando GeoJSON:', err);
    alert('No se pudo cargar el GeoJSON');
    return;
  }
}
// a partir de aqu√≠, usa 'raw'

    const filtered = filterGeojson(raw, u);
    console.log('[AT] Universo:', u, 'Total:', raw.features?.length||0, 'Filtradas:', filtered.features?.length||0);

    if(!filtered.features || filtered.features.length===0){
      console.warn('[AT] No hay geometr√≠as para el universo seleccionado:', u);
      alert('No hay datos para el universo seleccionado');
    }

    // Nombre fijo del campo (texto) del municipio
        const MUN_NAME_KEY = 'MUNICIPIO';

    // Detecta campo de C√ìDIGO (si existe); si no, usa el de nombre
        function detectMunCodeKey(raw){
        const feats = raw.features || [];
        const candidates = ['MUN','CVE_MUN','CLV_MUN','ID_MUN','MUNICIPIO_ID','MUNICIPIO_CVE','CVE_MUNICIPIO','CVE_MPIO'];
        for (const k of candidates) {
            if (feats.some(f => (f.properties?.[k] ?? '') !== '')) return k;
        }
        return null;
        }

        const munCodeKey = detectMunCodeKey(raw) || MUN_NAME_KEY; // fallback: nombre
        FIELD_KEYS.mun = munCodeKey;
        window.AT_KEYS = { munCode: munCodeKey, munName: MUN_NAME_KEY };


    // e) Dibujar capa
        const layer = L.geoJSON(filtered, {
      style: { color:'#000000', weight:1.2, fillOpacity:0.15 },
      onEachFeature: (feat, lyr) => {
        const p = feat.properties || {};
        const muni = p[FIELD_KEYS.mun] ?? '‚Äî';
        const dl   = p[FIELD_KEYS.dl]  ?? '‚Äî';
        const df   = p[FIELD_KEYS.df]  ?? '‚Äî';
        lyr.bindPopup(`<b>Secci√≥n</b>: ${p.SECCION ?? '‚Äî'}<br><b>Mun</b>: ${muni}<br><b>DL</b>: ${dl}<br><b>DF</b>: ${df}`);
        lyr.on('mouseover', () => lyr.setStyle({weight:2}));
        lyr.on('mouseout',  () => lyr.setStyle({weight:1.2}));
      }
    }).addTo(atMap);

    try { atMap.fitBounds(layer.getBounds(), { padding:[20,20] }); } catch(e){}
    window.AT_CTX = { universe: u, paths, map: atMap, layer };

    function getMunNameFromCatalog(code){
      const cat = window.AT_CATALOG;
      if (!cat?.municipios) return String(code ?? '');
      return cat.municipios[String(code)] || String(code ?? '');
    }
    function getDfListFromCatalog(feats){
      return (window.AT_CATALOG?.distritos_federales && window.AT_CATALOG.distritos_federales.length)
        ? window.AT_CATALOG.distritos_federales
        : uniqSorted(feats.map(f => f.properties?.[FIELD_KEYS.df]));
    }
    function getDlListFromCatalog(feats){
      return (window.AT_CATALOG?.distritos_locales && window.AT_CATALOG.distritos_locales.length)
        ? window.AT_CATALOG.distritos_locales
        : uniqSorted(feats.map(f => f.properties?.[FIELD_KEYS.dl]));
    }
        initMiniSelector(raw, u);
        initSectionSearch(window.AT_DATA || raw, u);  

  });

    document.getElementById('btn-gt-part')?.addEventListener('click', () => {
      AT27_GT_PART_ejecutar('A','2024');
    });


  (function wireATHotkeys(){
      if (window.__AT_HOTKEYS) return;
      window.__AT_HOTKEYS = true;

      window.addEventListener('keydown', (e)=>{
        // Esc: cerrar panel
        if (e.key === 'Escape'){
          if (document.getElementById('sec-info')?.style.display !== 'none'){
            e.preventDefault();
            closeSecInfoPanel();
          }
        }
        // Ctrl+K (o Cmd+K en Mac): enfocar buscador de secciones
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k'){
          e.preventDefault();
          document.getElementById('sec-q')?.focus();
        }
      });
    })();


  </script>
  <div id="sec-info">
    <div class="hdr">
    <span class="ttl">Secci√≥n</span>
    <button id="sec-close" class="btn-close" aria-label="Cerrar">√ó</button>
  </div>
  <div class="body">
    <div class="row"><span class="k">Secci√≥n</span>        <span class="v" id="si-sec">‚Äî</span></div>
    <div class="row"><span class="k">Distrito Federal</span><span class="v" id="si-df">‚Äî</span></div>
    <div class="row"><span class="k">Distrito Local</span>  <span class="v" id="si-dl">‚Äî</span></div>
    <div class="row"><span class="k">LN (2024)</span>    <span class="v" id="si-ln">‚Äî</span></div>
  </div>
</div>

<script>
  /* ========== MOD: GANAR TODO ¬∑ PARTICIPACI√ìN (AT27_GT_PART_) ========== */
    const AT27_GT_PART_PUESTOS = { A:'Ayuntamiento', DL:'Diputado Local', DF:'Diputado Federal', G:'Gobernador', S:'Senador', P:'Presidente' };
    const AT27_GT_PART_COLORS  = { LOW:'#ef4444', MID:'#facc15', HIGH:'#22c55e' };
    const AT27_GT_PART_sec  = s => String(s??'').replace(/\D+/g,'');
    const AT27_GT_PART_yearsFor = p => (['G','S','P'].includes(p) ? ['2018','2024','2027*'] : ['2018','2021','2024','2027*']);

    function AT27_GT_PART_getUniverseSecIds(){
      const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];
      const ids = [];
      for (const f of feats){
        const p = f.properties||{};
        const id = AT27_GT_PART_sec(p.ID ?? p.Seccion ?? p.SECCION ?? p.seccion ?? p.id ?? p.SECCION);
        if (id) ids.push(id);
      }
      return [...new Set(ids)];
    }

    function AT27_GT_PART_partPct(row){
      if (!row) return null;
      const ln = Number(row.LN||0); if (!ln) return null;
      let votos = (row.VOTOS!=null) ? Number(row.VOTOS||0) : 0;
      if (row.VOTOS==null){ for (const [k,v] of Object.entries(row)){ if (k!=='LN'&&k!=='VOTOS') votos += Number(v||0); } }
      const pct = (votos/ln)*100;
      return Math.max(0, Math.min(100, pct));
    }

    // Proyecci√≥n 2027 (ver explicaci√≥n en el mensaje)
    function AT27_GT_PART_project2027(slot, puesto){
      const p18 = AT27_GT_PART_partPct(slot['2018']);
      const p21 = AT27_GT_PART_partPct(slot['2021']);
      const p24 = AT27_GT_PART_partPct(slot['2024']);
      const vals = [p18,p21,p24].filter(v=>typeof v==='number'&&isFinite(v));
      if (vals.length===0) return null;
      if (['G','S','P'].includes(puesto)){
        const a = (typeof p18==='number')?p18:p24, b = (typeof p24==='number')?p24:p18;
        const slopePerYear = (b-a)/6;
        return Math.max(0, Math.min(100, b + 0.6*slopePerYear*3));
      } else {
        const pts=[]; if (typeof p18==='number') pts.push({t:0,y:p18,w:1.0}); if (typeof p21==='number') pts.push({t:3,y:p21,w:1.5}); if (typeof p24==='number') pts.push({t:6,y:p24,w:2.0});
        const W=pts.reduce((a,p)=>a+p.w,0), tbar=pts.reduce((a,p)=>a+p.w*p.t,0)/W, ybar=pts.reduce((a,p)=>a+p.w*p.y,0)/W;
        const num=pts.reduce((a,p)=>a+p.w*(p.t-tbar)*(p.y-ybar),0), den=pts.reduce((a,p)=>a+p.w*(p.t-tbar)*(p.t-tbar),0)||1e-9;
        const b1=num/den, b0=ybar-b1*tbar;
        return Math.max(0, Math.min(100, b0 + b1*9));
      }
    }

    function AT27_GT_PART_compute(js, secIds, puesto, year){
      const perSec = {}; const bins={LOW:0,MID:0,HIGH:0};
      let lnW=0, partW=0;
      for (const sec of secIds){
        const slot = js?.secciones?.[sec]; if (!slot) continue;
        const pct = (year==='2027*') ? AT27_GT_PART_project2027(slot, puesto) : AT27_GT_PART_partPct(slot[year]);
        if (pct==null || !isFinite(pct)) continue;
        perSec[sec]=pct;
        if (pct<30) bins.LOW++; else if (pct<50) bins.MID++; else bins.HIGH++;
        const rowForLN = (year==='2027*' ? slot['2024'] : slot[year]) || {};
        const ln = Number(rowForLN?.LN||0); if (ln>0){ lnW += ln; partW += pct*ln; }
      }
      const avg = lnW>0 ? (partW/lnW) : NaN;
      return { perSec, bins, avg };
    }

    function AT27_GT_PART_clearOverlay(){
      const map = window.AT_CTX?.map || window.map; if (!map) return;
      if (window.AT27_GT_PART_LAYER){ try{ map.removeLayer(AT27_GT_PART_LAYER); }catch(_){ } window.AT27_GT_PART_LAYER=null; }
    }

    function AT27_GT_PART_buildOverlay(perSec){
      const map = window.AT_CTX?.map || window.map;
      const base = window.AT_CTX?.layer?.toGeoJSON?.() || window.AT_DATA;
      if (!map || !base?.features) return;
      if (map.createPane && !map.getPane('at27_gt_part_pane')){
        map.createPane('at27_gt_part_pane'); map.getPane('at27_gt_part_pane').style.zIndex=660; map.getPane('at27_gt_part_pane').style.pointerEvents='none';
      }
      const geo = { type:'FeatureCollection', features: base.features.filter(f=>{
        const id = AT27_GT_PART_sec(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
        return perSec[id]!=null;
      })};
      const layer = L.geoJSON(geo, {
        pane:'at27_gt_part_pane',
        style:f=>{
          const id = AT27_GT_PART_sec(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
          const pct = perSec[id];
          const col = (pct<30)?AT27_GT_PART_COLORS.LOW: (pct<50?AT27_GT_PART_COLORS.MID:AT27_GT_PART_COLORS.HIGH);
          return { color:col, weight:1, opacity:.9, fillColor:col, fillOpacity:.45 };
        },
        interactive:false
      });
      AT27_GT_PART_clearOverlay(); layer.addTo(map); window.AT27_GT_PART_LAYER=layer;
    }

    function AT27_GT_PART_getOrCreatePanel(){
      let panel=document.getElementById('AT27_GT_PART_panel'); if (panel) return panel;
      panel=document.createElement('div');
      Object.assign(panel.style,{position:'fixed',right:'32px',top:'32px',zIndex:9999,width:'360px',height:'230px',background:'#fff',border:'1px solid #e5e7eb',borderRadius:'14px',boxShadow:'0 18px 40px rgba(0,0,0,.18)',overflow:'hidden',resize:'both',fontFamily:'system-ui, Segoe UI, Roboto, Arial'});
      panel.id='AT27_GT_PART_panel';
      panel.innerHTML=`
        <div id="AT27_GT_PART_hdr" style="cursor:move; user-select:none; background:#efefef; color:#111; padding:10px 12px; display:flex; gap:10px; align-items:center;">
          <div style="font-weight:800;">Participaci√≥n por secci√≥n</div>
          <select id="AT27_GT_PART_selYear"   style="margin-left:auto; background:#fff; color:#111827; border-radius:8px; padding:4px 8px; border:none; outline:none;"></select>
          <select id="AT27_GT_PART_selPuesto" style="background:#fff; color:#111827; border-radius:8px; padding:4px 8px; border:none; outline:none;">
            ${Object.entries(AT27_GT_PART_PUESTOS).map(([k,v])=>`<option value="${k}">${v}</option>`).join('')}
          </select>
          <button id="AT27_GT_PART_close" title="Cerrar" style="background:transparent;color:#111;border:none;font-size:18px;cursor:pointer;">√ó</button>
        </div>
        <div id="AT27_GT_PART_body" style="padding:10px 12px; height: calc(100% - 50px); overflow:auto;">
          <div style="margin-bottom:8px;">
            <div style="font-weight:700;">Leyenda</div>
            <div style="display:flex; gap:10px; margin-top:6px; font-size:13px;">
              <div style="display:flex; align-items:center; gap:6px;"><span style="display:inline-block;width:12px;height:12px;background:${AT27_GT_PART_COLORS.LOW};border:1px solid rgba(0,0,0,.2);border-radius:3px;"></span> < 30%</div>
              <div style="display:flex; align-items:center; gap:6px;"><span style="display:inline-block;width:12px;height:12px;background:${AT27_GT_PART_COLORS.MID};border:1px solid rgba(0,0,0,.2);border-radius:3px;"></span> 30‚Äì50%</div>
              <div style="display:flex; align-items:center; gap:6px;"><span style="display:inline-block;width:12px;height:12px;background:${AT27_GT_PART_COLORS.HIGH};border:1px solid rgba(0,0,0,.2);border-radius:3px;"></span> > 50%</div>
            </div>
          </div>
          <div id="AT27_GT_PART_stats" style="font-size:13px;color:#334155;"></div>
        </div>`;
      document.body.appendChild(panel);
      panel.querySelector('#AT27_GT_PART_close').onclick=()=>{ AT27_GT_PART_clearOverlay(); panel.remove(); };
      (function drag(panel,handle){ let drag=false,sx=0,sy=0,bx=0,by=0; handle.addEventListener('mousedown',e=>{drag=true;sx=e.clientX;sy=e.clientY;const r=panel.getBoundingClientRect();bx=r.left;by=r.top;document.body.style.userSelect='none';}); window.addEventListener('mousemove',e=>{if(!drag)return; const dx=e.clientX-sx, dy=e.clientY-sy; panel.style.left=(bx+dx)+'px'; panel.style.top=(by+dy)+'px'; panel.style.right='auto';}); window.addEventListener('mouseup',()=>{drag=false;document.body.style.userSelect='';});})(panel, panel.querySelector('#AT27_GT_PART_hdr'));
      return panel;
    }

    function AT27_GT_PART_populateYears(puesto){
      const panel=AT27_GT_PART_getOrCreatePanel(); const selY=panel.querySelector('#AT27_GT_PART_selYear');
      const years=AT27_GT_PART_yearsFor(puesto); selY.innerHTML=years.map(y=>`<option value="${y}">${y}</option>`).join(''); if (years.includes('2024')) selY.value='2024';
    }

    async function AT27_GT_PART_update(){
      const panel=AT27_GT_PART_getOrCreatePanel(); const selY=panel.querySelector('#AT27_GT_PART_selYear'); const selP=panel.querySelector('#AT27_GT_PART_selPuesto');
      const puesto=selP.value, year=selY.value;
      const secIds=AT27_GT_PART_getUniverseSecIds();
      const js=await loadPuesto(puesto);
      const { perSec, bins, avg }=AT27_GT_PART_compute(js, secIds, puesto, year);
      AT27_GT_PART_buildOverlay(perSec);
      const total=secIds.length, stats = `
        <div>Universo: <b>${total}</b> secciones ¬∑ Puesto <b>${AT27_GT_PART_PUESTOS[puesto]||puesto}</b> ¬∑ A√±o <b>${year}</b></div>
        <div style="margin-top:4px;">Promedio del universo (ponderado por LN): <b>${isFinite(avg)?avg.toFixed(1):'‚Äî'}%</b></div>
        <div style="margin-top:6px; display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px;">
          <div><span style="color:${AT27_GT_PART_COLORS.LOW};font-weight:700;">${bins.LOW}</span> <span style="color:#64748b;">(< 30%)</span></div>
          <div><span style="color:#b45309;font-weight:700;">${bins.MID}</span> <span style="color:#64748b;">(30‚Äì50%)</span></div>
          <div><span style="color:${AT27_GT_PART_COLORS.HIGH};font-weight:700;">${bins.HIGH}</span> <span style="color:#64748b;">(> 50%)</span></div>
        </div>`;
      panel.querySelector('#AT27_GT_PART_stats').innerHTML=stats;
    }

    async function AT27_GT_PART_ejecutar(puestoInicial='A', yearInicial='2024'){
      const panel=AT27_GT_PART_getOrCreatePanel(); const selY=panel.querySelector('#AT27_GT_PART_selYear'); const selP=panel.querySelector('#AT27_GT_PART_selPuesto');
      selP.value=puestoInicial; AT27_GT_PART_populateYears(puestoInicial); if ([...selY.options].some(o=>o.value===yearInicial)) selY.value=yearInicial;
      selP.onchange=()=>{ AT27_GT_PART_populateYears(selP.value); AT27_GT_PART_update(); };
      selY.onchange=()=> AT27_GT_PART_update();
      await AT27_GT_PART_update();
    }
    /* ============================ FIN MOD ============================ */

</script>

<script>
  // Usa tu loader de JSON electorales si no existe loadPuesto
  window.loadPuesto = window.loadPuesto || window.getElectData;

  // Evita que la barra ‚Äúcoma‚Äù los clicks/scroll del mapa y cablea el bot√≥n
  (function wireTopBarGT(){
    const bar = document.getElementById('top-toolbar');
    if (!bar || bar.__wired) return;
    if (window.L && L.DomEvent){
      L.DomEvent.disableClickPropagation(bar);
      L.DomEvent.disableScrollPropagation(bar);
    }
    document.getElementById('btn-gt-part')?.addEventListener('click', () => {
      // Lanza el panel flotante de Participaci√≥n (el overlay se pinta en el mapa)
      AT27_GT_PART_ejecutar('A','2024');
    });

    document.getElementById('btn-estabilidad')?.addEventListener('click', () => {
      AT27_EP_ejecutar(); // puesto fijo 'A'
    });

    document.getElementById('btn-ayuda')?.addEventListener('click', ()=>{
      document.getElementById('mini-ayuda-GT')?.scrollIntoView({behavior:'smooth', block:'start'});
    });

    document.getElementById('btn-gt-metas')?.addEventListener('click', () => {
      AT27_GT_META_ejecutar('A', 50, 3); // puesto A, meta 50%, tolerancia 3 pp
    });

    document.getElementById('btn-gt-ganar')?.addEventListener('click', () => {
      AT27_GT_GANAR_ejecutar('A','PAN'); // abre con Ayuntamiento + PAN
    });

    document.getElementById('btn-recentrar')?.addEventListener('click', () => {
      AT27_fitUniverseBounds();
    });

    // Atajo de teclado: R
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'R' || e.key === 'r'){
        e.preventDefault();
        AT27_fitUniverseBounds();
      }
    });

    bar.__wired = true;
  })();
</script>

<script>
  /* ====== ESTABILIDAD POL√çTICA 2018‚Äì2024 con upgrades (AT27_EP_) ====== */

const AT27_EP_COLORS = { HIGH:'#22c55e', MED:'#facc15', LOW:'#ef4444' }; // verde, amarillo, rojo
const AT27_EP_PUESTOS = { A:'Ayuntamiento', DL:'Diputado Local', DF:'Diputado Federal', G:'Gobernador', S:'Senador', P:'Presidente' };
const AT27_EP_sec = s => String(s??'').replace(/\D+/g,'');
const AT27_EP_yearsFor = p => (['G','S','P'].includes(p) ? ['2018','2024'] : ['2018','2021','2024']);
let   AT27_EP_FILL_OPACITY = 0.45; // slider

// Universo actual ‚Üí ids
function AT27_EP_getUniverseSecIds(){
  const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];
  const ids=[]; for (const f of feats){ const p=f.properties||{}; const id=AT27_EP_sec(p.ID??p.Seccion??p.SECCION??p.seccion??p.id); if(id) ids.push(id); }
  return [...new Set(ids)];
}

// ganador por fila (excluye LN/VOTOS)
function AT27_EP_winner(row){
  if (!row) return null;
  let best=null, max=-1;
  for (const [k,v] of Object.entries(row)){
    if (k==='LN'||k==='VOTOS') continue;
    const vv=Number(v||0); if (vv>max){max=vv; best=k.toUpperCase();}
  }
  return best;
}

// c√°lculo por secci√≥n (generalizado a 2 o 3 elecciones)
function AT27_EP_compute(js, secIds, years){
  const perSec = {}; // sec -> {cat, winners:{year:party}}
  const counts = { HIGH:0, MED:0, LOW:0 };
  let analyzed = 0;

  for (const sec of secIds){
    const slot = js?.secciones?.[sec]; if (!slot) continue;

    const winners = {};
    for (const y of years){ winners[y] = AT27_EP_winner(slot[y]); }
    const vals = years.map(y=>winners[y]).filter(Boolean);
    if (vals.length < Math.min(2, years.length)) continue; // requiere >=2 datos

    const uniq = new Set(vals).size;
    let cat;
    if (years.length === 3){
      // 2018‚Äì2021‚Äì2024: Alta=1 partido, Media=2 partidos, Baja=3 partidos
      cat = (uniq===1) ? 'HIGH' : (uniq===2 ? 'MED' : 'LOW');
    }else{
      // sexenales (2018,2024): Alta=igual, Media=diferente (no hay "LOW")
      cat = (uniq===1) ? 'HIGH' : 'MED';
    }
    perSec[sec] = { cat, winners };
    counts[cat]++; analyzed++;
  }
  return { perSec, counts, analyzed };
}

// limpiar / construir overlay
function AT27_EP_clearOverlay(){
  const map = window.AT_CTX?.map || window.map; if (!map) return;
  if (window.AT27_EP_LAYER){ try{ map.removeLayer(AT27_EP_LAYER); }catch(_){ } window.AT27_EP_LAYER=null; }
}
function AT27_EP_buildOverlay(perSec, years){
  const map  = window.AT_CTX?.map || window.map;
  const base = window.AT_CTX?.layer?.toGeoJSON?.() || window.AT_DATA;
  if (!map || !base?.features) return;

  if (map.createPane && !map.getPane('at27_ep_pane')){
    map.createPane('at27_ep_pane');
    map.getPane('at27_ep_pane').style.zIndex = 665;
    map.getPane('at27_ep_pane').style.pointerEvents = 'auto'; // permitir hover
  }

  const features = base.features.filter(f=>{
    const id = AT27_EP_sec(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
    return perSec[id]!=null;
  });
  const geo = { type:'FeatureCollection', features };

  const layer = L.geoJSON(geo, {
    pane: 'at27_ep_pane',
    style: f=>{
      const id  = AT27_EP_sec(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
      const cat = perSec[id]?.cat; const col = AT27_EP_COLORS[cat] || '#94a3b8';
      return { color: col, weight: 1, opacity: .9, fillColor: col, fillOpacity: AT27_EP_FILL_OPACITY };
    },
    onEachFeature: (feature, lyr)=>{
      const id = AT27_EP_sec(feature.properties?.ID ?? feature.properties?.SECCION ?? feature.properties?.id);
      const info = perSec[id]; if (!info) return;
      const seq = years.map(y => `${y}: <b>${info.winners[y]||'‚Äî'}</b>`).join(' &nbsp;‚Üí&nbsp; ');
      lyr.bindTooltip(`<div style="font-size:12px;">${seq}</div>`, {sticky:true, opacity:0.95, direction:'top', className:'at27-tt'});
      lyr.on('mouseover', ()=> lyr.setStyle({weight:2}));
      lyr.on('mouseout',  ()=> lyr.setStyle({weight:1}));
    }
  });

  AT27_EP_clearOverlay();
  layer.addTo(map);
  window.AT27_EP_LAYER = layer;
}

// actualizar opacidad en caliente
function AT27_EP_updateOpacity(){
  if (!window.AT27_EP_LAYER) return;
  window.AT27_EP_LAYER.setStyle({ fillOpacity: AT27_EP_FILL_OPACITY });
}

// Panel flotante (con puesto, opacidad y export)
function AT27_EP_getOrCreatePanel(){
  let panel = document.getElementById('AT27_EP_panel');
  if (panel) return panel;

  panel = document.createElement('div');
  panel.id = 'AT27_EP_panel';
  Object.assign(panel.style,{
    position:'fixed', right:'32px', top:'32px', zIndex:9999,
    width:'380px', background:'#fff', border:'1px solid #e5e7eb',
    borderRadius:'14px', boxShadow:'0 18px 40px rgba(0,0,0,.18)', overflow:'hidden',
    fontFamily:'system-ui, Segoe UI, Roboto, Arial'
  });
  panel.innerHTML = `
    <div id="AT27_EP_hdr" style="cursor:move; user-select:none; background:#e0e7ff; color:#111; padding:10px 12px; display:flex; gap:10px; align-items:center;">
      <div style="font-weight:800;">Estabilidad Pol√≠tica 2018‚Äì2024</div>
      <select id="AT27_EP_selPuesto" style="margin-left:auto;background:#fff;color:#111827;border-radius:8px;padding:4px 8px;border:none;outline:none;">
        ${Object.entries(AT27_EP_PUESTOS).map(([k,v])=>`<option value="${k}">${v}</option>`).join('')}
      </select>
      <button id="AT27_EP_close" title="Cerrar" style="background:transparent;color:#111;border:none;font-size:18px;cursor:pointer;">√ó</button>
    </div>
    <div id="AT27_EP_body" style="padding:12px 14px;">
      <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
        <div style="font-size:12px;color:#334155;">Opacidad</div>
        <input id="AT27_EP_opacity" type="range" min="0.1" max="0.9" step="0.05" value="${AT27_EP_FILL_OPACITY}" style="flex:1;">
        <button id="AT27_EP_export" class="ttb-btn" style="margin-left:6px;">Exportar PNG</button>
      </div>
      <div style="font-weight:700;margin-bottom:6px;">Leyenda</div>
      <div id="AT27_EP_legend" style="display:grid; grid-template-columns: 1fr; gap:6px; font-size:13px;"></div>
      <div id="AT27_EP_totalBox" style="margin-top:10px; font-weight:800;"></div>
    </div>
  `;
  document.body.appendChild(panel);

  panel.querySelector('#AT27_EP_close').onclick = ()=>{ AT27_EP_clearOverlay(); panel.remove(); };

  // drag
  (function drag(panel, handle){
    let sx=0, sy=0, ox=0, oy=0, dragging=false;
    handle.addEventListener('mousedown', e=>{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panel.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });
    window.addEventListener('mousemove', e=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panel.style.left=(ox+dx)+'px'; panel.style.top=(oy+dy)+'px'; panel.style.right='auto'; });
    window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; });
  })(panel, panel.querySelector('#AT27_EP_hdr'));

  // listeners del panel
  panel.querySelector('#AT27_EP_opacity').addEventListener('input', (e)=>{ AT27_EP_FILL_OPACITY = Number(e.target.value); AT27_EP_updateOpacity(); });
  panel.querySelector('#AT27_EP_export').addEventListener('click', AT27_EP_exportPNG);

  return panel;
}

// Rellena leyenda din√°micamente (en sexenales no hay "LOW")
function AT27_EP_renderLegend(counts, analyzed, years){
  const LBL = {
    HIGH: years.length===3 ? 'Alta (mismo partido 3 elecciones)' : 'Alta (mismo partido en todas)',
    MED : years.length===3 ? 'Estabilidad Media (1 cambio)'      : 'Media (cambio)',
    LOW : 'Inestabilidad Alta (3 partidos)'
  };
  const rows = ['HIGH','MED','LOW'].map(k=>{
    const hide = (k==='LOW' && years.length===2); // no aplica en 2 elecciones
    const pct  = analyzed>0 ? ` (${(counts[k]*100/analyzed).toFixed(1)}%)` : '';
    return hide ? '' : `
      <div style="display:flex;align-items:center;gap:8px;">
        <span style="width:12px;height:12px;border-radius:3px;background:${AT27_EP_COLORS[k]};border:1px solid rgba(0,0,0,.15)"></span>
        ${LBL[k]}: <b style="margin-left:4px;">${counts[k]}</b>
        <span style="color:#64748b;margin-left:4px;">${pct}</span>
      </div>`;
  }).join('');
  return rows || '<i style="color:#64748b;">Sin datos suficientes.</i>';
}

function AT27_EP_render({puesto, counts, analyzed, years}){
  const panel = AT27_EP_getOrCreatePanel();
  panel.querySelector('#AT27_EP_selPuesto').value = puesto;
  panel.querySelector('#AT27_EP_legend').innerHTML = AT27_EP_renderLegend(counts, analyzed, years);
  panel.querySelector('#AT27_EP_totalBox').innerHTML = `Total secciones analizadas: <span>${analyzed}</span>`;
}

// Exportar PNG (mapa + lo que se vea encima)
async function AT27_EP_exportPNG(){
  const mapEl = (window.AT_CTX?.map?._container) || document.querySelector('.leaflet-container,#map,#mapid');
  if (!mapEl){ alert('No encontr√© el contenedor del mapa.'); return; }

  // Carga html2canvas si no est√°
  async function ensureHtml2Canvas(){
    if (window.html2canvas) return;
    await new Promise((resolve, reject)=>{
      const s=document.createElement('script');
      s.src='https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
      s.onload=resolve; s.onerror=()=>reject(new Error('No pude cargar html2canvas'));
      document.head.appendChild(s);
    });
  }

  try{
    await ensureHtml2Canvas();
    const canvas = await window.html2canvas(mapEl, {useCORS:true, backgroundColor:null, logging:false});
    const link = document.createElement('a');
    link.download = `estabilidad_${Date.now()}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
  }catch(e){
    console.error(e);
    alert('No pude exportar PNG (CORS o bloqueo de librer√≠a).');
  }
}

// API p√∫blica
async function AT27_EP_ejecutar(puestoInicial='A'){
  try{
    const panel = AT27_EP_getOrCreatePanel();
    const sel   = panel.querySelector('#AT27_EP_selPuesto');
    sel.value = puestoInicial;

    sel.onchange = async ()=>{
      const p = sel.value;
      const years = AT27_EP_yearsFor(p);
      const ids   = AT27_EP_getUniverseSecIds();
      if (!ids.length) return alert('No hay secciones en el universo actual.');
      const js    = await (window.loadPuesto ? loadPuesto(p) : getElectData(p));
      const { perSec, counts, analyzed } = AT27_EP_compute(js, ids, years);
      AT27_EP_buildOverlay(perSec, years);
      AT27_EP_render({puesto:p, counts, analyzed, years});
    };

    // primer render
    const p     = sel.value;
    const years = AT27_EP_yearsFor(p);
    const ids   = AT27_EP_getUniverseSecIds();
    if (!ids.length) return alert('No hay secciones en el universo actual.');
    const js    = await (window.loadPuesto ? loadPuesto(p) : getElectData(p));
    const { perSec, counts, analyzed } = AT27_EP_compute(js, ids, years);
    AT27_EP_buildOverlay(perSec, years);
    AT27_EP_render({puesto:p, counts, analyzed, years});
  }catch(e){
    console.error('AT27_EP_ejecutar error:', e);
    alert('No pude calcular la estabilidad pol√≠tica.');
  }
}
/* ====================== FIN upgrades ESTABILIDAD POL√çTICA ====================== */

</script>
<script>

    /* ========== GANAR TODO ¬∑ METAS DE PARTICIPACI√ìN 2027* (AT27_GT_META_) ========== */
    /* Universos desde AT_CTX.layer; datos con loadPuesto(puesto)
      Colorea por secci√≥n seg√∫n p2027* vs meta:
      - PASS (verde): p2027 ‚â• meta
      - NEAR (amarillo): 0 < meta - p2027 ‚â§ tolerancia
      - FAIL (rojo): p2027 < meta - tolerancia
      Panel con puesto, meta, tolerancia, opacidad, resumen y Top-20 brechas, export PNG. */

    const AT27_GT_META_PUESTOS = { A:'Ayuntamiento', DL:'Diputado Local', DF:'Diputado Federal', G:'Gobernador', S:'Senador', P:'Presidente' };
    const AT27_GT_META_COLS   = { PASS:'#22c55e', NEAR:'#f59e0b', FAIL:'#ef4444' };
    const AT27_GT_META_sec    = s => String(s??'').replace(/\D+/g,'');
    const AT27_GT_META_yearsFor = p => (['G','S','P'].includes(p) ? ['2018','2024'] : ['2018','2021','2024']);
    let   AT27_GT_META_FILL   = 0.45;  // opacidad overlay

    // -------- Helpers universo / datos --------
    function AT27_GT_META_getUniverseSecIds(){
      const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];
      const ids=[]; for (const f of feats){ const p=f.properties||{}; const id=AT27_GT_META_sec(p.ID??p.Seccion??p.SECCION??p.seccion??p.id); if(id) ids.push(id); }
      return [...new Set(ids)];
    }
    function AT27_GT_META_partPct(row){
      if (!row) return null;
      const ln = Number(row.LN||0); if (!ln) return null;
      let votos = (row.VOTOS!=null) ? Number(row.VOTOS||0) : 0;
      if (row.VOTOS==null){ for (const [k,v] of Object.entries(row)){ if (k!=='LN' && k!=='VOTOS') votos += Number(v||0); } }
      return Math.max(0, Math.min(100, (votos/ln)*100));
    }
    function AT27_GT_META_project2027(slot, puesto){
      const p18 = AT27_GT_META_partPct(slot['2018']);
      const p21 = AT27_GT_META_partPct(slot['2021']);
      const p24 = AT27_GT_META_partPct(slot['2024']);
      const vals = [p18,p21,p24].filter(v=>typeof v==='number'&&isFinite(v));
      if (vals.length===0) return null;

      if (['G','S','P'].includes(puesto)){
        const a = (typeof p18==='number')?p18:p24, b=(typeof p24==='number')?p24:p18;
        const slopePerYear = (b-a)/6;  // 2018‚Üí2024
        return Math.max(0, Math.min(100, b + 0.6*slopePerYear*3)); // conservador 60%
      }else{
        // 2018=0, 2021=3, 2024=6 ‚Üí 2027=9; pesos 1,1.5,2
        const pts=[]; if (typeof p18==='number') pts.push({t:0,y:p18,w:1.0}); if (typeof p21==='number') pts.push({t:3,y:p21,w:1.5}); if (typeof p24==='number') pts.push({t:6,y:p24,w:2.0});
        const W=pts.reduce((a,p)=>a+p.w,0), tbar=pts.reduce((a,p)=>a+p.w*p.t,0)/W, ybar=pts.reduce((a,p)=>a+p.w*p.y,0)/W;
        const num=pts.reduce((a,p)=>a+p.w*(p.t-tbar)*(p.y-ybar),0), den=pts.reduce((a,p)=>a+p.w*(p.t-tbar)*(p.t-tbar),0)||1e-9;
        const b1=num/den, b0=ybar-b1*tbar;
        return Math.max(0, Math.min(100, b0 + b1*9));
      }
    }
    function AT27_GT_META_winner(row){
      if (!row) return null;
      let best=null,max=-1; for (const [k,v] of Object.entries(row)){ if (k==='LN'||k==='VOTOS') continue; const vv=Number(v||0); if (vv>max){max=vv; best=k.toUpperCase();} }
      return best;
    }

    // -------- C√°lculo por secci√≥n --------
    function AT27_GT_META_compute(js, secIds, puesto, metaPct, tolPct){
      const perSec = {}; // sec -> {cat, p18,p21,p24,p27, delta}  (delta = p27 - meta)
      const counts = { PASS:0, NEAR:0, FAIL:0 };
      let lnW=0, p27W=0;  // promedio ponderado por LN (usamos LN 2024)

      for (const sec of secIds){
        const slot = js?.secciones?.[sec]; if (!slot) continue;
        const p27  = AT27_GT_META_project2027(slot, puesto);
        if (p27==null || !isFinite(p27)) continue;

        const p18 = AT27_GT_META_partPct(slot['2018']);
        const p21 = AT27_GT_META_partPct(slot['2021']);
        const p24 = AT27_GT_META_partPct(slot['2024']);

        const delta = p27 - metaPct; // + = sobre meta; - = falta
        let cat = 'PASS';
        if (delta < -tolPct) cat = 'FAIL';
        else if (delta < 0)  cat = 'NEAR';

        perSec[sec] = { cat, p18, p21, p24, p27, delta };

        counts[cat]++;
        const ln = Number((slot['2024']||{}).LN || 0); if (ln>0){ lnW += ln; p27W += p27*ln; }
      }
      const avg = lnW>0 ? (p27W/lnW) : NaN;
      return { perSec, counts, avg };
    }

    // -------- Overlay Leaflet --------
    function AT27_GT_META_clearOverlay(){
      const map = window.AT_CTX?.map || window.map; if (!map) return;
      if (window.AT27_GT_META_LAYER){ try{ map.removeLayer(AT27_GT_META_LAYER); }catch(_){ } window.AT27_GT_META_LAYER=null; }
    }
    function AT27_GT_META_buildOverlay(perSec){
      const map  = window.AT_CTX?.map || window.map;
      const base = window.AT_CTX?.layer?.toGeoJSON?.() || window.AT_DATA;
      if (!map || !base?.features) return;

      if (map.createPane && !map.getPane('at27_gt_meta_pane')){
        map.createPane('at27_gt_meta_pane');
        map.getPane('at27_gt_meta_pane').style.zIndex = 670;
        map.getPane('at27_gt_meta_pane').style.pointerEvents = 'auto'; // hover/click
      }

      const features = base.features.filter(f=>{
        const id = AT27_GT_META_sec(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
        return perSec[id]!=null;
      });
      const geo = { type:'FeatureCollection', features };

      const layer = L.geoJSON(geo, {
        pane: 'at27_gt_meta_pane',
        style: f=>{
          const id = AT27_GT_META_sec(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
          const col = AT27_GT_META_COLS[ perSec[id].cat ] || '#94a3b8';
          return { color:col, weight:1, opacity:.9, fillColor:col, fillOpacity:AT27_GT_META_FILL };
        },
        onEachFeature: (feature, lyr)=>{
          const id = AT27_GT_META_sec(feature.properties?.ID ?? feature.properties?.SECCION ?? feature.properties?.id);
          const info = perSec[id]; if (!info) return;
          const p = (x)=> (typeof x==='number' && isFinite(x)) ? x.toFixed(1)+'%' : '‚Äî';
          const deltaTxt = (info.delta>=0?'+':'') + (isFinite(info.delta)?info.delta.toFixed(1):'‚Äî') + ' pp';
          const has21 = info.p21!=null && isFinite(info.p21);
          const seq = has21
            ? `2018 ${p(info.p18)} ‚Üí 2021 ${p(info.p21)} ‚Üí 2024 ${p(info.p24)} ‚Üí <b>2027* ${p(info.p27)}</b>`
            : `2018 ${p(info.p18)} ‚Üí 2024 ${p(info.p24)} ‚Üí <b>2027* ${p(info.p27)}</b>`;
          lyr.bindTooltip(`<div style="font-size:12px;">${seq}<br>Œî vs meta: <b>${deltaTxt}</b></div>`, {sticky:true, opacity:0.95, direction:'top', className:'at27-tt'});
          // Click: si tienes manejador de secci√≥n, √∫salo
          lyr.on('click', ()=>{ if (typeof window.openSeccionPanel==='function'){ window.openSeccionPanel(id); } });
          lyr.on('mouseover', ()=> lyr.setStyle({weight:2}));
          lyr.on('mouseout',  ()=> lyr.setStyle({weight:1}));
        }
      });

      AT27_GT_META_clearOverlay();
      layer.addTo(map);
      window.AT27_GT_META_LAYER = layer;
    }
    function AT27_GT_META_updateOpacity(){
      if (window.AT27_GT_META_LAYER) window.AT27_GT_META_LAYER.setStyle({ fillOpacity: AT27_GT_META_FILL });
    }

    // -------- Panel UI --------
    function AT27_GT_META_getOrCreatePanel(){
      let panel = document.getElementById('AT27_GT_META_panel');
      if (panel) return panel;

      panel = document.createElement('div');
      panel.id = 'AT27_GT_META_panel';
      Object.assign(panel.style,{
        position:'fixed', right:'32px', top:'32px', zIndex:9999,
        width:'440px', background:'#fff', border:'1px solid #e5e7eb',
        borderRadius:'14px', boxShadow:'0 18px 40px rgba(0,0,0,.18)',
        overflow:'hidden', fontFamily:'system-ui, Segoe UI, Roboto, Arial',
        resize: 'both',
        minWidth: '360px',
        minHeight: '260px',
        display: 'flex',
        flexDirection: 'column'
      });
      panel.innerHTML = `
        <div id="AT27_GT_META_hdr" style="cursor:move; user-select:none; background:#dcfce7; color:#111; padding:10px 12px; display:flex; gap:10px; align-items:center;">
          <div style="font-weight:800;">Metas de participaci√≥n 2027*</div>
          <select id="AT27_GT_META_selPuesto" style="margin-left:auto;background:#fff;color:#111827;border-radius:8px;padding:4px 8px;border:none;outline:none;">
            ${Object.entries(AT27_GT_META_PUESTOS).map(([k,v])=>`<option value="${k}">${v}</option>`).join('')}
          </select>
          <button id="AT27_GT_META_close" title="Cerrar" style="background:transparent;color:#111;border:none;font-size:18px;cursor:pointer;">√ó</button>
        </div>
        <div id="AT27_GT_META_body" style="padding:12px 14px;">
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:10px;">
            <label style="display:flex;align-items:center;gap:8px;border:1px solid #e5e7eb;border-radius:10px;padding:8px;">
              <span style="font-size:12px;color:#334155;">Meta (%)</span>
              <input id="AT27_GT_META_meta" type="range" min="40" max="70" step="1" value="50" style="flex:1;">
              <span id="AT27_GT_META_meta_val" style="width:42px;text-align:right;font-variant-numeric:tabular-nums;">50%</span>
            </label>
            <label style="display:flex;align-items:center;gap:8px;border:1px solid #e5e7eb;border-radius:10px;padding:8px;">
              <span style="font-size:12px;color:#334155;">Tolerancia (pp)</span>
              <input id="AT27_GT_META_tol" type="range" min="0" max="5" step="0.5" value="3" style="flex:1;">
              <span id="AT27_GT_META_tol_val" style="width:42px;text-align:right;font-variant-numeric:tabular-nums;">3.0</span>
            </label>
          </div>
          <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
            <div style="font-size:12px;color:#334155;">Opacidad</div>
            <input id="AT27_GT_META_opacity" type="range" min="0.1" max="0.9" step="0.05" value="${AT27_GT_META_FILL}" style="flex:1;">
            <button id="AT27_GT_META_export" class="ttb-btn" style="margin-left:6px;">Exportar PNG</button>
          </div>

          <div id="AT27_GT_META_summary" style="font-size:13px;color:#334155;margin-bottom:10px;"></div>

          <div style="font-weight:700;margin-bottom:6px;">Leyenda</div>
          <div id="AT27_GT_META_legend" style="display:grid; grid-template-columns: 1fr; gap:6px; font-size:13px;"></div>

          <div style="font-weight:700;margin:10px 0 6px;">Top 20 ‚Äì Mayor brecha vs meta</div>
          <div id="AT27_GT_META_top" style="max-height:220px; overflow:auto; border:1px solid #f1f5f9;border-radius:10px;padding:8px;"></div>
        </div>
      `;
      document.body.appendChild(panel);

      panel.querySelector('#AT27_GT_META_close').onclick = ()=>{ AT27_GT_META_clearOverlay(); panel.remove(); };

      // drag
      (function drag(panel, handle){
        let sx=0, sy=0, ox=0, oy=0, dragging=false;
        handle.addEventListener('mousedown', e=>{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panel.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });
        window.addEventListener('mousemove', e=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panel.style.left=(ox+dx)+'px'; panel.style.top=(oy+dy)+'px'; panel.style.right='auto'; });
        window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; });
      })(panel, panel.querySelector('#AT27_GT_META_hdr'));

      // listeners del panel
      const selP = panel.querySelector('#AT27_GT_META_selPuesto');
      const meta = panel.querySelector('#AT27_GT_META_meta');
      const tol  = panel.querySelector('#AT27_GT_META_tol');
      const opa  = panel.querySelector('#AT27_GT_META_opacity');

      meta.addEventListener('input', ()=>{ panel.querySelector('#AT27_GT_META_meta_val').textContent = meta.value+'%'; AT27_GT_META_update(); });
      tol .addEventListener('input', ()=>{ panel.querySelector('#AT27_GT_META_tol_val').textContent  = Number(tol.value).toFixed(1); AT27_GT_META_update(); });
      opa .addEventListener('input', e=>{ AT27_GT_META_FILL = Number(e.target.value); AT27_GT_META_updateOpacity(); });
      panel.querySelector('#AT27_GT_META_export').addEventListener('click', AT27_GT_META_exportPNG);

      return panel;
    }

    // -------- Render --------
    function AT27_GT_META_render({puesto, metaPct, tolPct, counts, avg, total, worst}){
      const panel = AT27_GT_META_getOrCreatePanel();
      panel.querySelector('#AT27_GT_META_selPuesto').value = puesto;

      panel.querySelector('#AT27_GT_META_summary').innerHTML =
        `Universo: <b>${total}</b> secciones ¬∑ Puesto <b>${AT27_GT_META_PUESTOS[puesto]||puesto}</b> ¬∑ ` +
        `Meta: <b>${metaPct}%</b> ¬∑ Tolerancia: <b>${tolPct} pp</b><br>` +
        `Promedio proyectado 2027* (ponderado LN 2024): <b>${isFinite(avg)?avg.toFixed(1)+'%':'‚Äî'}</b>`;

      const pct = (n)=> total>0 ? ` (${(n*100/total).toFixed(1)}%)` : '';
      panel.querySelector('#AT27_GT_META_legend').innerHTML = `
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="width:12px;height:12px;border-radius:3px;background:${AT27_GT_META_COLS.PASS};border:1px solid rgba(0,0,0,.15)"></span>
          Cumple meta: <b>${counts.PASS}</b> <span style="color:#64748b;">${pct(counts.PASS)}</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="width:12px;height:12px;border-radius:3px;background:${AT27_GT_META_COLS.NEAR};border:1px solid rgba(0,0,0,.15)"></span>
          Cerca de meta (¬± ${tolPct} pp): <b>${counts.NEAR}</b> <span style="color:#64748b;">${pct(counts.NEAR)}</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="width:12px;height:12px;border-radius:3px;background:${AT27_GT_META_COLS.FAIL};border:1px solid rgba(0,0,0,.15)"></span>
          Debajo de meta: <b>${counts.FAIL}</b> <span style="color:#64748b;">${pct(counts.FAIL)}</span>
        </div>
      `;

      // Top 20 peores brechas
      const rows = worst.slice(0,20).map(w=>{
        const id = w.sec;
        const delta = (w.delta>=0?'+':'') + w.delta.toFixed(1) + ' pp';
        return `
          <div style="display:grid; grid-template-columns: 80px 1fr auto; gap:8px; padding:6px 4px; border-bottom:1px solid #f1f5f9;">
            <div style="color:#64748b;">Secci√≥n</div>
            <div style="font-variant-numeric:tabular-nums;"><b>${id}</b></div>
            <div style="text-align:right; ${w.delta<0?'color:#ef4444;':''}">${delta}</div>
            <div></div>
            <div style="color:#64748b;">p2027*</div>
            <div style="text-align:right; font-variant-numeric:tabular-nums;">${w.p27.toFixed(1)}%</div>
          </div>
        `;
      }).join('') || '<i style="color:#64748b;">Sin brechas (todas cumplen meta).</i>';
      panel.querySelector('#AT27_GT_META_top').innerHTML = rows;
    }

    // -------- Update loop --------
    async function AT27_GT_META_update(){
      const panel = AT27_GT_META_getOrCreatePanel();
      const selP = panel.querySelector('#AT27_GT_META_selPuesto');
      const meta = panel.querySelector('#AT27_GT_META_meta');
      const tol  = panel.querySelector('#AT27_GT_META_tol');

      const puesto  = selP.value;
      const metaPct = Number(meta.value);
      const tolPct  = Number(tol.value);

      const secIds = AT27_GT_META_getUniverseSecIds();
      if (!secIds.length) return alert('No hay secciones en el universo actual.');

      const js = await (window.loadPuesto ? loadPuesto(puesto) : getElectData(puesto));
      const { perSec, counts, avg } = AT27_GT_META_compute(js, secIds, puesto, metaPct, tolPct);

      // overlay
      AT27_GT_META_buildOverlay(perSec);

      // worst (solo las que NO cumplen)
      const worst = Object.entries(perSec)
        .filter(([_,v])=> v.cat!=='PASS')
        .map(([sec,v])=> ({sec, delta:v.delta, p27:v.p27}))
        .sort((a,b)=> (a.delta - b.delta)); // m√°s negativo primero

      AT27_GT_META_render({puesto, metaPct, tolPct, counts, avg, total:secIds.length, worst});
    }

    // -------- Export PNG --------
    async function AT27_GT_META_exportPNG(){
      const mapEl = (window.AT_CTX?.map?._container) || document.querySelector('.leaflet-container,#map,#mapid');
      if (!mapEl){ alert('No encontr√© el contenedor del mapa.'); return; }
      async function ensureHtml2Canvas(){
        if (window.html2canvas) return;
        await new Promise((resolve, reject)=>{
          const s=document.createElement('script');
          s.src='https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
          s.onload=resolve; s.onerror=()=>reject(new Error('No pude cargar html2canvas'));
          document.head.appendChild(s);
        });
      }
      try{
        await ensureHtml2Canvas();
        const canvas = await window.html2canvas(mapEl, {useCORS:true, backgroundColor:null, logging:false});
        const link = document.createElement('a');
        link.download = `meta_participacion_${Date.now()}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
      }catch(e){
        console.error(e);
        alert('No pude exportar PNG (CORS o bloqueo de librer√≠a).');
      }
    }

    // -------- API p√∫blica --------
    async function AT27_GT_META_ejecutar(puestoInicial='A', metaInicial=50, tolInicial=3){
      try{
        // crea panel e inicializa controles
        const panel = AT27_GT_META_getOrCreatePanel();
        const selP  = panel.querySelector('#AT27_GT_META_selPuesto');
        const meta  = panel.querySelector('#AT27_GT_META_meta');
        const tol   = panel.querySelector('#AT27_GT_META_tol');

        selP.value = puestoInicial;
        meta.value = String(metaInicial);
        tol.value  = String(tolInicial);
        panel.querySelector('#AT27_GT_META_meta_val').textContent = meta.value+'%';
        panel.querySelector('#AT27_GT_META_tol_val').textContent  = Number(tol.value).toFixed(1);

        // cambia puesto ‚Üí recalc
        selP.onchange = AT27_GT_META_update;

        // primer render
        await AT27_GT_META_update();

        // cerrar panel limpia overlay
        panel.querySelector('#AT27_GT_META_close').onclick = ()=>{ AT27_GT_META_clearOverlay(); panel.remove(); };
          }catch(e){
        console.error('AT27_GT_META_ejecutar error:', e);
        alert('No pude calcular las metas de participaci√≥n.');
      }
    }
    /* ======================== FIN ¬∑ METAS DE PARTICIPACI√ìN 2027* ======================== */


</script>

<script>
  // Debounce simple
  function atDebounce(fn, ms=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

  // Recalcula cuando el universo (capas visibles) cambia
  function AT27_GG_bindUniverseAutoRecalc(){
    const map = window.AT_CTX?.map || window.map;
    if (!map || map.__ggAuto) return;
    const recalc = atDebounce(()=>{
      // Si el panel est√° abierto, vuelve a ejecutar usando el universo actual
      if (document.getElementById('AT27_GG_panel')) AT27_GG_run();
    }, 300);
    map.on('layeradd', recalc);
    map.on('layerremove', recalc);
    map.__ggAuto = true;
  }
</script>

<script>
  /* ====== GANAR TODO ¬∑ ¬øQu√© se requiere para ganar todo? (AT27_GT_GANAR_) ====== */

    // Mapa secId -> layer (asegura existencia)
  window.AT27_GG_LAYERS_BY_SEC = window.AT27_GG_LAYERS_BY_SEC || {};
  window.AT27_GG_STATE = window.AT27_GG_STATE || { running:false, autorun:false };

  function atDebounce(fn, ms=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

  function AT27_GG_bindUniverseAutoRecalc(){
    const map = window.AT_CTX?.map || window.map;
    if (!map || map.__ggBound) return;
    const recalc = atDebounce(()=>{
      // Recalcula SOLO si ya corriste una vez y el panel est√° abierto
      if (!document.getElementById('AT27_GG_panel')) return;
      if (!window.AT27_GG_STATE.autorun) return;
      if (window.AT27_GG_STATE.running) return;
      AT27_GG_run();
    }, 350);
    map.on('layeradd', recalc);
    map.on('layerremove', recalc);
    map.__ggBound = true;
  }

const AT27_GG_sec = s => String(s??'').replace(/\D+/g,'');

  const AT27_GT_GANAR_PUESTOS = { A:'Ayuntamiento', DL:'Diputado Local', DF:'Diputado Federal' };
  const AT27_GT_GANAR_PARTIDOS = ['PAN','PRI','PVEM','MORENA'];
  const AT27_GT_GANAR_COLORS = {
    PAN:'#2563eb', PRI:'#dc2626', PVEM:'#16a34a', MORENA:'#7a1d1d',
    OTHER:'#94a3b8'
  };
  let AT27_GT_GANAR_FILL = 0.45;

  const AT27_GG_yearsFor = p => (['A','DL','DF'].includes(p) ? ['2018','2021','2024'] : ['2018','2024']); // por si acaso



  function AT27_GG_getUniverseSecIds(){
    const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];
    const ids=[]; for (const f of feats){ const p=f.properties||{}; const id=AT27_GG_sec(p.ID??p.Seccion??p.SECCION??p.seccion??p.id); if(id) ids.push(id); }
    return [...new Set(ids)];
  }

 function AT27_GG_partPct(row){
    if (!row) return null;
    const ln = Number(row.LN||0); if (!ln) return null;
    let votos = (row.VOTOS!=null) ? Number(row.VOTOS||0) : 0;
    if (row.VOTOS==null){ for (const [k,v] of Object.entries(row)){ if (k!=='LN' && k!=='VOTOS') votos += Number(v||0); } }
    return Math.max(0, Math.min(100, (votos/ln)*100));
  }
  function AT27_GG_project2027(slot, puesto){
    const p18 = AT27_GG_partPct(slot['2018']);
    const p21 = AT27_GG_partPct(slot['2021']);
    const p24 = AT27_GG_partPct(slot['2024']);
    const vals = [p18,p21,p24].filter(v=>typeof v==='number'&&isFinite(v));
    if (vals.length===0) return null;
    if (['G','S','P'].includes(puesto)){
      const a = (typeof p18==='number')?p18:p24, b=(typeof p24==='number')?p24:p18;
      const slopePerYear = (b-a)/6;
      return Math.max(0, Math.min(100, b + 0.6*slopePerYear*3));
    }else{
      const pts=[]; if (typeof p18==='number') pts.push({t:0,y:p18,w:1.0}); if (typeof p21==='number') pts.push({t:3,y:p21,w:1.5}); if (typeof p24==='number') pts.push({t:6,y:p24,w:2.0});
      const W=pts.reduce((a,p)=>a+p.w,0), tbar=pts.reduce((a,p)=>a+p.w*p.t,0)/W, ybar=pts.reduce((a,p)=>a+p.w*p.y,0)/W;
      const num=pts.reduce((a,p)=>a+p.w*(p.t-tbar)*(p.y-ybar),0), den=pts.reduce((a,p)=>a+p.w*(p.t-tbar)*(p.t-tbar),0)||1e-9;
      const b1=num/den, b0=ybar-b1*tbar;
      return Math.max(0, Math.min(100, b0 + b1*9));
    }
  }
  function AT27_GG_shares2024(row24){
    if (!row24) return { total:0, shares:{} };
    let total = (row24.VOTOS!=null) ? Number(row24.VOTOS||0) : 0;
    if (row24.VOTOS==null){ for (const [k,v] of Object.entries(row24)){ if (k!=='LN' && k!=='VOTOS') total += Number(v||0); } }
    const shares = {};
    if (total>0){
      for (const [k,v] of Object.entries(row24)){
        if (k==='LN'||k==='VOTOS') continue;
        shares[k.toUpperCase()] = Number(v||0)/total;
      }
    }
    return { total, shares };
  }

  function AT27_GG_compute(js, secIds, puesto, partidoSel){
    const perSec = {};
    let votosTotalParaGanar = 0, swingTotal=0, ganadas=0;
    const X = partidoSel.toUpperCase();

    for (const sec of secIds){
      const slot = js?.secciones?.[sec]; if (!slot) continue;
      const p27 = AT27_GG_project2027(slot, puesto);
      const row24 = slot['2024'];
      if (p27==null || !row24) continue;

      const ln24 = Number(row24.LN||0);
      if (!ln24) continue;

      const Vproj = ln24 * (p27/100); // float, m√°s estable
      if (!isFinite(Vproj) || Vproj < 1) continue;

      const { shares, total:tot24 } = AT27_GG_shares2024(row24);
      if (!Object.keys(shares).length || !tot24) continue;

      // votos base 2027 por partido (manteniendo shares 2024) en float
      const vBase = {};
      for (const [sigla,sh] of Object.entries(shares)){
        vBase[sigla.toUpperCase()] = sh * Vproj;
      }

      // puntero y tu partido
      let L=null, vL=-1;
      for (const [sig, vv] of Object.entries(vBase)){ if (vv>vL){ vL=vv; L=sig; } }
      const vX = vBase[X] || 0;

      const faltanFloat = Math.max(0, (vL - vX) + 1);
      const swingFloat  = Math.max(0, faltanFloat / 2);

      perSec[AT27_GG_sec(sec)] = { winner:L, vL, vX, faltan:faltanFloat, swing:swingFloat, p27, Vproj };

      if (faltanFloat<=0 && L===X) ganadas++;
      votosTotalParaGanar += Math.ceil(faltanFloat);
      swingTotal         += Math.ceil(swingFloat);
    }

    return { perSec, resumen: { votosTotalParaGanar, swingTotal, ganadas, total:Object.keys(perSec).length } };
  }


  // ---------- Overlay ----------
    function AT27_GG_clearOverlay(){
      const map = window.AT_CTX?.map || window.map; if (!map) return;
      if (window.AT27_GG_LAYER){ try{ map.removeLayer(AT27_GG_LAYER); }catch(_){ } window.AT27_GG_LAYER=null; }
      window.AT27_GG_LAYERS_BY_SEC = {}; // reset √≠ndice de layers
    }

    function AT27_GG_buildOverlay(perSec){
      const map  = window.AT_CTX?.map || window.map;
      const base = window.AT_CTX?.layer?.toGeoJSON?.() || window.AT_DATA;
      if (!map || !base?.features) return;

      AT27_GG_clearOverlay(); // <- evita sobreponer capas

      if (map.createPane && !map.getPane('at27_gg_pane')){
        map.createPane('at27_gg_pane');
        const p = map.getPane('at27_gg_pane');
        p.style.zIndex = 675;
        p.style.pointerEvents = 'auto';
      }

      const features = base.features.filter(f=>{
        const id = AT27_GG_sec(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
        return perSec[id]!=null;
      });

      const layer = L.geoJSON({type:'FeatureCollection', features}, {
        pane:'at27_gg_pane',
        style: f=>{
          const id = AT27_GG_sec(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
          const win = perSec[id]?.winner || 'OTHER';
          const col = AT27_GT_GANAR_COLORS[win] || AT27_GT_GANAR_COLORS.OTHER;
          return { color:col, weight:1, opacity:.9, fillColor:col, fillOpacity:AT27_GT_GANAR_FILL };
        },
        onEachFeature: (feature, lyr)=>{
          const idRaw = feature.properties?.ID ?? feature.properties?.SECCION ?? feature.properties?.id;
          const id    = AT27_GG_sec(idRaw);
          // indexa con alias (141, 0141, etc.)
          [ id, id.padStart(4,'0'), String(Number(id)) ].forEach(k => { window.AT27_GG_LAYERS_BY_SEC[k] = lyr; });

          const info = perSec[id]; if (!info) return;
          const p = (x)=> isFinite(x) ? x.toFixed(1)+'%' : '‚Äî';
          const tip = `<div style="font-size:12px;">
            Secci√≥n <b>${id}</b><br>
            Proyecci√≥n 2027*: <b>${p(info.p27)}</b> ¬∑ Votos proj: <b>${Math.round(info.Vproj).toLocaleString()}</b><br>
            L√≠der: <b>${info.winner}</b> ${Math.round(info.vL).toLocaleString()} vs T√∫: <b>${Math.round(info.vX).toLocaleString()}</b><br>
            Faltan: <b>${Math.max(0, Math.ceil(info.faltan)).toLocaleString()}</b> ¬∑ Swing: <b>${Math.max(0, Math.ceil(info.swing)).toLocaleString()}</b>
          </div>`;
          lyr.bindTooltip(tip, { sticky:true, opacity:0.95, direction:'top', className:'at27-tt' });
          lyr.on('mouseover', ()=> lyr.setStyle({weight:2}));
          lyr.on('mouseout',  ()=> lyr.setStyle({weight:1}));
        }
      });

      layer.addTo(map);
      window.AT27_GG_LAYER = layer;
    }


  function AT27_GG_updateOpacity(){
    if (window.AT27_GG_LAYER) window.AT27_GG_LAYER.setStyle({ fillOpacity: AT27_GT_GANAR_FILL });
  }


  function AT27_GG_focusSection(sec){
    const base = AT27_GG_sec(sec);
    const dict = window.AT27_GG_LAYERS_BY_SEC || {};
    const candidates = [ base, base.padStart(4,'0'), String(Number(base)) ];
    let lyr = null;
    for (const k of candidates){ if (dict[k]) { lyr = dict[k]; break; } }

    const map = window.AT_CTX?.map || window.map;
    if (!map){ console.warn('No hay mapa'); return; }

    if (!lyr){
      // Fallback: buscar el feature en el universo y centrarlo
      const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];
      const feat = feats.find(f=>{
        const pid = AT27_GG_sec(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
        const cands = [ pid, pid.padStart(4,'0'), String(Number(pid)) ];
        return cands.some(x => candidates.includes(x));
      });
      if (feat){
        const tmp = L.geoJSON(feat);
        try{ map.fitBounds(tmp.getBounds(), {maxZoom:16, padding:[20,20]}); }catch(_){}
        return;
      }
      console.warn('No encontr√© layer ni feature para', base);
      return;
    }

    try{ map.fitBounds(lyr.getBounds(), { maxZoom:16, padding:[20,20] }); }catch(_){}
    if (lyr.openTooltip) lyr.openTooltip();

    // flash
    const orig = AT27_GT_GANAR_FILL;
    lyr.setStyle({ weight:3, fillOpacity:Math.min(0.9, orig+0.25) });
    if (lyr.bringToFront) lyr.bringToFront();
    setTimeout(()=> lyr.setStyle({ weight:1, fillOpacity:orig }), 1200);
  }


  // ---------- Panel ----------
  function AT27_GG_getOrCreatePanel(){
    let panel = document.getElementById('AT27_GG_panel');
    if (panel) return panel;

    panel = document.createElement('div');
    panel.id = 'AT27_GG_panel';
    Object.assign(panel.style,{
      position:'fixed', right:'24px', top:'24px', zIndex:9999,
      width: Math.min(480, window.innerWidth - 64) + 'px', background:'#fff',
      border:'1px solid #e5e7eb',
      maxWidth:  'calc(100vw - 48px)',
      maxHeight: 'calc(100vh - 48px)',
      borderRadius:'14px', boxShadow:'0 18px 40px rgba(0,0,0,.18)',
      height:'auto',
      overflow:'hidden', fontFamily:'system-ui, Segoe UI, Roboto, Arial',
      resize:'both', minWidth:'360px', minHeight:'300px', display:'flex',
      flexDirection:'column'
    });
    panel.innerHTML = `
      <div id="AT27_GG_hdr" style="cursor:move; user-select:none; background:#ffe4ef; color:#111; padding:10px 12px; display:flex; gap:10px; align-items:center;">
        <div style="font-weight:800;">¬øQu√© se requiere para ganar todo?</div>
        <button id="AT27_GG_close" title="Cerrar" style="margin-left:auto;background:transparent;color:#111;border:none;font-size:18px;cursor:pointer;">√ó</button>
      </div>
      <div id="AT27_GG_body" style="padding:12px 14px; flex:1; overflow:auto;">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
          <label style="display:flex;flex-direction:column;gap:6px;">
            <span style="font-size:12px;color:#334155;">Puesto</span>
            <select id="AT27_GG_selPuesto" style="background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:8px;">
              ${Object.entries(AT27_GT_GANAR_PUESTOS).map(([k,v])=>`<option value="${k}">${v}</option>`).join('')}
            </select>
          </label>
          <label style="display:flex;flex-direction:column;gap:6px;">
            <span style="font-size:12px;color:#334155;">Partido</span>
            <select id="AT27_GG_selPartido" style="background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:8px;">
              ${AT27_GT_GANAR_PARTIDOS.map(p=>`<option>${p}</option>`).join('')}
            </select>
          </label>
        </div>

        <div style="display:flex; align-items:center; gap:10px; margin:12px 0;">
          <div style="font-size:12px;color:#334155;">Opacidad</div>
          <input id="AT27_GG_opacity" type="range" min="0.1" max="0.9" step="0.05" value="${AT27_GT_GANAR_FILL}" style="flex:1;">
        </div>

        <button id="AT27_GG_run" class="ttb-btn ttb-primary" style="width:100%; background:#f4a3b9; border-color:#f4a3b9; color:#111; font-weight:700;">Ejecutar Consulta</button>

        <div id="AT27_GG_summary" style="margin-top:10px; font-size:13px; color:#334155;"></div>

        <div style="margin-top:10px; border:1px solid #f1f5f9; border-radius:10px; overflow:hidden;">
          <table style="width:100%; border-collapse:collapse; font-size:13px;">
            <thead style="background:#f8fafc;">
              <tr>
                <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">Secci√≥n</th>
                <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">Partido Ganador</th>
                <th style="text-align:right; padding:8px; border-bottom:1px solid #e5e7eb;">Votos</th>
                <th style="text-align:right; padding:8px; border-bottom:1px solid #e5e7eb;">Faltan</th>
              </tr>
            </thead>
            <tbody id="AT27_GG_tbody"></tbody>
          </table>
        </div>
      </div>
    `;
    document.body.appendChild(panel);

    function clampToViewport(el){
      const vw = window.innerWidth, vh = window.innerHeight;
      const r = el.getBoundingClientRect();
      let left = r.left, top = r.top;
      if (r.right  > vw - 16) left -= (r.right  - (vw - 16));
      if (r.bottom > vh - 16) top  -= (r.bottom - (vh - 16));
      if (left < 16) left = 16;
      if (top  < 16) top  = 16;
      el.style.left = left + 'px';
      el.style.top  = top  + 'px';
      el.style.right = 'auto';
    }
    clampToViewport(panel);
    window.addEventListener('resize', ()=>clampToViewport(panel));


    panel.querySelector('#AT27_GG_close').onclick = ()=>{ AT27_GG_clearOverlay(); panel.remove(); };

    // drag
    (function drag(panel, handle){
      let sx=0, sy=0, ox=0, oy=0, dragging=false;
      handle.addEventListener('mousedown', e=>{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panel.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });
      window.addEventListener('mousemove', e=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panel.style.left=(ox+dx)+'px'; panel.style.top=(oy+dy)+'px'; panel.style.right='auto'; });
      window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; });
    })(panel, panel.querySelector('#AT27_GG_hdr'));

    // listeners
    panel.querySelector('#AT27_GG_opacity').addEventListener('input', e=>{ AT27_GT_GANAR_FILL = Number(e.target.value); AT27_GG_updateOpacity(); });

    return panel;
  }

    // ---------- Render tabla + resumen ----------
    function AT27_GG_renderTabla(perSec, partidoSel){
      const tb = document.getElementById('AT27_GG_tbody');
      const party = partidoSel.toUpperCase();

      const rows = Object.entries(perSec).map(([sec, info])=>{
        return { sec: AT27_GG_sec(sec), winner: info.winner, vL: info.vL, faltan: Math.ceil(info.faltan) };
      }).sort((a,b)=> (a.faltan - b.faltan) || (Number(a.sec) - Number(b.sec)));

      tb.innerHTML = rows.map(r=>{
        const isWin  = (r.faltan<=0 && r.winner===party);
        const isLose = (r.winner!==party);
        const bg = isWin ? '#dcfce7' : (isLose ? '#fee2e2' : '');
        return `
          <tr data-sec="${AT27_GG_sec(r.sec)}" style="${bg?`background:${bg};`:''} cursor:pointer;">
            <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;">${r.sec}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;">${r.winner}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;">${Math.round(r.vL).toLocaleString()}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right; ${r.faltan>0?'color:#dc2626;':''}">${r.faltan>0 ? r.faltan.toLocaleString() : '0'}</td>
          </tr>
        `;
      }).join('');

      // Delegaci√≥n: un solo listener, aunque repintes la tabla
      tb.onclick = (e)=>{
        const tr = e.target.closest('tr[data-sec]');
        if (!tr) return;
        const sec = tr.getAttribute('data-sec');
        AT27_GG_focusSection(sec);
      };
    }


  function AT27_GG_renderResumen(resumen, partidoSel){
    const el = document.getElementById('AT27_GG_summary');
    el.innerHTML = `
      <div><b>Partido:</b> ${partidoSel}</div>
      <div style="display:flex; gap:12px; flex-wrap:wrap; margin-top:6px;">
        <span>Secciones ya ganadas: <b>${resumen.ganadas}</b> / ${resumen.total}</span>
        <span>Votos para ganar todo: <b>${resumen.votosTotalParaGanar.toLocaleString()}</b></span>
        <span>Swing total (equivalente): <b>${resumen.swingTotal.toLocaleString()}</b></span>
      </div>
    `;
  }

  // ---------- Update (recalcular) ----------
  async function AT27_GG_run(){
    if (window.AT27_GG_STATE.running) return;
    window.AT27_GG_STATE.running = true;
    try{
      const panel   = AT27_GG_getOrCreatePanel();
      const puesto  = panel.querySelector('#AT27_GG_selPuesto').value;
      const partido = panel.querySelector('#AT27_GG_selPartido').value;

      const secIds = AT27_GG_getUniverseSecIds();
      if (!secIds.length){
        AT27_GG_clearOverlay();
        document.getElementById('AT27_GG_tbody').innerHTML = '';
        document.getElementById('AT27_GG_summary').innerHTML = 'Sin secciones en el universo actual.';
        return;
      }

      const js = await (window.loadPuesto ? loadPuesto(puesto) : getElectData(puesto));
      const { perSec, resumen } = AT27_GG_compute(js, secIds, puesto, partido);

      AT27_GG_buildOverlay(perSec);            // 1) pinta y reindexa
      AT27_GG_renderResumen(resumen, partido); // 2) resumen
      AT27_GG_renderTabla(perSec, partido);    // 3) tabla (usa √≠ndice ya listo)
    }catch(e){
      console.error('AT27_GG_run error:', e);
      alert('No pude ejecutar la consulta de Ganar Todo.');
    }finally{
      window.AT27_GG_STATE.running = false;
    }
  }


  // ---------- API p√∫blica ----------
  async function AT27_GT_GANAR_ejecutar(puestoInicial='A', partidoInicial='PAN'){
    const panel = AT27_GG_getOrCreatePanel();
    panel.querySelector('#AT27_GG_selPuesto').value  = puestoInicial;
    panel.querySelector('#AT27_GG_selPartido').value = partidoInicial;

    // Ejecuta SOLO al presionar el bot√≥n
    panel.querySelector('#AT27_GG_run').onclick = ()=>{
      window.AT27_GG_STATE.autorun = true; // desde ahora, si cambias universo, recalc
      AT27_GG_run();
    };

    // Cambiar selects NO ejecuta autom√°ticamente (t√∫ decides con el bot√≥n)
    panel.querySelector('#AT27_GG_selPuesto').onchange  = ()=>{};
    panel.querySelector('#AT27_GG_selPartido').onchange = ()=>{};

    AT27_GG_bindUniverseAutoRecalc();
  }

  /* ======================= FIN ¬∑ GANAR TODO / GANAR TODO ======================= */
</script>

<script>
    // Centra el mapa al universo actual (overlay o capa base)
    function AT27_fitUniverseBounds(paddingPx = 24){
      const map = window.AT_CTX?.map || window.map;
      if (!map) return;

      // 1) Si hay overlay (ej. capas pintadas), √∫salo
      const candidates = [];
      if (window.AT27_GG_LAYER?.getBounds) candidates.push(window.AT27_GG_LAYER.getBounds());
      if (window.AT27_EP_LAYER?.getBounds) candidates.push(window.AT27_EP_LAYER.getBounds()); // (si tienes Estabilidad)
      if (window.AT27_PART_LAYER?.getBounds) candidates.push(window.AT27_PART_LAYER.getBounds()); // (si tienes Participaci√≥n)

      // 2) La capa de universo visible (AT_CTX.layer)
      const baseLayer = window.AT_CTX?.layer;
      if (baseLayer?.getBounds) candidates.push(baseLayer.getBounds());

      // 3) Fallback: calcula bounds desde GeoJSON de universo
      if (!candidates.length){
        const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];
        if (feats.length){
          const tmp = L.geoJSON({type:'FeatureCollection', features:feats});
          candidates.push(tmp.getBounds());
          // no a√±adimos tmp al mapa, solo usamos sus bounds
        }
      }

      // Unir bounds y centrar
      let union = null;
      for (const b of candidates){
        if (!b || !b.isValid()) continue;
        union = union ? union.extend(b) : L.latLngBounds(b.getSouthWest(), b.getNorthEast());
      }
      if (union && union.isValid()){
        map.fitBounds(union, { padding:[paddingPx, paddingPx] });
        requestAnimationFrame(()=> AT27_flashOverlay());

      }
    }
</script>

  <script>
  function AT27__eachPath(layer, fn){
    if (!layer) return;
    if (layer.eachLayer) layer.eachLayer(l => AT27__eachPath(l, fn));
    else if (layer.setStyle) fn(layer);
  }

  // Resalta brevemente los pol√≠gonos del overlay (o la capa base si no hay overlay)
  function AT27_flashOverlay(duration=900){
    const overlays = [
      window.AT27_GG_LAYER,   // Ganar Todo
      window.AT27_EP_LAYER,   // Estabilidad (si la tienes)
      window.AT27_PART_LAYER  // Participaci√≥n (si la tienes)
    ].filter(Boolean);

    // Si no hay overlay, ‚Äúflashea‚Äù el universo base
    if (!overlays.length && window.AT_CTX?.layer) overlays.push(window.AT_CTX.layer);

    overlays.forEach(g=>{
      AT27__eachPath(g, (lyr)=>{
        const origW  = (lyr.options && lyr.options.weight) || 1;
        const origFO = (lyr.options && typeof lyr.options.fillOpacity==='number') ? lyr.options.fillOpacity : 0.35;
        try{
          lyr.setStyle({ weight: origW + 2, fillOpacity: Math.min(0.95, origFO + 0.25) });
          setTimeout(()=> lyr.setStyle({ weight: origW, fillOpacity: origFO }), duration);
        }catch(_){}
      });
    });
  }
</script>



<script>
  // ========== GANAR TODO ¬∑ AYUDA (AT27_GT_HELP_) ==========
  function AT27_GT_HELP_open(){
    let panel = document.getElementById('AT27_GT_help');
    if (panel){ panel.style.display='block'; clampToViewport(panel); return; }

    panel = document.createElement('div');
    panel.id = 'AT27_GT_help';
    Object.assign(panel.style,{
      position:'fixed', right:'24px', top:'24px', zIndex:9999,
      width: Math.min(560, window.innerWidth - 64) + 'px',
      maxWidth:'calc(100vw - 48px)', maxHeight:'calc(100vh - 48px)',
      background:'#fff', border:'1px solid #e5e7eb', borderRadius:'14px',
      boxShadow:'0 18px 40px rgba(0,0,0,.18)', overflow:'hidden',
      display:'flex', flexDirection:'column', resize:'both',
      minWidth:'380px', minHeight:'280px'
    });

    panel.innerHTML = `
      <div id="AT27_GT_help_hdr" style="cursor:move; user-select:none; background:#f0f9ff; color:#111; padding:10px 12px; display:flex; gap:10px; align-items:center;">
        <div style="font-weight:800;">‚ÑπÔ∏è Minimanual ‚Äî Ganar Todo</div>
        <button id="AT27_GT_help_close" title="Cerrar" style="margin-left:auto;background:transparent;color:#111;border:none;font-size:18px;cursor:pointer;">√ó</button>
      </div>
      <div id="AT27_GT_help_body" style="padding:12px 14px; flex:1; overflow:auto; font-family:system-ui,Segoe UI,Roboto,Arial; color:#111;">
        <p style="margin:0 0 10px; color:#475569; font-size:13px;">
          Consultas a nivel <b>universo</b> (estado/municipio/DF/DL) con drill-down a secci√≥n. Se recalculan con el universo visible.
        </p>

        <details open style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;">
          <summary style="cursor:pointer; font-weight:700;">Metas de participaci√≥n 2027*</summary>
          <div style="margin-top:8px; font-size:13px; color:#334155;">
            <b>Qu√© muestra:</b> si cada secci√≥n <b>cumple</b> una <b>meta</b> de participaci√≥n 2027* (verde), est√° <b>cerca</b> (amarillo) o <b>debajo</b> (rojo).<br>
            <b>C√≥mputo:</b> p2027* por regresi√≥n ponderada 2018/2021/2024; meta y tolerancia ajustables.<br>
            <b>C√≥mo leerlo:</b> prioriza ‚ÄúNear‚Äù; revisa promedio ponderado por LN 2024.<br>
            <b>Notas:</b> proyecci√≥n conservadora si faltan a√±os.
          </div>
        </details>

        <details style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;">
          <summary style="cursor:pointer; font-weight:700;">¬øQu√© se requiere para ganar todo? (brecha 2027)</summary>
          <div style="margin-top:8px; font-size:13px; color:#334155;">
            <b>Qu√© muestra:</b> para un <i>partido</i> y <i>puesto</i>, colorea por <b>ganador proyectado 2027*</b> (PAN=azul, PRI=rojo, PVEM=verde, MORENA=guinda) y lista por secci√≥n:
            <b>ganador</b>, <b>votos del l√≠der</b>, <b>faltan</b> y <b>swing</b>.<br>
            <b>C√≥mputo:</b> Vproj = LN(2024)√óp2027*; votos por partido = share(2024)√óVproj; faltan = max(0, vL‚àívX+1); swing = ceil(faltan/2).<br>
            <b>C√≥mo leerlo:</b> la tabla prioriza por menor ‚Äúfaltan‚Äù; clic en fila hace zoom y muestra tooltip.<br>
            <b>Notas:</b> tras el primer ‚ÄúEjecutar‚Äù, si cambias el universo se recalcula solo.
          </div>
        </details>

        <details style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;">
          <summary style="cursor:pointer; font-weight:700;">Estabilidad pol√≠tica 2018‚Äì2024</summary>
          <div style="margin-top:8px; font-size:13px; color:#334155;">
            <b>Qu√© muestra:</b> continuidad/cambio por secci√≥n (verde/amarillo/rojo) en el universo actual.<br>
            <b>Uso:</b> combina con brecha 2027 para decidir estrategia: <i>‚Äúnear‚Äù + baja estabilidad</i> = oportunidad clara.
          </div>
        </details>

        <details style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;">
          <summary style="cursor:pointer; font-weight:700;">Participaci√≥n 2018/2021/2024 ‚Üí 2027*</summary>
          <div style="margin-top:8px; font-size:13px; color:#334155;">
            <b>Qu√© muestra:</b> mapa por participaci√≥n hist√≥rica y proyecci√≥n 2027* con rangos (&lt;30% rojo, 30‚Äì50% amarillo, &gt;50% verde).<br>
            <b>Uso:</b> detecci√≥n de secciones estructuralmente bajas (movilizaci√≥n).
          </div>
        </details>

        <p style="margin:10px 0 0; color:#64748b; font-size:12px;">
          <b>Limitaci√≥n:</b> la proyecci√≥n asume shares 2024 constantes (escenario base). √ösalo como l√≠nea base, no como predicci√≥n definitiva.
        </p>
      </div>
    `;
    document.body.appendChild(panel);

    // cerrar
    panel.querySelector('#AT27_GT_help_close').onclick = ()=>{ panel.style.display='none'; };

    // drag
    (function drag(panelEl, handleEl){
      let sx=0, sy=0, ox=0, oy=0, dragging=false;
      handleEl.addEventListener('mousedown', e=>{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panelEl.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });
      window.addEventListener('mousemove', e=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panelEl.style.left=(ox+dx)+'px'; panelEl.style.top=(oy+dy)+'px'; panelEl.style.right='auto'; });
      window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; clampToViewport(panelEl); });
    })(panel, panel.querySelector('#AT27_GT_help_hdr'));

    clampToViewport(panel);

    // Evita que el panel ‚Äútape‚Äù interacciones del mapa (propagaci√≥n)
    if (window.L && L.DomEvent){
      L.DomEvent.disableClickPropagation(panel);
      L.DomEvent.disableScrollPropagation(panel);
    }
  }

  function clampToViewport(el){
    const vw = window.innerWidth, vh = window.innerHeight;
    const r = el.getBoundingClientRect();
    let left = r.left, top = r.top;
    if (r.right  > vw - 16) left -= (r.right  - (vw - 16));
    if (r.bottom > vh - 16) top  -= (r.bottom - (vh - 16));
    if (left < 16) left = 16;
    if (top  < 16) top  = 16;
    el.style.left = left + 'px';
    el.style.top  = top  + 'px';
    el.style.right = 'auto';
  }

  // Cableado del bot√≥n de ayuda (por si tu id cambia, intentamos ambos)
  (function wireGT_Help(){
    const btn = document.getElementById('btn-ayuda') || document.getElementById('btn-gt-ayuda');
    if (!btn || btn.__wiredHelp) return;
    btn.addEventListener('click', AT27_GT_HELP_open);
    btn.__wiredHelp = true;
  })();
</script>


</body>
</html>
