<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Análisis Territorial</title>
  <link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; width:100%; font-family:'Segoe UI', Arial, sans-serif; background:#f4f4f4; }
    :root{ --sidebar-w:320px; }
    #panel-lateral{
      position:absolute;
      left:0; top:0; bottom:0; width:var(--sidebar-w); height:100%;
      background: linear-gradient(180deg, #8ea3ad 0%, #dfe6e9 100%);
      color:#2c3e50; border-right:1px solid #b2bec3;
      display:flex; flex-direction:column; 
      box-shadow:2px 0 5px rgba(0,0,0,0.1); box-sizing:border-box; align-items:stretch;
      z-index:2000;
    }
    #panel-header{ background:#b2bec3; color:#2c3e50; padding:12px 15px; display:flex; align-items:center; font-size:18px; font-weight:bold; }
    #panel-header img{ height:32px; margin-right:10px; }
    #map{ position:absolute; top:0; left:var(--sidebar-w); width:calc(100% - var(--sidebar-w)); height:100%; }

    #sec-search    { position: relative; }                /* contenedor del buscador */
    #sec-suggest   { z-index: 3000; } 
    #sec-suggest {
      position: absolute;
      left: 12px; right: 12px;
      top: 46px;           /* ajusta según tu input */
      max-height: 220px;
      overflow: auto;
    }
      /* la lista queda clickeable */

/* Etiqueta de la SECCIÓN seleccionada (rosa tenue) */
.sec-label{
  background: rgba(255, 235, 238, 0.96);  /* #ffebee */
  border: 1px solid #e91e63;
  color: #880e4f;
  padding: 2px 6px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 700;
  pointer-events: none;
  white-space: nowrap;
  box-shadow: 0 2px 6px rgba(0,0,0,.15);
}

/* Etiquetas de SECCIONES ADYACENTES (azul/gris tenue) */
.sec-label-adj{
  background: rgba(227, 242, 253, 0.94);  /* #e3f2fd */
  border: 1px solid #64b5f6;
  color: #0d47a1;
  padding: 1px 5px;
  border-radius: 8px;
  font-size: 11px;
  font-weight: 600;
  pointer-events: none;
  white-space: nowrap;
  box-shadow: 0 1px 4px rgba(0,0,0,.12);
}


/* Panel flotante sección */
#sec-info {
  position: absolute;
  left: 10px; bottom: 360px;
  width: 300px; max-width: 38vw; min-width: 260px;
  background: #ffffff;
  border: 1px solid #cfd8dc;
  border-radius: 10px;
  box-shadow: 0 10px 24px rgba(0,0,0,.15);
  resize: both; overflow: auto; z-index: 4000;
  display: none;
  pointer-events: auto;
}
#sec-info .hdr {
  cursor: move;
  display:flex; align-items:center; justify-content:space-between;
  background: linear-gradient(180deg,#eceff1,#e3f2fd);
  padding: 8px 12px;
  border-bottom: 1px solid #cfd8dc;
  font-weight: 700; color: #263238;
}

#sec-info .hdr .btn-close{
  cursor: pointer;
  border: none; outline: none;
  background: #ffcdd2;         /* rosa tenue */
  color: #880e4f;
  width: 24px; height: 24px; line-height: 24px;
  border-radius: 6px;
  font-size: 16px; font-weight: 800;
}
#sec-info .hdr .btn-close:hover{ background:#ef9a9a; }
#sec-info .body { padding: 10px 12px; color: #37474f; }
#sec-info .row  { display:flex; justify-content:space-between; margin:6px 0; }
#sec-info .k    { color:#607d8b; }
#sec-info .v    { font-weight:600; }
 

  :root{
  --rail-bg:#ffffff;
  --rail-br:#cfd8dc;
  --rail-shadow:0 10px 24px rgba(0,0,0,.15);
  --fg:#263238;
  --pink:#e91e63; --pink-bg:#ffebee;
  --blue:#2196f3; --blue-bg:#e3f2fd;
  --gray:#90a4ae;
  }
  .tool-rail{
    position:absolute; right:12px; top:50%; transform:translateY(-50%);
    z-index:2600; pointer-events:auto;
    display:flex; align-items:center; gap:.5rem;
  }
  .rail-toggle{
    width:42px; height:42px; border-radius:999px;
    border:1px solid var(--rail-br); background:var(--rail-bg);
    box-shadow:var(--rail-shadow); display:grid; place-items:center; cursor:pointer;
  }
  .rail-group{
    background:var(--rail-bg); border:1px solid var(--rail-br);
    border-radius:16px; padding:.5rem; box-shadow:var(--rail-shadow);
    display:flex; flex-direction:column; gap:.5rem; transition:transform .25s ease, opacity .2s;
  }
  .rail-group.is-collapsed{ transform:scale(.98); opacity:.0; pointer-events:none; }
  .rail-sep{ height:1px; background:var(--rail-br); margin:.25rem 0; }

  .tool{
    width:44px; height:44px; border-radius:999px; cursor:pointer;
    border:1px solid var(--rail-br); background:#fff; color:var(--fg);
    display:grid; place-items:center; box-shadow:0 2px 8px rgba(0,0,0,.08);
    transition:transform .15s ease, box-shadow .15s ease, background .15s, color .15s, border-color .15s;
  }
  .tool:hover{ transform:translateY(-1px); box-shadow:0 6px 14px rgba(0,0,0,.12); }
  .tool.active{ background:var(--pink-bg); border-color:var(--pink); color:var(--pink); }
  .tool svg{ width:22px; height:22px; }

  .tool[data-tool="ganador"].active{ background:var(--blue-bg); border-color:var(--blue); color:var(--blue); }

  .tool[data-tooltip]{
    position:relative;
  }
  .tool[data-tooltip]::after{
    content:attr(data-tooltip);
    position:absolute; right:110%; top:50%; transform:translateY(-50%);
    background:#000; color:#fff; font-size:12px; padding:.25rem .5rem;
    border-radius:6px; opacity:0; pointer-events:none; white-space:nowrap;
    transition:opacity .15s;
  }
  .tool:hover::after{ opacity:.9; }

  /* 1) Colores correctos en los iconos (svg) */
  .tool { color: #607d8b; } /* gris base */
  .tool svg, .tool svg path, .tool svg use { fill: currentColor; stroke: none; }

  .tool.active{
    background: #ffebee;           /* rosa tenue */
    border-color: #e91e63;
    color: #e91e63;
  }
  .tool[data-tool="ganador"].active{
    background: #e3f2fd;           /* azul tenue */
    border-color: #2196f3;
    color: #2196f3;
  }

  /* 2) Tooltips sin “rayitas” fantasma */
  .tool[data-tooltip]{ position: relative; }
  .tool[data-tooltip]::after{
    content: attr(data-tooltip);
    position: absolute;
    right: 110%;
    top: 50%;
    transform: translateY(-50%);
    background: #000;
    color: #fff;
    font-size: 12px;
    padding: .25rem .5rem;
    border-radius: 6px;
    white-space: nowrap;

    /* clave para evitar el “rastro” */
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition: opacity .15s ease, visibility .15s ease;
  }
  .tool:hover::after{
    opacity: .95;
    visibility: visible;
  }

  /* Por si el mapa se los tragaba */
  #tool-rail{ z-index: 5000; }

  .hist-panel{position:absolute;right:18px;top:70px;width:720px;max-width:86vw;background:#fff;border:1px solid #cfd8dc;border-radius:14px;box-shadow:0 12px 28px rgba(0,0,0,.16);z-index:4800;resize:both;overflow:auto}
  .hist-panel .hdr{display:flex;gap:.75rem;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #e0e0e0;background:linear-gradient(180deg,#4a148c,#ec76c5);color:#fff}
  .hist-panel .hdr .ctl{display:flex;align-items:center;gap:.5rem}
  .hist-panel .hdr label{font-size:12px;opacity:.85}
  .hist-panel .hdr select{padding:4px 8px;border-radius:8px;border:1px solid #b0bec5}
  .hist-panel .btn-close{cursor:pointer;border:none;background:#ffcdd2;color:#880e4f;width:28px;height:28px;line-height:28px;border-radius:8px;font-weight:800}
  .hist-panel .btn-close:hover{background:#ef9a9a}
  .hist-panel .body{padding:10px}
  .hist-panel .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .hist-panel .card{border:1px solid #eceff1;border-radius:10px;padding:8px}
  .hist-panel .card-h{font-weight:700;color:#263238;margin:0 0 6px}
  @media (max-width:1100px){.hist-panel{width:92vw;right:4vw}.hist-panel .grid{grid-template-columns:1fr}}


  /* El panel no debe crecer más que la ventana */
  #hist-panel{
    max-height: calc(100vh - 120px);
    overflow: hidden;
  }

  /* El área interna sí scrollea si hace falta */
  #hist-panel .body{
    max-height: calc(100vh - 170px);
    overflow: auto;
  }

  /* Cada tarjeta con alto estable */
  #hist-panel .card{
    height: 300px;                 /* ajusta 260–320 a tu gusto */
    display: flex; flex-direction: column;
  }

  /* El canvas ocupa el alto de la tarjeta (evita reflow infinito) */
  #hist-panel .card canvas{
    flex: 1;
    min-height: 240px;             /* altura mínima útil */
    height: 240px !important;      /* forzamos altura */
    width: 100% !important;
    display: block;
  }


  /* Controles del header del historial */
  .hist-panel .ctl { display:flex; align-items:center; gap:.5rem; }
  .hist-panel .ctl label { font-size:12px; opacity:.85; white-space:nowrap; }
  .hist-panel .ctl select { padding:4px 8px; border-radius:8px; border:1px solid #b0bec5; }

  .hist-panel .btn { cursor:pointer; border:1px solid #b0bec5; background:#fff;
    border-radius:8px; padding:4px 8px; font-size:12px; }
  .hist-panel .btn:hover{ background:#f3f6f9; }
  .hist-panel .btn-pink{ background:#ffe6ee; border-color:#f48fb1; color:#dd56d2; }
  .hist-panel .btn-blue{ background:#e3f2fd; border-color:#90caf9; color:#0d47a1; }

  /* Altos/scroll estables de las tarjetas/canvas */
  #hist-panel{ max-height:calc(100vh - 120px); overflow:hidden; }
  #hist-panel .body{ max-height:calc(100vh - 170px); overflow:auto; }
  #hist-panel .card{ height:300px; display:flex; flex-direction:column; }
  #hist-panel .card canvas{ flex:1; min-height:240px; height:240px !important; width:100% !important; display:block; }


    /* Barra superior */
    .ttb .ttb-wrap{
      display:flex; align-items:center; gap:.5rem;
      background:#ffffffcc; backdrop-filter: blur(6px);
      border:1px solid #cfd8dc; border-radius:12px; padding:8px 10px;
      box-shadow:0 10px 24px rgba(0,0,0,.12);
    }
    .ttb-btn{
      border:1px solid #b0bec5; background:#fff; color:#37474f;
      border-radius:10px; padding:6px 10px; cursor:pointer; font-size:13px;
    }
    .ttb-btn:hover{ background:#f5f7f9; }
    .ttb-primary{ background:#e3f2fd; border-color:#90caf9; color:#0d47a1; }
    .ttb-help{ background:#ffe6ee; border-color:#f48fb1; color:#880e4f; }
    .ttb-sep{ width:1px; height:26px; background:#e0e0e0; }
    .ttb-label{ font-size:12px; color:#455a64; }
    .ttb-select{
      padding:5px 8px; border:1px solid #b0bec5; border-radius:8px; font-size:13px;
    }

    /* Modal de ayuda */
    .hm{ position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:5300; display:grid; place-items:center; }
    .hm-content{
      width:min(860px, 92vw); max-height:80vh; overflow:auto;
      background:#fff; border:1px solid #cfd8dc; border-radius:14px; box-shadow:0 16px 40px rgba(0,0,0,.28);
    }
    .hm-hdr{ display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px; border-bottom:1px solid #e0e0e0; background:linear-gradient(180deg,#eceff1,#e3f2fd); }
    .hm-body{ padding:12px; }
    .hm details{ border:1px solid #eceff1; border-radius:10px; padding:8px 10px; margin-bottom:8px; }
    .hm summary{ cursor:pointer; font-weight:600; color:#263238; }
    .btn-close{ cursor:pointer; border:none; background:#ffcdd2; color:#880e4f; width:28px;height:28px;line-height:28px;border-radius:8px;font-weight:800 }
    .btn-close:hover{ background:#ef9a9a; }




  </style>
</head>
<body>
  <div id="panel-lateral">
    <div id="panel-header">
      <!-- <img src="assets/img/logo.png" alt="Logo"/> -->
      <span>Análisis Territorial</span>
    </div>
    <!-- Aquí va el contenido del panel lateral -->

    <!-- Buscador de secciones -->
    <div id="sec-search" style="padding:10px 12px; border-top:1px solid #cbd5e1; background:#eef2f7">
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="sec-q" type="text" placeholder="Buscar sección (ej. 1234 o '1234 León')" autocomplete="off" autocorrect="off" spellcheck="false" enterkeyhint="search"
              style="flex:1; padding:6px 8px; border:1px solid #94a3b8; border-radius:6px;">
        <label style="white-space:nowrap; font-size:12px;">
          <input id="sec-global" type="checkbox"> Todo el estado
        </label>
      </div>
      <ul id="sec-suggest" style="margin:8px 0 0 0; padding:0; list-style:none; max-height:180px; overflow:auto;
                                  border:1px solid #cbd5e1; border-radius:6px; background:#fff; display:none;"></ul>
    </div>



    <div id="mini-universe" style="padding:12px 12px 6px 12px; background:#eef2f7; border-top:1px solid #cbd5e1">
        <div class="row" style="margin-bottom:8px">
            <label><input type="checkbox" id="mini-all-state"> Estado completo</label>
        </div>
        <div class="row" style="margin-bottom:8px">
            <label>Municipio</label>
            <select id="mini-sel-mun" style="width:100%;padding:6px"><option value="">— Ninguno —</option></select>
        </div>
        <div class="row" style="margin-bottom:8px">
            <label>Distrito Federal</label>
            <select id="mini-sel-df" style="width:100%;padding:6px"><option value="">— Ninguno —</option></select>
        </div>
        <div class="row" style="margin-bottom:8px">
            <label>Distrito Local</label>
            <select id="mini-sel-dl" style="width:100%;padding:6px"><option value="">— Ninguno —</option></select>
        </div>
        <div class="hint" style="font-size:12px;color:#64748b">Elige solo uno. Al cambiar, el mapa se actualiza.</div>
    </div>

  </div>
  <div id="map"></div>

    <div id="hist-panel" class="hist-panel" style="display:none">
    <div class="hdr">
      <div class="ttl">
        <strong>Historial</strong> · Sección <span id="hist-sec">—</span>
      </div>
      <div class="ctl">
        <label for="hist-puesto">Puesto</label>
        <select id="hist-puesto">
          <option value="P">Presidente</option><option value="S">Senador</option><option value="G">Gobernador</option>
          <option value="DF">Diputado Federal</option><option value="DL">Diputado Local</option><option value="A">Ayuntamiento</option>
        </select>
        <button id="hist-close" class="btn-close" aria-label="Cerrar">×</button>
      </div>
    </div>
    <div class="body">
      <div class="grid">
        <div class="card"><div class="card-h">Historial por año (votos)</div><canvas id="hist-bar"></canvas></div>
        <div class="card"><div class="card-h">Ganadores 2018–2024 (votos)</div><canvas id="hist-win"></canvas></div>
        <div class="card"><div class="card-h">Competencia 2024 (% del total)</div><canvas id="hist-pie"></canvas></div>
      </div>
    </div>
  </div>




      <!-- Sprite de íconos (inline, sin dependencias) -->
    <svg style="display:none">
      <symbol id="ic-history" viewBox="0 0 24 24">
        <path d="M13 3a9 9 0 1 1-9 9H2l3.5-3.5L9 12H6a7 7 0 1 0 7-7v2h-2V3zM12 7h2v5l3 1-0.5 1.9L12 13V7z"/>
      </symbol>
      <symbol id="ic-trophy" viewBox="0 0 24 24">
        <path d="M18 2H6v2H3v3a5 5 0 0 0 5 5 5 5 0 0 0 4 2 5 5 0 0 0 4-2 5 5 0 0 0 5-5V4h-3V2zM5 6V6.2A3 3 0 0 0 8 9a7 7 0 0 1-3-3zM19 6v.2A3 3 0 0 1 16 9a7 7 0 0 0 3-3zM10 16h4v2h-4v-2zm-2 4h8v2H8v-2z"/>
      </symbol>
      <symbol id="ic-compare" viewBox="0 0 24 24">
        <path d="M10 3H5v18h5V3zm9 0h-5v18h5V3zM8 7h1v10H8V7zm7 0h1v10h-1V7z"/>
      </symbol>
      <symbol id="ic-forecast" viewBox="0 0 24 24">
        <path d="M6 19a4 4 0 1 1 1-7.874A6 6 0 1 1 18 18H6zm0-2h12a4 4 0 1 0-1.264-7.787A6.002 6.002 0 0 0 6.126 13H6a2 2 0 1 0 0 4z"/>
      </symbol>
      <symbol id="ic-download" viewBox="0 0 24 24">
        <path d="M12 3v10l4-4 1.4 1.4L12 16 6.6 10.4 8 9l4 4V3h0zM5 19h14v2H5v-2z"/>
      </symbol>
      <symbol id="ic-menu" viewBox="0 0 24 24">
        <path d="M4 7h16v2H4V7zm0 4h16v2H4v-2zm0 4h10v2H4v-2z"/>
      </symbol>
    </svg>

    <!-- Rail de herramientas -->
    <div id="tool-rail" class="tool-rail">
      <button class="rail-toggle" id="railToggle" aria-label="Mostrar/ocultar">
        <svg><use href="#ic-menu"></use></svg>
      </button>

      <div class="rail-group" id="railGroup">
        <button class="tool" data-tool="historial"  data-tooltip="Historial">
          <svg><use href="#ic-history"></use></svg>
        </button>
        <button class="tool" data-tool="ganador"    data-tooltip="Ganador">
          <svg><use href="#ic-trophy"></use></svg>
        </button>
        <button class="tool" data-tool="competencia" data-tooltip="Competencia">
          <svg><use href="#ic-compare"></use></svg>
        </button>
        <button class="tool" data-tool="proyeccion" data-tooltip="Proyección">
          <svg><use href="#ic-forecast"></use></svg>
        </button>

        <div class="rail-sep"></div>

        <button class="tool" data-tool="exportar"   data-tooltip="Exportar">
          <svg><use href="#ic-download"></use></svg>
        </button>
      </div>
    </div>


  <!-- === SCRIPT ÚNICO === -->
  <script>

  // Evita que la barra capture scroll/clicks del mapa
    (function wireTopBar(){
      const bar = document.getElementById('top-toolbar');
      if (!bar || bar.__wired) return;
      if (window.L && L.DomEvent){
        L.DomEvent.disableClickPropagation(bar);
        L.DomEvent.disableScrollPropagation(bar);
      }
      // Botones
      document.getElementById('btn-historial')?.addEventListener('click', ()=> {
        if (typeof openHistorialUI === 'function') openHistorialUI();
      });
      document.getElementById('btn-abrir-comp')?.addEventListener('click', ()=> {
        const kind = document.getElementById('comp-metric')?.value || 'ganador';
        if (typeof openComparativaUI === 'function') openComparativaUI(kind);
      });
      document.getElementById('btn-ayuda')?.addEventListener('click', openHelpModal);
      // Atajos: H historial, C comparativa, ? ayuda
      document.addEventListener('keydown', (e)=>{
        if (e.key==='H' || e.key==='h'){ e.preventDefault(); if (typeof openHistorialUI==='function') openHistorialUI(); }
        if (e.key==='C' || e.key==='c'){ e.preventDefault(); const k=document.getElementById('comp-metric')?.value||'ganador'; if (typeof openComparativaUI==='function') openComparativaUI(k); }
        if (e.key==='?' ){ e.preventDefault(); openHelpModal(); }
      });
      bar.__wired = true;
    })();

    // ===== Ayuda: acordeón =====
    const HELP_ITEMS = [
      {
        id:'historial',
        title:'Historial (sección)',
        short:'Tres gráficas: votos por partido 2018–2024, ganador por año y pastel de competencia del último año.',
        bullets:[
          'Toma la sección seleccionada (resaltada).',
          'Selector de puesto (P/S/G/DF/DL/A).',
          'Pastel: por defecto el último año disponible; puedes cambiarlo.',
        ]
      },
      {
        id:'comp-ganador',
        title:'Ganador + margen (sección)',
        short:'Muestra votos por partido del año elegido y resume ganador, votos y margen absoluto/%.',
        bullets:[
          'Elige puesto y año en el panel.',
          'Útil para ver cuán “segura”/“competida” es la sección en ese año.',
        ]
      },
      {
        id:'comp-participacion',
        title:'Participación (sección)',
        short:'Serie histórica de participación (VOTOS/LN %) por año disponible.',
        bullets:[
          'Calculada al vuelo con VOTOS/LN del puesto elegido.',
          'Para P/S/G sólo 2018 y 2024; para DF/DL/A incluye 2021.',
        ]
      },
      // Placeholders de futuras métricas (cuando las integremos):
      { id:'comp-margen-tiempo', title:'Margen en el tiempo (sección)', short:'Evolución del margen entre 1º y 2º lugar por año.', bullets:['Detecta si la sección se volvió más competida o más segura.'] },
      { id:'comp-swing', title:'Swing (sección)', short:'Cambio de votos/participación por partido entre elecciones.', bullets:['Mide ganancia/pérdida relativa de cada partido.'] },
      { id:'comp-h2h', title:'Head-to-Head PAN vs MORENA', short:'Ventaja en votos/% por año entre PAN y MORENA.', bullets:['Línea con valores ± y ganador del duelo.'] },
      { id:'comp-hhi', title:'Competitividad (HHI)', short:'Índice de concentración (∑ share²).', bullets:['Bajo = competido; alto = concentrado.'] },
      { id:'comp-vol', title:'Volatilidad (Pedersen)', short:'Suma de cambios absolutos en shares / 2.', bullets:['Cuánta “movida” hubo entre elecciones.'] },
      { id:'comp-proy', title:'Proyección simple', short:'Tendencia lineal por partido y pronóstico.', bullets:['Exploratorio; con cautela.'] },
    ];

    function openHelpModal(){
      const modal = document.getElementById('help-modal');
      const body  = document.getElementById('help-accordion');
      if (!modal || !body) return;
      if (!body.__built){
        body.innerHTML = HELP_ITEMS.map(it => `
          <details>
            <summary>${it.title}</summary>
            <p style="margin:.4rem 0;color:#37474f">${it.short}</p>
            ${it.bullets?.length ? `<ul style="margin:.2rem 0 .6rem 1rem">${it.bullets.map(b=>`<li>${b}</li>`).join('')}</ul>` : ''}
          </details>
        `).join('');
        body.__built = true;
      }
      modal.style.display='grid';
      document.getElementById('help-close')?.addEventListener('click', ()=> modal.style.display='none', { once:true });
      // Cierra con click fuera
      modal.addEventListener('click', (e)=>{ if (e.target === modal) modal.style.display='none'; }, { once:true });
    }



    
  document.addEventListener('DOMContentLoaded', () => {
    if (window.Chart && window.ChartDataLabels) {
      Chart.register(ChartDataLabels);
    }
    // …tu código que crea gráficas…
  });



  // ===== 0) Campos (ajusta si tus nombres son distintos) =====
  // DL = Distrito Local, DF = Distrito Federal
  const FIELD_KEYS = { mun: 'MUNICIPIO', dl: 'DISTRITO_L', df: 'DISTRITO_F' };


    const paths = JSON.parse(localStorage.getItem('AT_PATHS')||'{}');
    const urlGeo = paths.geo || 'data/geo/secciones.geojson';
    const catUrl = paths.catalog || 'data/catalogo_territorial.json';
    const ELP = paths.electoral?.P || 'data/electoral/P.json';
  // ...

  // Chart.js v4 necesita registrar el plugin explícitamente
  if (window.Chart && window.ChartDataLabels){
    Chart.register(ChartDataLabels);
  }

  
  // Asegura etiquetas numéricas en gráficos
  if (window.Chart && window.ChartDataLabels) {
    Chart.register(ChartDataLabels);
  }




  // ===== 1) Mapa único y chequeo =====
  function ensureLeafletMap() {
    if (window.__AT_MAP && window.__AT_MAP instanceof L.Map) return window.__AT_MAP;
    const m = L.map('map', { zoomControl:true }).setView([21.0, -101.3], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'© OSM' }).addTo(m);
    window.__AT_MAP = m;
    return m;
  }
  function assertIsLeafletMap(m) {
    if (!(m instanceof L.Map) || typeof m.addLayer !== 'function') {
      throw new Error('[AT] addTo(): destino no es un Leaflet Map. Revisa variables llamadas "map" o dobles inicializaciones.');
    }
  }

  function closeSecInfoPanel(){
    const box = document.getElementById('sec-info');
    if (box) box.style.display = 'none';
    // Si quieres limpiar resaltado y etiquetas al cerrar:
    if (typeof clearSectionOverlays === 'function') clearSectionOverlays();
  }


  function ensureSecInfoPanelWired(){
  const box = document.getElementById('sec-info');
  const hdr = box?.querySelector('.hdr');
  if (!box || !hdr || box.__wired) return;

  // Bloquear propagación al mapa (no “parpadea” al arrastrar)
  if (window.L && L.DomEvent){
    L.DomEvent.disableClickPropagation(box);
    L.DomEvent.disableScrollPropagation(box);
  }

  // Drag del panel
  let dragging = false, sx=0, sy=0, bx=0, by=0;
  hdr.addEventListener('mousedown', (e)=>{
    if (e.target.closest('.btn-close')) return; // no iniciar drag si clic en "×"
    e.preventDefault(); e.stopPropagation();
    dragging = true;
    const r = box.getBoundingClientRect();
    sx = e.clientX; sy = e.clientY; bx = r.left; by = r.top;
    box.style.position = 'absolute'; box.style.right='auto'; box.style.bottom='auto';
    document.body.style.userSelect = 'none';
  });
  window.addEventListener('mousemove', (e)=>{
    if (!dragging) return;
    e.preventDefault(); e.stopPropagation();
    const dx = e.clientX - sx, dy = e.clientY - sy;
    box.style.left = (bx + dx) + 'px';
    box.style.top  = (by + dy) + 'px';
  });
  window.addEventListener('mouseup', ()=>{
    if (!dragging) return;
    dragging = false; document.body.style.userSelect = '';
  });

  // Botón “×”
  const btn = document.getElementById('sec-close');
  if (btn && !btn.__wired){
    btn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); closeSecInfoPanel(); });
    btn.__wired = true;
  }

  box.__wired = true;
}



  // ===== 2) Filtrado por universo =====
  function toComp(v){ if(v==null) return ''; const s=String(v).trim(); return (isFinite(s) && s!=='') ? Number(s) : s.toUpperCase(); }
  function matches(props, u){
    if(u.scope==='ALL') return true;
    const keyField = u.scope==='MUN' ? FIELD_KEYS.mun : (u.scope==='DL' ? FIELD_KEYS.dl : FIELD_KEYS.df);
    return toComp(props?.[keyField]) === toComp(u.key);
  }
  function filterGeojson(geojson, u){
    if(u.scope==='ALL') return geojson;
    const features = (geojson.features || []).filter(f => matches(f.properties, u));
    return { ...geojson, features };
  }


  // ====== CARGA ELECTORAL (para obtener 24DL_LN) ======
  function getPaths(){ try{ return JSON.parse(localStorage.getItem('AT_PATHS')||'{}'); }catch{ return {}; } }
  function getPuestoPath(p){ const paths = getPaths(); return paths?.electoral?.[p] || `data/electoral/${p}.json`; }

  window.AT_ELECT = window.AT_ELECT || {};
  async function getElectData(puesto){
    if (window.AT_ELECT[puesto]) return window.AT_ELECT[puesto];
    const res = await fetch(getPuestoPath(puesto));
    if (!res.ok) throw new Error(`HTTP ${res.status} en ${puesto}`);
    const js = await res.json();
    window.AT_ELECT[puesto] = js;
    return js;
  }
  // LN para 2024 desde DL; si no hay, intenta P (fallback)
  async function getLN24DL(sec){
    const key = String(sec);
    try {
      const dl = await getElectData('DL');
      const ln = dl?.secciones?.[key]?.["2024"]?.LN;
      if (typeof ln === 'number') return ln;
    } catch(_){}
    try {
      const p = await getElectData('P');
      const ln = p?.secciones?.[key]?.["2024"]?.LN;
      if (typeof ln === 'number') return ln;
    } catch(_){}
    return null;
  }

  // ====== ADYACENCIAS (Turf) ======
  function bboxIntersects(b1, b2){
    return !(b2[0] > b1[2] || b2[2] < b1[0] || b2[1] > b1[3] || b2[3] < b1[1]);
  }
  function getAdjacents(feat){
    const all = (window.AT_DATA?.features)
            || (window.AT_CTX?.layer?.toGeoJSON?.()?.features)
            || [];
    if (!all.length) return [];
    const b1 = turf.bbox(feat);
    const out = [];
    const sec1 = feat.properties?.SECCION;
    for (const f of all){
      const p = f.properties || {};
      if (p.SECCION === sec1) continue;
      const b2 = turf.bbox(f);
      if (!bboxIntersects(b1,b2)) continue;
      try {
        if (turf.booleanTouches(feat, f) || turf.booleanOverlap(feat, f) || turf.booleanIntersects(feat, f)){
          out.push(f);
        }
      } catch(_){}
    }
    return out.slice(0, 25); // cota de seguridad
  }

  // ====== LABELS SOBRE EL MAPA ======
  function addLabelForFeature(feat, className, text){
    try {
      const c = turf.centerOfMass(feat).geometry.coordinates; // [lon, lat]
      const m = L.marker([c[1], c[0]], { icon: L.divIcon({ className, html: text, iconSize:[0,0] }) });
      window.__SEC_LABELS = window.__SEC_LABELS || L.layerGroup().addTo(ensureLeafletMap());
      window.__SEC_LABELS.addLayer(m);
      return m;
    } catch(_){}
    return null;
  }

  function clearSectionOverlays(){
    const atMap = ensureLeafletMap();
    if (window.__SEC_HL){ try{ atMap.removeLayer(__SEC_HL); }catch(_){ } window.__SEC_HL = null; }
    if (window.__SEC_ADJ){ try{ atMap.removeLayer(__SEC_ADJ); }catch(_){ } window.__SEC_ADJ = null; }
    if (window.__SEC_LABELS){ try{ atMap.removeLayer(__SEC_LABELS); }catch(_){ } window.__SEC_LABELS = null; }
  }

  // Dibuja selección + adyacentes + labels
  function paintSelectionAndAdj(feat){
    const atMap = ensureLeafletMap();
    clearSectionOverlays();

    // resaltado principal
    window.__SEC_HL = L.geoJSON(feat, { style:{ color:'#e91e63', weight:3, fillOpacity:0.25 } }).addTo(atMap);
    try { atMap.fitBounds(window.__SEC_HL.getBounds(), { padding:[28,28] }); } catch(_){}

    // adyacentes
    const adj = getAdjacents(feat);
    if (adj.length){
      window.__SEC_ADJ = L.geoJSON({type:'FeatureCollection', features:adj}, { style:{ color:'#90a4ae', weight:1.2, dashArray:'4,4', fillOpacity:0.05 } }).addTo(atMap);
    }

    // labels
    const sec = feat.properties?.SECCION ?? '—';
    addLabelForFeature(feat, 'sec-label', `Sección ${sec}`);
    for (const f of adj){
      const s2 = f.properties?.SECCION ?? '—';
      addLabelForFeature(f, 'sec-label-adj', s2);
    }
  }

  // ====== PANEL FLOTANTE (drag + datos) ======
  (function wireSecInfoPanel(){
    const box = document.getElementById('sec-info');
    const hdr = box?.querySelector('.hdr');
    if (!box || !hdr || box.__wired) return;
    let dragging = false, sx=0, sy=0, bx=0, by=0;
    hdr.addEventListener('mousedown', (e)=>{
      dragging=true; sx=e.clientX; sy=e.clientY;
      const r = box.getBoundingClientRect(); bx=r.left; by=r.top;
      document.body.style.userSelect='none';
    });
    window.addEventListener('mousemove', (e)=>{
      if (!dragging) return;
      const dx = e.clientX - sx, dy = e.clientY - sy;
      box.style.left = (bx + dx) + 'px';
      box.style.top  = (by + dy) + 'px';
      box.style.right = 'auto'; box.style.bottom='auto';
      box.style.position = 'absolute';
    });
    window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; });
    box.__wired = true;
  })();

  async function showSectionInfo(feat){
    ensureSecInfoPanelWired();
    const p = feat.properties || {};
    const sec = p.SECCION ?? '—';
    const df  = p[FIELD_KEYS.df] ?? '—';
    const dl  = p[FIELD_KEYS.dl] ?? '—';

    // LN 24DL_LN
    let ln = await getLN24DL(sec);
    if (ln==null) ln = '—';

    // Pintar
    const box = document.getElementById('sec-info');
    box.querySelector('.hdr').textContent = `Sección ${sec}`;
    document.getElementById('si-sec').textContent = sec;
    document.getElementById('si-df').textContent  = df;
    document.getElementById('si-dl').textContent  = dl;
    document.getElementById('si-ln').textContent  = ln;
    box.style.display = 'block';
  }



  // ENTER + CLIC + ULTIMO TOKEN

    function currentNeedle(q){
      if (!q) return '';
      const parts = String(q).split(/[,;\s]+/).filter(Boolean);
      return parts.length ? parts[parts.length-1] : '';
    }

// ===== Mini-selector de universo dentro del módulo =====
    let __mini = { selMun:null, selDf:null, selDl:null, all:null };

    function uniqueSorted(values){
    const arr = values.map(v => String(v ?? '').trim()).filter(Boolean);
    const set = Array.from(new Set(arr));
    return set.sort((a,b) => (isFinite(a)&&isFinite(b)) ? Number(a)-Number(b) : a.localeCompare(b,'es'));
    }
    function buildMiniOptions(raw){
    const feats = raw.features || [];
    const grab = k => uniqueSorted(feats.map(f => f.properties?.[k]));
    return { mun: grab(FIELD_KEYS.mun), df: grab(FIELD_KEYS.df), dl: grab(FIELD_KEYS.dl) };
    }
    function fillSelect(sel, arr){
    sel.innerHTML = '<option value="">— Ninguno —</option>' + arr.map(v=>`<option value="${v}">${v}</option>`).join('');
    }
    function getMiniUniverse(){
    const { selMun, selDf, selDl, all } = __mini;
    if(all.checked) return { scope:'ALL', key:null, label:'Estado completo' };
    if(selMun.value) return { scope:'MUN', key: selMun.value, label:`Municipio ${selMun.options[selMun.selectedIndex].text}` };
    if(selDf.value)  return { scope:'DF',  key: selDf.value,  label:`Distrito Federal ${selDf.value}` };
    if(selDl.value)  return { scope:'DL',  key: selDl.value,  label:`Distrito Local ${selDl.value}` };
    return null;
    }
    function miniExclusivity(which){
    const { selMun, selDf, selDl, all } = __mini;
    if(which==='ALL'){ selMun.value=''; selDf.value=''; selDl.value=''; }
    if(which==='MUN'){ selDf.value=''; selDl.value=''; all.checked=false; }
    if(which==='DF'){  selMun.value=''; selDl.value=''; all.checked=false; }
    if(which==='DL'){  selMun.value=''; selDf.value=''; all.checked=false; }
    applyMiniUniverse();
    }
    function applyMiniUniverse(){
    const u2 = getMiniUniverse();
    if(!u2) return;
    // 1) Persistir
    localStorage.setItem('AT_UNIVERSE', JSON.stringify({ ...u2, ts:Date.now() }));
    // 2) Redibujar con el nuevo universo usando el raw ya cargado
    const atMap = ensureLeafletMap();
    const filtered2 = filterGeojson(window.AT_DATA, u2);
    if (window.AT_CTX?.layer) { atMap.removeLayer(AT_CTX.layer); }
    const layer2 = L.geoJSON(filtered2, { style:{ color:'#7d0025', weight:1.2, fillOpacity:0.15 } }).addTo(atMap);
    try { atMap.fitBounds(layer2.getBounds(), { padding:[20,20] }); } catch(e){}
    window.AT_CTX = { ...(window.AT_CTX||{}), universe: u2, layer: layer2 };
    // 3) Header
    const hdr = document.querySelector('#panel-header span');
    if(hdr){ hdr.textContent = `Análisis Territorial · ${u2.label}`; }
      refreshSectionSearch(u2);
    }
    function initMiniSelector(raw, u){
    // Guardar el geojson bruto para futuros re-filtros
    window.AT_DATA = raw;

    __mini.selMun = document.getElementById('mini-sel-mun');
    labelMunicipiosFromCatalog('#mini-sel-mun');

    __mini.selDf  = document.getElementById('mini-sel-df');
    __mini.selDl  = document.getElementById('mini-sel-dl');
    __mini.all    = document.getElementById('mini-all-state');

    const opt = buildMiniOptions(raw);
    fillSelect(__mini.selMun, opt.mun);
    fillSelect(__mini.selDf,  opt.df);
    fillSelect(__mini.selDl,  opt.dl);

    // Reflejar el universo actual
    if(u.scope==='ALL'){ __mini.all.checked = true; }
    if(u.scope==='MUN'){ __mini.selMun.value = String(u.key); }
    if(u.scope==='DF'){  __mini.selDf.value  = String(u.key); }
    if(u.scope==='DL'){  __mini.selDl.value  = String(u.key); }


    
        async function labelMunicipiosFromCatalog(selectId){
        const sel = document.querySelector(selectId);
        if (!sel) return;

        // 1) Ruta del catálogo desde el Portal (AT_PATHS) o fallback
        let catUrl = 'data/catalogo_territorial.json';
        try {
            const paths = JSON.parse(localStorage.getItem('AT_PATHS') || '{}');
            if (paths?.catalog) catUrl = paths.catalog;
        } catch {}

        // 2) Cargar catálogo
        let cat = null;
        try {
            const r = await fetch(catUrl);
            if (!r.ok) throw new Error('HTTP '+r.status);
            cat = await r.json();
        } catch (e) {
            console.warn('[AT] No se pudo cargar el catálogo:', e);
            return; // salimos sin tocar etiquetas
        }

        const mapa = cat?.municipios || {};
        // helper: si el catálogo trae ceros a la izquierda en las llaves
        const getName = (code) => {
            const s = String(code);
            return mapa[s] || mapa[s.padStart(2,'0')] || mapa[s.padStart(3,'0')] || s;
        };

        // 3) Reetiquetar opciones (sin cambiar value)
        for (const opt of sel.options) {
            if (!opt.value) continue; // deja "— Ninguno —"
            const name = getName(opt.value);
            opt.text = `${opt.value} — ${name}`;
        }
        }

   

    // Eventos (auto-ejecuta)
    __mini.selMun.addEventListener('change', ()=> miniExclusivity('MUN'));
    __mini.selDf .addEventListener('change', ()=> miniExclusivity('DF'));
    __mini.selDl .addEventListener('change', ()=> miniExclusivity('DL'));
    __mini.all   .addEventListener('change', ()=> miniExclusivity('ALL'));
    }


    // Nombre fijo del campo (texto) del municipio
    const MUN_NAME_KEY = 'MUNICIPIO';

    // Detecta automáticamente el campo de CÓDIGO de municipio (si no, usa el nombre)
    function detectMunCodeKey(raw){
    const feats = raw.features || [];
    const candidates = ['MUN','CVE_MUN','CLV_MUN','ID_MUN','MUNICIPIO_ID','MUNICIPIO_CVE','CVE_MUNICIPIO','CVE_MPIO'];
    for (const k of candidates) {
        const ok = feats.some(f => {
        const v = f.properties?.[k];
        return v != null && String(v).trim() !== '' && String(v).toUpperCase() !== 'NULL';
        });
        if (ok) return k;
    }
    return null; // fallback será MUN_NAME_KEY
    }



      // —— Utils de texto ——
      function _norm(s){
        if (s==null) return '';
        return String(s).normalize('NFD').replace(/[\u0300-\u036f]/g,'').toUpperCase().trim();
      }
      function _isDigits(s){ return /^[0-9]+$/.test(String(s||'')); }

      // —— Nombre de municipio desde catálogo (si existe) ——
      function getMunNameFromCatalog(code){
        const cat = window.AT_CATALOG;
        if (!cat?.municipios) return String(code ?? '');
        const s = String(code);
        // maneja posibles ceros a la izquierda
        return cat.municipios[s] || cat.municipios[s.padStart(2,'0')] || cat.municipios[s.padStart(3,'0')] || s;
      }

      // —— Índice de secciones ——
      let __SEC_INDEX = { items: [], global: false };

      function buildSectionIndex(raw, universe, useGlobal){
        const feats = (raw?.features || []);
        const munKey = (window.AT_KEYS?.munCode) || FIELD_KEYS.mun;
        const items = [];

        // dataset base: global = todas, local = filtradas por universo
        const base = useGlobal ? feats : (filterGeojson(raw, universe).features || []);

        for(const f of base){
          const p = f.properties || {};
          const sec = p.SECCION ?? p.Seccion ?? p.seccion ?? null;
          if (sec == null) continue;

          const munCode = p[munKey];
          const munName = getMunNameFromCatalog(munCode);
          const df = p[FIELD_KEYS.df];
          const dl = p[FIELD_KEYS.dl];

          // texto para búsqueda
          const text = `${sec} ${munCode ?? ''} ${munName ?? ''} ${df ?? ''} ${dl ?? ''}`;
          // bounds (si multiparte, Leaflet lo resuelve)
          let bounds = null;
          try { bounds = L.geoJSON(f).getBounds(); } catch(_){}

          items.push({
            sec: String(sec).trim(),
            munCode: munCode,
            munName: munName,
            df, dl, feature: f, textNorm: _norm(text), bounds
          });
        }

        __SEC_INDEX = { items, global: !!useGlobal };
      }

      function searchSections(query, limit=15){
        const q = _norm(query);
        if (!q) return [];
        const ds = __SEC_INDEX.items;

        // Heurística sencilla:
        // - si es numérico puro: prioridad a SECCION que empiece con q
        // - si no: contiene tokens
        if (_isDigits(q)){
          const starts = ds.filter(it => _norm(it.sec).startsWith(q));
          if (starts.length >= limit) return starts.slice(0, limit);
          const contains = ds.filter(it => _norm(it.sec).includes(q));
          return [...starts, ...contains].slice(0, limit);
        } else {
          const tokens = q.split(/\s+/).filter(Boolean);
          return ds.filter(it => tokens.every(t => it.textNorm.includes(t))).slice(0, limit);
        }
      }

      // —— UI de sugerencias ——
      let __SEC_HIGHLIGHT = null;

      function renderSecSuggestions(list){
        const ul = document.getElementById('sec-suggest');
        if (!ul) return;
        if (!list.length){ ul.style.display='none'; ul.innerHTML=''; return; }

        ul.innerHTML = list.map(it => {
          const label = `${it.sec} — ${it.munName || it.munCode || ''}`.replace(/\s+-\s+$/, '');
          const meta  = [];
          if (it.dl!=null) meta.push(`DL ${it.dl}`);
          if (it.df!=null) meta.push(`DF ${it.df}`);
          const sub = meta.length ? `<small style="color:#64748b">${meta.join(' · ')}</small>` : '';
          return `<li data-sec="${it.sec}" style="padding:6px 8px; border-bottom:1px solid #e5e7eb; cursor:pointer">
                    <div>${label}</div>${sub}
                  </li>`;
        }).join('');
        ul.style.display = 'block';


      }

    function gotoSection(item){
      const atMap = (window.AT_CTX?.map) || ensureLeafletMap();

      // 1) Resolver el feature de la sección
      const sec = String(item.sec ?? item.SECCION ?? '');
      let feat = item.feature;

      if (!feat) {
        const feats =
          (window.AT_CTX?.layer?.toGeoJSON?.().features) ||
          (window.AT_DATA?.features) || [];
        feat = feats.find(f => normSec(f.properties?.SECCION) === normSec(sec));
      }

      if (!feat) {
        console.warn('[AT] No encontré el feature para la sección', sec, item);
        return;
      }

      // 2) Pintar selección + adyacentes + labels (esto limpia overlays previos)
      paintSelectionAndAdj(feat);

      // 3) Mostrar panel con DF, DL y LN (24DL_LN)
      showSectionInfo(feat);

      // 4) Feedback visual (parpadeo leve sobre el highlight actual)
      const hl = window.__SEC_HL;
      if (hl && typeof hl.setStyle === 'function') {
        try {
          hl.setStyle({ weight: 4 });
          setTimeout(() => { try { hl.setStyle({ weight: 3 }); } catch(_){} }, 220);
        } catch(_){}
      }

      // 5) Oculta la lista de sugerencias (si está visible)
      const ul = document.getElementById('sec-suggest');
      if (ul) ul.style.display = 'none';
    }


      // Delegación de clic en las sugerencias (una sola vez)
    (function wireSectionSearchEventsOnce(){
      const ul = document.getElementById('sec-suggest');
      const input = document.getElementById('sec-q');
      if (!ul || !input) return;

       // Si está dentro de un form, evita submit al Enter
      const form = input.closest('form');
      form?.addEventListener('submit', e => e.preventDefault());

      // Clic en cualquier <li data-sec="...">
      if (!ul.__wiredClick){
        ul.addEventListener('click', (ev)=>{
          const li = ev.target.closest('li[data-sec]');
          if (!li) return;
          const sec = li.getAttribute('data-sec');
          const item = (__SEC_INDEX?.items||[]).find(x => String(x.sec) === String(sec));
          if (item) gotoSection(item);
          ul.style.display = 'none';
        });
        ul.__wiredClick = true;
      }

      // Enter en el input = ir al primer resultado
      if (!input.__wiredKey){
        input.addEventListener('keydown', (ev)=>{
          if (ev.key === 'Enter'){
            ev.preventDefault(); // <- evita submit/autocomplete
            const results = searchSections(input.value, 1);
        const needle = currentNeedle(input.value);
        const [first] = searchSections(needle, 1);
        if (first) gotoSection(first);
        ul.style.display = 'none';
       }
          if (ev.key === 'Escape'){
            ul.style.display = 'none';
          }
        });
        input.__wiredKey = true;
      }

      // Input: recalcula sugerencias usando el "último token"
      if (!input.__wiredInput){
        input.addEventListener('input', ()=>{
          const needle = currentNeedle(input.value);
          renderSecSuggestions(searchSections(needle, 15));
        });
        input.__wiredInput = true;
      }
    })();


      // —— Inicializar Buscador en el módulo ——
      function initSectionSearch(raw, universe){
        const input   = document.getElementById('sec-q');
        const list    = document.getElementById('sec-suggest');
        const globalC = document.getElementById('sec-global');
        if (!input || !list) return;

        // construir índice (por universo actual)
        buildSectionIndex(raw, universe, !!globalC?.checked);



        // Cambiar ámbito (global / universo actual)
        globalC?.addEventListener('change', () => {
          buildSectionIndex(raw, universe, !!globalC.checked);
          // refresca sugerencias con la query actual
          if (input.value){
            renderSecSuggestions(searchSections(input.value, 15));
          }
        });
      }

      // —— Cuando cambies de universo con tu mini-selector, reindexa ——
      function refreshSectionSearch(universe){
        const input   = document.getElementById('sec-q');
        const globalC = document.getElementById('sec-global');
        if (!window.AT_DATA || !input) return;
        buildSectionIndex(window.AT_DATA, universe, !!globalC?.checked);
        if (input.value){
          renderSecSuggestions(searchSections(input.value, 15));
        }
      }


      function getRawForIndex(){
        // Usa el dataset completo si ya lo cacheaste
        if (window.AT_DATA) return window.AT_DATA;
        // Si no, al menos usa lo ya pintado en el mapa
        const lyr = window.AT_CTX?.layer;
        return (lyr && typeof lyr.toGeoJSON === 'function') ? lyr.toGeoJSON() : null;
  }


  // ===== 3) Boot =====
  document.addEventListener('DOMContentLoaded', async () => {
    // a) Leer universo y rutas puestos en el PORTAL
    const u     = JSON.parse(localStorage.getItem('AT_UNIVERSE') || 'null');
    const paths = JSON.parse(localStorage.getItem('AT_PATHS') || '{"geo":""}');
    if (!u) {
      const hdr = document.querySelector('#panel-header span');
      hdr && (hdr.textContent += ' · selecciona el universo en el Portal');
      setTimeout(()=>{ location.href = 'portal.html'; }, 600);
      return;
    }

    // b) Etiqueta del universo
    const hdr = document.querySelector('#panel-header span');
    hdr && (hdr.textContent += ` · ${u.label}`);

    // c) Mapa único
    const atMap = ensureLeafletMap();
    assertIsLeafletMap(atMap);

    // d) Cargar y filtrar GeoJSON
    const url = paths.geo || 'data/geo/secciones.geojson'; // <-- ajusta si tu ruta difiere

    // Cargar catálogo territorial (para nombres visibles)
    const catUrl = (paths.catalog && paths.catalog.trim()) || '/data/catalogo_territorial.json';
    let catalog = window.AT_CATALOG || null;
    if (!catalog) {
    try {
        const rc = await fetch(catUrl);
        if (!rc.ok) throw new Error(`HTTP ${rc.status} al cargar catálogo ${catUrl}`);
        catalog = await rc.json();
        window.AT_CATALOG = catalog;
    } catch (err) {
        console.warn('[AT] No se pudo cargar el catálogo de nombres:', err);
        window.AT_CATALOG = catalog = null; // seguimos sin nombres amigables
    }
    }


 let raw = window.AT_DATA || null; // usa caché si ya existe
if (!raw) {
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status} al cargar ${url}`);
    raw = await res.json();       // ✅ solo una vez
    window.AT_DATA = raw;         // ✅ guarda en caché aquí
  } catch (err) {
    console.error('[AT] Error cargando GeoJSON:', err);
    alert('No se pudo cargar el GeoJSON');
    return;
  }
}
// a partir de aquí, usa 'raw'

    const filtered = filterGeojson(raw, u);
    console.log('[AT] Universo:', u, 'Total:', raw.features?.length||0, 'Filtradas:', filtered.features?.length||0);

    if(!filtered.features || filtered.features.length===0){
      console.warn('[AT] No hay geometrías para el universo seleccionado:', u);
      alert('No hay datos para el universo seleccionado');
    }

    // Nombre fijo del campo (texto) del municipio
        const MUN_NAME_KEY = 'MUNICIPIO';

    // Detecta campo de CÓDIGO (si existe); si no, usa el de nombre
        function detectMunCodeKey(raw){
        const feats = raw.features || [];
        const candidates = ['MUN','CVE_MUN','CLV_MUN','ID_MUN','MUNICIPIO_ID','MUNICIPIO_CVE','CVE_MUNICIPIO','CVE_MPIO'];
        for (const k of candidates) {
            if (feats.some(f => (f.properties?.[k] ?? '') !== '')) return k;
        }
        return null;
        }

        const munCodeKey = detectMunCodeKey(raw) || MUN_NAME_KEY; // fallback: nombre
        FIELD_KEYS.mun = munCodeKey;
        window.AT_KEYS = { munCode: munCodeKey, munName: MUN_NAME_KEY };


    // e) Dibujar capa
        const layer = L.geoJSON(filtered, {
      style: { color:'#000000', weight:1.2, fillOpacity:0.15 },
      onEachFeature: (feat, lyr) => {
        const p = feat.properties || {};
        const muni = p[FIELD_KEYS.mun] ?? '—';
        const dl   = p[FIELD_KEYS.dl]  ?? '—';
        const df   = p[FIELD_KEYS.df]  ?? '—';
        lyr.bindPopup(`<b>Sección</b>: ${p.SECCION ?? '—'}<br><b>Mun</b>: ${muni}<br><b>DL</b>: ${dl}<br><b>DF</b>: ${df}`);
        lyr.on('mouseover', () => lyr.setStyle({weight:2}));
        lyr.on('mouseout',  () => lyr.setStyle({weight:1.2}));
      }
    }).addTo(atMap);

    try { atMap.fitBounds(layer.getBounds(), { padding:[20,20] }); } catch(e){}
    window.AT_CTX = { universe: u, paths, map: atMap, layer };

    function getMunNameFromCatalog(code){
  const cat = window.AT_CATALOG;
  if (!cat?.municipios) return String(code ?? '');
  return cat.municipios[String(code)] || String(code ?? '');
}
function getDfListFromCatalog(feats){
  return (window.AT_CATALOG?.distritos_federales && window.AT_CATALOG.distritos_federales.length)
    ? window.AT_CATALOG.distritos_federales
    : uniqSorted(feats.map(f => f.properties?.[FIELD_KEYS.df]));
}
function getDlListFromCatalog(feats){
  return (window.AT_CATALOG?.distritos_locales && window.AT_CATALOG.distritos_locales.length)
    ? window.AT_CATALOG.distritos_locales
    : uniqSorted(feats.map(f => f.properties?.[FIELD_KEYS.dl]));
}
    initMiniSelector(raw, u);
    initSectionSearch(window.AT_DATA || raw, u);

  });

  // Carga y cache
  window.AT_ELECT = window.AT_ELECT || {};
  function getPaths(){ try{ return JSON.parse(localStorage.getItem('AT_PATHS')||'{}'); }catch{ return {}; } }
  function getPuestoPath(p){ const paths=getPaths(); return paths?.electoral?.[p] || `data/electoral/${p}.json`; }
  async function loadPuesto(p){
    if (AT_ELECT[p]) return AT_ELECT[p];
    const r = await fetch(getPuestoPath(p) + `?v=${Date.now()}`);
    if (!r.ok) throw new Error(`HTTP ${r.status} al cargar ${p}.json`);
    AT_ELECT[p] = await r.json();
    return AT_ELECT[p];
  }

  // Detector
  function detectSchemaFrom(data){
    const secs = data?.secciones || {};
    const firstKey = Object.keys(secs)[0];
    const slot = secs[firstKey] || {};
    const years = Object.keys(slot).filter(k => /^\d{4}$/.test(k)).map(n=>+n).sort();
    // toma un año “reciente” para inferir partidos
    const row = slot[String(years[years.length-1])] || slot[String(years[0])] || {};
    const parties = (data?.meta?.parties && data.meta.parties.length)
      ? data.meta.parties
      : Object.keys(row).filter(k => !['VOTOS','LN'].includes(k));
    return { years, parties, exampleSection:firstKey, exampleRow: row };
  }

  // Uso rápido en consola:
  (async ()=>{
    const A = await loadPuesto('A');  // cambia a 'P','DF','DL','G','S' para probar
    const info = detectSchemaFrom(A);
    console.log('[A] years:', info.years, 'parties:', info.parties);
    console.log('[A] example row:', info.exampleSection, info.exampleRow);
  })();


  (function wireATHotkeys(){
      if (window.__AT_HOTKEYS) return;
      window.__AT_HOTKEYS = true;

      window.addEventListener('keydown', (e)=>{
        // Esc: cerrar panel
        if (e.key === 'Escape'){
          if (document.getElementById('sec-info')?.style.display !== 'none'){
            e.preventDefault();
            closeSecInfoPanel();
          }
        }
        // Ctrl+K (o Cmd+K en Mac): enfocar buscador de secciones
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k'){
          e.preventDefault();
          document.getElementById('sec-q')?.focus();
        }
      });
    })();

    // Mostrar/ocultar el rail (colapso)
    (function wireToolRail(){
      const railBtn = document.getElementById('railToggle');
      const group   = document.getElementById('railGroup');
      if (!railBtn || !group) return;

      railBtn.addEventListener('click', ()=>{
        group.classList.toggle('is-collapsed');
      });

      // Delegación de clicks para marcar activo y disparar acciones
      group.addEventListener('click', (ev)=>{
        const btn = ev.target.closest('.tool'); if (!btn) return;
        group.querySelectorAll('.tool').forEach(b => b.classList.toggle('active', b===btn));
        const tool = btn.getAttribute('data-tool');
        runTool(tool);
      });
    })();

    // Punto de entrada de cada herramienta
    async function runTool(tool){
      switch (tool){
        case 'historial':
          // Aquí activamos tu panel/diálogo de gráficas de Historial
          // (conectaremos a las nuevas funciones al vuelo)
          openHistorialUI();
          break;
        case 'ganador':
          await paintWinnersOnLayer({ puesto:'P', year:2024 }); // ejemplo
          break;
        case 'competencia':
          // Ejemplo: recolorear por margen
          await paintByMargin({ puesto:'P', year:2024 });
          break;
        case 'proyeccion':
          openProyeccionUI();
          break;
        case 'exportar':
          exportMapPNG(); // si ya tienes html2canvas/jsPDF integrados
          break;
        default:
          console.log('[Tool]', tool);
      }
    }

    // Stubs (los conectamos después con tus gráficas/núcleo)
    function openHistorialUI(){ /* abrir panel/modal con charts */ }
    function openProyeccionUI(){ /* ... */ }
    async function paintByMargin({puesto,year}){ /* ... usando universe/sectionMetrics */ }
    function exportMapPNG(){ /* ... */ }


  // Marca uno como activo al cargar (para ver el color desde el inicio)
  document.addEventListener('DOMContentLoaded', ()=>{
    document.querySelector('#railGroup .tool')?.classList.add('active');
  });

  // ====== Loader electoral + helpers ======
    window.AT_ELECT = window.AT_ELECT || {};
    function getPaths(){ try{return JSON.parse(localStorage.getItem('AT_PATHS')||'{}');}catch{return{};} }
    function getPuestoPath(p){ const paths=getPaths(); return paths?.electoral?.[p]||`data/electoral/${p}.json`; }
    async function loadPuesto(p){ if(AT_ELECT[p]) return AT_ELECT[p]; const r=await fetch(getPuestoPath(p)+`?v=${Date.now()}`); AT_ELECT[p]=await r.json(); return AT_ELECT[p]; }
    const asInt0=v=>(v==null||(typeof v==='number'&&v!==v)||String(v).trim()==='')?0:Math.round(+v||0);
    const secKey=s=>String(s).replace(/\D+/g,'').padStart(4,'0');
    function winnerOf(votes){ let best=null,max=-1; for(const[k,v]of Object.entries(votes)){ if(v>max){max=v;best=k;} } const tot=Object.values(votes).reduce((a,b)=>a+b,0); return {party:best,votes:max,total:tot}; }
    const CORE_PARTIES=['PAN','PRI','PVEM','MORENA'];
    const PARTY_COLORS={PAN:'#1e88e5',PRI:'#c62828',PVEM:'#2e7d32',MORENA:'#7b1fa2',OTROS:'#90a4ae'};

    // ====== Panel: drag + close ======
    (function wireHistPanel(){
      const box=document.getElementById('hist-panel');
      const hdr=box?.querySelector('.hdr');
      const close=document.getElementById('hist-close');
      if(!box||!hdr||box.__wired) return;
      if(window.L&&L.DomEvent){ L.DomEvent.disableClickPropagation(box); L.DomEvent.disableScrollPropagation(box); }
      let dragging=false,sx=0,sy=0,bx=0,by=0;
      hdr.addEventListener('mousedown',e=>{
        if(e.target.closest('.btn-close')||e.target.tagName==='SELECT') return;
        e.preventDefault(); e.stopPropagation();
        const r=box.getBoundingClientRect(); dragging=true; sx=e.clientX; sy=e.clientY; bx=r.left; by=r.top;
        box.style.position='absolute'; box.style.right='auto'; box.style.bottom='auto'; document.body.style.userSelect='none';
      });
      window.addEventListener('mousemove',e=>{
        if(!dragging) return; e.preventDefault(); e.stopPropagation();
        const dx=e.clientX-sx, dy=e.clientY-sy; box.style.left=(bx+dx)+'px'; box.style.top=(by+dy)+'px';
      });
      window.addEventListener('mouseup',()=>{ if(!dragging) return; dragging=false; document.body.style.userSelect=''; });
      close?.addEventListener('click',()=>{ box.style.display='none'; destroyHistCharts(); });
      box.__wired=true;
    })();

    function getActiveSectionSec(){
      const hl=window.__SEC_HL;
      if(hl?.getLayers){ const lyr=hl.getLayers()[0]; return lyr?.feature?.properties?.SECCION??null; }
      const t=document.getElementById('si-sec')?.textContent; return t&&t!=='—'?t:null;
    }

    // Normaliza: "0007" -> "7", "201" -> "201", 7 -> "7"
    const normSec = s => String(s ?? '').replace(/\D+/g, '');

    // Busca la fila de la sección en el JSON, tolerando distintos formatos de clave
    function findSecSlot(data, sec){
      const k = normSec(sec);
      const map = data?.secciones || {};
      return map[k]                  // "201"
          ?? map[k.padStart(4,'0')]  // "0201"
          ?? map[String(+k)]         // 201 (si estuviera como número)
          ?? null;
    }

    // Igualdad de secciones robusta
    const eqSec = (a,b) => normSec(a) === normSec(b);


    // ====== Charts ======
    let __HIST_CHART_BAR=null,__HIST_CHART_WIN=null,__HIST_CHART_PIE=null;
    function destroyHistCharts(){ try{__HIST_CHART_BAR?.destroy();}catch(_){}
      try{__HIST_CHART_WIN?.destroy();}catch(_){}
      try{__HIST_CHART_PIE?.destroy();}catch(_){}
      __HIST_CHART_BAR=__HIST_CHART_WIN=__HIST_CHART_PIE=null; }

    async function renderHistorialCharts(){
      const panel=document.getElementById('hist-panel');
      const puesto=document.getElementById('hist-puesto').value||'P';
      const sec=getActiveSectionSec();
      if(!sec){ alert('Selecciona una sección en el mapa.'); return; }
      document.getElementById('hist-sec').textContent=sec;

    const data = await loadPuesto(puesto);
    const slot = findSecSlot(data, sec);
    if (!slot){ destroyHistCharts(); console.warn('[Hist] sin datos', sec, puesto); return; }

    // Opción 1 (auto-detecta los años disponibles en esa sección)
    const years = Object.keys(slot).filter(k=>/^\d{4}$/.test(k)).map(Number).sort();
    // Opción 2 (forzar 2018/2021/2024 aunque falte alguno)
    // const years = [2018, 2021, 2024];

    const rows  = years.map(y => slot[String(y)] || null);


      destroyHistCharts();

      // 1) Historial (barras agrupadas)
      const barLabels=years.map(String);
      const barDS=CORE_PARTIES.map(p=>({ label:p, data:rows.map(r=>asInt0(r?.[p])), backgroundColor:PARTY_COLORS[p]||'#90a4ae' }));
      __HIST_CHART_BAR=new Chart(document.getElementById('hist-bar').getContext('2d'),{
        type:'bar', data:{labels:barLabels,datasets:barDS},
        options:{responsive:true,maintainAspectRatio:false,resizeDelay:150,animation:false,
           plugins:{legend:{position:'bottom'},datalabels:{anchor:'end',align:'top',formatter:v=>v||''}},
          scales:{y:{beginAtZero:true}}
        }
      });

      // 2) Ganadores por año (barras)
      const winLabels=[],winData=[],winColors=[];
      years.forEach((y,i)=>{ const r=rows[i]||{}; const v={}; CORE_PARTIES.forEach(p=>v[p]=asInt0(r[p]));
        const w=winnerOf(v); winLabels.push(`${y} • ${w.party||'—'}`); winData.push(asInt0(w.votes)); winColors.push(PARTY_COLORS[w.party]||'#90a4ae'); });
      __HIST_CHART_WIN=new Chart(document.getElementById('hist-win').getContext('2d'),{
        type:'bar', data:{labels:winLabels,datasets:[{label:'Votos',data:winData,backgroundColor:winColors}]},
        options:{responsive:true,maintainAspectRatio:false,resizeDelay:150,animation:false,plugins:{legend:{display:false},datalabels:{anchor:'end',align:'top',formatter:v=>v||''}},scales:{y:{beginAtZero:true}}}
      });

      // 3) Competencia (pie) — usa SIEMPRE el último año disponible
      const rLast     = rows[rows.length - 1] || {};
      const pieLabels = CORE_PARTIES;  // o filtra si quieres mostrar solo los que tienen datos
      const pieData   = pieLabels.map(p => asInt0(rLast[p]));
      const pieTotal  = pieData.reduce((a,b)=>a+b,0) || 1;

      __HIST_CHART_PIE = new Chart(
        document.getElementById('hist-pie').getContext('2d'),
        {
          type: 'pie',
          data: {
            labels: pieLabels,
            datasets: [{
              data: pieData,
              backgroundColor: pieLabels.map(p => PARTY_COLORS[p] || '#90a4ae')
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            resizeDelay: 150,
            animation: false,
            plugins: {
              legend: { position: 'bottom' },
              datalabels: {
                formatter: (v) => ((v / pieTotal * 100).toFixed(1) + '%'),
                color: '#111'
              },
              // opcional: rotula el año que se muestra
              title: {
                display: true,
                text: `Competencia ${years[years.length - 1]} (% del total)`
              }
            }
          }
        }
      );

    }

    function openHistorialUI(){
      const box=document.getElementById('hist-panel');
      box.style.display='block';
      const sel=document.getElementById('hist-puesto');
      if(!sel.__wired){ sel.addEventListener('change',renderHistorialCharts); sel.__wired=true; }
      renderHistorialCharts();
    }




  </script>
  <div id="sec-info">
    <div class="hdr">
    <span class="ttl">Sección</span>
    <button id="sec-close" class="btn-close" aria-label="Cerrar">×</button>
  </div>
  <div class="body">
    <div class="row"><span class="k">Sección</span>        <span class="v" id="si-sec">—</span></div>
    <div class="row"><span class="k">Distrito Federal</span><span class="v" id="si-df">—</span></div>
    <div class="row"><span class="k">Distrito Local</span>  <span class="v" id="si-dl">—</span></div>
    <div class="row"><span class="k">LN (2024)</span>    <span class="v" id="si-ln">—</span></div>
  </div>
</div>


  <!-- Barra superior -->
<div id="top-toolbar" class="ttb" style="position:absolute; top:12px; right:12px; z-index:5200;">
  <div class="ttb-wrap">
    <button id="btn-historial" class="ttb-btn" title="Historial (H)">Historial</button>
    <div class="ttb-sep"></div>
    <label for="comp-metric" class="ttb-label">Métrica</label>
    <select id="comp-metric" class="ttb-select">
      <option value="ganador">Ganador + margen</option>
      <option value="participacion">Participación</option>
      <!-- futuras: margen-tiempo, swing, h2h, hhi, volatilidad, proyección… -->
    </select>
    <button id="btn-abrir-comp" class="ttb-btn ttb-primary" title="Abrir comparativa (C)">Abrir</button>
    <div class="ttb-sep"></div>
    <button id="btn-ayuda" class="ttb-btn ttb-help" title="Ayuda (?)">Ayuda</button>
  </div>
</div>

<!-- Modal de ayuda con acordeón -->
<div id="help-modal" class="hm" style="display:none">
  <div class="hm-content">
    <div class="hm-hdr">
      <strong>Ayuda de consultas</strong>
      <button id="help-close" class="btn-close" aria-label="Cerrar">×</button>
    </div>
    <div id="help-accordion" class="hm-body"></div>
  </div>
</div>


</body>
</html>
