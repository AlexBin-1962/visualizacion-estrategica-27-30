<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Análisis Territorial</title>
  <link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; width:100%; font-family:'Segoe UI', Arial, sans-serif; background:#f4f4f4; }
    :root{ --sidebar-w:320px; }
    #panel-lateral{
      position:absolute;
      left:0; top:0; bottom:0; width:var(--sidebar-w); height:100%;
      background: linear-gradient(180deg, #8ea3ad 0%, #dfe6e9 100%);
      color:#2c3e50; border-right:1px solid #b2bec3;
      display:flex; flex-direction:column; 
      box-shadow:2px 0 5px rgba(0,0,0,0.1); box-sizing:border-box; align-items:stretch;
      z-index:2000;
    }
    #panel-header{ background:#b2bec3; color:#2c3e50; padding:12px 15px; display:flex; align-items:center; font-size:18px; font-weight:bold; }
    #panel-header img{ height:32px; margin-right:10px; }
    #map{ position:absolute; top:0; left:var(--sidebar-w); width:calc(100% - var(--sidebar-w)); height:100%; }

    #sec-search    { position: relative; }                /* contenedor del buscador */
    #sec-suggest   { z-index: 3000; } 
    #sec-suggest {
      position: absolute;
      left: 12px; right: 12px;
      top: 46px;           /* ajusta según tu input */
      max-height: 220px;
      overflow: auto;
    }
      /* la lista queda clickeable */

/* Etiqueta de la SECCIÓN seleccionada (rosa tenue) */
.sec-label{
  background: rgba(255, 235, 238, 0.96);  /* #ffebee */
  border: 1px solid #e91e63;
  color: #880e4f;
  padding: 2px 6px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 700;
  pointer-events: none;
  white-space: nowrap;
  box-shadow: 0 2px 6px rgba(0,0,0,.15);
}

/* Etiquetas de SECCIONES ADYACENTES (azul/gris tenue) */
.sec-label-adj{
  background: rgba(227, 242, 253, 0.94);  /* #e3f2fd */
  border: 1px solid #64b5f6;
  color: #0d47a1;
  padding: 1px 5px;
  border-radius: 8px;
  font-size: 11px;
  font-weight: 600;
  pointer-events: none;
  white-space: nowrap;
  box-shadow: 0 1px 4px rgba(0,0,0,.12);
}


/* Panel flotante sección */
#sec-info {
  position: absolute;
  left: 10px; bottom: 360px;
  width: 300px; max-width: 38vw; min-width: 260px;
  background: #ffffff;
  border: 1px solid #cfd8dc;
  border-radius: 10px;
  box-shadow: 0 10px 24px rgba(0,0,0,.15);
  resize: both; overflow: auto; z-index: 4000;
  display: none;
  pointer-events: auto;
}
#sec-info .hdr {
  cursor: move;
  display:flex; align-items:center; justify-content:space-between;
  background: linear-gradient(180deg,#eceff1,#e3f2fd);
  padding: 8px 12px;
  border-bottom: 1px solid #cfd8dc;
  font-weight: 700; color: #263238;
}

#sec-info .hdr .btn-close{
  cursor: pointer;
  border: none; outline: none;
  background: #ffcdd2;         /* rosa tenue */
  color: #880e4f;
  width: 24px; height: 24px; line-height: 24px;
  border-radius: 6px;
  font-size: 16px; font-weight: 800;
}
#sec-info .hdr .btn-close:hover{ background:#ef9a9a; }
#sec-info .body { padding: 10px 12px; color: #37474f; }
#sec-info .row  { display:flex; justify-content:space-between; margin:6px 0; }
#sec-info .k    { color:#607d8b; }
#sec-info .v    { font-weight:600; }
 

  :root{
  --rail-bg:#ffffff;
  --rail-br:#cfd8dc;
  --rail-shadow:0 10px 24px rgba(0,0,0,.15);
  --fg:#263238;
  --pink:#e91e63; --pink-bg:#ffebee;
  --blue:#2196f3; --blue-bg:#e3f2fd;
  --gray:#90a4ae;
  }
  .tool-rail{
    position:absolute; right:12px; top:50%; transform:translateY(-50%);
    z-index:2600; pointer-events:auto;
    display:flex; align-items:center; gap:.5rem;
  }
  .rail-toggle{
    width:42px; height:42px; border-radius:999px;
    border:1px solid var(--rail-br); background:var(--rail-bg);
    box-shadow:var(--rail-shadow); display:grid; place-items:center; cursor:pointer;
  }
  .rail-group{
    background:var(--rail-bg); border:1px solid var(--rail-br);
    border-radius:16px; padding:.5rem; box-shadow:var(--rail-shadow);
    display:flex; flex-direction:column; gap:.5rem; transition:transform .25s ease, opacity .2s;
  }
  .rail-group.is-collapsed{ transform:scale(.98); opacity:.0; pointer-events:none; }
  .rail-sep{ height:1px; background:var(--rail-br); margin:.25rem 0; }

  .tool{
    width:44px; height:44px; border-radius:999px; cursor:pointer;
    border:1px solid var(--rail-br); background:#fff; color:var(--fg);
    display:grid; place-items:center; box-shadow:0 2px 8px rgba(0,0,0,.08);
    transition:transform .15s ease, box-shadow .15s ease, background .15s, color .15s, border-color .15s;
  }
  .tool:hover{ transform:translateY(-1px); box-shadow:0 6px 14px rgba(0,0,0,.12); }
  .tool.active{ background:var(--pink-bg); border-color:var(--pink); color:var(--pink); }
  .tool svg{ width:22px; height:22px; }

  .tool[data-tool="ganador"].active{ background:var(--blue-bg); border-color:var(--blue); color:var(--blue); }

  .tool[data-tooltip]{
    position:relative;
  }
  .tool[data-tooltip]::after{
    content:attr(data-tooltip);
    position:absolute; right:110%; top:50%; transform:translateY(-50%);
    background:#000; color:#fff; font-size:12px; padding:.25rem .5rem;
    border-radius:6px; opacity:0; pointer-events:none; white-space:nowrap;
    transition:opacity .15s;
  }
  .tool:hover::after{ opacity:.9; }

  /* 1) Colores correctos en los iconos (svg) */
  .tool { color: #607d8b; } /* gris base */
  .tool svg, .tool svg path, .tool svg use { fill: currentColor; stroke: none; }

  .tool.active{
    background: #ffebee;           /* rosa tenue */
    border-color: #e91e63;
    color: #e91e63;
  }
  .tool[data-tool="ganador"].active{
    background: #e3f2fd;           /* azul tenue */
    border-color: #2196f3;
    color: #2196f3;
  }

  /* 2) Tooltips sin “rayitas” fantasma */
  .tool[data-tooltip]{ position: relative; }
  .tool[data-tooltip]::after{
    content: attr(data-tooltip);
    position: absolute;
    right: 110%;
    top: 50%;
    transform: translateY(-50%);
    background: #000;
    color: #fff;
    font-size: 12px;
    padding: .25rem .5rem;
    border-radius: 6px;
    white-space: nowrap;

    /* clave para evitar el “rastro” */
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition: opacity .15s ease, visibility .15s ease;
  }
  .tool:hover::after{
    opacity: .95;
    visibility: visible;
  }

  /* Por si el mapa se los tragaba */
  #tool-rail{ display: none !important; z-index: 5000; }

  .hist-panel{position:absolute;right:18px;top:70px;width:720px;max-width:86vw;background:#fff;border:1px solid #cfd8dc;border-radius:14px;box-shadow:0 12px 28px rgba(0,0,0,.16);z-index:4800;resize:both;overflow:auto}
  .hist-panel .hdr{display:flex;gap:.75rem;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #e0e0e0;background:linear-gradient(180deg,#4a148c,#ec76c5);color:#fff}
  .hist-panel .hdr .ctl{display:flex;align-items:center;gap:.5rem}
  .hist-panel .hdr label{font-size:12px;opacity:.85}
  .hist-panel .hdr select{padding:4px 8px;border-radius:8px;border:1px solid #b0bec5}
  .hist-panel .btn-close{cursor:pointer;border:none;background:#ffcdd2;color:#880e4f;width:28px;height:28px;line-height:28px;border-radius:8px;font-weight:800}
  .hist-panel .btn-close:hover{background:#ef9a9a}
  .hist-panel .body{padding:10px}
  .hist-panel .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .hist-panel .card{border:1px solid #eceff1;border-radius:10px;padding:8px}
  .hist-panel .card-h{font-weight:700;color:#263238;margin:0 0 6px}
  @media (max-width:1100px){.hist-panel{width:92vw;right:4vw}.hist-panel .grid{grid-template-columns:1fr}}


  /* El panel no debe crecer más que la ventana */
  #hist-panel{
    max-height: calc(100vh - 120px);
    overflow: hidden;
  }

  /* El área interna sí scrollea si hace falta */
  #hist-panel .body{
    max-height: calc(100vh - 170px);
    overflow: auto;
  }

  /* Cada tarjeta con alto estable */
  #hist-panel .card{
    height: 300px;                 /* ajusta 260–320 a tu gusto */
    display: flex; flex-direction: column;
  }

  /* El canvas ocupa el alto de la tarjeta (evita reflow infinito) */
  #hist-panel .card canvas{
    flex: 1;
    min-height: 240px;             /* altura mínima útil */
    height: 240px !important;      /* forzamos altura */
    width: 100% !important;
    display: block;
  }


  /* Controles del header del historial */
  .hist-panel .ctl { display:flex; align-items:center; gap:.5rem; }
  .hist-panel .ctl label { font-size:12px; opacity:.85; white-space:nowrap; }
  .hist-panel .ctl select { padding:4px 8px; border-radius:8px; border:1px solid #b0bec5; }

  .hist-panel .btn { cursor:pointer; border:1px solid #b0bec5; background:#fff;
    border-radius:8px; padding:4px 8px; font-size:12px; }
  .hist-panel .btn:hover{ background:#f3f6f9; }
  .hist-panel .btn-pink{ background:#ffe6ee; border-color:#f48fb1; color:#dd56d2; }
  .hist-panel .btn-blue{ background:#e3f2fd; border-color:#90caf9; color:#0d47a1; }

  /* Altos/scroll estables de las tarjetas/canvas */
  #hist-panel{ max-height:calc(100vh - 120px); overflow:hidden; }
  #hist-panel .body{ max-height:calc(100vh - 170px); overflow:auto; }
  #hist-panel .card{ height:300px; display:flex; flex-direction:column; }
  #hist-panel .card canvas{ flex:1; min-height:240px; height:240px !important; width:100% !important; display:block; }


    /* Barra superior */
    .ttb .ttb-wrap{
      display:flex; align-items:center; gap:.5rem;
      background:#ffffffcc; backdrop-filter: blur(6px);
      border:1px solid #cfd8dc; border-radius:12px; padding:8px 10px;
      box-shadow:0 10px 24px rgba(0,0,0,.12);
    }
    .ttb-btn{
      border:1px solid #b0bec5; background:#fff; color:#37474f;
      border-radius:10px; padding:6px 10px; cursor:pointer; font-size:13px;
    }
    .ttb-btn:hover{ background:#f5f7f9; }
    .ttb-primary{ background:#e3f2fd; border-color:#90caf9; color:#0d47a1; }
    .ttb-help{ background:#ffe6ee; border-color:#f48fb1; color:#880e4f; }
    .ttb-sep{ width:1px; height:26px; background:#e0e0e0; }
    .ttb-label{ font-size:12px; color:#455a64; }
    .ttb-select{
      padding:5px 8px; border:1px solid #b0bec5; border-radius:8px; font-size:13px;
    }

    /* Estado deshabilitado para botones de la barra */
    .ttb-btn[disabled],
    .ttb-btn[disabled]:hover,
    .ttb-btn[disabled]:focus {
      opacity: 0.5;
      cursor: not-allowed;
      /* Si quieres que NO reciba clics ni hover JS, deja esta línea.
        Si quieres que el tooltip (title) siempre aparezca, quítala. */
      pointer-events: none;
    }


    /* Modal de ayuda */
    .hm{ position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:5300; display:grid; place-items:center; }
    .hm-content{
      width:min(860px, 92vw); max-height:80vh; overflow:auto;
      background:#fff; border:1px solid #cfd8dc; border-radius:14px; box-shadow:0 16px 40px rgba(0,0,0,.28);
    }
    .hm-hdr{ display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px; border-bottom:1px solid #e0e0e0; background:linear-gradient(180deg,#eceff1,#e3f2fd); }
    .hm-body{ padding:12px; }
    .hm details{ border:1px solid #eceff1; border-radius:10px; padding:8px 10px; margin-bottom:8px; }
    .hm summary{ cursor:pointer; font-weight:600; color:#263238; }
    .btn-close{ cursor:pointer; border:none; background:#ffcdd2; color:#880e4f; width:28px;height:28px;line-height:28px;border-radius:8px;font-weight:800 }
    .btn-close:hover{ background:#ef9a9a; }

    .qa-table{ width:100%; border-collapse:collapse; font-size:13px }
    .qa-table th,.qa-table td{ border:1px solid #e0e0e0; padding:6px 8px; text-align:right }
    .qa-table th:first-child,.qa-table td:first-child{ text-align:left }
    .qa-warn{ margin-top:6px; color:#b71c1c }
    .bad-cell{ background:#fff3e0; color:#e65100; font-weight:600 }

    .qa-table input.qa-num{
      width: 140px; text-align: right; padding: 4px 6px;
      border: 1px solid #d0d0d0; border-radius: 4px; font-size: 13px;
    }
    .bad-input{ outline: 2px solid #e65100; background: #fff3e0; }
    .ok-msg{ color: #2e7d32; }
    .bad-msg{ color: #b71c1c; }


    /* Apila con espacio las tarjetas internas del QA */
      #hist-qa{
        display: flex;
        flex-direction: column;
        gap: 12px;            /* separa “Fuente interna” y “Externo” */
      }
      #hist-qa .card{
        position: static;     /* por si alguna card heredó posicionamiento raro */
        margin: 0;            /* evita márgenes que se colapsen */
      }


      /* QA: apila tarjetas en columna con espacio */
    #hist-qa{
      display: grid;
      grid-auto-rows: min-content;
      row-gap: 14px;
    }

    /* Cada tarjeta crea su propio contexto de flujo (clear de floats) */
    #hist-qa .card{
      display: flow-root;      /* ← clave para evitar que se “encimen” */
      position: relative;      /* asegúrate de que no herede absolute */
      margin: 0;               /* márgenes “limpios” */
      clear: both;             /* por si algo trae float */
    }

    /* La tabla nunca flota */
    #hist-qa .qa-table{ float: none; }

    /* ===== Compact Mode para la barra ===== */
  #top-toolbar .ttb-btn .ico { display:none; }
  #top-toolbar.ttb-compact .ttb-btn .txt { display:none; }
  #top-toolbar.ttb-compact .ttb-btn .ico { display:inline-block; }
  #top-toolbar.ttb-compact .ttb-btn {
    width: 36px; height: 36px;
    padding: 4px;
    display: inline-flex; align-items: center; justify-content: center;
  }
  #top-toolbar.ttb-compact .ttb-label { display:none; }
  #top-toolbar.ttb-compact .ttb-sep { margin: 0 4px; }

  /* Disabled legible en compacto */
  .ttb-btn[disabled]{ opacity:.45; cursor:not-allowed; }

  /* Botón toggle (opcional: mini) */
  #btn-ttb-compact-toggle { width: 32px; height: 32px; padding: 0 6px; }



  </style>
</head>
<body>
  <div id="panel-lateral">
    <div id="panel-header">
      <!-- <img src="assets/img/logo.png" alt="Logo"/> -->
      <span>Análisis Territorial</span>
    </div>
    <!-- Aquí va el contenido del panel lateral -->

    <!-- Buscador de secciones -->
    <div id="sec-search" style="padding:10px 12px; border-top:1px solid #cbd5e1; background:#eef2f7">
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="sec-q" type="text" placeholder="Buscar sección (ej. 1234 o '1234 León')" autocomplete="off" autocorrect="off" spellcheck="false" enterkeyhint="search"
              style="flex:1; padding:6px 8px; border:1px solid #94a3b8; border-radius:6px;">
        <label style="white-space:nowrap; font-size:12px;">
          <input id="sec-global" type="checkbox"> Todo el estado
        </label>
      </div>
      <ul id="sec-suggest" style="margin:8px 0 0 0; padding:0; list-style:none; max-height:180px; overflow:auto;
                                  border:1px solid #cbd5e1; border-radius:6px; background:#fff; display:none;"></ul>
    </div>



    <div id="mini-universe" style="padding:12px 12px 6px 12px; background:#eef2f7; border-top:1px solid #cbd5e1">
        <div class="row" style="margin-bottom:8px">
            <label><input type="checkbox" id="mini-all-state"> Estado completo</label>
        </div>
        <div class="row" style="margin-bottom:8px">
            <label>Municipio</label>
            <select id="mini-sel-mun" style="width:100%;padding:6px"><option value="">— Ninguno —</option></select>
        </div>
        <div class="row" style="margin-bottom:8px">
            <label>Distrito Federal</label>
            <select id="mini-sel-df" style="width:100%;padding:6px"><option value="">— Ninguno —</option></select>
        </div>
        <div class="row" style="margin-bottom:8px">
            <label>Distrito Local</label>
            <select id="mini-sel-dl" style="width:100%;padding:6px"><option value="">— Ninguno —</option></select>
        </div>
        <div class="hint" style="font-size:12px;color:#64748b">Elige solo uno. Al cambiar, el mapa se actualiza.</div>
    </div>

  </div>
  <div id="map"></div>

    <div id="hist-panel" class="hist-panel" style="display:none">
    <div class="hdr">
      <div class="ttl">
        <strong>Historial</strong> · Sección <span id="hist-sec">—</span>
      </div>
      <div class="ctl">
        <label for="hist-puesto">Puesto</label>
        <select id="hist-puesto">
          <option value="P">Presidente</option><option value="S">Senador</option><option value="G">Gobernador</option>
          <option value="DF">Diputado Federal</option><option value="DL">Diputado Local</option><option value="A">Ayuntamiento</option>
        </select>
        <button id="hist-close" class="btn-close" aria-label="Cerrar">×</button>
      </div>
    </div>
    <div class="body">
      <div class="grid">
        <div class="card"><div class="card-h">Historial por año (votos)</div><canvas id="hist-bar"></canvas></div>
        <div class="card"><div class="card-h">Ganadores 2018–2024 (votos)</div><canvas id="hist-win"></canvas></div>
        <div class="card"><div class="card-h">Competencia 2024 (% del total)</div><canvas id="hist-pie"></canvas></div>

        <div id="hist-qa" class="card" style="display:none">
          <div class="card-h">Verificación (QA)</div>
          <div id="hist-qa-context" style="font-size:13px;margin:.25rem 0;"></div>
            <div id="hist-qa-app" class="card" style="margin-top:.5rem">
          <div class="card-h">Fuente interna (App/JSON)</div>
            <table class="qa-table" id="qa-app-table"></table>
          <div id="qa-app-warn" class="qa-warn"></div>
        </div>
          <!-- Aquí luego pondremos tablas de App y Externo -->

        <div id="hist-qa-external" class="card" style="margin-top:.5rem">
          <div class="card-h">Externo (INE/IEEG)</div>

          <div class="qa-links" style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; margin:.5rem 0;">
            <label style="display:flex; gap:.25rem; align-items:center;">
              INE: <input id="qa-url-ine" type="url" placeholder="https://..." style="width:320px;">
              <button id="qa-open-ine" type="button">Abrir</button>
            </label>
            <label style="display:flex; gap:.25rem; align-items:center;">
              IEEG: <input id="qa-url-ieeg" type="url" placeholder="https://..." style="width:320px;">
              <button id="qa-open-ieeg" type="button">Abrir</button>
            </label>
            <button id="qa-save-urls" type="button">Guardar URLs</button>
          </div>

          <table class="qa-table" id="qa-ext-table">
            <thead><tr><th>Campo</th><th>Valor (pegar de INE/IEEG)</th></tr></thead>
            <tbody>
              <tr><td>PAN</td><td><input class="qa-num" data-f="PAN" inputmode="numeric"></td></tr>
              <tr><td>PRI</td><td><input class="qa-num" data-f="PRI" inputmode="numeric"></td></tr>
              <tr><td>PVEM</td><td><input class="qa-num" data-f="PVEM" inputmode="numeric"></td></tr>
              <tr><td>MORENA</td><td><input class="qa-num" data-f="MORENA" inputmode="numeric"></td></tr>
              <tr><td><b>VOTOS (total)</b></td><td><input class="qa-num" data-f="VOTOS" inputmode="numeric"></td></tr>
              <tr><td>LN</td><td><input class="qa-num" data-f="LN" inputmode="numeric"></td></tr>
            </tbody>
          </table>

          <div style="margin-top:.5rem; display:flex; gap:.5rem; align-items:center;">
            <button id="qa-compare" type="button">Comparar</button>
            <button id="qa-clear-ext" type="button">Limpiar</button>
            <span id="qa-compare-result" style="margin-left:.5rem;"></span>
          </div>
        </div>



        </div>
      </div>
      <label class="qa-toggle" title="Modo Verificación">
          <input type="checkbox" id="hist-qa-toggle"> QA
      </label>

    </div>
  </div>


      <!-- Sprite de íconos (inline, sin dependencias) -->
    <svg style="display:none">
      <symbol id="ic-history" viewBox="0 0 24 24">
        <path d="M13 3a9 9 0 1 1-9 9H2l3.5-3.5L9 12H6a7 7 0 1 0 7-7v2h-2V3zM12 7h2v5l3 1-0.5 1.9L12 13V7z"/>
      </symbol>
      <symbol id="ic-trophy" viewBox="0 0 24 24">
        <path d="M18 2H6v2H3v3a5 5 0 0 0 5 5 5 5 0 0 0 4 2 5 5 0 0 0 4-2 5 5 0 0 0 5-5V4h-3V2zM5 6V6.2A3 3 0 0 0 8 9a7 7 0 0 1-3-3zM19 6v.2A3 3 0 0 1 16 9a7 7 0 0 0 3-3zM10 16h4v2h-4v-2zm-2 4h8v2H8v-2z"/>
      </symbol>
      <symbol id="ic-compare" viewBox="0 0 24 24">
        <path d="M10 3H5v18h5V3zm9 0h-5v18h5V3zM8 7h1v10H8V7zm7 0h1v10h-1V7z"/>
      </symbol>
      <symbol id="ic-forecast" viewBox="0 0 24 24">
        <path d="M6 19a4 4 0 1 1 1-7.874A6 6 0 1 1 18 18H6zm0-2h12a4 4 0 1 0-1.264-7.787A6.002 6.002 0 0 0 6.126 13H6a2 2 0 1 0 0 4z"/>
      </symbol>
      <symbol id="ic-download" viewBox="0 0 24 24">
        <path d="M12 3v10l4-4 1.4 1.4L12 16 6.6 10.4 8 9l4 4V3h0zM5 19h14v2H5v-2z"/>
      </symbol>
      <symbol id="ic-menu" viewBox="0 0 24 24">
        <path d="M4 7h16v2H4V7zm0 4h16v2H4v-2zm0 4h10v2H4v-2z"/>
      </symbol>
    </svg>

    <!-- Rail de herramientas -->
    <div id="tool-rail" class="tool-rail">
      <button class="rail-toggle" id="railToggle" aria-label="Mostrar/ocultar">
        <svg><use href="#ic-menu"></use></svg>
      </button>

      <div class="rail-group" id="railGroup">
        <button class="tool" data-tool="historial"  data-tooltip="Historial">
          <svg><use href="#ic-history"></use></svg>
        </button>
        <button class="tool" data-tool="ganador"    data-tooltip="Ganador">
          <svg><use href="#ic-trophy"></use></svg>
        </button>
        <button class="tool" data-tool="competencia" data-tooltip="Competencia">
          <svg><use href="#ic-compare"></use></svg>
        </button>
        <button class="tool" data-tool="proyeccion" data-tooltip="Proyección">
          <svg><use href="#ic-forecast"></use></svg>
        </button>

        <div class="rail-sep"></div>

        <button class="tool" data-tool="exportar"   data-tooltip="Exportar">
          <svg><use href="#ic-download"></use></svg>
        </button>
      </div>
    </div>


  <!-- === SCRIPT ÚNICO === -->
  <script>

  

    // ===== Ayuda: acordeón =====
    const HELP_ITEMS = [
      {
        id:'historial',
        title:'Historial (sección)',
        short:'Tres gráficas: votos por partido 2018–2024, ganador por año y pastel de competencia del último año.',
        bullets:[
          'Toma la sección seleccionada (resaltada).',
          'Selector de puesto (P/S/G/DF/DL/A).',
          'Pastel: por defecto el último año disponible; puedes cambiarlo.',
        ]
      },
      {
        id:'comp-ganador',
        title:'Ganador + margen (sección)',
        short:'Muestra votos por partido del año elegido y resume ganador, votos y margen absoluto/%.',
        bullets:[
          'Elige puesto y año en el panel.',
          'Útil para ver cuán “segura”/“competida” es la sección en ese año.',
        ]
      },
      {
        id:'comp-participacion',
        title:'Participación (sección)',
        short:'Serie histórica de participación (VOTOS/LN %) por año disponible.',
        bullets:[
          'Calculada al vuelo con VOTOS/LN del puesto elegido.',
          'Para P/S/G sólo 2018 y 2024; para DF/DL/A incluye 2021.',
        ]
      },
      // Placeholders de futuras métricas (cuando las integremos):
      { id:'comp-margen-tiempo', title:'Margen en el tiempo (sección)', short:'Evolución del margen entre 1º y 2º lugar por año.', bullets:['Detecta si la sección se volvió más competida o más segura.'] },
      { id:'comp-swing', title:'Swing (sección)', short:'Cambio de votos/participación por partido entre elecciones.', bullets:['Mide ganancia/pérdida relativa de cada partido.'] },
      { id:'comp-h2h', title:'Head-to-Head PAN vs MORENA', short:'Ventaja en votos/% por año entre PAN y MORENA.', bullets:['Línea con valores ± y ganador del duelo.'] },
      { id:'comp-hhi', title:'Competitividad (HHI)', short:'Índice de concentración (∑ share²).', bullets:['Bajo = competido; alto = concentrado.'] },
      { id:'comp-vol', title:'Volatilidad (Pedersen)', short:'Suma de cambios absolutos en shares / 2.', bullets:['Cuánta “movida” hubo entre elecciones.'] },
      { id:'comp-proy', title:'Proyección simple', short:'Tendencia lineal por partido y pronóstico.', bullets:['Exploratorio; con cautela.'] },
    ];

    function openHelpModal(){
      const modal = document.getElementById('help-modal');
      const body  = document.getElementById('help-accordion');
      if (!modal || !body) return;
      if (!body.__built){
        body.innerHTML = HELP_ITEMS.map(it => `
          <details>
            <summary>${it.title}</summary>
            <p style="margin:.4rem 0;color:#37474f">${it.short}</p>
            ${it.bullets?.length ? `<ul style="margin:.2rem 0 .6rem 1rem">${it.bullets.map(b=>`<li>${b}</li>`).join('')}</ul>` : ''}
          </details>
        `).join('');
        body.__built = true;
      }
      modal.style.display='grid';
      document.getElementById('help-close')?.addEventListener('click', ()=> modal.style.display='none', { once:true });
      // Cierra con click fuera
      modal.addEventListener('click', (e)=>{ if (e.target === modal) modal.style.display='none'; }, { once:true });
    }



    
  document.addEventListener('DOMContentLoaded', () => {
    if (window.Chart && window.ChartDataLabels) {
      Chart.register(ChartDataLabels);
    }
    // …tu código que crea gráficas…
  });



  // ===== 0) Campos (ajusta si tus nombres son distintos) =====
  // DL = Distrito Local, DF = Distrito Federal
  const FIELD_KEYS = { mun: 'MUNICIPIO', dl: 'DISTRITO_L', df: 'DISTRITO_F' };


    const paths = JSON.parse(localStorage.getItem('AT_PATHS')||'{}');
    const urlGeo = paths.geo || 'data/geo/secciones.geojson';
    const catUrl = paths.catalog || 'data/catalogo_territorial.json';
    const ELP = paths.electoral?.P || 'data/electoral/P.json';
  // ...

  // Chart.js v4 necesita registrar el plugin explícitamente
  if (window.Chart && window.ChartDataLabels){
    Chart.register(ChartDataLabels);
  }

  
  // Asegura etiquetas numéricas en gráficos
  if (window.Chart && window.ChartDataLabels) {
    Chart.register(ChartDataLabels);
  }


  // ===== 1) Mapa único y chequeo =====
  function ensureLeafletMap() {
    if (window.__AT_MAP && window.__AT_MAP instanceof L.Map) return window.__AT_MAP;
    const m = L.map('map', { zoomControl:true }).setView([21.0, -101.3], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'© OSM' }).addTo(m);
    window.__AT_MAP = m;
    return m;
  }
  function assertIsLeafletMap(m) {
    if (!(m instanceof L.Map) || typeof m.addLayer !== 'function') {
      throw new Error('[AT] addTo(): destino no es un Leaflet Map. Revisa variables llamadas "map" o dobles inicializaciones.');
    }
  }

  function closeSecInfoPanel(){
    const box = document.getElementById('sec-info');
    if (box) box.style.display = 'none';
    // Si quieres limpiar resaltado y etiquetas al cerrar:
    if (typeof clearSectionOverlays === 'function') clearSectionOverlays();
  }


  function ensureSecInfoPanelWired(){
  const box = document.getElementById('sec-info');
  const hdr = box?.querySelector('.hdr');
  if (!box || !hdr || box.__wired) return;

  // Bloquear propagación al mapa (no “parpadea” al arrastrar)
  if (window.L && L.DomEvent){
    L.DomEvent.disableClickPropagation(box);
    L.DomEvent.disableScrollPropagation(box);
  }

  // Drag del panel
  let dragging = false, sx=0, sy=0, bx=0, by=0;
  hdr.addEventListener('mousedown', (e)=>{
    if (e.target.closest('.btn-close')) return; // no iniciar drag si clic en "×"
    e.preventDefault(); e.stopPropagation();
    dragging = true;
    const r = box.getBoundingClientRect();
    sx = e.clientX; sy = e.clientY; bx = r.left; by = r.top;
    box.style.position = 'absolute'; box.style.right='auto'; box.style.bottom='auto';
    document.body.style.userSelect = 'none';
  });
  window.addEventListener('mousemove', (e)=>{
    if (!dragging) return;
    e.preventDefault(); e.stopPropagation();
    const dx = e.clientX - sx, dy = e.clientY - sy;
    box.style.left = (bx + dx) + 'px';
    box.style.top  = (by + dy) + 'px';
  });
  window.addEventListener('mouseup', ()=>{
    if (!dragging) return;
    dragging = false; document.body.style.userSelect = '';
  });

  // Botón “×”
  const btn = document.getElementById('sec-close');
  if (btn && !btn.__wired){
    btn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); closeSecInfoPanel(); });
    btn.__wired = true;
  }

  box.__wired = true;
}



  // ===== 2) Filtrado por universo =====
  function toComp(v){ if(v==null) return ''; const s=String(v).trim(); return (isFinite(s) && s!=='') ? Number(s) : s.toUpperCase(); }
  function matches(props, u){
    if(u.scope==='ALL') return true;
    const keyField = u.scope==='MUN' ? FIELD_KEYS.mun : (u.scope==='DL' ? FIELD_KEYS.dl : FIELD_KEYS.df);
    return toComp(props?.[keyField]) === toComp(u.key);
  }
  function filterGeojson(geojson, u){
    if(u.scope==='ALL') return geojson;
    const features = (geojson.features || []).filter(f => matches(f.properties, u));
    return { ...geojson, features };
  }


  // ====== CARGA ELECTORAL (para obtener 24DL_LN) ======
  function getPaths(){ try{ return JSON.parse(localStorage.getItem('AT_PATHS')||'{}'); }catch{ return {}; } }
  function getPuestoPath(p){ const paths = getPaths(); return paths?.electoral?.[p] || `data/electoral/${p}.json`; }

  window.AT_ELECT = window.AT_ELECT || {};
  async function getElectData(puesto){
    if (window.AT_ELECT[puesto]) return window.AT_ELECT[puesto];
    const res = await fetch(getPuestoPath(puesto));
    if (!res.ok) throw new Error(`HTTP ${res.status} en ${puesto}`);
    const js = await res.json();
    window.AT_ELECT[puesto] = js;
    return js;
  }
  // LN para 2024 desde DL; si no hay, intenta P (fallback)
  async function getLN24DL(sec){
    const key = String(sec);
    try {
      const dl = await getElectData('DL');
      const ln = dl?.secciones?.[key]?.["2024"]?.LN;
      if (typeof ln === 'number') return ln;
    } catch(_){}
    try {
      const p = await getElectData('P');
      const ln = p?.secciones?.[key]?.["2024"]?.LN;
      if (typeof ln === 'number') return ln;
    } catch(_){}
    return null;
  }

  // ====== ADYACENCIAS (Turf) ======
  function bboxIntersects(b1, b2){
    return !(b2[0] > b1[2] || b2[2] < b1[0] || b2[1] > b1[3] || b2[3] < b1[1]);
  }
  function getAdjacents(feat){
    const all = (window.AT_DATA?.features)
            || (window.AT_CTX?.layer?.toGeoJSON?.()?.features)
            || [];
    if (!all.length) return [];
    const b1 = turf.bbox(feat);
    const out = [];
    const sec1 = feat.properties?.SECCION;
    for (const f of all){
      const p = f.properties || {};
      if (p.SECCION === sec1) continue;
      const b2 = turf.bbox(f);
      if (!bboxIntersects(b1,b2)) continue;
      try {
        if (turf.booleanTouches(feat, f) || turf.booleanOverlap(feat, f) || turf.booleanIntersects(feat, f)){
          out.push(f);
        }
      } catch(_){}
    }
    return out.slice(0, 25); // cota de seguridad
  }

  // ====== LABELS SOBRE EL MAPA ======
  function addLabelForFeature(feat, className, text){
    try {
      const c = turf.centerOfMass(feat).geometry.coordinates; // [lon, lat]
      const m = L.marker([c[1], c[0]], { icon: L.divIcon({ className, html: text, iconSize:[0,0] }) });
      window.__SEC_LABELS = window.__SEC_LABELS || L.layerGroup().addTo(ensureLeafletMap());
      window.__SEC_LABELS.addLayer(m);
      return m;
    } catch(_){}
    return null;
  }

  function clearSectionOverlays(){
    const atMap = ensureLeafletMap();
    if (window.__SEC_HL){ try{ atMap.removeLayer(__SEC_HL); }catch(_){ } window.__SEC_HL = null; }
    if (window.__SEC_ADJ){ try{ atMap.removeLayer(__SEC_ADJ); }catch(_){ } window.__SEC_ADJ = null; }
    if (window.__SEC_LABELS){ try{ atMap.removeLayer(__SEC_LABELS); }catch(_){ } window.__SEC_LABELS = null; }
  }

  // Dibuja selección + adyacentes + labels
  function paintSelectionAndAdj(feat){
    const atMap = ensureLeafletMap();
    clearSectionOverlays();

    // resaltado principal
    window.__SEC_HL = L.geoJSON(feat, { style:{ color:'#e91e63', weight:3, fillOpacity:0.25 } }).addTo(atMap);
    try { atMap.fitBounds(window.__SEC_HL.getBounds(), { padding:[28,28] }); } catch(_){}

    // adyacentes
    const adj = getAdjacents(feat);
    if (adj.length){
      window.__SEC_ADJ = L.geoJSON({type:'FeatureCollection', features:adj}, { style:{ color:'#90a4ae', weight:1.2, dashArray:'4,4', fillOpacity:0.05 } }).addTo(atMap);
    }

    // labels
    const sec = feat.properties?.SECCION ?? '—';
    addLabelForFeature(feat, 'sec-label', `Sección ${sec}`);
    for (const f of adj){
      const s2 = f.properties?.SECCION ?? '—';
      addLabelForFeature(f, 'sec-label-adj', s2);
    }
  }

  // ====== PANEL FLOTANTE (drag + datos) ======
  (function wireSecInfoPanel(){
    const box = document.getElementById('sec-info');
    const hdr = box?.querySelector('.hdr');
    if (!box || !hdr || box.__wired) return;
    let dragging = false, sx=0, sy=0, bx=0, by=0;
    hdr.addEventListener('mousedown', (e)=>{
      dragging=true; sx=e.clientX; sy=e.clientY;
      const r = box.getBoundingClientRect(); bx=r.left; by=r.top;
      document.body.style.userSelect='none';
    });
    window.addEventListener('mousemove', (e)=>{
      if (!dragging) return;
      const dx = e.clientX - sx, dy = e.clientY - sy;
      box.style.left = (bx + dx) + 'px';
      box.style.top  = (by + dy) + 'px';
      box.style.right = 'auto'; box.style.bottom='auto';
      box.style.position = 'absolute';
    });
    window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; });
    box.__wired = true;
  })();

  async function showSectionInfo(feat){
    ensureSecInfoPanelWired();
    const p = feat.properties || {};
    const sec = p.SECCION ?? '—';
    const df  = p[FIELD_KEYS.df] ?? '—';
    const dl  = p[FIELD_KEYS.dl] ?? '—';

    // LN 24DL_LN
    let ln = await getLN24DL(sec);
    if (ln==null) ln = '—';

    // Pintar
    const box = document.getElementById('sec-info');
    box.querySelector('.hdr').textContent = `Sección ${sec}`;
    document.getElementById('si-sec').textContent = sec;
    document.getElementById('si-df').textContent  = df;
    document.getElementById('si-dl').textContent  = dl;
    document.getElementById('si-ln').textContent  = ln;
    box.style.display = 'block';
  }



  // ENTER + CLIC + ULTIMO TOKEN

    function currentNeedle(q){
      if (!q) return '';
      const parts = String(q).split(/[,;\s]+/).filter(Boolean);
      return parts.length ? parts[parts.length-1] : '';
    }

// ===== Mini-selector de universo dentro del módulo =====
    let __mini = { selMun:null, selDf:null, selDl:null, all:null };

    function uniqueSorted(values){
    const arr = values.map(v => String(v ?? '').trim()).filter(Boolean);
    const set = Array.from(new Set(arr));
    return set.sort((a,b) => (isFinite(a)&&isFinite(b)) ? Number(a)-Number(b) : a.localeCompare(b,'es'));
    }
    function buildMiniOptions(raw){
    const feats = raw.features || [];
    const grab = k => uniqueSorted(feats.map(f => f.properties?.[k]));
    return { mun: grab(FIELD_KEYS.mun), df: grab(FIELD_KEYS.df), dl: grab(FIELD_KEYS.dl) };
    }
    function fillSelect(sel, arr){
    sel.innerHTML = '<option value="">— Ninguno —</option>' + arr.map(v=>`<option value="${v}">${v}</option>`).join('');
    }
    function getMiniUniverse(){
    const { selMun, selDf, selDl, all } = __mini;
    if(all.checked) return { scope:'ALL', key:null, label:'Estado completo' };
    if(selMun.value) return { scope:'MUN', key: selMun.value, label:`Municipio ${selMun.options[selMun.selectedIndex].text}` };
    if(selDf.value)  return { scope:'DF',  key: selDf.value,  label:`Distrito Federal ${selDf.value}` };
    if(selDl.value)  return { scope:'DL',  key: selDl.value,  label:`Distrito Local ${selDl.value}` };
    return null;
    }
    function miniExclusivity(which){
    const { selMun, selDf, selDl, all } = __mini;
    if(which==='ALL'){ selMun.value=''; selDf.value=''; selDl.value=''; }
    if(which==='MUN'){ selDf.value=''; selDl.value=''; all.checked=false; }
    if(which==='DF'){  selMun.value=''; selDl.value=''; all.checked=false; }
    if(which==='DL'){  selMun.value=''; selDf.value=''; all.checked=false; }
    applyMiniUniverse();
    }
    function applyMiniUniverse(){
    const u2 = getMiniUniverse();
    if(!u2) return;
    // 1) Persistir
    localStorage.setItem('AT_UNIVERSE', JSON.stringify({ ...u2, ts:Date.now() }));
    // 2) Redibujar con el nuevo universo usando el raw ya cargado
    const atMap = ensureLeafletMap();
    const filtered2 = filterGeojson(window.AT_DATA, u2);
    if (window.AT_CTX?.layer) { atMap.removeLayer(AT_CTX.layer); }
    const layer2 = L.geoJSON(filtered2, { style:{ color:'#7d0025', weight:1.2, fillOpacity:0.15 } }).addTo(atMap);
    try { atMap.fitBounds(layer2.getBounds(), { padding:[20,20] }); } catch(e){}
    window.AT_CTX = { ...(window.AT_CTX||{}), universe: u2, layer: layer2 };
    // 3) Header
    const hdr = document.querySelector('#panel-header span');
    if(hdr){ hdr.textContent = `Análisis Territorial · ${u2.label}`; }
      refreshSectionSearch(u2);
    }
    function initMiniSelector(raw, u){
    // Guardar el geojson bruto para futuros re-filtros
    window.AT_DATA = raw;

    __mini.selMun = document.getElementById('mini-sel-mun');
    labelMunicipiosFromCatalog('#mini-sel-mun');

    __mini.selDf  = document.getElementById('mini-sel-df');
    __mini.selDl  = document.getElementById('mini-sel-dl');
    __mini.all    = document.getElementById('mini-all-state');

    const opt = buildMiniOptions(raw);
    fillSelect(__mini.selMun, opt.mun);
    fillSelect(__mini.selDf,  opt.df);
    fillSelect(__mini.selDl,  opt.dl);

    // Reflejar el universo actual
    if(u.scope==='ALL'){ __mini.all.checked = true; }
    if(u.scope==='MUN'){ __mini.selMun.value = String(u.key); }
    if(u.scope==='DF'){  __mini.selDf.value  = String(u.key); }
    if(u.scope==='DL'){  __mini.selDl.value  = String(u.key); }


    
        async function labelMunicipiosFromCatalog(selectId){
        const sel = document.querySelector(selectId);
        if (!sel) return;

        // 1) Ruta del catálogo desde el Portal (AT_PATHS) o fallback
        let catUrl = 'data/catalogo_territorial.json';
        try {
            const paths = JSON.parse(localStorage.getItem('AT_PATHS') || '{}');
            if (paths?.catalog) catUrl = paths.catalog;
        } catch {}

        // 2) Cargar catálogo
        let cat = null;
        try {
            const r = await fetch(catUrl);
            if (!r.ok) throw new Error('HTTP '+r.status);
            cat = await r.json();
        } catch (e) {
            console.warn('[AT] No se pudo cargar el catálogo:', e);
            return; // salimos sin tocar etiquetas
        }

        const mapa = cat?.municipios || {};
        // helper: si el catálogo trae ceros a la izquierda en las llaves
        const getName = (code) => {
            const s = String(code);
            return mapa[s] || mapa[s.padStart(2,'0')] || mapa[s.padStart(3,'0')] || s;
        };

        // 3) Reetiquetar opciones (sin cambiar value)
        for (const opt of sel.options) {
            if (!opt.value) continue; // deja "— Ninguno —"
            const name = getName(opt.value);
            opt.text = `${opt.value} — ${name}`;
        }
        }

   

    // Eventos (auto-ejecuta)
    __mini.selMun.addEventListener('change', ()=> miniExclusivity('MUN'));
    __mini.selDf .addEventListener('change', ()=> miniExclusivity('DF'));
    __mini.selDl .addEventListener('change', ()=> miniExclusivity('DL'));
    __mini.all   .addEventListener('change', ()=> miniExclusivity('ALL'));
    }


    // Nombre fijo del campo (texto) del municipio
    const MUN_NAME_KEY = 'MUNICIPIO';

    // Detecta automáticamente el campo de CÓDIGO de municipio (si no, usa el nombre)
    function detectMunCodeKey(raw){
    const feats = raw.features || [];
    const candidates = ['MUN','CVE_MUN','CLV_MUN','ID_MUN','MUNICIPIO_ID','MUNICIPIO_CVE','CVE_MUNICIPIO','CVE_MPIO'];
    for (const k of candidates) {
        const ok = feats.some(f => {
        const v = f.properties?.[k];
        return v != null && String(v).trim() !== '' && String(v).toUpperCase() !== 'NULL';
        });
        if (ok) return k;
    }
    return null; // fallback será MUN_NAME_KEY
    }



      // —— Utils de texto ——
      function _norm(s){
        if (s==null) return '';
        return String(s).normalize('NFD').replace(/[\u0300-\u036f]/g,'').toUpperCase().trim();
      }
      function _isDigits(s){ return /^[0-9]+$/.test(String(s||'')); }

      // —— Nombre de municipio desde catálogo (si existe) ——
      function getMunNameFromCatalog(code){
        const cat = window.AT_CATALOG;
        if (!cat?.municipios) return String(code ?? '');
        const s = String(code);
        // maneja posibles ceros a la izquierda
        return cat.municipios[s] || cat.municipios[s.padStart(2,'0')] || cat.municipios[s.padStart(3,'0')] || s;
      }

      // —— Índice de secciones ——
      let __SEC_INDEX = { items: [], global: false };

      function buildSectionIndex(raw, universe, useGlobal){
        const feats = (raw?.features || []);
        const munKey = (window.AT_KEYS?.munCode) || FIELD_KEYS.mun;
        const items = [];

        // dataset base: global = todas, local = filtradas por universo
        const base = useGlobal ? feats : (filterGeojson(raw, universe).features || []);

        for(const f of base){
          const p = f.properties || {};
          const sec = p.SECCION ?? p.Seccion ?? p.seccion ?? null;
          if (sec == null) continue;

          const munCode = p[munKey];
          const munName = getMunNameFromCatalog(munCode);
          const df = p[FIELD_KEYS.df];
          const dl = p[FIELD_KEYS.dl];

          // texto para búsqueda
          const text = `${sec} ${munCode ?? ''} ${munName ?? ''} ${df ?? ''} ${dl ?? ''}`;
          // bounds (si multiparte, Leaflet lo resuelve)
          let bounds = null;
          try { bounds = L.geoJSON(f).getBounds(); } catch(_){}

          items.push({
            sec: String(sec).trim(),
            munCode: munCode,
            munName: munName,
            df, dl, feature: f, textNorm: _norm(text), bounds
          });
        }

        __SEC_INDEX = { items, global: !!useGlobal };
      }

      function searchSections(query, limit=15){
        const q = _norm(query);
        if (!q) return [];
        const ds = __SEC_INDEX.items;

        // Heurística sencilla:
        // - si es numérico puro: prioridad a SECCION que empiece con q
        // - si no: contiene tokens
        if (_isDigits(q)){
          const starts = ds.filter(it => _norm(it.sec).startsWith(q));
          if (starts.length >= limit) return starts.slice(0, limit);
          const contains = ds.filter(it => _norm(it.sec).includes(q));
          return [...starts, ...contains].slice(0, limit);
        } else {
          const tokens = q.split(/\s+/).filter(Boolean);
          return ds.filter(it => tokens.every(t => it.textNorm.includes(t))).slice(0, limit);
        }
      }

      // —— UI de sugerencias ——
      let __SEC_HIGHLIGHT = null;

      function renderSecSuggestions(list){
        const ul = document.getElementById('sec-suggest');
        if (!ul) return;
        if (!list.length){ ul.style.display='none'; ul.innerHTML=''; return; }

        ul.innerHTML = list.map(it => {
          const label = `${it.sec} — ${it.munName || it.munCode || ''}`.replace(/\s+-\s+$/, '');
          const meta  = [];
          if (it.dl!=null) meta.push(`DL ${it.dl}`);
          if (it.df!=null) meta.push(`DF ${it.df}`);
          const sub = meta.length ? `<small style="color:#64748b">${meta.join(' · ')}</small>` : '';
          return `<li data-sec="${it.sec}" style="padding:6px 8px; border-bottom:1px solid #e5e7eb; cursor:pointer">
                    <div>${label}</div>${sub}
                  </li>`;
        }).join('');
        ul.style.display = 'block';


      }

   

    function gotoSection(item){
      const atMap = (window.AT_CTX?.map) || ensureLeafletMap();

      // 1) Resolver el feature de la sección
      const sec = String(item.sec ?? item.SECCION ?? '');
      let feat = item.feature;

      if (!feat) {
        const feats =
          (window.AT_CTX?.layer?.toGeoJSON?.().features) ||
          (window.AT_DATA?.features) || [];
        feat = feats.find(f => normSec(f.properties?.SECCION) === normSec(sec));
      }

      if (!feat) {
        console.warn('[AT] No encontré el feature para la sección', sec, item);
        return;
      }

      // 2) Pintar selección + adyacentes + labels (esto limpia overlays previos)
      paintSelectionAndAdj(feat);

      window.AT_SELECTED_SECTION = sec;
      document.getElementById('btn-comp-puesto')?.removeAttribute('disabled');

      // Guarda sección activa y habilita botones de la barra
      document.getElementById('btn-competitividad')?.removeAttribute('disabled');

      document.getElementById('btn-top3')?.removeAttribute('disabled');


      // 3) Mostrar panel con DF, DL y LN (24DL_LN)
      showSectionInfo(feat);

      // 4) Feedback visual (parpadeo leve sobre el highlight actual)
      const hl = window.__SEC_HL;
      if (hl && typeof hl.setStyle === 'function') {
        try {
          hl.setStyle({ weight: 4 });
          setTimeout(() => { try { hl.setStyle({ weight: 3 }); } catch(_){} }, 220);
        } catch(_){}
      }

      // 5) Oculta la lista de sugerencias (si está visible)
      const ul = document.getElementById('sec-suggest');
      if (ul) ul.style.display = 'none';
    }


      // Delegación de clic en las sugerencias (una sola vez)
    (function wireSectionSearchEventsOnce(){
      const ul = document.getElementById('sec-suggest');
      const input = document.getElementById('sec-q');
      if (!ul || !input) return;

       // Si está dentro de un form, evita submit al Enter
      const form = input.closest('form');
      form?.addEventListener('submit', e => e.preventDefault());

      // Clic en cualquier <li data-sec="...">
      if (!ul.__wiredClick){
        ul.addEventListener('click', (ev)=>{
          const li = ev.target.closest('li[data-sec]');
          if (!li) return;
          const sec = li.getAttribute('data-sec');
          const item = (__SEC_INDEX?.items||[]).find(x => String(x.sec) === String(sec));
          if (item) gotoSection(item);
          ul.style.display = 'none';
        });
        ul.__wiredClick = true;
      }

      // Enter en el input = ir al primer resultado
      if (!input.__wiredKey){
        input.addEventListener('keydown', (ev)=>{
          if (ev.key === 'Enter'){
            ev.preventDefault(); // <- evita submit/autocomplete
            const results = searchSections(input.value, 1);
        const needle = currentNeedle(input.value);
        const [first] = searchSections(needle, 1);
        if (first) gotoSection(first);
        ul.style.display = 'none';
       }
          if (ev.key === 'Escape'){
            ul.style.display = 'none';
          }
        });
        input.__wiredKey = true;
      }

      // Input: recalcula sugerencias usando el "último token"
      if (!input.__wiredInput){
        input.addEventListener('input', ()=>{
          const needle = currentNeedle(input.value);
          renderSecSuggestions(searchSections(needle, 15));
        });
        input.__wiredInput = true;
      }
    })();


      // —— Inicializar Buscador en el módulo ——
      function initSectionSearch(raw, universe){
        const input   = document.getElementById('sec-q');
        const list    = document.getElementById('sec-suggest');
        const globalC = document.getElementById('sec-global');
        if (!input || !list) return;

        // construir índice (por universo actual)
        buildSectionIndex(raw, universe, !!globalC?.checked);



        // Cambiar ámbito (global / universo actual)
        globalC?.addEventListener('change', () => {
          buildSectionIndex(raw, universe, !!globalC.checked);
          // refresca sugerencias con la query actual
          if (input.value){
            renderSecSuggestions(searchSections(input.value, 15));
          }
        });
      }

      // —— Cuando cambies de universo con tu mini-selector, reindexa ——
      function refreshSectionSearch(universe){
        const input   = document.getElementById('sec-q');
        const globalC = document.getElementById('sec-global');
        if (!window.AT_DATA || !input) return;
        buildSectionIndex(window.AT_DATA, universe, !!globalC?.checked);
        if (input.value){
          renderSecSuggestions(searchSections(input.value, 15));
        }
      }


      function getRawForIndex(){
        // Usa el dataset completo si ya lo cacheaste
        if (window.AT_DATA) return window.AT_DATA;
        // Si no, al menos usa lo ya pintado en el mapa
        const lyr = window.AT_CTX?.layer;
        return (lyr && typeof lyr.toGeoJSON === 'function') ? lyr.toGeoJSON() : null;
  }


  // ===== 3) Boot =====
  document.addEventListener('DOMContentLoaded', async () => {
    // a) Leer universo y rutas puestos en el PORTAL
    const u     = JSON.parse(localStorage.getItem('AT_UNIVERSE') || 'null');
    const paths = JSON.parse(localStorage.getItem('AT_PATHS') || '{"geo":""}');
    if (!u) {
      const hdr = document.querySelector('#panel-header span');
      hdr && (hdr.textContent += ' · selecciona el universo en el Portal');
      setTimeout(()=>{ location.href = 'portal.html'; }, 600);
      return;
    }

    // b) Etiqueta del universo
    const hdr = document.querySelector('#panel-header span');
    hdr && (hdr.textContent += ` · ${u.label}`);

    // c) Mapa único
    const atMap = ensureLeafletMap();
    assertIsLeafletMap(atMap);

    // d) Cargar y filtrar GeoJSON
    const url = paths.geo || 'data/geo/secciones.geojson'; // <-- ajusta si tu ruta difiere

    // Cargar catálogo territorial (para nombres visibles)
    const catUrl = (paths.catalog && paths.catalog.trim()) || '/data/catalogo_territorial.json';
    let catalog = window.AT_CATALOG || null;
    if (!catalog) {
    try {
        const rc = await fetch(catUrl);
        if (!rc.ok) throw new Error(`HTTP ${rc.status} al cargar catálogo ${catUrl}`);
        catalog = await rc.json();
        window.AT_CATALOG = catalog;
    } catch (err) {
        console.warn('[AT] No se pudo cargar el catálogo de nombres:', err);
        window.AT_CATALOG = catalog = null; // seguimos sin nombres amigables
    }
    }


 let raw = window.AT_DATA || null; // usa caché si ya existe
if (!raw) {
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status} al cargar ${url}`);
    raw = await res.json();       // ✅ solo una vez
    window.AT_DATA = raw;         // ✅ guarda en caché aquí
  } catch (err) {
    console.error('[AT] Error cargando GeoJSON:', err);
    alert('No se pudo cargar el GeoJSON');
    return;
  }
}
// a partir de aquí, usa 'raw'

    const filtered = filterGeojson(raw, u);
    console.log('[AT] Universo:', u, 'Total:', raw.features?.length||0, 'Filtradas:', filtered.features?.length||0);

    if(!filtered.features || filtered.features.length===0){
      console.warn('[AT] No hay geometrías para el universo seleccionado:', u);
      alert('No hay datos para el universo seleccionado');
    }

    // Nombre fijo del campo (texto) del municipio
        const MUN_NAME_KEY = 'MUNICIPIO';

    // Detecta campo de CÓDIGO (si existe); si no, usa el de nombre
        function detectMunCodeKey(raw){
        const feats = raw.features || [];
        const candidates = ['MUN','CVE_MUN','CLV_MUN','ID_MUN','MUNICIPIO_ID','MUNICIPIO_CVE','CVE_MUNICIPIO','CVE_MPIO'];
        for (const k of candidates) {
            if (feats.some(f => (f.properties?.[k] ?? '') !== '')) return k;
        }
        return null;
        }

        const munCodeKey = detectMunCodeKey(raw) || MUN_NAME_KEY; // fallback: nombre
        FIELD_KEYS.mun = munCodeKey;
        window.AT_KEYS = { munCode: munCodeKey, munName: MUN_NAME_KEY };


    // e) Dibujar capa
        const layer = L.geoJSON(filtered, {
      style: { color:'#000000', weight:1.2, fillOpacity:0.15 },
      onEachFeature: (feat, lyr) => {
        const p = feat.properties || {};
        const muni = p[FIELD_KEYS.mun] ?? '—';
        const dl   = p[FIELD_KEYS.dl]  ?? '—';
        const df   = p[FIELD_KEYS.df]  ?? '—';
        lyr.bindPopup(`<b>Sección</b>: ${p.SECCION ?? '—'}<br><b>Mun</b>: ${muni}<br><b>DL</b>: ${dl}<br><b>DF</b>: ${df}`);
        lyr.on('mouseover', () => lyr.setStyle({weight:2}));
        lyr.on('mouseout',  () => lyr.setStyle({weight:1.2}));
      }
    }).addTo(atMap);

    try { atMap.fitBounds(layer.getBounds(), { padding:[20,20] }); } catch(e){}
    window.AT_CTX = { universe: u, paths, map: atMap, layer };

    function getMunNameFromCatalog(code){
  const cat = window.AT_CATALOG;
  if (!cat?.municipios) return String(code ?? '');
  return cat.municipios[String(code)] || String(code ?? '');
}
function getDfListFromCatalog(feats){
  return (window.AT_CATALOG?.distritos_federales && window.AT_CATALOG.distritos_federales.length)
    ? window.AT_CATALOG.distritos_federales
    : uniqSorted(feats.map(f => f.properties?.[FIELD_KEYS.df]));
}
function getDlListFromCatalog(feats){
  return (window.AT_CATALOG?.distritos_locales && window.AT_CATALOG.distritos_locales.length)
    ? window.AT_CATALOG.distritos_locales
    : uniqSorted(feats.map(f => f.properties?.[FIELD_KEYS.dl]));
}
    initMiniSelector(raw, u);
    initSectionSearch(window.AT_DATA || raw, u);

  });

  // Carga y cache
  window.AT_ELECT = window.AT_ELECT || {};
  function getPaths(){ try{ return JSON.parse(localStorage.getItem('AT_PATHS')||'{}'); }catch{ return {}; } }
  function getPuestoPath(p){ const paths=getPaths(); return paths?.electoral?.[p] || `data/electoral/${p}.json`; }
  async function loadPuesto(p){
    if (AT_ELECT[p]) return AT_ELECT[p];
    const r = await fetch(getPuestoPath(p) + `?v=${Date.now()}`);
    if (!r.ok) throw new Error(`HTTP ${r.status} al cargar ${p}.json`);
    AT_ELECT[p] = await r.json();
    return AT_ELECT[p];
  }

  // Detector
  function detectSchemaFrom(data){
    const secs = data?.secciones || {};
    const firstKey = Object.keys(secs)[0];
    const slot = secs[firstKey] || {};
    const years = Object.keys(slot).filter(k => /^\d{4}$/.test(k)).map(n=>+n).sort();
    // toma un año “reciente” para inferir partidos
    const row = slot[String(years[years.length-1])] || slot[String(years[0])] || {};
    const parties = (data?.meta?.parties && data.meta.parties.length)
      ? data.meta.parties
      : Object.keys(row).filter(k => !['VOTOS','LN'].includes(k));
    return { years, parties, exampleSection:firstKey, exampleRow: row };
  }

  // Uso rápido en consola:
  (async ()=>{
    const A = await loadPuesto('A');  // cambia a 'P','DF','DL','G','S' para probar
    const info = detectSchemaFrom(A);
    console.log('[A] years:', info.years, 'parties:', info.parties);
    console.log('[A] example row:', info.exampleSection, info.exampleRow);
  })();


  (function wireATHotkeys(){
      if (window.__AT_HOTKEYS) return;
      window.__AT_HOTKEYS = true;

      window.addEventListener('keydown', (e)=>{
        // Esc: cerrar panel
        if (e.key === 'Escape'){
          if (document.getElementById('sec-info')?.style.display !== 'none'){
            e.preventDefault();
            closeSecInfoPanel();
          }
        }
        // Ctrl+K (o Cmd+K en Mac): enfocar buscador de secciones
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k'){
          e.preventDefault();
          document.getElementById('sec-q')?.focus();
        }
      });
    })();

    // Mostrar/ocultar el rail (colapso)
    

    // Stubs (los conectamos después con tus gráficas/núcleo)
    function openHistorialUI(){ /* abrir panel/modal con charts */ }
    function openProyeccionUI(){ /* ... */ }
    async function paintByMargin({puesto,year}){ /* ... usando universe/sectionMetrics */ }
    function exportMapPNG(){ /* ... */ }


  // Marca uno como activo al cargar (para ver el color desde el inicio)
  document.addEventListener('DOMContentLoaded', ()=>{
    document.querySelector('#railGroup .tool')?.classList.add('active');
  });

  // ====== Loader electoral + helpers ======
    window.AT_ELECT = window.AT_ELECT || {};
    function getPaths(){ try{return JSON.parse(localStorage.getItem('AT_PATHS')||'{}');}catch{return{};} }
    function getPuestoPath(p){ const paths=getPaths(); return paths?.electoral?.[p]||`data/electoral/${p}.json`; }
    async function loadPuesto(p){ if(AT_ELECT[p]) return AT_ELECT[p]; const r=await fetch(getPuestoPath(p)+`?v=${Date.now()}`); AT_ELECT[p]=await r.json(); return AT_ELECT[p]; }
    const asInt0=v=>(v==null||(typeof v==='number'&&v!==v)||String(v).trim()==='')?0:Math.round(+v||0);
    const secKey=s=>String(s).replace(/\D+/g,'').padStart(4,'0');
    function winnerOf(votes){ let best=null,max=-1; for(const[k,v]of Object.entries(votes)){ if(v>max){max=v;best=k;} } const tot=Object.values(votes).reduce((a,b)=>a+b,0); return {party:best,votes:max,total:tot}; }
    const CORE_PARTIES=['PAN','PRI','PVEM','MORENA'];
    const PARTY_COLORS={PAN:'#1e88e5',PRI:'#c62828',PVEM:'#2e7d32',MORENA:'#7b1fa2',OTROS:'#90a4ae'};

    // ====== Panel: drag + close ======
    (function wireHistPanel(){
      const box=document.getElementById('hist-panel');
      const hdr=box?.querySelector('.hdr');
      const close=document.getElementById('hist-close');
      if(!box||!hdr||box.__wired) return;
      if(window.L&&L.DomEvent){ L.DomEvent.disableClickPropagation(box); L.DomEvent.disableScrollPropagation(box); }
      let dragging=false,sx=0,sy=0,bx=0,by=0;
      hdr.addEventListener('mousedown',e=>{
        if(e.target.closest('.btn-close')||e.target.tagName==='SELECT') return;
        e.preventDefault(); e.stopPropagation();
        const r=box.getBoundingClientRect(); dragging=true; sx=e.clientX; sy=e.clientY; bx=r.left; by=r.top;
        box.style.position='absolute'; box.style.right='auto'; box.style.bottom='auto'; document.body.style.userSelect='none';
      });
      window.addEventListener('mousemove',e=>{
        if(!dragging) return; e.preventDefault(); e.stopPropagation();
        const dx=e.clientX-sx, dy=e.clientY-sy; box.style.left=(bx+dx)+'px'; box.style.top=(by+dy)+'px';
      });
      window.addEventListener('mouseup',()=>{ if(!dragging) return; dragging=false; document.body.style.userSelect=''; });
      close?.addEventListener('click',()=>{ box.style.display='none'; destroyHistCharts(); });
      box.__wired=true;
    })();

    function getActiveSectionSec(){
        const hl=window.__SEC_HL;
        if(hl?.getLayers){ const lyr=hl.getLayers()[0]; return lyr?.feature?.properties?.SECCION??null; }
        const t=document.getElementById('si-sec')?.textContent; return t&&t!=='—'?t:null;
      }

    // Compat no-op: por si quedó alguna llamada vieja
    function runTool(){ /* eliminado: barra vertical */ }


    // Normaliza: "0007" -> "7", "201" -> "201", 7 -> "7"
    const normSec = s => String(s ?? '').replace(/\D+/g, '');

    // Busca la fila de la sección en el JSON, tolerando distintos formatos de clave
    function findSecSlot(data, sec){
      const k = normSec(sec);
      const map = data?.secciones || {};
      return map[k]                  // "201"
          ?? map[k.padStart(4,'0')]  // "0201"
          ?? map[String(+k)]         // 201 (si estuviera como número)
          ?? null;
    }

    // Igualdad de secciones robusta
    const eqSec = (a,b) => normSec(a) === normSec(b);


    // ====== Charts ======
    let __HIST_CHART_BAR=null,__HIST_CHART_WIN=null,__HIST_CHART_PIE=null;
    function destroyHistCharts(){ try{__HIST_CHART_BAR?.destroy();}catch(_){}
      try{__HIST_CHART_WIN?.destroy();}catch(_){}
      try{__HIST_CHART_PIE?.destroy();}catch(_){}
      __HIST_CHART_BAR=__HIST_CHART_WIN=__HIST_CHART_PIE=null; }

    async function renderHistorialCharts(){
      const panel=document.getElementById('hist-panel');
      const puesto=document.getElementById('hist-puesto').value||'P';
      const sec=getActiveSectionSec();
      if(!sec){ alert('Selecciona una sección en el mapa.'); return; }
      document.getElementById('hist-sec').textContent=sec;

    const data = await loadPuesto(puesto);
    const slot = findSecSlot(data, sec);
    if (!slot){ destroyHistCharts(); console.warn('[Hist] sin datos', sec, puesto); return; }

    // Opción 1 (auto-detecta los años disponibles en esa sección)
    const years = Object.keys(slot).filter(k=>/^\d{4}$/.test(k)).map(Number).sort();
    // Opción 2 (forzar 2018/2021/2024 aunque falte alguno)
    // const years = [2018, 2021, 2024];

    const rows  = years.map(y => slot[String(y)] || null);


      destroyHistCharts();

      // 1) Historial (barras agrupadas)
      const barLabels=years.map(String);
      const barDS=CORE_PARTIES.map(p=>({ label:p, data:rows.map(r=>asInt0(r?.[p])), backgroundColor:PARTY_COLORS[p]||'#90a4ae' }));
      __HIST_CHART_BAR=new Chart(document.getElementById('hist-bar').getContext('2d'),{
        type:'bar', data:{labels:barLabels,datasets:barDS},
        options:{responsive:true,maintainAspectRatio:false,resizeDelay:150,animation:false,
           plugins:{legend:{position:'bottom'},datalabels:{anchor:'end',align:'top',formatter:v=>v||''}},
          scales:{y:{beginAtZero:true}}
        }
      });

      // 2) Ganadores por año (barras)
      const winLabels=[],winData=[],winColors=[];
      years.forEach((y,i)=>{ const r=rows[i]||{}; const v={}; CORE_PARTIES.forEach(p=>v[p]=asInt0(r[p]));
        const w=winnerOf(v); winLabels.push(`${y} • ${w.party||'—'}`); winData.push(asInt0(w.votes)); winColors.push(PARTY_COLORS[w.party]||'#90a4ae'); });
      __HIST_CHART_WIN=new Chart(document.getElementById('hist-win').getContext('2d'),{
        type:'bar', data:{labels:winLabels,datasets:[{label:'Votos',data:winData,backgroundColor:winColors}]},
        options:{responsive:true,maintainAspectRatio:false,resizeDelay:150,animation:false,plugins:{legend:{display:false},datalabels:{anchor:'end',align:'top',formatter:v=>v||''}},scales:{y:{beginAtZero:true}}}
      });

      // 3) Competencia (pie) — usa SIEMPRE el último año disponible
      const rLast     = rows[rows.length - 1] || {};
      const pieLabels = CORE_PARTIES;  // o filtra si quieres mostrar solo los que tienen datos
      const pieData   = pieLabels.map(p => asInt0(rLast[p]));
      const pieTotal  = pieData.reduce((a,b)=>a+b,0) || 1;

      __HIST_CHART_PIE = new Chart(
        document.getElementById('hist-pie').getContext('2d'),
        {
          type: 'pie',
          data: {
            labels: pieLabels,
            datasets: [{
              data: pieData,
              backgroundColor: pieLabels.map(p => PARTY_COLORS[p] || '#90a4ae')
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            resizeDelay: 150,
            animation: false,
            plugins: {
              legend: { position: 'bottom' },
              datalabels: {
                formatter: (v) => ((v / pieTotal * 100).toFixed(1) + '%'),
                color: '#111'
              },
              // opcional: rotula el año que se muestra
              title: {
                display: true,
                text: `Competencia ${years[years.length - 1]} (% del total)`
              }
            }
          }
        }
      );
      if (document.getElementById('hist-qa')?.style.display !== 'none') renderHistQA();


    }

    function openHistorialUI(){
      const box=document.getElementById('hist-panel');
      box.style.display='block';
      const sel=document.getElementById('hist-puesto');
      if(!sel.__wired){ sel.addEventListener('change',renderHistorialCharts); sel.__wired=true; }
      renderHistorialCharts();
    }

    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('btn-historial');
      if (btn) btn.addEventListener('click', () => openHistorialUI());
    });

    
    function getHistContext(){
      const sec = (typeof getActiveSectionSec==='function') ? getActiveSectionSec() : null;
      const selP = document.getElementById('hist-puesto');
      const selY = document.getElementById('hist-year');
      const puesto = selP?.value || 'P';
      const year   = selY?.value || '2024';
      const label  = (window.PUESTO_LABEL?.[puesto]) || puesto;
      return { sec, puesto, year, label };
    }


  // Helpers mínimos
  
  function fmt(n){ return (n==null || isNaN(n)) ? '—' : Number(n).toLocaleString('es-MX'); }
  function fmtPct(x){ return (!isFinite(x)) ? '—' : (x.toFixed(1) + '%'); }

  async function getPuestoData(p){
    window.AT_ELECT = window.AT_ELECT || {};
    if (window.AT_ELECT[p]) return window.AT_ELECT[p];
    const paths = JSON.parse(localStorage.getItem('AT_PATHS')||'{}');
    const url = (paths.electoral && paths.electoral[p]) || `data/electoral/${p}.json`;
    const res = await fetch(url);
    const json = await res.json();
    window.AT_ELECT[p] = json;
    return json;
  }
  function getSlotRow(data, sec, year){
    // Reutiliza tu helper existente para encontrar la sección
    const slot = (typeof findSecSlot === 'function')
      ? findSecSlot(data, sec)
      : (data?.secciones?.[String(sec)] || null);

    return slot ? (slot[year] || null) : null;
  }

  function winnerAndMargin(row){
    const PAN = +row.PAN||0, PRI=+row.PRI||0, PVEM=+row.PVEM||0, MORENA=+row.MORENA||0;
    const arr = [['PAN',PAN],['PRI',PRI],['PVEM',PVEM],['MORENA',MORENA]].sort((a,b)=>b[1]-a[1]);
    const gan = arr[0], seg = arr[1] || ['—',0];
    const votos = +row.VOTOS||0;
    const margen = (gan[1] - seg[1]);
    const margenPct = votos>0 ? (margen / votos * 100) : 0;
    return { ganador: gan[0], margen, margenPct };
  }           


  async function renderHistQA(){
    const qaBox = document.getElementById('hist-qa');
    if (!qaBox || qaBox.style.display==='none') return;

    const { sec, puesto, year, label } = getHistContext();
    const ctx = document.getElementById('hist-qa-context');
    if (!sec){ ctx.textContent = 'Selecciona una sección en el mapa.'; return; }

    const route = `data/electoral/${puesto}.json → secciones["${String(sec)}"]["${String(year)}"]`;
    ctx.innerHTML = `
      <div><b>Contexto:</b> SEC-${sec} · ${label} · ${year}</div>
      <!-- <div><b>Ruta interna:</b> <code>${route}</code></div> -->
    `;

    // --- Fuente interna (App/JSON)
    const tbl = document.getElementById('qa-app-table');
    const warn = document.getElementById('qa-app-warn');
    if (!tbl) return;

    const data = await getPuestoData(puesto);
    const row  = getSlotRow(data, sec, year);

    if (!row){
      tbl.innerHTML = '<tr><td>No hay datos para esta combinación.</td></tr>';
      warn.textContent = '';
      return;
    }

    const PAN=+row.PAN||0, PRI=+row.PRI||0, PVEM=+row.PVEM||0, MORENA=+row.MORENA||0;
    const VOTOS=+row.VOTOS||0, LN=+row.LN||0;
    const totPart = PAN+PRI+PVEM+MORENA;
    const otros   = VOTOS - totPart;
    const partPct = (VOTOS>0 && LN>0) ? (VOTOS/LN*100) : NaN;
    const { ganador, margen, margenPct } = winnerAndMargin(row);

    tbl.innerHTML = `
      <thead>
        <tr>
          <th>Campo</th><th>Valor</th>
        </tr>
      </thead>
      <tbody>
        <tr><td>PAN</td><td>${fmt(PAN)}</td></tr>
        <tr><td>PRI</td><td>${fmt(PRI)}</td></tr>
        <tr><td>PVEM</td><td>${fmt(PVEM)}</td></tr>
        <tr><td>MORENA</td><td>${fmt(MORENA)}</td></tr>
        <tr><td><b>VOTOS (total)</b></td><td><b>${fmt(VOTOS)}</b></td></tr>
        <tr><td>LN</td><td>${fmt(LN)}</td></tr>
        
        <!-- <tr><td>Total partidos (4)</td><td>${fmt(totPart)}</td></tr> -->
        <!-- <tr><td>OTROS = VOTOS - Total partidos</td><td class="${otros!==0?'bad-cell':''}">${fmt(otros)}</td></tr> -->
        <!-- <tr><td>Participación</td><td>${fmtPct(partPct)}</td></tr> -->
        <!-- <tr><td>Ganador</td><td>${ganador}</td></tr> -->
        <!-- <tr><td>Margen</td><td>${fmt(margen)} (${fmtPct(margenPct)})</td></tr>// -->
      </tbody>
    `;

    warn.textContent = (otros!==0)
      ? 'Aviso: La suma PAN+PRI+PVEM+MORENA no coincide con VOTOS (hay votos en “OTROS”).'
      : '';

    // ...después de pintar la tabla interna y calcular row:
    await wireQAExternal(sec, puesto, year, row);

  }



    (function wireHistQA(){
      const tg = document.getElementById('hist-qa-toggle');
      const qa = document.getElementById('hist-qa');
      if (!tg || !qa) return;

      tg.addEventListener('change', ()=>{
        qa.style.display = tg.checked ? 'block' : 'none';
        if (tg.checked) renderHistQA();
      });

      // Cuando cambian puesto/año del historial, refrescamos QA si está visible
      const selP = document.getElementById('hist-puesto');
      const selY = document.getElementById('hist-year');
      selP?.addEventListener('change', ()=>{ if (qa.style.display!=='none') renderHistQA(); });
      selY?.addEventListener('change', ()=>{ if (qa.style.display!=='none') renderHistQA(); });
    })();

    // --- Utilidades QA externas ---
    function qaKey(sec, puesto, year){
      const s = String(sec).replace(/\D+/g,'');
      return `QA:${s}|${puesto}|${year}`;
    }
    function readExtInputs(){
      const o = {};
      document.querySelectorAll('#qa-ext-table .qa-num').forEach(inp=>{
        const f = inp.getAttribute('data-f');
        const v = inp.value.trim();
        o[f] = v==='' ? null : Number(v.replace(/[^\d\-]/g,''));
      });
      return o;
    }
    function fillExtInputs(vals){
      document.querySelectorAll('#qa-ext-table .qa-num').forEach(inp=>{
        const f = inp.getAttribute('data-f');
        const v = (vals && typeof vals[f] !== 'undefined') ? vals[f] : '';
        inp.value = (v===null || v==='') ? '' : String(v);
        inp.classList.remove('bad-input');
      });
    }
    function saveQAState(sec, puesto, year, vals, urls){
      const key = qaKey(sec, puesto, year);
      const obj = { values: vals||{}, urls: urls||{} };
      localStorage.setItem(key, JSON.stringify(obj));
    }
    function loadQAState(sec, puesto, year){
      const key = qaKey(sec, puesto, year);
      try{ return JSON.parse(localStorage.getItem(key)||'null'); }catch(_){ return null; }
    }
    function openIf(url){ if(url && /^https?:\/\//i.test(url)) window.open(url,'_blank'); }

    // Reusa winnerAndMargin(row), fmt, fmtPct ya definidos en el PASO 2.

    // --- Cablear la parte externa dentro del render del QA ---
    async function wireQAExternal(sec, puesto, year, rowInt){
      // Restaurar guardado (si existe)
      const saved = loadQAState(sec, puesto, year) || {};
      fillExtInputs(saved.values||{});
      document.getElementById('qa-url-ine').value  = saved.urls?.ine  || '';
      document.getElementById('qa-url-ieeg').value = saved.urls?.ieeg || '';

      // Abrir URLs
      document.getElementById('qa-open-ine').onclick  = () => openIf(document.getElementById('qa-url-ine').value);
      document.getElementById('qa-open-ieeg').onclick = () => openIf(document.getElementById('qa-url-ieeg').value);

      // Guardar URLs
      document.getElementById('qa-save-urls').onclick = () => {
        const urls = {
          ine:  document.getElementById('qa-url-ine').value.trim(),
          ieeg: document.getElementById('qa-url-ieeg').value.trim()
        };
        const vals = readExtInputs();
        saveQAState(sec, puesto, year, vals, urls);
      };

      // Limpiar
      document.getElementById('qa-clear-ext').onclick = () => {
        fillExtInputs({});
        document.getElementById('qa-compare-result').textContent = '';
        saveQAState(sec, puesto, year, {}, {
          ine:  document.getElementById('qa-url-ine').value.trim(),
          ieeg: document.getElementById('qa-url-ieeg').value.trim()
        });
      };

      // Comparar
      document.getElementById('qa-compare').onclick = () => {
        const vals = readExtInputs();
        const res  = document.getElementById('qa-compare-result');
        // marcar campos vacíos o no numéricos como diferencia
        document.querySelectorAll('#qa-ext-table .qa-num').forEach(inp=>inp.classList.remove('bad-input'));

        const intPAN=+rowInt.PAN||0, intPRI=+rowInt.PRI||0, intPVEM=+rowInt.PVEM||0, intMORENA=+rowInt.MORENA||0;
        const intVOT=+rowInt.VOTOS||0,   intLN=+rowInt.LN||0;

        const diffs = [];
        const fields = ['PAN','PRI','PVEM','MORENA','VOTOS','LN'];

        fields.forEach(f=>{
          const ext = vals[f];
          const intv= (f==='PAN')?intPAN:(f==='PRI')?intPRI:(f==='PVEM')?intPVEM:(f==='MORENA')?intMORENA:(f==='VOTOS')?intVOT:intLN;
          const inp = document.querySelector(`#qa-ext-table .qa-num[data-f="${f}"]`);
          const mismatch = (ext==null || Number.isNaN(ext) || ext!==intv);
          if (mismatch){
            diffs.push(`• ${f}: App=${fmt(intv)} vs Ext=${(ext==null||Number.isNaN(ext))?'—':fmt(ext)}`);
            inp?.classList.add('bad-input');
          }
        });

        // Ganador/Margen externos (si tenemos votos externos)
        const rowExt = {
          PAN: +vals.PAN||0, PRI:+vals.PRI||0, PVEM:+vals.PVEM||0, MORENA:+vals.MORENA||0,
          VOTOS: +vals.VOTOS||0, LN:+vals.LN||0
        };
        const gInt = winnerAndMargin(rowInt);
        const gExt = winnerAndMargin(rowExt);

        if (rowExt.VOTOS>0){
          if (gInt.ganador !== gExt.ganador)
            diffs.push(`• Ganador: App=${gInt.ganador} vs Ext=${gExt.ganador}`);
          // margen % tolerancia 0.1 p.p.
          const tol = 0.1;
          if (Math.abs(gInt.margenPct - gExt.margenPct) > tol)
            diffs.push(`• Margen%: App=${fmtPct(gInt.margenPct)} vs Ext=${fmtPct(gExt.margenPct)}`);
          if (gInt.margen !== gExt.margen)
            diffs.push(`• Margen(v): App=${fmt(gInt.margen)} vs Ext=${fmt(gExt.margen)}`);
        }

        // Mensaje
        if (diffs.length===0){
          res.textContent = '✔ Coinciden App y Externo (INE/IEEG).';
          res.classList.remove('bad-msg'); res.classList.add('ok-msg');
        }else{
          res.textContent = '⚠ Diferencias:\n' + diffs.join('\n');
          res.classList.remove('ok-msg'); res.classList.add('bad-msg');
        }

        // Guardar lo pegado
        const urls = {
          ine:  document.getElementById('qa-url-ine').value.trim(),
          ieeg: document.getElementById('qa-url-ieeg').value.trim()
        };
        saveQAState(sec, puesto, year, vals, urls);
      };
    }


    /* ====================== AQUI EMPIEZA MODULO: COMPARATIVA HISTORICA POR PUESTO (AT27_CHP_) ====================== */
      // Autor: Alex + GPT | Panel movible + redimensionable | Chart.js

      // ---------- Utiles ----------
      const AT27_CHP_PUESTOS = {
        'A': 'Ayuntamiento', 'DL': 'Diputado Local', 'DF': 'Diputado Federal',
        'G': 'Gobernador', 'S': 'Senador', 'P': 'Presidente'
      };
      const AT27_CHP_SEXENALES = new Set(['G','S','P']); // solo 2018 y 2024
      function AT27_CHP_fmt(x){ return Number(x||0).toLocaleString('es-MX'); }
    // Reemplaza toda tu función por esta
    function AT27_CHP_getPropsDeSeccion(seccionId){
      const secKey = String(seccionId ?? '').replace(/\D+/g,'').padStart(4,'0');

      // 1) Props base desde el highlight (o null si no coincide)
      const hl = window.__SEC_HL;
      const lyr = hl && hl.getLayers ? hl.getLayers()[0] : null;
      const base = lyr?.feature?.properties || null;
      const propSec = base?.SECCION ?? base?.Seccion ?? base?.seccion ?? base?.ID ?? base?.id;
      const matchHL = propSec && String(propSec).replace(/\D+/g,'').padStart(4,'0') === secKey;

      // 2) Votos desde el índice cargado de JSON
      const elect = (window.AT27_PUESTOS_IDX || {})[secKey] || {};

      // 3) Fusión (base + votos)
      const out = Object.assign({}, matchHL ? base : {}, elect);

      // 4) Validar que realmente hay llaves de votos 18/21/24
      const hasVotes = Object.keys(out).some(k => /^(18|21|24)(A|DL|DF|G|S|P)_/.test(k));
      return hasVotes ? out : null;
    }


      // Colores por partido (fallback determinístico si no está mapeado)
      const AT27_CHP_COLORS = {
        'PAN':'#1E88E5','PRI':'#D32F2F','PRD':'#FBC02D','PVEM':'#50E991','PT':'#E64A19',
        'MC':'#FF9800','MORENA':'#8D4B0F','PES':'#7E57C2','PANAL':'#26C6DA'
      };
      function AT27_CHP_colorFor(key){
        if (AT27_CHP_COLORS[key]) return AT27_CHP_COLORS[key];
        // fallback: hash to HSL
        let h=0; for(let i=0;i<key.length;i++) h=(h*31+key.charCodeAt(i))>>>0;
        return `hsl(${h%360} 70% 45%)`;
      }

      // ---------- DOM: Panel ----------
      function AT27_CHP_getOrCreatePanel(){
        let panel = document.getElementById('AT27_CHP_panel');
        if (panel) return panel;

        panel = document.createElement('div');
        panel.id = 'AT27_CHP_panel';
        Object.assign(panel.style,{
          position:'fixed', right:'24px', top:'24px', zIndex:9999,
          width:'460px', height:'360px', background:'#fff',
          border:'1px solid #e5e7eb', borderRadius:'14px',
          boxShadow:'0 18px 40px rgba(0,0,0,.18)', overflow:'hidden', resize:'both'
        });

        panel.innerHTML = `
          <div id="AT27_CHP_hdr" style="cursor:move; user-select:none; background:#5b21b6; color:#fff; padding:10px 12px; display:flex; align-items:center; gap:10px;">
            <div style="font-weight:700;">Comparativa Histórica por Puesto</div>
            <select id="AT27_CHP_selPuesto" title="Puesto" style="margin-left:auto; background:#fff; color:#111827; border-radius:8px; padding:4px 8px; border:none; outline:none;">
              ${Object.entries(AT27_CHP_PUESTOS).map(([k,v])=>`<option value="${k}">${v}</option>`).join('')}
            </select>
            <button id="AT27_CHP_btnClose" title="Cerrar" style="background:transparent;color:#fff;border:none;font-size:18px;line-height:1;cursor:pointer;">×</button>
          </div>
          <div id="AT27_CHP_body" style="padding:10px 12px; height: calc(100% - 96px);">
            <canvas id="AT27_CHP_canvas" aria-label="Gráfica histórica por puesto"></canvas>
          </div>
          <div style="padding:10px 12px; border-top:1px solid #f1f5f9; display:flex; gap:8px; align-items:center;">
            <div id="AT27_CHP_info" style="font-size:12px;color:#64748b;">—</div>
            <button id="AT27_CHP_btnPNG" style="margin-left:auto; background:#f3f4f6;border:1px solid #e5e7eb;border-radius:10px;padding:6px 10px;cursor:pointer;">Exportar PNG</button>
          </div>
        `;
        document.body.appendChild(panel);

        // Cerrar
        panel.querySelector('#AT27_CHP_btnClose').onclick = ()=> panel.remove();

        // Movible por header
        AT27_CHP_makeDraggable(panel, panel.querySelector('#AT27_CHP_hdr'));

        // Redibuja al redimensionar
        new ResizeObserver(()=>{
          if (window.AT27_CHP_chart) window.AT27_CHP_chart.resize();
        }).observe(panel);

        // Export PNG
        panel.querySelector('#AT27_CHP_btnPNG').onclick = ()=>{
          if (!window.AT27_CHP_chart) return;
          const url = window.AT27_CHP_chart.toBase64Image();
          const a = document.createElement('a');
          a.href = url; a.download = 'comparativa_historica_puesto.png'; a.click();
        };

        return panel;
      }
      function AT27_CHP_makeDraggable(panel, handle){
        let sx=0, sy=0, ox=0, oy=0, dragging=false;
        handle.addEventListener('mousedown', (e)=>{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panel.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });
        window.addEventListener('mousemove', (e)=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panel.style.left=(ox+dx)+'px'; panel.style.top=(oy+dy)+'px'; panel.style.right='auto'; });
        window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; });
      }

      // ---------- Datos ----------
      function AT27_CHP_detectPartidos(props, puesto){
        const years = ['18','21','24'];
        const parts = new Set();
        years.forEach(y=>{
          const pref = `${y}${puesto}_`;
          for (const k in props) if (k.startsWith(pref)) parts.add(k.slice(pref.length));
        });
        return Array.from(parts);
      }
      function AT27_CHP_buildDatasets(props, puesto){
        const sexenal = AT27_CHP_SEXENALES.has(puesto);
        const labels = sexenal ? ['2018','2024'] : ['2018','2021','2024'];
        const years = sexenal ? ['18','24'] : ['18','21','24'];
        const partidos = AT27_CHP_detectPartidos(props, puesto);
        const datasets = partidos.map(p=>{
          const data = years.map(y=> Number(props[`${y}${puesto}_${p}`] || 0));
          return {
            label: p,
            data,
            borderColor: AT27_CHP_colorFor(p),
            backgroundColor: AT27_CHP_colorFor(p),
            tension: 0.25,
            borderWidth: 2,
            pointRadius: 3,
            spanGaps: true
          };
        });
        return { labels, datasets };
      }

      // ---------- Chart ----------
      async function AT27_CHP_ensureChartJS(){
        if (typeof window.Chart !== 'undefined') return;
        await new Promise((res,rej)=>{
          const s = document.createElement('script');
          s.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js';
          s.onload = res; s.onerror = rej; document.head.appendChild(s);
        });
      }


      // Carga una sola vez los archivos por puesto y arma un índice por sección
 
      // Carga A/DL/DF/G/S/P.json, normaliza las llaves y construye índice por sección
    async function AT27_CHP_loadPuestosIndex(){
      if (window.AT27_PUESTOS_IDX) return window.AT27_PUESTOS_IDX;

      const urls = {
        A:  './data/electoral/A.json',
        DL: './data/electoral/DL.json',
        DF: './data/electoral/DF.json',
        G:  './data/electoral/G.json',
        S:  './data/electoral/S.json',
        P:  './data/electoral/P.json',
      };

      const idx = {}; // { '0152': { 18A_PAN: 123, 21A_PAN: 234, 24A_PAN: 345, ... } }

      for (const [puesto, url] of Object.entries(urls)){
        try{
          const res = await fetch(url);
          if (!res.ok) continue;
          const arr = await res.json();
          if (!Array.isArray(arr)) continue;

          for (const r of arr){
            const raw = r.SECCION ?? r.Id ?? r.ID ?? r.seccion ?? r.id;
            const secKey = String(raw||'').replace(/\D+/g,'').padStart(4,'0');
            if (!secKey) continue;

            const acc = (idx[secKey] ||= {});

            for (const [k, v] of Object.entries(r)){
              // deja pasar metadatos (ID, municipio, etc.)
              if (/^(ID|Seccion|SECCION|seccion|ENTIDAD|MUNICIPIO|DISTRITO_)/.test(k)) {
                if (!(k in acc)) acc[k] = v;
                continue;
              }

              let m, yy, pu = puesto, party;

              // 1) 18A_PAN o 21DL_PRI o 24P_MORENA (ya canónico)
              if ((m = k.match(/^(18|21|24)(A|DL|DF|G|S|P)_(.+)$/i))){
                acc[`${m[1]}${m[2].toUpperCase()}_${m[3].toUpperCase()}`] = v;
                continue;
              }
              // 2) A18_PAN / DL24_PRI (puesto antes del año)
              if ((m = k.match(/^(A|DL|DF|G|S|P)(18|21|24)_(.+)$/i))){
                acc[`${m[2]}${m[1].toUpperCase()}_${m[3].toUpperCase()}`] = v;
                continue;
              }
              // 3) A_2018_PAN / DL_2024_PRI (con guion/underscore)
              if ((m = k.match(/^(A|DL|DF|G|S|P)[\-_]?(2018|2021|2024)[\-_]?(.+)$/i))){
                yy = m[2].slice(-2); party = m[3].toUpperCase();
                acc[`${yy}${m[1].toUpperCase()}_${party}`] = v;
                continue;
              }
              // 4) 2018_A_PAN / 2024_DL_PRI (año antes del puesto)
              if ((m = k.match(/^(2018|2021|2024)[\-_]?(A|DL|DF|G|S|P)[\-_]?(.+)$/i))){
                yy = m[1].slice(-2); party = m[3].toUpperCase();
                acc[`${yy}${m[2].toUpperCase()}_${party}`] = v;
                continue;
              }
              // 5) 2018_PAN (sin puesto) → asumimos el del archivo actual
              if ((m = k.match(/^(?:V|VOTOS)?(2018|2021|2024)[\-_]?(.+)$/i))){
                yy = m[1].slice(-2); party = m[2].toUpperCase();
                acc[`${yy}${pu}_${party}`] = v;
                continue;
              }
              // 6) PAN_2018 o MORENA_24 (partido + año) → asumimos puesto del archivo
              if ((m = k.match(/^([A-ZÁÉÍÓÚÑ]+)[\-_]?(2018|2021|2024)$/i))){
                yy = m[2].slice(-2); party = m[1].toUpperCase();
                acc[`${yy}${pu}_${party}`] = v;
                continue;
              }
              // 7) Otros nombres: ignora o agrega reglas si encontramos más patrones
            }
          }
        }catch(e){ /* ignora errores de red/formato para no romper el flujo */ }
      }

      window.AT27_PUESTOS_IDX = idx;
      return idx;
    }


  function AT27_CHP_slotToProps(slot, puesto){
      const sexenal = ['G','S','P'].includes(puesto);
      const years = sexenal ? ['2018','2024'] : ['2018','2021','2024'];
      const out = {};
      for (const y of years){
        const yy = y.slice(-2);
        const row = slot[y] || {};
        for (const [k,v] of Object.entries(row)){
          if (k==='VOTOS' || k==='LN') continue;      // omite metadatos
          out[`${yy}${puesto}_${k.toUpperCase()}`] = Number(v || 0);
        }
      }
      return out;
    }




      async function AT27_CHP_renderChart({seccionId, puesto}){
        await AT27_CHP_ensureChartJS();
        await AT27_CHP_loadPuestosIndex();
        const panel = AT27_CHP_getOrCreatePanel();
        const ctx = panel.querySelector('#AT27_CHP_canvas').getContext('2d');
        const info = panel.querySelector('#AT27_CHP_info');

        const secKey = String(seccionId).replace(/\D+/g,'');   // sin padStart
        const dataPuesto = await loadPuesto(puesto);           // A / DL / DF / G / S / P
        const slot = dataPuesto?.secciones?.[secKey] || dataPuesto?.secciones?.[String(Number(secKey))];
        if (!slot) { alert('No hay datos para la sección/puesto seleccionado.'); return; }



        const propsPlano = AT27_CHP_slotToProps(slot, puesto);
        const { labels, datasets } = AT27_CHP_buildDatasets(propsPlano, puesto);

        info.innerHTML = `Sección <b>${seccionId}</b> · Puesto <b>${AT27_CHP_PUESTOS[puesto]||puesto}</b>`;

        // Destruye instancia anterior si existe
        if (window.AT27_CHP_chart) { window.AT27_CHP_chart.destroy(); }

        window.AT27_CHP_chart = new Chart(ctx, {
          type: 'line',
          data: { labels, datasets },
          options: {
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'top', labels: { boxWidth: 16, usePointStyle: true } },
              tooltip: {
                callbacks: {
                  label: (ctx)=>{
                    const v = ctx.parsed.y || 0;
                    return `${ctx.dataset.label}: ${AT27_CHP_fmt(v)}`;
                  }
                }
              },
              title: { display: true, text: `Histórico por Puesto: ${puesto}` }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: { callback: (v)=> AT27_CHP_fmt(v) },
                grid: { color: 'rgba(0,0,0,.06)' }
              },
              x: { grid: { color: 'rgba(0,0,0,.04)' } }
            }
          }
        });

        // Hook del select (cambia puesto y redibuja)
        const sel = panel.querySelector('#AT27_CHP_selPuesto');
        sel.onchange = ()=> AT27_CHP_renderChart({seccionId, puesto: sel.value});
        sel.value = puesto;
      }

      // ---------- API publica ----------
      /** Abre el módulo para una sección: seccionId = clave de tu buscador; puestoInicial = 'A'|'DL'|'DF'|'G'|'S'|'P' */
      function AT27_CHP_ejecutar(seccionId, puestoInicial='A'){
        try{
          AT27_CHP_getOrCreatePanel(); // asegura panel
          AT27_CHP_renderChart({seccionId, puesto: puestoInicial});
        }catch(err){
          console.error('AT27_CHP_ejecutar error:', err);
          alert('Ocurrió un problema al abrir la comparativa histórica.');
        }
      }
      /* ====================== AQUI TERMINA MODULO: COMPARATIVA HISTORICA POR PUESTO (AT27_CHP_) ====================== */


      /* =================== AQUI EMPIEZA MODULO: COMPETITIVIDAD 2024 (AT27_COMP_) =================== */
      // Autor: Alex + GPT | Semáforo por puesto (2024) | Lee tus A/DL/DF/DF/G/S/P.json via loadPuesto()

      const AT27_COMP_PUESTOS = { A:'Ayuntamiento', DL:'Diputado Local', DF:'Diputado Federal', G:'Gobernador', S:'Senador', P:'Presidente' };

      // ---------- Utils ----------
      function AT27_COMP_fmt(x){ return Number(x||0).toLocaleString('es-MX'); }
      function AT27_COMP_secKey(seccionId){ return String(seccionId ?? '').replace(/\D+/g,''); } // sin padStart
      function AT27_COMP_color(status){
        if (status==='SEGURA') return '#e6f7ec';
        if (status==='COMPETIDA') return '#fff7e6';
        return '#fff1f2'; // MUY COMPETIDA
      }

      // ---------- Datos ----------
      async function AT27_COMP_getSlot(seccionId, puesto){
        if (typeof loadPuesto !== 'function') throw new Error('loadPuesto no está disponible');
        const js = await loadPuesto(puesto);
        const sec = AT27_COMP_secKey(seccionId);
        return (js?.secciones?.[sec]) || (js?.secciones?.[String(Number(sec))]) || null;
      }

      function AT27_COMP_calcFromSlot(slot){
        const row = slot?.['2024'] || {};
        const entries = Object.entries(row)
          .filter(([k]) => k!=='VOTOS' && k!=='LN')
          .map(([k,v]) => [k.toUpperCase(), Number(v||0)])
          .sort((a,b)=>b[1]-a[1]);

        const top1 = entries[0] || ['—', 0];
        const top2 = entries[1] || ['—', 0];
        const votosTot = Number(row.VOTOS || entries.reduce((a, [,v])=>a+v, 0));
        const margen = Math.max(0, top1[1] - top2[1]);
        const margenPct = votosTot > 0 ? (margen / votosTot) * 100 : 0;

        let status = 'MUY COMPETIDA';
        if (margenPct >= 10) status = 'SEGURA';
        else if (margenPct >= 5) status = 'COMPETIDA';

        return { votosTot, top1, top2, margen, margenPct, status, ranking: entries };
      }

      // ---------- UI Panel ----------
      function AT27_COMP_getOrCreatePanel(){
        let panel = document.getElementById('AT27_COMP_panel');
        if (panel) return panel;

        panel = document.createElement('div');
        panel.id = 'AT27_COMP_panel';
        Object.assign(panel.style,{
          position:'fixed', right:'28px', top:'28px', zIndex:9999, width:'420px', height:'360px',
          background:'#fff', border:'1px solid #e5e7eb', borderRadius:'14px',
          boxShadow:'0 18px 40px rgba(0,0,0,.18)', overflow:'hidden', resize:'both', fontFamily:'system-ui, Segoe UI, Roboto, Arial'
        });
        panel.innerHTML = `
          <div id="AT27_COMP_hdr" style="cursor:move; user-select:none; background:#0ea5e9; color:#fff; padding:10px 12px; display:flex; gap:10px; align-items:center;">
            <div style="font-weight:700;">Competitividad 2024 · Semáforo</div>
            <select id="AT27_COMP_selPuesto" style="margin-left:auto; background:#fff; color:#111827; border-radius:8px; padding:4px 8px; border:none; outline:none;" title="Puesto">
              ${Object.entries(AT27_COMP_PUESTOS).map(([k,v])=>`<option value="${k}">${v}</option>`).join('')}
            </select>
            <button id="AT27_COMP_close" title="Cerrar" style="background:transparent;color:#fff;border:none;font-size:18px;line-height:1;cursor:pointer;">×</button>
          </div>
          <div id="AT27_COMP_body" style="padding:12px 14px; height: calc(100% - 54px); overflow:auto;"></div>
        `;
        document.body.appendChild(panel);

        // Cerrar
        panel.querySelector('#AT27_COMP_close').onclick = ()=> panel.remove();

        // Drag
        (function makeDrag(panel, handle){
          let sx=0, sy=0, ox=0, oy=0, dragging=false;
          handle.addEventListener('mousedown', (e)=>{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panel.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });
          window.addEventListener('mousemove', (e)=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panel.style.left=(ox+dx)+'px'; panel.style.top=(oy+dy)+'px'; panel.style.right='auto'; });
          window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; });
        })(panel, panel.querySelector('#AT27_COMP_hdr'));

        // Resize → no canvas aquí, pero dejamos el observer por consistencia futura
        new ResizeObserver(()=>{}).observe(panel);

        return panel;
      }

      function AT27_COMP_renderPanel({seccionId, puesto, resultado}){
        const panel = AT27_COMP_getOrCreatePanel();
        const body = panel.querySelector('#AT27_COMP_body');
        const sel = panel.querySelector('#AT27_COMP_selPuesto');
        sel.value = puesto;

        const { votosTot, top1, top2, margen, margenPct, status, ranking } = resultado;

        const filas = ranking.slice(0,6).map(([p, v]) => `
          <tr>
            <td style="padding:6px 8px;">${p}</td>
            <td style="padding:6px 8px; text-align:right;">${AT27_COMP_fmt(v)}</td>
          </tr>
        `).join('');

        body.innerHTML = `
          <div style="font-size:12px;color:#64748b;margin-bottom:8px;">
            Sección <b>${seccionId}</b> · Puesto <b>${AT27_COMP_PUESTOS[puesto]||puesto}</b> · Año <b>2024</b>
          </div>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
            <div style="border:1px solid #f1f5f9;border-radius:12px;padding:10px;background:${AT27_COMP_color(status)}">
              <div style="font-size:12px;color:#334155;">Semáforo</div>
              <div style="font-weight:800;font-size:18px;margin-top:4px;">${status}</div>
              <div style="font-size:12px;color:#475569;margin-top:2px;">Margen ${AT27_COMP_fmt(margen)} (${margenPct.toFixed(1)} pp)</div>
            </div>
            <div style="border:1px solid #f1f5f9;border-radius:12px;padding:10px;">
              <div style="font-size:12px;color:#334155;">Puntero</div>
              <div style="font-weight:800;font-size:18px;margin-top:4px;">${top1[0]} · ${AT27_COMP_fmt(top1[1])}</div>
              <div style="font-size:12px;color:#64748b;margin-top:2px;">2º: ${top2[0]} · ${AT27_COMP_fmt(top2[1])}</div>
            </div>
          </div>
          <div style="font-size:12px;color:#64748b;margin-bottom:8px;">
            Votos totales 2024: <b>${AT27_COMP_fmt(votosTot)}</b>
          </div>
          <table style="width:100%; border-collapse:collapse; font-size:13px;">
            <thead>
              <tr style="background:#f8fafc;">
                <th style="text-align:left;padding:6px 8px;">Partido</th>
                <th style="text-align:right;padding:6px 8px;">Votos 2024</th>
              </tr>
            </thead>
            <tbody>${filas}</tbody>
          </table>
        `;

        // Cambio de puesto → recalc
        sel.onchange = async ()=>{
          const nuevo = sel.value;
          try{
            const slot = await AT27_COMP_getSlot(seccionId, nuevo);
            if (!slot){ alert('No hay datos para este puesto en la sección.'); return; }
            const res = AT27_COMP_calcFromSlot(slot);
            AT27_COMP_renderPanel({seccionId, puesto:nuevo, resultado:res});
          }catch(err){ console.error(err); alert('Error al recalcular competitividad.'); }
        };
      }

      // ---------- API pública ----------
      async function AT27_COMP_ejecutar(seccionId, puestoInicial='A'){
        try{
          const slot = await AT27_COMP_getSlot(seccionId, puestoInicial);
          if (!slot){ alert('No hay datos para la sección/puesto seleccionado.'); return; }
          const res = AT27_COMP_calcFromSlot(slot);
          AT27_COMP_renderPanel({seccionId, puesto:puestoInicial, resultado:res});
        }catch(err){
          console.error('AT27_COMP_ejecutar error:', err);
          alert('Ocurrió un problema al calcular la competitividad.');
        }
      }
      /* =================== AQUI TERMINA MODULO: COMPETITIVIDAD 2024 (AT27_COMP_) =================== */


      /* ========== AQUI EMPIEZA MODULO: TOP 3 PARTIDOS 2024 (AT27_TOP3_) ========== */
      // Autor: Alex + GPT | Lee tus A/DL/DF/G/S/P.json (loadPuesto) | Panel movible con dropdown

      const AT27_TOP3_PUESTOS = { A:'Ayuntamiento', DL:'Diputado Local', DF:'Diputado Federal', G:'Gobernador', S:'Senador', P:'Presidente' };

      // --------- Utils ---------
      function AT27_TOP3_fmt(x){ return Number(x||0).toLocaleString('es-MX'); }
      function AT27_TOP3_secKey(seccionId){ return String(seccionId ?? '').replace(/\D+/g,''); } // sin padStart
      const AT27_TOP3_COLORS = { PAN:'#1E88E5', PRI:'#D32F2F', PRD:'#FBC02D', PVEM:'#50E991', PT:'#E64A19', MC:'#FF9800', MORENA:'#8D4B0F', PES:'#7E57C2', PANAL:'#26C6DA' };
      function AT27_TOP3_colorFor(key){
        if (AT27_TOP3_COLORS[key]) return AT27_TOP3_COLORS[key];
        let h=0; for(let i=0;i<key.length;i++) h=(h*31+key.charCodeAt(i))>>>0;
        return `hsl(${h%360} 70% 45%)`;
      }

      // --------- Datos ---------
      async function AT27_TOP3_getSlot(seccionId, puesto){
        if (typeof loadPuesto !== 'function') throw new Error('loadPuesto no está disponible');
        const js = await loadPuesto(puesto);
        const sec = AT27_TOP3_secKey(seccionId);
        return (js?.secciones?.[sec]) || (js?.secciones?.[String(Number(sec))]) || null;
      }

      function AT27_TOP3_calcFromSlot(slot){
        const row = slot?.['2024'] || {};
        const entries = Object.entries(row)
          .filter(([k]) => k!=='VOTOS' && k!=='LN')
          .map(([k,v]) => [k.toUpperCase(), Number(v||0)])
          .sort((a,b)=>b[1]-a[1]);

        const total = Number(row.VOTOS || entries.reduce((a, [,v])=>a+v, 0));
        const top1 = entries[0] || ['—',0];
        const top2 = entries[1] || ['—',0];
        const top3 = entries[2] || ['—',0];
        const others = entries.slice(3).reduce((a, [,v])=>a+v, 0);

        const toObj = ([p,v]) => ({ partido:p, votos:v, share: total>0 ? v/total : 0 });
        return {
          total,
          top: [toObj(top1), toObj(top2), toObj(top3)],
          others,
          ranking: entries.map(toObj),
          deltaVsPuntero: {
            [top1[0]]: 0,
            [top2[0]]: Math.max(0, top1[1]-top2[1]),
            [top3[0]]: Math.max(0, top1[1]-top3[1]),
          },
          puntero: top1[0],
          punterosVotos: top1[1]
        };
      }

      // --------- UI Panel ---------
      function AT27_TOP3_getOrCreatePanel(){
        let panel = document.getElementById('AT27_TOP3_panel');
        if (panel) return panel;

        panel = document.createElement('div');
        panel.id = 'AT27_TOP3_panel';
        Object.assign(panel.style,{
          position:'fixed', right:'32px', top:'32px', zIndex:9999,
          width:'420px', height:'380px', background:'#fff',
          border:'1px solid #e5e7eb', borderRadius:'14px',
          boxShadow:'0 18px 40px rgba(0,0,0,.18)', overflow:'hidden', resize:'both',
          fontFamily:'system-ui, Segoe UI, Roboto, Arial'
        });

        panel.innerHTML = `
          <div id="AT27_TOP3_hdr" style="cursor:move; user-select:none; background:#10b981; color:#fff; padding:10px 12px; display:flex; gap:10px; align-items:center;">
            <div style="font-weight:800;">Top 3 Partidos · 2024</div>
            <select id="AT27_TOP3_selPuesto" style="margin-left:auto; background:#fff; color:#111827; border-radius:8px; padding:4px 8px; border:none; outline:none;" title="Puesto">
              ${Object.entries(AT27_TOP3_PUESTOS).map(([k,v])=>`<option value="${k}">${v}</option>`).join('')}
            </select>
            <button id="AT27_TOP3_close" title="Cerrar" style="background:transparent;color:#fff;border:none;font-size:18px;line-height:1;cursor:pointer;">×</button>
          </div>
          <div id="AT27_TOP3_body" style="padding:12px 14px; height: calc(100% - 54px); overflow:auto;"></div>
        `;
        document.body.appendChild(panel);

        // Cerrar
        panel.querySelector('#AT27_TOP3_close').onclick = ()=> panel.remove();

        // Drag
        (function makeDrag(panel, handle){
          let sx=0, sy=0, ox=0, oy=0, dragging=false;
          handle.addEventListener('mousedown', (e)=>{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panel.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });
          window.addEventListener('mousemove', (e)=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panel.style.left=(ox+dx)+'px'; panel.style.top=(oy+dy)+'px'; panel.style.right='auto'; });
          window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; });
        })(panel, panel.querySelector('#AT27_TOP3_hdr'));

        new ResizeObserver(()=>{}).observe(panel);
        return panel;
      }

      function AT27_TOP3_render({seccionId, puesto, resultado}){
        const panel = AT27_TOP3_getOrCreatePanel();
        const body = panel.querySelector('#AT27_TOP3_body');
        const sel  = panel.querySelector('#AT27_TOP3_selPuesto');
        sel.value  = puesto;

        const { total, top, others, deltaVsPuntero, puntero, punterosVotos } = resultado;

        const rows = top.map((t, i) => {
          const ancho = punterosVotos>0 ? Math.round((t.votos/punterosVotos)*100) : 0;
          const delta = deltaVsPuntero[t.partido] ?? 0;
          return `
            <div style="margin-bottom:10px;">
              <div style="display:flex; align-items:center; gap:8px;">
                <div style="font-weight:800; width:18px; text-align:center;">${i+1}</div>
                <div style="font-weight:700;">${t.partido}</div>
                <div style="margin-left:auto; font-variant-numeric: tabular-nums;">${AT27_TOP3_fmt(t.votos)}</div>
                <div style="width:64px; text-align:right; color:#64748b; font-variant-numeric: tabular-nums;">${(t.share*100).toFixed(1)}%</div>
              </div>
              <div style="display:flex; align-items:center; gap:8px; margin-top:6px;">
                <div style="flex:1; height:8px; background:#f1f5f9; border-radius:999px; overflow:hidden;">
                  <div style="width:${ancho}%; height:100%; background:${AT27_TOP3_colorFor(t.partido)};"></div>
                </div>
                <div style="min-width:120px; text-align:right; font-size:12px; color:${delta===0?'#10b981':'#ef4444'};">
                  ${delta===0 ? 'Puntero' : ('−'+AT27_TOP3_fmt(delta)) + ' vs puntero'}
                </div>
              </div>
            </div>
          `;
        }).join('');

        const otrosBloque = others>0 ? `
          <div style="display:flex; justify-content:space-between; color:#64748b; font-size:12px; margin-top:4px;">
            <div>Otros partidos</div>
            <div>${AT27_TOP3_fmt(others)} (${ total>0 ? ((others/total)*100).toFixed(1) : '0.0' }%)</div>
          </div>
        ` : '';

        body.innerHTML = `
          <div style="font-size:12px;color:#64748b;margin-bottom:8px;">
            Sección <b>${seccionId}</b> · Puesto <b>${AT27_TOP3_PUESTOS[puesto]||puesto}</b> · Año <b>2024</b>
          </div>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:8px;">
            <div style="border:1px solid #f1f5f9;border-radius:12px;padding:10px;">
              <div style="font-size:12px;color:#334155;">Puntero</div>
              <div style="font-weight:800;font-size:18px;margin-top:2px;">${puntero} · ${AT27_TOP3_fmt(punterosVotos)}</div>
            </div>
            <div style="border:1px solid #f1f5f9;border-radius:12px;padding:10px;">
              <div style="font-size:12px;color:#334155;">Votos totales 2024</div>
              <div style="font-weight:800;font-size:18px;margin-top:2px;">${AT27_TOP3_fmt(total)}</div>
            </div>
          </div>
          <div>${rows}</div>
          ${otrosBloque}
        `;

        // Cambio de puesto → recalc
        sel.onchange = async ()=>{
          const nuevo = sel.value;
          try{
            const slot = await AT27_TOP3_getSlot(seccionId, nuevo);
            if (!slot){ alert('No hay datos para este puesto en la sección.'); return; }
            const res = AT27_TOP3_calcFromSlot(slot);
            AT27_TOP3_render({seccionId, puesto:nuevo, resultado:res});
          }catch(err){ console.error(err); alert('Error al recalcular Top 3.'); }
        };
      }

      // --------- API pública ---------
      async function AT27_TOP3_ejecutar(seccionId, puestoInicial='A'){
        try{
          const slot = await AT27_TOP3_getSlot(seccionId, puestoInicial);
          if (!slot){ alert('No hay datos para la sección/puesto seleccionado.'); return; }
          const res = AT27_TOP3_calcFromSlot(slot);
          AT27_TOP3_render({seccionId, puesto:puestoInicial, resultado:res});
        }catch(err){
          console.error('AT27_TOP3_ejecutar error:', err);
          alert('Ocurrió un problema al calcular el Top 3.');
        }
      }
      /* ========== AQUI TERMINA MODULO: TOP 3 PARTIDOS 2024 (AT27_TOP3_) ========== */


      /* ================== MOD: HISTORIAL DE GANADOR (AT27_HG_) ================== */
    /* Universo = todas las secciones visibles en el layer actual (AT_CTX.layer)
      Fuente: loadPuesto(puesto)  -> { secciones: {secId: { "2018": {PAN,...}, "2021": {...}, "2024": {...} } } }
    */

    const AT27_HG_PUESTOS = { A:'Ayuntamiento', DL:'Diputado Local', DF:'Diputado Federal', G:'Gobernador', S:'Senador', P:'Presidente' };
    const AT27_HG_COLORS  = { PAN:'#1E88E5', PRI:'#D32F2F', PRD:'#FBC02D', PVEM:'#50E991', PT:'#E64A19', MC:'#FF9800', MORENA:'#8D4B0F', PES:'#7E57C2', PANAL:'#26C6DA' };
    const AT27_HG_colorFor = p => AT27_HG_COLORS[p] || `hsl(${[...p].reduce((h,c)=>((h*31+c.charCodeAt(0))>>>0),0)%360} 70% 45%)`;

    function AT27_HG_fmt(x){ return Number(x||0).toLocaleString('es-MX'); }
    const AT27_HG_sec = s => String(s??'').replace(/\D+/g,'');               // sin padStart

    // ----- Universo actual: ids de secciones visibles -----
    function AT27_HG_getUniverseSecIds(){
      if (Array.isArray(window.AT_UNIVERSE_SECCIONES) && window.AT_UNIVERSE_SECCIONES.length){
        return [...new Set(window.AT_UNIVERSE_SECCIONES.map(AT27_HG_sec).filter(Boolean))];
      }
      const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];
      const ids = [];
      for (const f of feats){
        const p = f.properties || {};
        const id = AT27_HG_sec(p.ID ?? p.Seccion ?? p.SECCION ?? p.seccion ?? p.id);
        if (id) ids.push(id);
      }
      return [...new Set(ids)];
    }

    // ----- Agregación por año -----
    function AT27_HG_aggregateByYear(js, secIds, puesto){
      const sexenal = ['G','S','P'].includes(puesto);
      const years   = sexenal ? ['2018','2024'] : ['2018','2021','2024'];
      const out = {};

      for (const y of years){
        const partySum = {}; let totalSum = 0;
        for (const sec of secIds){
          const row = js?.secciones?.[sec]?.[y]; if (!row) continue;
          // suma por partido (excluye metadatos)
          let sumRow = 0;
          for (const [k,v] of Object.entries(row)){
            if (k==='VOTOS' || k==='LN') continue;
            const val = Number(v||0);
            partySum[k] = (partySum[k]||0) + val;
            sumRow += val;
          }
          totalSum += sumRow;
        }
        const entries = Object.entries(partySum).sort((a,b)=>b[1]-a[1]);
        const top1 = entries[0] || ['—',0];
        const top2 = entries[1] || ['—',0];
        const share = totalSum>0 ? (top1[1]/totalSum) : 0;
        const margen = Math.max(0, top1[1]-top2[1]);
        out[y] = { total: totalSum, ganador: top1[0], votos: top1[1], share, segundo: top2[0], margen };
      }
      return out;
    }

    // ----- UI Panel -----
    function AT27_HG_getOrCreatePanel(){
      let panel = document.getElementById('AT27_HG_panel');
      if (panel) return panel;

      panel = document.createElement('div');
      panel.id = 'AT27_HG_panel';
      Object.assign(panel.style,{
        position:'fixed', right:'32px', top:'32px', zIndex:9999,
        width:'480px', height:'380px', background:'#fff', border:'1px solid #e5e7eb',
        borderRadius:'14px', boxShadow:'0 18px 40px rgba(0,0,0,.18)', overflow:'hidden', resize:'both',
        fontFamily:'system-ui, Segoe UI, Roboto, Arial'
      });
      panel.innerHTML = `
        <div id="AT27_HG_hdr" style="cursor:move; user-select:none; background:#7c3aed; color:#fff; padding:10px 12px; display:flex; gap:10px; align-items:center;">
          <div style="font-weight:800;">Historial de Ganador (2018–2024)</div>
          <select id="AT27_HG_selPuesto" style="margin-left:auto; background:#fff; color:#111827; border-radius:8px; padding:4px 8px; border:none; outline:none;">
            ${Object.entries(AT27_HG_PUESTOS).map(([k,v])=>`<option value="${k}">${v}</option>`).join('')}
          </select>
          <button id="AT27_HG_close" title="Cerrar" style="background:transparent;color:#fff;border:none;font-size:18px;cursor:pointer;">×</button>
        </div>
        <div id="AT27_HG_body" style="padding:12px 14px; height: calc(100% - 54px); overflow:auto;"></div>
      `;
      document.body.appendChild(panel);

      panel.querySelector('#AT27_HG_close').onclick = ()=> panel.remove();

      // drag
      (function drag(panel, handle){
        let sx=0, sy=0, ox=0, oy=0, dragging=false;
        handle.addEventListener('mousedown', (e)=>{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panel.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });
        window.addEventListener('mousemove', (e)=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panel.style.left=(ox+dx)+'px'; panel.style.top=(oy+dy)+'px'; panel.style.right='auto'; });
        window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; });
      })(panel, panel.querySelector('#AT27_HG_hdr'));

      new ResizeObserver(()=>{}).observe(panel);
      return panel;
    }

    function AT27_HG_render({puesto, resumen, universeCount}){
      const panel = AT27_HG_getOrCreatePanel();
      const sel   = panel.querySelector('#AT27_HG_selPuesto');
      const body  = panel.querySelector('#AT27_HG_body');
      sel.value = puesto;

      const years = Object.keys(resumen);
      const tiles = years.map(y=>{
        const r = resumen[y];
        const c = AT27_HG_colorFor(r.ganador);
        return `
          <div style="border:1px solid #f1f5f9; border-radius:12px; padding:12px; display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
            <div>
              <div style="font-size:12px; color:#334155;">Año</div>
              <div style="font-weight:800; font-size:20px;">${y}</div>
              <div style="font-size:12px; color:#64748b; margin-top:4px;">Total votos: <b>${AT27_HG_fmt(r.total)}</b></div>
            </div>
            <div>
              <div style="font-size:12px; color:#334155;">Ganador</div>
              <div style="font-weight:900; font-size:18px; color:${c};">${r.ganador}</div>
              <div style="font-size:12px; color:#64748b; margin-top:4px;">
                ${AT27_HG_fmt(r.votos)} (${(r.share*100).toFixed(1)}%) · margen vs 2º: <b>${AT27_HG_fmt(r.margen)}</b>
              </div>
            </div>
          </div>
        `;
      }).join('<div style="height:8px;"></div>');

      body.innerHTML = `
        <div style="font-size:12px;color:#64748b;margin-bottom:8px;">
          Universo actual: <b>${universeCount}</b> secciones · Puesto <b>${AT27_HG_PUESTOS[puesto]||puesto}</b>
        </div>
        <div style="display:grid; grid-template-columns: 1fr; gap:10px;">${tiles}</div>
      `;

      sel.onchange = async ()=>{
        const nuevo = sel.value;
        try{
          const secIds = AT27_HG_getUniverseSecIds();
          const js = await loadPuesto(nuevo);
          const res = AT27_HG_aggregateByYear(js, secIds, nuevo);
          AT27_HG_render({puesto:nuevo, resumen:res, universeCount:secIds.length});
        }catch(e){ console.error(e); alert('No pude recalcular el historial.'); }
      };
    }

    // ----- API pública -----
    async function AT27_HG_ejecutar(puestoInicial='A'){
      try{
        const secIds = AT27_HG_getUniverseSecIds();
        if (!secIds.length){ alert('No hay secciones en el universo actual.'); return; }

        const js = await loadPuesto(puestoInicial);
        const res = AT27_HG_aggregateByYear(js, secIds, puestoInicial);
        AT27_HG_render({puesto:puestoInicial, resumen:res, universeCount:secIds.length});
      }catch(err){
        console.error('AT27_HG_ejecutar error:', err);
        alert('Ocurrió un problema al calcular el historial de ganador.');
      }
    }
    /* ================== FIN MOD: HISTORIAL DE GANADOR (AT27_HG_) ================== */


    /* ============ MOD: GANADORES POR PARTIDO POR AÑO (AT27_GPA_) ============ */
    /* Universo = todas las secciones del layer actual (AT_CTX.layer)
      Fuente: loadPuesto(puesto) -> { secciones: { secId: { "2018": {PAN,...}, "2021": {...}, "2024": {...} } } }
      Efecto: pinta un overlay por sección con el color del partido ganador y muestra leyenda. */

    const AT27_GPA_PUESTOS = { A:'Ayuntamiento', DL:'Diputado Local', DF:'Diputado Federal', G:'Gobernador', S:'Senador', P:'Presidente' };
    const AT27_GPA_COLORS  = {
      PAN:'#1565C0', PRI:'#C62828', PVEM:'#2E7D32', MORENA:'#6D0019', PRD:'#FBC02D', PT:'#E64A19', MC:'#FF9800',
      PES:'#7E57C2', PANAL:'#26C6DA', IND:'#9E9E9E'
    };
    const AT27_GPA_colorFor = p => AT27_GPA_COLORS[p] || `hsl(${[...String(p||'')].reduce((h,c)=>((h*31+c.charCodeAt(0))>>>0),0)%360} 70% 45%)`;

    const AT27_GPA_sec = s => String(s??'').replace(/\D+/g,'');  // sin padStart
    function AT27_GPA_yearsFor(puesto){ return ['G','S','P'].includes(puesto) ? ['2018','2024'] : ['2018','2021','2024']; }

    // ----- Universo actual: ids de secciones -----
    function AT27_GPA_getUniverseSecIds(){
      if (Array.isArray(window.AT_UNIVERSE_SECCIONES) && window.AT_UNIVERSE_SECCIONES.length){
        return [...new Set(window.AT_UNIVERSE_SECCIONES.map(AT27_GPA_sec).filter(Boolean))];
      }
      const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];
      const ids = [];
      for (const f of feats){
        const p = f.properties || {};
        const id = AT27_GPA_sec(p.ID ?? p.Seccion ?? p.SECCION ?? p.seccion ?? p.id);
        if (id) ids.push(id);
      }
      return [...new Set(ids)];
    }

    // ----- Cálculo de ganadores por sección -----
    function AT27_GPA_computeWinners(js, secIds, year){
      const winners = {};               // secId -> partido
      const counts  = {};               // partido -> #secciones ganadas
      for (const sec of secIds){
        const row = js?.secciones?.[sec]?.[year];
        if (!row) continue;
        let top = ['—', 0];
        for (const [k,v] of Object.entries(row)){
          if (k==='VOTOS' || k==='LN') continue;
          const vv = Number(v||0);
          if (vv > top[1]) top = [k.toUpperCase(), vv];
        }
        if (top[0] !== '—'){
          winners[sec] = top[0];
          counts[top[0]] = (counts[top[0]]||0) + 1;
        }
      }
      return { winners, counts };
    }

    // ----- Overlay Leaflet -----
    function AT27_GPA_clearOverlay(){
      const map = window.AT_CTX?.map || window.map;
      if (!map) return;
      if (window.AT27_GPA_LAYER){
        try { map.removeLayer(window.AT27_GPA_LAYER); } catch(e){}
        window.AT27_GPA_LAYER = null;
      }
      if (map.getPane && map.getPane('at27_gpa_pane')){
        // dejamos el pane; no hace falta removerlo
      }
    }

    function AT27_GPA_buildOverlay(winners){
      const map = window.AT_CTX?.map || window.map;
      const base = window.AT_CTX?.layer?.toGeoJSON?.() || window.AT_DATA;
      if (!map || !base?.features) return;

      // Pane dedicado arriba del layer base
      if (map.createPane && !map.getPane('at27_gpa_pane')){
        map.createPane('at27_gpa_pane');
        map.getPane('at27_gpa_pane').style.zIndex = 650; // arriba de polígonos
        map.getPane('at27_gpa_pane').style.pointerEvents = 'none';
      }

      // Filtra features del universo que tengan ganador
      const features = base.features.filter(f => {
        const p = f.properties || {};
        const sec = AT27_GPA_sec(p.ID ?? p.Seccion ?? p.SECCION ?? p.seccion ?? p.id);
        return !!winners[sec];
      });

      const geo = { type:'FeatureCollection', features };

      // Crea overlay coloreado
      const layer = window.L && L.geoJSON ? L.geoJSON(geo, {
        pane: 'at27_gpa_pane',
        style: f => {
          const p = f.properties || {};
          const sec = AT27_GPA_sec(p.ID ?? p.Seccion ?? p.SECCION ?? p.seccion ?? p.id);
          const partido = winners[sec];
          const fill = AT27_GPA_colorFor(partido);
          return {
            color: fill,           // borde del mismo color, tenue
            weight: 1,
            opacity: 0.9,
            fillColor: fill,
            fillOpacity: 0.45
          };
        },
        interactive: false
      }) : null;

      if (layer){
        AT27_GPA_clearOverlay();
        layer.addTo(map);
        window.AT27_GPA_LAYER = layer;
      }
    }

    // ----- Leyenda (en el panel) -----
    function AT27_GPA_renderLegend(counts, universeSize){
      const items = Object.entries(counts)
        .sort((a,b)=>b[1]-a[1])
        .map(([p,c])=>{
          const col = AT27_GPA_colorFor(p);
          const pct = universeSize>0 ? ((c/universeSize)*100).toFixed(1) : '0.0';
          return `
            <div style="display:flex; align-items:center; gap:8px;">
              <span style="display:inline-block; width:12px; height:12px; border-radius:3px; background:${col}; border:1px solid rgba(0,0,0,.15)"></span>
              <div style="flex:1;">${p}</div>
              <div style="font-variant-numeric: tabular-nums;">${c} (${pct}%)</div>
            </div>
          `;
        }).join('');
      return items || `<div style="color:#64748b;">Sin datos para el universo/año/puesto seleccionados.</div>`;
    }

    // ----- Panel UI -----
    function AT27_GPA_getOrCreatePanel(){
      let panel = document.getElementById('AT27_GPA_panel');
      if (panel) return panel;

      panel = document.createElement('div');
      panel.id = 'AT27_GPA_panel';
      Object.assign(panel.style,{
        position:'fixed', right:'32px', top:'32px', zIndex:9999,
        width:'490px', height:'420px', background:'#fff', border:'1px solid #e5e7eb',
        borderRadius:'14px', boxShadow:'0 18px 40px rgba(0,0,0,.18)', overflow:'hidden', resize:'both',
        fontFamily:'system-ui, Segoe UI, Roboto, Arial'
      });
      panel.innerHTML = `
        <div id="AT27_GPA_hdr" style="cursor:move; user-select:none; background:#0ea5e9; color:#fff; padding:10px 12px; display:flex; gap:10px; align-items:center;">
          <div style="font-weight:800;">Ganadores por Partido por Año</div>
          <select id="AT27_GPA_selAnio"   style="margin-left:auto; background:#fff; color:#111827; border-radius:8px; padding:4px 8px; border:none; outline:none;"></select>
          <select id="AT27_GPA_selPuesto" style="background:#fff; color:#111827; border-radius:8px; padding:4px 8px; border:none; outline:none;">
            ${Object.entries(AT27_GPA_PUESTOS).map(([k,v])=>`<option value="${k}">${v}</option>`).join('')}
          </select>
          <button id="AT27_GPA_close" title="Cerrar" style="background:transparent;color:#fff;border:none;font-size:18px;cursor:pointer;">×</button>
        </div>
        <div id="AT27_GPA_body" style="padding:12px 14px; height: calc(100% - 54px); overflow:auto;">
          <div style="font-size:12px;color:#64748b;margin-bottom:8px;">
            Universo actual: <b id="AT27_GPA_uniCount">—</b> secciones
          </div>
          <div id="AT27_GPA_legend" style="display:grid; grid-template-columns: 1fr; gap:8px;"></div>
        </div>
      `;
      document.body.appendChild(panel);

      // Cerrar
      panel.querySelector('#AT27_GPA_close').onclick = ()=>{ AT27_GPA_clearOverlay(); panel.remove(); };

      // Drag
      (function drag(panel, handle){
        let sx=0, sy=0, ox=0, oy=0, dragging=false;
        handle.addEventListener('mousedown', (e)=>{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panel.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });
        window.addEventListener('mousemove', (e)=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panel.style.left=(ox+dx)+'px'; panel.style.top=(oy+dy)+'px'; panel.style.right='auto'; });
        window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; });
      })(panel, panel.querySelector('#AT27_GPA_hdr'));

      new ResizeObserver(()=>{}).observe(panel);
      return panel;
    }

    // ----- Render / Update -----
    async function AT27_GPA_update(){
      const panel = AT27_GPA_getOrCreatePanel();
      const selYear   = panel.querySelector('#AT27_GPA_selAnio');
      const selPuesto = panel.querySelector('#AT27_GPA_selPuesto');

      const puesto = selPuesto.value;
      const year   = selYear.value;

      const secIds = AT27_GPA_getUniverseSecIds();
      panel.querySelector('#AT27_GPA_uniCount').textContent = String(secIds.length);

      if (!secIds.length){ AT27_GPA_clearOverlay(); panel.querySelector('#AT27_GPA_legend').innerHTML = '<i>Sin secciones</i>'; return; }

      const js = await loadPuesto(puesto);
      const { winners, counts } = AT27_GPA_computeWinners(js, secIds, year);

      // pinta overlay y leyenda
      AT27_GPA_buildOverlay(winners);
      panel.querySelector('#AT27_GPA_legend').innerHTML = AT27_GPA_renderLegend(counts, secIds.length);
    }

    function AT27_GPA_populateYears(puesto){
      const panel = AT27_GPA_getOrCreatePanel();
      const selYear = panel.querySelector('#AT27_GPA_selAnio');
      const years = AT27_GPA_yearsFor(puesto);
      selYear.innerHTML = years.map(y=>`<option value="${y}">${y}</option>`).join('');
      // seleccionar por defecto 2024 si existe
      if (years.includes('2024')) selYear.value = '2024';
    }

    // ----- API pública -----
    async function AT27_GPA_ejecutar(puestoInicial='A', yearInicial='2024'){
      try{
        const panel = AT27_GPA_getOrCreatePanel();
        const selYear   = panel.querySelector('#AT27_GPA_selAnio');
        const selPuesto = panel.querySelector('#AT27_GPA_selPuesto');

        // inicializa selects
        selPuesto.value = puestoInicial;
        AT27_GPA_populateYears(puestoInicial);
        if (yearInicial && [...selYear.options].some(o=>o.value===yearInicial)) selYear.value = yearInicial;

        // listeners
        selPuesto.onchange = ()=>{ AT27_GPA_populateYears(selPuesto.value); AT27_GPA_update(); };
        selYear.onchange   = ()=> AT27_GPA_update();

        // primer render
        await AT27_GPA_update();
      }catch(err){
        console.error('AT27_GPA_ejecutar error:', err);
        alert('No pude calcular los ganadores por partido/año. Verifica que el universo y los JSON estén cargados.');
      }
    }
    /* ===================== FIN MOD: GANADORES POR PARTIDO POR AÑO ===================== */


    /* ================= MOD 2: TENDENCIA DE ABSTENCIÓN 2018→2024 (AT27_ABS_) ================= */
    /* Universo = secciones del layer actual (AT_CTX.layer)
      Fuente: loadPuesto(puesto) -> secciones[sec]["2018"/"2021"/"2024"] con { PAN, ..., VOTOS?, LN? }
      Cálculo: abst% = (LN - VOTOS) / LN * 100, con VOTOS = row.VOTOS || suma(partidos) */

    const AT27_ABS_PUESTOS = { A:'Ayuntamiento', DL:'Diputado Local', DF:'Diputado Federal', G:'Gobernador', S:'Senador', P:'Presidente' };
    const AT27_ABS_sec = s => String(s??'').replace(/\D+/g,'');
    const AT27_ABS_yearsFor = p => (['G','S','P'].includes(p) ? ['2018','2024'] : ['2018','2021','2024']);
    const AT27_ABS_fmtPct = x => (isFinite(x) ? (x).toFixed(1)+'%' : '—');
    const AT27_ABS_fmtInt = x => Number(x||0).toLocaleString('es-MX');

    function AT27_ABS_getUniverseSecIds(){
      if (Array.isArray(window.AT_UNIVERSE_SECCIONES) && window.AT_UNIVERSE_SECCIONES.length){
        return [...new Set(window.AT_UNIVERSE_SECCIONES.map(AT27_ABS_sec).filter(Boolean))];
      }
      const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];
      const ids = [];
      for (const f of feats){
        const p = f.properties || {};
        const id = AT27_ABS_sec(p.ID ?? p.Seccion ?? p.SECCION ?? p.seccion ?? p.id);
        if (id) ids.push(id);
      }
      return [...new Set(ids)];
    }

    function AT27_ABS_aggregate(js, secIds, puesto){
      const years = AT27_ABS_yearsFor(puesto);
      const out = {};
      for (const y of years){
        let lnSum = 0, votosSum = 0;
        for (const sec of secIds){
          const row = js?.secciones?.[sec]?.[y]; if (!row) continue;
          const ln = Number(row.LN || 0);
          if (!ln) continue;
          let votos = 0;
          if (row.VOTOS != null) votos = Number(row.VOTOS||0);
          else {
            for (const [k,v] of Object.entries(row)){ if (k==='LN' || k==='VOTOS') continue; votos += Number(v||0); }
          }
          lnSum    += ln;
          votosSum += Math.min(votos, ln); // por seguridad
        }
        const abst = lnSum>0 ? ((lnSum - votosSum) * 100 / lnSum) : NaN;
        const part = lnSum>0 ? (votosSum * 100 / lnSum) : NaN;
        out[y] = { ln: lnSum, votos: votosSum, abst, part };
      }
      return out;
    }

    // ---- Panel UI
    function AT27_ABS_getOrCreatePanel(){
      let panel = document.getElementById('AT27_ABS_panel');
      if (panel) return panel;
      panel = document.createElement('div');
      panel.id = 'AT27_ABS_panel';
      Object.assign(panel.style,{
        position:'fixed', right:'32px', top:'32px', zIndex:9999, width:'520px', height:'420px',
        background:'#fff', border:'1px solid #e5e7eb', borderRadius:'14px', boxShadow:'0 18px 40px rgba(0,0,0,.18)',
        overflow:'hidden', resize:'both', fontFamily:'system-ui, Segoe UI, Roboto, Arial'
      });
      panel.innerHTML = `
        <div id="AT27_ABS_hdr" style="cursor:move; user-select:none; background:#14b8a6; color:#fff; padding:10px 12px; display:flex; gap:10px; align-items:center;">
          <div style="font-weight:800;">Tendencia de abstención (2018→2024)</div>
          <select id="AT27_ABS_selPuesto" style="margin-left:auto; background:#fff; color:#111827; border-radius:8px; padding:4px 8px; border:none; outline:none;">
            ${Object.entries(AT27_ABS_PUESTOS).map(([k,v])=>`<option value="${k}">${v}</option>`).join('')}
          </select>
          <button id="AT27_ABS_close" title="Cerrar" style="background:transparent;color:#fff;border:none;font-size:18px;cursor:pointer;">×</button>
        </div>
        <div id="AT27_ABS_body" style="padding:12px 14px; height: calc(100% - 54px); overflow:auto;"></div>
      `;
      document.body.appendChild(panel);
      panel.querySelector('#AT27_ABS_close').onclick = ()=> panel.remove();

      // drag
      (function drag(panel, handle){
        let sx=0, sy=0, ox=0, oy=0, dragging=false;
        handle.addEventListener('mousedown', e=>{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panel.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });
        window.addEventListener('mousemove', e=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panel.style.left=(ox+dx)+'px'; panel.style.top=(oy+dy)+'px'; panel.style.right='auto'; });
        window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; });
      })(panel, panel.querySelector('#AT27_ABS_hdr'));

      new ResizeObserver(()=>{}).observe(panel);
      return panel;
    }

    function AT27_ABS_render({puesto, resumen, universeCount}){
      const panel = AT27_ABS_getOrCreatePanel();
      const body  = panel.querySelector('#AT27_ABS_body');
      panel.querySelector('#AT27_ABS_selPuesto').value = puesto;

      const years = Object.keys(resumen);
      const first = years[0], last = years[years.length-1];
      const delta = (isFinite(resumen[last].abst) && isFinite(resumen[first].abst)) ? (resumen[last].abst - resumen[first].abst) : NaN;
      const arrow = !isFinite(delta) ? {txt:'—', col:'#64748b'} : (delta>0 ? {txt:'↑', col:'#ef4444'} : (delta<0 ? {txt:'↓', col:'#16a34a'} : {txt:'→', col:'#64748b'}));

      const tiles = years.map(y=>{
        const r = resumen[y];
        const bar = (isFinite(resumen[first].abst) && isFinite(r.abst) && resumen[first].abst>0) ?
          Math.max(2, Math.min(100, Math.round((r.abst / resumen[first].abst)*100))) : 0;
        return `
          <div style="border:1px solid #f1f5f9;border-radius:12px;padding:10px;">
            <div style="font-size:12px;color:#334155;">Año</div>
            <div style="font-weight:800;font-size:18px;">${y}</div>
            <div style="font-size:12px;color:#64748b;margin-top:4px;">LN: <b>${AT27_ABS_fmtInt(r.ln)}</b> · Votos: <b>${AT27_ABS_fmtInt(r.votos)}</b></div>
            <div style="margin-top:8px;">
              <div style="font-size:12px;color:#334155;">Abstención</div>
              <div style="display:flex;align-items:baseline;gap:8px;">
                <div style="font-weight:900;font-size:20px;">${AT27_ABS_fmtPct(r.abst)}</div>
                <div style="color:#64748b;font-size:12px;">(Participación: ${AT27_ABS_fmtPct(r.part)})</div>
              </div>
              <div style="height:8px;background:#f1f5f9;border-radius:999px;overflow:hidden;margin-top:6px;">
                <div style="width:${bar}%;height:100%;background:#14b8a6;"></div>
              </div>
            </div>
          </div>
        `;
      }).join('<div style="height:8px;"></div>');

      body.innerHTML = `
        <div style="font-size:12px;color:#64748b;margin-bottom:8px;">
          Universo: <b>${universeCount}</b> secciones · Puesto <b>${AT27_ABS_PUESTOS[puesto]||puesto}</b>
        </div>
        <div style="border:1px solid #e2e8f0;border-radius:12px;padding:10px;margin-bottom:10px;background:#f8fafc;">
          Cambio  ${years[0]} → ${years[years.length-1]}:
          <b style="color:${arrow.col};">${arrow.txt} ${isFinite(delta)?AT27_ABS_fmtPct(Math.abs(delta)):'—'}</b>
        </div>
        <div style="display:grid; grid-template-columns: 1fr; gap:10px;">${tiles}</div>
      `;
    }

    // ---- API pública
    async function AT27_ABS_ejecutar(puestoInicial='A'){
      try{
        const panel = AT27_ABS_getOrCreatePanel();
        const sel = panel.querySelector('#AT27_ABS_selPuesto');
        sel.value = puestoInicial;

        sel.onchange = async ()=>{
          const nuevo = sel.value;
          const ids = AT27_ABS_getUniverseSecIds();
          const js  = await loadPuesto(nuevo);
          const res = AT27_ABS_aggregate(js, ids, nuevo);
          AT27_ABS_render({puesto:nuevo, resumen:res, universeCount:ids.length});
        };

        const ids = AT27_ABS_getUniverseSecIds();
        if (!ids.length) return alert('No hay secciones en el universo actual.');
        const js  = await loadPuesto(puestoInicial);
        const res = AT27_ABS_aggregate(js, ids, puestoInicial);
        AT27_ABS_render({puesto:puestoInicial, resumen:res, universeCount:ids.length});
      }catch(e){
        console.error('AT27_ABS_ejecutar error:', e);
        alert('No pude calcular la abstención.');
      }
    }
    /* ======================= FIN MOD 2: TENDENCIA DE ABSTENCIÓN ======================= */


    /* ======================= MOD 3: ÍNDICE DE CONCENTRACIÓN HHI 2024 (AT27_HHI_) ======================= */
    /* Universo = secciones del layer actual. Año fijo: 2024.
      HHI = sum_i ( (votos_i / votos_totales)^2 )
      También muestra ENP = 1/HHI (número efectivo de partidos) y shares por partido. */

    const AT27_HHI_PUESTOS = { A:'Ayuntamiento', DL:'Diputado Local', DF:'Diputado Federal', G:'Gobernador', S:'Senador', P:'Presidente' };
    const AT27_HHI_COLORS  = { PAN:'#1565C0', PRI:'#C62828', PVEM:'#2E7D32', MORENA:'#6D0019', PRD:'#FBC02D', PT:'#E64A19', MC:'#FF9800', PES:'#7E57C2', PANAL:'#26C6DA', IND:'#9E9E9E' };
    const AT27_HHI_colorFor = p => AT27_HHI_COLORS[p] || `hsl(${[...String(p||'')].reduce((h,c)=>((h*31+c.charCodeAt(0))>>>0),0)%360} 70% 45%)`;
    const AT27_HHI_sec = s => String(s??'').replace(/\D+/g,'');

    function AT27_HHI_getUniverseSecIds(){
      if (Array.isArray(window.AT_UNIVERSE_SECCIONES) && window.AT_UNIVERSE_SECCIONES.length){
        return [...new Set(window.AT_UNIVERSE_SECCIONES.map(AT27_HHI_sec).filter(Boolean))];
      }
      const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];
      const ids = [];
      for (const f of feats){
        const p = f.properties || {};
        const id = AT27_HHI_sec(p.ID ?? p.Seccion ?? p.SECCION ?? p.seccion ?? p.id);
        if (id) ids.push(id);
      }
      return [...new Set(ids)];
    }

    function AT27_HHI_aggregate2024(js, secIds){
      const partyTotals = {};
      let totalVotes = 0;
      for (const sec of secIds){
        const row = js?.secciones?.[sec]?.['2024']; if (!row) continue;
        let sumRow = 0;
        for (const [k,v] of Object.entries(row)){
          if (k==='VOTOS' || k==='LN') { sumRow += Number(k==='VOTOS' ? v||0 : 0); continue; }
          const val = Number(v||0);
          partyTotals[k.toUpperCase()] = (partyTotals[k.toUpperCase()]||0) + val;
          sumRow += val;
        }
        totalVotes += (row.VOTOS != null ? Number(row.VOTOS||0) : sumRow);
      }
      if (totalVotes===0){
        return { partyTotals:{}, totalVotes:0, hhi:NaN, enp:NaN, shares:{} };
      }
      const shares = {};
      let hhi = 0;
      for (const [p, v] of Object.entries(partyTotals)){
        const s = v / totalVotes;
        shares[p] = s;
        hhi += s*s;
      }
      const enp = hhi>0 ? (1/hhi) : NaN;
      return { partyTotals, totalVotes, hhi, enp, shares };
    }

    function AT27_HHI_bucket(hhi){
      if (!isFinite(hhi)) return {label:'Sin dato', color:'#64748b'};
      // Umbrales típicos (orientativos)
      if (hhi >= 0.45) return {label:'Concentración alta', color:'#ef4444'};
      if (hhi >= 0.30) return {label:'Concentración media', color:'#f59e0b'};
      return {label:'Concentración baja', color:'#16a34a'};
    }

    // ---- Panel UI
    function AT27_HHI_getOrCreatePanel(){
      let panel = document.getElementById('AT27_HHI_panel');
      if (panel) return panel;
      panel = document.createElement('div');
      panel.id = 'AT27_HHI_panel';
      Object.assign(panel.style,{
        position:'fixed', right:'32px', top:'32px', zIndex:9999, width:'520px', height:'440px',
        background:'#fff', border:'1px solid #e5e7eb', borderRadius:'14px', boxShadow:'0 18px 40px rgba(0,0,0,.18)',
        overflow:'hidden', resize:'both', fontFamily:'system-ui, Segoe UI, Roboto, Arial'
      });
      panel.innerHTML = `
        <div id="AT27_HHI_hdr" style="cursor:move; user-select:none; background:#8b5cf6; color:#fff; padding:10px 12px; display:flex; gap:10px; align-items:center;">
          <div style="font-weight:800;">Índice de concentración (HHI) · 2024</div>
          <select id="AT27_HHI_selPuesto" style="margin-left:auto; background:#fff; color:#111827; border-radius:8px; padding:4px 8px; border:none; outline:none;">
            ${Object.entries(AT27_HHI_PUESTOS).map(([k,v])=>`<option value="${k}">${v}</option>`).join('')}
          </select>
          <button id="AT27_HHI_close" title="Cerrar" style="background:transparent;color:#fff;border:none;font-size:18px;cursor:pointer;">×</button>
        </div>
        <div id="AT27_HHI_body" style="padding:12px 14px; height: calc(100% - 54px); overflow:auto;"></div>
      `;
      document.body.appendChild(panel);
      panel.querySelector('#AT27_HHI_close').onclick = ()=> panel.remove();

      // drag
      (function drag(panel, handle){
        let sx=0, sy=0, ox=0, oy=0, dragging=false;
        handle.addEventListener('mousedown', e=>{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panel.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });
        window.addEventListener('mousemove', e=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panel.style.left=(ox+dx)+'px'; panel.style.top=(oy+dy)+'px'; panel.style.right='auto'; });
        window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; });
      })(panel, panel.querySelector('#AT27_HHI_hdr'));

      new ResizeObserver(()=>{}).observe(panel);
      return panel;
    }

    function AT27_HHI_render({puesto, resumen, universeCount}){
      const panel = AT27_HHI_getOrCreatePanel();
      const body  = panel.querySelector('#AT27_HHI_body');
      panel.querySelector('#AT27_HHI_selPuesto').value = puesto;

      const { totalVotes, hhi, enp, shares, partyTotals } = resumen;
      const bucket = AT27_HHI_bucket(hhi);

      const rows = Object.entries(shares)
        .sort((a,b)=>b[1]-a[1])
        .map(([p,s])=>{
          const w = Math.round(s*100);
          return `
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
              <span style="width:12px;height:12px;border-radius:3px;background:${AT27_HHI_colorFor(p)};border:1px solid rgba(0,0,0,.15)"></span>
              <div style="flex:1;">${p}</div>
              <div style="min-width:90px; text-align:right; font-variant-numeric: tabular-nums;">${(s*100).toFixed(1)}%</div>
            </div>
            <div style="height:8px;background:#f1f5f9;border-radius:999px;overflow:hidden;margin:-4px 0 6px 20px;">
              <div style="width:${w}%;height:100%;background:${AT27_HHI_colorFor(p)};"></div>
            </div>
          `;
        }).join('');

      body.innerHTML = `
        <div style="font-size:12px;color:#64748b;margin-bottom:8px;">
          Universo: <b>${universeCount}</b> secciones · Puesto <b>${AT27_HHI_PUESTOS[puesto]||puesto}</b>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
          <div style="border:1px solid #f1f5f9;border-radius:12px;padding:10px;">
            <div style="font-size:12px;color:#334155;">HHI (0–1)</div>
            <div style="font-weight:900;font-size:20px;">${isFinite(hhi)?hhi.toFixed(3):'—'}</div>
            <div style="font-size:12px;color:${bucket.color};margin-top:4px;">${bucket.label}</div>
          </div>
          <div style="border:1px solid #f1f5f9;border-radius:12px;padding:10px;">
            <div style="font-size:12px;color:#334155;">Votos totales 2024</div>
            <div style="font-weight:900;font-size:20px;">${AT27_ABS_fmtInt(totalVotes)}</div>
            <div style="font-size:12px;color:#64748b;margin-top:4px;">ENP (1/HHI): <b>${isFinite(enp)?enp.toFixed(2):'—'}</b></div>
          </div>
        </div>
        <div>${rows || '<i style="color:#64748b;">Sin votos en el universo actual.</i>'}</div>
      `;
    }

    // ---- API pública
    async function AT27_HHI_ejecutar(puestoInicial='A'){
      try{
        const panel = AT27_HHI_getOrCreatePanel();
        const sel = panel.querySelector('#AT27_HHI_selPuesto');
        sel.value = puestoInicial;

        sel.onchange = async ()=>{
          const nuevo = sel.value;
          const ids = AT27_HHI_getUniverseSecIds();
          if (!ids.length) return alert('No hay secciones en el universo actual.');
          const js  = await loadPuesto(nuevo);
          const res = AT27_HHI_aggregate2024(js, ids);
          AT27_HHI_render({puesto:nuevo, resumen:res, universeCount:ids.length});
        };

        const ids = AT27_HHI_getUniverseSecIds();
        if (!ids.length) return alert('No hay secciones en el universo actual.');
        const js  = await loadPuesto(puestoInicial);
        const res = AT27_HHI_aggregate2024(js, ids);
        AT27_HHI_render({puesto:puestoInicial, resumen:res, universeCount:ids.length});
      }catch(e){
        console.error('AT27_HHI_ejecutar error:', e);
        alert('No pude calcular el HHI 2024.');
      }
    }
    /* ===================== FIN MOD 3: ÍNDICE DE CONCENTRACIÓN (HHI) ===================== */







  </script>
  <div id="sec-info">
    <div class="hdr">
    <span class="ttl">Sección</span>
    <button id="sec-close" class="btn-close" aria-label="Cerrar">×</button>
  </div>
  <div class="body">
    <div class="row"><span class="k">Sección</span>        <span class="v" id="si-sec">—</span></div>
    <div class="row"><span class="k">Distrito Federal</span><span class="v" id="si-df">—</span></div>
    <div class="row"><span class="k">Distrito Local</span>  <span class="v" id="si-dl">—</span></div>
    <div class="row"><span class="k">LN (2024)</span>    <span class="v" id="si-ln">—</span></div>
  </div>
</div>


    

  <!-- Barra superior -->
<div id="top-toolbar" class="ttb" style="position:absolute; top:12px; right:12px; z-index:5200;">
  <div class="ttb-wrap">

    <!-- Toggle Compact -->
    <button id="btn-ttb-compact-toggle" class="ttb-btn" title="Compactar barra" type="button">
      <span class="ico">▤</span><span class="txt">▤</span>
    </button>

    <!-- SECCIÓN (requieren sección seleccionada) -->
    <span class="ttb-label" style="margin-right:6px;">Sección</span>
    <button id="btn-historial" class="ttb-btn" title="Historial (H)">Historial</button>
    <button id="btn-comp-puesto"   class="ttb-btn" title="Comparativa por Puesto (C)" type="button" disabled>Comparativa</button>
    <button id="btn-competitividad" class="ttb-btn" title="Competitividad 2024 (K)" type="button" disabled>Competitividad</button>
    <button id="btn-top3"          class="ttb-btn" title="Top 3 Partidos 2024 (T)" type="button" disabled>Top 3</button>
    

    <div class="ttb-sep"></div>

    <!-- UNIVERSO (estado/mun/DF/DL; siempre habilitados) -->
    <span class="ttb-label" style="margin-right:6px;">Universo</span>
  
    <button id="btn-gpa"           class="ttb-btn" title="Ganadores por Año (Y)"    type="button">Ganadores por Año</button>
    <button id="btn-abst"          class="ttb-btn" title="Abstención (B)"           type="button">Abstención</button>
    <button id="btn-hhi"           class="ttb-btn" title="HHI 2024 (I)"             type="button">Indice de concentracion 2024</button>

    <div class="ttb-sep"></div>

    <button id="btn-recentrar" class="ttb-btn" title="Recentrar universo (R)" type="button">
      Recentrar
    </button>


    <button id="btn-ayuda"         class="ttb-btn ttb-help" title="Ayuda (?)" type="button">Ayuda</button>
  </div>
</div>




<!-- Modal de ayuda con acordeón -->
<div id="help-modal" class="hm" style="display:none">
  <div class="hm-content">
    <div class="hm-hdr">
      <strong>Ayuda de consultas</strong>
      <button id="help-close" class="btn-close" aria-label="Cerrar">×</button>
    </div>
    <div id="help-accordion" class="hm-body"></div>
  </div>
</div>

  <script>
  // Evita que la barra capture scroll/clicks del mapa
      (function wireTopBar(){
        const bar = document.getElementById('top-toolbar');
        if (!bar || bar.__wired) return;
        if (window.L && L.DomEvent){
          L.DomEvent.disableClickPropagation(bar);
          L.DomEvent.disableScrollPropagation(bar);
        }
      
        document.getElementById('btn-abrir-comp')?.addEventListener('click', ()=> {
          const kind = document.getElementById('comp-metric')?.value || 'ganador';
          if (typeof openComparativaUI === 'function') openComparativaUI(kind);
        });

        document.getElementById('btn-ayuda')?.addEventListener('click', ()=>{
          document.getElementById('mini-ayuda-AT')?.scrollIntoView({behavior:'smooth', block:'start'});
        });


        document.getElementById('btn-comp-puesto')?.addEventListener('click', () => {
          const sec = (typeof getActiveSectionSec==='function' && getActiveSectionSec()) || window.AT_SELECTED_SECTION;
          if (!sec) return alert('Selecciona una sección en el mapa');
          AT27_CHP_ejecutar(String(sec).replace(/\D+/g,'').padStart(4,'0'), 'A');
        });

        document.getElementById('btn-competitividad')?.addEventListener('click', async () => {
          // toma la sección activa (mismo patrón que usamos antes)
          const sec =
            (typeof getActiveSectionSec==='function' && getActiveSectionSec()) ||
            window.AT_SELECTED_SECTION ||
            (window.__SEC_HL?.getLayers?.()[0]?.feature?.properties?.ID);

          if (!sec) return alert('Selecciona una sección en el mapa');
          // Abre el panel con puesto inicial 'A' (cámbialo si quieres otro default)
          AT27_COMP_ejecutar(String(sec).replace(/\D+/g,''), 'A');
        });

        document.getElementById('btn-top3')?.addEventListener('click', () => {
        const sec =
          (typeof getActiveSectionSec==='function' && getActiveSectionSec()) ||
          window.AT_SELECTED_SECTION ||
          (window.__SEC_HL?.getLayers?.()[0]?.feature?.properties?.ID);
        if (!sec) return alert('Selecciona una sección en el mapa');
        AT27_TOP3_ejecutar(String(sec).replace(/\D+/g,''), 'A'); // default 'A'
      });

      document.getElementById('btn-uhg')?.addEventListener('click', () => {
        // default 'A' (ayuntamiento). Si quieres recordar el último puesto usado, cámbialo aquí.
        AT27_HG_ejecutar('A');
      });

      document.getElementById('btn-gpa')?.addEventListener('click', () => {
        AT27_GPA_ejecutar('A', '2024');  // default: puesto A, año 2024
      });

        document.getElementById('btn-abst')?.addEventListener('click', () => {
        AT27_ABS_ejecutar('A'); // default: A
      });
      document.getElementById('btn-hhi')?.addEventListener('click', () => {
        AT27_HHI_ejecutar('A'); // default: A
      });

      document.getElementById('btn-recentrar')?.addEventListener('click', () => {
        AT27_fitUniverseBounds();
      });

      // Atajo de teclado: R
      document.addEventListener('keydown', (e)=>{
        if (e.key === 'R' || e.key === 'r'){
          e.preventDefault();
          AT27_fitUniverseBounds();
        }
      });




              bar.__wired = true;
  })();

  </script>

    <script>
      // Centra el mapa al universo actual (overlay o capa base)
      function AT27_fitUniverseBounds(paddingPx = 24){
        const map = window.AT_CTX?.map || window.map;
        if (!map) return;

        // 1) Si hay overlay (ej. capas pintadas), úsalo
        const candidates = [];
        if (window.AT27_GG_LAYER?.getBounds) candidates.push(window.AT27_GG_LAYER.getBounds());
        if (window.AT27_EP_LAYER?.getBounds) candidates.push(window.AT27_EP_LAYER.getBounds()); // (si tienes Estabilidad)
        if (window.AT27_PART_LAYER?.getBounds) candidates.push(window.AT27_PART_LAYER.getBounds()); // (si tienes Participación)

        // 2) La capa de universo visible (AT_CTX.layer)
        const baseLayer = window.AT_CTX?.layer;
        if (baseLayer?.getBounds) candidates.push(baseLayer.getBounds());

        // 3) Fallback: calcula bounds desde GeoJSON de universo
        if (!candidates.length){
          const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];
          if (feats.length){
            const tmp = L.geoJSON({type:'FeatureCollection', features:feats});
            candidates.push(tmp.getBounds());
            // no añadimos tmp al mapa, solo usamos sus bounds
          }
        }

        // Unir bounds y centrar
        let union = null;
        for (const b of candidates){
          if (!b || !b.isValid()) continue;
          union = union ? union.extend(b) : L.latLngBounds(b.getSouthWest(), b.getNorthEast());
        }
        if (union && union.isValid()){
          map.fitBounds(union, { padding:[paddingPx, paddingPx] });
          requestAnimationFrame(()=> AT27_flashOverlay());
        }
      }
</script>

<script>
  function AT27__eachPath(layer, fn){
    if (!layer) return;
    if (layer.eachLayer) layer.eachLayer(l => AT27__eachPath(l, fn));
    else if (layer.setStyle) fn(layer);
  }

  // Resalta brevemente los polígonos del overlay (o la capa base si no hay overlay)
  function AT27_flashOverlay(duration=900){
    const overlays = [
      window.AT27_GG_LAYER,   // Ganar Todo
      window.AT27_EP_LAYER,   // Estabilidad (si la tienes)
      window.AT27_PART_LAYER  // Participación (si la tienes)
    ].filter(Boolean);

    // Si no hay overlay, “flashea” el universo base
    if (!overlays.length && window.AT_CTX?.layer) overlays.push(window.AT_CTX.layer);

    overlays.forEach(g=>{
      AT27__eachPath(g, (lyr)=>{
        const origW  = (lyr.options && lyr.options.weight) || 1;
        const origFO = (lyr.options && typeof lyr.options.fillOpacity==='number') ? lyr.options.fillOpacity : 0.35;
        try{
          lyr.setStyle({ weight: origW + 2, fillOpacity: Math.min(0.95, origFO + 0.25) });
          setTimeout(()=> lyr.setStyle({ weight: origW, fillOpacity: origFO }), duration);
        }catch(_){}
      });
    });
  }
</script>


  <script>
  // ========== ANÁLISIS TERRITORIAL · AYUDA (AT27_AT_HELP_) ==========
  function AT27_AT_HELP_open(){
    let panel = document.getElementById('AT27_AT_help');
    if (panel){ panel.style.display='block'; if (typeof clampToViewport==='function') clampToViewport(panel); return; }

    panel = document.createElement('div');
    panel.id = 'AT27_AT_help';
    Object.assign(panel.style,{
      position:'fixed', right:'24px', top:'24px', zIndex:9999,
      width: Math.min(560, window.innerWidth - 64) + 'px',
      maxWidth:'calc(100vw - 48px)', maxHeight:'calc(100vh - 48px)',
      background:'#fff', border:'1px solid #e5e7eb', borderRadius:'14px',
      boxShadow:'0 18px 40px rgba(0,0,0,.18)', overflow:'hidden',
      display:'flex', flexDirection:'column', resize:'both',
      minWidth:'380px', minHeight:'280px', fontFamily:'system-ui,Segoe UI,Roboto,Arial'
    });

    panel.innerHTML = `
      <div id="AT27_AT_help_hdr" style="cursor:move; user-select:none; background:#f0fdf4; color:#111; padding:10px 12px; display:flex; gap:10px; align-items:center;">
        <div style="font-weight:800;">ℹ️ Minimanual — Análisis Territorial</div>
        <button id="AT27_AT_help_close" title="Cerrar" style="margin-left:auto;background:transparent;color:#111;border:none;font-size:18px;cursor:pointer;">×</button>
      </div>
      <div id="AT27_AT_help_body" style="padding:12px 14px; flex:1; overflow:auto; color:#111;">
        <p style="margin:0 0 14px; color:#475569; font-size:13px;">
          Consultas a nivel <b>sección</b>. Usa el buscador para seleccionar la sección; el panel/tooltip se actualiza con la sección resaltada.
        </p>

        <details open style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;">
          <summary style="cursor:pointer; font-weight:700;">Comparativa histórica por puesto</summary>
          <div style="margin-top:8px; font-size:13px; color:#334155;">
            <b>Qué muestra:</b> línea de votos por elección <b>2018–2021–2024</b> para el <i>puesto seleccionado</i>
            (en elecciones sexenales muestra <b>2018 y 2024</b>).<br>
            <b>Cómputo:</b> agrupa totales por año/partido desde los JSON del puesto; el dropdown cambia el puesto.<br>
            <b>Cómo leerlo:</b> identifica tendencias (crecimiento/caída) y “saltos” por elección.<br>
            <b>Notas:</b> si falta un año, la serie se interpone con hueco.
          </div>
        </details>

        <details style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;">
          <summary style="cursor:pointer; font-weight:700;">Competitividad por sección</summary>
          <div style="margin-top:8px; font-size:13px; color:#334155;">
            <b>Qué muestra:</b> mapa por <b>margen</b> del ganador (cerrada, media, holgada) y top de secciones más reñidas.<br>
            <b>Cómputo:</b> margen = (votos del ganador − votos del 2.º) en pp o votos según modo.<br>
            <b>Cómo leerlo:</b> prioriza “Near” para campo; el top ordena por menor brecha.<br>
            <b>Notas:</b> considera votos válidos del año elegido.
          </div>
        </details>

        <details style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;">
          <summary style="cursor:pointer; font-weight:700;">Top 3 partidos (2024)</summary>
          <div style="margin-top:8px; font-size:13px; color:#334155;">
            <b>Qué muestra:</b> los tres partidos con más votos en 2024 por sección (colores estándar: PAN=azul, PRI=rojo, PVEM=verde, MORENA=guinda; otros=gris).<br>
            <b>Cómputo:</b> ordena votos 2024 y pinta por ganador; tooltip con Top 3.<br>
            <b>Cómo leerlo:</b> detecta pluralidad/fragmentación y segundos lugares consistentes.
          </div>
        </details>

        <details style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;">
          <summary style="cursor:pointer; font-weight:700;">Estabilidad política 2018–2024</summary>
          <div style="margin-top:8px; font-size:13px; color:#334155;">
            <b>Qué muestra:</b> continuidad/cambios de ganador 2018→2021→2024:
            <span style="color:#16a34a;">Verde</span>=alta (mismo partido 3 elecciones),
            <span style="color:#f59e0b;">Amarillo</span>=media (≥1 cambio),
            <span style="color:#ef4444;">Rojo</span>=baja (3 distintos).<br>
            <b>Uso:</b> (verde) bastión; (amarillo) competencia; (rojo) volatilidad.
          </div>
        </details>

        <p style="margin:10px 0 0; color:#64748b; font-size:12px;">
          <b>Tips:</b> usa el slider de opacidad del overlay; clic en una fila/lista centra la sección; exporta PNG si el panel lo incluye.
        </p>
      </div>
    `;
    document.body.appendChild(panel);

    // cerrar
    panel.querySelector('#AT27_AT_help_close').onclick = ()=>{ panel.style.display='none'; };

    // drag
    (function drag(panelEl, handleEl){
      let sx=0, sy=0, ox=0, oy=0, dragging=false;
      handleEl.addEventListener('mousedown', e=>{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panelEl.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });
      window.addEventListener('mousemove', e=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panelEl.style.left=(ox+dx)+'px'; panelEl.style.top=(oy+dy)+'px'; panelEl.style.right='auto'; });
      window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; if (typeof clampToViewport==='function') clampToViewport(panelEl); });
    })(panel, panel.querySelector('#AT27_AT_help_hdr'));

    if (typeof clampToViewport==='function') clampToViewport(panel);

    // Evita que “tape” interacciones del mapa
    if (window.L && L.DomEvent){
      L.DomEvent.disableClickPropagation(panel);
      L.DomEvent.disableScrollPropagation(panel);
    }
  }

  // Utilidad para mantener panel dentro del viewport (define si no existe)
  if (typeof clampToViewport !== 'function'){
    function clampToViewport(el){
      const vw = window.innerWidth, vh = window.innerHeight;
      const r = el.getBoundingClientRect();
      let left = r.left, top = r.top;
      if (r.right  > vw - 16) left -= (r.right  - (vw - 16));
      if (r.bottom > vh - 16) top  -= (r.bottom - (vh - 16));
      if (left < 16) left = 16;
      if (top  < 16) top  = 16;
      el.style.left = left + 'px';
      el.style.top  = top  + 'px';
      el.style.right = 'auto';
    }
  }

  // Cableado del botón de ayuda (busca id estándar o alterno)
  (function wireAT_Help(){
    const btn = document.getElementById('btn-ayuda') || document.getElementById('btn-at-ayuda');
    if (!btn || btn.__wiredHelp) return;
    btn.addEventListener('click', AT27_AT_HELP_open);
    btn.__wiredHelp = true;

    // (Opcional) tecla ? para abrir
    document.addEventListener('keydown', (e)=>{
      if (e.key==='?'){ e.preventDefault(); AT27_AT_HELP_open(); }
    });
  })();
</script>



</body>
</html>
