<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ganar Todo</title>
  <link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>
        html, body { margin:0; padding:0; height:100%; width:100%; font-family:'Segoe UI', Arial, sans-serif; background:#f4f4f4; }
        :root{ --sidebar-w:320px; }
        #panel-lateral{
          position:absolute;
          left:0; top:0; bottom:0; width:var(--sidebar-w); height:100%;
          background: linear-gradient(180deg, #8ea3ad 0%, #dfe6e9 100%);
          color:#2c3e50; border-right:1px solid #b2bec3;
          display:flex; flex-direction:column; 
          box-shadow:2px 0 5px rgba(0,0,0,0.1); box-sizing:border-box; align-items:stretch;
          z-index:2000;
        }
        #panel-header{ background:#b2bec3; color:#2c3e50; padding:12px 15px; display:flex; align-items:center; font-size:18px; font-weight:bold; }
        #panel-header img{ height:32px; margin-right:10px; }
        #map{ position:absolute; top:0; left:var(--sidebar-w); width:calc(100% - var(--sidebar-w)); height:100%; }

        #sec-search    { position: relative; }                /* contenedor del buscador */
        #sec-suggest   { z-index: 3000; } 
        #sec-suggest {
          position: absolute;
          left: 12px; right: 12px;
          top: 46px;           /* ajusta seg√∫n tu input */
          max-height: 220px;
          overflow: auto;
        }
          /* la lista queda clickeable */

    /* Etiqueta de la SECCI√ìN seleccionada (rosa tenue) */
    .sec-label{
      background: rgba(255, 235, 238, 0.96);  /* #ffebee */
      border: 1px solid #e91e63;
      color: #880e4f;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 700;
      pointer-events: none;
      white-space: nowrap;
      box-shadow: 0 2px 6px rgba(0,0,0,.15);
    }

    /* Etiquetas de SECCIONES ADYACENTES (azul/gris tenue) */
    .sec-label-adj{
      background: rgba(227, 242, 253, 0.94);  /* #e3f2fd */
      border: 1px solid #64b5f6;
      color: #0d47a1;
      padding: 1px 5px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 600;
      pointer-events: none;
      white-space: nowrap;
      box-shadow: 0 1px 4px rgba(0,0,0,.12);
    }


    /* Panel flotante secci√≥n */
    #sec-info {
      position: absolute;
      right: 16px; bottom: 16px;
      width: 320px; max-width: 38vw; min-width: 260px;
      background: #ffffff;
      border: 1px solid #cfd8dc;
      border-radius: 10px;
      box-shadow: 0 10px 24px rgba(0,0,0,.15);
      resize: both; overflow: auto; z-index: 4000;
      display: none;
      pointer-events: auto;
    }
    #sec-info .hdr {
      cursor: move;
      display:flex; align-items:center; justify-content:space-between;
      background: linear-gradient(180deg,#eceff1,#e3f2fd);
      padding: 8px 12px;
      border-bottom: 1px solid #cfd8dc;
      font-weight: 700; color: #263238;
    }

    #sec-info .hdr .btn-close{
      cursor: pointer;
      border: none; outline: none;
      background: #ffcdd2;         /* rosa tenue */
      color: #880e4f;
      width: 24px; height: 24px; line-height: 24px;
      border-radius: 6px;
      font-size: 16px; font-weight: 800;
    }
    #sec-info .hdr .btn-close:hover{ background:#ef9a9a; }
    #sec-info .body { padding: 10px 12px; color: #37474f; }
    #sec-info .row  { display:flex; justify-content:space-between; margin:6px 0; }
    #sec-info .k    { color:#607d8b; }
    #sec-info .v    { font-weight:600; }

    /* Toolbar b√°sica (igual look & feel) */
    .ttb{backdrop-filter: blur(6px); background: rgba(255,255,255,.92); border-radius:12px; 
        box-shadow: 0 8px 24px rgba(0,0,0,.12); border: 1px solid #e5e7eb;}
    .ttb-wrap{display:flex; align-items:center; gap:6px; padding:6px;}
    .ttb-btn{background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:6px 10px; cursor:pointer;}
    .ttb-btn:hover{background:#f8fafc}
    .ttb-btn[disabled]{opacity:.45; cursor:not-allowed;}
    .ttb-sep{width:1px; height:24px; background:#e5e7eb; margin:0 4px;}
    .ttb-help{background:#eef2ff; border-color:#c7d2fe}

    .leaflet-tooltip.at27-tt{
      background: rgba(255,255,255,.95);
      color:#111; border:1px solid #e5e7eb;
      border-radius:8px; padding:6px 8px;
      box-shadow:0 6px 18px rgba(0,0,0,.12);
    }

    .leaflet-tooltip.at27-tt{
      background: rgba(255,255,255,.95);
      color:#111; border:1px solid #e5e7eb;
      border-radius:8px; padding:6px 8px;
      box-shadow:0 6px 18px rgba(0,0,0,.12);
    }


  </style>
</head>
<body>

  
    <!-- Barra superior -->
    <div id="top-toolbar" class="ttb" style="position:absolute; top:12px; right:10px; z-index:5200;">
      <div class="ttb-wrap">
        <button id="btn-gt-part" class="ttb-btn" title="Participaci√≥n 21/24/27*" type="button">
          <span class="ico">üó≥Ô∏è</span><span class="txt">Part. 21/24/27*</span>
        </button>

        <button id="btn-estabilidad" class="ttb-btn" title="Estabilidad 2018‚Äì2024" type="button">
          <span class="ico">üß≠</span><span class="txt">Estabilidad 18‚Äì24</span>
        </button>

        <button id="btn-gt-metas" class="ttb-btn" title="Metas de participaci√≥n 2027*" type="button">
          <span class="ico">üéØ</span><span class="txt">Meta 2027*</span>
        </button>

        <button id="btn-gt-ganar" class="ttb-btn" title="¬øQu√© se requiere para ganar todo?" type="button">
          <span class="ico">üèÜ</span><span class="txt">Ganar todo</span>
        </button>

        <button id="btn-recentrar" class="ttb-btn" title="Recentrar universo (R)" type="button">
          Recentrar
        </button>

        <button id="btn-prob-volteo" class="ttb-btn" title="Probabilidad de voltear 2027">
          Voltear 2027
        </button>

        <button id="btn-plan-mayoria" class="ttb-btn" title="M√≠nimo de votos para mayor√≠a">
          Plan mayor√≠a
        </button>

        <button id="btn-eficiencia-voto" class="ttb-btn" title="Eficiencia del voto (votos ociosos)">
          Eficiencia voto
        </button>

        <button id="btn-corredores-volteo" class="ttb-btn" title="Corredores de volteo (clusters)">
          Corredores
        </button>

        <button id="btn-alertas-riesgo" class="ttb-btn" title="Alertas de riesgo (bastiones en ca√≠da)">
          Alertas
        </button>

        <button id="btn-simulador-impulso" class="ttb-btn" title="Simulador de impulso">
          Impulso
        </button>

        <button id="btn-brecha" class="ttb-btn" title="Mapa de brecha (pp / votos)">
          Brecha pp/votos
        </button>

        <button id="btn-sensibilidad-participacion" class="ttb-btn" title="Sensibilidad a participaci√≥n (¬±pp)">
          Sensibilidad p%
        </button>



        <div class="ttb-sep"></div>

        <button id="btn-ayuda" class="ttb-btn ttb-help" title="Ayuda (?)" type="button">
          <span class="ico">‚ùì</span><span class="txt">Ayuda</span>
        </button>
      </div>
    </div>


  <div id="panel-lateral">
    <div id="panel-header">
      <!-- <img src="assets/img/logo.png" alt="Logo"/> -->
      <span>Ganar Todo</span>
    </div>
    <!-- Aqu√≠ va el contenido del panel lateral -->

    <!-- Buscador de secciones -->
    <div id="sec-search" style="padding:10px 12px; border-top:1px solid #cbd5e1; background:#eef2f7">
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="sec-q" type="text" placeholder="Buscar secci√≥n (ej. 1234 o '1234 Le√≥n')" autocomplete="off" autocorrect="off" spellcheck="false" enterkeyhint="search"
              style="flex:1; padding:6px 8px; border:1px solid #94a3b8; border-radius:6px;">
        <label style="white-space:nowrap; font-size:12px;">
          <input id="sec-global" type="checkbox"> Todo el estado
        </label>
      </div>
      <ul id="sec-suggest" style="margin:8px 0 0 0; padding:0; list-style:none; max-height:180px; overflow:auto;
                                  border:1px solid #cbd5e1; border-radius:6px; background:#fff; display:none;"></ul>
    </div>




    <!-- Panel flotante de info de secci√≥n -->

    <div id="mini-universe" style="padding:12px 12px 6px 12px; background:#eef2f7; border-top:1px solid #cbd5e1">
        <div class="row" style="margin-bottom:8px">
            <label><input type="checkbox" id="mini-all-state"> Estado completo</label>
        </div>
        <div class="row" style="margin-bottom:8px">
            <label>Municipio</label>
            <select id="mini-sel-mun" style="width:100%;padding:6px"><option value="">‚Äî Ninguno ‚Äî</option></select>
        </div>
        <div class="row" style="margin-bottom:8px">
            <label>Distrito Federal</label>
            <select id="mini-sel-df" style="width:100%;padding:6px"><option value="">‚Äî Ninguno ‚Äî</option></select>
        </div>
        <div class="row" style="margin-bottom:8px">
            <label>Distrito Local</label>
            <select id="mini-sel-dl" style="width:100%;padding:6px"><option value="">‚Äî Ninguno ‚Äî</option></select>
        </div>
        <div class="hint" style="font-size:12px;color:#64748b">Elige solo uno. Al cambiar, el mapa se actualiza.</div>
    </div>

  </div>

  <div id="gt-consultas" style="padding:12px; border-top:1px solid #cbd5e1; background:#f8fafc">
    <div style="font-weight:700; margin-bottom:8px;">Ganar Todo ¬∑ Consultas</div>
    <button id="btn-gt-part" style="width:100%; padding:8px; border:1px solid #cbd5e1; border-radius:8px; background:#fff; cursor:pointer;">
      üó≥Ô∏è Participaci√≥n 21/24/27*
    </button>
  </div>


  <div id="map"></div>

  <!-- === SCRIPT √öNICO === -->
  <script>
  // ===== 0) Campos (ajusta si tus nombres son distintos) =====
  // DL = Distrito Local, DF = Distrito Federal
    const FIELD_KEYS = { mun: 'MUNICIPIO', dl: 'DISTRITO_L', df: 'DISTRITO_F' };

    const paths = JSON.parse(localStorage.getItem('AT_PATHS')||'{}');
    const urlGeo = paths.geo || 'data/geo/secciones.geojson';
    const catUrl = paths.catalog || 'data/catalogo_territorial.json';
    const ELP = paths.electoral?.P || 'data/electoral/P.json';
  // ...


  // Adapter: usa tus JSON electorales del propio archivo
  window.loadPuesto = window.loadPuesto || getElectData;


  // ===== 1) Mapa √∫nico y chequeo =====
  function ensureLeafletMap() {
    if (window.__AT_MAP && window.__AT_MAP instanceof L.Map) return window.__AT_MAP;
    const m = L.map('map', { zoomControl:true }).setView([21.0, -101.3], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'¬© OSM' }).addTo(m);
    window.__AT_MAP = m;
    return m;
  }
  function assertIsLeafletMap(m) {
    if (!(m instanceof L.Map) || typeof m.addLayer !== 'function') {
      throw new Error('[AT] addTo(): destino no es un Leaflet Map. Revisa variables llamadas "map" o dobles inicializaciones.');
    }
  }

  function closeSecInfoPanel(){
    const box = document.getElementById('sec-info');
    if (box) box.style.display = 'none';
    // Si quieres limpiar resaltado y etiquetas al cerrar:
    if (typeof clearSectionOverlays === 'function') clearSectionOverlays();
  }


  function ensureSecInfoPanelWired(){
  const box = document.getElementById('sec-info');
  const hdr = box?.querySelector('.hdr');
  if (!box || !hdr || box.__wired) return;

  // Bloquear propagaci√≥n al mapa (no ‚Äúparpadea‚Äù al arrastrar)
  if (window.L && L.DomEvent){
    L.DomEvent.disableClickPropagation(box);
    L.DomEvent.disableScrollPropagation(box);
  }

  // Drag del panel
  let dragging = false, sx=0, sy=0, bx=0, by=0;
  hdr.addEventListener('mousedown', (e)=>{
    if (e.target.closest('.btn-close')) return; // no iniciar drag si clic en "√ó"
    e.preventDefault(); e.stopPropagation();
    dragging = true;
    const r = box.getBoundingClientRect();
    sx = e.clientX; sy = e.clientY; bx = r.left; by = r.top;
    box.style.position = 'absolute'; box.style.right='auto'; box.style.bottom='auto';
    document.body.style.userSelect = 'none';
  });
  window.addEventListener('mousemove', (e)=>{
    if (!dragging) return;
    e.preventDefault(); e.stopPropagation();
    const dx = e.clientX - sx, dy = e.clientY - sy;
    box.style.left = (bx + dx) + 'px';
    box.style.top  = (by + dy) + 'px';
  });
  window.addEventListener('mouseup', ()=>{
    if (!dragging) return;
    dragging = false; document.body.style.userSelect = '';
  });

  // Bot√≥n ‚Äú√ó‚Äù
  const btn = document.getElementById('sec-close');
  if (btn && !btn.__wired){
    btn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); closeSecInfoPanel(); });
    btn.__wired = true;
  }

  box.__wired = true;
}

  // ===== 2) Filtrado por universo =====
  function toComp(v){ if(v==null) return ''; const s=String(v).trim(); return (isFinite(s) && s!=='') ? Number(s) : s.toUpperCase(); }
  function matches(props, u){
    if(u.scope==='ALL') return true;
    const keyField = u.scope==='MUN' ? FIELD_KEYS.mun : (u.scope==='DL' ? FIELD_KEYS.dl : FIELD_KEYS.df);
    return toComp(props?.[keyField]) === toComp(u.key);
  }
  function filterGeojson(geojson, u){
    if(u.scope==='ALL') return geojson;
    const features = (geojson.features || []).filter(f => matches(f.properties, u));
    return { ...geojson, features };
  }

 
  // Normaliza y busca una secci√≥n con varias variantes de llave
  function AT27_getSecSlot(js, sec){
    if (!js || !js.secciones) return null;
    const raw = String(sec||'').replace(/\D+/g,'');       // "0312" -> "312"
    const kPad = raw.padStart(4,'0');                     // "0312"
    const kNum = String(Number(raw));                     // "312"
    return js.secciones[kPad] || js.secciones[raw] || js.secciones[kNum] || null;
  }



    // =======================================================
    // Helper robusto: AT27_GG_shares2024(row24)
    // - Ignora campos no partidistas (LN, VOTOS, NULOS, etc).
    // - Normaliza nombres (sin acentos, may√∫sculas).
    // - Reconoce sin√≥nimos (PVEM ~ VERDE, MC ~ MOVIMIENTO CIUDADANO, NA ~ PANAL).
    // - Si encuentra alianzas (/, +, -), reparte los votos 1/n entre sus partidos.
    // Devuelve: { shares: {PARTIDO: fracci√≥n}, total: votos_usados }
    // =======================================================

    (function(){
      const KNOWN = new Set(['PAN','PRI','PRD','PVEM','PT','MC','MORENA','PES','NA','RSP','FXM','IND','OTROS']);
      const IGNORE = new Set([
        'LN','LISTA_NOMINAL','LISTA NOMINAL','VOTOS','TOTAL','TOTAL_VOTOS','VOTOS_TOTALES',
        'VALIDOS','V√ÅLIDOS','NULOS','VOTOS_NULOS','CNR','CAND_NO_REG','NO_REG','NO REG'
      ]);

      const MAP = new Map([
        // sin√≥nimos ‚Üí partido can√≥nico
        ['VERDE','PVEM'], ['PV','PVEM'], ['PVE','PVEM'], ['PARTIDO VERDE','PVEM'],
        ['MOVIMIENTO CIUDADANO','MC'], ['MC','MC'],
        ['NUEVA ALIANZA','NA'], ['PANAL','NA'], ['NA','NA'],
        ['ENCUENTRO SOCIAL','PES'], ['PES','PES'],
        ['FUERZA POR MEXICO','FXM'], ['FUERZA XM','FXM'], ['FXM','FXM'],
        ['REDES SOCIALES PROGRESISTAS','RSP'], ['RSP','RSP'],
        ['INDEPENDIENTE','IND'], ['CANDIDATO INDEPENDIENTE','IND'], ['IND','IND'],
        // comunes
        ['PAN','PAN'], ['PRI','PRI'], ['PRD','PRD'], ['PT','PT'], ['MORENA','MORENA']
      ]);

      function norm(s){
        return String(s||'')
          .normalize('NFD').replace(/[\u0300-\u036f]/g,'') // sin acentos
          .toUpperCase().replace(/\s+/g,' ').trim();
      }
      function canonParty(raw){
        const k = norm(raw);
        if (MAP.has(k)) return MAP.get(k);
        // si ya es conocido tal cual:
        if (KNOWN.has(k)) return k;
        // heur√≠stica: a veces vienen como "PARTIDO ACCION NACIONAL"
        if (k.includes('ACCION NACIONAL')) return 'PAN';
        if (k.includes('REVOLUCIONARIO INSTITUCIONAL')) return 'PRI';
        if (k.includes('DE LA REVOLUCION DEMOCRATICA')) return 'PRD';
        if (k.includes('VERDE')) return 'PVEM';
        if (k.includes('TRABAJO')) return 'PT';
        if (k.includes('MOVIMIENTO CIUDADANO')) return 'MC';
        if (k.includes('MORENA')) return 'MORENA';
        if (k.includes('NUEVA ALIANZA')) return 'NA';
        if (k.includes('ENCUENTRO SOCIAL')) return 'PES';
        if (k.includes('INDEPENDIENTE')) return 'IND';
        return 'OTROS';
      }

      // Exporta/actualiza helper global
      window.AT27_GG_shares2024 = function(row24){
        const votes = {};
        let used = 0;

        for (const [k,v] of Object.entries(row24||{})){
          const key = norm(k);
          if (IGNORE.has(key)) continue;
          const val = Number(v||0);
          if (!val) continue;

          // ¬øes coalici√≥n? separadores -, / o +
          if (/[\/+\-]/.test(key)){
            const parts = key.split(/[\/+\-]/).map(s => canonParty(s));
            const parties = parts.filter(p => KNOWN.has(p));
            if (parties.length === 0){
              votes.OTROS = (votes.OTROS||0) + val; used += val; continue;
            }
            const share = val / parties.length;
            parties.forEach(p => { votes[p] = (votes[p]||0) + share; });
            used += val;
            continue;
          }

          const p = canonParty(key);
          votes[p] = (votes[p]||0) + val;
          used += val;
        }

        const total = used;
        const shares = {};
        if (total > 0){
          for (const [p,vv] of Object.entries(votes)) shares[p] = vv / total;
        }
        return { shares, total };
      };
    })();

    // cuando terminas de construir la capa base:
    AT27_captureUniverse(capaBaseSecciones);



  // ====== CARGA ELECTORAL (para obtener 24DL_LN) ======
  function getPaths(){ try{ return JSON.parse(localStorage.getItem('AT_PATHS')||'{}'); }catch{ return {}; } }
  function getPuestoPath(p){ const paths = getPaths(); return paths?.electoral?.[p] || `data/electoral/${p}.json`; }

  window.AT_ELECT = window.AT_ELECT || {};
  async function getElectData(puesto){
    if (window.AT_ELECT[puesto]) return window.AT_ELECT[puesto];
    const res = await fetch(getPuestoPath(puesto));
    if (!res.ok) throw new Error(`HTTP ${res.status} en ${puesto}`);
    const js = await res.json();
    window.AT_ELECT[puesto] = js;
    return js;
  }
  // LN para 2024 desde DL; si no hay, intenta P (fallback)
  async function getLN24DL(sec){
    const key = String(sec);
    try {
      const dl = await getElectData('DL');
      const ln = dl?.secciones?.[key]?.["2024"]?.LN;
      if (typeof ln === 'number') return ln;
    } catch(_){}
    try {
      const p = await getElectData('P');
      const ln = p?.secciones?.[key]?.["2024"]?.LN;
      if (typeof ln === 'number') return ln;
    } catch(_){}
    return null;
  }

  // ====== ADYACENCIAS (Turf) ======
  function bboxIntersects(b1, b2){
    return !(b2[0] > b1[2] || b2[2] < b1[0] || b2[1] > b1[3] || b2[3] < b1[1]);
  }
  function getAdjacents(feat){
    const all = (window.AT_DATA?.features)
            || (window.AT_CTX?.layer?.toGeoJSON?.()?.features)
            || [];
    if (!all.length) return [];
    const b1 = turf.bbox(feat);
    const out = [];
    const sec1 = feat.properties?.SECCION;
    for (const f of all){
      const p = f.properties || {};
      if (p.SECCION === sec1) continue;
      const b2 = turf.bbox(f);
      if (!bboxIntersects(b1,b2)) continue;
      try {
        if (turf.booleanTouches(feat, f) || turf.booleanOverlap(feat, f) || turf.booleanIntersects(feat, f)){
          out.push(f);
        }
      } catch(_){}
    }
    return out.slice(0, 25); // cota de seguridad
  }

  // ====== LABELS SOBRE EL MAPA ======
  function addLabelForFeature(feat, className, text){
    try {
      const c = turf.centerOfMass(feat).geometry.coordinates; // [lon, lat]
      const m = L.marker([c[1], c[0]], { icon: L.divIcon({ className, html: text, iconSize:[0,0] }) });
      window.__SEC_LABELS = window.__SEC_LABELS || L.layerGroup().addTo(ensureLeafletMap());
      window.__SEC_LABELS.addLayer(m);
      return m;
    } catch(_){}
    return null;
  }

  function clearSectionOverlays(){
    const atMap = ensureLeafletMap();
    if (window.__SEC_HL){ try{ atMap.removeLayer(__SEC_HL); }catch(_){ } window.__SEC_HL = null; }
    if (window.__SEC_ADJ){ try{ atMap.removeLayer(__SEC_ADJ); }catch(_){ } window.__SEC_ADJ = null; }
    if (window.__SEC_LABELS){ try{ atMap.removeLayer(__SEC_LABELS); }catch(_){ } window.__SEC_LABELS = null; }
  }

  // Dibuja selecci√≥n + adyacentes + labels
  function paintSelectionAndAdj(feat){
    const atMap = ensureLeafletMap();
    clearSectionOverlays();

    // resaltado principal
    window.__SEC_HL = L.geoJSON(feat, { style:{ color:'#e91e63', weight:3, fillOpacity:0.25 } }).addTo(atMap);
    try { atMap.fitBounds(window.__SEC_HL.getBounds(), { padding:[28,28] }); } catch(_){}

    // adyacentes
    const adj = getAdjacents(feat);
    if (adj.length){
      window.__SEC_ADJ = L.geoJSON({type:'FeatureCollection', features:adj}, { style:{ color:'#90a4ae', weight:1.2, dashArray:'4,4', fillOpacity:0.05 } }).addTo(atMap);
    }

    // labels
    const sec = feat.properties?.SECCION ?? '‚Äî';
    addLabelForFeature(feat, 'sec-label', `Secci√≥n ${sec}`);
    for (const f of adj){
      const s2 = f.properties?.SECCION ?? '‚Äî';
      addLabelForFeature(f, 'sec-label-adj', s2);
    }
  }

  // ====== PANEL FLOTANTE (drag + datos) ======
  (function wireSecInfoPanel(){
    const box = document.getElementById('sec-info');
    const hdr = box?.querySelector('.hdr');
    if (!box || !hdr || box.__wired) return;
    let dragging = false, sx=0, sy=0, bx=0, by=0;
    hdr.addEventListener('mousedown', (e)=>{
      dragging=true; sx=e.clientX; sy=e.clientY;
      const r = box.getBoundingClientRect(); bx=r.left; by=r.top;
      document.body.style.userSelect='none';
    });
    window.addEventListener('mousemove', (e)=>{
      if (!dragging) return;
      const dx = e.clientX - sx, dy = e.clientY - sy;
      box.style.left = (bx + dx) + 'px';
      box.style.top  = (by + dy) + 'px';
      box.style.right = 'auto'; box.style.bottom='auto';
      box.style.position = 'absolute';
    });
    window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; });
    box.__wired = true;
  })();

  async function showSectionInfo(feat){
    ensureSecInfoPanelWired();
    const p = feat.properties || {};
    const sec = p.SECCION ?? '‚Äî';
    const df  = p[FIELD_KEYS.df] ?? '‚Äî';
    const dl  = p[FIELD_KEYS.dl] ?? '‚Äî';

    // LN 24DL_LN
    let ln = await getLN24DL(sec);
    if (ln==null) ln = '‚Äî';

    // Pintar
    const box = document.getElementById('sec-info');
    box.querySelector('.hdr').textContent = `Secci√≥n ${sec}`;
    document.getElementById('si-sec').textContent = sec;
    document.getElementById('si-df').textContent  = df;
    document.getElementById('si-dl').textContent  = dl;
    document.getElementById('si-ln').textContent  = ln;
    box.style.display = 'block';
  }



  // ENTER + CLIC + ULTIMO TOKEN

    function currentNeedle(q){
      if (!q) return '';
      const parts = String(q).split(/[,;\s]+/).filter(Boolean);
      return parts.length ? parts[parts.length-1] : '';
    }

// ===== Mini-selector de universo dentro del m√≥dulo =====
    let __mini = { selMun:null, selDf:null, selDl:null, all:null };

    function uniqueSorted(values){
    const arr = values.map(v => String(v ?? '').trim()).filter(Boolean);
    const set = Array.from(new Set(arr));
    return set.sort((a,b) => (isFinite(a)&&isFinite(b)) ? Number(a)-Number(b) : a.localeCompare(b,'es'));
    }
    function buildMiniOptions(raw){
    const feats = raw.features || [];
    const grab = k => uniqueSorted(feats.map(f => f.properties?.[k]));
    return { mun: grab(FIELD_KEYS.mun), df: grab(FIELD_KEYS.df), dl: grab(FIELD_KEYS.dl) };
    }
    function fillSelect(sel, arr){
    sel.innerHTML = '<option value="">‚Äî Ninguno ‚Äî</option>' + arr.map(v=>`<option value="${v}">${v}</option>`).join('');
    }
    function getMiniUniverse(){
    const { selMun, selDf, selDl, all } = __mini;
    if(all.checked) return { scope:'ALL', key:null, label:'Estado completo' };
    if(selMun.value) return { scope:'MUN', key: selMun.value, label:`Municipio ${selMun.options[selMun.selectedIndex].text}` };
    if(selDf.value)  return { scope:'DF',  key: selDf.value,  label:`Distrito Federal ${selDf.value}` };
    if(selDl.value)  return { scope:'DL',  key: selDl.value,  label:`Distrito Local ${selDl.value}` };
    return null;
    }
    function miniExclusivity(which){
    const { selMun, selDf, selDl, all } = __mini;
    if(which==='ALL'){ selMun.value=''; selDf.value=''; selDl.value=''; }
    if(which==='MUN'){ selDf.value=''; selDl.value=''; all.checked=false; }
    if(which==='DF'){  selMun.value=''; selDl.value=''; all.checked=false; }
    if(which==='DL'){  selMun.value=''; selDf.value=''; all.checked=false; }
    applyMiniUniverse();
    }
    function applyMiniUniverse(){
    const u2 = getMiniUniverse();
    if(!u2) return;
    // 1) Persistir
    localStorage.setItem('AT_UNIVERSE', JSON.stringify({ ...u2, ts:Date.now() }));
    // 2) Redibujar con el nuevo universo usando el raw ya cargado
    const atMap = ensureLeafletMap();
    const filtered2 = filterGeojson(window.AT_DATA, u2);
    if (window.AT_CTX?.layer) { atMap.removeLayer(AT_CTX.layer); }
    const layer2 = L.geoJSON(filtered2, { style:{ color:'#7d0025', weight:1.2, fillOpacity:0.15 } }).addTo(atMap);
    try { atMap.fitBounds(layer2.getBounds(), { padding:[20,20] }); } catch(e){}
    window.AT_CTX = { ...(window.AT_CTX||{}), universe: u2, layer: layer2 };
    // 3) Header
    const hdr = document.querySelector('#panel-header span');
    if(hdr){ hdr.textContent = `An√°lisis Territorial ¬∑ ${u2.label}`; }
      refreshSectionSearch(u2);
    }
    function initMiniSelector(raw, u){
    // Guardar el geojson bruto para futuros re-filtros
    window.AT_DATA = raw;

    __mini.selMun = document.getElementById('mini-sel-mun');
    labelMunicipiosFromCatalog('#mini-sel-mun');

    __mini.selDf  = document.getElementById('mini-sel-df');
    __mini.selDl  = document.getElementById('mini-sel-dl');
    __mini.all    = document.getElementById('mini-all-state');

    const opt = buildMiniOptions(raw);
    fillSelect(__mini.selMun, opt.mun);
    fillSelect(__mini.selDf,  opt.df);
    fillSelect(__mini.selDl,  opt.dl);

    // Reflejar el universo actual
    if(u.scope==='ALL'){ __mini.all.checked = true; }
    if(u.scope==='MUN'){ __mini.selMun.value = String(u.key); }
    if(u.scope==='DF'){  __mini.selDf.value  = String(u.key); }
    if(u.scope==='DL'){  __mini.selDl.value  = String(u.key); }


    
        async function labelMunicipiosFromCatalog(selectId){
        const sel = document.querySelector(selectId);
        if (!sel) return;

        // 1) Ruta del cat√°logo desde el Portal (AT_PATHS) o fallback
        let catUrl = 'data/catalogo_territorial.json';
        try {
            const paths = JSON.parse(localStorage.getItem('AT_PATHS') || '{}');
            if (paths?.catalog) catUrl = paths.catalog;
        } catch {}

        // 2) Cargar cat√°logo
        let cat = null;
        try {
            const r = await fetch(catUrl);
            if (!r.ok) throw new Error('HTTP '+r.status);
            cat = await r.json();
        } catch (e) {
            console.warn('[AT] No se pudo cargar el cat√°logo:', e);
            return; // salimos sin tocar etiquetas
        }

        const mapa = cat?.municipios || {};
        // helper: si el cat√°logo trae ceros a la izquierda en las llaves
        const getName = (code) => {
            const s = String(code);
            return mapa[s] || mapa[s.padStart(2,'0')] || mapa[s.padStart(3,'0')] || s;
        };

        // 3) Reetiquetar opciones (sin cambiar value)
        for (const opt of sel.options) {
            if (!opt.value) continue; // deja "‚Äî Ninguno ‚Äî"
            const name = getName(opt.value);
            opt.text = `${opt.value} ‚Äî ${name}`;
        }
        }

   

    // Eventos (auto-ejecuta)
    __mini.selMun.addEventListener('change', ()=> miniExclusivity('MUN'));
    __mini.selDf .addEventListener('change', ()=> miniExclusivity('DF'));
    __mini.selDl .addEventListener('change', ()=> miniExclusivity('DL'));
    __mini.all   .addEventListener('change', ()=> miniExclusivity('ALL'));
    }


    // Nombre fijo del campo (texto) del municipio
    const MUN_NAME_KEY = 'MUNICIPIO';

    // Detecta autom√°ticamente el campo de C√ìDIGO de municipio (si no, usa el nombre)
    function detectMunCodeKey(raw){
    const feats = raw.features || [];
    const candidates = ['MUN','CVE_MUN','CLV_MUN','ID_MUN','MUNICIPIO_ID','MUNICIPIO_CVE','CVE_MUNICIPIO','CVE_MPIO'];
    for (const k of candidates) {
        const ok = feats.some(f => {
        const v = f.properties?.[k];
        return v != null && String(v).trim() !== '' && String(v).toUpperCase() !== 'NULL';
        });
        if (ok) return k;
    }
    return null; // fallback ser√° MUN_NAME_KEY
    }



      // ‚Äî‚Äî Utils de texto ‚Äî‚Äî
      function _norm(s){
        if (s==null) return '';
        return String(s).normalize('NFD').replace(/[\u0300-\u036f]/g,'').toUpperCase().trim();
      }
      function _isDigits(s){ return /^[0-9]+$/.test(String(s||'')); }

      // ‚Äî‚Äî Nombre de municipio desde cat√°logo (si existe) ‚Äî‚Äî
      function getMunNameFromCatalog(code){
        const cat = window.AT_CATALOG;
        if (!cat?.municipios) return String(code ?? '');
        const s = String(code);
        // maneja posibles ceros a la izquierda
        return cat.municipios[s] || cat.municipios[s.padStart(2,'0')] || cat.municipios[s.padStart(3,'0')] || s;
      }

      // ‚Äî‚Äî √çndice de secciones ‚Äî‚Äî
      let __SEC_INDEX = { items: [], global: false };

      function buildSectionIndex(raw, universe, useGlobal){
        const feats = (raw?.features || []);
        const munKey = (window.AT_KEYS?.munCode) || FIELD_KEYS.mun;
        const items = [];

        // dataset base: global = todas, local = filtradas por universo
        const base = useGlobal ? feats : (filterGeojson(raw, universe).features || []);

        for(const f of base){
          const p = f.properties || {};
          const sec = p.SECCION ?? p.Seccion ?? p.seccion ?? null;
          if (sec == null) continue;

          const munCode = p[munKey];
          const munName = getMunNameFromCatalog(munCode);
          const df = p[FIELD_KEYS.df];
          const dl = p[FIELD_KEYS.dl];

          // texto para b√∫squeda
          const text = `${sec} ${munCode ?? ''} ${munName ?? ''} ${df ?? ''} ${dl ?? ''}`;
          // bounds (si multiparte, Leaflet lo resuelve)
          let bounds = null;
          try { bounds = L.geoJSON(f).getBounds(); } catch(_){}

          items.push({
            sec: String(sec).trim(),
            munCode: munCode,
            munName: munName,
            df, dl, feature: f, textNorm: _norm(text), bounds
          });
        }

        __SEC_INDEX = { items, global: !!useGlobal };
      }

      function searchSections(query, limit=15){
        const q = _norm(query);
        if (!q) return [];
        const ds = __SEC_INDEX.items;

        // Heur√≠stica sencilla:
        // - si es num√©rico puro: prioridad a SECCION que empiece con q
        // - si no: contiene tokens
        if (_isDigits(q)){
          const starts = ds.filter(it => _norm(it.sec).startsWith(q));
          if (starts.length >= limit) return starts.slice(0, limit);
          const contains = ds.filter(it => _norm(it.sec).includes(q));
          return [...starts, ...contains].slice(0, limit);
        } else {
          const tokens = q.split(/\s+/).filter(Boolean);
          return ds.filter(it => tokens.every(t => it.textNorm.includes(t))).slice(0, limit);
        }
      }

      // ‚Äî‚Äî UI de sugerencias ‚Äî‚Äî
      let __SEC_HIGHLIGHT = null;

      function renderSecSuggestions(list){
        const ul = document.getElementById('sec-suggest');
        if (!ul) return;
        if (!list.length){ ul.style.display='none'; ul.innerHTML=''; return; }

        ul.innerHTML = list.map(it => {
          const label = `${it.sec} ‚Äî ${it.munName || it.munCode || ''}`.replace(/\s+-\s+$/, '');
          const meta  = [];
          if (it.dl!=null) meta.push(`DL ${it.dl}`);
          if (it.df!=null) meta.push(`DF ${it.df}`);
          const sub = meta.length ? `<small style="color:#64748b">${meta.join(' ¬∑ ')}</small>` : '';
          return `<li data-sec="${it.sec}" style="padding:6px 8px; border-bottom:1px solid #e5e7eb; cursor:pointer">
                    <div>${label}</div>${sub}
                  </li>`;
        }).join('');
        ul.style.display = 'block';


      }

    function gotoSection(item){
      const atMap = (window.AT_CTX?.map) || ensureLeafletMap();

      // 1) Resolver el feature de la secci√≥n
      const sec = String(item.sec ?? item.SECCION ?? '');
      let feat = item.feature;

      if (!feat) {
        const feats =
          (window.AT_CTX?.layer?.toGeoJSON?.().features) ||
          (window.AT_DATA?.features) || [];
        feat = feats.find(f => String(f.properties?.SECCION) === sec);
      }

      if (!feat) {
        console.warn('[AT] No encontr√© el feature para la secci√≥n', sec, item);
        return;
      }

      // 2) Pintar selecci√≥n + adyacentes + labels (esto limpia overlays previos)
      paintSelectionAndAdj(feat);

      // 3) Mostrar panel con DF, DL y LN (24DL_LN)
      showSectionInfo(feat);

      // 4) Feedback visual (parpadeo leve sobre el highlight actual)
      const hl = window.__SEC_HL;
      if (hl && typeof hl.setStyle === 'function') {
        try {
          hl.setStyle({ weight: 4 });
          setTimeout(() => { try { hl.setStyle({ weight: 3 }); } catch(_){} }, 220);
        } catch(_){}
      }

      // 5) Oculta la lista de sugerencias (si est√° visible)
      const ul = document.getElementById('sec-suggest');
      if (ul) ul.style.display = 'none';
    }


      // Delegaci√≥n de clic en las sugerencias (una sola vez)
    (function wireSectionSearchEventsOnce(){
      const ul = document.getElementById('sec-suggest');
      const input = document.getElementById('sec-q');
      if (!ul || !input) return;

       // Si est√° dentro de un form, evita submit al Enter
      const form = input.closest('form');
      form?.addEventListener('submit', e => e.preventDefault());

      // Clic en cualquier <li data-sec="...">
      if (!ul.__wiredClick){
        ul.addEventListener('click', (ev)=>{
          const li = ev.target.closest('li[data-sec]');
          if (!li) return;
          const sec = li.getAttribute('data-sec');
          const item = (__SEC_INDEX?.items||[]).find(x => String(x.sec) === String(sec));
          if (item) gotoSection(item);
          ul.style.display = 'none';
        });
        ul.__wiredClick = true;
      }

      // Enter en el input = ir al primer resultado
      if (!input.__wiredKey){
        input.addEventListener('keydown', (ev)=>{
          if (ev.key === 'Enter'){
            ev.preventDefault(); // <- evita submit/autocomplete
            const results = searchSections(input.value, 1);
        const needle = currentNeedle(input.value);
        const [first] = searchSections(needle, 1);
        if (first) gotoSection(first);
        ul.style.display = 'none';
       }
          if (ev.key === 'Escape'){
            ul.style.display = 'none';
          }
        });
        input.__wiredKey = true;
      }

      // Input: recalcula sugerencias usando el "√∫ltimo token"
      if (!input.__wiredInput){
        input.addEventListener('input', ()=>{
          const needle = currentNeedle(input.value);
          renderSecSuggestions(searchSections(needle, 15));
        });
        input.__wiredInput = true;
      }
    })();


      // ‚Äî‚Äî Inicializar Buscador en el m√≥dulo ‚Äî‚Äî
      function initSectionSearch(raw, universe){
        const input   = document.getElementById('sec-q');
        const list    = document.getElementById('sec-suggest');
        const globalC = document.getElementById('sec-global');
        if (!input || !list) return;

        // construir √≠ndice (por universo actual)
        buildSectionIndex(raw, universe, !!globalC?.checked);



        // Cambiar √°mbito (global / universo actual)
        globalC?.addEventListener('change', () => {
          buildSectionIndex(raw, universe, !!globalC.checked);
          // refresca sugerencias con la query actual
          if (input.value){
            renderSecSuggestions(searchSections(input.value, 15));
          }
        });
      }

      // ‚Äî‚Äî Cuando cambies de universo con tu mini-selector, reindexa ‚Äî‚Äî
      function refreshSectionSearch(universe){
        const input   = document.getElementById('sec-q');
        const globalC = document.getElementById('sec-global');
        if (!window.AT_DATA || !input) return;
        buildSectionIndex(window.AT_DATA, universe, !!globalC?.checked);
        if (input.value){
          renderSecSuggestions(searchSections(input.value, 15));
        }
      }


      function getRawForIndex(){
        // Usa el dataset completo si ya lo cacheaste
        if (window.AT_DATA) return window.AT_DATA;
        // Si no, al menos usa lo ya pintado en el mapa
        const lyr = window.AT_CTX?.layer;
        return (lyr && typeof lyr.toGeoJSON === 'function') ? lyr.toGeoJSON() : null;
  }


  // ===== 3) Boot =====
  document.addEventListener('DOMContentLoaded', async () => {
    // a) Leer universo y rutas puestos en el PORTAL
    const u     = JSON.parse(localStorage.getItem('AT_UNIVERSE') || 'null');
    const paths = JSON.parse(localStorage.getItem('AT_PATHS') || '{"geo":""}');
    if (!u) {
      const hdr = document.querySelector('#panel-header span');
      hdr && (hdr.textContent += ' ¬∑ selecciona el universo en el Portal');
      setTimeout(()=>{ location.href = 'portal.html'; }, 600);
      return;
    }

    // b) Etiqueta del universo
    const hdr = document.querySelector('#panel-header span');
    hdr && (hdr.textContent += ` ¬∑ ${u.label}`);

    // c) Mapa √∫nico
    const atMap = ensureLeafletMap();
    assertIsLeafletMap(atMap);

    // d) Cargar y filtrar GeoJSON
    const url = paths.geo || 'data/geo/secciones.geojson'; // <-- ajusta si tu ruta difiere

    // Cargar cat√°logo territorial (para nombres visibles)
    const catUrl = (paths.catalog && paths.catalog.trim()) || '/data/catalogo_territorial.json';
    let catalog = window.AT_CATALOG || null;
    if (!catalog) {
    try {
        const rc = await fetch(catUrl);
        if (!rc.ok) throw new Error(`HTTP ${rc.status} al cargar cat√°logo ${catUrl}`);
        catalog = await rc.json();
        window.AT_CATALOG = catalog;
    } catch (err) {
        console.warn('[AT] No se pudo cargar el cat√°logo de nombres:', err);
        window.AT_CATALOG = catalog = null; // seguimos sin nombres amigables
    }
    }


 let raw = window.AT_DATA || null; // usa cach√© si ya existe
if (!raw) {
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status} al cargar ${url}`);
    raw = await res.json();       // ‚úÖ solo una vez
    window.AT_DATA = raw;         // ‚úÖ guarda en cach√© aqu√≠
  } catch (err) {
    console.error('[AT] Error cargando GeoJSON:', err);
    alert('No se pudo cargar el GeoJSON');
    return;
  }
}
// a partir de aqu√≠, usa 'raw'

    const filtered = filterGeojson(raw, u);
    console.log('[AT] Universo:', u, 'Total:', raw.features?.length||0, 'Filtradas:', filtered.features?.length||0);

    if(!filtered.features || filtered.features.length===0){
      console.warn('[AT] No hay geometr√≠as para el universo seleccionado:', u);
      alert('No hay datos para el universo seleccionado');
    }

    // Nombre fijo del campo (texto) del municipio
        const MUN_NAME_KEY = 'MUNICIPIO';

    // Detecta campo de C√ìDIGO (si existe); si no, usa el de nombre
        function detectMunCodeKey(raw){
        const feats = raw.features || [];
        const candidates = ['MUN','CVE_MUN','CLV_MUN','ID_MUN','MUNICIPIO_ID','MUNICIPIO_CVE','CVE_MUNICIPIO','CVE_MPIO'];
        for (const k of candidates) {
            if (feats.some(f => (f.properties?.[k] ?? '') !== '')) return k;
        }
        return null;
        }

        const munCodeKey = detectMunCodeKey(raw) || MUN_NAME_KEY; // fallback: nombre
        FIELD_KEYS.mun = munCodeKey;
        window.AT_KEYS = { munCode: munCodeKey, munName: MUN_NAME_KEY };


    // e) Dibujar capa
        const layer = L.geoJSON(filtered, {
      style: { color:'#000000', weight:1.2, fillOpacity:0.15 },
      onEachFeature: (feat, lyr) => {
        const p = feat.properties || {};
        const muni = p[FIELD_KEYS.mun] ?? '‚Äî';
        const dl   = p[FIELD_KEYS.dl]  ?? '‚Äî';
        const df   = p[FIELD_KEYS.df]  ?? '‚Äî';
        lyr.bindPopup(`<b>Secci√≥n</b>: ${p.SECCION ?? '‚Äî'}<br><b>Mun</b>: ${muni}<br><b>DL</b>: ${dl}<br><b>DF</b>: ${df}`);
        lyr.on('mouseover', () => lyr.setStyle({weight:2}));
        lyr.on('mouseout',  () => lyr.setStyle({weight:1.2}));
      }
    }).addTo(atMap);

    try { atMap.fitBounds(layer.getBounds(), { padding:[20,20] }); } catch(e){}
    window.AT_CTX = { universe: u, paths, map: atMap, layer };

    function getMunNameFromCatalog(code){
      const cat = window.AT_CATALOG;
      if (!cat?.municipios) return String(code ?? '');
      return cat.municipios[String(code)] || String(code ?? '');
    }
    function getDfListFromCatalog(feats){
      return (window.AT_CATALOG?.distritos_federales && window.AT_CATALOG.distritos_federales.length)
        ? window.AT_CATALOG.distritos_federales
        : uniqSorted(feats.map(f => f.properties?.[FIELD_KEYS.df]));
    }
    function getDlListFromCatalog(feats){
      return (window.AT_CATALOG?.distritos_locales && window.AT_CATALOG.distritos_locales.length)
        ? window.AT_CATALOG.distritos_locales
        : uniqSorted(feats.map(f => f.properties?.[FIELD_KEYS.dl]));
    }
        initMiniSelector(raw, u);
        initSectionSearch(window.AT_DATA || raw, u);  

    });

    document.getElementById('btn-gt-part')?.addEventListener('click', () => {
      AT27_GT_PART_ejecutar('A','2024');
    });


  (function wireATHotkeys(){
      if (window.__AT_HOTKEYS) return;
      window.__AT_HOTKEYS = true;

      window.addEventListener('keydown', (e)=>{
        // Esc: cerrar panel
        if (e.key === 'Escape'){
          if (document.getElementById('sec-info')?.style.display !== 'none'){
            e.preventDefault();
            closeSecInfoPanel();
          }
        }
        // Ctrl+K (o Cmd+K en Mac): enfocar buscador de secciones
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k'){
          e.preventDefault();
          document.getElementById('sec-q')?.focus();
        }
      });
    })();


  </script>
  <div id="sec-info">
    <div class="hdr">
    <span class="ttl">Secci√≥n</span>
    <button id="sec-close" class="btn-close" aria-label="Cerrar">√ó</button>
  </div>
  <div class="body">
    <div class="row"><span class="k">Secci√≥n</span>        <span class="v" id="si-sec">‚Äî</span></div>
    <div class="row"><span class="k">Distrito Federal</span><span class="v" id="si-df">‚Äî</span></div>
    <div class="row"><span class="k">Distrito Local</span>  <span class="v" id="si-dl">‚Äî</span></div>
    <div class="row"><span class="k">LN (2024)</span>    <span class="v" id="si-ln">‚Äî</span></div>
  </div>
</div>

<script>
  /* ========== MOD: GANAR TODO ¬∑ PARTICIPACI√ìN (AT27_GT_PART_) ========== */
    const AT27_GT_PART_PUESTOS = { A:'Ayuntamiento', DL:'Diputado Local', DF:'Diputado Federal', G:'Gobernador', S:'Senador', P:'Presidente' };
    const AT27_GT_PART_COLORS  = { LOW:'#ef4444', MID:'#facc15', HIGH:'#22c55e' };
    const AT27_GT_PART_sec  = s => String(s??'').replace(/\D+/g,'');
    const AT27_GT_PART_yearsFor = p => (['G','S','P'].includes(p) ? ['2018','2024','2027*'] : ['2018','2021','2024','2027*']);

    function AT27_GT_PART_getUniverseSecIds(){
      const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];
      const ids = [];
      for (const f of feats){
        const p = f.properties||{};
        const id = AT27_GT_PART_sec(p.ID ?? p.Seccion ?? p.SECCION ?? p.seccion ?? p.id ?? p.SECCION);
        if (id) ids.push(id);
      }
      return [...new Set(ids)];
    }

    function AT27_GT_PART_partPct(row){
      if (!row) return null;
      const ln = Number(row.LN||0); if (!ln) return null;
      let votos = (row.VOTOS!=null) ? Number(row.VOTOS||0) : 0;
      if (row.VOTOS==null){ for (const [k,v] of Object.entries(row)){ if (k!=='LN'&&k!=='VOTOS') votos += Number(v||0); } }
      const pct = (votos/ln)*100;
      return Math.max(0, Math.min(100, pct));
    }

    // Proyecci√≥n 2027 (ver explicaci√≥n en el mensaje)
    function AT27_GT_PART_project2027(slot, puesto){
      const p18 = AT27_GT_PART_partPct(slot['2018']);
      const p21 = AT27_GT_PART_partPct(slot['2021']);
      const p24 = AT27_GT_PART_partPct(slot['2024']);
      const vals = [p18,p21,p24].filter(v=>typeof v==='number'&&isFinite(v));
      if (vals.length===0) return null;
      if (['G','S','P'].includes(puesto)){
        const a = (typeof p18==='number')?p18:p24, b = (typeof p24==='number')?p24:p18;
        const slopePerYear = (b-a)/6;
        return Math.max(0, Math.min(100, b + 0.6*slopePerYear*3));
      } else {
        const pts=[]; if (typeof p18==='number') pts.push({t:0,y:p18,w:1.0}); if (typeof p21==='number') pts.push({t:3,y:p21,w:1.5}); if (typeof p24==='number') pts.push({t:6,y:p24,w:2.0});
        const W=pts.reduce((a,p)=>a+p.w,0), tbar=pts.reduce((a,p)=>a+p.w*p.t,0)/W, ybar=pts.reduce((a,p)=>a+p.w*p.y,0)/W;
        const num=pts.reduce((a,p)=>a+p.w*(p.t-tbar)*(p.y-ybar),0), den=pts.reduce((a,p)=>a+p.w*(p.t-tbar)*(p.t-tbar),0)||1e-9;
        const b1=num/den, b0=ybar-b1*tbar;
        return Math.max(0, Math.min(100, b0 + b1*9));
      }
    }

    function AT27_GT_PART_compute(js, secIds, puesto, year){
      const perSec = {}; const bins={LOW:0,MID:0,HIGH:0};
      let lnW=0, partW=0;
      for (const sec of secIds){
        const slot = js?.secciones?.[sec]; if (!slot) continue;
        const pct = (year==='2027*') ? AT27_GT_PART_project2027(slot, puesto) : AT27_GT_PART_partPct(slot[year]);
        if (pct==null || !isFinite(pct)) continue;
        perSec[sec]=pct;
        if (pct<30) bins.LOW++; else if (pct<50) bins.MID++; else bins.HIGH++;
        const rowForLN = (year==='2027*' ? slot['2024'] : slot[year]) || {};
        const ln = Number(rowForLN?.LN||0); if (ln>0){ lnW += ln; partW += pct*ln; }
      }
      const avg = lnW>0 ? (partW/lnW) : NaN;
      return { perSec, bins, avg };
    }

    function AT27_GT_PART_clearOverlay(){
      const map = window.AT_CTX?.map || window.map; if (!map) return;
      if (window.AT27_GT_PART_LAYER){ try{ map.removeLayer(AT27_GT_PART_LAYER); }catch(_){ } window.AT27_GT_PART_LAYER=null; }
    }

    function AT27_GT_PART_buildOverlay(perSec){
      const map = window.AT_CTX?.map || window.map;
      const base = window.AT_CTX?.layer?.toGeoJSON?.() || window.AT_DATA;
      if (!map || !base?.features) return;
      if (map.createPane && !map.getPane('at27_gt_part_pane')){
        map.createPane('at27_gt_part_pane'); map.getPane('at27_gt_part_pane').style.zIndex=660; map.getPane('at27_gt_part_pane').style.pointerEvents='none';
      }
      const geo = { type:'FeatureCollection', features: base.features.filter(f=>{
        const id = AT27_GT_PART_sec(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
        return perSec[id]!=null;
      })};
      const layer = L.geoJSON(geo, {
        pane:'at27_gt_part_pane',
        style:f=>{
          const id = AT27_GT_PART_sec(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
          const pct = perSec[id];
          const col = (pct<30)?AT27_GT_PART_COLORS.LOW: (pct<50?AT27_GT_PART_COLORS.MID:AT27_GT_PART_COLORS.HIGH);
          return { color:col, weight:1, opacity:.9, fillColor:col, fillOpacity:.45 };
        },
        interactive:false
      });
      AT27_GT_PART_clearOverlay(); layer.addTo(map); window.AT27_GT_PART_LAYER=layer;
    }

    function AT27_GT_PART_getOrCreatePanel(){
      let panel=document.getElementById('AT27_GT_PART_panel'); if (panel) return panel;
      panel=document.createElement('div');
      Object.assign(panel.style,{position:'fixed',right:'32px',top:'32px',zIndex:9999,width:'360px',height:'230px',background:'#fff',border:'1px solid #e5e7eb',borderRadius:'14px',boxShadow:'0 18px 40px rgba(0,0,0,.18)',overflow:'hidden',resize:'both',fontFamily:'system-ui, Segoe UI, Roboto, Arial'});
      panel.id='AT27_GT_PART_panel';
      panel.innerHTML=`
        <div id="AT27_GT_PART_hdr" style="cursor:move; user-select:none; background:#efefef; color:#111; padding:10px 12px; display:flex; gap:10px; align-items:center;">
          <div style="font-weight:800;">Participaci√≥n por secci√≥n</div>
          <select id="AT27_GT_PART_selYear"   style="margin-left:auto; background:#fff; color:#111827; border-radius:8px; padding:4px 8px; border:none; outline:none;"></select>
          <select id="AT27_GT_PART_selPuesto" style="background:#fff; color:#111827; border-radius:8px; padding:4px 8px; border:none; outline:none;">
            ${Object.entries(AT27_GT_PART_PUESTOS).map(([k,v])=>`<option value="${k}">${v}</option>`).join('')}
          </select>
          <button id="AT27_GT_PART_close" title="Cerrar" style="background:transparent;color:#111;border:none;font-size:18px;cursor:pointer;">√ó</button>
        </div>
        <div id="AT27_GT_PART_body" style="padding:10px 12px; height: calc(100% - 50px); overflow:auto;">
          <div style="margin-bottom:8px;">
            <div style="font-weight:700;">Leyenda</div>
            <div style="display:flex; gap:10px; margin-top:6px; font-size:13px;">
              <div style="display:flex; align-items:center; gap:6px;"><span style="display:inline-block;width:12px;height:12px;background:${AT27_GT_PART_COLORS.LOW};border:1px solid rgba(0,0,0,.2);border-radius:3px;"></span> < 30%</div>
              <div style="display:flex; align-items:center; gap:6px;"><span style="display:inline-block;width:12px;height:12px;background:${AT27_GT_PART_COLORS.MID};border:1px solid rgba(0,0,0,.2);border-radius:3px;"></span> 30‚Äì50%</div>
              <div style="display:flex; align-items:center; gap:6px;"><span style="display:inline-block;width:12px;height:12px;background:${AT27_GT_PART_COLORS.HIGH};border:1px solid rgba(0,0,0,.2);border-radius:3px;"></span> > 50%</div>
            </div>
          </div>
          <div id="AT27_GT_PART_stats" style="font-size:13px;color:#334155;"></div>
        </div>`;
      document.body.appendChild(panel);
      panel.querySelector('#AT27_GT_PART_close').onclick=()=>{ AT27_GT_PART_clearOverlay(); panel.remove(); };
      (function drag(panel,handle){ let drag=false,sx=0,sy=0,bx=0,by=0; handle.addEventListener('mousedown',e=>{drag=true;sx=e.clientX;sy=e.clientY;const r=panel.getBoundingClientRect();bx=r.left;by=r.top;document.body.style.userSelect='none';}); window.addEventListener('mousemove',e=>{if(!drag)return; const dx=e.clientX-sx, dy=e.clientY-sy; panel.style.left=(bx+dx)+'px'; panel.style.top=(by+dy)+'px'; panel.style.right='auto';}); window.addEventListener('mouseup',()=>{drag=false;document.body.style.userSelect='';});})(panel, panel.querySelector('#AT27_GT_PART_hdr'));
      return panel;
    }

    function AT27_GT_PART_populateYears(puesto){
      const panel=AT27_GT_PART_getOrCreatePanel(); const selY=panel.querySelector('#AT27_GT_PART_selYear');
      const years=AT27_GT_PART_yearsFor(puesto); selY.innerHTML=years.map(y=>`<option value="${y}">${y}</option>`).join(''); if (years.includes('2024')) selY.value='2024';
    }

    async function AT27_GT_PART_update(){
      const panel=AT27_GT_PART_getOrCreatePanel(); const selY=panel.querySelector('#AT27_GT_PART_selYear'); const selP=panel.querySelector('#AT27_GT_PART_selPuesto');
      const puesto=selP.value, year=selY.value;
      const secIds=AT27_GT_PART_getUniverseSecIds();
      const js=await loadPuesto(puesto);
      const { perSec, bins, avg }=AT27_GT_PART_compute(js, secIds, puesto, year);
      AT27_GT_PART_buildOverlay(perSec);
      const total=secIds.length, stats = `
        <div>Universo: <b>${total}</b> secciones ¬∑ Puesto <b>${AT27_GT_PART_PUESTOS[puesto]||puesto}</b> ¬∑ A√±o <b>${year}</b></div>
        <div style="margin-top:4px;">Promedio del universo (ponderado por LN): <b>${isFinite(avg)?avg.toFixed(1):'‚Äî'}%</b></div>
        <div style="margin-top:6px; display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px;">
          <div><span style="color:${AT27_GT_PART_COLORS.LOW};font-weight:700;">${bins.LOW}</span> <span style="color:#64748b;">(< 30%)</span></div>
          <div><span style="color:#b45309;font-weight:700;">${bins.MID}</span> <span style="color:#64748b;">(30‚Äì50%)</span></div>
          <div><span style="color:${AT27_GT_PART_COLORS.HIGH};font-weight:700;">${bins.HIGH}</span> <span style="color:#64748b;">(> 50%)</span></div>
        </div>`;
      panel.querySelector('#AT27_GT_PART_stats').innerHTML=stats;
    }

    async function AT27_GT_PART_ejecutar(puestoInicial='A', yearInicial='2024'){
      const panel=AT27_GT_PART_getOrCreatePanel(); const selY=panel.querySelector('#AT27_GT_PART_selYear'); const selP=panel.querySelector('#AT27_GT_PART_selPuesto');
      selP.value=puestoInicial; AT27_GT_PART_populateYears(puestoInicial); if ([...selY.options].some(o=>o.value===yearInicial)) selY.value=yearInicial;
      selP.onchange=()=>{ AT27_GT_PART_populateYears(selP.value); AT27_GT_PART_update(); };
      selY.onchange=()=> AT27_GT_PART_update();
      await AT27_GT_PART_update();
    }
    /* ============================ FIN MOD ============================ */

</script>

<script>
  // Usa tu loader de JSON electorales si no existe loadPuesto
  window.loadPuesto = window.loadPuesto || window.getElectData;

  // Evita que la barra ‚Äúcoma‚Äù los clicks/scroll del mapa y cablea el bot√≥n
  (function wireTopBarGT(){
    const bar = document.getElementById('top-toolbar');
    if (!bar || bar.__wired) return;
    if (window.L && L.DomEvent){
      L.DomEvent.disableClickPropagation(bar);
      L.DomEvent.disableScrollPropagation(bar);
    }
    document.getElementById('btn-gt-part')?.addEventListener('click', () => {
      // Lanza el panel flotante de Participaci√≥n (el overlay se pinta en el mapa)
      AT27_GT_PART_ejecutar('A','2024');
    });

    document.getElementById('btn-estabilidad')?.addEventListener('click', () => {
      AT27_EP_ejecutar(); // puesto fijo 'A'
    });

    document.getElementById('btn-ayuda')?.addEventListener('click', ()=>{
      document.getElementById('mini-ayuda-GT')?.scrollIntoView({behavior:'smooth', block:'start'});
    });

    document.getElementById('btn-gt-metas')?.addEventListener('click', () => {
      AT27_GT_META_ejecutar('A', 50, 3); // puesto A, meta 50%, tolerancia 3 pp
    });

    document.getElementById('btn-gt-ganar')?.addEventListener('click', () => {
      AT27_GT_GANAR_ejecutar('A','PAN'); // abre con Ayuntamiento + PAN
    });

    document.getElementById('btn-recentrar')?.addEventListener('click', () => {
      AT27_fitUniverseBounds();
    });
    
        /* ====== Cableado del bot√≥n de la barra (a√±ade un bot√≥n con id="btn-prob-volteo") ====== */
    
      document.getElementById('btn-prob-volteo')?.addEventListener('click',() =>{
         AT27_PV_open();
          });
          // Atajo de teclado: R
          document.addEventListener('keydown', (e)=>{
            if (e.key === 'R' || e.key === 'r'){
              e.preventDefault();
              AT27_fitUniverseBounds();
            }
          });

      /* ====== Cableado bot√≥n de la barra ====== */
    
      document.getElementById('btn-plan-mayoria')?.addEventListener('click',() =>{
         AT27_PM_open();
      });

          /* ====== Cableado bot√≥n de la barra ====== */
    
      document.getElementById('btn-eficiencia-voto')?.addEventListener('click',() =>{
        AT27_EV_open();
      });

          /* ====== Cableado bot√≥n de la barra ====== */
    
      document.getElementById('btn-corredores-volteo')?.addEventListener('click',() =>{
         AT27_CV_open();
      });

      document.getElementById('btn-alertas-riesgo')?.addEventListener('click',() =>{
        AT27_AR_open();
      });

          /* ====== Cableado bot√≥n ====== */

      document.getElementById('btn-simulador-impulso')?.addEventListener('click',() =>{
         AT27_SI_open();
      });

          /* ====== Cableado bot√≥n ====== */
    
      document.getElementById('btn-brecha')?.addEventListener('click',() =>{
         AT27_BR_open();
    });

        /* ====== Cableado bot√≥n ====== */

      document.getElementById('btn-sensibilidad-participacion')?.addEventListener('click',() =>{
         AT27_SP_open();
    });

    bar.__wired = true;
  })();
</script>

<script>
  // ===== Universo robusto (ids + geo) =====
  (function(){
    const sec4 = s => String(s||'').replace(/\D+/g,'').padStart(4,'0');

    window.AT27_UNI = window.AT27_UNI || { ids: [], fc: null };

    // Llama esto cuando creas/actualizas la capa base de secciones (DF/DL/Mpio/Estado)
    window.AT27_captureUniverse = function(layer){
      try{
        const fc = layer?.toGeoJSON?.();
        if (!fc?.features) return;
        const ids = fc.features.map(f=> sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id));
        window.AT27_UNI = { ids, fc };
      }catch(_){}
    };

    window.AT27_getUniverseSecIds = function(){
      if (AT27_UNI.ids?.length) return [...AT27_UNI.ids];
      const base = window.AT_DATA?.features || (window.AT_CTX?.layer?.toGeoJSON?.().features) || [];
      return base.map(f=> sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id));
    };

    window.AT27_getUniverseFC = function(){
      return AT27_UNI.fc || window.AT_DATA || (window.AT_CTX?.layer?.toGeoJSON?.()) || {type:'FeatureCollection', features:[]};
    };
  })();
</script>

  
<script>
  /* ====== ESTABILIDAD POL√çTICA 2018‚Äì2024 con upgrades (AT27_EP_) ====== */

const AT27_EP_COLORS = { HIGH:'#22c55e', MED:'#facc15', LOW:'#ef4444' }; // verde, amarillo, rojo
const AT27_EP_PUESTOS = { A:'Ayuntamiento', DL:'Diputado Local', DF:'Diputado Federal', G:'Gobernador', S:'Senador', P:'Presidente' };
const AT27_EP_sec = s => String(s??'').replace(/\D+/g,'');
const AT27_EP_yearsFor = p => (['G','S','P'].includes(p) ? ['2018','2024'] : ['2018','2021','2024']);
let   AT27_EP_FILL_OPACITY = 0.45; // slider

// Universo actual ‚Üí ids
function AT27_EP_getUniverseSecIds(){
  const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];
  const ids=[]; for (const f of feats){ const p=f.properties||{}; const id=AT27_EP_sec(p.ID??p.Seccion??p.SECCION??p.seccion??p.id); if(id) ids.push(id); }
  return [...new Set(ids)];
}

// ganador por fila (excluye LN/VOTOS)
function AT27_EP_winner(row){
  if (!row) return null;
  let best=null, max=-1;
  for (const [k,v] of Object.entries(row)){
    if (k==='LN'||k==='VOTOS') continue;
    const vv=Number(v||0); if (vv>max){max=vv; best=k.toUpperCase();}
  }
  return best;
}

// c√°lculo por secci√≥n (generalizado a 2 o 3 elecciones)
function AT27_EP_compute(js, secIds, years){
  const perSec = {}; // sec -> {cat, winners:{year:party}}
  const counts = { HIGH:0, MED:0, LOW:0 };
  let analyzed = 0;

  for (const sec of secIds){
    const slot = js?.secciones?.[sec]; if (!slot) continue;

    const winners = {};
    for (const y of years){ winners[y] = AT27_EP_winner(slot[y]); }
    const vals = years.map(y=>winners[y]).filter(Boolean);
    if (vals.length < Math.min(2, years.length)) continue; // requiere >=2 datos

    const uniq = new Set(vals).size;
    let cat;
    if (years.length === 3){
      // 2018‚Äì2021‚Äì2024: Alta=1 partido, Media=2 partidos, Baja=3 partidos
      cat = (uniq===1) ? 'HIGH' : (uniq===2 ? 'MED' : 'LOW');
    }else{
      // sexenales (2018,2024): Alta=igual, Media=diferente (no hay "LOW")
      cat = (uniq===1) ? 'HIGH' : 'MED';
    }
    perSec[sec] = { cat, winners };
    counts[cat]++; analyzed++;
  }
  return { perSec, counts, analyzed };
}

// limpiar / construir overlay
function AT27_EP_clearOverlay(){
  const map = window.AT_CTX?.map || window.map; if (!map) return;
  if (window.AT27_EP_LAYER){ try{ map.removeLayer(AT27_EP_LAYER); }catch(_){ } window.AT27_EP_LAYER=null; }
}
function AT27_EP_buildOverlay(perSec, years){
  const map  = window.AT_CTX?.map || window.map;
  const base = window.AT_CTX?.layer?.toGeoJSON?.() || window.AT_DATA;
  if (!map || !base?.features) return;

  if (map.createPane && !map.getPane('at27_ep_pane')){
    map.createPane('at27_ep_pane');
    map.getPane('at27_ep_pane').style.zIndex = 665;
    map.getPane('at27_ep_pane').style.pointerEvents = 'auto'; // permitir hover
  }

  const features = base.features.filter(f=>{
    const id = AT27_EP_sec(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
    return perSec[id]!=null;
  });
  const geo = { type:'FeatureCollection', features };

  const layer = L.geoJSON(geo, {
    pane: 'at27_ep_pane',
    style: f=>{
      const id  = AT27_EP_sec(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
      const cat = perSec[id]?.cat; const col = AT27_EP_COLORS[cat] || '#94a3b8';
      return { color: col, weight: 1, opacity: .9, fillColor: col, fillOpacity: AT27_EP_FILL_OPACITY };
    },
    onEachFeature: (feature, lyr)=>{
      const id = AT27_EP_sec(feature.properties?.ID ?? feature.properties?.SECCION ?? feature.properties?.id);
      const info = perSec[id]; if (!info) return;
      const seq = years.map(y => `${y}: <b>${info.winners[y]||'‚Äî'}</b>`).join(' &nbsp;‚Üí&nbsp; ');
      lyr.bindTooltip(`<div style="font-size:12px;">${seq}</div>`, {sticky:true, opacity:0.95, direction:'top', className:'at27-tt'});
      lyr.on('mouseover', ()=> lyr.setStyle({weight:2}));
      lyr.on('mouseout',  ()=> lyr.setStyle({weight:1}));
    }
  });


// ===== Universo robusto (ids + geo) =====
  (function(){
    const sec4 = s => String(s||'').replace(/\D+/g,'').padStart(4,'0');

    window.AT27_UNI = window.AT27_UNI || { ids: [], fc: null };

    // Llama esto cuando creas/actualizas la capa base de secciones (DF/DL/Mpio/Estado)
    window.AT27_captureUniverse = function(layer){
      try{
        const fc = layer?.toGeoJSON?.();
        if (!fc?.features) return;
        const ids = fc.features.map(f=> sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id));
        window.AT27_UNI = { ids, fc };
      }catch(_){}
    };

    window.AT27_getUniverseSecIds = function(){
      if (AT27_UNI.ids?.length) return [...AT27_UNI.ids];
      // Fallback a los datos cargados originalmente
      const base = window.AT_DATA?.features || (window.AT_CTX?.layer?.toGeoJSON?.().features) || [];
      return base.map(f=> sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id));
    };

    window.AT27_getUniverseFC = function(){
      return AT27_UNI.fc || window.AT_DATA || (window.AT_CTX?.layer?.toGeoJSON?.()) || {type:'FeatureCollection', features:[]};
    };
  })();

  

  AT27_EP_clearOverlay();
  layer.addTo(map);
  window.AT27_EP_LAYER = layer;
}

// actualizar opacidad en caliente
function AT27_EP_updateOpacity(){
  if (!window.AT27_EP_LAYER) return;
  window.AT27_EP_LAYER.setStyle({ fillOpacity: AT27_EP_FILL_OPACITY });
}

// Panel flotante (con puesto, opacidad y export)
function AT27_EP_getOrCreatePanel(){
  let panel = document.getElementById('AT27_EP_panel');
  if (panel) return panel;

  panel = document.createElement('div');
  panel.id = 'AT27_EP_panel';
  Object.assign(panel.style,{
    position:'fixed', right:'32px', top:'32px', zIndex:9999,
    width:'380px', background:'#fff', border:'1px solid #e5e7eb',
    borderRadius:'14px', boxShadow:'0 18px 40px rgba(0,0,0,.18)', overflow:'hidden',
    fontFamily:'system-ui, Segoe UI, Roboto, Arial'
  });
  panel.innerHTML = `
    <div id="AT27_EP_hdr" style="cursor:move; user-select:none; background:#e0e7ff; color:#111; padding:10px 12px; display:flex; gap:10px; align-items:center;">
      <div style="font-weight:800;">Estabilidad Pol√≠tica 2018‚Äì2024</div>
      <select id="AT27_EP_selPuesto" style="margin-left:auto;background:#fff;color:#111827;border-radius:8px;padding:4px 8px;border:none;outline:none;">
        ${Object.entries(AT27_EP_PUESTOS).map(([k,v])=>`<option value="${k}">${v}</option>`).join('')}
      </select>
      <button id="AT27_EP_close" title="Cerrar" style="background:transparent;color:#111;border:none;font-size:18px;cursor:pointer;">√ó</button>
    </div>
    <div id="AT27_EP_body" style="padding:12px 14px;">
      <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
        <div style="font-size:12px;color:#334155;">Opacidad</div>
        <input id="AT27_EP_opacity" type="range" min="0.1" max="0.9" step="0.05" value="${AT27_EP_FILL_OPACITY}" style="flex:1;">
        <button id="AT27_EP_export" class="ttb-btn" style="margin-left:6px;">Exportar PNG</button>
      </div>
      <div style="font-weight:700;margin-bottom:6px;">Leyenda</div>
      <div id="AT27_EP_legend" style="display:grid; grid-template-columns: 1fr; gap:6px; font-size:13px;"></div>
      <div id="AT27_EP_totalBox" style="margin-top:10px; font-weight:800;"></div>
    </div>
  `;
  document.body.appendChild(panel);

  panel.querySelector('#AT27_EP_close').onclick = ()=>{ AT27_EP_clearOverlay(); panel.remove(); };

  // drag
  (function drag(panel, handle){
    let sx=0, sy=0, ox=0, oy=0, dragging=false;
    handle.addEventListener('mousedown', e=>{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panel.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });
    window.addEventListener('mousemove', e=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panel.style.left=(ox+dx)+'px'; panel.style.top=(oy+dy)+'px'; panel.style.right='auto'; });
    window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; });
  })(panel, panel.querySelector('#AT27_EP_hdr'));

  // listeners del panel
  panel.querySelector('#AT27_EP_opacity').addEventListener('input', (e)=>{ AT27_EP_FILL_OPACITY = Number(e.target.value); AT27_EP_updateOpacity(); });
  panel.querySelector('#AT27_EP_export').addEventListener('click', AT27_EP_exportPNG);

  return panel;
}

// Rellena leyenda din√°micamente (en sexenales no hay "LOW")
function AT27_EP_renderLegend(counts, analyzed, years){
  const LBL = {
    HIGH: years.length===3 ? 'Alta (mismo partido 3 elecciones)' : 'Alta (mismo partido en todas)',
    MED : years.length===3 ? 'Estabilidad Media (1 cambio)'      : 'Media (cambio)',
    LOW : 'Inestabilidad Alta (3 partidos)'
  };
  const rows = ['HIGH','MED','LOW'].map(k=>{
    const hide = (k==='LOW' && years.length===2); // no aplica en 2 elecciones
    const pct  = analyzed>0 ? ` (${(counts[k]*100/analyzed).toFixed(1)}%)` : '';
    return hide ? '' : `
      <div style="display:flex;align-items:center;gap:8px;">
        <span style="width:12px;height:12px;border-radius:3px;background:${AT27_EP_COLORS[k]};border:1px solid rgba(0,0,0,.15)"></span>
        ${LBL[k]}: <b style="margin-left:4px;">${counts[k]}</b>
        <span style="color:#64748b;margin-left:4px;">${pct}</span>
      </div>`;
  }).join('');
  return rows || '<i style="color:#64748b;">Sin datos suficientes.</i>';
}

function AT27_EP_render({puesto, counts, analyzed, years}){
  const panel = AT27_EP_getOrCreatePanel();
  panel.querySelector('#AT27_EP_selPuesto').value = puesto;
  panel.querySelector('#AT27_EP_legend').innerHTML = AT27_EP_renderLegend(counts, analyzed, years);
  panel.querySelector('#AT27_EP_totalBox').innerHTML = `Total secciones analizadas: <span>${analyzed}</span>`;
}

// Exportar PNG (mapa + lo que se vea encima)
async function AT27_EP_exportPNG(){
  const mapEl = (window.AT_CTX?.map?._container) || document.querySelector('.leaflet-container,#map,#mapid');
  if (!mapEl){ alert('No encontr√© el contenedor del mapa.'); return; }

  // Carga html2canvas si no est√°
  async function ensureHtml2Canvas(){
    if (window.html2canvas) return;
    await new Promise((resolve, reject)=>{
      const s=document.createElement('script');
      s.src='https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
      s.onload=resolve; s.onerror=()=>reject(new Error('No pude cargar html2canvas'));
      document.head.appendChild(s);
    });
  }

  try{
    await ensureHtml2Canvas();
    const canvas = await window.html2canvas(mapEl, {useCORS:true, backgroundColor:null, logging:false});
    const link = document.createElement('a');
    link.download = `estabilidad_${Date.now()}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
  }catch(e){
    console.error(e);
    alert('No pude exportar PNG (CORS o bloqueo de librer√≠a).');
  }
}

// API p√∫blica
async function AT27_EP_ejecutar(puestoInicial='A'){
  try{
    const panel = AT27_EP_getOrCreatePanel();
    const sel   = panel.querySelector('#AT27_EP_selPuesto');
    sel.value = puestoInicial;

    sel.onchange = async ()=>{
      const p = sel.value;
      const years = AT27_EP_yearsFor(p);
      const ids   = AT27_EP_getUniverseSecIds();
      if (!ids.length) return alert('No hay secciones en el universo actual.');
      const js    = await (window.loadPuesto ? loadPuesto(p) : getElectData(p));
      const { perSec, counts, analyzed } = AT27_EP_compute(js, ids, years);
      AT27_EP_buildOverlay(perSec, years);
      AT27_EP_render({puesto:p, counts, analyzed, years});
    };

    // primer render
    const p     = sel.value;
    const years = AT27_EP_yearsFor(p);
    const ids   = AT27_EP_getUniverseSecIds();
    if (!ids.length) return alert('No hay secciones en el universo actual.');
    const js    = await (window.loadPuesto ? loadPuesto(p) : getElectData(p));
    const { perSec, counts, analyzed } = AT27_EP_compute(js, ids, years);
    AT27_EP_buildOverlay(perSec, years);
    AT27_EP_render({puesto:p, counts, analyzed, years});
  }catch(e){
    console.error('AT27_EP_ejecutar error:', e);
    alert('No pude calcular la estabilidad pol√≠tica.');
  }
}
/* ====================== FIN upgrades ESTABILIDAD POL√çTICA ====================== */

</script>
<script>

    /* ========== GANAR TODO ¬∑ METAS DE PARTICIPACI√ìN 2027* (AT27_GT_META_) ========== */
    /* Universos desde AT_CTX.layer; datos con loadPuesto(puesto)
      Colorea por secci√≥n seg√∫n p2027* vs meta:
      - PASS (verde): p2027 ‚â• meta
      - NEAR (amarillo): 0 < meta - p2027 ‚â§ tolerancia
      - FAIL (rojo): p2027 < meta - tolerancia
      Panel con puesto, meta, tolerancia, opacidad, resumen y Top-20 brechas, export PNG. */

    const AT27_GT_META_PUESTOS = { A:'Ayuntamiento', DL:'Diputado Local', DF:'Diputado Federal', G:'Gobernador', S:'Senador', P:'Presidente' };
    const AT27_GT_META_COLS   = { PASS:'#22c55e', NEAR:'#f59e0b', FAIL:'#ef4444' };
    const AT27_GT_META_sec    = s => String(s??'').replace(/\D+/g,'');
    const AT27_GT_META_yearsFor = p => (['G','S','P'].includes(p) ? ['2018','2024'] : ['2018','2021','2024']);
    let   AT27_GT_META_FILL   = 0.45;  // opacidad overlay

    // -------- Helpers universo / datos --------
    function AT27_GT_META_getUniverseSecIds(){
      const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];
      const ids=[]; for (const f of feats){ const p=f.properties||{}; const id=AT27_GT_META_sec(p.ID??p.Seccion??p.SECCION??p.seccion??p.id); if(id) ids.push(id); }
      return [...new Set(ids)];
    }
    function AT27_GT_META_partPct(row){
      if (!row) return null;
      const ln = Number(row.LN||0); if (!ln) return null;
      let votos = (row.VOTOS!=null) ? Number(row.VOTOS||0) : 0;
      if (row.VOTOS==null){ for (const [k,v] of Object.entries(row)){ if (k!=='LN' && k!=='VOTOS') votos += Number(v||0); } }
      return Math.max(0, Math.min(100, (votos/ln)*100));
    }
    function AT27_GT_META_project2027(slot, puesto){
      const p18 = AT27_GT_META_partPct(slot['2018']);
      const p21 = AT27_GT_META_partPct(slot['2021']);
      const p24 = AT27_GT_META_partPct(slot['2024']);
      const vals = [p18,p21,p24].filter(v=>typeof v==='number'&&isFinite(v));
      if (vals.length===0) return null;

      if (['G','S','P'].includes(puesto)){
        const a = (typeof p18==='number')?p18:p24, b=(typeof p24==='number')?p24:p18;
        const slopePerYear = (b-a)/6;  // 2018‚Üí2024
        return Math.max(0, Math.min(100, b + 0.6*slopePerYear*3)); // conservador 60%
      }else{
        // 2018=0, 2021=3, 2024=6 ‚Üí 2027=9; pesos 1,1.5,2
        const pts=[]; if (typeof p18==='number') pts.push({t:0,y:p18,w:1.0}); if (typeof p21==='number') pts.push({t:3,y:p21,w:1.5}); if (typeof p24==='number') pts.push({t:6,y:p24,w:2.0});
        const W=pts.reduce((a,p)=>a+p.w,0), tbar=pts.reduce((a,p)=>a+p.w*p.t,0)/W, ybar=pts.reduce((a,p)=>a+p.w*p.y,0)/W;
        const num=pts.reduce((a,p)=>a+p.w*(p.t-tbar)*(p.y-ybar),0), den=pts.reduce((a,p)=>a+p.w*(p.t-tbar)*(p.t-tbar),0)||1e-9;
        const b1=num/den, b0=ybar-b1*tbar;
        return Math.max(0, Math.min(100, b0 + b1*9));
      }
    }
    function AT27_GT_META_winner(row){
      if (!row) return null;
      let best=null,max=-1; for (const [k,v] of Object.entries(row)){ if (k==='LN'||k==='VOTOS') continue; const vv=Number(v||0); if (vv>max){max=vv; best=k.toUpperCase();} }
      return best;
    }

    // -------- C√°lculo por secci√≥n --------
    function AT27_GT_META_compute(js, secIds, puesto, metaPct, tolPct){
      const perSec = {}; // sec -> {cat, p18,p21,p24,p27, delta}  (delta = p27 - meta)
      const counts = { PASS:0, NEAR:0, FAIL:0 };
      let lnW=0, p27W=0;  // promedio ponderado por LN (usamos LN 2024)

      for (const sec of secIds){
        const slot = js?.secciones?.[sec]; if (!slot) continue;
        const p27  = AT27_GT_META_project2027(slot, puesto);
        if (p27==null || !isFinite(p27)) continue;

        const p18 = AT27_GT_META_partPct(slot['2018']);
        const p21 = AT27_GT_META_partPct(slot['2021']);
        const p24 = AT27_GT_META_partPct(slot['2024']);

        const delta = p27 - metaPct; // + = sobre meta; - = falta
        let cat = 'PASS';
        if (delta < -tolPct) cat = 'FAIL';
        else if (delta < 0)  cat = 'NEAR';

        perSec[sec] = { cat, p18, p21, p24, p27, delta };

        counts[cat]++;
        const ln = Number((slot['2024']||{}).LN || 0); if (ln>0){ lnW += ln; p27W += p27*ln; }
      }
      const avg = lnW>0 ? (p27W/lnW) : NaN;
      return { perSec, counts, avg };
    }

    // -------- Overlay Leaflet --------
    function AT27_GT_META_clearOverlay(){
      const map = window.AT_CTX?.map || window.map; if (!map) return;
      if (window.AT27_GT_META_LAYER){ try{ map.removeLayer(AT27_GT_META_LAYER); }catch(_){ } window.AT27_GT_META_LAYER=null; }
    }
    function AT27_GT_META_buildOverlay(perSec){
      const map  = window.AT_CTX?.map || window.map;
      const base = window.AT_CTX?.layer?.toGeoJSON?.() || window.AT_DATA;
      if (!map || !base?.features) return;

      if (map.createPane && !map.getPane('at27_gt_meta_pane')){
        map.createPane('at27_gt_meta_pane');
        map.getPane('at27_gt_meta_pane').style.zIndex = 670;
        map.getPane('at27_gt_meta_pane').style.pointerEvents = 'auto'; // hover/click
      }

      const features = base.features.filter(f=>{
        const id = AT27_GT_META_sec(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
        return perSec[id]!=null;
      });
      const geo = { type:'FeatureCollection', features };

      const layer = L.geoJSON(geo, {
        pane: 'at27_gt_meta_pane',
        style: f=>{
          const id = AT27_GT_META_sec(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
          const col = AT27_GT_META_COLS[ perSec[id].cat ] || '#94a3b8';
          return { color:col, weight:1, opacity:.9, fillColor:col, fillOpacity:AT27_GT_META_FILL };
        },
        onEachFeature: (feature, lyr)=>{
          const id = AT27_GT_META_sec(feature.properties?.ID ?? feature.properties?.SECCION ?? feature.properties?.id);
          const info = perSec[id]; if (!info) return;
          const p = (x)=> (typeof x==='number' && isFinite(x)) ? x.toFixed(1)+'%' : '‚Äî';
          const deltaTxt = (info.delta>=0?'+':'') + (isFinite(info.delta)?info.delta.toFixed(1):'‚Äî') + ' pp';
          const has21 = info.p21!=null && isFinite(info.p21);
          const seq = has21
            ? `2018 ${p(info.p18)} ‚Üí 2021 ${p(info.p21)} ‚Üí 2024 ${p(info.p24)} ‚Üí <b>2027* ${p(info.p27)}</b>`
            : `2018 ${p(info.p18)} ‚Üí 2024 ${p(info.p24)} ‚Üí <b>2027* ${p(info.p27)}</b>`;
          lyr.bindTooltip(`<div style="font-size:12px;">${seq}<br>Œî vs meta: <b>${deltaTxt}</b></div>`, {sticky:true, opacity:0.95, direction:'top', className:'at27-tt'});
          // Click: si tienes manejador de secci√≥n, √∫salo
          lyr.on('click', ()=>{ if (typeof window.openSeccionPanel==='function'){ window.openSeccionPanel(id); } });
          lyr.on('mouseover', ()=> lyr.setStyle({weight:2}));
          lyr.on('mouseout',  ()=> lyr.setStyle({weight:1}));
        }
      });

      AT27_GT_META_clearOverlay();
      layer.addTo(map);
      window.AT27_GT_META_LAYER = layer;
    }
    function AT27_GT_META_updateOpacity(){
      if (window.AT27_GT_META_LAYER) window.AT27_GT_META_LAYER.setStyle({ fillOpacity: AT27_GT_META_FILL });
    }

    // -------- Panel UI --------
    function AT27_GT_META_getOrCreatePanel(){
      let panel = document.getElementById('AT27_GT_META_panel');
      if (panel) return panel;

      panel = document.createElement('div');
      panel.id = 'AT27_GT_META_panel';
      Object.assign(panel.style,{
        position:'fixed', right:'32px', top:'32px', zIndex:9999,
        width:'440px', background:'#fff', border:'1px solid #e5e7eb',
        borderRadius:'14px', boxShadow:'0 18px 40px rgba(0,0,0,.18)',
        overflow:'hidden', fontFamily:'system-ui, Segoe UI, Roboto, Arial',
        resize: 'both',
        minWidth: '360px',
        minHeight: '260px',
        display: 'flex',
        flexDirection: 'column'
      });
      panel.innerHTML = `
        <div id="AT27_GT_META_hdr" style="cursor:move; user-select:none; background:#dcfce7; color:#111; padding:10px 12px; display:flex; gap:10px; align-items:center;">
          <div style="font-weight:800;">Metas de participaci√≥n 2027*</div>
          <select id="AT27_GT_META_selPuesto" style="margin-left:auto;background:#fff;color:#111827;border-radius:8px;padding:4px 8px;border:none;outline:none;">
            ${Object.entries(AT27_GT_META_PUESTOS).map(([k,v])=>`<option value="${k}">${v}</option>`).join('')}
          </select>
          <button id="AT27_GT_META_close" title="Cerrar" style="background:transparent;color:#111;border:none;font-size:18px;cursor:pointer;">√ó</button>
        </div>
        <div id="AT27_GT_META_body" style="padding:12px 14px;">
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:10px;">
            <label style="display:flex;align-items:center;gap:8px;border:1px solid #e5e7eb;border-radius:10px;padding:8px;">
              <span style="font-size:12px;color:#334155;">Meta (%)</span>
              <input id="AT27_GT_META_meta" type="range" min="40" max="70" step="1" value="50" style="flex:1;">
              <span id="AT27_GT_META_meta_val" style="width:42px;text-align:right;font-variant-numeric:tabular-nums;">50%</span>
            </label>
            <label style="display:flex;align-items:center;gap:8px;border:1px solid #e5e7eb;border-radius:10px;padding:8px;">
              <span style="font-size:12px;color:#334155;">Tolerancia (pp)</span>
              <input id="AT27_GT_META_tol" type="range" min="0" max="5" step="0.5" value="3" style="flex:1;">
              <span id="AT27_GT_META_tol_val" style="width:42px;text-align:right;font-variant-numeric:tabular-nums;">3.0</span>
            </label>
          </div>
          <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
            <div style="font-size:12px;color:#334155;">Opacidad</div>
            <input id="AT27_GT_META_opacity" type="range" min="0.1" max="0.9" step="0.05" value="${AT27_GT_META_FILL}" style="flex:1;">
            <button id="AT27_GT_META_export" class="ttb-btn" style="margin-left:6px;">Exportar PNG</button>
          </div>

          <div id="AT27_GT_META_summary" style="font-size:13px;color:#334155;margin-bottom:10px;"></div>

          <div style="font-weight:700;margin-bottom:6px;">Leyenda</div>
          <div id="AT27_GT_META_legend" style="display:grid; grid-template-columns: 1fr; gap:6px; font-size:13px;"></div>

          <div style="font-weight:700;margin:10px 0 6px;">Top 20 ‚Äì Mayor brecha vs meta</div>
          <div id="AT27_GT_META_top" style="max-height:220px; overflow:auto; border:1px solid #f1f5f9;border-radius:10px;padding:8px;"></div>
        </div>
      `;
      document.body.appendChild(panel);

      panel.querySelector('#AT27_GT_META_close').onclick = ()=>{ AT27_GT_META_clearOverlay(); panel.remove(); };

      // drag
      (function drag(panel, handle){
        let sx=0, sy=0, ox=0, oy=0, dragging=false;
        handle.addEventListener('mousedown', e=>{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panel.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });
        window.addEventListener('mousemove', e=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panel.style.left=(ox+dx)+'px'; panel.style.top=(oy+dy)+'px'; panel.style.right='auto'; });
        window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; });
      })(panel, panel.querySelector('#AT27_GT_META_hdr'));

      // listeners del panel
      const selP = panel.querySelector('#AT27_GT_META_selPuesto');
      const meta = panel.querySelector('#AT27_GT_META_meta');
      const tol  = panel.querySelector('#AT27_GT_META_tol');
      const opa  = panel.querySelector('#AT27_GT_META_opacity');

      meta.addEventListener('input', ()=>{ panel.querySelector('#AT27_GT_META_meta_val').textContent = meta.value+'%'; AT27_GT_META_update(); });
      tol .addEventListener('input', ()=>{ panel.querySelector('#AT27_GT_META_tol_val').textContent  = Number(tol.value).toFixed(1); AT27_GT_META_update(); });
      opa .addEventListener('input', e=>{ AT27_GT_META_FILL = Number(e.target.value); AT27_GT_META_updateOpacity(); });
      panel.querySelector('#AT27_GT_META_export').addEventListener('click', AT27_GT_META_exportPNG);

      return panel;
    }

    // -------- Render --------
    function AT27_GT_META_render({puesto, metaPct, tolPct, counts, avg, total, worst}){
      const panel = AT27_GT_META_getOrCreatePanel();
      panel.querySelector('#AT27_GT_META_selPuesto').value = puesto;

      panel.querySelector('#AT27_GT_META_summary').innerHTML =
        `Universo: <b>${total}</b> secciones ¬∑ Puesto <b>${AT27_GT_META_PUESTOS[puesto]||puesto}</b> ¬∑ ` +
        `Meta: <b>${metaPct}%</b> ¬∑ Tolerancia: <b>${tolPct} pp</b><br>` +
        `Promedio proyectado 2027* (ponderado LN 2024): <b>${isFinite(avg)?avg.toFixed(1)+'%':'‚Äî'}</b>`;

      const pct = (n)=> total>0 ? ` (${(n*100/total).toFixed(1)}%)` : '';
      panel.querySelector('#AT27_GT_META_legend').innerHTML = `
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="width:12px;height:12px;border-radius:3px;background:${AT27_GT_META_COLS.PASS};border:1px solid rgba(0,0,0,.15)"></span>
          Cumple meta: <b>${counts.PASS}</b> <span style="color:#64748b;">${pct(counts.PASS)}</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="width:12px;height:12px;border-radius:3px;background:${AT27_GT_META_COLS.NEAR};border:1px solid rgba(0,0,0,.15)"></span>
          Cerca de meta (¬± ${tolPct} pp): <b>${counts.NEAR}</b> <span style="color:#64748b;">${pct(counts.NEAR)}</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="width:12px;height:12px;border-radius:3px;background:${AT27_GT_META_COLS.FAIL};border:1px solid rgba(0,0,0,.15)"></span>
          Debajo de meta: <b>${counts.FAIL}</b> <span style="color:#64748b;">${pct(counts.FAIL)}</span>
        </div>
      `;

      // Top 20 peores brechas
      const rows = worst.slice(0,20).map(w=>{
        const id = w.sec;
        const delta = (w.delta>=0?'+':'') + w.delta.toFixed(1) + ' pp';
        return `
          <div style="display:grid; grid-template-columns: 80px 1fr auto; gap:8px; padding:6px 4px; border-bottom:1px solid #f1f5f9;">
            <div style="color:#64748b;">Secci√≥n</div>
            <div style="font-variant-numeric:tabular-nums;"><b>${id}</b></div>
            <div style="text-align:right; ${w.delta<0?'color:#ef4444;':''}">${delta}</div>
            <div></div>
            <div style="color:#64748b;">p2027*</div>
            <div style="text-align:right; font-variant-numeric:tabular-nums;">${w.p27.toFixed(1)}%</div>
          </div>
        `;
      }).join('') || '<i style="color:#64748b;">Sin brechas (todas cumplen meta).</i>';
      panel.querySelector('#AT27_GT_META_top').innerHTML = rows;
    }

    // -------- Update loop --------
    async function AT27_GT_META_update(){
      const panel = AT27_GT_META_getOrCreatePanel();
      const selP = panel.querySelector('#AT27_GT_META_selPuesto');
      const meta = panel.querySelector('#AT27_GT_META_meta');
      const tol  = panel.querySelector('#AT27_GT_META_tol');

      const puesto  = selP.value;
      const metaPct = Number(meta.value);
      const tolPct  = Number(tol.value);

      const secIds = AT27_GT_META_getUniverseSecIds();
      if (!secIds.length) return alert('No hay secciones en el universo actual.');

      const js = await (window.loadPuesto ? loadPuesto(puesto) : getElectData(puesto));
      const { perSec, counts, avg } = AT27_GT_META_compute(js, secIds, puesto, metaPct, tolPct);

      // overlay
      AT27_GT_META_buildOverlay(perSec);

      // worst (solo las que NO cumplen)
      const worst = Object.entries(perSec)
        .filter(([_,v])=> v.cat!=='PASS')
        .map(([sec,v])=> ({sec, delta:v.delta, p27:v.p27}))
        .sort((a,b)=> (a.delta - b.delta)); // m√°s negativo primero

      AT27_GT_META_render({puesto, metaPct, tolPct, counts, avg, total:secIds.length, worst});
    }

    // -------- Export PNG --------
    async function AT27_GT_META_exportPNG(){
      const mapEl = (window.AT_CTX?.map?._container) || document.querySelector('.leaflet-container,#map,#mapid');
      if (!mapEl){ alert('No encontr√© el contenedor del mapa.'); return; }
      async function ensureHtml2Canvas(){
        if (window.html2canvas) return;
        await new Promise((resolve, reject)=>{
          const s=document.createElement('script');
          s.src='https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
          s.onload=resolve; s.onerror=()=>reject(new Error('No pude cargar html2canvas'));
          document.head.appendChild(s);
        });
      }
      try{
        await ensureHtml2Canvas();
        const canvas = await window.html2canvas(mapEl, {useCORS:true, backgroundColor:null, logging:false});
        const link = document.createElement('a');
        link.download = `meta_participacion_${Date.now()}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
      }catch(e){
        console.error(e);
        alert('No pude exportar PNG (CORS o bloqueo de librer√≠a).');
      }
    }

    // -------- API p√∫blica --------
    async function AT27_GT_META_ejecutar(puestoInicial='A', metaInicial=50, tolInicial=3){
      try{
        // crea panel e inicializa controles
        const panel = AT27_GT_META_getOrCreatePanel();
        const selP  = panel.querySelector('#AT27_GT_META_selPuesto');
        const meta  = panel.querySelector('#AT27_GT_META_meta');
        const tol   = panel.querySelector('#AT27_GT_META_tol');

        selP.value = puestoInicial;
        meta.value = String(metaInicial);
        tol.value  = String(tolInicial);
        panel.querySelector('#AT27_GT_META_meta_val').textContent = meta.value+'%';
        panel.querySelector('#AT27_GT_META_tol_val').textContent  = Number(tol.value).toFixed(1);

        // cambia puesto ‚Üí recalc
        selP.onchange = AT27_GT_META_update;

        // primer render
        await AT27_GT_META_update();

        // cerrar panel limpia overlay
        panel.querySelector('#AT27_GT_META_close').onclick = ()=>{ AT27_GT_META_clearOverlay(); panel.remove(); };
          }catch(e){
        console.error('AT27_GT_META_ejecutar error:', e);
        alert('No pude calcular las metas de participaci√≥n.');
      }
    }
    /* ======================== FIN ¬∑ METAS DE PARTICIPACI√ìN 2027* ======================== */


</script>

<script>
  // Debounce simple
  function atDebounce(fn, ms=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

  // Recalcula cuando el universo (capas visibles) cambia
  function AT27_GG_bindUniverseAutoRecalc(){
    const map = window.AT_CTX?.map || window.map;
    if (!map || map.__ggAuto) return;
    const recalc = atDebounce(()=>{
      // Si el panel est√° abierto, vuelve a ejecutar usando el universo actual
      if (document.getElementById('AT27_GG_panel')) AT27_GG_run();
    }, 300);
    map.on('layeradd', recalc);
    map.on('layerremove', recalc);
    map.__ggAuto = true;
  }
</script>

<script>
  /* ====== GANAR TODO ¬∑ ¬øQu√© se requiere para ganar todo? (AT27_GT_GANAR_) ====== */

    // Mapa secId -> layer (asegura existencia)
  window.AT27_GG_LAYERS_BY_SEC = window.AT27_GG_LAYERS_BY_SEC || {};
  window.AT27_GG_STATE = window.AT27_GG_STATE || { running:false, autorun:false };

  function atDebounce(fn, ms=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

  function AT27_GG_bindUniverseAutoRecalc(){
    const map = window.AT_CTX?.map || window.map;
    if (!map || map.__ggBound) return;
    const recalc = atDebounce(()=>{
      // Recalcula SOLO si ya corriste una vez y el panel est√° abierto
      if (!document.getElementById('AT27_GG_panel')) return;
      if (!window.AT27_GG_STATE.autorun) return;
      if (window.AT27_GG_STATE.running) return;
      AT27_GG_run();
    }, 350);
    map.on('layeradd', recalc);
    map.on('layerremove', recalc);
    map.__ggBound = true;
  }

const AT27_GG_sec = s => String(s??'').replace(/\D+/g,'');

  const AT27_GT_GANAR_PUESTOS = { A:'Ayuntamiento', DL:'Diputado Local', DF:'Diputado Federal' };
  const AT27_GT_GANAR_PARTIDOS = ['PAN','PRI','PVEM','MORENA'];
  const AT27_GT_GANAR_COLORS = {
    PAN:'#2563eb', PRI:'#dc2626', PVEM:'#16a34a', MORENA:'#7a1d1d',
    OTHER:'#94a3b8'
  };
  let AT27_GT_GANAR_FILL = 0.45;

  const AT27_GG_yearsFor = p => (['A','DL','DF'].includes(p) ? ['2018','2021','2024'] : ['2018','2024']); // por si acaso



  function AT27_GG_getUniverseSecIds(){
    const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];
    const ids=[]; for (const f of feats){ const p=f.properties||{}; const id=AT27_GG_sec(p.ID??p.Seccion??p.SECCION??p.seccion??p.id); if(id) ids.push(id); }
    return [...new Set(ids)];
  }

 function AT27_GG_partPct(row){
    if (!row) return null;
    const ln = Number(row.LN||0); if (!ln) return null;
    let votos = (row.VOTOS!=null) ? Number(row.VOTOS||0) : 0;
    if (row.VOTOS==null){ for (const [k,v] of Object.entries(row)){ if (k!=='LN' && k!=='VOTOS') votos += Number(v||0); } }
    return Math.max(0, Math.min(100, (votos/ln)*100));
  }
  function AT27_GG_project2027(slot, puesto){
    const p18 = AT27_GG_partPct(slot['2018']);
    const p21 = AT27_GG_partPct(slot['2021']);
    const p24 = AT27_GG_partPct(slot['2024']);
    const vals = [p18,p21,p24].filter(v=>typeof v==='number'&&isFinite(v));
    if (vals.length===0) return null;
    if (['G','S','P'].includes(puesto)){
      const a = (typeof p18==='number')?p18:p24, b=(typeof p24==='number')?p24:p18;
      const slopePerYear = (b-a)/6;
      return Math.max(0, Math.min(100, b + 0.6*slopePerYear*3));
    }else{
      const pts=[]; if (typeof p18==='number') pts.push({t:0,y:p18,w:1.0}); if (typeof p21==='number') pts.push({t:3,y:p21,w:1.5}); if (typeof p24==='number') pts.push({t:6,y:p24,w:2.0});
      const W=pts.reduce((a,p)=>a+p.w,0), tbar=pts.reduce((a,p)=>a+p.w*p.t,0)/W, ybar=pts.reduce((a,p)=>a+p.w*p.y,0)/W;
      const num=pts.reduce((a,p)=>a+p.w*(p.t-tbar)*(p.y-ybar),0), den=pts.reduce((a,p)=>a+p.w*(p.t-tbar)*(p.t-tbar),0)||1e-9;
      const b1=num/den, b0=ybar-b1*tbar;
      return Math.max(0, Math.min(100, b0 + b1*9));
    }
  }
  function AT27_GG_shares2024(row24){
    if (!row24) return { total:0, shares:{} };
    let total = (row24.VOTOS!=null) ? Number(row24.VOTOS||0) : 0;
    if (row24.VOTOS==null){ for (const [k,v] of Object.entries(row24)){ if (k!=='LN' && k!=='VOTOS') total += Number(v||0); } }
    const shares = {};
    if (total>0){
      for (const [k,v] of Object.entries(row24)){
        if (k==='LN'||k==='VOTOS') continue;
        shares[k.toUpperCase()] = Number(v||0)/total;
      }
    }
    return { total, shares };
  }


    /** Devuelve shares SOLO de PAN, PRI, PVEM, MORENA, renormalizados para sumar 1.
     *  Usa el helper robusto ya instalado (modo 'full' para tratar coaliciones).
     */
    function AT27_GG_shares2024_four(row24){
      const focus = ['PAN','PRI','PVEM','MORENA'];

      const { shares, total: tot24 } = AT27_GG_shares2024_four(row24);

      let sum = 0;
      focus.forEach(p => { sum += (shares[p]||0); });
      const out = {};
      if (sum > 0){
        focus.forEach(p => { out[p] = (shares[p]||0) / sum; });
      }else{
        // Si no hay info √∫til, regresa vac√≠os
        focus.forEach(p => { out[p] = 0; });
      }
      return { shares: out, total };
    }



  function AT27_GG_compute(js, secIds, puesto, partidoSel){
    const perSec = {};
    let votosTotalParaGanar = 0, swingTotal=0, ganadas=0;
    const X = partidoSel.toUpperCase();

    for (const sec of secIds){
      const slot = js?.secciones?.[sec]; if (!slot) continue;
      const p27 = AT27_GG_project2027(slot, puesto);
      const row24 = slot['2024'];
      if (p27==null || !row24) continue;

      const ln24 = Number(row24.LN||0);
      if (!ln24) continue;

      const Vproj = ln24 * (p27/100); // float, m√°s estable
      if (!isFinite(Vproj) || Vproj < 1) continue;

      const { shares, total: tot24 } = AT27_GG_shares2024_four(row24);

      if (!Object.keys(shares).length || !tot24) continue;

      // votos base 2027 por partido (manteniendo shares 2024) en float
      const vBase = {};
      for (const [sigla,sh] of Object.entries(shares)){
        vBase[sigla.toUpperCase()] = sh * Vproj;
      }

      // puntero y tu partido
      let L=null, vL=-1;
      for (const [sig, vv] of Object.entries(vBase)){ if (vv>vL){ vL=vv; L=sig; } }
      const vX = vBase[X] || 0;

      const faltanFloat = Math.max(0, (vL - vX) + 1);
      const swingFloat  = Math.max(0, faltanFloat / 2);

      perSec[AT27_GG_sec(sec)] = { winner:L, vL, vX, faltan:faltanFloat, swing:swingFloat, p27, Vproj };

      if (faltanFloat<=0 && L===X) ganadas++;
      votosTotalParaGanar += Math.ceil(faltanFloat);
      swingTotal         += Math.ceil(swingFloat);
    }

    return { perSec, resumen: { votosTotalParaGanar, swingTotal, ganadas, total:Object.keys(perSec).length } };
  }


  // ---------- Overlay ----------
    function AT27_GG_clearOverlay(){
      const map = window.AT_CTX?.map || window.map; if (!map) return;
      if (window.AT27_GG_LAYER){ try{ map.removeLayer(AT27_GG_LAYER); }catch(_){ } window.AT27_GG_LAYER=null; }
      window.AT27_GG_LAYERS_BY_SEC = {}; // reset √≠ndice de layers
    }

    function AT27_GG_buildOverlay(perSec){
      const map  = window.AT_CTX?.map || window.map;
      const base = window.AT_CTX?.layer?.toGeoJSON?.() || window.AT_DATA;
      if (!map || !base?.features) return;

      AT27_GG_clearOverlay(); // <- evita sobreponer capas

      if (map.createPane && !map.getPane('at27_gg_pane')){
        map.createPane('at27_gg_pane');
        const p = map.getPane('at27_gg_pane');
        p.style.zIndex = 675;
        p.style.pointerEvents = 'auto';
      }

      const features = base.features.filter(f=>{
        const id = AT27_GG_sec(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
        return perSec[id]!=null;
      });

      const layer = L.geoJSON({type:'FeatureCollection', features}, {
        pane:'at27_gg_pane',
        style: f=>{
          const id = AT27_GG_sec(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
          const win = perSec[id]?.winner || 'OTHER';
          const col = AT27_GT_GANAR_COLORS[win] || AT27_GT_GANAR_COLORS.OTHER;
          return { color:col, weight:1, opacity:.9, fillColor:col, fillOpacity:AT27_GT_GANAR_FILL };
        },
        onEachFeature: (feature, lyr)=>{
          const idRaw = feature.properties?.ID ?? feature.properties?.SECCION ?? feature.properties?.id;
          const id    = AT27_GG_sec(idRaw);
          // indexa con alias (141, 0141, etc.)
          [ id, id.padStart(4,'0'), String(Number(id)) ].forEach(k => { window.AT27_GG_LAYERS_BY_SEC[k] = lyr; });

          const info = perSec[id]; if (!info) return;
          const p = (x)=> isFinite(x) ? x.toFixed(1)+'%' : '‚Äî';
          const tip = `<div style="font-size:12px;">
            Secci√≥n <b>${id}</b><br>
            Proyecci√≥n 2027*: <b>${p(info.p27)}</b> ¬∑ Votos proj: <b>${Math.round(info.Vproj).toLocaleString()}</b><br>
            L√≠der: <b>${info.winner}</b> ${Math.round(info.vL).toLocaleString()} vs T√∫: <b>${Math.round(info.vX).toLocaleString()}</b><br>
            Faltan: <b>${Math.max(0, Math.ceil(info.faltan)).toLocaleString()}</b> ¬∑ Swing: <b>${Math.max(0, Math.ceil(info.swing)).toLocaleString()}</b>
          </div>`;
          lyr.bindTooltip(tip, { sticky:true, opacity:0.95, direction:'top', className:'at27-tt' });
          lyr.on('mouseover', ()=> lyr.setStyle({weight:2}));
          lyr.on('mouseout',  ()=> lyr.setStyle({weight:1}));
        }
      });

      layer.addTo(map);
      window.AT27_GG_LAYER = layer;
    }


  function AT27_GG_updateOpacity(){
    if (window.AT27_GG_LAYER) window.AT27_GG_LAYER.setStyle({ fillOpacity: AT27_GT_GANAR_FILL });
  }


  function AT27_GG_focusSection(sec){
    const base = AT27_GG_sec(sec);
    const dict = window.AT27_GG_LAYERS_BY_SEC || {};
    const candidates = [ base, base.padStart(4,'0'), String(Number(base)) ];
    let lyr = null;
    for (const k of candidates){ if (dict[k]) { lyr = dict[k]; break; } }

    const map = window.AT_CTX?.map || window.map;
    if (!map){ console.warn('No hay mapa'); return; }

    if (!lyr){
      // Fallback: buscar el feature en el universo y centrarlo
      const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];
      const feat = feats.find(f=>{
        const pid = AT27_GG_sec(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
        const cands = [ pid, pid.padStart(4,'0'), String(Number(pid)) ];
        return cands.some(x => candidates.includes(x));
      });
      if (feat){
        const tmp = L.geoJSON(feat);
        try{ map.fitBounds(tmp.getBounds(), {maxZoom:16, padding:[20,20]}); }catch(_){}
        return;
      }
      console.warn('No encontr√© layer ni feature para', base);
      return;
    }

    try{ map.fitBounds(lyr.getBounds(), { maxZoom:16, padding:[20,20] }); }catch(_){}
    if (lyr.openTooltip) lyr.openTooltip();

    // flash
    const orig = AT27_GT_GANAR_FILL;
    lyr.setStyle({ weight:3, fillOpacity:Math.min(0.9, orig+0.25) });
    if (lyr.bringToFront) lyr.bringToFront();
    setTimeout(()=> lyr.setStyle({ weight:1, fillOpacity:orig }), 1200);
  }


  // ---------- Panel ----------
  function AT27_GG_getOrCreatePanel(){
    let panel = document.getElementById('AT27_GG_panel');
    if (panel) return panel;

    panel = document.createElement('div');
    panel.id = 'AT27_GG_panel';
    Object.assign(panel.style,{
      position:'fixed', right:'24px', top:'24px', zIndex:9999,
      width: Math.min(480, window.innerWidth - 64) + 'px', background:'#fff',
      border:'1px solid #e5e7eb',
      maxWidth:  'calc(100vw - 48px)',
      maxHeight: 'calc(100vh - 48px)',
      borderRadius:'14px', boxShadow:'0 18px 40px rgba(0,0,0,.18)',
      height:'auto',
      overflow:'hidden', fontFamily:'system-ui, Segoe UI, Roboto, Arial',
      resize:'both', minWidth:'360px', minHeight:'300px', display:'flex',
      flexDirection:'column'
    });
    panel.innerHTML = `
      <div id="AT27_GG_hdr" style="cursor:move; user-select:none; background:#ffe4ef; color:#111; padding:10px 12px; display:flex; gap:10px; align-items:center;">
        <div style="font-weight:800;">¬øQu√© se requiere para ganar todo?</div>
        <button id="AT27_GG_close" title="Cerrar" style="margin-left:auto;background:transparent;color:#111;border:none;font-size:18px;cursor:pointer;">√ó</button>
      </div>
      <div id="AT27_GG_body" style="padding:12px 14px; flex:1; overflow:auto;">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
          <label style="display:flex;flex-direction:column;gap:6px;">
            <span style="font-size:12px;color:#334155;">Puesto</span>
            <select id="AT27_GG_selPuesto" style="background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:8px;">
              ${Object.entries(AT27_GT_GANAR_PUESTOS).map(([k,v])=>`<option value="${k}">${v}</option>`).join('')}
            </select>
          </label>
          <label style="display:flex;flex-direction:column;gap:6px;">
            <span style="font-size:12px;color:#334155;">Partido</span>
            <select id="AT27_GG_selPartido" style="background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:8px;">
              ${AT27_GT_GANAR_PARTIDOS.map(p=>`<option>${p}</option>`).join('')}
            </select>
          </label>
        </div>

        <div style="display:flex; align-items:center; gap:10px; margin:12px 0;">
          <div style="font-size:12px;color:#334155;">Opacidad</div>
          <input id="AT27_GG_opacity" type="range" min="0.1" max="0.9" step="0.05" value="${AT27_GT_GANAR_FILL}" style="flex:1;">
        </div>

        <button id="AT27_GG_run" class="ttb-btn ttb-primary" style="width:100%; background:#f4a3b9; border-color:#f4a3b9; color:#111; font-weight:700;">Ejecutar Consulta</button>

        <div id="AT27_GG_summary" style="margin-top:10px; font-size:13px; color:#334155;"></div>

        <div style="margin-top:10px; border:1px solid #f1f5f9; border-radius:10px; overflow:hidden;">
          <table style="width:100%; border-collapse:collapse; font-size:13px;">
            <thead style="background:#f8fafc;">
              <tr>
                <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">Secci√≥n</th>
                <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">Partido Ganador</th>
                <th style="text-align:right; padding:8px; border-bottom:1px solid #e5e7eb;">Votos</th>
                <th style="text-align:right; padding:8px; border-bottom:1px solid #e5e7eb;">Faltan</th>
              </tr>
            </thead>
            <tbody id="AT27_GG_tbody"></tbody>
          </table>
        </div>
      </div>
    `;
    document.body.appendChild(panel);

    function clampToViewport(el){
      const vw = window.innerWidth, vh = window.innerHeight;
      const r = el.getBoundingClientRect();
      let left = r.left, top = r.top;
      if (r.right  > vw - 16) left -= (r.right  - (vw - 16));
      if (r.bottom > vh - 16) top  -= (r.bottom - (vh - 16));
      if (left < 16) left = 16;
      if (top  < 16) top  = 16;
      el.style.left = left + 'px';
      el.style.top  = top  + 'px';
      el.style.right = 'auto';
    }
    clampToViewport(panel);
    window.addEventListener('resize', ()=>clampToViewport(panel));


    panel.querySelector('#AT27_GG_close').onclick = ()=>{ AT27_GG_clearOverlay(); panel.remove(); };

    // drag
    (function drag(panel, handle){
      let sx=0, sy=0, ox=0, oy=0, dragging=false;
      handle.addEventListener('mousedown', e=>{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panel.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });
      window.addEventListener('mousemove', e=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panel.style.left=(ox+dx)+'px'; panel.style.top=(oy+dy)+'px'; panel.style.right='auto'; });
      window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; });
    })(panel, panel.querySelector('#AT27_GG_hdr'));

    // listeners
    panel.querySelector('#AT27_GG_opacity').addEventListener('input', e=>{ AT27_GT_GANAR_FILL = Number(e.target.value); AT27_GG_updateOpacity(); });

    return panel;
  }

    // ---------- Render tabla + resumen ----------
    function AT27_GG_renderTabla(perSec, partidoSel){
      const tb = document.getElementById('AT27_GG_tbody');
      const party = partidoSel.toUpperCase();

      const rows = Object.entries(perSec).map(([sec, info])=>{
        return { sec: AT27_GG_sec(sec), winner: info.winner, vL: info.vL, faltan: Math.ceil(info.faltan) };
      }).sort((a,b)=> (a.faltan - b.faltan) || (Number(a.sec) - Number(b.sec)));

      tb.innerHTML = rows.map(r=>{
        const isWin  = (r.faltan<=0 && r.winner===party);
        const isLose = (r.winner!==party);
        const bg = isWin ? '#dcfce7' : (isLose ? '#fee2e2' : '');
        return `
          <tr data-sec="${AT27_GG_sec(r.sec)}" style="${bg?`background:${bg};`:''} cursor:pointer;">
            <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;">${r.sec}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;">${r.winner}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;">${Math.round(r.vL).toLocaleString()}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right; ${r.faltan>0?'color:#dc2626;':''}">${r.faltan>0 ? r.faltan.toLocaleString() : '0'}</td>
          </tr>
        `;
      }).join('');

      // Delegaci√≥n: un solo listener, aunque repintes la tabla
      tb.onclick = (e)=>{
        const tr = e.target.closest('tr[data-sec]');
        if (!tr) return;
        const sec = tr.getAttribute('data-sec');
        AT27_GG_focusSection(sec);
      };
    }


  function AT27_GG_renderResumen(resumen, partidoSel){
    const el = document.getElementById('AT27_GG_summary');
    el.innerHTML = `
      <div><b>Partido:</b> ${partidoSel}</div>
      <div style="display:flex; gap:12px; flex-wrap:wrap; margin-top:6px;">
        <span>Secciones ya ganadas: <b>${resumen.ganadas}</b> / ${resumen.total}</span>
        <span>Votos para ganar todo: <b>${resumen.votosTotalParaGanar.toLocaleString()}</b></span>
        <span>Swing total (equivalente): <b>${resumen.swingTotal.toLocaleString()}</b></span>
      </div>
    `;
  }

  // ---------- Update (recalcular) ----------
  async function AT27_GG_run(){
    if (window.AT27_GG_STATE.running) return;
    window.AT27_GG_STATE.running = true;
    try{
      const panel   = AT27_GG_getOrCreatePanel();
      const puesto  = panel.querySelector('#AT27_GG_selPuesto').value;
      const partido = panel.querySelector('#AT27_GG_selPartido').value;

      const secIds = AT27_GG_getUniverseSecIds();
      if (!secIds.length){
        AT27_GG_clearOverlay();
        document.getElementById('AT27_GG_tbody').innerHTML = '';
        document.getElementById('AT27_GG_summary').innerHTML = 'Sin secciones en el universo actual.';
        return;
      }

      const js = await (window.loadPuesto ? loadPuesto(puesto) : getElectData(puesto));
      const { perSec, resumen } = AT27_GG_compute(js, secIds, puesto, partido);

      AT27_GG_buildOverlay(perSec);            // 1) pinta y reindexa
      AT27_GG_renderResumen(resumen, partido); // 2) resumen
      AT27_GG_renderTabla(perSec, partido);    // 3) tabla (usa √≠ndice ya listo)
    }catch(e){
      console.error('AT27_GG_run error:', e);
      alert('No pude ejecutar la consulta de Ganar Todo.');
    }finally{
      window.AT27_GG_STATE.running = false;
    }
  }


  // ---------- API p√∫blica ----------
  async function AT27_GT_GANAR_ejecutar(puestoInicial='A', partidoInicial='PAN'){
    const panel = AT27_GG_getOrCreatePanel();
    panel.querySelector('#AT27_GG_selPuesto').value  = puestoInicial;
    panel.querySelector('#AT27_GG_selPartido').value = partidoInicial;

    // Ejecuta SOLO al presionar el bot√≥n
    panel.querySelector('#AT27_GG_run').onclick = ()=>{
      window.AT27_GG_STATE.autorun = true; // desde ahora, si cambias universo, recalc
      AT27_GG_run();
    };

    // Cambiar selects NO ejecuta autom√°ticamente (t√∫ decides con el bot√≥n)
    panel.querySelector('#AT27_GG_selPuesto').onchange  = ()=>{};
    panel.querySelector('#AT27_GG_selPartido').onchange = ()=>{};

    AT27_GG_bindUniverseAutoRecalc();
  }

  /* ======================= FIN ¬∑ GANAR TODO / GANAR TODO ======================= */
</script>

<script>
    // Centra el mapa al universo actual (overlay o capa base)
    function AT27_fitUniverseBounds(paddingPx = 24){
      const map = window.AT_CTX?.map || window.map;
      if (!map) return;

      // 1) Si hay overlay (ej. capas pintadas), √∫salo
      const candidates = [];
      if (window.AT27_GG_LAYER?.getBounds) candidates.push(window.AT27_GG_LAYER.getBounds());
      if (window.AT27_EP_LAYER?.getBounds) candidates.push(window.AT27_EP_LAYER.getBounds()); // (si tienes Estabilidad)
      if (window.AT27_PART_LAYER?.getBounds) candidates.push(window.AT27_PART_LAYER.getBounds()); // (si tienes Participaci√≥n)

      // 2) La capa de universo visible (AT_CTX.layer)
      const baseLayer = window.AT_CTX?.layer;
      if (baseLayer?.getBounds) candidates.push(baseLayer.getBounds());

      // 3) Fallback: calcula bounds desde GeoJSON de universo
      if (!candidates.length){
        const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];
        if (feats.length){
          const tmp = L.geoJSON({type:'FeatureCollection', features:feats});
          candidates.push(tmp.getBounds());
          // no a√±adimos tmp al mapa, solo usamos sus bounds
        }
      }

      // Unir bounds y centrar
      let union = null;
      for (const b of candidates){
        if (!b || !b.isValid()) continue;
        union = union ? union.extend(b) : L.latLngBounds(b.getSouthWest(), b.getNorthEast());
      }
      if (union && union.isValid()){
        map.fitBounds(union, { padding:[paddingPx, paddingPx] });
        requestAnimationFrame(()=> AT27_flashOverlay());

      }
    }
</script>

  <script>
  function AT27__eachPath(layer, fn){
    if (!layer) return;
    if (layer.eachLayer) layer.eachLayer(l => AT27__eachPath(l, fn));
    else if (layer.setStyle) fn(layer);
  }

  // Resalta brevemente los pol√≠gonos del overlay (o la capa base si no hay overlay)
  function AT27_flashOverlay(duration=900){
    const overlays = [
      window.AT27_GG_LAYER,   // Ganar Todo
      window.AT27_EP_LAYER,   // Estabilidad (si la tienes)
      window.AT27_PART_LAYER  // Participaci√≥n (si la tienes)
    ].filter(Boolean);

    // Si no hay overlay, ‚Äúflashea‚Äù el universo base
    if (!overlays.length && window.AT_CTX?.layer) overlays.push(window.AT_CTX.layer);

    overlays.forEach(g=>{
      AT27__eachPath(g, (lyr)=>{
        const origW  = (lyr.options && lyr.options.weight) || 1;
        const origFO = (lyr.options && typeof lyr.options.fillOpacity==='number') ? lyr.options.fillOpacity : 0.35;
        try{
          lyr.setStyle({ weight: origW + 2, fillOpacity: Math.min(0.95, origFO + 0.25) });
          setTimeout(()=> lyr.setStyle({ weight: origW, fillOpacity: origFO }), duration);
        }catch(_){}
      });
    });
  }
</script>

<script>
    // =======================================================
    //  GENIALIDAD #1  ¬∑ PROBABILIDAD DE VOLTEAR 2027
    //  Panel con pesos (margen 2024, tendencia de participaci√≥n, estabilidad),
    //  mapa verde/amarillo/rojo por puntaje, tabla ordenable y clic‚Üízoom.
    //  Requiere: loadPuesto(puesto) o getElectData(puesto), AT_CTX.map/layer
    //  y (si existe) AT27_GG_getUniverseSecIds(). Colores partidos est√°ndar.
    // =======================================================

    /* ====== Estado y constantes ====== */
    window.AT27_PV_STATE  = window.AT27_PV_STATE  || { autorun:false, running:false };
    window.AT27_PV_LAYERS = window.AT27_PV_LAYERS || {};   // sec -> layer
    window.AT27_PV_LAYER  = window.AT27_PV_LAYER  || null;

    const AT27_PV_COLORS = { ALTA:'#22c55e', MEDIA:'#f59e0b', BAJA:'#ef4444' }; // verde, amarillo, rojo
    const AT27_PARTY_COLORS = { PAN:'#2563eb', PRI:'#ef4444', PVEM:'#16a34a', MORENA:'#7f1d1d', OTROS:'#6b7280' };

    /* ====== Utilidades ====== */
    const clamp = (x, a, b)=> Math.min(b, Math.max(a, x));
    const fmtpp = (x)=>{
            if (x === null || x === undefined) return '‚Äî';
            const n = Number(x);
            return Number.isFinite(n) ? ((n>0?'+':'') + n.toFixed(1) + ' pp') : '‚Äî';
          };

    const fmt   = (x)=> isFinite(x)? Math.round(x).toLocaleString() : '‚Äî';
    const sec4  = (s)=> String(s||'').replace(/\D+/g,'').padStart(4,'0');

    function AT27_PV_getUniverseSecIds(){
      if (typeof AT27_GG_getUniverseSecIds==='function') return AT27_GG_getUniverseSecIds();
      const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];
      return feats.map(f=> sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id));
    }
    async function AT27_PV_load(p){ return (window.loadPuesto? loadPuesto(p) : getElectData(p)); }

    /* ====== M√©tricas ====== */
    // participaci√≥n (%) del a√±o (usa VV / LN). Si falta VOTOS, suma partidos.
    function partPct(row){
      if (!row) return null;
      const ln = Number(row.LN||0); if (!ln) return null;
      let vv = (row.VOTOS!=null)? Number(row.VOTOS||0) : 0;
      if (row.VOTOS==null){ for (const [k,v] of Object.entries(row)){ if (k!=='LN' && k!=='VOTOS') vv += Number(v||0); } }
      return clamp((vv/ln)*100, 0, 100);
    }
    // margen vs PARTIDO en 2024, en puntos porcentuales (l√≠der ‚àí partido)
    function marginVsPartyPP(row24, partido){
      if (!row24) return null;
      let vv = (row24.VOTOS!=null)? Number(row24.VOTOS||0) : 0;
      if (row24.VOTOS==null){ for (const [k,v] of Object.entries(row24)){ if (k!=='LN' && k!=='VOTOS') vv += Number(v||0); } }
      const votes = {};
      for (const [k,v] of Object.entries(row24)){
        if (k==='LN'||k==='VOTOS') continue;
        votes[k.toUpperCase()] = Number(v||0);
      }
      const vX = votes[partido] || 0;
      let vL = -1, L=null;
      for (const [sig, val] of Object.entries(votes)){ if (val>vL){ vL=val; L=sig; } }
      if (vv<=0) return null;
      return ((vL - vX) / vv) * 100; // puede ser 0 si ya gana ese partido
    }
    // estabilidad 2018-2024: devuelve categor√≠a y score invertido (0/50/100)
    function stabilityCat(slot){
      const g = ['2018','2021','2024'].map(y=>{
        const row = slot?.[y]; if (!row) return null;
        // ganador por votos  (si falta VOTOS se suma)
        let vv = (row.VOTOS!=null)? Number(row.VOTOS||0) : 0;
        if (row.VOTOS==null){ for (const [k,v] of Object.entries(row)){ if (k!=='LN' && k!=='VOTOS') vv += Number(v||0); } }
        let vL = -1, L=null;
        for (const [k,v] of Object.entries(row)){
          if (k==='LN'||k==='VOTOS') continue;
          const z = Number(v||0);
          if (z>vL){ vL=z; L=k.toUpperCase(); }
        }
        return L;
      }).filter(Boolean);
      const uniq = Array.from(new Set(g)).length;
      if (uniq<=1) return { cat:'Alta',  invScore:0 };
      if (uniq==2) return { cat:'Media', invScore:50 };
      return { cat:'Baja', invScore:100 };
    }
    // normaliza Œî participaci√≥n 18‚Üí24 a 0..100 (‚àí15‚Üí0, 0‚Üí50, +15‚Üí100)
    function trendScore(slot){
      const p18 = partPct(slot?.['2018']);
      const p24 = partPct(slot?.['2024']);
      if (p18==null || p24==null) return 50; // neutro si faltan datos
      const delta = clamp(p24 - p18, -15, 15);
      return ((delta + 15) / 30) * 100;
    }
    // score de ‚Äúvolteabilidad‚Äù (0..100): margen invertido, tendencia, inestabilidad
    function flipScore(slot, partido){
      const row24 = slot?.['2024'];
      const mpp = marginVsPartyPP(row24, partido);           // pp contra el l√≠der
      const stab = stabilityCat(slot);                       // Alta/Media/Baja
      const tsc = trendScore(slot);                          // 0..100
      // margen invertido: 0pp ‚Üí100; 20+pp ‚Üí0
      const mInv = (mpp==null)? 50 : clamp( (20 - clamp(mpp,0,20)) / 20 * 100, 0, 100 );

      // pesos desde UI
      const w1 = Number(document.getElementById('AT27_PV_w_margen')?.value || 50);
      const w2 = Number(document.getElementById('AT27_PV_w_trend')?.value  || 30);
      const w3 = Number(document.getElementById('AT27_PV_w_stab')?.value   || 20);
      const W  = (w1+w2+w3) || 1;

      const score = (w1*mInv + w2*tsc + w3*stab.invScore) / W;
      return { score, mpp, trend: (partPct(slot?.['2024'])??0) - (partPct(slot?.['2018'])??0), stabCat: stab.cat };
    }
    function classFromScore(s){ return s>=70? 'ALTA' : (s>=40? 'MEDIA' : 'BAJA'); }

    /* ====== Overlay ====== */
    function AT27_PV_clear(){
      const map = window.AT_CTX?.map || window.map;
      if (!map) return;
      if (window.AT27_PV_LAYER){ try{ map.removeLayer(AT27_PV_LAYER); }catch(_){} window.AT27_PV_LAYER=null; }
      window.AT27_PV_LAYERS = {};
    }
    function AT27_PV_build(perSec, partido){
      const map  = window.AT_CTX?.map || window.map;
      const base = window.AT_CTX?.layer?.toGeoJSON?.() || window.AT_DATA;
      if (!map || !base?.features) return;

      AT27_PV_clear();

      if (map.createPane && !map.getPane('at27_pv_pane')){
        map.createPane('at27_pv_pane');
        const p = map.getPane('at27_pv_pane');
        p.style.zIndex = 680; p.style.pointerEvents='auto';
      }

      const features = base.features.filter(f=>{
        const id = sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
        return perSec[id]!=null;
      });

      const layer = L.geoJSON({type:'FeatureCollection', features}, {
        pane:'at27_pv_pane',
        style: f=>{
          const id = sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
          const cls = perSec[id]?.cls || 'BAJA';
          const col = AT27_PV_COLORS[cls] || '#999';
          return { color: col, weight:1, opacity:.9, fillColor: col, fillOpacity:.35 };
        },
        onEachFeature: (feature, lyr)=>{
          const id = sec4(feature.properties?.ID ?? feature.properties?.SECCION ?? feature.properties?.id);
          window.AT27_PV_LAYERS[id] = lyr;

          const info = perSec[id]; if (!info) return;
          const tip = `
            <div style="font-size:12px;">
              Secci√≥n <b>${id}</b><br>
              Partido analizado: <b>${partido}</b><br>
              Margen vs ${partido} (2024): <b>${fmtpp(info.mpp)}</b><br>
              Œî participaci√≥n 2018‚Üí2024: <b>${fmtpp(info.trend)}</b><br>
              Estabilidad: <b>${info.stabCat}</b><br>
              <span style="opacity:.8">Puntaje:</span> <b>${info.score.toFixed(0)}/100</b>
            </div>`;
          lyr.bindTooltip(tip, {sticky:true, opacity:.95, direction:'top', className:'at27-tt'});
          lyr.on('mouseover', ()=>lyr.setStyle({weight:2}));
          lyr.on('mouseout',  ()=>lyr.setStyle({weight:1}));
        }
      });

      layer.addTo(map);
      window.AT27_PV_LAYER = layer;
    }

    /* ====== Tabla y resumen ====== */
    function AT27_PV_renderTabla(perSec){
      const tb = document.getElementById('AT27_PV_tbody');
      const rows = Object.entries(perSec).map(([sec,info])=>({sec, ...info}))
        .sort((a,b)=> b.score - a.score || Number(a.sec)-Number(b.sec));

      tb.innerHTML = rows.map(r=>{
        const bg = r.cls==='ALTA' ? '#dcfce7' : (r.cls==='MEDIA' ? '#fef9c3' : '#fee2e2');
        return `
          <tr data-sec="${r.sec}" style="background:${bg}; cursor:pointer;">
            <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;">${r.sec}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;">${Number.isFinite(r.score) ? r.score.toFixed(0) : '‚Äî'}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;">${r.cls}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;">${fmtpp(r.mpp)}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;">${fmtpp(r.trend)}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;">${r.stabCat}</td>
          </tr>
        `;
      }).join('');

      tb.onclick = (e)=>{
        const tr = e.target.closest('tr[data-sec]'); if (!tr) return;
        AT27_PV_focus(tr.getAttribute('data-sec'));
      };
    }
    function AT27_PV_focus(sec){
      const id = sec4(sec);
      const lyr = window.AT27_PV_LAYERS[id];
      const map = window.AT_CTX?.map || window.map;
      if (!map) return;
      if (lyr){
        try{ map.fitBounds(lyr.getBounds(), {maxZoom:16, padding:[20,20]}); }catch(_){}
        if (lyr.openTooltip) lyr.openTooltip();
        const origFO = lyr.options.fillOpacity ?? .35;
        lyr.setStyle({weight:3, fillOpacity: Math.min(.95, origFO+.25)});
        setTimeout(()=> lyr.setStyle({weight:1, fillOpacity: origFO}), 900);
        return;
      }
      // fallback: por si no est√° indexado
      const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];
      const f = feats.find(ft=> sec4(ft.properties?.ID ?? ft.properties?.SECCION ?? ft.properties?.id)===id);
      if (f){ const tmp=L.geoJSON(f); map.fitBounds(tmp.getBounds(), {maxZoom:16, padding:[20,20]}); }
    }
    function AT27_PV_renderResumen(counts, total){
      const el = document.getElementById('AT27_PV_summary');
      const pct = (n)=> total? ((n/total)*100).toFixed(1)+'%' : '‚Äî';
      el.innerHTML = `
        <div style="font-size:12px; line-height:1.3;">
          <div><span style="display:inline-block;width:10px;height:10px;background:${AT27_PV_COLORS.ALTA};border-radius:2px;"></span> Alta: <b>${counts.ALTA}</b> (${pct(counts.ALTA)})</div>
          <div><span style="display:inline-block;width:10px;height:10px;background:${AT27_PV_COLORS.MEDIA};border-radius:2px;"></span> Media: <b>${counts.MEDIA}</b> (${pct(counts.MEDIA)})</div>
          <div><span style="display:inline-block;width:10px;height:10px;background:${AT27_PV_COLORS.BAJA};border-radius:2px;"></span> Baja: <b>${counts.BAJA}</b> (${pct(counts.BAJA)})</div>
          <div style="margin-top:6px;"><b>Total secciones:</b> ${total}</div>
        </div>`;
    }

    /* ====== RUN principal ====== */
    async function AT27_PV_run(){
      if (window.AT27_PV_STATE.running) return;
      window.AT27_PV_STATE.running = true;
      try{
        const puesto  = document.getElementById('AT27_PV_selPuesto').value;
        const partido = document.getElementById('AT27_PV_selPartido').value.toUpperCase();

        const secIds = AT27_PV_getUniverseSecIds();
        if (!secIds.length){ AT27_PV_clear(); document.getElementById('AT27_PV_tbody').innerHTML=''; return; }

        const js = await AT27_PV_load(puesto);

        const perSec = {};
        for (const sec of secIds){
          const slot = js?.secciones?.[sec4(sec)];
          if (!slot) continue;
          const met = flipScore(slot, partido); // {score, mpp, trend, stabCat}
          const cls = classFromScore(met.score);
          perSec[sec4(sec)] = { ...met, cls };
        }

        // contar
        const total = Object.keys(perSec).length;
        const counts = { ALTA:0, MEDIA:0, BAJA:0 };
        Object.values(perSec).forEach(x=> counts[x.cls]++);

        // pintar
        AT27_PV_build(perSec, partido);
        AT27_PV_renderResumen(counts, total);
        AT27_PV_renderTabla(perSec);

      }catch(e){
        console.error('AT27_PV_run', e);
        alert('No pude ejecutar ‚ÄúProbabilidad de voltear 2027‚Äù.');
      }finally{
        window.AT27_PV_STATE.running = false;
      }
    }

    /* ====== Panel UI ====== */
    function AT27_PV_open(){
      let panel = document.getElementById('AT27_PV_panel');
      if (panel){ panel.style.display='block'; return; }

      panel = document.createElement('div');
      panel.id = 'AT27_PV_panel';
      Object.assign(panel.style,{
        position:'fixed', right:'20px', top:'20px', zIndex:9998,
        width:'520px', maxWidth:'calc(100vw - 40px)', maxHeight:'calc(100vh - 40px)',
        background:'#fff', border:'1px solid #e5e7eb', borderRadius:'14px',
        boxShadow:'0 18px 40px rgba(0,0,0,.18)', display:'flex', flexDirection:'column',
        overflow:'hidden', resize:'both', minWidth:'380px', minHeight:'280px'
      });
      panel.innerHTML = `
        <div id="AT27_PV_hdr" style="cursor:move; user-select:none; background:#eef2ff; color:#111; padding:10px 12px; display:flex; gap:10px; align-items:center;">
          <div style="font-weight:800;">Probabilidad de voltear 2027</div>
          <button id="AT27_PV_center" style="margin-left:auto; background:#eef2ff; border:1px solid #c7d2fe; border-radius:8px; padding:4px 8px; cursor:pointer;">Recentrar</button>
          <button id="AT27_PV_close" title="Cerrar" style="background:transparent;border:none;font-size:18px;cursor:pointer;">√ó</button>
        </div>
        <div style="padding:10px 12px; display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:end;">
          <label style="font-size:12px;">Puesto<br>
            <select id="AT27_PV_selPuesto" class="ttb-select" style="width:100%;">
              <option value="A">Ayuntamiento</option>
              <option value="DL">Diputado Local</option>
              <option value="DF">Diputado Federal</option>
            </select>
          </label>
          <label style="font-size:12px;">Partido<br>
            <select id="AT27_PV_selPartido" class="ttb-select" style="width:100%;">
              <option>PAN</option><option>PRI</option><option>PVEM</option><option>MORENA</option>
            </select>
          </label>

          <label style="grid-column:1 / span 2; font-size:12px;">Peso: margen 2024 (invertido) <span id="AT27_PV_lbl_margen" style="opacity:.7;">50</span>
            <input id="AT27_PV_w_margen" type="range" min="0" max="100" value="50" style="width:100%;">
          </label>
          <label style="grid-column:1 / span 2; font-size:12px;">Peso: cambio de participaci√≥n 2018‚Üí2024 <span id="AT27_PV_lbl_trend" style="opacity:.7;">30</span>
            <input id="AT27_PV_w_trend"  type="range" min="0" max="100" value="30" style="width:100%;">
          </label>
          <label style="grid-column:1 / span 2; font-size:12px;">Peso: inestabilidad pol√≠tica <span id="AT27_PV_lbl_stab" style="opacity:.7;">20</span>
            <input id="AT27_PV_w_stab"   type="range" min="0" max="100" value="20" style="width:100%;">
          </label>

          <button id="AT27_PV_run" class="ttb-btn ttb-primary" style="grid-column:1 / span 2;">Ejecutar</button>
        </div>

        <div style="padding:8px 12px;">
          <div id="AT27_PV_legend" style="font-size:12px; display:flex; gap:12px; align-items:center; margin-bottom:6px;">
            <span><span style="display:inline-block;width:10px;height:10px;background:${AT27_PV_COLORS.ALTA};border-radius:2px;"></span> Alta</span>
            <span><span style="display:inline-block;width:10px;height:10px;background:${AT27_PV_COLORS.MEDIA};border-radius:2px;"></span> Media</span>
            <span><span style="display:inline-block;width:10px;height:10px;background:${AT27_PV_COLORS.BAJA};border-radius:2px;"></span> Baja</span>
          </div>
          <div id="AT27_PV_summary" style="font-size:12px; color:#334155;"></div>
        </div>

        <div style="flex:1; overflow:auto;">
          <table style="width:100%; border-collapse:collapse; font-size:12px;">
            <thead>
              <tr style="position:sticky; top:0; background:#f8fafc;">
                <th style="text-align:left; padding:6px 8px; border-bottom:1px solid #e2e8f0;">Secci√≥n</th>
                <th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;">Puntaje</th>
                <th style="text-align:left; padding:6px 8px; border-bottom:1px solid #e2e8f0;">Clase</th>
                <th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;">Margen vs partido</th>
                <th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;">Œî participaci√≥n</th>
                <th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;">Estabilidad</th>
              </tr>
            </thead>
            <tbody id="AT27_PV_tbody"></tbody>
          </table>
        </div>
      `;
      document.body.appendChild(panel);

      // wiring UI
      const $$ = id=> panel.querySelector(id);
      $$('#AT27_PV_close').onclick  = ()=> panel.style.display='none';
      $$('#AT27_PV_center').onclick = ()=> (window.AT27_fitUniverseBounds? AT27_fitUniverseBounds() : null);
      $$('#AT27_PV_run').onclick    = ()=>{ window.AT27_PV_STATE.autorun = true; AT27_PV_run(); };

      // sliders labels
      const upd = ()=>{ $$('#AT27_PV_lbl_margen').textContent=$$('#AT27_PV_w_margen').value;
                        $$('#AT27_PV_lbl_trend').textContent =$$('#AT27_PV_w_trend').value;
                        $$('#AT27_PV_lbl_stab').textContent  =$$('#AT27_PV_w_stab').value; };
      ['AT27_PV_w_margen','AT27_PV_w_trend','AT27_PV_w_stab'].forEach(id=> $$('#'+id).addEventListener('input', upd)); upd();

      // draggability
      (function drag(panelEl, handleEl){
        let sx=0, sy=0, ox=0, oy=0, dragging=false;
        handleEl.addEventListener('mousedown', e=>{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panelEl.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });
        window.addEventListener('mousemove', e=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panelEl.style.left=(ox+dx)+'px'; panelEl.style.top=(oy+dy)+'px'; panelEl.style.right='auto'; });
        window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; });
      })(panel, panel.querySelector('#AT27_PV_hdr'));

      // evitar que tape al mapa
      if (window.L && L.DomEvent){ L.DomEvent.disableClickPropagation(panel); L.DomEvent.disableScrollPropagation(panel); }

      // rec√°lculo autom√°tico si cambias el universo (despu√©s del primer Run)
      const map = window.AT_CTX?.map || window.map;
      if (map && !map.__pvBound){
        const deb = (fn,ms=300)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
        map.on('layeradd',    deb(()=>{ if (window.AT27_PV_STATE.autorun) AT27_PV_run(); }, 350));
        map.on('layerremove', deb(()=>{ if (window.AT27_PV_STATE.autorun) AT27_PV_run(); }, 350));
        map.__pvBound = true;
      }
    }


</script>

  <script>
// =======================================================
//  GENIALIDAD #2 ¬∑ M√çNIMO DE VOTOS PARA MAYOR√çA (por DF/DL/Mpio)
//  Usa la l√≠nea base 2027 (misma que ‚ÄúGanar todo‚Äù) y ordena por ‚Äúfaltan‚Äù.
//  Panel: Puesto, Partido, Meta (% secciones), Umbral opcional ‚Äúsolo cercanas‚Äù.
//  Overlay: verde=ya ganada, amarillo=candidata del plan, rojo=resto.
//  Tabla: ordenada por costo; clic ‚Üí zoom + tooltip.
//  Requiere: AT27_GG_project2027, AT27_GG_shares2024, loadPuesto/getElectData,
//            AT_CTX.map/layer y (si existe) AT27_GG_getUniverseSecIds().
// =======================================================

/* ====== Estado y utilidades ====== */
window.AT27_PM_STATE  = window.AT27_PM_STATE  || { autorun:false, running:false };
window.AT27_PM_LAYERS = window.AT27_PM_LAYERS || {};   // sec -> layer
window.AT27_PM_LAYER  = window.AT27_PM_LAYER  || null;

const PM_COLORS = { WIN:'#22c55e', PLAN:'#f59e0b', LOSS:'#ef4444', NA:'#94a3b8' }; // verde, √°mbar, rojo, gris

//const sec4 = (s)=> String(s||'').replace(/\D+/g,'').padStart(4,'0');
//const clamp = (x,a,b)=> Math.min(b, Math.max(a, x));
const fmtInt = (x)=> Number.isFinite(x)? Math.round(x).toLocaleString() : '‚Äî';

function PM_getUniverseSecIds(){
  if (typeof AT27_GG_getUniverseSecIds==='function') return AT27_GG_getUniverseSecIds();
  const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];
  return feats.map(f=> sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id));
}
async function PM_load(p){ return (window.loadPuesto? loadPuesto(p) : getElectData(p)); }

function partPct(row){
  if (!row) return null;
  const ln = Number(row.LN||0); if (!ln) return null;
  let vv = (row.VOTOS!=null)? Number(row.VOTOS||0) : 0;
  if (row.VOTOS==null){ for (const [k,v] of Object.entries(row)){ if (k!=='LN' && k!=='VOTOS') vv += Number(v||0); } }
  return (vv/ln)*100;
}

/* ====== C√°lculo por secci√≥n (l√≠nea base 2027) ====== */
function PM_computeBySec(js, secIds, puesto, partido){
  const bySec = {};                      // sec -> {winner, vL, vX, faltan, swing, evaluable, Vproj}
  const X = partido.toUpperCase();

  for (const sec of secIds){
    const slot  = js?.secciones?.[sec4(sec)]; if (!slot){ bySec[sec4(sec)] = { evaluable:false }; continue; }
    const row24 = slot['2024'];          if (!row24){ bySec[sec4(sec)] = { evaluable:false }; continue; }

    // Proyecci√≥n de participaci√≥n 2027*
    const p27 = (typeof AT27_GG_project2027==='function') ? AT27_GG_project2027(slot, puesto) : null;
    const ln24 = Number(row24?.LN||0);
    if (p27==null || !ln24){ bySec[sec4(sec)] = { evaluable:false }; continue; }

    const Vproj = ln24 * (p27/100);
    if (!Number.isFinite(Vproj) || Vproj < 1){ bySec[sec4(sec)] = { evaluable:false }; continue; }

    // Shares 2024
    const { shares, total:tot24 } = (typeof AT27_GG_shares2024==='function')
                                    ? AT27_GG_shares2024(row24)
                                    : (function(){
                                        let vv = (row24.VOTOS!=null)? Number(row24.VOTOS||0) : 0;
                                        if (row24.VOTOS==null){ for (const [k,v] of Object.entries(row24)){ if (k!=='LN' && k!=='VOTOS') vv += Number(v||0); } }
                                        const sh = {};
                                        for (const [k,v] of Object.entries(row24)){
                                          if (k==='LN'||k==='VOTOS') continue;
                                          sh[k.toUpperCase()] = vv? (Number(v||0)/vv) : 0;
                                        }
                                        return { shares:sh, total:vv };
                                      })();

    if (!Object.keys(shares).length || !tot24){ bySec[sec4(sec)] = { evaluable:false }; continue; }

    // Votos 2027* por partido (base shares 2024)
    const vBase = {};
    for (const [sig,sh] of Object.entries(shares)){ vBase[sig.toUpperCase()] = sh * Vproj; }

    // L√≠der y tu partido
    let L=null, vL=-1;
    for (const [sig, vv] of Object.entries(vBase)){ if (vv>vL){ vL=vv; L=sig; } }
    const vX = vBase[X] || 0;

    const faltan = Math.max(0, (vL - vX) + 1);
    const swing  = Math.ceil(faltan / 2);

    bySec[sec4(sec)] = { winner:L, vL, vX, faltan, swing, evaluable:true, Vproj };
  }
  return bySec;
}

/* ====== Construcci√≥n del plan (m√≠nimo costo) ====== */
function PM_buildPlan(bySec, metaPct){
  const entries = Object.entries(bySec).filter(([,x])=> x && x.evaluable);
  const totalSecs = entries.length;
  const metaCount = Math.ceil( clamp(metaPct, 1, 100) / 100 * totalSecs );

  // Secciones ya ganadas (costo 0)
  const wins   = entries.filter(([,x])=> x.faltan<=0 && x.winner && Number.isFinite(x.vX) && x.vX>=x.vL);
  const losses = entries.filter(([,x])=> !(x.faltan<=0 && x.winner && Number.isFinite(x.vX) && x.vX>=x.vL));

  // Si ya se cumple la meta con wins
  if (wins.length >= metaCount){
    return {
      selected: new Set(wins.map(([sec])=>sec).slice(0, metaCount)),
      planRows: wins.map(([sec,x])=>({sec, estado:'GANADA', faltan:0, swing:0, winner:x.winner, vL:x.vL, vX:x.vX}))
                     .sort((a,b)=> Number(a.sec)-Number(b.sec)),
      totals:{ votos:0, swing:0, metaCount, totalSecs }
    };
  }

  // Ordenar p√©rdidas por costo ascendente
  losses.sort((a,b)=> (a[1].faltan - b[1].faltan) || (Number(a[0])-Number(b[0])));

  const selected = new Set(wins.map(([sec])=>sec));
  const planRows = wins.map(([sec,x])=>({sec, estado:'GANADA', faltan:0, swing:0, winner:x.winner, vL:x.vL, vX:x.vX}));
  let votos=0, swing=0;

  for (const [sec,x] of losses){
    if (selected.size >= metaCount) break;
    selected.add(sec);
    votos += Math.ceil(x.faltan);
    swing += Math.ceil(x.swing);
    planRows.push({ sec, estado:'CANDIDATA', faltan:x.faltan, swing:x.swing, winner:x.winner, vL:x.vL, vX:x.vX });
  }

  // Las restantes (no seleccionadas) por claridad en tabla
  const rest = losses.filter(([sec])=> !selected.has(sec))
                     .map(([sec,x])=>({ sec, estado:'RESTO', faltan:x.faltan, swing:x.swing, winner:x.winner, vL:x.vL, vX:x.vX }));

  // Orden final: GANADA (id asc) ‚Üí CANDIDATA (faltan asc) ‚Üí RESTO (faltan asc)
  const table = [
    ...planRows.filter(r=>r.estado==='GANADA').sort((a,b)=> Number(a.sec)-Number(b.sec)),
    ...planRows.filter(r=>r.estado==='CANDIDATA').sort((a,b)=> a.faltan-b.faltan || Number(a.sec)-Number(b.sec)),
    ...rest.sort((a,b)=> a.faltan-b.faltan || Number(a.sec)-Number(b.sec))
  ];

  return { selected, planRows: table, totals:{ votos, swing, metaCount, totalSecs } };
}

/* ====== Overlay ====== */
function PM_clear(){
  const map = window.AT_CTX?.map || window.map;
  if (!map) return;
  if (window.AT27_PM_LAYER){ try{ map.removeLayer(AT27_PM_LAYER); }catch(_){} window.AT27_PM_LAYER=null; }
  window.AT27_PM_LAYERS = {};
}

function PM_buildOverlay(selectedSet, bySec){
  const map  = window.AT_CTX?.map || window.map;
  const base = window.AT_CTX?.layer?.toGeoJSON?.() || window.AT_DATA;
  if (!map || !base?.features) return;

  PM_clear();

  if (map.createPane && !map.getPane('at27_pm_pane')){
    map.createPane('at27_pm_pane');
    const p = map.getPane('at27_pm_pane'); p.style.zIndex=690; p.style.pointerEvents='auto';
  }

  const feats = base.features.filter(f=>{
    const id = sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
    return bySec[id]?.evaluable;
  });

  const layer = L.geoJSON({type:'FeatureCollection', features:feats}, {
    pane:'at27_pm_pane',
    style: f=>{
      const id = sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
      const info = bySec[id];
      let col = PM_COLORS.NA;
      if (info?.evaluable){
        if (info.faltan<=0 && info.vX>=info.vL) col = PM_COLORS.WIN;
        else if (selectedSet.has(id))          col = PM_COLORS.PLAN;
        else                                   col = PM_COLORS.LOSS;
      }
      return { color: col, weight:1, opacity:.9, fillColor: col, fillOpacity:.35 };
    },
    onEachFeature: (feature, lyr)=>{
      const id = sec4(feature.properties?.ID ?? feature.properties?.SECCION ?? feature.properties?.id);
      window.AT27_PM_LAYERS[id] = lyr;

      const x = bySec[id] || {};
      const estado = (x.faltan<=0 && x.vX>=x.vL) ? 'GANADA' : (selectedSet.has(id) ? 'CANDIDATA' : 'RESTO');
      const tip = `
        <div style="font-size:12px;">
          Secci√≥n <b>${id}</b><br>
          Estado: <b>${estado}</b><br>
          Ganador base 2027*: <b>${x.winner||'‚Äî'}</b><br>
          Votos l√≠der: <b>${fmtInt(x.vL)}</b> ¬∑ Tus votos: <b>${fmtInt(x.vX)}</b><br>
          Faltan: <b>${fmtInt(x.faltan)}</b> ¬∑ Swing: <b>${fmtInt(x.swing)}</b>
        </div>`;
      lyr.bindTooltip(tip, {sticky:true, opacity:.95, direction:'top', className:'at27-tt'});
      lyr.on('mouseover', ()=>lyr.setStyle({weight:2}));
      lyr.on('mouseout',  ()=>lyr.setStyle({weight:1}));
    }
  });

  layer.addTo(map);
  window.AT27_PM_LAYER = layer;
}

/* ====== Tabla + resumen ====== */
function PM_renderTable(planRows){
  const tb = document.getElementById('AT27_PM_tbody');
  tb.innerHTML = planRows.map(r=>{
    const bg = r.estado==='GANADA' ? '#dcfce7' : (r.estado==='CANDIDATA' ? '#fef9c3' : '#fee2e2');
    return `
      <tr data-sec="${r.sec}" style="background:${bg}; cursor:pointer;">
        <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;">${r.sec}</td>
        <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;">${r.estado}</td>
        <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;">${r.winner||'‚Äî'}</td>
        <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;">${fmtInt(r.faltan)}</td>
        <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;">${fmtInt(r.swing)}</td>
      </tr>
    `;
  }).join('');

  // Zoom al hacer clic
  tb.onclick = (e)=>{
    const tr = e.target.closest('tr[data-sec]'); if (!tr) return;
    PM_focus(tr.getAttribute('data-sec'));
  };
}

function PM_focus(sec){
  const id = sec4(sec);
  const lyr = window.AT27_PM_LAYERS[id];
  const map = window.AT_CTX?.map || window.map;
  if (!map) return;
  if (lyr){
    try{ map.fitBounds(lyr.getBounds(), {maxZoom:16, padding:[20,20]}); }catch(_){}
    if (lyr.openTooltip) lyr.openTooltip();
    const origFO = lyr.options.fillOpacity ?? .35;
    lyr.setStyle({weight:3, fillOpacity: Math.min(.95, origFO+.25)});
    setTimeout(()=> lyr.setStyle({weight:1, fillOpacity: origFO}), 900);
    return;
  }
  // fallback
  const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];
  const f = feats.find(ft=> sec4(ft.properties?.ID ?? ft.properties?.SECCION ?? ft.properties?.id)===id);
  if (f){ const tmp=L.geoJSON(f); map.fitBounds(tmp.getBounds(), {maxZoom:16, padding:[20,20]}); }
}

function PM_renderSummary(totals){
  const el = document.getElementById('AT27_PM_summary');
  const { votos, swing, metaCount, totalSecs } = totals || {};
  el.innerHTML = `
    <div style="font-size:12px; line-height:1.35;">
      <div><span style="display:inline-block;width:10px;height:10px;background:${PM_COLORS.WIN};border-radius:2px;"></span> Ya ganadas (costo 0)</div>
      <div><span style="display:inline-block;width:10px;height:10px;background:${PM_COLORS.PLAN};border-radius:2px;"></span> Candidatas del plan</div>
      <div><span style="display:inline-block;width:10px;height:10px;background:${PM_COLORS.LOSS};border-radius:2px;"></span> Resto</div>
      <div style="margin-top:6px;"><b>Meta de secciones:</b> ${fmtInt(metaCount)} de ${fmtInt(totalSecs)}</div>
      <div><b>Votos m√≠nimos a movilizar:</b> ${fmtInt(votos)}</div>
      <div><b>Swing estimado:</b> ${fmtInt(swing)}</div>
    </div>
  `;
}

/* ====== RUN principal ====== */
async function AT27_PM_run(){
  if (window.AT27_PM_STATE.running) return;
  window.AT27_PM_STATE.running = true;
  try{
    const puesto  = document.getElementById('AT27_PM_selPuesto').value;
    const partido = document.getElementById('AT27_PM_selPartido').value.toUpperCase();
    const meta    = Number(document.getElementById('AT27_PM_meta').value || 60); // %
    const onlyNear = document.getElementById('AT27_PM_onlyNear').checked;
    const nearMax  = Number(document.getElementById('AT27_PM_nearMax').value || 0);

    const secIds = PM_getUniverseSecIds();
    if (!secIds.length){ PM_clear(); document.getElementById('AT27_PM_tbody').innerHTML=''; return; }

    const js = await PM_load(puesto);
    let bySec = PM_computeBySec(js, secIds, puesto, partido);

    // Filtro "solo cercanas" (opcional)
    if (onlyNear){
      const filtered = {};
      for (const [sec,x] of Object.entries(bySec)){
        if (!x?.evaluable) continue;
        if (x.faltan<=0 || x.faltan<=nearMax) filtered[sec] = x;
      }
      bySec = filtered;
    }

    const plan = PM_buildPlan(bySec, meta);
    PM_buildOverlay(plan.selected, bySec);
    PM_renderSummary(plan.totals);
    PM_renderTable(plan.planRows);

  }catch(e){
    console.error('AT27_PM_run', e);
    alert('No pude ejecutar ‚ÄúPlan de mayor√≠a‚Äù.');
  }finally{
    window.AT27_PM_STATE.running = false;
  }
}

/* ====== Panel UI ====== */
function AT27_PM_open(){
  let panel = document.getElementById('AT27_PM_panel');
  if (panel){ panel.style.display='block'; return; }

  panel = document.createElement('div');
  panel.id = 'AT27_PM_panel';
  Object.assign(panel.style,{
    position:'fixed', right:'24px', top:'24px', zIndex:9998,
    width:'560px', maxWidth:'calc(100vw - 40px)', maxHeight:'calc(100vh - 40px)',
    background:'#fff', border:'1px solid #e5e7eb', borderRadius:'14px',
    boxShadow:'0 18px 40px rgba(0,0,0,.18)', display:'flex', flexDirection:'column',
    overflow:'hidden', resize:'both', minWidth:'380px', minHeight:'280px'
  });

  panel.innerHTML = `
    <div id="AT27_PM_hdr" style="cursor:move; user-select:none; background:#fffbeb; color:#111; padding:10px 12px; display:flex; gap:10px; align-items:center;">
      <div style="font-weight:800;">M√≠nimo de votos para mayor√≠a</div>
      <button id="AT27_PM_center" style="margin-left:auto; background:#eef2ff; border:1px solid #c7d2fe; border-radius:8px; padding:4px 8px; cursor:pointer;">Recentrar</button>
      <button id="AT27_PM_close" title="Cerrar" style="background:transparent;border:none;font-size:18px;cursor:pointer;">√ó</button>
    </div>

    <div style="padding:10px 12px; display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:end;">
      <label style="font-size:12px;">Puesto<br>
        <select id="AT27_PM_selPuesto" class="ttb-select" style="width:100%;">
          <option value="A">Ayuntamiento</option>
          <option value="DL">Diputado Local</option>
          <option value="DF">Diputado Federal</option>
        </select>
      </label>
      <label style="font-size:12px;">Partido<br>
        <select id="AT27_PM_selPartido" class="ttb-select" style="width:100%;">
          <option>PAN</option><option>PRI</option><option>PVEM</option><option>MORENA</option>
        </select>
      </label>

      <label style="font-size:12px;">Meta de secciones (%) <span id="AT27_PM_lblMeta" style="opacity:.7;">60%</span>
        <input id="AT27_PM_meta" type="range" min="50" max="80" step="5" value="60" style="width:100%;">
      </label>
      <label style="font-size:12px;">Solo cercanas (‚â§ votos faltantes)
        <div style="display:flex; gap:8px; align-items:center;">
          <input id="AT27_PM_onlyNear" type="checkbox">
          <input id="AT27_PM_nearMax" type="number" min="0" value="300" style="width:100px; padding:4px 6px; border:1px solid #e5e7eb; border-radius:8px;">
        </div>
      </label>

      <button id="AT27_PM_run" class="ttb-btn ttb-primary" style="grid-column:1 / span 2;">Ejecutar</button>
    </div>

    <div style="padding:8px 12px;">
      <div id="AT27_PM_legend" style="font-size:12px; display:flex; gap:12px; align-items:center; margin-bottom:6px;">
        <span><span style="display:inline-block;width:10px;height:10px;background:${PM_COLORS.WIN};border-radius:2px;"></span> Ya ganada</span>
        <span><span style="display:inline-block;width:10px;height:10px;background:${PM_COLORS.PLAN};border-radius:2px;"></span> Candidata del plan</span>
        <span><span style="display:inline-block;width:10px;height:10px;background:${PM_COLORS.LOSS};border-radius:2px;"></span> Resto</span>
      </div>
      <div id="AT27_PM_summary" style="font-size:12px; color:#334155;"></div>
    </div>

    <div style="flex:1; overflow:auto;">
      <table style="width:100%; border-collapse:collapse; font-size:12px;">
        <thead>
          <tr style="position:sticky; top:0; background:#f8fafc;">
            <th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;">Secci√≥n</th>
            <th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;">Estado</th>
            <th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;">Ganador base</th>
            <th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;">Faltan</th>
            <th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;">Swing</th>
          </tr>
        </thead>
        <tbody id="AT27_PM_tbody"></tbody>
      </table>
    </div>
  `;
  document.body.appendChild(panel);

  // Wiring UI
  const $$ = (sel)=> panel.querySelector(sel);
  $$('#AT27_PM_close').onclick  = ()=> panel.style.display='none';
  $$('#AT27_PM_center').onclick = ()=> (window.AT27_fitUniverseBounds? AT27_fitUniverseBounds() : null);
  $$('#AT27_PM_run').onclick    = ()=>{ window.AT27_PM_STATE.autorun = true; AT27_PM_run(); };
  $$('#AT27_PM_meta').addEventListener('input', ()=> $$('#AT27_PM_lblMeta').textContent = $$('#AT27_PM_meta').value + '%');

  // Drag & evitar que tape al mapa
  (function drag(panelEl, handleEl){
    let sx=0, sy=0, ox=0, oy=0, dragging=false;
    handleEl.addEventListener('mousedown', e=>{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panelEl.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });
    window.addEventListener('mousemove', e=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panelEl.style.left=(ox+dx)+'px'; panelEl.style.top=(oy+dy)+'px'; panelEl.style.right='auto'; });
    window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; });
  })(panel, panel.querySelector('#AT27_PM_hdr'));
  if (window.L && L.DomEvent){ L.DomEvent.disableClickPropagation(panel); L.DomEvent.disableScrollPropagation(panel); }

  // Recalcular si cambias universo (despu√©s del primer run)
  const map = window.AT_CTX?.map || window.map;
  if (map && !map.__pmBound){
    const deb = (fn,ms=350)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
    map.on('layeradd',    deb(()=>{ if (window.AT27_PM_STATE.autorun) AT27_PM_run(); }));
    map.on('layerremove', deb(()=>{ if (window.AT27_PM_STATE.autorun) AT27_PM_run(); }));
    map.__pmBound = true;
  }
}


</script>


<script>
    // =======================================================
    // GENIALIDAD #3 ¬∑ EFICIENCIA DEL VOTO (VOTOS OCIOSOS)
    // 2018‚Äì2024 base: usa 2024 real (no proyecci√≥n). Azul = ociosos si tu partido gan√≥.
    // Rojo = d√©ficit si tu partido perdi√≥. Modo "votos" o "pp". Tabla y zoom.
    // Requiere: AT_CTX.map/layer y (si existe) AT27_GG_getUniverseSecIds().
    // =======================================================

    /* ====== Estado y utilidades ====== */
    window.AT27_EV_STATE  = window.AT27_EV_STATE  || { autorun:false, running:false };
    window.AT27_EV_LAYERS = window.AT27_EV_LAYERS || {};   // sec -> layer
    window.AT27_EV_LAYER  = window.AT27_EV_LAYER  || null;

    const EV_COLORS = { SURPLUS:'#3b82f6', DEFICIT:'#ef4444', NA:'#94a3b8' }; // azul, rojo, gris

    // const sec4   = s => String(s||'').replace(/\D+/g,'').padStart(4,'0');
    // const clamp  = (x,a,b)=> Math.min(b, Math.max(a, x));
    // const fmtInt = x => Number.isFinite(x) ? Math.round(x).toLocaleString() : '‚Äî';
    // const fmtpp  = x => (x===null||x===undefined) ? '‚Äî' : (Number.isFinite(+x) ? ((x>0?'+':'')+(+x).toFixed(1)+' pp') : '‚Äî');

    function EV_getUniverseSecIds(){
      if (typeof AT27_GG_getUniverseSecIds==='function') return AT27_GG_getUniverseSecIds();
      const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];
      return feats.map(f=> sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id));
    }
    function partVV(row){
      // votos v√°lidos (usa row.VOTOS si existe; si no, suma partidos)
      if (!row) return 0;
      if (row.VOTOS!=null) return Number(row.VOTOS||0);
      let vv = 0; for (const [k,v] of Object.entries(row)){ if (k==='LN'||k==='VOTOS') continue; vv += Number(v||0); }
      return vv;
    }
    function EV_load(p){ return (window.loadPuesto? loadPuesto(p) : getElectData(p)); }

    /* ====== C√°lculo por secci√≥n (con 2024 real) ====== */
    function EV_computeBySec(js, secIds, partido, modo){
      const X = partido.toUpperCase();
      const perSec = {}; // sec -> { estado:'GANA'|'PIERDE', winner, v1, v2, vX, vv, ociosos, deficit, valor, mppSigned }

      for (const sec of secIds){
        const slot  = js?.secciones?.[sec4(sec)];
        const row24 = slot?.['2024'];
        if (!row24){ continue; }

        // votos por partido
        const votes = {};
        for (const [k,v] of Object.entries(row24)){
          if (k==='LN'||k==='VOTOS') continue;
          votes[k.toUpperCase()] = Number(v||0);
        }
        const vv = partVV(row24); if (!vv){ continue; }

        // ordenar para v1 (l√≠der) y v2 (segundo)
        const arr = Object.entries(votes).sort((a,b)=> b[1]-a[1]);
        const [L, v1] = arr[0] || [null,0];
        const v2      = (arr[1]?.[1]) ?? 0;
        const vX      = votes[X] || 0;

        const gana   = (L===X);
        const ociosos_v   = gana ? Math.max(0, vX - (v2 + 1)) : 0;       // sobrante al ganar
        const deficit_v   = gana ? 0 : Math.max(0, v1 - vX + 1);          // lo que falt√≥ al perder
        const ociosos_pp  = vv? (ociosos_v / vv * 100) : 0;
        const deficit_pp  = vv? (deficit_v / vv * 100) : 0;

        // valor (para color/intensidad): positivo = ociosos; negativo = d√©ficit
        const valor_v = ociosos_v - deficit_v;   // votos
        const valor_p = ociosos_pp - deficit_pp; // pp
        const valor   = (modo==='pp') ? valor_p : valor_v;

        // margen firmado vs rival m√°s cercano (pp): + si gana por pp, ‚àí si pierde por pp
        const mppSigned = (gana ? (vX - v2) : (vX - v1)) / vv * 100;

        perSec[sec4(sec)] = {
          estado: gana? 'GANA' : 'PIERDE',
          winner: L, v1, v2, vX, vv,
          ociosos_v, deficit_v, ociosos_pp, deficit_pp,
          valor, mppSigned
        };
      }
      return perSec;
    }

    /* ====== Overlay ====== */
    function EV_clear(){
      const map = window.AT_CTX?.map || window.map;
      if (!map) return;
      if (window.AT27_EV_LAYER){ try{ map.removeLayer(AT27_EV_LAYER); }catch(_){}
        window.AT27_EV_LAYER=null; }
      window.AT27_EV_LAYERS = {};
    }

    function EV_buildOverlay(perSec, modo, cap, umbral){
      const map  = window.AT_CTX?.map || window.map;
      const base = window.AT_CTX?.layer?.toGeoJSON?.() || window.AT_DATA;
      if (!map || !base?.features) return;

      EV_clear();

      if (map.createPane && !map.getPane('at27_ev_pane')){
        map.createPane('at27_ev_pane');
        const p = map.getPane('at27_ev_pane'); p.style.zIndex=700; p.style.pointerEvents='auto';
      }

      const feats = base.features.filter(f=>{
        const id = sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
        return perSec[id]!=null;
      });

      const layer = L.geoJSON({type:'FeatureCollection', features:feats}, {
        pane:'at27_ev_pane',
        style: f=>{
          const id = sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
          const info = perSec[id];
          if (!info) return { color:EV_COLORS.NA, fillColor:EV_COLORS.NA, weight:1, fillOpacity:.2, opacity:.6 };

          const val  = info.valor; // positivo (ociosos), negativo (d√©ficit)
          const sign = val>=0 ? 1 : -1;
          const mag  = Math.min(1, Math.abs(val) / Math.max(1, cap)); // 0..1
          const col  = sign>0 ? EV_COLORS.SURPLUS : EV_COLORS.DEFICIT;
          const fo   = 0.20 + mag*0.50;
          return { color: col, fillColor: col, weight:1, opacity:.9, fillOpacity: fo };
        },
        onEachFeature: (feature, lyr)=>{
          const id = sec4(feature.properties?.ID ?? feature.properties?.SECCION ?? feature.properties?.id);
          window.AT27_EV_LAYERS[id] = lyr;

          const x = perSec[id];
          const oTxt = (modo==='pp') ? fmtpp(x?.ociosos_pp) : fmtInt(x?.ociosos_v);
          const dTxt = (modo==='pp') ? fmtpp(x?.deficit_pp) : fmtInt(x?.deficit_v);
          const mTxt = fmtpp(x?.mppSigned);

          const tip = `
            <div style="font-size:12px;">
              Secci√≥n <b>${id}</b><br>
              Estado: <b>${x?.estado||'‚Äî'}</b> ¬∑ Ganador 2024: <b>${x?.winner||'‚Äî'}</b><br>
              Ociosos: <b>${oTxt}</b> ¬∑ D√©ficit: <b>${dTxt}</b><br>
              Margen firmado (pp): <b>${mTxt}</b>
            </div>`;
          lyr.bindTooltip(tip, {sticky:true, opacity:.95, direction:'top', className:'at27-tt'});
          lyr.on('mouseover', ()=>lyr.setStyle({weight:2}));
          lyr.on('mouseout',  ()=>lyr.setStyle({weight:1}));
        }
      });

      layer.addTo(map);
      window.AT27_EV_LAYER = layer;
    }

    /* ====== Tabla + resumen ====== */
    function EV_renderSummary(perSec, modo){
      const el = document.getElementById('AT27_EV_summary');
      let sumO=0, sumD=0, n=0, gana=0, pierde=0;
      Object.values(perSec).forEach(x=>{
        if (!x) return;
        n++;
        if (x.estado==='GANA'){ gana++; sumO += (modo==='pp'? x.ociosos_pp : x.ociosos_v); }
        else { pierde++;       sumD += (modo==='pp'? x.deficit_pp : x.deficit_v); }
      });
      const unit = (modo==='pp') ? ' pp' : '';
      el.innerHTML = `
        <div style="font-size:12px; line-height:1.35;">
          <div><span style="display:inline-block;width:10px;height:10px;background:${EV_COLORS.SURPLUS};border-radius:2px;"></span> <b>Ociosos</b> (se gan√≥): ${modo==='pp'? fmtpp(sumO) : fmtInt(sumO)}</div>
          <div><span style="display:inline-block;width:10px;height:10px;background:${EV_COLORS.DEFICIT};border-radius:2px;"></span> <b>D√©ficit</b> (se perdi√≥): ${modo==='pp'? fmtpp(sumD) : fmtInt(sumD)}</div>
          <div style="margin-top:6px;">Secciones: <b>${n}</b> ¬∑ Gana: <b>${gana}</b> ¬∑ Pierde: <b>${pierde}</b></div>
        </div>`;
    }

    function EV_renderTable(perSec, modo){
      const tb = document.getElementById('AT27_EV_tbody');
      const rows = Object.entries(perSec).map(([sec,x])=>{
        const o = (modo==='pp') ? x.ociosos_pp : x.ociosos_v;
        const d = (modo==='pp') ? x.deficit_pp : x.deficit_v;
        return { sec, estado:x.estado, winner:x.winner, o, d, mpp:x.mppSigned };
      });

      // Orden: primero p√©rdidas por d√©ficit asc (m√°s volteables), luego ganancias por ociosos desc.
      rows.sort((a,b)=>{
        const aKey = (a.estado==='PIERDE') ? 0 : 1;
        const bKey = (b.estado==='PIERDE') ? 0 : 1;
        if (aKey!==bKey) return aKey-bKey;
        return (a.estado==='PIERDE')
          ? (a.d - b.d) || (Number(a.sec)-Number(b.sec))
          : (b.o - a.o) || (Number(a.sec)-Number(b.sec));
      });

      tb.innerHTML = rows.map(r=>{
        const bg = r.estado==='PIERDE' ? '#fee2e2' : '#dbeafe';
        return `
          <tr data-sec="${r.sec}" style="background:${bg}; cursor:pointer;">
            <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;">${r.sec}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;">${r.estado}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;">${r.winner||'‚Äî'}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;">${modo==='pp'? fmtpp(r.o) : fmtInt(r.o)}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;">${modo==='pp'? fmtpp(r.d) : fmtInt(r.d)}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;">${fmtpp(r.mpp)}</td>
          </tr>`;
      }).join('');

      tb.onclick = (e)=>{
        const tr = e.target.closest('tr[data-sec]'); if (!tr) return;
        EV_focus(tr.getAttribute('data-sec'));
      };
    }

    function EV_focus(sec){
      const id = sec4(sec);
      const lyr = window.AT27_EV_LAYERS[id];
      const map = window.AT_CTX?.map || window.map;
      if (!map) return;
      if (lyr){
        try{ map.fitBounds(lyr.getBounds(), {maxZoom:16, padding:[20,20]}); }catch(_){}
        if (lyr.openTooltip) lyr.openTooltip();
        const origFO = lyr.options.fillOpacity ?? .35;
        lyr.setStyle({weight:3, fillOpacity: Math.min(.95, origFO+.25)});
        setTimeout(()=> lyr.setStyle({weight:1, fillOpacity: origFO}), 900);
        return;
      }
      // fallback
      const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];
      const f = feats.find(ft=> sec4(ft.properties?.ID ?? ft.properties?.SECCION ?? ft.properties?.id)===id);
      if (f){ const tmp=L.geoJSON(f); map.fitBounds(tmp.getBounds(), {maxZoom:16, padding:[20,20]}); }
    }

    /* ====== RUN principal ====== */
    async function AT27_EV_run(){
      if (window.AT27_EV_STATE.running) return;
      window.AT27_EV_STATE.running = true;
      try{
        const puesto  = document.getElementById('AT27_EV_selPuesto').value;
        const partido = document.getElementById('AT27_EV_selPartido').value.toUpperCase();
        const modo    = document.querySelector('input[name="AT27_EV_modo"]:checked').value; // 'votos' | 'pp'
        const cap     = Number(document.getElementById('AT27_EV_cap').value || (modo==='pp'? 10 : 1000)); // saturaci√≥n color
        const umbral  = Number(document.getElementById('AT27_EV_umbral').value || 0); // sobrante m√≠nimo para resaltar (solo visual)

        const secIds = EV_getUniverseSecIds();
        if (!secIds.length){ EV_clear(); document.getElementById('AT27_EV_tbody').innerHTML=''; return; }

        const js = await EV_load(puesto);
        const perSecAll = EV_computeBySec(js, secIds, partido, modo);

        // Opcional: "umbral" solo afecta color (suaviza si ociosos < umbral)
        const perSec = {};
        Object.entries(perSecAll).forEach(([k,x])=>{
          if (!x) return;
          let val = x.valor;
          if (modo==='pp'){
            const o = x.ociosos_pp, d = x.deficit_pp;
            if (o>0 && o < umbral) val = val * 0.25; // suavizar
          }else{
            const o = x.ociosos_v;
            if (o>0 && o < umbral) val = val * 0.25;
          }
          perSec[k] = { ...x, valor: val };
        });

        EV_buildOverlay(perSec, modo, cap, umbral);
        EV_renderSummary(perSec, modo);
        EV_renderTable(perSec, modo);

      }catch(e){
        console.error('AT27_EV_run', e);
        alert('No pude ejecutar ‚ÄúEficiencia del voto‚Äù.');
      }finally{
        window.AT27_EV_STATE.running = false;
      }
    }

    /* ====== Panel UI ====== */
    function AT27_EV_open(){
      let panel = document.getElementById('AT27_EV_panel');
      if (panel){ panel.style.display='block'; return; }

      panel = document.createElement('div');
      panel.id = 'AT27_EV_panel';
      Object.assign(panel.style,{
        position:'fixed', right:'24px', top:'24px', zIndex:9998,
        width:'560px', maxWidth:'calc(100vw - 40px)', maxHeight:'calc(100vh - 40px)',
        background:'#fff', border:'1px solid #e5e7eb', borderRadius:'14px',
        boxShadow:'0 18px 40px rgba(0,0,0,.18)', display:'flex', flexDirection:'column',
        overflow:'hidden', resize:'both', minWidth:'380px', minHeight:'280px'
      });

      panel.innerHTML = `
        <div id="AT27_EV_hdr" style="cursor:move; user-select:none; background:#e0f2fe; color:#111; padding:10px 12px; display:flex; gap:10px; align-items:center;">
          <div style="font-weight:800;">Eficiencia del voto (votos ociosos)</div>
          <button id="AT27_EV_center" style="margin-left:auto; background:#eef2ff; border:1px solid #c7d2fe; border-radius:8px; padding:4px 8px; cursor:pointer;">Recentrar</button>
          <button id="AT27_EV_close" title="Cerrar" style="background:transparent;border:none;font-size:18px;cursor:pointer;">√ó</button>
        </div>

        <div style="padding:10px 12px; display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:end;">
          <label style="font-size:12px;">Puesto<br>
            <select id="AT27_EV_selPuesto" class="ttb-select" style="width:100%;">
              <option value="A">Ayuntamiento</option>
              <option value="DL">Diputado Local</option>
              <option value="DF">Diputado Federal</option>
            </select>
          </label>
          <label style="font-size:12px;">Partido<br>
            <select id="AT27_EV_selPartido" class="ttb-select" style="width:100%;">
              <option>PAN</option><option>PRI</option><option>PVEM</option><option>MORENA</option>
            </select>
          </label>

          <div style="grid-column:1 / span 2; display:flex; gap:16px; align-items:center; font-size:12px;">
            Modo:
            <label><input type="radio" name="AT27_EV_modo" value="votos" checked> votos</label>
            <label><input type="radio" name="AT27_EV_modo" value="pp"> pp</label>
            <span style="opacity:.7;">¬∑ Cap color</span>
            <input id="AT27_EV_cap" type="number" value="1000" style="width:90px; padding:4px 6px; border:1px solid #e5e7eb; border-radius:8px;">
            <span style="opacity:.7;">¬∑ Umbral sobrante</span>
            <input id="AT27_EV_umbral" type="number" value="50" style="width:90px; padding:4px 6px; border:1px solid #e5e7eb; border-radius:8px;">
          </div>

          <button id="AT27_EV_run" class="ttb-btn ttb-primary" style="grid-column:1 / span 2;">Ejecutar</button>
        </div>

        <div style="padding:8px 12px;">
          <div id="AT27_EV_legend" style="font-size:12px; display:flex; gap:12px; align-items:center; margin-bottom:6px;">
            <span><span style="display:inline-block;width:10px;height:10px;background:${EV_COLORS.SURPLUS};border-radius:2px;"></span> Ociosos (ganadas)</span>
            <span><span style="display:inline-block;width:10px;height:10px;background:${EV_COLORS.DEFICIT};border-radius:2px;"></span> D√©ficit (perdidas)</span>
          </div>
          <div id="AT27_EV_summary" style="font-size:12px; color:#334155;"></div>
        </div>

        <div style="flex:1; overflow:auto;">
          <table style="width:100%; border-collapse:collapse; font-size:12px;">
            <thead>
              <tr style="position:sticky; top:0; background:#f8fafc;">
                <th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;">Secci√≥n</th>
                <th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;">Estado</th>
                <th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;">Ganador 2024</th>
                <th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;">Ociosos</th>
                <th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;">D√©ficit</th>
                <th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;">Margen (pp)</th>
              </tr>
            </thead>
            <tbody id="AT27_EV_tbody"></tbody>
          </table>
        </div>
      `;
      document.body.appendChild(panel);

      // Wiring UI
      const $$ = (sel)=> panel.querySelector(sel);
      $$('#AT27_EV_close').onclick  = ()=> panel.style.display='none';
      $$('#AT27_EV_center').onclick = ()=> (window.AT27_fitUniverseBounds? AT27_fitUniverseBounds() : null);
      $$('#AT27_EV_run').onclick    = ()=>{ window.AT27_EV_STATE.autorun = true; AT27_EV_run(); };
      panel.querySelectorAll('input[name="AT27_EV_modo"]').forEach(r=>{
        r.addEventListener('change', ()=>{
          // Ajuste de cap por modo
          const modo = panel.querySelector('input[name="AT27_EV_modo"]:checked').value;
          if (modo==='pp' && Number($$('#AT27_EV_cap').value)>50) $$('#AT27_EV_cap').value = 10;
          if (modo==='votos' && Number($$('#AT27_EV_cap').value)<50) $$('#AT27_EV_cap').value = 1000;
        });
      });

      // Drag & bloquear eventos al mapa
      (function drag(panelEl, handleEl){
        let sx=0, sy=0, ox=0, oy=0, dragging=false;
        handleEl.addEventListener('mousedown', e=>{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panelEl.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });
        window.addEventListener('mousemove', e=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panelEl.style.left=(ox+dx)+'px'; panelEl.style.top=(oy+dy)+'px'; panelEl.style.right='auto'; });
        window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; });
      })(panel, panel.querySelector('#AT27_EV_hdr'));
      if (window.L && L.DomEvent){ L.DomEvent.disableClickPropagation(panel); L.DomEvent.disableScrollPropagation(panel); }

      // Recalcular si cambias universo (tras primer run)
      const map = window.AT_CTX?.map || window.map;
      if (map && !map.__evBound){
        const deb = (fn,ms=350)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
        map.on('layeradd',    deb(()=>{ if (window.AT27_EV_STATE.autorun) AT27_EV_run(); }));
        map.on('layerremove', deb(()=>{ if (window.AT27_EV_STATE.autorun) AT27_EV_run(); }));
        map.__evBound = true;
      }
    }

</script>

<script>
    // =======================================================
    // GENIALIDAD #4 ¬∑ CORREDORES DE VOLTEO (CLUSTERS CONTIGUOS)
    // Agrupa secciones contiguas con brecha peque√±a (por votos o pp) para operarlas en bloque.
    // Requiere: AT27_GG_project2027, AT27_GG_shares2024, loadPuesto/getElectData,
    //           AT_CTX.map, AT_CTX.layer y (si existe) AT27_GG_getUniverseSecIds().
    // =======================================================

    /* ====== Estado y utilidades ====== */
    window.AT27_CV_STATE   = window.AT27_CV_STATE   || { autorun:false, running:false };
    window.AT27_CV_LAYER   = window.AT27_CV_LAYER   || null;  // layer GeoJSON de clusters
    window.AT27_CV_LAYERS  = window.AT27_CV_LAYERS  || {};    // sec -> layer (por zoom)
    window.AT27_CV_CLUSTERS= window.AT27_CV_CLUSTERS|| [];     // [{id, secs:Set, bounds, sumFaltan, avgPP, maxPP}]

    //const sec4   = (s)=> String(s||'').replace(/\D+/g,'').padStart(4,'0');
    //const clamp  = (x,a,b)=> Math.min(b, Math.max(a, x));
    //const fmtInt = (x)=> Number.isFinite(x)? Math.round(x).toLocaleString() : '‚Äî';
    //const fmtpp  = (x)=> (x===null||x===undefined) ? '‚Äî' : (Number.isFinite(+x) ? ((x>0?'+':'')+(+x).toFixed(1)+' pp') : '‚Äî');

    function CV_getUniverseSecIds(){
      if (typeof AT27_GG_getUniverseSecIds==='function') return AT27_GG_getUniverseSecIds();
      const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];
      return feats.map(f=> sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id));
    }
    async function CV_load(p){ return (window.loadPuesto? loadPuesto(p) : getElectData(p)); }

    function getBaseGeoJSON(){
      return window.AT_CTX?.layer?.toGeoJSON?.() || window.AT_DATA || { type:'FeatureCollection', features:[] };
    }

    /* ====== C√°lculo por secci√≥n (base 2027) ======
      Produce para cada secci√≥n:
      - faltan (votos para rebasar),
      - gapPP (pp relativas = (vL ‚àí vX)/Vproj * 100),
      - only if pierdes (faltan>0). */
    function CV_computeBySec(js, secIds, puesto, partido){
      const X = partido.toUpperCase();
      const bySec = {}; // sec -> { faltan, gapPP, winner, vL, vX, Vproj }

      for (const sec of secIds){
        const slot = js?.secciones?.[sec4(sec)];
        const row24 = slot?.['2024']; if (!row24) continue;

        const p27 = (typeof AT27_GG_project2027==='function') ? AT27_GG_project2027(slot, puesto) : null;
        const ln24 = Number(row24.LN||0);
        if (p27==null || !ln24) continue;

        const Vproj = ln24 * (p27/100);
        if (!Number.isFinite(Vproj) || Vproj<1) continue;

        // shares 2024
        const { shares, total:tot24 } = (typeof AT27_GG_shares2024==='function')
          ? AT27_GG_shares2024(row24)
          : (function(){
              let vv = (row24.VOTOS!=null)? Number(row24.VOTOS||0) : 0;
              if (row24.VOTOS==null){ for (const [k,v] of Object.entries(row24)){ if (k==='LN'||k==='VOTOS') continue; vv += Number(v||0); } }
              const sh = {};
              for (const [k,v] of Object.entries(row24)){ if (k==='LN'||k==='VOTOS') continue; sh[k.toUpperCase()] = vv? (Number(v||0)/vv) : 0; }
              return { shares:sh, total:vv };
            })();
        if (!Object.keys(shares).length || !tot24) continue;

        // votos base 2027 por partido
        const vBase = {};
        for (const [sig,sh] of Object.entries(shares)){ vBase[sig.toUpperCase()] = sh * Vproj; }

        let L=null, vL=-1; for (const [sig,vv] of Object.entries(vBase)){ if (vv>vL){ vL=vv; L=sig; } }
        const vX = vBase[X] || 0;

        const faltan = Math.max(0, (vL - vX) + 1);
        if (faltan<=0) continue; // s√≥lo ‚Äúvolteables‚Äù (pierdes hoy)

        const gapPP  = (vL - vX) / Vproj * 100; // > 0 pp
        bySec[sec4(sec)] = { faltan, gapPP, winner:L, vL, vX, Vproj };
      }
      return bySec;
    }

    /* ====== Construcci√≥n de clusters por contig√ºidad ======
      Aproximaci√≥n: dos secciones son vecinas si sus bounding-boxes se intersectan (con epsilon). */
    function bboxOfFeature(f){
      // usa bounds de Leaflet si existe; si no, calcula por coords
      const g = f.geometry;
      let minX=  999, minY=  999, maxX= -999, maxY= -999;
      const walk = (coords)=>{
        for (const pt of coords){
          if (Array.isArray(pt[0])){
            walk(pt);
          }else{
            const [x,y] = pt; // lon, lat
            if (x<minX) minX=x; if (x>maxX) maxX=x;
            if (y<minY) minY=y; if (y>maxY) maxY=y;
          }
        }
      };
      if (g) walk(g.coordinates);
      const eps = 1e-5;
      return { minX:minX-eps, minY:minY-eps, maxX:maxX+eps, maxY:maxY+eps };
    }
    function bboxIntersects(a,b){
      return !(a.maxX < b.minX || a.minX > b.maxX || a.maxY < b.minY || a.minY > b.maxY);
    }

    function CV_buildClusters(candidatesSet){
      const base = getBaseGeoJSON();
      const feats = base.features.filter(f=>{
        const id = sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
        return candidatesSet.has(id);
      });
      // index r√°pidos
      const ids   = feats.map(f=> sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id));
      const bboxes= feats.map(bboxOfFeature);
      const id2idx= Object.fromEntries(ids.map((id,i)=>[id,i]));

      const visited = new Set();
      const clusters = [];

      for (let i=0;i<feats.length;i++){
        const rootId = ids[i];
        if (visited.has(rootId)) continue;

        // BFS
        const queue=[i]; visited.add(rootId);
        const secSet = new Set([rootId]);
        let mergedBBox = { ...bboxes[i] };

        while (queue.length){
          const idx = queue.shift();
          const bb  = bboxes[idx];

          for (let j=0;j<feats.length;j++){
            const nbrId = ids[j];
            if (visited.has(nbrId)) continue;
            if (bboxIntersects(bb, bboxes[j])){
              // considerar vecino
              visited.add(nbrId);
              queue.push(j);
              secSet.add(nbrId);
              // merge bbox
              mergedBBox = {
                minX: Math.min(mergedBBox.minX, bboxes[j].minX),
                minY: Math.min(mergedBBox.minY, bboxes[j].minY),
                maxX: Math.max(mergedBBox.maxX, bboxes[j].maxX),
                maxY: Math.max(mergedBBox.maxY, bboxes[j].maxY),
              };
            }
          }
        }

        clusters.push({ id: clusters.length+1, secs: secSet, bbox: mergedBBox });
      }

      return clusters;
    }

    /* ====== Overlay ====== */
    function CV_clear(){
      const map = window.AT_CTX?.map || window.map;
      if (!map) return;
      if (window.AT27_CV_LAYER){ try{ map.removeLayer(AT27_CV_LAYER); }catch(_){} window.AT27_CV_LAYER=null; }
      window.AT27_CV_LAYERS = {};
    }

    function colorFromIndex(i){
      // paleta HSL agradable (12 tonos)
      const H = (i*47) % 360;
      return `hsl(${H} 80% 55%)`;
    }

    function CV_buildOverlay(clusters, bySec){
      const map  = window.AT_CTX?.map || window.map;
      const base = getBaseGeoJSON();
      if (!map || !base?.features) return;

      CV_clear();

      if (map.createPane && !map.getPane('at27_cv_pane')){
        map.createPane('at27_cv_pane');
        const p = map.getPane('at27_cv_pane'); p.style.zIndex=710; p.style.pointerEvents='auto';
      }

      // mapa sec -> clusterId
      const sec2cid = {};
      clusters.forEach(c=> c.secs.forEach(s=> sec2cid[s]=c.id));

      const feats = base.features.filter(f=>{
        const id = sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
        return sec2cid[id]!=null;
      });

      const layer = L.geoJSON({type:'FeatureCollection', features:feats}, {
        pane:'at27_cv_pane',
        style: f=>{
          const id = sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
          const cid = sec2cid[id];
          const col = colorFromIndex(cid);
          return { color: col, weight:1, opacity:.9, fillColor: col, fillOpacity:.38 };
        },
        onEachFeature: (feature, lyr)=>{
          const id  = sec4(feature.properties?.ID ?? feature.properties?.SECCION ?? feature.properties?.id);
          const cid = sec2cid[id];
          window.AT27_CV_LAYERS[id] = lyr;

          const x   = bySec[id];
          const tip = `
            <div style="font-size:12px;">
              Secci√≥n <b>${id}</b> ¬∑ Corredor <b>#${cid}</b><br>
              Faltan: <b>${fmtInt(x?.faltan)}</b> ¬∑ Brecha: <b>${fmtpp(x?.gapPP)}</b><br>
              L√≠der: <b>${x?.winner||'‚Äî'}</b> ¬∑ vL: <b>${fmtInt(x?.vL)}</b> ¬∑ T√∫: <b>${fmtInt(x?.vX)}</b>
            </div>`;
          lyr.bindTooltip(tip, {sticky:true, opacity:.95, direction:'top', className:'at27-tt'});
          lyr.on('mouseover', ()=>lyr.setStyle({weight:2}));
          lyr.on('mouseout',  ()=>lyr.setStyle({weight:1}));
        }
      });

      layer.addTo(map);
      window.AT27_CV_LAYER = layer;
    }

    /* ====== Tabla + resumen ====== */
    function CV_renderTable(clusters, bySec){
      const rows = clusters.map(c=>{
        let sumF=0, sumPP=0, maxPP=0, n=0;
        c.secs.forEach(s=>{
          const x = bySec[s]; if (!x) return;
          n++; sumF += Math.ceil(x.faltan); sumPP += x.gapPP; if (x.gapPP>maxPP) maxPP=x.gapPP;
        });
        const avgPP = n? (sumPP/n) : 0;
        return { id:c.id, n, sumF, avgPP, maxPP };
      }).sort((a,b)=> (a.sumF - b.sumF) || (b.n - a.n) || (a.id - b.id));

      const tb = document.getElementById('AT27_CV_tbody');
      tb.innerHTML = rows.map(r=>`
        <tr data-cid="${r.id}" style="cursor:pointer;">
          <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;">#${r.id}</td>
          <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;">${r.n}</td>
          <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;">${fmtInt(r.sumF)}</td>
          <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;">${fmtpp(r.avgPP)}</td>
          <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;">${fmtpp(r.maxPP)}</td>
        </tr>
      `).join('');

      tb.onclick = (e)=>{
        const tr = e.target.closest('tr[data-cid]'); if (!tr) return;
        const cid = Number(tr.getAttribute('data-cid'));
        CV_focusCluster(cid);
      };
    }

    function CV_renderSummary(clusters){
      const el = document.getElementById('AT27_CV_summary');
      const total = clusters.reduce((a,c)=> a + c.secs.size, 0);
      const nCorr = clusters.length;
      el.innerHTML = `
        <div style="font-size:12px; line-height:1.35;">
          Corredores: <b>${nCorr}</b> ¬∑ Secciones dentro: <b>${total}</b><br>
          Tip: ordena por <i>votos que faltan</i> para priorizar corredores con mayor retorno.
        </div>`;
    }

    function CV_focusCluster(cid){
      const map  = window.AT_CTX?.map || window.map;
      const base = getBaseGeoJSON();
      if (!map || !base?.features) return;

      const c = (window.AT27_CV_CLUSTERS||[]).find(k=> k.id===cid);
      if (!c) return;

      // construir bounds del cluster a partir de las capas indexadas (si existen)
      let bounds = null;
      c.secs.forEach(s=>{
        const lyr = window.AT27_CV_LAYERS[s];
        if (lyr){
          const b = lyr.getBounds();
          bounds = bounds ? bounds.extend(b) : L.latLngBounds(b.getSouthWest(), b.getNorthEast());
        }
      });
      if (bounds){ try{ map.fitBounds(bounds, {maxZoom:15, padding:[24,24]}); }catch(_){} }
    }

    /* ====== RUN principal ====== */
    async function AT27_CV_run(){
      if (window.AT27_CV_STATE.running) return;
      window.AT27_CV_STATE.running = true;
      try{
        const puesto   = document.getElementById('AT27_CV_selPuesto').value;
        const partido  = document.getElementById('AT27_CV_selPartido').value.toUpperCase();
        const modo     = document.querySelector('input[name="AT27_CV_modo"]:checked').value; // 'votos' | 'pp'
        const umbral   = Number(document.getElementById('AT27_CV_umbral').value || (modo==='pp'? 3 : 250));
        const minSize  = Number(document.getElementById('AT27_CV_minSize').value || 2);

        const secIds = CV_getUniverseSecIds();
        if (!secIds.length){ CV_clear(); document.getElementById('AT27_CV_tbody').innerHTML=''; return; }

        const js = await CV_load(puesto);
        const bySecAll = CV_computeBySec(js, secIds, puesto, partido);

        // filtra ‚ÄúNear‚Äù: s√≥lo donde pierdes y la brecha es peque√±a
        const nearSet = new Set();
        for (const [sec,x] of Object.entries(bySecAll)){
          if (modo==='pp'){
            if (x.gapPP>0 && x.gapPP <= umbral) nearSet.add(sec);
          }else{
            if (x.faltan>0 && x.faltan <= umbral) nearSet.add(sec);
          }
        }
        if (!nearSet.size){
          CV_clear();
          document.getElementById('AT27_CV_tbody').innerHTML = '';
          document.getElementById('AT27_CV_summary').innerHTML = '<div style="font-size:12px;">No hay secciones ‚Äúcercanas‚Äù con el umbral actual.</div>';
          return;
        }

        // clusters por contig√ºidad (bbox-intersect)
        let clusters = CV_buildClusters(nearSet);

        // quita clusters peque√±os
        clusters = clusters.filter(c=> c.secs.size >= minSize);

        // calcula m√©tricas de cluster
        clusters.forEach(c=>{
          let sumF=0, sumPP=0, maxPP=0, n=0;
          c.secs.forEach(s=>{
            const x = bySecAll[s]; if (!x) return;
            n++; sumF += Math.ceil(x.faltan); sumPP += x.gapPP; if (x.gapPP>maxPP) maxPP=x.gapPP;
          });
          c.sumF = sumF; c.avgPP = n? (sumPP/n) : 0; c.maxPP = maxPP;
        });

        window.AT27_CV_CLUSTERS = clusters;

        CV_buildOverlay(clusters, bySecAll);
        CV_renderSummary(clusters);
        CV_renderTable(clusters, bySecAll);

      }catch(e){
        console.error('AT27_CV_run', e);
        alert('No pude ejecutar ‚ÄúCorredores de volteo‚Äù.');
      }finally{
        window.AT27_CV_STATE.running = false;
      }
    }

    /* ====== Panel UI ====== */
    function AT27_CV_open(){
      let panel = document.getElementById('AT27_CV_panel');
      if (panel){ panel.style.display='block'; return; }

      panel = document.createElement('div');
      panel.id = 'AT27_CV_panel';
      Object.assign(panel.style,{
        position:'fixed', right:'24px', top:'24px', zIndex:9998,
        width:'560px', maxWidth:'calc(100vw - 40px)', maxHeight:'calc(100vh - 40px)',
        background:'#fff', border:'1px solid #e5e7eb', borderRadius:'14px',
        boxShadow:'0 18px 40px rgba(0,0,0,.18)', display:'flex', flexDirection:'column',
        overflow:'hidden', resize:'both', minWidth:'380px', minHeight:'280px'
      });

      panel.innerHTML = `
        <div id="AT27_CV_hdr" style="cursor:move; user-select:none; background:#fdf2f8; color:#111; padding:10px 12px; display:flex; gap:10px; align-items:center;">
          <div style="font-weight:800;">Corredores de volteo (clusters contiguos)</div>
          <button id="AT27_CV_center" style="margin-left:auto; background:#eef2ff; border:1px solid #c7d2fe; border-radius:8px; padding:4px 8px; cursor:pointer;">Recentrar</button>
          <button id="AT27_CV_close" title="Cerrar" style="background:transparent;border:none;font-size:18px;cursor:pointer;">√ó</button>
        </div>

        <div style="padding:10px 12px; display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:end;">
          <label style="font-size:12px;">Puesto<br>
            <select id="AT27_CV_selPuesto" class="ttb-select" style="width:100%;">
              <option value="A">Ayuntamiento</option>
              <option value="DL">Diputado Local</option>
              <option value="DF">Diputado Federal</option>
            </select>
          </label>
          <label style="font-size:12px;">Partido<br>
            <select id="AT27_CV_selPartido" class="ttb-select" style="width:100%;">
              <option>PAN</option><option>PRI</option><option>PVEM</option><option>MORENA</option>
            </select>
          </label>

          <div style="grid-column:1 / span 2; display:flex; gap:16px; align-items:center; font-size:12px;">
            Umbral por:
            <label><input type="radio" name="AT27_CV_modo" value="votos" checked> votos (faltan ‚â§)</label>
            <label><input type="radio" name="AT27_CV_modo" value="pp"> pp (brecha ‚â§)</label>
            <span style="opacity:.7;">Valor</span>
            <input id="AT27_CV_umbral" type="number" value="250" style="width:100px; padding:4px 6px; border:1px solid #e5e7eb; border-radius:8px;">
            <span style="opacity:.7;">Tama√±o m√≠nimo</span>
            <input id="AT27_CV_minSize" type="number" value="2" min="2" style="width:80px; padding:4px 6px; border:1px solid #e5e7eb; border-radius:8px;">
          </div>

          <button id="AT27_CV_run" class="ttb-btn ttb-primary" style="grid-column:1 / span 2;">Ejecutar</button>
        </div>

        <div style="padding:8px 12px;">
          <div id="AT27_CV_summary" style="font-size:12px; color:#334155;"></div>
        </div>

        <div style="flex:1; overflow:auto;">
          <table style="width:100%; border-collapse:collapse; font-size:12px;">
            <thead>
              <tr style="position:sticky; top:0; background:#f8fafc;">
                <th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;">Corredor</th>
                <th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;">Secciones</th>
                <th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;">Faltan (total)</th>
                <th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;">Brecha promedio</th>
                <th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;">Brecha m√°xima</th>
              </tr>
            </thead>
            <tbody id="AT27_CV_tbody"></tbody>
          </table>
        </div>
      `;
      document.body.appendChild(panel);

      // Wiring UI
      const $$ = (sel)=> panel.querySelector(sel);
      $$('#AT27_CV_close').onclick  = ()=> panel.style.display='none';
      $$('#AT27_CV_center').onclick = ()=> (window.AT27_fitUniverseBounds? AT27_fitUniverseBounds() : null);
      $$('#AT27_CV_run').onclick    = ()=>{ window.AT27_CV_STATE.autorun = true; AT27_CV_run(); };

      // Drag & bloqueo de eventos al mapa
      (function drag(panelEl, handleEl){
        let sx=0, sy=0, ox=0, oy=0, dragging=false;
        handleEl.addEventListener('mousedown', e=>{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panelEl.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });
        window.addEventListener('mousemove', e=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panelEl.style.left=(ox+dx)+'px'; panelEl.style.top=(oy+dy)+'px'; panelEl.style.right='auto'; });
        window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; });
      })(panel, panel.querySelector('#AT27_CV_hdr'));
      if (window.L && L.DomEvent){ L.DomEvent.disableClickPropagation(panel); L.DomEvent.disableScrollPropagation(panel); }

      // Recalcular si cambias universo (despu√©s del primer run)
      const map = window.AT_CTX?.map || window.map;
      if (map && !map.__cvBound){
        const deb = (fn,ms=350)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
        map.on('layeradd',    deb(()=>{ if (window.AT27_CV_STATE.autorun) AT27_CV_run(); }));
        map.on('layerremove', deb(()=>{ if (window.AT27_CV_STATE.autorun) AT27_CV_run(); }));
        map.__cvBound = true;
      }
    }


</script>

<script>
    // =======================================================
    // GENIALIDAD #5 ¬∑ ALERTAS DE RIESGO (BASTIONES EN CA√çDA)
    // Basti√≥n = misma fuerza ganadora en 2018, 2021 y 2024 (estabilidad alta).
    // Riesgo si: Œî participaci√≥n (2018‚Üí2024) < 0  y  p2027* < meta.
    // Vigilar si cumple una de las dos. Verde si ninguna.
    // Requiere: AT_CTX.map/layer, loadPuesto/getElectData, AT27_GG_project2027.
    // =======================================================

    /* ====== Estado y utilidades ====== */
    window.AT27_AR_STATE  = window.AT27_AR_STATE  || { autorun:false, running:false };
    window.AT27_AR_LAYER  = window.AT27_AR_LAYER  || null;   // overlay
    window.AT27_AR_LAYERS = window.AT27_AR_LAYERS || {};     // sec -> layer

    const AR_COLORS = { RIESGO:'#ef4444', VIGILAR:'#f59e0b', OK:'#10b981', NA:'#94a3b8' };

    //const sec4   = (s)=> String(s||'').replace(/\D+/g,'').padStart(4,'0');
    //const fmtInt = (x)=> Number.isFinite(x)? Math.round(x).toLocaleString() : '‚Äî';
    //const fmtpp  = (x)=> (x===null||x===undefined) ? '‚Äî' : (Number.isFinite(+x) ? ((x>0?'+':'')+(+x).toFixed(1)+' pp') : '‚Äî');

    function AR_getUniverseSecIds(){
      const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];
      return feats.map(f=> sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id));
    }
    async function AR_load(p){ return (window.loadPuesto? loadPuesto(p) : getElectData(p)); }

    function votosValidos(row){
      if (!row) return 0;
      if (row.VOTOS!=null) return Number(row.VOTOS||0);
      let vv = 0; for (const [k,v] of Object.entries(row)){ if (k==='LN'||k==='VOTOS') continue; vv += Number(v||0); }
      return vv;
    }
    function participacion(row){ 
      const ln = Number(row?.LN||0); const vv = votosValidos(row);
      return (ln>0 && vv>=0) ? (vv/ln*100) : null;
    }
    function ganador(row){
      if (!row) return null;
      let L=null, vL=-1;
      for (const [k,v] of Object.entries(row)){
        if (k==='LN'||k==='VOTOS') continue;
        const kk = k.toUpperCase(), vv = Number(v||0);
        if (vv>vL){ vL=vv; L=kk; }
      }
      return L;
    }

    /* ====== C√°lculo por secci√≥n ======
      - winners 2018/21/24
      - estabilidad (Alta/Media/Baja) -> usamos Alta (basti√≥n).
      - Œîp = p2024 - p2018
      - p27 = proyecci√≥n participaci√≥n 2027*
      - etiqueta: RIESGO si (Œîp< -tol && p27 < meta), VIGILAR si (Œîp< -tol || p27 < meta), OK si no.
    */
    function AR_compute(js, secIds, puesto, metaPct, tolDrop){
      const perSec = {}; // sec -> { bastion:party|null, est:'Alta'|'Media'|'Baja', dP, p27, tag, vv18,vv24 }

      for (const sec of secIds){
        const slot = js?.secciones?.[sec4(sec)];
        const row18 = slot?.['2018'], row21 = slot?.['2021'], row24 = slot?.['2024'];
        if (!row18 || !row24) continue;

        const g18 = ganador(row18), g21 = ganador(row21), g24 = ganador(row24);
        const est = (g18 && g21 && g24)
                      ? (g18===g21 && g21===g24 ? 'Alta' : (new Set([g18,g21,g24]).size===3 ? 'Baja' : 'Media'))
                      : null;
        const bastion = (est==='Alta') ? g24 : null;

        const p18 = participacion(row18);
        const p24 = participacion(row24);
        const dP  = (p18!=null && p24!=null) ? (p24 - p18) : null;

        // proyecci√≥n p2027*
        const p27 = (typeof AT27_GG_project2027==='function') ? AT27_GG_project2027(slot, puesto) : null;

        // Etiquetado
        let tag='NA';
        if (est==='Alta' && dP!=null && p27!=null){
          const cae = (dP < -Math.abs(tolDrop));     // ca√≠da verdadera (ej. tol=0 ‚Üí <0)
          const bajo= (p27 < metaPct);
          tag = (cae && bajo) ? 'RIESGO' : ((cae || bajo) ? 'VIGILAR' : 'OK');
        }

        perSec[sec4(sec)] = { bastion, est, dP, p27, tag,
                              vv18: votosValidos(row18), vv24: votosValidos(row24) };
      }
      return perSec;
    }

    /* ====== Overlay ====== */
    function AR_clear(){
      const map = window.AT_CTX?.map || window.map;
      if (!map) return;
      if (window.AT27_AR_LAYER){ try{ map.removeLayer(AT27_AR_LAYER); }catch(_){};
        window.AT27_AR_LAYER=null; }
      window.AT27_AR_LAYERS = {};
    }
    function AR_buildOverlay(perSec){
      const map  = window.AT_CTX?.map || window.map;
      const base = window.AT_CTX?.layer?.toGeoJSON?.() || window.AT_DATA;
      if (!map || !base?.features) return;

      AR_clear();

      if (map.createPane && !map.getPane('at27_ar_pane')){
        map.createPane('at27_ar_pane');
        const p = map.getPane('at27_ar_pane'); p.style.zIndex=720; p.style.pointerEvents='auto';
      }

      const feats = base.features.filter(f=>{
        const id = sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
        return perSec[id]!=null;
      });

      const layer = L.geoJSON({type:'FeatureCollection', features:feats}, {
        pane:'at27_ar_pane',
        style: f=>{
          const id = sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
          const info = perSec[id];
          let col = AR_COLORS.NA, fo=.20;
          if (info){
            if (info.tag==='RIESGO'){ col = AR_COLORS.RIESGO; fo=.45; }
            else if (info.tag==='VIGILAR'){ col = AR_COLORS.VIGILAR; fo=.35; }
            else if (info.tag==='OK'){ col = AR_COLORS.OK; fo=.28; }
          }
          return { color:col, fillColor:col, weight:1, opacity:.9, fillOpacity:fo };
        },
        onEachFeature: (feature, lyr)=>{
          const id = sec4(feature.properties?.ID ?? feature.properties?.SECCION ?? feature.properties?.id);
          window.AT27_AR_LAYERS[id] = lyr;

          const x = perSec[id] || {};
          const tip = `
            <div style="font-size:12px;">
              Secci√≥n <b>${id}</b><br>
              Estabilidad: <b>${x.est||'‚Äî'}</b> ¬∑ Basti√≥n: <b>${x.bastion||'‚Äî'}</b><br>
              Œî participaci√≥n 18‚Üí24: <b>${fmtpp(x.dP)}</b><br>
              p2027*: <b>${x.p27!=null ? x.p27.toFixed(1)+'%' : '‚Äî'}</b><br>
              Alerta: <b>${x.tag||'‚Äî'}</b>
            </div>`;
          lyr.bindTooltip(tip, {sticky:true, opacity:.95, direction:'top', className:'at27-tt'});
          lyr.on('mouseover', ()=>lyr.setStyle({weight:2}));
          lyr.on('mouseout',  ()=>lyr.setStyle({weight:1}));
        }
      });

      layer.addTo(map);
      window.AT27_AR_LAYER = layer;
    }

    /* ====== Tabla + zoom ====== */
    function AR_renderTable(perSec, orden){
      const tb = document.getElementById('AT27_AR_tbody');

      // a filas
      const rows = Object.entries(perSec).map(([sec,x])=>({
        sec, tag:x.tag, bastion:x.bastion||'‚Äî', est:x.est||'‚Äî',
        dP:x.dP, p27:x.p27, vv18:x.vv18, vv24:x.vv24
      })).filter(r=> r.est==='Alta'); // solo bastiones

      // orden: Riesgo primero, luego Vigilar, luego OK. Dentro, por mayor ca√≠da y menor p27.
      const catRank = (t)=> t==='RIESGO'?0 : (t==='VIGILAR'?1 : (t==='OK'?2:3));
      rows.sort((a,b)=> (catRank(a.tag) - catRank(b.tag)) ||
                        ((a.dP??0) - (b.dP??0)) || // m√°s negativa primero
                        ((a.p27??999) - (b.p27??999)) ||
                        (Number(a.sec)-Number(b.sec)));

      tb.innerHTML = rows.map(r=>{
        const bg = r.tag==='RIESGO' ? '#fee2e2' : (r.tag==='VIGILAR' ? '#fef9c3' : '#dcfce7');
        return `
          <tr data-sec="${r.sec}" style="background:${bg}; cursor:pointer;">
            <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;">${r.sec}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;">${r.bastion}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;">${r.est}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;">${fmtpp(r.dP)}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;">${r.p27!=null ? r.p27.toFixed(1)+'%' : '‚Äî'}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;">${r.tag}</td>
          </tr>`;
      }).join('');

      // zoom
      tb.onclick = (e)=>{
        const tr = e.target.closest('tr[data-sec]'); if (!tr) return;
        AR_focus(tr.getAttribute('data-sec'));
      };
    }
    function AR_focus(sec){
      const id = sec4(sec);
      const lyr = window.AT27_AR_LAYERS[id];
      const map = window.AT_CTX?.map || window.map;
      if (!map) return;
      if (lyr){
        try{ map.fitBounds(lyr.getBounds(), {maxZoom:16, padding:[20,20]}); }catch(_){}
        if (lyr.openTooltip) lyr.openTooltip();
        const origFO = lyr.options.fillOpacity ?? .3;
        lyr.setStyle({weight:3, fillOpacity: Math.min(.95, origFO+.25)});
        setTimeout(()=> lyr.setStyle({weight:1, fillOpacity: origFO}), 900);
        return;
      }
      // fallback (por si el overlay no est√°)
      const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];
      const f = feats.find(ft=> sec4(ft.properties?.ID ?? ft.properties?.SECCION ?? ft.properties?.id)===id);
      if (f){ const tmp=L.geoJSON(f); map.fitBounds(tmp.getBounds(), {maxZoom:16, padding:[20,20]}); }
    }

    /* ====== Resumen ====== */
    function AR_renderSummary(perSec){
      const el = document.getElementById('AT27_AR_summary');
      let nAlta=0, nRisk=0, nWatch=0, nOk=0;
      Object.values(perSec).forEach(x=>{
        if (x?.est==='Alta'){ nAlta++; if (x.tag==='RIESGO') nRisk++; else if (x.tag==='VIGILAR') nWatch++; else if (x.tag==='OK') nOk++; }
      });
      el.innerHTML = `
        <div style="font-size:12px; line-height:1.35;">
          Bastiones (estabilidad alta): <b>${nAlta}</b><br>
          <span style="display:inline-block;width:10px;height:10px;background:${AR_COLORS.RIESGO};border-radius:2px;"></span> Riesgo: <b>${nRisk}</b>
          ¬∑ <span style="display:inline-block;width:10px;height:10px;background:${AR_COLORS.VIGILAR};border-radius:2px;"></span> Vigilar: <b>${nWatch}</b>
          ¬∑ <span style="display:inline-block;width:10px;height:10px;background:${AR_COLORS.OK};border-radius:2px;"></span> Sano: <b>${nOk}</b>
        </div>`;
    }

    /* ====== RUN ====== */
    async function AT27_AR_run(){
      if (window.AT27_AR_STATE.running) return;
      window.AT27_AR_STATE.running = true;
      try{
        const puesto  = document.getElementById('AT27_AR_selPuesto').value;
        const meta    = Number(document.getElementById('AT27_AR_meta').value || 50); // %
        const tolDrop = Number(document.getElementById('AT27_AR_tol').value || 0);   // pp (ej. 0 ‚Üí cualquier ca√≠da)

        const secIds = AR_getUniverseSecIds();
        if (!secIds.length){ AR_clear(); document.getElementById('AT27_AR_tbody').innerHTML=''; return; }

        const js   = await AR_load(puesto);
        const per  = AR_compute(js, secIds, puesto, meta, tolDrop);

        AR_buildOverlay(per);
        AR_renderSummary(per);
        AR_renderTable(per);

      }catch(e){
        console.error('AT27_AR_run', e);
        alert('No pude ejecutar ‚ÄúAlertas de riesgo‚Äù.');
      }finally{
        window.AT27_AR_STATE.running = false;
      }
    }

    /* ====== Panel UI ====== */
    function AT27_AR_open(){
      let panel = document.getElementById('AT27_AR_panel');
      if (panel){ panel.style.display='block'; return; }

      panel = document.createElement('div');
      panel.id = 'AT27_AR_panel';
      Object.assign(panel.style,{
        position:'fixed', right:'24px', top:'24px', zIndex:9998,
        width:'560px', maxWidth:'calc(100vw - 40px)', maxHeight:'calc(100vh - 40px)',
        background:'#fff', border:'1px solid #e5e7eb', borderRadius:'14px',
        boxShadow:'0 18px 40px rgba(0,0,0,.18)', display:'flex', flexDirection:'column',
        overflow:'hidden', resize:'both', minWidth:'380px', minHeight:'280px'
      });

      panel.innerHTML = `
        <div id="AT27_AR_hdr" style="cursor:move; user-select:none; background:#ffe4e6; color:#111; padding:10px 12px; display:flex; gap:10px; align-items:center;">
          <div style="font-weight:800;">Alertas de riesgo (bastiones en ca√≠da)</div>
          <button id="AT27_AR_center" style="margin-left:auto; background:#eef2ff; border:1px solid #c7d2fe; border-radius:8px; padding:4px 8px; cursor:pointer;">Recentrar</button>
          <button id="AT27_AR_close" title="Cerrar" style="background:transparent;border:none;font-size:18px;cursor:pointer;">√ó</button>
        </div>

        <div style="padding:10px 12px; display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:end;">
          <label style="font-size:12px;">Puesto<br>
            <select id="AT27_AR_selPuesto" class="ttb-select" style="width:100%;">
              <option value="A">Ayuntamiento</option>
              <option value="DL">Diputado Local</option>
              <option value="DF">Diputado Federal</option>
            </select>
          </label>

          <label style="font-size:12px;">Meta p2027* (%) <span id="AT27_AR_lblMeta" style="opacity:.7;">50%</span>
            <input id="AT27_AR_meta" type="range" min="40" max="70" step="2" value="50" style="width:100%;">
          </label>

          <div style="grid-column:1 / span 2; display:flex; gap:14px; align-items:center; font-size:12px;">
            Tolerancia a ca√≠da (Œî participaci√≥n &lt; ‚àítol):
            <input id="AT27_AR_tol" type="number" value="0" step="0.5" style="width:90px; padding:4px 6px; border:1px solid #e5e7eb; border-radius:8px;">
            <button id="AT27_AR_run" class="ttb-btn ttb-primary" style="margin-left:auto;">Ejecutar</button>
          </div>
        </div>

        <div style="padding:8px 12px;">
          <div id="AT27_AR_legend" style="font-size:12px; display:flex; gap:12px; align-items:center; margin-bottom:6px;">
            <span><span style="display:inline-block;width:10px;height:10px;background:${AR_COLORS.RIESGO};border-radius:2px;"></span> Riesgo (cae y bajo meta)</span>
            <span><span style="display:inline-block;width:10px;height:10px;background:${AR_COLORS.VIGILAR};border-radius:2px;"></span> Vigilar (cae o bajo meta)</span>
            <span><span style="display:inline-block;width:10px;height:10px;background:${AR_COLORS.OK};border-radius:2px;"></span> Sano</span>
          </div>
          <div id="AT27_AR_summary" style="font-size:12px; color:#334155;"></div>
        </div>

        <div style="flex:1; overflow:auto;">
          <table style="width:100%; border-collapse:collapse; font-size:12px;">
            <thead>
              <tr style="position:sticky; top:0; background:#f8fafc;">
                <th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;">Secci√≥n</th>
                <th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;">Basti√≥n</th>
                <th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;">Estabilidad</th>
                <th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;">Œî participaci√≥n 18‚Üí24</th>
                <th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;">p2027*</th>
                <th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;">Alerta</th>
              </tr>
            </thead>
            <tbody id="AT27_AR_tbody"></tbody>
          </table>
        </div>
      `;
      document.body.appendChild(panel);

      const $$ = (sel)=> panel.querySelector(sel);
      $$('#AT27_AR_close').onclick  = ()=> panel.style.display='none';
      $$('#AT27_AR_center').onclick = ()=> (window.AT27_fitUniverseBounds? AT27_fitUniverseBounds() : null);
      $$('#AT27_AR_run').onclick    = ()=>{ window.AT27_AR_STATE.autorun = true; AT27_AR_run(); };
      $$('#AT27_AR_meta').addEventListener('input', ()=> $$('#AT27_AR_lblMeta').textContent = $$('#AT27_AR_meta').value + '%');

      // Drag y bloqueo de eventos al mapa
      (function drag(panelEl, handleEl){
        let sx=0, sy=0, ox=0, oy=0, dragging=false;
        handleEl.addEventListener('mousedown', e=>{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panelEl.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });
        window.addEventListener('mousemove', e=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panelEl.style.left=(ox+dx)+'px'; panelEl.style.top=(oy+dy)+'px'; panelEl.style.right='auto'; });
        window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; });
      })(panel, panel.querySelector('#AT27_AR_hdr'));
      if (window.L && L.DomEvent){ L.DomEvent.disableClickPropagation(panel); L.DomEvent.disableScrollPropagation(panel); }

      // Recalcular si cambias universo (tras primer run)
      const map = window.AT_CTX?.map || window.map;
      if (map && !map.__arBound){
        const deb = (fn,ms=350)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
        map.on('layeradd',    deb(()=>{ if (window.AT27_AR_STATE.autorun) AT27_AR_run(); }));
        map.on('layerremove', deb(()=>{ if (window.AT27_AR_STATE.autorun) AT27_AR_run(); }));
        map.__arBound = true;
      }
    }

</script>


<script>
    // =======================================================
    // GENIALIDAD #6 ¬∑ SIMULADOR DE IMPULSO
    // Suma apoyo a tu partido y estima cu√°ntas secciones adicionales ganas.
    // Modos:
    //   - VOTOS (K global): reparte un presupuesto total de votos K (uniforme / ponderado / solo cercanas).
    //   - PORCENTAJE: incrementa el share del partido en +x% en secciones objetivo.
    // Incluye curva "impulso ‚Üí secciones ganadas", overlay de flips y tabla clic‚Üízoom.
    // Requiere: AT_CTX.map/layer, loadPuesto/getElectData, AT27_GG_project2027, AT27_GG_shares2024,
    //           y (si existe) AT27_GG_getUniverseSecIds().
    // =======================================================

    /* ====== Estado y utilidades ====== */
    window.AT27_SI_STATE   = window.AT27_SI_STATE   || { autorun:false, running:false };
    window.AT27_SI_LAYER   = window.AT27_SI_LAYER   || null;   // overlay
    window.AT27_SI_LAYERS  = window.AT27_SI_LAYERS  || {};     // sec -> layer

    //const sec4   = s => String(s||'').replace(/\D+/g,'').padStart(4,'0');
    //const clamp  = (x,a,b)=> Math.min(b, Math.max(a, x));
    //const fmtInt = x => Number.isFinite(x) ? Math.round(x).toLocaleString() : '‚Äî';
    //const fmtpp  = x => (x===null||x===undefined) ? '‚Äî' : (Number.isFinite(+x) ? ((x>0?'+':'')+(+x).toFixed(1)+' pp') : '‚Äî');

    function SI_getUniverseSecIds(){
      if (typeof AT27_GG_getUniverseSecIds==='function') return AT27_GG_getUniverseSecIds();
      const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];
      return feats.map(f=> sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id));
    }
    async function SI_load(p){ return (window.loadPuesto? loadPuesto(p) : getElectData(p)); }

    /* ====== C√°lculo base 2027 por secci√≥n ======
      Construye base por secci√≥n:
      - Vproj (votos v√°lidos 2027*), vBase por partido (manteniendo shares 2024),
      - ganador base (L, vL), votos del partido X (vX), faltan base, gap (pp). */
    function SI_baseBySec(js, secIds, puesto, partido){
      const X = partido.toUpperCase();
      const out = {}; // sec -> { Vproj, vBase:{}, vX, vL, L, faltan, gapPP }

      for (const sec of secIds){
        const slot = js?.secciones?.[sec4(sec)];
        const row24 = slot?.['2024']; if (!row24) continue;

        const p27 = (typeof AT27_GG_project2027==='function') ? AT27_GG_project2027(slot, puesto) : null;
        const ln24 = Number(row24.LN||0);
        if (p27==null || !ln24) continue;

        const Vproj = ln24 * (p27/100);
        if (!Number.isFinite(Vproj) || Vproj < 1) continue;

        // shares 2024
        const { shares, total:tot24 } = (typeof AT27_GG_shares2024==='function')
          ? AT27_GG_shares2024(row24)
          : (function(){
              let vv = (row24.VOTOS!=null)? Number(row24.VOTOS||0) : 0;
              if (row24.VOTOS==null){ for (const [k,v] of Object.entries(row24)){ if (k==='LN'||k==='VOTOS') continue; vv += Number(v||0); } }
              const sh = {};
              for (const [k,v] of Object.entries(row24)){ if (k==='LN'||k==='VOTOS') continue; sh[k.toUpperCase()] = vv? (Number(v||0)/vv) : 0; }
              return { shares:sh, total:vv };
            })();
        if (!Object.keys(shares).length || !tot24) continue;

        // votos base 2027 (float) por partido
        const vBase = {};
        for (const [sig,sh] of Object.entries(shares)){
          vBase[sig.toUpperCase()] = sh * Vproj;
        }

        let L=null, vL=-1; for (const [sig,vv] of Object.entries(vBase)){ if (vv>vL){ vL=vv; L=sig; } }
        const vX = vBase[X] || 0;

        const faltan = Math.max(0, (vL - vX) + 1);
        const gapPP  = (vL - vX) / Vproj * 100;

        out[sec4(sec)] = { Vproj, vBase, vX, vL, L, faltan, gapPP };
      }
      return out;
    }

    /* ====== Aplicaci√≥n del impulso ======
      - modo='votos': repartir K_total entre secciones target seg√∫n distribuci√≥n.
      - modo='pct': aumentar vX por factor (1 + x) en secciones target. */
    function SI_applyImpulse(base, partido, modo, K_total, xPct, distrib, nearUmbral){
      const X = partido.toUpperCase();
      const keys = Object.keys(base);

      // Target set:
      //   - 'solo-cer' ‚Üí s√≥lo secciones con faltan <= nearUmbral (y que pierdes).
      //   - si no, todas las secciones del universo.
      const target = (distrib==='solo-cer')
        ? keys.filter(s=> base[s].faltan>0 && base[s].faltan <= nearUmbral)
        : keys.slice();

      // Pesos para repartir K_total cuando modo=votos
      let weights = null, sumW=0;
      if (modo==='votos'){
        if (distrib==='ponderado'){
          // mayor peso a faltas peque√±as ‚Üí w = 1 / max(1, faltan)
          weights = {};
          target.forEach(s=>{
            const f = Math.max(1, Math.round(base[s].faltan));
            const w = 1 / f;
            weights[s] = w; sumW += w;
          });
          if (sumW<=0){ weights=null; }
        }else{
          // uniforme (entre target)
          weights = {};
          const w = 1; target.forEach(s=>{ weights[s]=w; }); sumW = w*target.length;
        }
      }

      // Resultado por secci√≥n con impulso aplicado
      const after = {}; // sec -> { vXp, vLp, Lp, flipped:boolean, asignado:number }
      let flips = 0, used = 0;

      for (const s of keys){
        const b = base[s];
        let vXp = b.vX, vLp=b.vL, Lp=b.L, asignado=0;

        if (modo==='votos'){
          if (target.includes(s) && sumW>0 && K_total>0){
            const k_i = K_total * (weights[s] / sumW); // votos asignados a la secci√≥n s
            asignado = k_i;
            vXp = b.vX + k_i;
          }
        }else{
          // porcentaje: aplicar a target (uniforme); si NO est√° en target, no se altera
          if (target.includes(s) && xPct>0){
            vXp = b.vX * (1 + xPct);
          }
        }

        // Recalcular ganador post-impulso (no movemos a los otros partidos)
        if (vXp >= b.vL){ Lp = X; vLp = vXp; }

        const flipped = (b.L!==X && Lp===X);
        if (flipped) flips++;
        used += asignado;

        after[s] = { vXp, Lp, vLp, flipped, asignado };
      }

      return { after, flips, used, targetCount: target.length };
    }

    /* ====== Serie para curva "impulso ‚Üí secciones ganadas" ====== */
    function SI_makeSeries(base, partido, modo, Kmax, steps, xMax, distrib, nearUmbral){
      const pts = [];
      for (let i=0;i<=steps;i++){
        const t = i/steps;
        const K  = (modo==='votos') ? (t*Kmax) : 0;
        const xp = (modo==='pct')   ? (t*xMax) : 0;
        const { flips } = SI_applyImpulse(base, partido, modo, K, xp, distrib, nearUmbral);
        pts.push({ t, K, x:xp, flips });
      }
      return pts;
    }

    /* ====== Overlay ====== */
    function SI_clear(){
      const map = window.AT_CTX?.map || window.map;
      if (!map) return;
      if (window.AT27_SI_LAYER){ try{ map.removeLayer(AT27_SI_LAYER); }catch(_){};
        window.AT27_SI_LAYER=null; }
      window.AT27_SI_LAYERS = {};
    }
    function SI_buildOverlay(base, after, partido){
      const map  = window.AT_CTX?.map || window.map;
      const baseGeo = window.AT_CTX?.layer?.toGeoJSON?.() || window.AT_DATA;
      if (!map || !baseGeo?.features) return;

      SI_clear();

      if (map.createPane && !map.getPane('at27_si_pane')){
        map.createPane('at27_si_pane');
        const p = map.getPane('at27_si_pane'); p.style.zIndex=730; p.style.pointerEvents='auto';
      }

      const feats = baseGeo.features.filter(f=>{
        const id = sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
        return base[id]!=null;
      });

      const PARTY_COL = { PAN:'#3b82f6', PRI:'#ef4444', PVEM:'#16a34a', MORENA:'#7f1d1d', OTRO:'#6b7280' };

      const layer = L.geoJSON({type:'FeatureCollection', features:feats}, {
        pane:'at27_si_pane',
        style: f=>{
          const id = sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
          const b = base[id], a = after[id];
          const flipped = a?.flipped;
          const color = flipped ? '#22c55e' : '#94a3b8'; // verde = volteada; gris = no
          const fo = flipped ? 0.48 : 0.20;
          return { color, fillColor:color, weight:1, opacity:.9, fillOpacity:fo };
        },
        onEachFeature: (feature, lyr)=>{
          const id = sec4(feature.properties?.ID ?? feature.properties?.SECCION ?? feature.properties?.id);
          window.AT27_SI_LAYERS[id] = lyr;

          const b = base[id], a= after[id];
          const faltan0 = Math.max(0, Math.ceil(b.vL - b.vX + 1));
          const mpp0    = b.gapPP;
          const flipped = a?.flipped;
          const tip = `
            <div style="font-size:12px;">
              Secci√≥n <b>${id}</b><br>
              Base 2027*: l√≠der <b>${b.L}</b>, t√∫ <b>${fmtInt(b.vX)}</b>, faltan <b>${fmtInt(faltan0)}</b>, margen <b>${fmtpp(mpp0)}</b><br>
              Con impulso: ${flipped? '<b style="color:#16a34a;">GANADA</b>' : '‚Äî'}
            </div>`;
          lyr.bindTooltip(tip, {sticky:true, opacity:.95, direction:'top', className:'at27-tt'});
          lyr.on('mouseover', ()=>lyr.setStyle({weight:2}));
          lyr.on('mouseout',  ()=>lyr.setStyle({weight:1}));
        }
      });

      layer.addTo(map);
      window.AT27_SI_LAYER = layer;
    }

    /* ====== Tabla + zoom ====== */
    function SI_renderTable(base, after){
      const tb = document.getElementById('AT27_SI_tbody');
      const rows = Object.entries(base).map(([sec,b])=>{
        const a = after[sec];
        const faltan0 = Math.max(0, Math.ceil(b.vL - b.vX + 1));
        return { sec, faltan0, asignado: a?.asignado||0, flipped: !!a?.flipped };
      });

      rows.sort((A,B)=>{
        if (A.flipped!==B.flipped) return (A.flipped? -1:1); // flipped primero
        return (A.faltan0 - B.faltan0) || (Number(A.sec)-Number(B.sec));
      });

      tb.innerHTML = rows.map(r=>{
        const bg = r.flipped? '#dcfce7' : '';
        return `
          <tr data-sec="${r.sec}" style="cursor:pointer; background:${bg};">
            <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;">${r.sec}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;">${fmtInt(r.faltan0)}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9; text-align:right;">${fmtInt(r.asignado)}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;">${r.flipped? 'GANADA' : '‚Äî'}</td>
          </tr>`;
      }).join('');

      tb.onclick = (e)=>{
        const tr = e.target.closest('tr[data-sec]'); if (!tr) return;
        SI_focus(tr.getAttribute('data-sec'));
      };
    }
    function SI_focus(sec){
      const id = sec4(sec);
      const map = window.AT_CTX?.map || window.map;
      const lyr = window.AT27_SI_LAYERS[id];
      if (!map) return;
      if (lyr){
        try{ map.fitBounds(lyr.getBounds(), {maxZoom:16, padding:[20,20]}); }catch(_){}
        if (lyr.openTooltip) lyr.openTooltip();
        const ofo = lyr.options.fillOpacity ?? .3;
        lyr.setStyle({weight:3, fillOpacity: Math.min(.95, ofo+.25)});
        setTimeout(()=> lyr.setStyle({weight:1, fillOpacity:ofo}), 900);
      }
    }

    /* ====== Curva SVG ====== */
    function SI_renderCurve(series, modo, Kmax, xMax){
      const box = document.getElementById('AT27_SI_chart');
      const w = box.clientWidth || 520, h=120, pad=18;
      const maxY = Math.max(1, ...series.map(p=>p.flips));
      const pts = series.map(p=>{
        const x = pad + (w-2*pad) * p.t;
        const y = h - pad - (h-2*pad) * (p.flips/maxY);
        return [x,y];
      });
      const d = pts.map((p,i)=> (i? 'L':'M') + p[0].toFixed(1)+','+p[1].toFixed(1)).join(' ');
      const xLabel = (modo==='votos') ? `K (0 ‚Üí ${fmtInt(Kmax)} votos)` : `Œî share (0 ‚Üí ${(xMax*100).toFixed(1)}%)`;
      box.innerHTML = `
        <svg width="100%" height="${h}" viewBox="0 0 ${w} ${h}">
          <rect x="0" y="0" width="${w}" height="${h}" fill="#f8fafc" rx="8"/>
          <path d="${d}" fill="none" stroke="#0ea5e9" stroke-width="2"/>
          <text x="${w/2}" y="${h-4}" text-anchor="middle" font-size="10" fill="#334155">${xLabel}</text>
          <text x="${pad}" y="12" font-size="10" fill="#334155">Secciones ganadas</text>
        </svg>`;
    }

    /* ====== RUN ====== */
    async function AT27_SI_run(){
      if (window.AT27_SI_STATE.running) return;
      window.AT27_SI_STATE.running = true;
      try{
        const puesto   = document.getElementById('AT27_SI_selPuesto').value;
        const partido  = document.getElementById('AT27_SI_selPartido').value.toUpperCase();
        const modo     = document.querySelector('input[name="AT27_SI_modo"]:checked').value; // votos|pct
        const distrib  = document.getElementById('AT27_SI_distrib').value; // uniforme|ponderado|solo-cer
        const nearUmbral = Number(document.getElementById('AT27_SI_umbral').value || 250);

        const Kmax     = Number(document.getElementById('AT27_SI_K').value || 20000);  // voto presupuesto m√°x
        const steps    = 20; // puntos de la curva
        const xMax     = Number(document.getElementById('AT27_SI_X').value || 0.20);   // 20% share m√°x
        const Kactual  = Number(document.getElementById('AT27_SI_K_now').value || 0);
        const Xactual  = Number(document.getElementById('AT27_SI_X_now').value || 0);

        const secIds = SI_getUniverseSecIds();
        if (!secIds.length){ SI_clear(); document.getElementById('AT27_SI_tbody').innerHTML=''; return; }

        const js   = await SI_load(puesto);
        const base = SI_baseBySec(js, secIds, puesto, partido);

        // Serie
        const serie = SI_makeSeries(base, partido, modo, Kmax, steps, xMax, distrib, nearUmbral);
        SI_renderCurve(serie, modo, Kmax, xMax);

        // Resultado puntual (slider actual)
        const { after, flips, used, targetCount } = SI_applyImpulse(
          base, partido, modo,
          (modo==='votos') ? Kactual : 0,
          (modo==='pct')   ? Xactual : 0,
          distrib, nearUmbral
        );

        // Overlay + tabla + resumen
        SI_buildOverlay(base, after, partido);
        SI_renderTable(base, after);

        const sum = document.getElementById('AT27_SI_summary');
        // Base ganadas (sin impulso)
        let baseWins=0; Object.values(base).forEach(b=>{ if (b.L===partido) baseWins++; });
        sum.innerHTML = `
          <div style="font-size:12px; line-height:1.4;">
            Objetivo: <b>${partido}</b> ‚Äî Universo: <b>${secIds.length}</b> secciones ¬∑ Target: <b>${targetCount}</b><br>
            Ganadas base: <b>${baseWins}</b> ¬∑ Con impulso: <b>${baseWins+flips}</b> (<b>+${flips}</b>)<br>
            ${modo==='votos'
              ? `Presupuesto usado: <b>${fmtInt(used)}</b> (de ${fmtInt(Kactual)})`
              : `Incremento aplicado: <b>${(Xactual*100).toFixed(1)}%</b> en secciones objetivo`}
          </div>`;
      }catch(e){
        console.error('AT27_SI_run', e);
        alert('No pude ejecutar ‚ÄúSimulador de impulso‚Äù.');
      }finally{
        window.AT27_SI_STATE.running = false;
      }
    }

    /* ====== Panel UI ====== */
    function AT27_SI_open(){
      let panel = document.getElementById('AT27_SI_panel');
      if (panel){ panel.style.display='block'; return; }

      panel = document.createElement('div');
      panel.id = 'AT27_SI_panel';
      Object.assign(panel.style,{
        position:'fixed', right:'24px', top:'24px', zIndex:9998,
        width:'620px', maxWidth:'calc(100vw - 40px)', maxHeight:'calc(100vh - 40px)',
        background:'#fff', border:'1px solid #e5e7eb', borderRadius:'14px',
        boxShadow:'0 18px 40px rgba(0,0,0,.18)', display:'flex', flexDirection:'column',
        overflow:'hidden', resize:'both', minWidth:'420px', minHeight:'320px'
      });

      panel.innerHTML = `
        <div id="AT27_SI_hdr" style="cursor:move; user-select:none; background:#ecfeff; color:#111; padding:10px 12px; display:flex; gap:10px; align-items:center;">
          <div style="font-weight:800;">Simulador de impulso</div>
          <button id="AT27_SI_center" style="margin-left:auto; background:#eef2ff; border:1px solid #c7d2fe; border-radius:8px; padding:4px 8px; cursor:pointer;">Recentrar</button>
          <button id="AT27_SI_close" title="Cerrar" style="background:transparent;border:none;font-size:18px;cursor:pointer;">√ó</button>
        </div>

        <div style="padding:10px 12px; display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:end;">
          <label style="font-size:12px;">Puesto<br>
            <select id="AT27_SI_selPuesto" class="ttb-select" style="width:100%;">
              <option value="A">Ayuntamiento</option>
              <option value="DL">Diputado Local</option>
              <option value="DF">Diputado Federal</option>
            </select>
          </label>
          <label style="font-size:12px;">Partido<br>
            <select id="AT27_SI_selPartido" class="ttb-select" style="width:100%;">
              <option>PAN</option><option>PRI</option><option>PVEM</option><option>MORENA</option>
            </select>
          </label>

          <div style="grid-column:1 / span 2; display:flex; gap:16px; align-items:center; font-size:12px;">
            Modo:
            <label><input type="radio" name="AT27_SI_modo" value="votos" checked> votos (K global)</label>
            <label><input type="radio" name="AT27_SI_modo" value="pct"> porcentaje (+x% share)</label>

            <span style="opacity:.7;">Distribuci√≥n:</span>
            <select id="AT27_SI_distrib" class="ttb-select" style="width:160px;">
              <option value="uniforme">Uniforme</option>
              <option value="ponderado">Ponderado por brecha</option>
              <option value="solo-cer">Solo cercanas</option>
            </select>

            <span style="opacity:.7;">Cercanas ‚â§ (faltan)</span>
            <input id="AT27_SI_umbral" type="number" value="250" style="width:90px; padding:4px 6px; border:1px solid #e5e7eb; border-radius:8px;">
          </div>

          <div id="AT27_SI_ctrlVotos" style="grid-column:1 / span 2; display:flex; gap:12px; align-items:center; font-size:12px;">
            Presupuesto K (m√°x)
            <input id="AT27_SI_K" type="number" value="20000" style="width:110px; padding:4px 6px; border:1px solid #e5e7eb; border-radius:8px;">
            K actual
            <input id="AT27_SI_K_now" type="range" min="0" max="20000" step="200" value="600" style="flex:1;">
            <span id="AT27_SI_lblK" style="min-width:70px; text-align:right;">600</span>
          </div>

          <div id="AT27_SI_ctrlPct" style="grid-column:1 / span 2; display:none; gap:12px; align-items:center; font-size:12px;">
            Œî share (m√°x)
            <input id="AT27_SI_X" type="number" value="0.20" step="0.01" style="width:90px; padding:4px 6px; border:1px solid #e5e7eb; border-radius:8px;">
            Œî actual
            <input id="AT27_SI_X_now" type="range" min="0" max="0.20" step="0.005" value="0.02" style="flex:1;">
            <span id="AT27_SI_lblX" style="min-width:70px; text-align:right;">2.0%</span>
          </div>

          <button id="AT27_SI_run" class="ttb-btn ttb-primary" style="grid-column:1 / span 2;">Ejecutar</button>
        </div>

        <div style="padding:8px 12px; display:grid; grid-template-columns: 1fr; gap:6px;">
          <div id="AT27_SI_summary" style="font-size:12px; color:#334155;"></div>
          <div id="AT27_SI_chart" style="width:100%; height:120px;"></div>
        </div>

        <div style="flex:1; overflow:auto;">
          <table style="width:100%; border-collapse:collapse; font-size:12px;">
            <thead>
              <tr style="position:sticky; top:0; background:#f8fafc;">
                <th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;">Secci√≥n</th>
                <th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;">Faltan base</th>
                <th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;">Asignado</th>
                <th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;">Estado</th>
              </tr>
            </thead>
            <tbody id="AT27_SI_tbody"></tbody>
          </table>
        </div>
      `;
      document.body.appendChild(panel);

      // Wire UI
      const $$ = (sel)=> panel.querySelector(sel);
      $$('#AT27_SI_close').onclick  = ()=> panel.style.display='none';
      $$('#AT27_SI_center').onclick = ()=> (window.AT27_fitUniverseBounds? AT27_fitUniverseBounds() : null);
      $$('#AT27_SI_run').onclick    = ()=>{ window.AT27_SI_STATE.autorun = true; AT27_SI_run(); };

      // Sincronizar sliders/inputs
      const syncK = ()=>{
        const Kmax = Number($$('#AT27_SI_K').value||20000);
        const now  = Number($$('#AT27_SI_K_now').value||0);
        $$('#AT27_SI_K_now').max = String(Kmax);
        if (now>Kmax){ $$('#AT27_SI_K_now').value = String(Kmax); }
        $$('#AT27_SI_lblK').textContent = fmtInt(Number($$('#AT27_SI_K_now').value||0));
      };
      const syncX = ()=>{
        const Xmax = Number($$('#AT27_SI_X').value||0.20);
        const now  = Number($$('#AT27_SI_X_now').value||0);
        $$('#AT27_SI_X_now').max = String(Xmax);
        if (now>Xmax){ $$('#AT27_SI_X_now').value = String(Xmax); }
        $$('#AT27_SI_lblX').textContent = (Number($$('#AT27_SI_X_now').value||0)*100).toFixed(1)+'%';
      };
      $$('#AT27_SI_K').addEventListener('input', syncK);
      $$('#AT27_SI_K_now').addEventListener('input', syncK);
      $$('#AT27_SI_X').addEventListener('input', syncX);
      $$('#AT27_SI_X_now').addEventListener('input', syncX);
      syncK(); syncX();

      // Toggle controles por modo
      panel.querySelectorAll('input[name="AT27_SI_modo"]').forEach(r=>{
        r.addEventListener('change', ()=>{
          const modo = panel.querySelector('input[name="AT27_SI_modo"]:checked').value;
          $$('#AT27_SI_ctrlVotos').style.display = (modo==='votos')? 'flex':'none';
          $$('#AT27_SI_ctrlPct').style.display   = (modo==='pct')  ? 'flex':'none';
        });
      });

      // Drag y bloqueo de eventos al mapa
      (function drag(panelEl, handleEl){
        let sx=0, sy=0, ox=0, oy=0, dragging=false;
        handleEl.addEventListener('mousedown', e=>{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panelEl.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });
        window.addEventListener('mousemove', e=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panelEl.style.left=(ox+dx)+'px'; panelEl.style.top=(oy+dy)+'px'; panelEl.style.right='auto'; });
        window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; });
      })(panel, panel.querySelector('#AT27_SI_hdr'));
      if (window.L && L.DomEvent){ L.DomEvent.disableClickPropagation(panel); L.DomEvent.disableScrollPropagation(panel); }

      // Recalcular si cambias universo (tras primer run)
      const map = window.AT_CTX?.map || window.map;
      if (map && !map.__siBound){
        const deb = (fn,ms=350)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
        map.on('layeradd',    deb(()=>{ if (window.AT27_SI_STATE.autorun) AT27_SI_run(); }));
        map.on('layerremove', deb(()=>{ if (window.AT27_SI_STATE.autorun) AT27_SI_run(); }));
        map.__siBound = true;
      }
    }


</script>

<script>
    // =======================================================
    // GENIALIDAD #7 ¬∑ MAPA DE BRECHA RELATIVA VS. ABSOLUTA
    // Muestra, para cada secci√≥n, la brecha:
    //   - ABSOLUTA (votos que faltan para rebasar = faltan)
    //   - RELATIVA (pp = (vL ‚àí vX) / Vproj √ó 100)
    // Colores: Rojo = pierde (intensidad seg√∫n brecha). Gris tenue = gana.
    // Incluye tabla (clic ‚Üí zoom) y se recalcula al cambiar universo.
    // Requiere: AT_CTX.map/layer, loadPuesto/getElectData, AT27_GG_project2027, AT27_GG_shares2024.
    // =======================================================

    /* ====== Estado y utilidades ====== */
    window.AT27_BR_STATE  = window.AT27_BR_STATE  || { autorun:false, running:false };
    window.AT27_BR_LAYER  = window.AT27_BR_LAYER  || null;
    window.AT27_BR_LAYERS = window.AT27_BR_LAYERS || {};   // sec -> layer

    //const sec4   = s => String(s||'').replace(/\D+/g,'').padStart(4,'0');
    //const fmtInt = x => Number.isFinite(x) ? Math.round(x).toLocaleString() : '‚Äî';
    //const fmtpp  = x => (x===null||x===undefined) ? '‚Äî' : (Number.isFinite(+x) ? ((x>0?'+':'')+(+x).toFixed(1)+' pp') : '‚Äî');

    const BR_COLORS = { LOSE:'#ef4444', WIN:'#9ca3af', NA:'#cbd5e1' };

    function BR_getUniverseSecIds(){
      const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];
      return feats.map(f=> sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id));
    }
    async function BR_load(p){ return (window.loadPuesto? loadPuesto(p) : getElectData(p)); }

    /* ====== Base 2027 por secci√≥n ====== */
    
    function BR_baseBySec(js, secIds, puesto, partido){
      const X = partido.toUpperCase();
      const base = {}; // sec -> { Vproj, vX, vL, L, faltan, gapPP }

      // contadores de omisiones
      const stats = {
        total: secIds.length,
        no2024: 0,   // sin fila 2024
        ln0: 0,      // LN=0
        noProj: 0,   // p2027* null
        badVproj: 0, // Vproj < 1 o inv√°lido
        noShares: 0  // no se pudo calcular share 2024
      };

      for (const sec0 of secIds){
        const sec = String(sec0).replace(/\D+/g,'').padStart(4,'0');
        const slot  = AT27_getSecSlot(js, sec);
        const row24 = slot?.['2024'];
        if (!row24){ stats.no2024++; continue; }

        const ln24 = Number(row24.LN||0);
        if (!ln24){ stats.ln0++; continue; }

        const p27  = (typeof AT27_GG_project2027==='function') ? AT27_GG_project2027(slot, puesto) : null;
        if (p27==null){ stats.noProj++; continue; }

        const Vproj = ln24 * (p27/100);
        if (!Number.isFinite(Vproj) || Vproj < 1){ stats.badVproj++; continue; }

        // shares 2024 ‚Üí votos base 2027
        const { shares, total:tot24 } = (typeof AT27_GG_shares2024==='function')
          ? AT27_GG_shares2024(row24)
          : (function(){
              let vv = (row24.VOTOS!=null)? Number(row24.VOTOS||0) : 0;
              if (row24.VOTOS==null){
                for (const [k,v] of Object.entries(row24)){
                  if (k==='LN'||k==='VOTOS') continue;
                  vv += Number(v||0);
                }
              }
              const sh = {};
              for (const [k,v] of Object.entries(row24)){
                if (k==='LN'||k==='VOTOS') continue;
                sh[k.toUpperCase()] = vv? (Number(v||0)/vv) : 0;
              }
              return { shares:sh, total:vv };
            })();

        if (!Object.keys(shares).length || !tot24){ stats.noShares++; continue; }

        let L=null, vL=-1, vX=0;
        for (const [sig,sh] of Object.entries(shares)){
          const vv = sh * Vproj;
          if (sig.toUpperCase()===X) vX = vv;
          if (vv>vL){ vL = vv; L = sig.toUpperCase(); }
        }

        const faltan = Math.max(0, (vL - vX) + 1);
        const gapPP  = (vL - vX) / Vproj * 100;

        base[sec] = { Vproj, vX, vL, L, faltan, gapPP };
      }

      return { base, stats };
    }



    /* ====== Overlay ====== */
    function BR_clear(){
      const map = window.AT_CTX?.map || window.map;
      if (!map) return;
      if (window.AT27_BR_LAYER){ try{ map.removeLayer(AT27_BR_LAYER); }catch(_){};
        window.AT27_BR_LAYER=null; }
      window.AT27_BR_LAYERS = {};
    }

    function BR_buildOverlay(base, modo, cap){
      const map  = window.AT_CTX?.map || window.map;
      const baseGeo = window.AT_CTX?.layer?.toGeoJSON?.() || window.AT_DATA;
      if (!map || !baseGeo?.features) return;

      BR_clear();

      if (map.createPane && !map.getPane('at27_br_pane')){
        map.createPane('at27_br_pane');
        const p = map.getPane('at27_br_pane'); p.style.zIndex=740; p.style.pointerEvents='auto';
      }

      const feats = baseGeo.features.filter(f=>{
        const id = sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
        return base[id]!=null;
      });

      const layer = L.geoJSON({type:'FeatureCollection', features:feats}, {
        pane:'at27_br_pane',
        style: f=>{
          const id = sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
          const b  = base[id];
          if (!b) return { color:BR_COLORS.NA, fillColor:BR_COLORS.NA, weight:1, opacity:.8, fillOpacity:.2 };

          const losing = (b.faltan>0);
          const metric = (modo==='pp') ? Math.max(0, b.gapPP) : Math.max(0, b.faltan);
          const mag    = Math.min(1, metric / Math.max(1, cap)); // 0..1
          const col    = losing ? BR_COLORS.LOSE : BR_COLORS.WIN;
          const fo     = losing ? (0.22 + mag*0.55) : 0.15;
          return { color:col, fillColor:col, weight:1, opacity:.9, fillOpacity:fo };
        },
        onEachFeature: (feature, lyr)=>{
          const id = sec4(feature.properties?.ID ?? feature.properties?.SECCION ?? feature.properties?.id);
          const aliases = [ id, id.padStart(4,'0'), String(Number(id)) ];
          aliases.forEach(k => { window.AT27_BR_LAYERS[k] = lyr; });

          const b = base[id];

          const tip = `
            <div style="font-size:12px;">
              Secci√≥n <b>${id}</b><br>
              ${b.faltan>0? 'Estado: <b>PIERDE</b>' : 'Estado: <b>GANA</b>'}<br>
              Brecha (votos): <b>${fmtInt(b.faltan)}</b><br>
              Brecha (pp): <b>${fmtpp(b.gapPP)}</b>
            </div>`;
          lyr.bindTooltip(tip, {sticky:true, opacity:.95, direction:'top', className:'at27-tt'});
          lyr.on('mouseover', ()=>lyr.setStyle({weight:2}));
          lyr.on('mouseout',  ()=>lyr.setStyle({weight:1}));
        }
      });

      layer.addTo(map);
      window.AT27_BR_LAYER = layer;
    }

    /* ====== Tabla + resumen ====== */
    function BR_renderTable(base, modo){
      const tb = document.getElementById('AT27_BR_tbody');
      const rows = Object.entries(base).map(([sec,b])=>{
        return {
          sec,
          estado: b.faltan>0 ? 'PIERDE' : 'GANA',
          faltan: Math.ceil(Math.max(0,b.faltan)),
          gapPP:  b.gapPP
        };
      });

      // Orden: primero PIERDE por mayor brecha (seg√∫n modo), luego GANA por menor margen.
      rows.sort((a,b)=>{
        const aKey = (a.estado==='PIERDE')? 0 : 1;
        const bKey = (b.estado==='PIERDE')? 0 : 1;
        if (aKey!==bKey) return aKey-bKey;
        if (a.estado==='PIERDE'){
          return (modo==='pp' ? (b.gapPP - a.gapPP) : (b.faltan - a.faltan)) || (Number(a.sec)-Number(b.sec));
        }else{
          // ganadas: margen menor primero ‚Üí gapPP asc
          return (a.gapPP - b.gapPP) || (Number(a.sec)-Number(b.sec));
        }
      });

      tb.innerHTML = rows.map(r=>{
        const bg = r.estado==='PIERDE' ? '#fee2e2' : '#f1f5f9';
        const metr = (modo==='pp') ? fmtpp(r.gapPP) : fmtInt(r.faltan);
        return `
          <tr data-sec="${r.sec}" style="cursor:pointer; background:${bg};">
            <td style="padding:6px 8px; border-bottom:1px solid #e5e7eb;">${r.sec}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #e5e7eb;">${r.estado}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #e5e7eb; text-align:right;">${metr}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #e5e7eb; text-align:right;">${fmtInt(r.faltan)}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #e5e7eb; text-align:right;">${fmtpp(r.gapPP)}</td>
          </tr>`;
      }).join('');

      tb.onclick = (e)=>{
        const tr = e.target.closest('tr[data-sec]'); if (!tr) return;
        BR_focus(tr.getAttribute('data-sec'));
      };
    }


      // --- REEMPLAZA TODO EL CUERPO DE BR_renderSummary POR ESTE ---
      function BR_renderSummary(base, modo, stats){
        const el = document.getElementById('AT27_BR_summary');
        let pierde=0, gana=0, maxF=0, maxPP=0;
        Object.values(base).forEach(b=>{
          if (b.faltan>0){
            pierde++;
            if (b.faltan>maxF) maxF=b.faltan;
            if (b.gapPP>maxPP) maxPP=b.gapPP;
          } else {
            gana++;
          }
        });

        const omitidas = (stats?.no2024||0) + (stats?.ln0||0) + (stats?.noProj||0) + (stats?.badVproj||0) + (stats?.noShares||0);
        const nota = omitidas>0
          ? `<div style="margin-top:4px; color:#b45309; font-size:11px;">
              Omitidas: <b>${omitidas}</b> de ${stats?.total||'?'} 
              <span title="Sin 2024: ${stats?.no2024||0}\nLN=0: ${stats?.ln0||0}\np2027* nula: ${stats?.noProj||0}\nVproj inv√°lida: ${stats?.badVproj||0}\nSin shares 2024: ${stats?.noShares||0}">(detalle)</span>
            </div>`
          : '';

        el.innerHTML = `
          <div style="font-size:12px; line-height:1.35;">
            Secciones: <b>${pierde+gana}</b> ¬∑ Pierde: <b>${pierde}</b> ¬∑ Gana: <b>${gana}</b><br>
            M√°xima brecha: <b>${Math.round(maxF).toLocaleString()}</b> votos ¬∑ <b>${(maxPP>0? '+' : '')+maxPP.toFixed(1)} pp</b>
            ${nota}
          </div>`;
      }



    function BR_focus(sec){
      const id = sec4(sec);
      const map = window.AT_CTX?.map || window.map;
      const lyr = window.AT27_BR_LAYERS[id];
      if (!map) return;
      if (lyr){
        try{ map.fitBounds(lyr.getBounds(), {maxZoom:16, padding:[20,20]}); }catch(_){}
        if (lyr.openTooltip) lyr.openTooltip();
        const ofo = lyr.options.fillOpacity ?? .3;
        lyr.setStyle({weight:3, fillOpacity: Math.min(.95, ofo+.25)});
        setTimeout(()=> lyr.setStyle({weight:1, fillOpacity:ofo}), 900);
      }
    }

    /* ====== RUN ====== */
    async function AT27_BR_run(){
      if (window.AT27_BR_STATE.running) return;
      window.AT27_BR_STATE.running = true;
      try{
        const puesto  = document.getElementById('AT27_BR_selPuesto').value;
        const partido = document.getElementById('AT27_BR_selPartido').value.toUpperCase();
        const modo    = document.querySelector('input[name="AT27_BR_modo"]:checked').value; // votos | pp
        const cap     = Number(document.getElementById('AT27_BR_cap').value || (modo==='pp'? 10 : 1000));

        const secIds = BR_getUniverseSecIds();
        if (!secIds.length){ BR_clear(); document.getElementById('AT27_BR_tbody').innerHTML=''; return; }

        const js   = await BR_load(puesto);


        // --- S√ìLO ESTE FRAGMENTO DENTRO DE AT27_BR_run ---
        const { base, stats } = BR_baseBySec(js, secIds, puesto, partido);

        BR_buildOverlay(base, modo, cap);
        BR_renderSummary(base, modo, stats);   // <-- ahora recibe stats
        BR_renderTable(base, modo);

      }catch(e){
        console.error('AT27_BR_run', e);
        alert('No pude ejecutar ‚ÄúBrecha pp/votos‚Äù.');
      }finally{
        window.AT27_BR_STATE.running = false;
      }
    }

    /* ====== Panel UI ====== */
    function AT27_BR_open(){
      let panel = document.getElementById('AT27_BR_panel');
      if (panel){ panel.style.display='block'; return; }

      panel = document.createElement('div');
      panel.id = 'AT27_BR_panel';
      Object.assign(panel.style,{
        position:'fixed', right:'24px', top:'24px', zIndex:9998,
        width:'560px', maxWidth:'calc(100vw - 40px)', maxHeight:'calc(100vh - 40px)',
        background:'#fff', border:'1px solid #e5e7eb', borderRadius:'14px',
        boxShadow:'0 18px 40px rgba(0,0,0,.18)', display:'flex', flexDirection:'column',
        overflow:'hidden', resize:'both', minWidth:'380px', minHeight:'280px'
      });

      panel.innerHTML = `
        <div id="AT27_BR_hdr" style="cursor:move; user-select:none; background:#f8fafc; color:#111; padding:10px 12px; display:flex; gap:10px; align-items:center;">
          <div style="font-weight:800;">Mapa de brecha (pp / votos)</div>
          <button id="AT27_BR_center" style="margin-left:auto; background:#eef2ff; border:1px solid #c7d2fe; border-radius:8px; padding:4px 8px; cursor:pointer;">Recentrar</button>
          <button id="AT27_BR_close" title="Cerrar" style="background:transparent;border:none;font-size:18px;cursor:pointer;">√ó</button>
        </div>

        <div style="padding:10px 12px; display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:end;">
          <label style="font-size:12px;">Puesto<br>
            <select id="AT27_BR_selPuesto" class="ttb-select" style="width:100%;">
              <option value="A">Ayuntamiento</option>
              <option value="DL">Diputado Local</option>
              <option value="DF">Diputado Federal</option>
            </select>
          </label>
          <label style="font-size:12px;">Partido<br>
            <select id="AT27_BR_selPartido" class="ttb-select" style="width:100%;">
              <option>PAN</option><option>PRI</option><option>PVEM</option><option>MORENA</option>
            </select>
          </label>

          <div style="grid-column:1 / span 2; display:flex; gap:16px; align-items:center; font-size:12px;">
            Modo:
            <label><input type="radio" name="AT27_BR_modo" value="votos" checked> votos</label>
            <label><input type="radio" name="AT27_BR_modo" value="pp"> pp</label>
            <span style="opacity:.7;">¬∑ Cap color</span>
            <input id="AT27_BR_cap" type="number" value="1000" style="width:90px; padding:4px 6px; border:1px solid #e5e7eb; border-radius:8px;">
          </div>

          <button id="AT27_BR_run" class="ttb-btn ttb-primary" style="grid-column:1 / span 2;">Ejecutar</button>
        </div>

        <div style="padding:8px 12px;">
          <div id="AT27_BR_legend" style="font-size:12px; display:flex; gap:12px; align-items:center; margin-bottom:6px;">
            <span><span style="display:inline-block;width:10px;height:10px;background:${BR_COLORS.LOSE};border-radius:2px;"></span> Pierde (intensidad = brecha)</span>
            <span><span style="display:inline-block;width:10px;height:10px;background:${BR_COLORS.WIN};border-radius:2px;"></span> Gana</span>
          </div>
          <div id="AT27_BR_summary" style="font-size:12px; color:#334155;"></div>
        </div>

        <div style="flex:1; overflow:auto;">
          <table style="width:100%; border-collapse:collapse; font-size:12px;">
            <thead>
              <tr style="position:sticky; top:0; background:#f8fafc;">
                <th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;">Secci√≥n</th>
                <th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;">Estado</th>
                <th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;">Brecha (seg√∫n modo)</th>
                <th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;">Faltan (votos)</th>
                <th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;">Brecha (pp)</th>
              </tr>
            </thead>
            <tbody id="AT27_BR_tbody"></tbody>
          </table>
        </div>
      `;
      document.body.appendChild(panel);

      // Wire UI
      const $$ = (sel)=> panel.querySelector(sel);
      $$('#AT27_BR_close').onclick  = ()=> panel.style.display='none';
      $$('#AT27_BR_center').onclick = ()=> (window.AT27_fitUniverseBounds? AT27_fitUniverseBounds() : null);
      $$('#AT27_BR_run').onclick    = ()=>{ window.AT27_BR_STATE.autorun = true; AT27_BR_run(); };

      // Cambiar cap por modo (sugerencias)
      panel.querySelectorAll('input[name="AT27_BR_modo"]').forEach(r=>{
        r.addEventListener('change', ()=>{
          const modo = panel.querySelector('input[name="AT27_BR_modo"]:checked').value;
          if (modo==='pp' && Number($$('#AT27_BR_cap').value)>50) $$('#AT27_BR_cap').value = 10;
          if (modo==='votos' && Number($$('#AT27_BR_cap').value)<50) $$('#AT27_BR_cap').value = 1000;
        });
      });

      // Drag + bloqueo eventos al mapa
      (function drag(panelEl, handleEl){
        let sx=0, sy=0, ox=0, oy=0, dragging=false;
        handleEl.addEventListener('mousedown', e=>{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panelEl.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });
        window.addEventListener('mousemove', e=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panelEl.style.left=(ox+dx)+'px'; panelEl.style.top=(oy+dy)+'px'; panelEl.style.right='auto'; });
        window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; });
      })(panel, panel.querySelector('#AT27_BR_hdr'));
      if (window.L && L.DomEvent){ L.DomEvent.disableClickPropagation(panel); L.DomEvent.disableScrollPropagation(panel); }

      // Recalcular si cambias universo (tras primer run)
      const map = window.AT_CTX?.map || window.map;
      if (map && !map.__brBound){
        const deb = (fn,ms=350)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
        map.on('layeradd',    deb(()=>{ if (window.AT27_BR_STATE.autorun) AT27_BR_run(); }));
        map.on('layerremove', deb(()=>{ if (window.AT27_BR_STATE.autorun) AT27_BR_run(); }));
        map.__brBound = true;
      }
    }


</script>


<script>
    // =======================================================
    // GENIALIDAD #8 ¬∑ SENSIBILIDAD A PARTICIPACI√ìN
    // ¬øQu√© cambia si la participaci√≥n 2027* sube/baja ¬±Œ¥ pp?
    // Verde: la secci√≥n voltea a tu favor | Rojo: voltea en contra | Gris: sin cambio.
    // Requiere: AT_CTX.map/layer, loadPuesto/getElectData, AT27_GG_project2027, AT27_GG_shares2024.
    // (Opcional) AT27_GG_getUniverseSecIds para obtener universo actual.
    // =======================================================

    /* ====== Estado y utilidades ====== */
    window.AT27_SP_STATE  = window.AT27_SP_STATE  || { autorun:false, running:false };
    window.AT27_SP_LAYER  = window.AT27_SP_LAYER  || null;
    window.AT27_SP_LAYERS = window.AT27_SP_LAYERS || {};   // sec -> layer

    //const sec4   = s => String(s||'').replace(/\D+/g,'').padStart(4,'0');
    //const clamp  = (x,a,b)=> Math.min(b, Math.max(a, x));
    //const fmtInt = x => Number.isFinite(x) ? Math.round(x).toLocaleString() : '‚Äî';
    //const fmtpp  = x => (x===null||x===undefined) ? '‚Äî' : (Number.isFinite(+x) ? ((x>0?'+':'')+(+x).toFixed(1)+' pp') : '‚Äî');

    const SP_COL = { FAVOR:'#22c55e', CONTRA:'#ef4444', NC:'#cbd5e1' };

    function SP_getUniverseSecIds(){
      if (typeof AT27_GG_getUniverseSecIds==='function') return AT27_GG_getUniverseSecIds();
      const feats = (window.AT_CTX?.layer?.toGeoJSON?.().features) || (window.AT_DATA?.features) || [];
      return feats.map(f=> sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id));
    }
    async function SP_load(p){ return (window.loadPuesto? loadPuesto(p) : getElectData(p)); }

    /* ====== Helpers shares 2024 ====== */
    function SHARES_2024(row24){
      if (typeof AT27_GG_shares2024==='function') return AT27_GG_shares2024(row24);
      // fallback simple
      let vv = (row24?.VOTOS!=null)? Number(row24.VOTOS||0) : 0;
      if (row24 && row24.VOTOS==null){ for (const [k,v] of Object.entries(row24)){ if (k==='LN'||k==='VOTOS') continue; vv += Number(v||0); } }
      const sh = {};
      if (row24){
        for (const [k,v] of Object.entries(row24)){ if (k==='LN'||k==='VOTOS') continue; sh[k.toUpperCase()] = vv? (Number(v||0)/vv) : 0; }
      }
      return { shares: sh, total: vv };
    }

    /* ====== Base y escenario con delta ====== */
    function SP_compute(js, secIds, puesto, partido, deltaPP){
      const X = partido.toUpperCase();
      const bySec = {}; // sec -> { L0, vL0, vX0, gap0, p27, p27d, Ld, vLd, vXd, gapd, flip:'FAVOR'|'CONTRA'|'NC' }

      for (const s of secIds){
        const slot = js?.secciones?.[sec4(s)];
        const row24 = slot?.['2024']; if (!row24) continue;

        const ln24 = Number(row24.LN||0);
        const p27  = (typeof AT27_GG_project2027==='function') ? AT27_GG_project2027(slot, puesto) : null;
        if (!ln24 || p27==null) continue;

        const { shares, total:vv24 } = SHARES_2024(row24);
        if (!Object.keys(shares).length || !vv24) continue;

        // base
        const V0 = ln24 * (p27/100);
        if (!Number.isFinite(V0) || V0<1) continue;

        let L0=null, vL0=-1, vX0=0;
        for (const [sig,sh] of Object.entries(shares)){
          const v = sh*V0;
          if (sig.toUpperCase()===X) vX0 = v;
          if (v>vL0){ vL0=v; L0=sig.toUpperCase(); }
        }
        const gap0 = (vL0 - vX0) / V0 * 100; // pp (>=0 si L0 ‚â† X)

        // escenario con delta (aditivo en puntos a p27)
        const p27d = clamp(p27 + deltaPP, 5, 90);
        const Vd   = ln24 * (p27d/100);

        let Ld=null, vLd=-1, vXd=0;
        for (const [sig,sh] of Object.entries(shares)){
          const v = sh*Vd;
          if (sig.toUpperCase()===X) vXd = v;
          if (v>vLd){ vLd=v; Ld=sig.toUpperCase(); }
        }
        const gapd = (vLd - vXd) / Vd * 100;

        let flip='NC';
        if (L0!==Ld){
          // cambi√≥ de ganador
          flip = (Ld===X) ? 'FAVOR' : (L0===X ? 'CONTRA' : (Ld===X ? 'FAVOR' : 'CONTRA'));
        }

        bySec[sec4(s)] = { L0, vL0, vX0, gap0, p27, p27d, Ld, vLd, vXd, gapd, flip };
      }
      return bySec;
    }

    /* ====== Overlay ====== */
    function SP_clear(){
      const map = window.AT_CTX?.map || window.map;
      if (!map) return;
      if (window.AT27_SP_LAYER){ try{ map.removeLayer(AT27_SP_LAYER); }catch(_){};
        window.AT27_SP_LAYER=null; }
      window.AT27_SP_LAYERS = {};
    }

    function SP_buildOverlay(perSec, filtro){
      const map  = window.AT_CTX?.map || window.map;
      const base = window.AT_CTX?.layer?.toGeoJSON?.() || window.AT_DATA;
      if (!map || !base?.features) return;

      SP_clear();

      if (map.createPane && !map.getPane('at27_sp_pane')){
        map.createPane('at27_sp_pane');
        const p = map.getPane('at27_sp_pane'); p.style.zIndex=750; p.style.pointerEvents='auto';
      }

      const feats = base.features.filter(f=>{
        const id = sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
        const x = perSec[id]; if (!x) return false;
        return (filtro==='TODOS') ? true : (x.flip===filtro);
      });

      const layer = L.geoJSON({type:'FeatureCollection', features:feats}, {
        pane:'at27_sp_pane',
        style: f=>{
          const id = sec4(f.properties?.ID ?? f.properties?.SECCION ?? f.properties?.id);
          const x  = perSec[id];
          const col = x.flip==='FAVOR' ? SP_COL.FAVOR : (x.flip==='CONTRA' ? SP_COL.CONTRA : SP_COL.NC);
          const fo  = (x.flip==='NC') ? .18 : .45;
          return { color:col, fillColor:col, weight:1, opacity:.9, fillOpacity:fo };
        },
        onEachFeature: (feature, lyr)=>{
          const id = sec4(feature.properties?.ID ?? feature.properties?.SECCION ?? feature.properties?.id);
          window.AT27_SP_LAYERS[id] = lyr;
          const x = perSec[id];
          const tip = `
            <div style="font-size:12px;">
              Secci√≥n <b>${id}</b><br>
              Base: <b>${x.L0}</b> (margen ${fmtpp(x.gap0)}) ¬∑ p2027*: <b>${x.p27?.toFixed(1)||'‚Äî'}%</b><br>
              Con Œîp: <b>${x.Ld}</b> (margen ${fmtpp(x.gapd)}) ¬∑ p' = <b>${x.p27d?.toFixed(1)||'‚Äî'}%</b><br>
              Cambio: <b>${x.flip}</b>
            </div>`;
          lyr.bindTooltip(tip, {sticky:true, opacity:.95, direction:'top', className:'at27-tt'});
          lyr.on('mouseover', ()=>lyr.setStyle({weight:2}));
          lyr.on('mouseout',  ()=>lyr.setStyle({weight:1}));
        }
      });

      layer.addTo(map);
      window.AT27_SP_LAYER = layer;
    }

    /* ====== Tabla + resumen ====== */
    function SP_renderTable(perSec, filtro){
      const tb = document.getElementById('AT27_SP_tbody');
      let rows = Object.entries(perSec).map(([sec,x])=>({
        sec, L0:x.L0, Ld:x.Ld, gap0:x.gap0, gapd:x.gapd, flip:x.flip
      }));
      if (filtro!=='TODOS') rows = rows.filter(r=> r.flip===filtro);

      // orden: FAVOR primero (por |gapd| m√°s justo), luego CONTRA, luego NC
      const keyRank = t => t==='FAVOR'?0 : (t==='CONTRA'?1:2);
      rows.sort((a,b)=> (keyRank(a.flip)-keyRank(b.flip))
                        || (Math.abs(a.gapd)-Math.abs(b.gapd))
                        || (Number(a.sec)-Number(b.sec)));

      tb.innerHTML = rows.map(r=>{
        const bg = r.flip==='FAVOR' ? '#dcfce7' : (r.flip==='CONTRA' ? '#fee2e2' : '');
        return `
          <tr data-sec="${r.sec}" style="cursor:pointer; background:${bg};">
            <td style="padding:6px 8px; border-bottom:1px solid #e5e7eb;">${r.sec}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #e5e7eb;">${r.L0}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #e5e7eb;">${r.Ld}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #e5e7eb; text-align:right;">${fmtpp(r.gap0)}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #e5e7eb; text-align:right;">${fmtpp(r.gapd)}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #e5e7eb;">${r.flip}</td>
          </tr>`;
      }).join('');

      tb.onclick = (e)=>{
        const tr = e.target.closest('tr[data-sec]'); if (!tr) return;
        SP_focus(tr.getAttribute('data-sec'));
      };
    }

    function SP_renderSummary(perSec){
      const el = document.getElementById('AT27_SP_summary');
      let fav=0, contra=0, nc=0;
      Object.values(perSec).forEach(x=>{
        if (x.flip==='FAVOR') fav++;
        else if (x.flip==='CONTRA') contra++;
        else nc++;
      });
      el.innerHTML = `
        <div style="font-size:12px; line-height:1.35;">
          Cambios con Œîp: <b>${fav+contra}</b> ¬∑ A favor: <b style="color:${SP_COL.FAVOR}">${fav}</b>
          ¬∑ En contra: <b style="color:${SP_COL.CONTRA}">${contra}</b> ¬∑ Sin cambio: <b>${nc}</b>
        </div>`;
    }

    function SP_focus(sec){
      const id = sec4(sec);
      const map = window.AT_CTX?.map || window.map;
      const lyr = window.AT27_SP_LAYERS[id];
      if (!map) return;
      if (lyr){
        try{ map.fitBounds(lyr.getBounds(), {maxZoom:16, padding:[20,20]}); }catch(_){}
        if (lyr.openTooltip) lyr.openTooltip();
        const ofo = lyr.options.fillOpacity ?? .3;
        lyr.setStyle({weight:3, fillOpacity: Math.min(.95, ofo+.25)});
        setTimeout(()=> lyr.setStyle({weight:1, fillOpacity:ofo}), 900);
      }
    }

    /* ====== RUN ====== */
    async function AT27_SP_run(){
      if (window.AT27_SP_STATE.running) return;
      window.AT27_SP_STATE.running = true;
      try{
        const puesto  = document.getElementById('AT27_SP_selPuesto').value;
        const partido = document.getElementById('AT27_SP_selPartido').value.toUpperCase();
        const delta   = Number(document.getElementById('AT27_SP_delta').value || 0); // ¬±pp
        const filtro  = document.getElementById('AT27_SP_filtro').value; // TODOS|FAVOR|CONTRA

        const secIds = AT27_getUniverseSecIds();
        if (!secIds.length){ SP_clear(); document.getElementById('AT27_SP_tbody').innerHTML=''; return; }

        const js   = await SP_load(puesto);
        const per  = SP_compute(js, secIds, puesto, partido, delta);

        SP_buildOverlay(per, filtro);
        SP_renderSummary(per);
        SP_renderTable(per, filtro);

      }catch(e){
        console.error('AT27_SP_run', e);
        alert('No pude ejecutar ‚ÄúSensibilidad a participaci√≥n‚Äù.');
      }finally{
        window.AT27_SP_STATE.running = false;
      }
    }

    /* ====== Panel UI ====== */
    function AT27_SP_open(){
      let panel = document.getElementById('AT27_SP_panel');
      if (panel){ panel.style.display='block'; return; }

      panel = document.createElement('div');
      panel.id = 'AT27_SP_panel';
      Object.assign(panel.style,{
        position:'fixed', right:'24px', top:'24px', zIndex:9998,
        width:'560px', maxWidth:'calc(100vw - 40px)', maxHeight:'calc(100vh - 40px)',
        background:'#fff', border:'1px solid #e5e7eb', borderRadius:'14px',
        boxShadow:'0 18px 40px rgba(0,0,0,.18)', display:'flex', flexDirection:'column',
        overflow:'hidden', resize:'both', minWidth:'380px', minHeight:'280px'
      });

      panel.innerHTML = `
        <div id="AT27_SP_hdr" style="cursor:move; user-select:none; background:#fff7ed; color:#111; padding:10px 12px; display:flex; gap:10px; align-items:center;">
          <div style="font-weight:800;">Sensibilidad a participaci√≥n (¬±pp)</div>
          <button id="AT27_SP_center" style="margin-left:auto; background:#eef2ff; border:1px solid #c7d2fe; border-radius:8px; padding:4px 8px; cursor:pointer;">Recentrar</button>
          <button id="AT27_SP_close" title="Cerrar" style="background:transparent;border:none;font-size:18px;cursor:pointer;">√ó</button>
        </div>

        <div style="padding:10px 12px; display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:end;">
          <label style="font-size:12px;">Puesto<br>
            <select id="AT27_SP_selPuesto" class="ttb-select" style="width:100%;">
              <option value="A">Ayuntamiento</option>
              <option value="DL">Diputado Local</option>
              <option value="DF">Diputado Federal</option>
            </select>
          </label>
          <label style="font-size:12px;">Partido<br>
            <select id="AT27_SP_selPartido" class="ttb-select" style="width:100%;">
              <option>PAN</option><option>PRI</option><option>PVEM</option><option>MORENA</option>
            </select>
          </label>

          <div style="grid-column:1 / span 2; display:flex; gap:14px; align-items:center; font-size:12px;">
            Œî participaci√≥n (pp) 
            <input id="AT27_SP_delta" type="range" min="-8" max="8" step="0.5" value="2" style="flex:1;">
            <span id="AT27_SP_lblDelta" style="width:60px; text-align:right;">+2.0 pp</span>
            <span style="opacity:.7;">Filtrar:</span>
            <select id="AT27_SP_filtro" class="ttb-select">
              <option value="TODOS">Todos</option>
              <option value="FAVOR">Solo a favor</option>
              <option value="CONTRA">Solo en contra</option>
            </select>
            <button id="AT27_SP_run" class="ttb-btn ttb-primary" style="margin-left:auto;">Ejecutar</button>
          </div>
        </div>

        <div style="padding:8px 12px;">
          <div id="AT27_SP_legend" style="font-size:12px; display:flex; gap:12px; align-items:center; margin-bottom:6px;">
            <span><span style="display:inline-block;width:10px;height:10px;background:${SP_COL.FAVOR};border-radius:2px;"></span> Voltea a tu favor</span>
            <span><span style="display:inline-block;width:10px;height:10px;background:${SP_COL.CONTRA};border-radius:2px;"></span> Voltea en contra</span>
            <span><span style="display:inline-block;width:10px;height:10px;background:${SP_COL.NC};border-radius:2px;"></span> Sin cambio</span>
          </div>
          <div id="AT27_SP_summary" style="font-size:12px; color:#334155;"></div>
        </div>

        <div style="flex:1; overflow:auto;">
          <table style="width:100%; border-collapse:collapse; font-size:12px;">
            <thead>
              <tr style="position:sticky; top:0; background:#f8fafc;">
                <th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;">Secci√≥n</th>
                <th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;">Ganador base</th>
                <th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;">Ganador con Œîp</th>
                <th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;">Margen base</th>
                <th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0;">Margen Œîp</th>
                <th style="text-align:left;  padding:6px 8px; border-bottom:1px solid #e2e8f0;">Cambio</th>
              </tr>
            </thead>
            <tbody id="AT27_SP_tbody"></tbody>
          </table>
        </div>
      `;
      document.body.appendChild(panel);

      // Wiring UI
      const $$ = (sel)=> panel.querySelector(sel);
      $$('#AT27_SP_close').onclick  = ()=> panel.style.display='none';
      $$('#AT27_SP_center').onclick = ()=> (window.AT27_fitUniverseBounds? AT27_fitUniverseBounds() : null);
      $$('#AT27_SP_run').onclick    = ()=>{ window.AT27_SP_STATE.autorun = true; AT27_SP_run(); };

      // Sync etiqueta del slider
      const syncŒî = ()=>{
        const v = Number($$('#AT27_SP_delta').value||0);
        $$('#AT27_SP_lblDelta').textContent = (v>=0? '+' : '') + v.toFixed(1) + ' pp';
      };
      $$('#AT27_SP_delta').addEventListener('input', syncŒî);
      syncŒî();

      // Drag + bloqueo eventos al mapa
      (function drag(panelEl, handleEl){
        let sx=0, sy=0, ox=0, oy=0, dragging=false;
        handleEl.addEventListener('mousedown', e=>{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panelEl.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });
        window.addEventListener('mousemove', e=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panelEl.style.left=(ox+dx)+'px'; panelEl.style.top=(oy+dy)+'px'; panelEl.style.right='auto'; });
        window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; });
      })(panel, panel.querySelector('#AT27_SP_hdr'));
      if (window.L && L.DomEvent){ L.DomEvent.disableClickPropagation(panel); L.DomEvent.disableScrollPropagation(panel); }

      // Recalcular si cambias universo (tras primer run)
      const map = window.AT_CTX?.map || window.map;
      if (map && !map.__spBound){
        const deb = (fn,ms=350)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
        map.on('layeradd',    deb(()=>{ if (window.AT27_SP_STATE.autorun) AT27_SP_run(); }));
        map.on('layerremove', deb(()=>{ if (window.AT27_SP_STATE.autorun) AT27_SP_run(); }));
        map.__spBound = true;
      }
    }


</script>






<script>
  // ========== GANAR TODO ¬∑ AYUDA (AT27_GT_HELP_) ==========
  function AT27_GT_HELP_open(){
    let panel = document.getElementById('AT27_GT_help');
    if (panel){ panel.style.display='block'; clampToViewport(panel); return; }

    panel = document.createElement('div');
    panel.id = 'AT27_GT_help';
    Object.assign(panel.style,{
      position:'fixed', right:'24px', top:'24px', zIndex:9999,
      width: Math.min(560, window.innerWidth - 64) + 'px',
      maxWidth:'calc(100vw - 48px)', maxHeight:'calc(100vh - 48px)',
      background:'#fff', border:'1px solid #e5e7eb', borderRadius:'14px',
      boxShadow:'0 18px 40px rgba(0,0,0,.18)', overflow:'hidden',
      display:'flex', flexDirection:'column', resize:'both',
      minWidth:'380px', minHeight:'280px'
    });

    panel.innerHTML = `
      <div id="AT27_GT_help_hdr" style="cursor:move; user-select:none; background:#f0f9ff; color:#111; padding:10px 12px; display:flex; gap:10px; align-items:center;">
        <div style="font-weight:800;">‚ÑπÔ∏è Minimanual ‚Äî Ganar Todo</div>
        <button id="AT27_GT_help_close" title="Cerrar" style="margin-left:auto;background:transparent;color:#111;border:none;font-size:18px;cursor:pointer;">√ó</button>
      </div>
      <div id="AT27_GT_help_body" style="padding:12px 14px; flex:1; overflow:auto; font-family:system-ui,Segoe UI,Roboto,Arial; color:#111;">
        <p style="margin:0 0 10px; color:#475569; font-size:13px;">
          Consultas a nivel <b>universo</b> (estado/municipio/DF/DL) con drill-down a secci√≥n. Se recalculan con el universo visible.
        </p>

        <details open style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;">
          <summary style="cursor:pointer; font-weight:700;">Metas de participaci√≥n 2027*</summary>
          <div style="margin-top:8px; font-size:13px; color:#334155;">
            <b>Qu√© muestra:</b> si cada secci√≥n <b>cumple</b> una <b>meta</b> de participaci√≥n 2027* (verde), est√° <b>cerca</b> (amarillo) o <b>debajo</b> (rojo).<br>
            <b>C√≥mputo:</b> p2027* por regresi√≥n ponderada 2018/2021/2024; meta y tolerancia ajustables.<br>
            <b>C√≥mo leerlo:</b> prioriza ‚ÄúNear‚Äù; revisa promedio ponderado por LN 2024.<br>
            <b>Notas:</b> proyecci√≥n conservadora si faltan a√±os.
          </div>
        </details>

        <details style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;">
          <summary style="cursor:pointer; font-weight:700;">¬øQu√© se requiere para ganar todo? (brecha 2027)</summary>
          <div style="margin-top:8px; font-size:13px; color:#334155;">
            <b>Qu√© muestra:</b> para un <i>partido</i> y <i>puesto</i>, colorea por <b>ganador proyectado 2027*</b> (PAN=azul, PRI=rojo, PVEM=verde, MORENA=guinda) y lista por secci√≥n:
            <b>ganador</b>, <b>votos del l√≠der</b>, <b>faltan</b> y <b>swing</b>.<br>
            <b>C√≥mputo:</b> Vproj = LN(2024)√óp2027*; votos por partido = share(2024)√óVproj; faltan = max(0, vL‚àívX+1); swing = ceil(faltan/2).<br>
            <b>C√≥mo leerlo:</b> la tabla prioriza por menor ‚Äúfaltan‚Äù; clic en fila hace zoom y muestra tooltip.<br>
            <b>Notas:</b> tras el primer ‚ÄúEjecutar‚Äù, si cambias el universo se recalcula solo.
          </div>
        </details>

        <details style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;">
          <summary style="cursor:pointer; font-weight:700;">Estabilidad pol√≠tica 2018‚Äì2024</summary>
          <div style="margin-top:8px; font-size:13px; color:#334155;">
            <b>Qu√© muestra:</b> continuidad/cambio por secci√≥n (verde/amarillo/rojo) en el universo actual.<br>
            <b>Uso:</b> combina con brecha 2027 para decidir estrategia: <i>‚Äúnear‚Äù + baja estabilidad</i> = oportunidad clara.
          </div>
        </details>

        <details style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;">
          <summary style="cursor:pointer; font-weight:700;">Participaci√≥n 2018/2021/2024 ‚Üí 2027*</summary>
          <div style="margin-top:8px; font-size:13px; color:#334155;">
            <b>Qu√© muestra:</b> mapa por participaci√≥n hist√≥rica y proyecci√≥n 2027* con rangos (&lt;30% rojo, 30‚Äì50% amarillo, &gt;50% verde).<br>
            <b>Uso:</b> detecci√≥n de secciones estructuralmente bajas (movilizaci√≥n).
          </div>
        </details>

        <!-- Metas de participaci√≥n 2027* -->
        <details open style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;">
          <summary style="cursor:pointer; font-weight:700;">Metas de participaci√≥n 2027*</summary>
          <div style="margin-top:8px; font-size:13px; color:#334155;">
            <b>Qu√© muestra:</b> si cada secci√≥n <b>cumple</b> la meta de participaci√≥n 2027* (verde), est√° <b>cerca</b> (amarillo) o <b>debajo</b> (rojo).<br>
            <b>C√≥mo leerlo:</b> prioriza las secciones ‚Äúcerca‚Äù para cerrar la brecha; revisa el promedio del universo.<br>
            <b>Nota:</b> la proyecci√≥n se basa en tendencias 2018‚Äì2024. Es una <i>l√≠nea base</i> para planear movilizaci√≥n.
          </div>
        </details>

        <!-- ¬øQu√© se requiere para ganar todo? -->
        <details style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;">
          <summary style="cursor:pointer; font-weight:700;">¬øQu√© se requiere para ganar todo? (brecha 2027)</summary>
          <div style="margin-top:8px; font-size:13px; color:#334155;">
            <b>Qu√© muestra:</b> para el <i>partido</i> y <i>puesto</i> elegidos, pinta por <b>ganador proyectado 2027*</b> y lista por secci√≥n:
            <b>ganador</b>, <b>votos del l√≠der</b>, <b>faltan</b> y <b>swing</b>.<br>
            <b>C√≥mo leerlo:</b> la tabla prioriza por menor ‚Äúfaltan‚Äù; clic en una fila centra la secci√≥n y muestra detalles.<br>
            <b>Nota:</b> se asume el reparto de 2024 como escenario base. √ösalo para dimensionar esfuerzos.
          </div>
        </details>

        <!-- Estabilidad pol√≠tica -->
        <details style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;">
          <summary style="cursor:pointer; font-weight:700;">Estabilidad pol√≠tica 2018‚Äì2024</summary>
          <div style="margin-top:8px; font-size:13px; color:#334155;">
            <b>Qu√© muestra:</b> continuidad/cambio del partido ganador: <span style="color:#16a34a;">verde</span>=alta (3 elecciones),
            <span style="color:#f59e0b;">amarillo</span>=media (hubo cambio),
            <span style="color:#ef4444;">rojo</span>=baja (tres distintos).<br>
            <b>C√≥mo leerlo:</b> zonas estables son bastiones; las inestables son oportunidad o riesgo.
          </div>
        </details>

        <!-- Participaci√≥n hist√≥rica ‚Üí 2027* (opcional) -->
        <details style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;">
          <summary style="cursor:pointer; font-weight:700;">Participaci√≥n 2018/2021/2024 ‚Üí 2027*</summary>
          <div style="margin-top:8px; font-size:13px; color:#334155;">
            <b>Qu√© muestra:</b> mapa por rangos de participaci√≥n hist√≥rica y proyecci√≥n 2027*:
            &lt;30% rojo, 30‚Äì50% amarillo, &gt;50% verde.<br>
            <b>C√≥mo leerlo:</b> detecta secciones estructuralmente bajas para reforzar movilizaci√≥n.
          </div>
        </details>




      <!-- 1) Probabilidad de voltear 2027 -->
      <details style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;">
        <summary style="cursor:pointer; font-weight:700;">Probabilidad de voltear 2027</summary>
        <div style="margin-top:8px; font-size:13px; color:#334155;">
          <b>Qu√© muestra:</b> mapa por secci√≥n en <b>verde</b> (alta), <b>amarillo</b> (media) y <b>rojo</b> (baja) seg√∫n la facilidad para cambiar el resultado en 2027.<br>
          <b>Entradas:</b> Puesto, Partido, pesos para: margen 2024, cambio de participaci√≥n 2018‚Üí2024, estabilidad pol√≠tica.<br>
          <b>C√°lculo (resumen):</b> puntaje = w‚ÇÅ¬∑(margen 2024 invertido) + w‚ÇÇ¬∑(sube/baja la participaci√≥n) + w‚ÇÉ¬∑(inestabilidad). Se normaliza 0‚Äì100 y se clasifica en alto/medio/bajo.<br>
          <b>C√≥mo leerlo:</b> prioriza las secciones verdes; las amarillas requieren impulso moderado; las rojas son de alto costo.
        </div>
      </details>

      <!-- 2) M√≠nimo de votos para mayor√≠a (por DF/DL) -->
      <details style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;">
        <summary style="cursor:pointer; font-weight:700;">M√≠nimo de votos para mayor√≠a (por DF/DL)</summary>
        <div style="margin-top:8px; font-size:13px; color:#334155;">
          <b>Qu√© muestra:</b> cu√°ntos votos adicionales se requieren para lograr una <b>mayor√≠a de secciones</b> en el √°mbito elegido (DF, DL o municipio).<br>
          <b>Entradas:</b> Puesto, Partido, √°mbito y meta de secciones (por ejemplo 60%).<br>
          <b>C√°lculo (resumen):</b> ordena secciones por ‚Äú<i>faltan</i>‚Äù de menor a mayor y acumula hasta cubrir la meta; reporta total y lista priorizada.<br>
          <b>C√≥mo leerlo:</b> es un plan de ataque m√≠nimo: empieza por las secciones con menor costo.
        </div>
      </details>

      <!-- 3) Eficiencia del voto (votos ociosos) -->
      <details style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;">
        <summary style="cursor:pointer; font-weight:700;">Eficiencia del voto (votos ociosos)</summary>
        <div style="margin-top:8px; font-size:13px; color:#334155;">
          <b>Qu√© muestra:</b> d√≥nde se ‚Äúsobraron‚Äù votos al ganar por amplia ventaja y d√≥nde faltaron para ganar.<br>
          <b>Entradas:</b> Puesto, Partido, umbral de sobrante (puntos porcentuales).<br>
          <b>C√°lculo (resumen):</b> si se gana: ociosos = votos del partido ‚àí (votos del segundo + 1). Si se pierde: d√©ficit = votos del segundo ‚àí votos del partido + 1. Mapa en azules (ocio) y rojos (d√©ficit).<br>
          <b>C√≥mo leerlo:</b> baja esfuerzo en secciones con gran sobrante y s√∫belo en d√©ficits peque√±os.
        </div>
      </details>

      <!-- 4) Corredores de volteo (grupos contiguos) -->
      <details style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;">
        <summary style="cursor:pointer; font-weight:700;">Corredores de volteo (grupos contiguos)</summary>
        <div style="margin-top:8px; font-size:13px; color:#334155;">
          <b>Qu√© muestra:</b> grupos de secciones vecinas con brecha peque√±a para voltearlas en bloque.<br>
          <b>Entradas:</b> Puesto, Partido, umbral de brecha (por ejemplo ‚Äúfaltan ‚â§ 3 pp‚Äù).<br>
          <b>C√°lculo (resumen):</b> agrupa secciones contiguas que cumplan el umbral; muestra color por grupo y el total de votos necesarios por corredor.<br>
          <b>C√≥mo leerlo:</b> enfoca operaci√≥n territorial por zonas, optimizando log√≠stica y comunicaci√≥n.
        </div>
      </details>

      <!-- 5) Alertas de riesgo (bastiones en ca√≠da) -->
      <details style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;">
        <summary style="cursor:pointer; font-weight:700;">Alertas de riesgo (bastiones en ca√≠da)</summary>
        <div style="margin-top:8px; font-size:13px; color:#334155;">
          <b>Qu√© muestra:</b> bastiones con se√±ales de deterioro: tendencia negativa y proyecci√≥n de participaci√≥n por debajo de la meta.<br>
          <b>Entradas:</b> Puesto, meta de participaci√≥n (control deslizante).<br>
          <b>C√°lculo (resumen):</b> estabilidad alta + pendiente 2018‚Üí2024 a la baja + p2027* menor a la meta ‚Üí se marca como ‚ÄúRiesgo‚Äù.<br>
          <b>C√≥mo leerlo:</b> activar pronto defensa y movilizaci√≥n donde la se√±al sea roja/√°mbar.
        </div>
      </details>

      <!-- 6) Simulador de impulso -->
      <details style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;">
        <summary style="cursor:pointer; font-weight:700;">Simulador de impulso</summary>
        <div style="margin-top:8px; font-size:13px; color:#334155;">
          <b>Qu√© muestra:</b> qu√© pasa si se agregan votos al partido (de forma uniforme, por deciles de brecha o solo en secciones ‚Äúcercanas‚Äù).<br>
          <b>Entradas:</b> Puesto, suma de votos o aumento de porcentaje, opci√≥n ‚Äúsolo cercanas‚Äù.<br>
          <b>C√°lculo (resumen):</b> ajusta los votos del partido y recalcula cu√°ntas secciones pasan a ganarse; grafica ‚Äúvotos a√±adidos ‚Üí secciones ganadas‚Äù.<br>
          <b>C√≥mo leerlo:</b> estima retornos por tramos de esfuerzo para planear despliegue.
        </div>
      </details>

      <!-- 7) Brecha relativa vs. brecha absoluta -->
      <details style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;">
        <summary style="cursor:pointer; font-weight:700;">Brecha relativa vs. brecha absoluta</summary>
        <div style="margin-top:8px; font-size:13px; color:#334155;">
          <b>Qu√© muestra:</b> conmutador de vista entre <b>puntos porcentuales</b> (relativa) y <b>votos</b> (absoluta).<br>
          <b>Entradas:</b> Puesto, Partido, conmutador ‚Äúpp/votos‚Äù.<br>
          <b>C√°lculo (resumen):</b> relativa = (votos del l√≠der ‚àí votos del partido) / Vproj ¬∑ 100; absoluta = ‚Äúfaltan‚Äù.<br>
          <b>C√≥mo leerlo:</b> usa la relativa para comparar dificultad; usa la absoluta para dimensionar movilizaci√≥n.
        </div>
      </details>

      <!-- 8) Sensibilidad a participaci√≥n -->
      <details style="margin:8px 0; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;">
        <summary style="cursor:pointer; font-weight:700;">Sensibilidad a participaci√≥n</summary>
        <div style="margin-top:8px; font-size:13px; color:#334155;">
          <b>Qu√© muestra:</b> c√≥mo cambia el ganador por secci√≥n si la participaci√≥n proyectada sube o baja algunos puntos.<br>
          <b>Entradas:</b> Puesto, Partido, variaci√≥n de participaci√≥n (¬± en puntos).<br>
          <b>C√°lculo (resumen):</b> ajusta p2027* ¬± Œ¥, recalcula Vproj y resultados; destaca secciones que cambian de ganador.<br>
          <b>C√≥mo leerlo:</b> identifica territorios sensibles a la movilizaci√≥n (o al abstencionismo).
        </div>
      </details>
    </div>

        <p style="margin:10px 0 0; color:#64748b; font-size:12px;">
          <b>Limitaci√≥n:</b> la proyecci√≥n asume shares 2024 constantes (escenario base). √ösalo como l√≠nea base, no como predicci√≥n definitiva.
        </p>

        <!-- Tips de uso -->
        <p style="margin:10px 0 0; color:#64748b; font-size:12px;">
          <b>Tips:</b> usa ‚ÄúRecentrar‚Äù para encuadrar todo el universo; el panel se actualiza si cambias el filtro del mapa.
        </p>

    `;
    document.body.appendChild(panel);

    // cerrar
    panel.querySelector('#AT27_GT_help_close').onclick = ()=>{ panel.style.display='none'; };

    // drag
    (function drag(panelEl, handleEl){
      let sx=0, sy=0, ox=0, oy=0, dragging=false;
      handleEl.addEventListener('mousedown', e=>{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panelEl.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none'; });
      window.addEventListener('mousemove', e=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panelEl.style.left=(ox+dx)+'px'; panelEl.style.top=(oy+dy)+'px'; panelEl.style.right='auto'; });
      window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; clampToViewport(panelEl); });
    })(panel, panel.querySelector('#AT27_GT_help_hdr'));

    clampToViewport(panel);

    // Evita que el panel ‚Äútape‚Äù interacciones del mapa (propagaci√≥n)
    if (window.L && L.DomEvent){
      L.DomEvent.disableClickPropagation(panel);
      L.DomEvent.disableScrollPropagation(panel);
    }
  }

  function clampToViewport(el){
    const vw = window.innerWidth, vh = window.innerHeight;
    const r = el.getBoundingClientRect();
    let left = r.left, top = r.top;
    if (r.right  > vw - 16) left -= (r.right  - (vw - 16));
    if (r.bottom > vh - 16) top  -= (r.bottom - (vh - 16));
    if (left < 16) left = 16;
    if (top  < 16) top  = 16;
    el.style.left = left + 'px';
    el.style.top  = top  + 'px';
    el.style.right = 'auto';
  }

  // Cableado del bot√≥n de ayuda (por si tu id cambia, intentamos ambos)
  (function wireGT_Help(){
    const btn = document.getElementById('btn-ayuda') || document.getElementById('btn-gt-ayuda');
    if (!btn || btn.__wiredHelp) return;
    btn.addEventListener('click', AT27_GT_HELP_open);
    btn.__wiredHelp = true;
  })();
</script>


</body>
</html>
