<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>APP Estratégico 2027</title>
<link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<style>
  html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: 'Segoe UI', Arial, sans-serif;
      display: block;  /* Cambiado para que el mapa se pueda expandir */
      background: #f4f4f4;
  }


  /* Asegura que el mapa cubra todo */
    #map {
        position: absolute;
        top: 0;
        left: 300px;  /* Empieza después del panel */
        width: calc(100% - 300px);
        height: 100%;
        transition: all 0.3s ease;  /* Suaviza el cambio al colapsar */
    }


  /* Reubica los botones de zoom de Leaflet */
  .leaflet-top.leaflet-left {
      left: auto;
      right: 10px;  /* Aparecen a la derecha */
      top: 10px;
  }


  #panel-lateral {
    width: 20%;
    height: 100%;
    background: linear-gradient(180deg, #8ea3ad 0%, #dfe6e9 100%);
    color: #2c3e50;
    border-right: 1px solid #b2bec3;
    display: flex;
    flex-direction: column;
    box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    box-sizing: border-box;
    position: relative;
    align-items: stretch;
    transition: width 0.4s ease, opacity 0.3s ease;
  }

  #panel-lateral.colapsado {
    width: 50px;
    opacity: 0.9;
  }

  #panel-header {
    background: #b2bec3; 
    color: #2c3e50;
    padding: 12px 15px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 18px;
    font-weight: bold;
    position: relative;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }
  #panel-header img {
    height: 28px;
    margin-right: 8px;
  }
  #panel-title {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  #toggle-panel {
    width: 28px;
    height: 28px;
    background: rgba(44, 62, 80, 0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  #toggle-panel:hover {
    background: rgba(44,62,80,0.2);
    transform: scale(1.1);
  }

  #panel-lateral.colapsado .tarjeta,
  #panel-lateral.colapsado #panel-title {
    display: none;
  }

  #buscador-seccion {
    display: flex;
    margin: 10px auto;
    background: #ffffff;
    border: 1px solid #dfe6e9;
    border-radius: 8px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.5);
    padding: 2px;
    width: 85%;
    min-width: 120px;
    z-index: 100;
    align-items: center;
    transition: transform 0.3s ease;
  }
  #buscador-seccion:hover {
    transform: scale(1.03);
  }
  #panel-lateral.colapsado #buscador-seccion {
    flex-direction: column;
    width: 40px;
    padding: 4px;
  }
  #buscador-seccion input {
    flex: 1;
    padding: 6px;
    font-size: 14px;
    border: none;
    outline: none;
    background: transparent;
    text-align: center;
  }
  #buscador-seccion button {
    background-color: #636e72;
    border: none;
    color: white;
    padding: 6px 10px;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.3s ease;
  }
  #buscador-seccion button:hover {
    background-color: #2d3436;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  #botones-consultas {
    display: flex;
    justify-content: space-around;
    margin: 6px 12px;
    padding: 4px 0;
    background: #f8f8f8;
    border-radius: 6px;
    border: 1px solid #ddd;
    transition: box-shadow 0.3s ease;
  }
  #botones-consultas button {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 20px;
    padding: 4px;
    transition: transform 0.2s, color 0.3s;
    position: relative;
  }
  #botones-consultas button:hover {
    transform: scale(1.3);
    color: #77808b; /* guinda para hover */
  }

/* Ventana flotante de consulta */
#ventana-ganartodo {
  position: absolute;
  top: 60px;
  left: 440px;
  width: 340px; /* más angosta */
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 5px 12px rgba(0,0,0,0.25);
  z-index: 3000;
  display: none;
  font-family: Arial, sans-serif;
  font-size: 13px;
  line-height: 1.4;
}

/* Cabecera */
#ventana-ganartodo .ventana-header {
  background: #21158a;
  color: #fff;
  padding: 6px 10px;
  font-weight: bold;
  cursor: move;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-radius: 10px 10px 0 0;
  font-size: 14px;
}

/* Cuerpo */
#ventana-ganartodo .ventana-body {
  padding: 8px 10px;
  background: #fafafa;
  max-height: 380px;
  overflow-y: auto;
}

/* Selects más compactos */
#ventana-ganartodo select {
  width: 100%;
  padding: 4px;
  margin: 3px 0;
  border-radius: 5px;
  border: 1px solid #ccc;
  font-size: 13px;
}

/* Botones estilo prueba */
#ventana-ganartodo button {
  background: #e2a8ce;
  color: #fff;
  border: none;
  padding: 6px;
  margin: 4px 0;
  border-radius: 6px;
  width: 100%;
  font-size: 13px;
  cursor: pointer;
  transition: background 0.2s ease;
}
#ventana-ganartodo button:hover {
  background: #3e0f6e;
}

/* Texto de ayuda más elegante */
#ventana-ganartodo .resumen {
  margin-top: 6px;
  padding: 6px;
  background: #ffeef1;
  border-radius: 6px;
  font-size: 12px;
  color: #21158a;
  text-align: center;
}
/* Handle visible para redimensionar */
.ui-resizable-se {
  position: absolute;
  right: 3px;
  bottom: 3px;
  width: 16px;
  height: 16px;
  background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"><line x1="0" y1="16" x2="16" y2="0" stroke="%238a1538" stroke-width="2"/></svg>') no-repeat center center;
  cursor: se-resize;
}




/* Leyenda en esquina inferior derecha */
#ventana-leyenda {
      position:absolute; 
      margin-bottom:10px; 
      left:10px; 
      background:#fff;
      padding:10px; 
      border-radius:8px; 
      box-shadow:0 2px 8px rgba(0,0,0,0.3);
      font-size:14px; 
      width:200px; 
      z-index:998;
}


/* Cabecera pequeña */
#ventana-leyenda .ventana-header {
  background: #152c8a;
  color: #fff;
  padding: 4px 8px;
  font-weight: bold;
  cursor: move;
  display: flex;
  justify-content: space-between;
  border-radius: 8px 8px 0 0;
  font-size: 13px;
}

/* Distribución en una sola línea para los partidos */
#ventana-leyenda .contenido {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 6px;
  padding: 6px 0;
}

/* Cada item de partido */
#ventana-leyenda .item {
  display: flex;
  align-items: center;
  gap: 4px;
}

/* Cuadro de color */
#ventana-leyenda .color-box {
  width: 12px;
  height: 12px;
  border: 1px solid #444444;
}

/* Texto de nota */
#ventana-leyenda small {
  display: block;
  margin-top: 4px;
  font-size: 11px;
  color: #555555;
  text-align: center;
}





/* Leyenda flotante */
  #leyenda {
    position: absolute;
    bottom: 20px;
    left: 420px;      /* también fuera del panel lateral */
    z-index: 2999 !important;
    display: none;    /* oculta al inicio */
  }
    .ventana-flotante {
    position: absolute;
    top: 60px;
    left: 440px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 3000;
    display: none; /* ocultas al inicio */
    min-width: 300px;
    resize: both;
    overflow: auto;
    width: 480px;
    height: 380px;
    min-width: 320px;
    min-height: 300px;

  }

  .ventana-body canvas {
  width: 100% !important;
  height: auto !important;
  }

  .ventana-header {
    background: #3a158a;
    color: #fff;
    padding: 8px;
    font-weight: bold;
    cursor: move;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 10px 10px 0 0;
  }

  .ventana-header .cerrar {
    cursor: pointer;
    font-weight: bold;
  }

  .ventana-body {
    padding: 10px;
    background: #fafafa;
    max-height: 450px;
    overflow-y: auto;
  }

  .color-box {
    width: 14px;
    height: 14px;
    margin-right: 6px;
    border: 1px solid #444;
    display: inline-block;
  }



  #exportar-btn {
    margin: 6px auto;
    padding: 6px 12px;
    background: #4c93af;
    color: #fff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    width: 85%;
    transition: all 0.3s ease;
  }
  #exportar-btn:hover {
    background: #387d8e;
    transform: scale(1.05);
  }

  .tarjeta {
    background: #fff;
    margin: 12px 15px;
    padding: 12px;
    border-radius: 12px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    opacity: 0;
    animation: fadeIn 0.8s forwards;
  }
  .tarjeta:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 10px rgba(0,0,0,0.15);
  }
  .tarjeta h4 {
    margin: 0 0 8px 0;
    font-size: 18px;
    color: #1f276b; /* Títulos guinda */
    display: flex;
    align-items: center;
    gap: 6px;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
  }

  .ganador-bloque {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 60px;
    margin: 8px 0;
    font-size: 18px;
    font-weight: bold;
    color: #fff;
    border-radius: 10px;
    opacity: 0;
    transform: translateY(15px);
    animation: slideUp 0.8s forwards;
  }

  .grafica-proyeccion {
    height: 300px !important;
  }

  .grafica-competencia {
    max-height: 180px !important;
    margin: 0 auto;
  }

  #map {
    width: 80%;
    height: 100%;
    transition: width 0.3s ease;
  }
  #panel-lateral.colapsado + #map {
    width: calc(100% - 50px);
  }

  @keyframes fadeIn {
    to { opacity: 1; }
  }
  @keyframes slideUp {
    to { opacity: 1; transform: translateY(0); }
  }
  .etiqueta-seccion {
    background: #b4ebf4;
    color: #fff;
    font-weight: bold;
    padding: 2px 6px;
    border-radius: 4px;
    border: 1px solid #fff;
    font-size: 13px;
    text-align: center;
  }

  /* === ESTILOS PANEL COMPARATIVA HISTÓRICA POR PARTIDO === */

#ventanaComparativaPartido {
  position: absolute;
  top: 70px;
  left: 480px;
  width: 400px;
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  z-index: 3000;
  display: none;
  resize: both;
  overflow: auto;
  min-width: 320px;
  min-height: 250px;
  max-height: 600px;
}

.panel-comparativa-partido-header {
  background-color: #cd6da0;
  color: white;
  padding: 10px;
  font-weight: bold;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-top-left-radius: 10px;
  border-top-right-radius: 10px;
}

.titulo-panel {
  font-size: 16px;
  display: flex;
  align-items: center;
  gap: 5px;
}

.btn-cerrar-partido {
  background: transparent;
  border: none;
  color: white;
  font-size: 18px;
  cursor: pointer;
}

.panel-comparativa-partido-cuerpo {
  padding: 12px 16px 20px 16px;
  font-size: 14px;
}

.selector-comparativa-partido {
  width: 100%;
  padding: 6px;
  margin-bottom: 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 14px;
}

.btn-ejecutar-partido {
  background-color: #1c0e88;
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  margin-top: 5px;
  width: 100%;
}

.btn-ejecutar-partido:hover {
  background-color: #1c0e88;
}

.mensaje-error-partido {
  color: red;
  font-weight: bold;
  font-size: 13px;
  margin-top: 12px;
  display: none;
}

.contenedor-grafica-partido {
  margin-top: 20px;
  max-height: 300px;
  overflow: auto;
}

/* === FIN ESTILOS PANEL COMPARATIVA HISTÓRICA POR PARTIDO === */

</style>
<!-- jQuery y jQuery UI (necesarios para resizable) -->
<link href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" rel="stylesheet"/>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

  <style>
  .ventana-heytigen {
    position: fixed;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    width: 480px;
    background: white;
    border: 2px solid #ddd;
    border-radius: 12px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    z-index: 9999;
    display: none;
    overflow: hidden;
      resize: both;
  }

  .barra-superior-heytigen {
    background-color: #efa0d6;
    color: white;
    padding: 10px;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .btn-cerrar-heytigen {
    background: none;
    border: none;
    color: white;
    font-size: 18px;
    cursor: pointer;
  }

  .contenido-heytigen {
    padding: 10px;
  }

  .contenido-heytigen video {
    width: 100%;
    border-radius: 8px;
  }

  .btn-mostrar-heytigen {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background-color: #cb6cca;
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    z-index: 999;
  }
</style>


</head>
<body>
<div =""="" id="panel-lateral" style="
  position: absolute;
  top: 0;
  left: 0;
  width: 300px;
  height: 100%;
  background: rgba(161, 217, 238, 0.95);
  color: #fff;
  z-index: 1000;
  display: flex;
  flex-direction: column;
  box-shadow: 2px 0 6px rgba(0,0,0,0.3);
  transition: transform 0.3s ease;
">
<!-- Botón para colapsar -->
<div id="toggle-panel" style="
    position: absolute;
    top: 50%;
    right: -24px;
    width: 24px;
    height: 48px;
    background: #513a7a;
    color: #fff;
    border-radius: 0 6px 6px 0;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 2px 2px 6px rgba(0,0,0,0.3);
    transition: background 0.3s;
    z-index: 20;
  " title="Ocultar/Mostrar Panel">
    ➤
  </div>
<!-- Encabezado -->
<div style="padding: 16px; position: relative; z-index: 10;">
<h3 style="margin-top: 0;">Datos Básicos</h3>
<!-- Buscador de sección -->
<div id="buscador-seccion" style="margin-top: 8px; z-index: 10; position: relative;">
<input id="input-seccion" placeholder="Buscar sección..." style="width: 70%; padding: 4px;" type="text"/>
<button id="btn-buscar-seccion" style="
        background: #1b1485; 
        color: #fff; 
        border: none; 
        padding: 5px 8px; 
        cursor: pointer;">
        🔍
      </button>
</div>
<!-- Info básica de la sección -->
<div id="info-seccion" style="margin-top: 10px;">
<p>Selecciona una sección o consulta para mostrar información aquí.</p>
</div>
</div>
<!-- Acordeón explicativo (oculto al inicio) -->
<div id="acordeon-graficas" style="
    position: absolute;
    top: 180px;           /* Debajo del buscador */
    left: 0;
    width: 100%;
    display: none;
    padding: 8px;
    box-sizing: border-box;
    z-index: 5;           /* Debajo del buscador */
  ">
</div>
</div>
<style>
</style>
<script>

  let seccionActiva = null;
  let tooltipSeccion = null;

  // --- Toggle Panel Lateral ---
  const panel = document.getElementById('panel-lateral');
  const toggleBtn = document.getElementById('toggle-panel');
  let panelVisible = true;

  toggleBtn.addEventListener('click', () => {
    const mapa = document.getElementById('map');

    if (panelVisible) {
      panel.style.transform = 'translateX(-280px)';
      mapa.style.left = '0';
      mapa.style.width = '100%';
      toggleBtn.innerHTML = '◀';
    } else {
      panel.style.transform = 'translateX(0)';
      mapa.style.left = '300px';
      mapa.style.width = 'calc(100% - 300px)';
      toggleBtn.innerHTML = '➤';
    }

    panelVisible = !panelVisible;
  });


  // --- Acordeón funcionalidad ---
  // --- Acordeón funcionalidad con apertura automática ---
    const headers = document.querySelectorAll('#acordeon-graficas .acordeon-header');

    headers.forEach(header => {
      header.addEventListener('click', () => {
        // Cierra todos los demás
        headers.forEach(h => {
          if (h !== header) h.classList.remove('active');
        });
        // Alterna el que se clickeó
        header.classList.toggle('active');
      });
    });

    // --- Función para abrir un acordeón automáticamente ---


</script>
<div id="map"></div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>

    let map, capaSecciones, ultimaCapaResaltada = null;
    let datosElectorales = {}; 
    let grafico = null;
    let graficaActual = 'historial';
    let capasPorSeccion = {}; // Declaración global ANTES de usarla

    const coloresPartido = {
      PAN: '#1976D2', PRI: '#C62828', PVEM: '#2E7D32', MORENA: '#6A1B1A'
    };

    document.addEventListener('DOMContentLoaded', () => {
      map = L.map('map').setView([20.86492084469482, -100.72329019456481],18);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);


      // Paso 2: Cargar datos electorales primero
fetch('Datos_Electoral.json')
  .then(resp => resp.json())
  .then(data => {
    datosElectorales = data;
    console.log("✔ Datos electorales cargados:", data);
  })
  .catch(err => console.error('❌ Error cargando datos electorales:', err));

// Paso 3: Cargar el GeoJSON y fusionar datos al vuelo
fetch('AT_SME_27.geojson')
  .then(response => response.json())
  .then(data => {
    capaSecciones = L.geoJSON(data, {
      style: { color: "#000000", weight: 2, fillOpacity: 0.07 },
      onEachFeature: (feature, layer) => {
        const props = feature.properties;
        const seccion = props.SECCION;

        // Buscar los datos electorales correspondientes a esta sección
        const datosElectoralesSeccion = datosElectorales[seccion] || {};

        // Unirlos en un solo objeto
        const propsUnificados = { ...props, ...datosElectoralesSeccion };

        // Guardar todo en el objeto global por sección
        capasPorSeccion[seccion] = {
          props: propsUnificados,
          geometry: feature.geometry,
          layer: layer
        };

        layer.on('click', () => {
          mostrarSeccion(propsUnificados, layer.getBounds().getCenter(), layer);
          map.fitBounds(layer.getBounds(), { maxZoom: 14 });
          mostrarEtiquetaSeccion(layer, seccion);
        });
      }
    }).addTo(map);

    map.fitBounds(capaSecciones.getBounds());
  })
  .catch(error => console.error('❌ Error al cargar GeoJSON:', error));

      const input = document.getElementById('input-seccion');
      const boton = document.querySelector('#buscador-seccion button');
      boton.addEventListener('click', () => buscarSeccion(input.value.trim()));
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') buscarSeccion(input.value.trim());
      });

      const toggle = document.getElementById('toggle-panel');
      const panel = document.getElementById('panel-lateral');
      toggle.addEventListener('click', () => {
        panel.classList.toggle('colapsado');
        toggle.innerText = panel.classList.contains('colapsado') ? '◀':'▶';
      });

      const ventana = document.getElementById('ventana-historial');
      const header = ventana.querySelector('header');
      const btnMin = ventana.querySelector('.btn-minimizar');
      const btnCerrar = ventana.querySelector('.btn-cerrar');

      let offsetX = 0, offsetY = 0, isDragging = false;

      header.addEventListener('mousedown', (e) => {
        isDragging = true;
        offsetX = e.clientX - ventana.offsetLeft;
        offsetY = e.clientY - ventana.offsetTop;
      });
      document.addEventListener('mousemove', (e) => {
        if (isDragging) {
          ventana.style.left = (e.clientX - offsetX) + 'px';
          ventana.style.top = (e.clientY - offsetY) + 'px';
        }
      });
      document.addEventListener('mouseup', () => {
        isDragging = false;
      });

      btnMin.addEventListener('click', () => {
        const canvas = ventana.querySelector('canvas');
        canvas.style.display = canvas.style.display === 'none' ? 'block' : 'none';
      });

      btnCerrar.addEventListener('click', () => {
        ventana.style.display = 'none';
      });

      // --- Control de movimiento, minimizar y cerrar para la ventana de Competencia ---
      const ventanaComp = document.getElementById('ventana-competencia');
      const headerComp = ventanaComp.querySelector('header');
      const btnMinComp = ventanaComp.querySelector('.btn-minimizar');
      const btnCerrarComp = ventanaComp.querySelector('.btn-cerrar');

      let offsetXComp = 0, offsetYComp = 0, isDraggingComp = false;

      headerComp.addEventListener('mousedown', (e) => {
        isDraggingComp = true;
        offsetXComp = e.clientX - ventanaComp.offsetLeft;
        offsetYComp = e.clientY - ventanaComp.offsetTop;
      });

      document.addEventListener('mousemove', (e) => {
        if (isDraggingComp) {
          ventanaComp.style.left = (e.clientX - offsetXComp) + 'px';
          ventanaComp.style.top = (e.clientY - offsetYComp) + 'px';
        }
      });

      document.addEventListener('mouseup', () => {
        isDraggingComp = false;
      });

      // Botón minimizar (oculta/muestra el canvas de la gráfica)
      btnMinComp.addEventListener('click', () => {
        const canvasComp = ventanaComp.querySelector('canvas');
        canvasComp.style.display = canvasComp.style.display === 'none' ? 'block' : 'none';
      });

      // Botón cerrar (oculta toda la ventana)
      btnCerrarComp.addEventListener('click', () => {
        ventanaComp.style.display = 'none';
      });


      // Inicializar gráfica por defecto
      mostrarGrafica('historial');

    });

    // --- Activar movimiento, minimizar y cerrar para Ganadores y Proyección ---
    window.addEventListener("load", function() {
        ['ventana-ganadores', 'ventana-proyeccion'].forEach(id => {
            const ventana = document.getElementById(id);
            if (!ventana) return;

            const header = ventana.querySelector('header');
            const btnMin = ventana.querySelector('.btn-minimizar');
            const btnCerrar = ventana.querySelector('.btn-cerrar');

            let offsetX = 0, offsetY = 0, isDragging = false;

            header.addEventListener('mousedown', (e) => {
                isDragging = true;
                offsetX = e.clientX - ventana.offsetLeft;
                offsetY = e.clientY - ventana.offsetTop;
            });
            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    ventana.style.left = (e.clientX - offsetX) + 'px';
                    ventana.style.top = (e.clientY - offsetY) + 'px';
                }
            });
            document.addEventListener('mouseup', () => {
                isDragging = false;
            });

            if (btnMin) {
                btnMin.addEventListener('click', () => {
                    const canvas = ventana.querySelector('canvas');
                    canvas.style.display = (canvas.style.display === 'none') ? 'block' : 'none';
                });
            }

            if (btnCerrar) {
                btnCerrar.addEventListener('click', () => {
                    ventana.style.display = 'none';
                });
            }
        });
    });


      function buscarSeccion(seccion) {
      if (!seccion || !capaSecciones) return;
  if (!seccion) { alert('Selecciona una sección antes de ejecutar esta consulta.'); return; }
      let encontrada = false;
      capaSecciones.eachLayer(layer => {
        const props = layer.feature.properties;
        const clave = props.SECCION?.toString();
        if (clave === seccion) {
          encontrada = true;
          seccionActiva = clave; // ✅ ← AQUÍ guardamos la sección global
          if (ultimaCapaResaltada) ultimaCapaResaltada.setStyle({ color: '#555', weight: 1 });
          layer.setStyle({ color: '#E53935', weight: 3 });
          ultimaCapaResaltada = layer;
          map.fitBounds(layer.getBounds(), { maxZoom: 17 });
          mostrarSeccion(props, layer.getBounds().getCenter(), layer);
            // Mostrar etiqueta de sección
          mostrarEtiquetaSeccion(layer, props.SECCION);
        } else if (clave && clave.includes(seccion)) {
          // Resaltar parcialmente si la sección contiene el texto buscado
          layer.setStyle({ color: '#FF9800', weight: 2 });
        } else {
          layer.setStyle({ color: '#5A1818', weight: 1 }); // Restaurar estilo original
        }
      });
      if (!encontrada) alert('⚠️ Sección no encontrada.');
    }

function mostrarSeccion(props, layer) {
    const seccion = String(props.SECCION);

    // Buscar en Datos_Elector.json
    const datosSeccion = datosElectorales[seccion];

    // Formatear Lista Nominal (2024) - campo 24DL_LN
    const listaNominal = datosSeccion?.["24DL_LN"]
        ? Number(datosSeccion["24DL_LN"]).toLocaleString('es-MX')
        : 'Sin datos';

    // Mostrar datos básicos en el panel lateral
    document.getElementById('info-seccion').innerHTML = `
        <p><b>Sección:</b> ${props.SECCION}</p>
        <p><b>Distrito Federal:</b> ${props.DISTRITO_F || 'N/D'}</p>
        <p><b>Distrito Local:</b> ${props.DISTRITO_L || 'N/D'}</p>
        <p><b>Lista Nominal (2024):</b> ${listaNominal}</p>
    `;

    // Activar acordeón de explicaciones (si no estaba visible)
    const acordeon = document.getElementById('acordeon-graficas');
    if (acordeon) {
        acordeon.style.display = 'block';
        acordeon.querySelectorAll('.acordeon-header').forEach(h => h.classList.remove('active'));
    }

    // Actualizar gráficas (solo si hay datos para la sección)
    if (datosSeccion) {
        actualizarGrafica(datosSeccion);
        mostrarGraficaCompetencia(datosSeccion);
        mostrarGraficaGanadores(datosSeccion);
        mostrarGraficaProyeccion(datosSeccion);
    }
}




// --- Ocultar explicaciones si todas las gráficas están cerradas ---



    function mostrarGrafica(tipo) {
      console.log("Ejecutandose mostrarGrafica con tipo:", tipo);
      graficaActual = tipo;
      const titulos = {
        historial: '🗳 Historial Electoral',
        competencia: '⚔️ Competencia (Top 2)',
        ganador: '🏆 Ganadores Ayuntamiento (2018, 2021, 2024)',
        proyeccion: '📈 Proyección 2027'
      };
     // document.getElementById('titulo-grafica').innerText = titulos[tipo];
      if (ultimaCapaResaltada) {
        const props = ultimaCapaResaltada.feature.properties;
        actualizarGrafica(datosElectorales[props.SECCION]);
        mostrarGraficaCompetencia(datosElectorales[props.SECCION]);
        }
    }

    function actualizarGrafica(datosSeccion) {
      // Mostrar la ventana flotante
      const ventana = document.getElementById('ventana-historial');
      ventana.style.display = 'flex';

      // Datos de ejemplo (ajústalos con los reales si los tienes ya)
      const partidos = ['PAN', 'PRI', 'PVEM', 'MORENA'];
      const votos2018 = partidos.map(p => datosSeccion[`18DL_${p}`] || 0);
      const votos2021 = partidos.map(p => datosSeccion[`21DL_${p}`] || 0);
      const votos2024 = partidos.map(p => datosSeccion[`24DL_${p}`] || 0);

      const ctx = document.getElementById('grafica-historial').getContext('2d');
      if (grafico) grafico.destroy();

      grafico = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['2018', '2021', '2024'],  // Años en eje X
            datasets: [
              {
                label: 'PAN',
                data: [
                  datosSeccion['18DL_PAN'] || 0,
                  datosSeccion['21DL_PAN'] || 0,
                  datosSeccion['24DL_PAN'] || 0
                ],
                backgroundColor: '#0055A4' // Azul oficial PAN
              },
              {
                label: 'PRI',
                data: [
                  datosSeccion['18DL_PRI'] || 0,
                  datosSeccion['21DL_PRI'] || 0,
                  datosSeccion['24DL_PRI'] || 0
                ],
                backgroundColor: '#E30613' // Rojo oficial PRI
              },
              {
                label: 'PVEM',
                data: [
                  datosSeccion['18DL_PVEM'] || 0,
                  datosSeccion['21DL_PVEM'] || 0,
                  datosSeccion['24DL_PVEM'] || 0
                ],
                backgroundColor: '#78BE20' // Verde oficial PVEM
              },
              {
                label: 'MORENA',
                data: [
                  datosSeccion['18DL_MORENA'] || 0,
                  datosSeccion['21DL_MORENA'] || 0,
                  datosSeccion['24DL_MORENA'] || 0
                ],
                backgroundColor: '#862633' // Guinda oficial MORENA
              }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: {
                  font: { size: 11 }
                }
              },
              tooltip: { enabled: true },
              datalabels: {
                color: '#333',
                anchor: 'end',
                align: 'end',
                font: {
                  size: 10,
                  weight: 'normal'
                },
                formatter: function(value) {
                  return value.toLocaleString();
                }
              }
            },
            scales: {
              x: { stacked: false },
              y: { beginAtZero: true }
            },
            elements: {
              bar: {
                borderRadius: 6,         // Bordes redondeados
                borderSkipped: false,    // Redondea las esquinas inferiores también
                shadowOffsetX: 2,        // Desplazamiento horizontal de la sombra
                shadowOffsetY: 2,        // Desplazamiento vertical de la sombra
                shadowBlur: 4,           // Suavizado de la sombra
                shadowColor: 'rgba(0,0,0,0.2)' // Color y opacidad de la sombra
              }
            }
          },
          
          plugins: [ChartDataLabels] // Activamos plugin para etiquetas
        });

      // Ajustar tamaño del canvas
      const canvas = document.getElementById('grafica-historial');
      canvas.style.width = '100%';
      canvas.style.height = '100%';

      // Mostrar ventana flotante
      ventana.style.display = 'flex';

    }

    // Función para mostrar gráfica de Competencia (Top 3 partidos) en ventana flotante
      function mostrarGraficaCompetencia(datosSeccion) {
          const ventana = document.getElementById("ventana-competencia");
          ventana.style.display = 'flex';  // Mostrar ventana
          const ctx = document.getElementById("grafica-competencia").getContext("2d");

          // Obtener partidos y votos (2024) para competencia
          const partidos = ['PAN', 'PRI', 'PVEM', 'MORENA'];
          const votos = partidos.map(p => (datosSeccion['24DL_' + p] || 0));

          // Ordenar por votos y tomar los 3 primeros
          const ranking = partidos.map((p, i) => ({ partido: p, votos: votos[i] }))
                                  .sort((a, b) => b.votos - a.votos)
                                  .slice(0, 3);

          const etiquetas = ranking.map(r => r.partido);
          const valores = ranking.map(r => r.votos);
          const colores = {
              'PAN': '#0055A4',
              'PRI': '#E30613',
              'PVEM': '#78BE20',
              'MORENA': '#862633'
          };
          const coloresUsados = ranking.map(r => colores[r.partido] || '#999');

          // Destruir gráfico anterior si existe
          if (window.graficoCompetencia) {
              window.graficoCompetencia.destroy();
          }

          // Crear nuevo gráfico de pastel
          window.graficoCompetencia = new Chart(ctx, {
              type: 'pie',
              data: {
                  labels: etiquetas,
                  datasets: [{
                      data: valores,
                      backgroundColor: coloresUsados
                  }]
              },
             options: {
                  responsive: true,
                  maintainAspectRatio: false,  // Permite que la gráfica se estire
                  plugins: {
                      legend: { 
                          position: 'bottom',
                          labels: {
                              font: { size: 11 }  // Etiquetas más pequeñas si quieres
                          }
                      },
                      tooltip: { enabled: true }
                  }
              }
,
              plugins: [ChartDataLabels]
          });

          // Redimensionar dinámicamente
          const observer = new ResizeObserver(() => {
              if (window.graficoCompetencia) window.graficoCompetencia.resize();
          });
          observer.observe(ventana);
      }

      window.addEventListener("load", function() {
        // Exportar PDF - Historial
        const btnHistorial = document.getElementById("exportar-btn");
        if (btnHistorial) {
            btnHistorial.addEventListener("click", function() {
                const { jsPDF } = window.jspdf;
                const ventana = document.getElementById("ventana-historial");

                html2canvas(ventana).then(canvas => {
                    const imgData = canvas.toDataURL("image/png");
                    const pdf = new jsPDF('landscape', 'pt', 'a4');
                    const imgWidth = 800;
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    pdf.addImage(imgData, 'PNG', 20, 40, imgWidth, imgHeight);
                    pdf.save("historial.pdf");
                });
            });
        }

        // Exportar PDF - Competencia
        const btnCompetencia = document.getElementById("exportar-btn-competencia");
        if (btnCompetencia) {
            btnCompetencia.addEventListener("click", function() {
                const { jsPDF } = window.jspdf;
                const ventana = document.getElementById("ventana-competencia");

                html2canvas(ventana).then(canvas => {
                    const imgData = canvas.toDataURL("image/png");
                    const pdf = new jsPDF('landscape', 'pt', 'a4');
                    const imgWidth = 800;
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    pdf.addImage(imgData, 'PNG', 20, 40, imgWidth, imgHeight);
                    pdf.save("competencia.pdf");
                });
            });
        }
    });
</script>
<script>
  function mostrarEtiquetaSeccion(layer, seccion) {
  if (tooltipSeccion) {
    map.removeLayer(tooltipSeccion);
    tooltipSeccion = null;
  }
  
  tooltipSeccion = L.tooltip({
    permanent: true,
    direction: 'center',
    className: 'etiqueta-seccion'
  })
  .setContent(`Sección ${seccion}`)
  .setLatLng(layer.getBounds().getCenter());

  map.addLayer(tooltipSeccion);
}

</script>
<script>

  // Función para mostrar ventana de Proyección 2027
  function mostrarVentanaProyeccion() {
    const ventana = document.getElementById('ventana-proyeccion');
    ventana.style.display = 'flex';
    const ctx = document.getElementById('grafica-proyeccion').getContext('2d');

    // Datos de ejemplo para la proyección (ajusta según tus datos reales)
    const partidos = ['PAN', 'PRI', 'PVEM', 'MORENA'];
    const proyeccion2027 = partidos.map(p => Math.floor(Math.random() * 10000) + 5000); // Valores aleatorios

    if (window.graficoProyeccion) window.graficoProyeccion.destroy();

    window.graficoProyeccion = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: partidos,
        datasets: [{
          label: 'Proyección 2027',
          data: proyeccion2027,
          backgroundColor: partidos.map(p => coloresPartido[p] || '#999')
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: true, position: 'top' },
          tooltip: { enabled: true },
          datalabels: {
            color: '#fff',
            font: { size: 12, weight: 'bold' },
            formatter: value => value.toLocaleString()
          }
        },
        scales: {
          x: { stacked: false },
          y: { beginAtZero: true }
        }
      },
      plugins: [ChartDataLabels]
    });

    // Redimensionar dinámicamente
    const observer = new ResizeObserver(() => {
      if (window.graficoProyeccion) window.graficoProyeccion.resize();
    });
    observer.observe(ventana);
  }/* ===============================
   FUNCIONES PARA LAS NUEVAS VENTANAS
   =============================== */

// --- Función para mostrar gráfica de Ganadores (Barras) ---
    function mostrarGraficaGanadores(datosSeccion) {
        const ventana = document.getElementById("ventana-ganadores");
        ventana.style.display = 'flex';
        const ctx = document.getElementById("grafica-ganadores").getContext("2d");

        // Ganadores solo para 2018, 2021, 2024 (Ayuntamiento)
        const ganadores = [
            datosSeccion['GANADOR_18DL'] || 'N/D',
            datosSeccion['GANADOR_21DL'] || 'N/D',
            datosSeccion['GANADOR_24DL'] || 'N/D'
        ];

        const etiquetas = ['2024', '2021', '2018'];
        const valores = etiquetas.map(() => 1); // Barras uniformes, solo para mostrar ganadores
        const colores = {
            'PAN': '#0055A4',
            'PRI': '#E30613',
            'PVEM': '#78BE20',
            'MORENA': '#862633',
            'N/D': '#999'
        };
        const coloresUsados = ganadores.map(p => colores[p] || '#999');

        if (window.graficoGanadores) window.graficoGanadores.destroy();

        window.graficoGanadores = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: etiquetas,
                datasets: [{
                    data: valores,
                    backgroundColor: coloresUsados
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (context) => `Ganador: ${ganadores[context.dataIndex]}`
                        }
                    },
                    datalabels: {
                        color: '#fff',
                        font: { size: 12, weight: 'bold' },
                        formatter: (_, context) => ganadores[context.dataIndex]
                    }
                },
                scales: {
                    x: { grid: { display: false } },
                    y: { display: false }
                }
            },
            plugins: [ChartDataLabels]
        });
    }


// --- Función para mostrar gráfica de Proyección (Línea) ---
      function mostrarGraficaProyeccion(datosSeccion) {
          const ventana = document.getElementById("ventana-proyeccion");
          ventana.style.display = 'flex';
          const ctx = document.getElementById("grafica-proyeccion").getContext("2d");

          const partidos = ['PAN', 'PRI', 'PVEM', 'MORENA'];
          const colores = {
              PAN: '#0055A4',    // Azul
              PRI: '#E30613',    // Rojo
              PVEM: '#78BE20',   // Verde
              MORENA: '#862633'  // Guinda
          };

          // Para cada partido, tomamos votos de 2018, 2021, 2024 y la proyección 2027
          const datasets = partidos.map(partido => ({
              label: partido,
              data: [
                  datosSeccion[`18DL_${partido}`] || 0,       // 2018
                  datosSeccion[`21DL_${partido}`] || 0,       // 2021
                  datosSeccion[`24DL_${partido}`] || 0,       // 2024
                  datosSeccion[`PROY_2027_DL_${partido}`] || 0 // Proyección 2027
              ],
              borderColor: colores[partido],
              backgroundColor: `${colores[partido]}33`, // Relleno semitransparente
              tension: 0.3,
              fill: false,
              pointBackgroundColor: colores[partido],
              pointBorderColor: '#fff',
              pointRadius: 5,
              pointHoverRadius: 7
          }));

          if (window.graficoProyeccion) window.graficoProyeccion.destroy();

          window.graficoProyeccion = new Chart(ctx, {
              type: 'line',
              data: {
                  labels: ['2018', '2021', '2024', 'Proy. 2027'],
                  datasets: datasets
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                      legend: {
                          position: 'top',
                          labels: { font: { size: 12 } }
                      },
                      tooltip: { enabled: true },
                      datalabels: {
                          color: '#333',
                          font: { size: 11, weight: 'bold' },
                          formatter: (value) => value.toLocaleString()
                      }
                  },
                  scales: {
                      x: {
                          title: { display: true, text: 'Elecciones', font: { size: 12, weight: 'bold' } },
                          grid: { display: false }
                      },
                      y: {
                          beginAtZero: true,
                          title: { display: true, text: 'Votos por partido', font: { size: 12, weight: 'bold' } }
                      }
                  }
              },
              plugins: [ChartDataLabels]
          });
      }

/* ===============================
   CONTROL DE MOVIMIENTO Y BOTONES
   =============================== */

// Reutilizamos el patrón de movimiento/cierre de Historial y Competencia

function habilitarVentanaFlotante(idVentana) {
    const ventana = document.getElementById(idVentana);
    const header = ventana.querySelector('header');
    const btnMin = ventana.querySelector('.btn-minimizar');
    const btnCerrar = ventana.querySelector('.btn-cerrar');

    let offsetX = 0, offsetY = 0, isDragging = false;

    header.addEventListener('mousedown', (e) => {
        isDragging = true;
        offsetX = e.clientX - ventana.offsetLeft;
        offsetY = e.clientY - ventana.offsetTop;
    });
    document.addEventListener('mousemove', (e) => {
        if (isDragging) {
            ventana.style.left = (e.clientX - offsetX) + 'px';
            ventana.style.top = (e.clientY - offsetY) + 'px';
        }
    });
    document.addEventListener('mouseup', () => {
        isDragging = false;
    });

    btnMin.addEventListener('click', () => {
        const canvas = ventana.querySelector('canvas');
        canvas.style.display = canvas.style.display === 'none' ? 'block' : 'none';
    });

    btnCerrar.addEventListener('click', () => {
        ventana.style.display = 'none';
    });
}

// Activamos movimiento en Ganadores y Proyección
// Habilitar las 4 ventanas flotantes
habilitarVentanaFlotante('ventana-historial');
habilitarVentanaFlotante('ventana-competencia');
habilitarVentanaFlotante('ventana-ganadores');
habilitarVentanaFlotante('ventana-proyeccion');


/* ===============================
   EXPORTAR A PDF PARA LAS NUEVAS VENTANAS
   =============================== */
window.addEventListener("load", function() {
    const exportar = (idBoton, idVentana, nombrePDF) => {
        const btn = document.getElementById(idBoton);
        if (btn) {
            btn.addEventListener("click", () => {
                const { jsPDF } = window.jspdf;
                const ventana = document.getElementById(idVentana);
                html2canvas(ventana).then(canvas => {
                    const imgData = canvas.toDataURL("image/png");
                    const pdf = new jsPDF('landscape', 'pt', 'a4');
                    const imgWidth = 800;
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    pdf.addImage(imgData, 'PNG', 20, 40, imgWidth, imgHeight);
                    pdf.save(nombrePDF);
                });
            });
        }
    };

    exportar('exportar-btn-ganadores', 'ventana-ganadores', 'ganadores.pdf');
    exportar('exportar-btn-proyeccion', 'ventana-proyeccion', 'proyeccion.pdf');
});

    function habilitarVentanaFlotante(idVentana) {
        const ventana = document.getElementById(idVentana);
        if (!ventana) return;  // Si no existe, salir para evitar errores

        const header = ventana.querySelector('header');
        const btnMin = ventana.querySelector('.btn-minimizar');
        const btnCerrar = ventana.querySelector('.btn-cerrar');

        let offsetX = 0, offsetY = 0, isDragging = false;

        // Habilitar arrastre desde el header
        if (header) {
            header.addEventListener('mousedown', (e) => {
                isDragging = true;
                offsetX = e.clientX - ventana.offsetLeft;
                offsetY = e.clientY - ventana.offsetTop;
            });
        }

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                ventana.style.left = (e.clientX - offsetX) + 'px';
                ventana.style.top = (e.clientY - offsetY) + 'px';
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
        });

        // Botón para minimizar
        if (btnMin) {
            btnMin.addEventListener('click', () => {
                const canvas = ventana.querySelector('canvas');
                if (canvas) {
                    canvas.style.display = canvas.style.display === 'none' ? 'block' : 'none';
                }
            });
        }

        // Botón para cerrar
        if (btnCerrar) {
            btnCerrar.addEventListener('click', () => {
                ventana.style.display = 'none';
                // Ocultar explicaciones si todas las ventanas están cerradas
                if (typeof ocultarExplicacionesSiNoHayGraficas === 'function') {
                    ocultarExplicacionesSiNoHayGraficas();
                }
            });
        }
    }



</script>
<!-- Ventana flotante: Proyección 2027 (primera en mostrarse, más abajo) -->
<div id="ventana-proyeccion" style="
    position: absolute;
    top: 380px;       /* Más abajo y más a la izquierda */
    right: 240px;
    width: 380px;
    height: 280px;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    display: none;
    flex-direction: column;
    z-index: 500;
    resize: both;
    overflow: auto;
  ">
<header style="
      background: #3c1b6b;
      color: #fff;
      padding: 6px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      cursor: move;
    ">
<span>Proyección 2027</span>
<div>
<button class="btn-minimizar" style="background:none;border:none;color:#fff;font-size:16px;cursor:pointer;">–</button>
<button class="btn-cerrar" style="background:none;border:none;color:#fff;font-size:16px;cursor:pointer;">×</button>
</div>
</header>
<canvas id="grafica-proyeccion" style="flex:1; padding:10px;"></canvas>
</div>
<!-- Ventana flotante: Ganadores (segunda en mostrarse) -->
<div id="ventana-ganadores" style="
    position: absolute;
    top: 280px;       /* Más arriba que Proyección */
    right: 180px;
    width: 380px;
    height: 280px;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    display: none;
    flex-direction: column;
    z-index: 500;
    resize: both;
    overflow: auto;
  ">
<header style="
      background: #3c1b6b;
      color: #fff;
      padding: 6px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      cursor: move;
    ">
<span>Ganadores (2018, 2021, 2024)</span>
<div>
<button class="btn-minimizar" style="background:none;border:none;color:#fff;font-size:16px;cursor:pointer;">–</button>
<button class="btn-cerrar" style="background:none;border:none;color:#fff;font-size:16px;cursor:pointer;">×</button>
</div>
</header>
<div style="padding: 6px; text-align: center;">
<button id="exportar-btn-ganadores" onmouseout="this.style.background='#8B2E3A';" onmouseover="this.style.background='#A34755';" style="
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 4px 8px;
        background: #3c1b6b;
        color: #fff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 13px;
        width: auto;
        transition: all 0.3s ease;
      ">
        📄 Exportar PDF
      </button>
</div>
<canvas id="grafica-ganadores" style="flex:1; padding:10px;"></canvas>
</div>
<!-- Ventana flotante: Competencia (Top 3) (tercera en mostrarse) -->
<div id="ventana-competencia" style="
    position: absolute;
    top: 180px;       /* Más arriba que Ganadores */
    right: 120px;
    width: 380px;
    height: 280px;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    display: none;
    flex-direction: column;
    z-index: 500;
    resize: both;
    overflow: auto;
  ">
<header style="
      background: #3c1b6b;
      color: #fff;
      padding: 6px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      cursor: move;
    ">
<span>Competencia (Top 3)</span>
<div>
<button class="btn-minimizar" style="background:none;border:none;color:#fff;font-size:16px;cursor:pointer;">–</button>
<button class="btn-cerrar" style="background:none;border:none;color:#fff;font-size:16px;cursor:pointer;">×</button>
</div>
</header>
<div style="padding: 6px; text-align: center;">
<button id="exportar-btn-competencia" onmouseout="this.style.background='#8B2E3A';" onmouseover="this.style.background='#A34755';" style="
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 4px 8px;
        background: #3c1b6b;
        color: #fff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 13px;
        width: auto;
        transition: all 0.3s ease;
      ">
        📄 Exportar PDF
      </button>
</div>
<canvas id="grafica-competencia" style="
        width: 100%;
        height: 220px;
        min-width: 180px;     /* Tamaño mínimo horizontal */
        min-height: 180px;    /* Tamaño mínimo vertical */
        display: block;
        margin: auto;
      "></canvas>
</div>
<!-- Ventana flotante: Historial Electoral (última en mostrarse, arriba) -->
<div id="ventana-historial" style="
    position: absolute;
    top: 80px;        /* Queda más arriba de todas */
    right: 60px;
    width: 380px;
    height: 280px;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    display: none;
    flex-direction: column;
    z-index: 500;
    resize: both;
    overflow: auto;
  ">
<header style="
      background: #3c1b6b;
      color: #fff;
      padding: 6px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      cursor: move;
    ">
<span>Historial Electoral</span>
<div>
<button class="btn-minimizar" style="background:none;border:none;color:#fff;font-size:16px;cursor:pointer;">–</button>
<button class="btn-cerrar" style="background:none;border:none;color:#fff;font-size:16px;cursor:pointer;">×</button>
</div>
</header>
<div style="padding: 6px; width: 40%;">
<button id="exportar-btn" onmouseout="this.style.background='#8B2E3A';" onmouseover="this.style.background='#A34755';" style="
                  display: inline-flex;        /* Botón como inline-flex para alinearlo */
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        margin-left: 0;              /* Forzar alineación a la izquierda */
        background: #3c1b6b;
        color: #fff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.3s ease;
      ">
        📄 Exportar PDF
      </button>
</div>
<canvas id="grafica-historial" style="flex:1; padding:10px;"></canvas>
</div>
<!-- Script para colapsar panel y ajustar mapa -->
<script>
    window.addEventListener('DOMContentLoaded', () => {
      const panel = document.getElementById('panel-lateral');
      const toggleBtn = document.getElementById('toggle-panel');
      const mapa = document.getElementById('map');
      let panelVisible = true;

      if (panel && toggleBtn && mapa) {
        toggleBtn.addEventListener('click', () => {
          if (panelVisible) {
            panel.style.transform = 'translateX(-280px)';
            mapa.style.left = '0';
            mapa.style.width = '100%';
            toggleBtn.innerHTML = '◀';
          } else {
            panel.style.transform = 'translateX(0)';
            mapa.style.left = '300px';
            mapa.style.width = 'calc(100% - 300px)';
            toggleBtn.innerHTML = '➤';
          }
          panelVisible = !panelVisible;
        });
      } else {
        console.error("No se encontró panel, mapa o botón para colapsar");
      }
    });
    </script>
<!-- === Barras de Consultas (Derecha e Izquierda, ajustadas con animación) === -->
<style>
  .barra-consultas {
    position: fixed;
    right: 10px;
    top: calc(50% + 40px); /* subimos 40px en total (antes 60) */
    transform: translateY(-50%);
    display: flex;
    flex-direction: column;
    background: transparent;
    padding: 6px;
    border-radius: 15px;
    border: 1px solid rgba(200,200,200,0.3);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
    transition: top 0.3s ease;
  }
  .barra-consultas.oculta { right: -70px; }
  .toggle-barra {
    position: absolute;
    left: -22px;
    top: 50%;
    transform: translateY(-50%);
    background: #efafd4;
    color: #fff;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }
  .grupo {
    margin: 4px 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding-bottom: 4px;
    position: relative;
  }
  .grupo:not(:last-child)::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 15%;
    right: 15%;
    height: 1px;
    background: rgba(180,180,180,0.4);
    filter: blur(1px);
  }
  .btn-consulta {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    margin: 3px 0;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: white;
    font-size: 16px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    position: relative;
    transition: transform 0.2s ease;
  }
  .btn-consulta:hover { transform: scale(1.1); }
  .generales { background: #efafd4; }
  .comparativas { background: #555; }
  .visuales {
    background: #fff;
    color: #efafd4;
    border: 2px solid #800020;
  }
  .visuales:hover { background: #efafd4; color: #fff; }
  .btn-consulta::after {
    content: attr(data-tooltip);
    position: absolute;
    left: -180px;
    white-space: nowrap;
    background: rgba(0,0,0,0.8);
    color: #fff;
    padding: 5px 10px;
    border-radius: 5px;
    opacity: 0;
    transform: translateY(-50%);
    pointer-events: none;
    transition: opacity 0.3s ease;
    font-size: 13px;
  }
  .btn-consulta:hover::after { opacity: 1; }

  /* Barra visual (izquierda), movida 15px fuera del panel */
  .barra-visuales {
    position: fixed;
    left: calc(260px + 50px); /* considerando ancho del panel lateral */
    top: 110px;
    display: flex;
    flex-direction: column;
    background: transparent;
    padding: 6px;
    border-radius: 12px;
    box-shadow: none;
    z-index: 1000;
    transition: left 0.3s ease, top 0.3s ease;
  }
  .barra-visuales .btn-consulta {
    width: 38px;
    height: 38px;
    margin: 3px 0;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  }

  /* Ventana de filtros */
.ventana-filtros {
  position: fixed;
  top: 350px;            /* Baja un poco para quedar debajo del buscador */
  left: 40px;            /* Dentro del panel lateral */
  width: 220px;          /* Tamaño más compacto para caber en el panel */
  background: #fff;
  padding: 12px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  z-index: 3000;
  display: none;
  cursor: grab;
  user-select: none;
}


  .ventana-filtros h3 { margin-top: 0; color: #efafd4; font-size: 18px; }
  .cerrar-filtros { cursor: pointer; float: right; color: #efafd4; font-weight: bold; }
  .btn-ejecutar {
    background: #efafd4;
    color: #fff;
    border: none;
    padding: 7px 10px;
    margin-top: 8px;
    cursor: pointer;
    border-radius: 6px;
    font-size: 14px;
  }
</style>
<!-- Barras -->
<div class="barra-consultas" id="barraConsultas">
<div class="toggle-barra" onclick="toggleBarra()">❮</div>
<div class="grupo">
<div class="btn-consulta generales" data-tooltip="Ganadores por Partido 2024" onclick="console.log('Ganadores por Partido 2024')">🏆</div>
<div class="btn-consulta generales" data-tooltip="Consulta por Partido y Año" onclick="abrirFiltros()">📊</div>
<div class="btn-consulta generales" data-tooltip="Participación por Elección (DL)" onclick="console.log('Participación por Elección DL')">🗳️</div>
<div class="btn-consulta generales" data-tooltip="Fortaleza por Partido" onclick="console.log('Fortaleza por Partido')">💪</div>
<div class="btn-consulta generales" data-tooltip="Participación 2018 vs 2024" onclick="console.log('Participación 2018 vs 2024')">📈</div>
<div class="btn-consulta generales" data-tooltip="Alternancia y Crecimiento" onclick="console.log('Alternancia y Crecimiento')">🔄</div>
<div class="btn-consulta generales" data-tooltip="Estabilidad Política" onclick="console.log('Estabilidad Política')">⚖️</div>
</div>
<div class="grupo">
<div class="btn-consulta comparativas" data-tooltip="Consulta Histórica por Puesto" onclick="console.log('Consulta Histórica por Puesto')">📜</div>
<div class="btn-consulta comparativas" data-tooltip="Comparar Puestos en un Año" onclick="console.log('Comparar Puestos en un Año')">⚖️</div>
<div class="btn-consulta comparativas" data-tooltip="Comparativa Histórica por Partido" onclick="console.log('Comparativa Histórica por Partido')">📂</div>
<div class="btn-consulta comparativas" data-tooltip="Cruce de Puestos entre Años" onclick="console.log('Cruce de Puestos entre Años')">🔀</div>
<div class="btn-consulta comparativas" data-tooltip="Comparativa Proyección 2027" onclick="console.log('Comparativa Proyección 2027')">📅</div>
<div class="btn-consulta comparativas" data-tooltip="¿Qué se requiere para ganar todo?" onclick="console.log('Qué se requiere para ganar todo')">🏅</div>
</div>
</div>
<div class="barra-visuales">
<div class="btn-consulta visuales" data-tooltip="Reiniciar Mapa" onclick="console.log('Reiniciar Mapa')">🔄</div>
<div class="btn-consulta visuales" data-tooltip="Mostrar Etiquetas" onclick="console.log('Mostrar Etiquetas')">👁️</div>
<div class="btn-consulta visuales" data-tooltip="Ocultar Etiquetas" onclick="console.log('Ocultar Etiquetas')">🚫</div>
</div>
<div class="ventana-filtros" id="ventanaFiltros">
<span class="cerrar-filtros" onclick="cerrarFiltros()">✖</span>
<h3>Filtros de Consulta</h3>
<label>Año:
    <select><option>2018</option><option>2021</option><option>2024</option></select>
</label><br/>
<label>Partido:
    <select><option>PAN</option><option>PRI</option><option>MORENA</option></select>
</label><br/>
<button class="btn-ejecutar" onclick="ejecutarConsulta()">Ejecutar</button>
</div>
<script>
  function toggleBarra() {
    document.getElementById('barraConsultas').classList.toggle('oculta');
  }
  function abrirFiltros() {
    document.getElementById('ventanaFiltros').style.display = 'block';
  }
  function cerrarFiltros() {
    document.getElementById('ventanaFiltros').style.display = 'none';
  }
  function ejecutarConsulta() {
    console.log('Ejecutando consulta con filtros');
    cerrarFiltros();
  }
  // Reajustar posiciones al cambiar tamaño de ventana
  window.addEventListener('resize', () => {
    const barra = document.querySelector('.barra-consultas');
    if (window.innerHeight < 700) {
      barra.style.top = '55%';
    } else {
      barra.style.top = 'calc(50% + 20px)';
    }
  });
</script>
<!-- === Consulta: Ganadores por Partido 2024 (Diputados Locales) === -->
<style>
  /* Ventana de Leyenda */
  .ventana-leyenda {
    position: fixed;
    bottom: 20px;
    left: 20px;
    background: rgba(255, 255, 255, 0.95);
    padding: 12px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    z-index: 1500;
    min-width: 160px;
    cursor: grab;
    user-select: none;
  }
  .ventana-leyenda h4 {
    margin: 0 0 8px;
    font-size: 14px;
    color: #efafd4;
  }
  .leyenda-item {
    display: flex;
    align-items: center;
    margin-bottom: 4px;
    font-size: 13px;
  }
  .color-box {
    width: 16px;
    height: 16px;
    margin-right: 6px;
    border-radius: 3px;
  }
  .cerrar-leyenda {
    position: absolute;
    top: 5px;
    right: 6px;
    cursor: pointer;
    color: #efafd4;
    font-weight: bold;
  }
</style>
<!-- Ventana flotante de leyenda -->
<div class="ventana-leyenda" id="leyendaPartidos" style="display:none;">
<span class="cerrar-leyenda" onclick="cerrarLeyenda()">✖</span>
<h4>Ganadores 2024 (DL)</h4>
<div class="leyenda-item"><div class="color-box" style="background:#005CB9;"></div>PAN</div>
<div class="leyenda-item"><div class="color-box" style="background:#D71920;"></div>PRI</div>
<div class="leyenda-item"><div class="color-box" style="background:#8C1B1B;"></div>MORENA</div>
<div class="leyenda-item"><div class="color-box" style="background:#3BB54A;"></div>PVEM</div>
</div>
<script>
    const coloresPartidos = {
      "PAN": "#005CB9",
      "PRI": "#D71920",
      "MORENA": "#8C1B1B",
      "PVEM": "#3BB54A"
    };

    function pintarGanadores2024() {
      if (!capaSecciones || !datosElectorales) {
        console.error('Datos no disponibles');
        return;
      }

      capaSecciones.eachLayer(layer => {
        const props = layer.feature.properties;
        const seccion = props.SECCION; // Ajustar si tu campo se llama distinto
        const registro = datosElectorales.find(d => d.SECCION === seccion);

        if (registro && registro.GANADOR_24DL) {
          const partido = registro.GANADOR_24DL;
          const color = coloresPartidos[partido] || "#CCCCCC";
          layer.setStyle({ fillColor: color, fillOpacity: 0.6, color: "#333", weight: 1 });
        } else {
          layer.setStyle({ fillColor: "#CCCCCC", fillOpacity: 0.3, color: "#5A1818", weight: 1 });
        }
      });

      document.getElementById('leyendaPartidos').style.display = 'block';
    }

    function cerrarLeyenda() {
      document.getElementById('leyendaPartidos').style.display = 'none';
    }

    // Hacer la leyenda movible
    const leyenda = document.getElementById('leyendaPartidos');
    let offsetX, offsetY, isDragging = false;

    leyenda.addEventListener('mousedown', e => {
      if (e.target.classList.contains('cerrar-leyenda')) return;
      isDragging = true;
      offsetX = e.clientX - leyenda.getBoundingClientRect().left;
      offsetY = e.clientY - leyenda.getBoundingClientRect().top;
      leyenda.style.cursor = 'grabbing';
    });
    window.addEventListener('mouseup', () => {
      isDragging = false;
      leyenda.style.cursor = 'grab';
    });
    window.addEventListener('mousemove', e => {
      if (!isDragging) return;
      leyenda.style.left = (e.clientX - offsetX) + 'px';
      leyenda.style.top = (e.clientY - offsetY) + 'px';
      leyenda.style.bottom = 'auto';
    });
  </script>
<!-- Botón en la barra (ya existente) -->
<!-- Ajusta para que llame a la función -->
<script>
    document.querySelectorAll('.btn-consulta.generales')[0].onclick = pintarGanadores2024;
  </script>
<script>
    function reiniciarMapa() {
      // Quitar etiqueta de sección si existe
      if (tooltipSeccion) {
        map.removeLayer(tooltipSeccion);
        tooltipSeccion = null;
      }

      // Quitar resaltado de sección activa si existe
      if (ultimaCapaResaltada) {
        ultimaCapaResaltada.setStyle({ color: '#5A1818', weight: 2 });
        ultimaCapaResaltada = null;
      }

      // Restaurar estilos originales de todas las secciones
      capaSecciones.eachLayer(layer => {
        layer.setStyle({
          color: '#5A1818',
          weight: 2,
          fillOpacity: 0.07,
          fillColor: '#FFFFFF'
        });
      });

      // Volver a centrar el mapa con zoom 10
      map.setView([20.86492084469482, -100.72329019456481], 10);

      // Cerrar cualquier ventana flotante activa (leyendas, filtros, gráficas)
      document.querySelectorAll('.ventana-leyenda, .ventana-filtros, .ventana-grafica')
        .forEach(el => el.style.display = 'none');
    }
   // Conectar función al primer botón de la barra izquierda (Reiniciar Mapa)
    document.querySelectorAll('.barra-visuales .btn-consulta')[0].onclick = reiniciarMapa;
  </script>
<!-- === Consulta: Por Partido y Año (Ventana flotante + Pintado) === -->
<style>
  .ventana-filtros {
    position: fixed;
    top: 350px;
    left: 10%;
    transform: translateX(-50%);
    background: #fff;
    padding: 18px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 2000;
    min-width: 250px;
    display: none;
    cursor: grab;
    user-select: none;
  }
  .ventana-filtros h3 {
    margin-top: 0;
    color: #efafd4;
    font-size: 16px;
  }
  .cerrar-filtros {
    cursor: pointer;
    float: right;
    color: #efafd4;
    font-weight: bold;
  }
  .campo-filtro {
    margin: 8px 0;
    font-size: 14px;
  }
  .btn-ejecutar {
    background: #efafd4;
    color: #fff;
    border: none;
    padding: 7px 12px;
    cursor: pointer;
    border-radius: 6px;
    font-size: 14px;
  }
</style>
<!-- Ventana flotante de filtros -->
<div class="ventana-filtros" id="ventanaConsultaPartido">
<span class="cerrar-filtros" onclick="cerrarVentanaConsulta()">✖</span>
<h3>Consulta por Partido y Año</h3>
<div class="campo-filtro">
<label>Partido:</label>
<select id="filtroPartido">
<option value="PAN">PAN</option>
<option value="PRI">PRI</option>
<option value="MORENA">MORENA</option>
<option value="PVEM">PVEM</option>
</select>
</div>
<div class="campo-filtro">
<label>Año:</label>
<select id="filtroAnio">
<option value="2018">2018</option>
<option value="2021">2021</option>
<option value="2024">2024</option>
</select>
</div>
<button class="btn-ejecutar" onclick="ejecutarConsultaPartido()">Ejecutar</button>
</div>
<script>
  const ventanaConsulta = document.getElementById('ventanaConsultaPartido');
  let dragConsulta = { active: false, x: 0, y: 0 };

  // Hacer movible la ventana de filtros
  ventanaConsulta.addEventListener('pointerdown', e => {
    if (e.target.classList.contains('cerrar-filtros') || e.target.tagName === 'SELECT' || e.target.tagName === 'BUTTON') return;
    dragConsulta.active = true;
    dragConsulta.x = e.clientX - ventanaConsulta.offsetLeft;
    dragConsulta.y = e.clientY - ventanaConsulta.offsetTop;
    ventanaConsulta.setPointerCapture(e.pointerId);
  });
  ventanaConsulta.addEventListener('pointerup', () => { dragConsulta.active = false; });
  ventanaConsulta.addEventListener('pointermove', e => {
    if (!dragConsulta.active) return;
    ventanaConsulta.style.left = (e.clientX - dragConsulta.x) + 'px';
    ventanaConsulta.style.top = (e.clientY - dragConsulta.y) + 'px';
    ventanaConsulta.style.transform = 'none';
  });

  function abrirConsultaPartido() {
    ventanaConsulta.style.display = 'block';
  }
  function cerrarVentanaConsulta() {
    ventanaConsulta.style.display = 'none';
  }

  // Vincular al botón de la barra (📊 - segundo botón de la sección Generales)
  document.querySelectorAll('.btn-consulta.generales')[1].onclick = abrirConsultaPartido;

  // Función principal: pintar mapa y mostrar leyenda
  
  function ejecutarConsultaPartido() {
    if (!capaSecciones || !datosElectorales) {
      console.error('Datos no disponibles para consulta.');
      return;
    }

    const partido = document.getElementById('filtroPartido').value;
    const anio = document.getElementById('filtroAnio').value;

    const campo = (anio === '2018' ? '18DL_' : anio === '2021' ? '21DL_' : '24DL_') + partido;
    console.log(`Ejecutando consulta de depuración: Campo a buscar -> ${campo}`);

    let maxVotos = 0, minVotos = Infinity, totalSecciones = 0, totalVotos = 0;

    datosElectorales.forEach(d => {
      if (d[campo] !== undefined && d[campo] > 0) {
        maxVotos = Math.max(maxVotos, d[campo]);
        minVotos = Math.min(minVotos, d[campo]);
        totalVotos += d[campo];
      }
    });

    console.log(`Rango de votos encontrado: min=${minVotos}, max=${maxVotos}, total=${totalVotos}`);

 capaSecciones.eachLayer(layer => {
  const props = layer.feature.properties;
  const seccionGeo = String(props.SECCION).trim();
  const registro = datosElectorales.find(d => String(parseInt(d.SECCION)).trim() === seccionGeo);

  if (registro && registro[campo] !== undefined) {
    const votos = registro[campo];
    const intensidad = maxVotos > 0 ? votos / maxVotos : 0;
    const baseColor = coloresPartidos[partido] || "#999";
    const colorFinal = ajustarBrillo(baseColor, intensidad);

    console.log(`Sección ${seccionGeo} -> votos=${votos}, intensidad=${intensidad.toFixed(2)}, color=${colorFinal}`);

    layer.setStyle({ fillColor: colorFinal, fillOpacity: 0.6, color: "#333", weight: 1 });
    totalSecciones++;
  } else {
    console.warn(`Sección ${seccionGeo} no tiene datos para ${campo}`);
    // Colorear en rojo para identificar visualmente secciones sin datos
    layer.setStyle({ fillColor: "#FF0000", fillOpacity: 0.5, color: "#5A1818", weight: 1 });
  }
});


    console.log(`Total de secciones pintadas: ${totalSecciones}`);

    // Mostramos leyenda aunque sea básica (para confirmar)
    mostrarLeyendaPartido(partido, anio, totalSecciones, minVotos, maxVotos, totalVotos);
   // cerrarVentanaConsulta();
  }



  // Mostrar leyenda con gradiente, min/max y totales
  function mostrarLeyendaPartido(partido, anio, totalSecciones, minVotos, maxVotos, totalVotos) {
    let leyenda = document.getElementById('leyendaConsultaPartido');
    const baseColor = coloresPartidos[partido] || "#999";
    const estiloTotal = `font-weight:bold; color:${baseColor}; font-size:13px;`;

    if (!leyenda) {
        leyenda = document.createElement('div');
        leyenda.id = 'leyendaConsultaPartido';
        leyenda.className = 'ventana-leyenda';
        leyenda.innerHTML = `
          <span class="cerrar-leyenda" onclick="cerrarLeyendaPartido()">✖</span>
          <h4>${anio} - ${partido} (Dip. Local)</h4>
          <div class="leyenda-item">
            <div class="color-box" style="background:${baseColor};"></div><span class="partido-nombre">${partido}</span>
          </div>
          <div class="gradiente-container" style="margin-top:8px;">
            <div style="font-size:11px; display:flex; justify-content:space-between; margin-bottom:3px;">
              <span class="min-votos">Pocos votos (${minVotos || 0})</span>
              <span class="max-votos">Más votos (${maxVotos || 0})</span>
            </div>
            <div id="gradienteBarra" style="
              height:12px;
              border-radius:4px;
              background: linear-gradient(to right, ${ajustarBrillo(baseColor, 0.2)}, ${baseColor});
              border:1px solid #ccc;">
            </div>
          </div>
          <div class="contador-leyenda" style="margin-top:8px;">
            Secciones con datos: ${totalSecciones}<br>
            <span class="total-votos" style="${estiloTotal}">Total de votos: ${totalVotos.toLocaleString()}</span>
          </div>
        `;
        document.body.appendChild(leyenda);

        // Hacer movible
        let drag = { active: false, x: 0, y: 0 };
        leyenda.addEventListener('pointerdown', e => {
          if (e.target.classList.contains('cerrar-leyenda')) return;
          drag.active = true;
          drag.x = e.clientX - leyenda.offsetLeft;
          drag.y = e.clientY - leyenda.offsetTop;
          leyenda.setPointerCapture(e.pointerId);
        });
        leyenda.addEventListener('pointerup', () => { drag.active = false; });
        leyenda.addEventListener('pointermove', e => {
          if (!drag.active) return;
          leyenda.style.left = (e.clientX - drag.x) + 'px';
          leyenda.style.top = (e.clientY - drag.y) + 'px';
          leyenda.style.bottom = 'auto';
        });
      } else {
        // Actualizar si ya existe
        leyenda.querySelector('h4').textContent = `${anio} - ${partido} (Dip. Local)`;
        leyenda.querySelector('.color-box').style.background = baseColor;
        leyenda.querySelector('.partido-nombre').textContent = partido;
        leyenda.querySelector('#gradienteBarra').style.background =
          `linear-gradient(to right, ${ajustarBrillo(baseColor, 0.2)}, ${baseColor})`;
        leyenda.querySelector('.min-votos').textContent = `Pocos votos (${minVotos || 0})`;
        leyenda.querySelector('.max-votos').textContent = `Más votos (${maxVotos || 0})`;
        leyenda.querySelector('.total-votos').textContent = `Total de votos: ${totalVotos.toLocaleString()}`;
      }


    leyenda.style.display = 'block';
  }
</script>
<script>
      function cerrarLeyendaPartido() {
        const leyenda = document.getElementById('leyendaConsultaPartido');
        if (leyenda) leyenda.style.display = 'none';
      }
    </script>
<script>
  // Ajusta el brillo de un color HEX según un factor (0 a 1)
  function ajustarBrillo(hex, factor) {
    const f = parseInt(hex.slice(1), 16),
          t = factor < 0.5 ? 255 : 0,
          p = factor < 0.5 ? factor * 2 : (1 - factor) * 2,
          R = f >> 16,
          G = f >> 8 & 0x00FF,
          B = f & 0x0000FF;
    return "#" + (0x1000000 + (Math.round((t - R) * p) + R) * 0x10000 +
      (Math.round((t - G) * p) + G) * 0x100 +
      (Math.round((t - B) * p) + B)).toString(16).slice(1);
  }
</script>
<!-- === Consulta: Participación por Elección (Ventana flotante + Pintado) === -->
<style>
    .ventana-participacion {
      position: fixed;
      top: 300px;
      left: 10px;  /* En el panel lateral */
      width: 220px;
      background: #fff;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 3000;
      display: none;
      cursor: grab;
      user-select: none;
    }
    .ventana-participacion h3 {
      margin-top: 0;
      color: #efafd4;
      font-size: 16px;
    }
    .cerrar-participacion {
      cursor: pointer;
      float: right;
      color: #efafd4;
      font-weight: bold;
    }
    .btn-ejecutar {
      background: #efafd4;
      color: #fff;
      border: none;
      padding: 7px 12px;
      cursor: pointer;
      border-radius: 6px;
      font-size: 14px;
    }
  </style>
<!-- Ventana flotante -->
<div class="ventana-participacion" id="ventanaParticipacion">
<span class="cerrar-participacion" onclick="cerrarVentanaParticipacion()">✖</span>
<h3>Participación por Elección</h3>
<div class="campo-filtro">
<label>Año:</label>
<select id="filtroAnioParticipacion">
<option value="18">2018</option>
<option value="21">2021</option>
<option value="24">2024</option>
</select>
</div>
<button class="btn-ejecutar" onclick="ejecutarConsultaParticipacion()">Ejecutar</button>
</div>
<script>
    const ventanaParticipacion = document.getElementById('ventanaParticipacion');
    let dragPart = { active: false, x: 0, y: 0 };

    // Hacer la ventana movible
    ventanaParticipacion.addEventListener('pointerdown', e => {
      if (e.target.classList.contains('cerrar-participacion') || e.target.tagName === 'SELECT' || e.target.tagName === 'BUTTON') return;
      dragPart.active = true;
      dragPart.x = e.clientX - ventanaParticipacion.offsetLeft;
      dragPart.y = e.clientY - ventanaParticipacion.offsetTop;
      ventanaParticipacion.setPointerCapture(e.pointerId);
    });
    ventanaParticipacion.addEventListener('pointerup', () => { dragPart.active = false; });
    ventanaParticipacion.addEventListener('pointermove', e => {
      if (!dragPart.active) return;
      ventanaParticipacion.style.left = (e.clientX - dragPart.x) + 'px';
      ventanaParticipacion.style.top = (e.clientY - dragPart.y) + 'px';
      ventanaParticipacion.style.transform = 'none';
    });

    function abrirConsultaParticipacion() {
      ventanaParticipacion.style.display = 'block';
    }
    function cerrarVentanaParticipacion() {
      ventanaParticipacion.style.display = 'none';
    }

    // Vincular al botón de la barra (🗳️ - tercer botón de Generales)
    document.querySelectorAll('.btn-consulta.generales')[2].onclick = abrirConsultaParticipacion;

    // Ejecutar la consulta
    function ejecutarConsultaParticipacion() {
      if (!capaSecciones || !datosElectorales) {
        console.error('Datos no disponibles para consulta de participación.');
        return;
      }

      const anio = document.getElementById('filtroAnioParticipacion').value;
      const campo = `PARTICIPACION_${anio}`;

      let totalSecciones = 0;
      let sumaParticipacion = 0;

      capaSecciones.eachLayer(layer => {
        const props = layer.feature.properties;
        const seccionGeo = String(props.SECCION).trim();
        const registro = datosElectorales.find(d => String(parseInt(d.SECCION)).trim() === seccionGeo);

        if (registro && registro[campo] !== undefined) {
          const valor = registro[campo] * 100; // convertir a porcentaje
          let color = '#FF0000'; // rojo <30
          if (valor >= 50) color = '#2E7D32'; // verde
          else if (valor >= 30) color = '#FFEB3B'; // amarillo

          layer.setStyle({ fillColor: color, fillOpacity: 0.6, color: "#333", weight: 1 });
          sumaParticipacion += valor;
          totalSecciones++;
        } else {
          layer.setStyle({ fillColor: "#CCCCCC", fillOpacity: 0.3, color: "#5A1818", weight: 1 });
        }
      });

      const promedio = totalSecciones > 0 ? (sumaParticipacion / totalSecciones).toFixed(1) : 0;

      mostrarLeyendaParticipacion(anio, promedio);
     // cerrarVentanaParticipacion();
    }

    // Leyenda flotante para la consulta
    function mostrarLeyendaParticipacion(anio, promedio) {
      let leyenda = document.getElementById('leyendaParticipacion');

      if (!leyenda) {
        leyenda = document.createElement('div');
        leyenda.id = 'leyendaParticipacion';
        leyenda.className = 'ventana-leyenda';
        leyenda.innerHTML = `
          <span class="cerrar-leyenda" onclick="leyenda.style.display='none'">✖</span>
          <h4>Participación ${anio}</h4>
          <div class="leyenda-item"><div class="color-box" style="background:#FF0000;"></div><span>Menos de 30%</span></div>
          <div class="leyenda-item"><div class="color-box" style="background:#FFEB3B;"></div><span>30% a 50%</span></div>
          <div class="leyenda-item"><div class="color-box" style="background:#2E7D32;"></div><span>50% o más</span></div>
          <div class="contador-leyenda" style="margin-top:8px; font-weight:bold; color:#800020;">
            Promedio estatal: ${promedio}%
          </div>
        `;
        document.body.appendChild(leyenda);

        // Movible
        let drag = { active: false, x: 0, y: 0 };
        leyenda.addEventListener('pointerdown', e => {
          if (e.target.classList.contains('cerrar-leyenda')) return;
          drag.active = true;
          drag.x = e.clientX - leyenda.offsetLeft;
          drag.y = e.clientY - leyenda.offsetTop;
          leyenda.setPointerCapture(e.pointerId);
        });
        leyenda.addEventListener('pointerup', () => { drag.active = false; });
        leyenda.addEventListener('pointermove', e => {
          if (!drag.active) return;
          leyenda.style.left = (e.clientX - drag.x) + 'px';
          leyenda.style.top = (e.clientY - drag.y) + 'px';
          leyenda.style.bottom = 'auto';
        });
      } else {
        leyenda.querySelector('h4').textContent = `Participación ${anio}`;
        leyenda.querySelector('.contador-leyenda').textContent = `Promedio estatal: ${promedio}%`;
      }

      leyenda.style.display = 'block';
    }
  </script>
<!-- === Consulta: Fortaleza por Partido (Ventana flotante + Pintado + Leyenda) === -->
<style>
  .ventana-fortaleza {
    position: fixed;
    top: 300px;
    left: 10px;
    width: 210px;
    background: #fff;
    padding: 12px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 3000;
    display: none;
    cursor: grab;
    user-select: none;
  }
  .ventana-fortaleza h3 {
    margin-top: 0;
    color: #efafd4;
    font-size: 16px;
  }
  .cerrar-fortaleza {
    cursor: pointer;
    float: right;
    color: #efafd4;
    font-weight: bold;
  }
  .btn-ejecutar {
    background: #efafd4;
    color: #fff;
    border: none;
    padding: 7px 12px;
    cursor: pointer;
    border-radius: 6px;
    font-size: 14px;
  }
</style>
<!-- === Consulta: Fortaleza por Partido (Ventana flotante + Pintado + Leyenda) === -->
<style>
  .ventana-fortaleza {
    position: fixed;
    top: 300px;
    left: 30px;
    width: 220px;
    background: #fff;
    padding: 12px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 3000;
    display: none;
    cursor: grab;
    user-select: none;
  }
  .ventana-fortaleza h3 {
    margin-top: 0;
    color: #efafd4;
    font-size: 16px;
  }
  .cerrar-fortaleza {
    cursor: pointer;
    float: right;
    color: #efafd4;
    font-weight: bold;
  }
  .btn-ejecutar {
    background: #efafd4;
    color: #fff;
    border: none;
    padding: 7px 12px;
    cursor: pointer;
    border-radius: 6px;
    font-size: 14px;
  }
</style>
<!-- Ventana flotante -->
<div class="ventana-fortaleza" id="ventanaFortaleza">
<span class="cerrar-fortaleza" onclick="cerrarVentanaFortaleza()">✖</span>
<h3>Fortaleza por Partido</h3>
<div class="campo-filtro">
<label>Partido:</label>
<select id="filtroPartidoFortaleza">
<option value="PAN">PAN</option>
<option value="PRI">PRI</option>
<option value="MORENA">MORENA</option>
<option value="PVEM">PVEM</option>
</select>
</div>
<div class="campo-filtro">
<label>Año:</label>
<select id="filtroAnioFortaleza">
<option value="18">2018</option>
<option value="21">2021</option>
<option value="24">2024</option>
</select>
</div>
<button class="btn-ejecutar" onclick="ejecutarConsultaFortaleza()">Ejecutar</button>
</div>
<script>
  const ventanaFortaleza = document.getElementById('ventanaFortaleza');
  let dragFort = { active: false, x: 0, y: 0 };

  ventanaFortaleza.addEventListener('pointerdown', e => {
    if (e.target.classList.contains('cerrar-fortaleza') || e.target.tagName === 'SELECT' || e.target.tagName === 'BUTTON') return;
    dragFort.active = true;
    dragFort.x = e.clientX - ventanaFortaleza.offsetLeft;
    dragFort.y = e.clientY - ventanaFortaleza.offsetTop;
    ventanaFortaleza.setPointerCapture(e.pointerId);
  });
  ventanaFortaleza.addEventListener('pointerup', () => { dragFort.active = false; });
  ventanaFortaleza.addEventListener('pointermove', e => {
    if (!dragFort.active) return;
    ventanaFortaleza.style.left = (e.clientX - dragFort.x) + 'px';
    ventanaFortaleza.style.top = (e.clientY - dragFort.y) + 'px';
    ventanaFortaleza.style.transform = 'none';
  });

  function abrirConsultaFortaleza() {
    ventanaFortaleza.style.display = 'block';
  }
  function cerrarVentanaFortaleza() {
    ventanaFortaleza.style.display = 'none';
  }

  // Vincular al botón de la barra (💪 - cuarto botón de Generales)
  document.querySelectorAll('.btn-consulta.generales')[3].onclick = abrirConsultaFortaleza;

  const coloresFortaleza = {
    mayor50: "#1e88e5",      // ganó por ≥50 votos
    mayor1000: "#43a047",    // ganó por ≥1000 votos
    dobleSegundo: "#f4511e"  // ganó con el doble de votos del segundo
  };

  function ejecutarConsultaFortaleza() {
    if (!capaSecciones || !datosElectorales) {
      console.error('Datos no disponibles para consulta de fortaleza.');
      return;
    }

    const partido = document.getElementById('filtroPartidoFortaleza').value;
    const anio = document.getElementById('filtroAnioFortaleza').value;
    const campos = ['PAN', 'PRI', 'PVEM', 'MORENA'].map(p => `${anio}DL_${p}`);

    let seccionesGanadas = 0;
    let totalVotosGanados = 0;
    let totalSecciones = 0;

    capaSecciones.eachLayer(layer => {
      const props = layer.feature.properties;
      const seccionGeo = String(props.SECCION).trim();
      const registro = datosElectorales.find(d => String(parseInt(d.SECCION)).trim() === seccionGeo);

      if (registro) {
        const votos = campos.map(c => registro[c] || 0);
        const partidos = ['PAN', 'PRI', 'PVEM', 'MORENA'];
        const ranking = partidos.map((p, i) => ({ partido: p, votos: votos[i] }))
          .sort((a, b) => b.votos - a.votos);

        const ganador = ranking[0];
        const segundo = ranking[1];

        if (ganador.partido === partido) {
          const diff = ganador.votos - segundo.votos;
          let color = "#CCCCCC";

          if (ganador.votos >= segundo.votos * 2) color = coloresFortaleza.dobleSegundo;
          else if (diff >= 1000) color = coloresFortaleza.mayor1000;
          else if (diff >= 50) color = coloresFortaleza.mayor50;

          layer.setStyle({ fillColor: color, fillOpacity: 0.6, color: "#333", weight: 1 });
          seccionesGanadas++;
          totalVotosGanados += ganador.votos;
        } else {
          layer.setStyle({ fillColor: "#CCCCCC", fillOpacity: 0.3, color: "#5A1818", weight: 1 });
        }

        totalSecciones++;
      }
    });

    const porcentajeGanadas = totalSecciones > 0 ? ((seccionesGanadas / totalSecciones) * 100).toFixed(1) : 0;
    mostrarLeyendaFortaleza(partido, anio, seccionesGanadas, totalSecciones, porcentajeGanadas, totalVotosGanados);
    //cerrarVentanaFortaleza();
  }

  function mostrarLeyendaFortaleza(partido, anio, ganadas, total, porcentaje, totalVotos) {
  let leyenda = document.getElementById('leyendaFortaleza');

  if (!leyenda) {
    leyenda = document.createElement('div');
    leyenda.id = 'leyendaFortaleza';
    leyenda.className = 'ventana-leyenda';
    leyenda.innerHTML = `
      <span class="cerrar-leyenda" onclick="cerrarLeyendaFortaleza()">✖</span>
      <h4>Fortaleza ${anio} - ${partido}</h4>
      <div class="leyenda-item"><div class="color-box" style="background:${coloresFortaleza.dobleSegundo};"></div><span>Ganó con el doble de votos del 2º</span></div>
      <div class="leyenda-item"><div class="color-box" style="background:${coloresFortaleza.mayor1000};"></div><span>Ganó por ≥1000 votos</span></div>
      <div class="leyenda-item"><div class="color-box" style="background:${coloresFortaleza.mayor50};"></div><span>Ganó por ≥50 votos</span></div>
      <div class="contador-leyenda" style="margin-top:8px; font-weight:bold; color:#800020;">
        Secciones ganadas: ${ganadas}/${total} (${porcentaje}%)<br>
        Total de votos en ganadas: ${totalVotos.toLocaleString()}
      </div>
    `;
    document.body.appendChild(leyenda);

    // Hacer movible
    let drag = { active: false, x: 0, y: 0 };
    leyenda.addEventListener('pointerdown', e => {
      if (e.target.classList.contains('cerrar-leyenda')) return;
      drag.active = true;
      drag.x = e.clientX - leyenda.offsetLeft;
      drag.y = e.clientY - leyenda.offsetTop;
      leyenda.setPointerCapture(e.pointerId);
    });
    leyenda.addEventListener('pointerup', () => { drag.active = false; });
    leyenda.addEventListener('pointermove', e => {
      if (!drag.active) return;
      leyenda.style.left = (e.clientX - drag.x) + 'px';
      leyenda.style.top = (e.clientY - drag.y) + 'px';
      leyenda.style.bottom = 'auto';
    });
  } else {
    leyenda.querySelector('h4').textContent = `Fortaleza ${anio} - ${partido}`;
    leyenda.querySelector('.contador-leyenda').innerHTML =
      `Secciones ganadas: ${ganadas}/${total} (${porcentaje}%)<br>
       Total de votos en ganadas: ${totalVotos.toLocaleString()}`;
  }

  leyenda.style.display = 'block';
}

// Nueva función global para cerrar
function cerrarLeyendaFortaleza() {
  const leyenda = document.getElementById('leyendaFortaleza');
  if (leyenda) leyenda.style.display = 'none';
}

</script>
<script>
  // Colores para los rangos de diferencia
  const coloresDiferencia = {
    negativo: "#E53935",     // Participación bajó
    aumentoModerado: "#81C784",  // Subió 0–30%
    aumentoAlto: "#2E7D32"       // Subió >30%
  };

  // Vincular al botón de la barra (📈 - quinto botón de Generales)
  document.querySelectorAll('.btn-consulta.generales')[4].onclick = ejecutarComparacionParticipacion;

  function ejecutarComparacionParticipacion() {
    if (!capaSecciones || !datosElectorales) {
      console.error('Datos no disponibles para comparación de participación.');
      return;
    }

    let totalSecciones = 0;
    let sumaDiferencia = 0;

    capaSecciones.eachLayer(layer => {
      const props = layer.feature.properties;
      const seccionGeo = String(props.SECCION).trim();
      const registro = datosElectorales.find(d => String(parseInt(d.SECCION)).trim() === seccionGeo);

      if (registro && registro.PARTICIPACION_18 !== undefined && registro.PARTICIPACION_24 !== undefined) {
        const diff = registro.PARTICIPACION_24 - registro.PARTICIPACION_18;
        sumaDiferencia += diff;
        totalSecciones++;

        let color = coloresDiferencia.negativo;
        if (diff >= 0 && diff <= 30) color = coloresDiferencia.aumentoModerado;
        else if (diff > 30) color = coloresDiferencia.aumentoAlto;

        layer.setStyle({ fillColor: color, fillOpacity: 0.6, color: "#333", weight: 1 });
      } else {
        layer.setStyle({ fillColor: "#CCCCCC", fillOpacity: 0.3, color: "#5A1818", weight: 1 });
      }
    });

    const promedio = totalSecciones > 0 ? (sumaDiferencia / totalSecciones).toFixed(1) : 0;
    mostrarLeyendaDiferencia(promedio, totalSecciones);
  }

  function mostrarLeyendaDiferencia(promedio, totalSecciones) {
    let leyenda = document.getElementById('leyendaDiferencia');

    if (!leyenda) {
      leyenda = document.createElement('div');
      leyenda.id = 'leyendaDiferencia';
      leyenda.className = 'ventana-leyenda';
      leyenda.innerHTML = `
        <span class="cerrar-leyenda" onclick="cerrarLeyendaDiferencia()">✖</span>
        <h4>Participación 2018 vs 2024</h4>
        <div class="leyenda-item"><div class="color-box" style="background:${coloresDiferencia.negativo};"></div><span>Disminución (<0%)</span></div>
        <div class="leyenda-item"><div class="color-box" style="background:${coloresDiferencia.aumentoModerado};"></div><span>Aumento 0–30%</span></div>
        <div class="leyenda-item"><div class="color-box" style="background:${coloresDiferencia.aumentoAlto};"></div><span>Aumento >30%</span></div>
        <div class="contador-leyenda" style="margin-top:8px; font-weight:bold; color:#800020;">
          Secciones analizadas: ${totalSecciones}<br>
          Promedio de diferencia: ${promedio}%
        </div>
      `;
      document.body.appendChild(leyenda);

      // Hacer movible
      let drag = { active: false, x: 0, y: 0 };
      leyenda.addEventListener('pointerdown', e => {
        if (e.target.classList.contains('cerrar-leyenda')) return;
        drag.active = true;
        drag.x = e.clientX - leyenda.offsetLeft;
        drag.y = e.clientY - leyenda.offsetTop;
        leyenda.setPointerCapture(e.pointerId);
      });
      leyenda.addEventListener('pointerup', () => { drag.active = false; });
      leyenda.addEventListener('pointermove', e => {
        if (!drag.active) return;
        leyenda.style.left = (e.clientX - drag.x) + 'px';
        leyenda.style.top = (e.clientY - drag.y) + 'px';
        leyenda.style.bottom = 'auto';
      });
    } else {
      leyenda.querySelector('.contador-leyenda').innerHTML =
        `Secciones analizadas: ${totalSecciones}<br>
         Promedio de diferencia: ${promedio}%`;
    }

    leyenda.style.display = 'block';
  }

  function cerrarLeyendaDiferencia() {
    const leyenda = document.getElementById('leyendaDiferencia');
    if (leyenda) leyenda.style.display = 'none';
  }
</script>
<script>
  const coloresPartidosSuaves = {
    PAN: "#4A90E2",
    PRI: "#E57373",
    PVEM: "#66BB6A",
    MORENA: "#A0525C",
    ALTERNANCIA: "#FFEB3B"
  };

  let etiquetasAlternancia = [];

  
  // Limpia etiquetas, leyendas y ventanas flotantes sin reiniciar el mapa
    function ocultarElementosFlotantes() {
      // Ocultar todas las ventanas flotantes (paneles y leyendas)
      document.querySelectorAll('.ventana-flotante').forEach(v => {
        v.style.display = 'none';
      });

      // Eliminar cualquier etiqueta activa en el mapa
      if (window.etiquetaActiva) {
        map.removeLayer(window.etiquetaActiva);
        window.etiquetaActiva = null;
      }
    }


  // Vincular al botón de la barra (🔄 - sexto botón de Generales)
  document.querySelectorAll('.btn-consulta.generales')[5].onclick = ejecutarAlternancia;
  
  function ejecutarAlternancia() {
  if (!capaSecciones || !datosElectorales) {
    console.error('Datos no disponibles para Alternancia.');
    return;
  }

  // Limpiar etiquetas previas
  etiquetasAlternancia.forEach(e => map.removeLayer(e));
  etiquetasAlternancia = [];

  let totalSecciones = 0;
  let alternanciaCount = 0;

  capaSecciones.eachLayer(layer => {
    const props = layer.feature.properties;
    const seccionGeo = String(props.SECCION).trim();
    const registro = datosElectorales.find(d => String(parseInt(d.SECCION)).trim() === seccionGeo);

    if (registro) {
      const g18 = registro.GANADOR_18DL || '';
      const g21 = registro.GANADOR_21DL || '';
      const g24 = registro.GANADOR_24DL || '';

      totalSecciones++;

      const mismoPartido = (g18 === g21 && g21 === g24 && g18 !== '');
      let color = coloresPartidosSuaves.ALTERNANCIA;

      if (mismoPartido) {
        color = coloresPartidosSuaves[g18] || "#CCCCCC";
      } else {
        alternanciaCount++;

        // Crear la etiqueta pero NO agregarla aún (se controla con zoom)
        const secuencia = `${g18 || '-'}-${g21 || '-'}-${g24 || '-'}`;
        const label = L.marker(layer.getBounds().getCenter(), {
          icon: L.divIcon({
            className: 'etiqueta-seccion',
            html: `<div class="etiqueta-burbuja">${secuencia}</div>`,
            iconSize: [100, 30],
            iconAnchor: [50, 15]
          })
        });
        etiquetasAlternancia.push(label);
      }

      layer.setStyle({ fillColor: color, fillOpacity: 0.6, color: "#333", weight: 1 });
    } else {
      layer.setStyle({ fillColor: "#CCCCCC", fillOpacity: 0.3, color: "#5A1818", weight: 1 });
    }
  });

  // Controlar visibilidad de etiquetas según el zoom (con fade-in)
  map.off('zoomend', controlarEtiquetasAlternancia); // Evitar duplicados
  map.on('zoomend', controlarEtiquetasAlternancia);
  controlarEtiquetasAlternancia(); // Ejecutar al inicio por si ya está en zoom alto

  const porcentajeAlt = totalSecciones > 0 ? ((alternanciaCount / totalSecciones) * 100).toFixed(1) : 0;
  mostrarLeyendaAlternancia(alternanciaCount, totalSecciones, porcentajeAlt);
}

// Función para manejar etiquetas según zoom (con animación)
function controlarEtiquetasAlternancia() {
  const mostrar = map.getZoom() >= 13;
  etiquetasAlternancia.forEach(etq => {
    const div = etq.getElement();
    if (mostrar) {
      etq.addTo(map);
      if (div) {
        div.classList.remove('visible'); // reset
        setTimeout(() => div.classList.add('visible'), 50); // fade-in
      }
    } else {
      if (div) div.classList.remove('visible');
      map.removeLayer(etq);
    }
  });
}


  function mostrarLeyendaAlternancia(alternanciaCount, totalSecciones, porcentaje) {
    let leyenda = document.getElementById('leyendaAlternancia');

    if (!leyenda) {
      leyenda = document.createElement('div');
      leyenda.id = 'leyendaAlternancia';
      leyenda.className = 'ventana-leyenda';
      leyenda.innerHTML = `
        <span class="cerrar-leyenda" onclick="cerrarLeyendaAlternancia()">✖</span>
        <h4>Alternancia 2018-2024</h4>
        <div class="leyenda-item"><div class="color-box" style="background:${coloresPartidosSuaves.PAN};"></div>PAN (3 elecciones)</div>
        <div class="leyenda-item"><div class="color-box" style="background:${coloresPartidosSuaves.PRI};"></div>PRI (3 elecciones)</div>
        <div class="leyenda-item"><div class="color-box" style="background:${coloresPartidosSuaves.PVEM};"></div>PVEM (3 elecciones)</div>
        <div class="leyenda-item"><div class="color-box" style="background:${coloresPartidosSuaves.MORENA};"></div>MORENA (3 elecciones)</div>
        <div class="leyenda-item"><div class="color-box" style="background:${coloresPartidosSuaves.ALTERNANCIA};"></div>Alternancia (cambio)</div>
        <div class="contador-leyenda" style="margin-top:8px; font-weight:bold; color:#800020;">
          Secciones con alternancia: ${alternanciaCount}/${totalSecciones} (${porcentaje}%)
        </div>
      `;
      document.body.appendChild(leyenda);

      // Movible
      let drag = { active: false, x: 0, y: 0 };
      leyenda.addEventListener('pointerdown', e => {
        if (e.target.classList.contains('cerrar-leyenda')) return;
        drag.active = true;
        drag.x = e.clientX - leyenda.offsetLeft;
        drag.y = e.clientY - leyenda.offsetTop;
        leyenda.setPointerCapture(e.pointerId);
      });
      leyenda.addEventListener('pointerup', () => { drag.active = false; });
      leyenda.addEventListener('pointermove', e => {
        if (!drag.active) return;
        leyenda.style.left = (e.clientX - drag.x) + 'px';
        leyenda.style.top = (e.clientY - drag.y) + 'px';
        leyenda.style.bottom = 'auto';
      });
    } else {
      leyenda.querySelector('.contador-leyenda').innerHTML =
        `Secciones con alternancia: ${alternanciaCount}/${totalSecciones} (${porcentaje}%)`;
    }

    leyenda.style.display = 'block';
  }

  function cerrarLeyendaAlternancia() {
    const leyenda = document.getElementById('leyendaAlternancia');
    if (leyenda) leyenda.style.display = 'none';
  }

  // Extender reiniciarMapa para limpiar etiquetas de alternancia
  const oldReiniciarMapaAlt = reiniciarMapa;
  reiniciarMapa = function() {
    etiquetasAlternancia.forEach(e => map.removeLayer(e));
    etiquetasAlternancia = [];
    oldReiniciarMapaAlt();
  };
</script>
<style>
  /* Estilo moderno para las etiquetas de alternancia */
  .etiqueta-burbuja {
    background: rgba(255,255,255,0.9);
    border: 1px solid #efafd4;
    border-radius: 12px;
    padding: 2px 8px;
    font-size: 12px;
    font-weight: bold;
    color: #efafd4;
    text-align: center;
    white-space: nowrap;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  }
</style>
<style>
.panel-flotante {
  z-index: 3000 !important;  /* por encima del panel lateral */
}

.leyenda {
  z-index: 2999 !important;  /* un poco menos que el panel */
}

</style>
<script>
  const coloresEstabilidad = {
    alta: { PAN: "#4A90E2", PRI: "#E57373", PVEM: "#66BB6A", MORENA: "#A0525C" }, // mismos tonos que Alternancia
    media: "#81D4FA",        // Azul claro
    inestable: "#FFB74D"     // Naranja claro
  };

  let etiquetasInestabilidad = [];

  // Vincular al botón de la barra (⚖️ - séptimo botón de Generales)
  document.querySelectorAll('.btn-consulta.generales')[6].onclick = ejecutarEstabilidad;

  function ejecutarEstabilidad() {
    if (!capaSecciones || !datosElectorales) {
      console.error('Datos no disponibles para Estabilidad Política.');
      return;
    }

    // Limpiar etiquetas previas
    etiquetasInestabilidad.forEach(e => map.removeLayer(e));
    etiquetasInestabilidad = [];

    let totalSecciones = 0;
    let cuentaAlta = 0, cuentaMedia = 0, cuentaInestable = 0;

    capaSecciones.eachLayer(layer => {
      const props = layer.feature.properties;
      const seccionGeo = String(props.SECCION).trim();
      const registro = datosElectorales.find(d => String(parseInt(d.SECCION)).trim() === seccionGeo);

      if (registro) {
        const g18 = registro.GANADOR_18DL || '';
        const g21 = registro.GANADOR_21DL || '';
        const g24 = registro.GANADOR_24DL || '';

        totalSecciones++;
        let color = "#CCCCCC";

        if (g18 && g21 && g24) {
          if (g18 === g21 && g21 === g24) {
            // Alta estabilidad (mismo partido)
            cuentaAlta++;
            color = coloresEstabilidad.alta[g18] || "#CCCCCC";
          } else if (
            (g18 === g21 && g24 !== g18) ||
            (g18 === g24 && g21 !== g18) ||
            (g21 === g24 && g18 !== g21)
          ) {
            // Estabilidad media (un cambio)
            cuentaMedia++;
            color = coloresEstabilidad.media;
          } else {
            // Inestabilidad alta (3 partidos diferentes)
            cuentaInestable++;
            color = coloresEstabilidad.inestable;

            const secuencia = `${g18 || '-'}-${g21 || '-'}-${g24 || '-'}`;
            const label = L.marker(layer.getBounds().getCenter(), {
              icon: L.divIcon({
                className: 'etiqueta-seccion',
                html: `<div class="etiqueta-burbuja">${secuencia}</div>`,
                iconSize: [100, 30],
                iconAnchor: [50, 15]
              })
            });
            etiquetasInestabilidad.push(label);
          }
        }

        layer.setStyle({ fillColor: color, fillOpacity: 0.6, color: "#333", weight: 1 });
      } else {
        layer.setStyle({ fillColor: "#CCCCCC", fillOpacity: 0.3, color: "#5A1818", weight: 1 });
      }
    });

    // Control de etiquetas por zoom con fade-in
    map.off('zoomend', controlarEtiquetasInestabilidad);
    map.on('zoomend', controlarEtiquetasInestabilidad);
    controlarEtiquetasInestabilidad();

    const porcentajeAlta = totalSecciones ? ((cuentaAlta / totalSecciones) * 100).toFixed(1) : 0;
    const porcentajeMedia = totalSecciones ? ((cuentaMedia / totalSecciones) * 100).toFixed(1) : 0;
    const porcentajeInestable = totalSecciones ? ((cuentaInestable / totalSecciones) * 100).toFixed(1) : 0;

    mostrarLeyendaEstabilidad(cuentaAlta, porcentajeAlta, cuentaMedia, porcentajeMedia, cuentaInestable, porcentajeInestable, totalSecciones);
  }

  function controlarEtiquetasInestabilidad() {
    const mostrar = map.getZoom() >= 13;
    etiquetasInestabilidad.forEach(etq => {
      const div = etq.getElement();
      if (mostrar) {
        etq.addTo(map);
        if (div) {
          div.classList.remove('visible');
          setTimeout(() => div.classList.add('visible'), 50);
        }
      } else {
        if (div) div.classList.remove('visible');
        map.removeLayer(etq);
      }
    });
  }

  function mostrarLeyendaEstabilidad(cAlta, pAlta, cMedia, pMedia, cInest, pInest, total) {
    let leyenda = document.getElementById('leyendaEstabilidad');

    if (!leyenda) {
      leyenda = document.createElement('div');
      leyenda.id = 'leyendaEstabilidad';
      leyenda.className = 'ventana-leyenda';
      leyenda.innerHTML = `
        <span class="cerrar-leyenda" onclick="cerrarLeyendaEstabilidad()">✖</span>
        <h4>Estabilidad Política 2018-2024</h4>
        <div class="leyenda-item"><div class="color-box" style="background:${coloresEstabilidad.alta.PAN};"></div>Alta (mismo partido 3 elecciones): ${cAlta} (${pAlta}%)</div>
        <div class="leyenda-item"><div class="color-box" style="background:${coloresEstabilidad.media};"></div>Estabilidad Media (1 cambio): ${cMedia} (${pMedia}%)</div>
        <div class="leyenda-item"><div class="color-box" style="background:${coloresEstabilidad.inestable};"></div>Inestabilidad Alta (3 partidos): ${cInest} (${pInest}%)</div>
        <div class="contador-leyenda" style="margin-top:8px; font-weight:bold; color:#800020;">
          Total secciones analizadas: ${total}
        </div>
      `;
      document.body.appendChild(leyenda);

      // Hacer la leyenda movible
      let drag = { active: false, x: 0, y: 0 };
      leyenda.addEventListener('pointerdown', e => {
        if (e.target.classList.contains('cerrar-leyenda')) return;
        drag.active = true;
        drag.x = e.clientX - leyenda.offsetLeft;
        drag.y = e.clientY - leyenda.offsetTop;
        leyenda.setPointerCapture(e.pointerId);
      });
      leyenda.addEventListener('pointerup', () => { drag.active = false; });
      leyenda.addEventListener('pointermove', e => {
        if (!drag.active) return;
        leyenda.style.left = (e.clientX - drag.x) + 'px';
        leyenda.style.top = (e.clientY - drag.y) + 'px';
        leyenda.style.bottom = 'auto';
      });
    } else {
      // Actualizar totales si ya existe
      const items = leyenda.querySelectorAll('.leyenda-item');
      items[0].innerHTML = `<div class="color-box" style="background:${coloresEstabilidad.alta.PAN};"></div>Alta (mismo partido 3 elecciones): ${cAlta} (${pAlta}%)`;
      items[1].innerHTML = `<div class="color-box" style="background:${coloresEstabilidad.media};"></div>Estabilidad Media (1 cambio): ${cMedia} (${pMedia}%)`;
      items[2].innerHTML = `<div class="color-box" style="background:${coloresEstabilidad.inestable};"></div>Inestabilidad Alta (3 partidos): ${cInest} (${pInest}%)`;
      leyenda.querySelector('.contador-leyenda').innerHTML = `Total secciones analizadas: ${total}`;
    }

    leyenda.style.display = 'block';
  }

  function cerrarLeyendaEstabilidad() {
    const leyenda = document.getElementById('leyendaEstabilidad');
    if (leyenda) leyenda.style.display = 'none';
  }

  // Extender reiniciarMapa para limpiar etiquetas de inestabilidad
  const oldReiniciarMapaEstabilidad = reiniciarMapa;
  reiniciarMapa = function() {
    etiquetasInestabilidad.forEach(e => map.removeLayer(e));
    etiquetasInestabilidad = [];
    oldReiniciarMapaEstabilidad();
  };
</script>
<!-- === Consulta: Comparativa Histórica por Puesto === -->
<style>
  .ventana-comparativa {
    position: fixed;
    top: 100px;
    left: 20px; /* Sobre panel lateral */
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 3000;
    width: 320px;
    height: 400px;
    min-width: 280px;
    min-height: 280px;
    display: none;
    padding: 14px;
    overflow-y: auto;
    cursor: grab;
    user-select: none;
    resize: both; /* Permite redimensionar */
  }
  .ventana-comparativa h3 {
    margin: 0 0 8px;
    font-size: 16px;
    font-weight: bold;
    color: #efafd4;
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: move;
  }
  .ventana-comparativa h3::before {
    content: "⏱️";
    margin-right: 6px;
  }
  .cerrar-comparativa {
    cursor: pointer;
    color: #efafd4;
    font-weight: bold;
    font-size: 16px;
    margin-left: 8px;
  }
  .handle-resize {
    position: absolute;
    bottom: 4px;
    right: 4px;
    width: 14px;
    height: 14px;
    cursor: se-resize;
    background: #efafd4;
    border-radius: 3px;
  }
  .campo-filtro {
    margin: 6px 0;
    font-size: 14px;
  }
  .btn-ejecutar {
    background: #efafd4;
    color: #fff;
    border: none;
    padding: 6px 12px;
    cursor: pointer;
    border-radius: 6px;
    font-size: 14px;
    margin-bottom: 10px;
  }
  .tabla-comparativa {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    margin-top: 6px;
  }
  .tabla-comparativa th, .tabla-comparativa td {
    border: 1px solid #ccc;
    padding: 4px 6px;
    text-align: center;
  }
  .grafica-container {
    margin-top: 10px;
  }
</style>
<div class="ventana-comparativa" id="ventanaComparativa">
<h3>
<span>Comparativa Histórica</span>
<span class="cerrar-comparativa" onclick="cerrarComparativa()">✖</span>
</h3>
<div class="campo-filtro">
<label>Puesto:</label>
<select id="filtroPuesto">
<option value="A">Ayuntamiento</option>
<option value="DL">Diputado Local</option>
<option value="DF">Diputado Federal</option>
<option value="G">Gobernador</option>
<option value="S">Senador</option>
<option value="P">Presidente</option>
</select>
</div>
<div id="contenedorTabla"></div>
<div class="grafica-container">
<canvas height="200" id="graficaComparativa"></canvas>
</div>
<div class="handle-resize"></div>
</div>
<!-- Botón para restablecer vista inicial -->
<button class="btn-restablecer" id="btn-restablecer">Vista Inicial</button>
<!-- Leyenda flotante -->
<div class="ventana-flotante" id="ventana-leyenda">
<div class="ventana-header" onmousedown="arrastrarVentana(event, this.parentElement)">
    Leyenda
    <span class="cerrar" onclick="document.getElementById('ventana-leyenda').style.display='none'">✖</span>
</div>
<div class="ventana-body">
<div><div class="color-box" style="background:blue;"></div>PAN</div>
<div><div class="color-box" style="background:red;"></div>PRI</div>
<div><div class="color-box" style="background:#800020;"></div>MORENA</div>
<div><div class="color-box" style="background:green;"></div>PVEM</div>
<small style="display:block;margin-top:5px;color:#555;">Colores: partido ganador (Proyección 2027)</small>
</div>
</div>
<!-- aqui empieza el codigo de la consulta GANAR TODO-->
<!-- aqui empieza el codigo de la consulta GANAR TODO-->
<!-- aqui empieza el codigo de la consulta GANAR TODO-->
<!-- aqui empieza el codigo de la consulta GANAR TODO-->
<!-- Ventana flotante Ganar Todo -->
<style>
  #ventana-ganartodo {
    position: absolute;
    top: 60px;
    left: 440px;
    width: 360px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 5px 12px rgba(0,0,0,0.25);
    z-index: 3000;
    display: none;
    font-family: Arial, sans-serif;
    font-size: 13px;
    line-height: 1.4;
    resize: both;
    overflow: auto;
    min-width: 320px;
    min-height: 220px;
  }
  #ventana-ganartodo .ventana-header {
    background: #efafd4;
    color: #fff;
    padding: 6px 10px;
    font-weight: bold;
    cursor: move;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 10px 10px 0 0;
    font-size: 14px;
  }
  #ventana-ganartodo .ventana-body {
    padding: 8px 10px;
    background: #fafafa;
    max-height: 380px;
    overflow-y: auto;
  }
  #ventana-ganartodo select, #ventana-ganartodo button {
    width: 100%;
    margin: 4px 0;
    font-size: 13px;
  }
  #ventana-ganartodo button {
    background: #efafd4;
    color: #fff;
    border: none;
    padding: 6px;
    border-radius: 6px;
    cursor: pointer;
  }
  #ventana-ganartodo button:hover { background: #efafd4; }
  #tablaResultados {
    width:100%;
    border-collapse: collapse;
    margin-top: 8px;
    font-size: 12px;
  }
  #tablaResultados th, #tablaResultados td {
    border: 1px solid #ddd;
    padding: 4px;
    text-align: center;
  }
  #tablaResultados tr:hover { background: #f5f5f5; cursor: pointer; }
</style>
<div class="ventana-flotante" id="ventana-ganartodo">
<div class="ventana-header" onmousedown="arrastrarVentana(event, this.parentElement)">
    ¿Qué se requiere para ganar todo?
    <span class="cerrar" onclick="document.getElementById('ventana-ganartodo').style.display='none'">✖</span>
</div>
<div class="ventana-body">
<label for="puesto">Puesto</label>
<select id="puesto">
<option value="A">Ayuntamiento</option>
<option value="DL">Diputado Local</option>
<option value="DF">Diputado Federal</option>
</select>
<label for="partido">Partido</label>
<select id="partido">
<option value="PAN">PAN</option>
<option value="PRI">PRI</option>
<option value="MORENA">MORENA</option>
<option value="PVEM">PVEM</option>
</select>
<label for="distritoLocal">Distrito Local</label>
<select id="distritoLocal">
<option value="9">Distrito Local 9</option>
<option value="17">Distrito Local 17</option>
<option value="16">Distrito Local 16</option>
</select>
<button onclick="ejecutarConsulta()">Ejecutar Consulta</button>
<table id="tablaResultados">
<thead>
<tr><th>Sección</th><th>Partido Ganador</th><th>Votos</th><th>Faltan</th></tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
<script>

  // Abrir ventana de Ganar Todo al hacer clic en su botón
    document.querySelectorAll('.btn-consulta.comparativas')[5].onclick = function() {
      // Cierra cualquier ventana flotante activa
      document.querySelectorAll('.ventana-flotante').forEach(v => v.style.display = 'none');
      // Abre esta ventana
      document.getElementById('ventana-ganartodo').style.display = 'block';
    };

 function ejecutarConsulta() {
  const puesto = document.getElementById('puesto').value;
  const partido = document.getElementById('partido').value;
  const distritoLocal = document.getElementById('distritoLocal').value;

  const tbody = document.querySelector('#tablaResultados tbody');
  tbody.innerHTML = '';

  if (!capaSecciones || !datosElectorales.length) {
    alert('Las secciones o los datos electorales no están listos.');
    return;
  }

  const resultados = [];

  capaSecciones.eachLayer(layer => {
    const props = layer.feature.properties;
    if (distritoLocal && String(props.DISTRITO_L) !== String(distritoLocal)) return;

    const datos = datosElectorales.find(d => String(d.SECCION) === String(props.SECCION));
    if (!datos) return;

    const votos = {
      PAN: datos[`PROY_2027_${puesto}_PAN`] || 0,
      PRI: datos[`PROY_2027_${puesto}_PRI`] || 0,
      MORENA: datos[`PROY_2027_${puesto}_MORENA`] || 0,
      PVEM: datos[`PROY_2027_${puesto}_PVEM`] || 0
    };

    const orden = Object.entries(votos).sort((a, b) => b[1] - a[1]);
    const ganador = orden[0][0];
    const votosGanador = orden[0][1];
    const votosSeleccionado = votos[partido] || 0;

    let faltan = 0;
    let estado = 'ganada';
    if (partido !== ganador) {
      faltan = Math.max(0, votosGanador - votosSeleccionado + 1);
      estado = 'perdida';
    }

    // Pintar la sección según el partido ganador
    const colorGanador = ganador === 'PAN' ? '#007BFF' :
                         ganador === 'PRI' ? '#FF0000' :
                         ganador === 'MORENA' ? '#800020' :
                         ganador === 'PVEM' ? '#008000' : '#AAAAAA';

    layer.setStyle({
      fillColor: colorGanador,
      color: '#333',
      weight: 1.5,
      fillOpacity: 0.6
    });

    resultados.push({
      seccion: props.SECCION,
      ganador,
      votosGanador,
      faltan,
      estado,
      layer
    });
  });

  resultados.sort((a, b) => parseInt(a.seccion) - parseInt(b.seccion));

  resultados.forEach(item => {
    const fila = document.createElement('tr');
    if (item.estado === 'perdida') fila.style.backgroundColor = '#ffe5e5';
    fila.innerHTML = `
      <td>${item.seccion}</td>
      <td>${item.ganador}</td>
      <td>${item.votosGanador.toFixed(0)}</td>
      <td>${Math.ceil(item.faltan)}</td>
    `;
    fila.addEventListener('click', () => {
  map.fitBounds(item.layer.getBounds(), { maxZoom: 15 });

  // Resaltar sección temporalmente
  item.layer.setStyle({ color: '#000', weight: 4, fillOpacity: 0.3 });
  setTimeout(() => capaSecciones.resetStyle(item.layer), 2000);

  // Crear etiqueta flotante en el centro de la sección
  const center = item.layer.getBounds().getCenter();
  const contenido = `
    <div style="font-size:12px; font-weight:bold; text-align:center; color:#333;">
      Sección ${item.seccion}<br>
      Ganador: ${item.ganador} (${item.votosGanador.toFixed(0)} votos)<br>
      ${item.estado === 'perdida' ? `Faltan ${Math.ceil(item.faltan)} votos` : 'Ganada por el partido'}
    </div>
  `;

  // Remover etiquetas previas
  if (window.etiquetaActiva) {
    map.removeLayer(window.etiquetaActiva);
    window.etiquetaActiva = null;
  }

  window.etiquetaActiva = L.marker(center, {
    icon: L.divIcon({
      className: 'etiqueta-seccion',
      html: contenido,
      iconSize: [140, 50],
      iconAnchor: [70, 0]
    })
  }).addTo(map);

  // Ocultar automáticamente la etiqueta después de 5 segundos
  setTimeout(() => {
    if (window.etiquetaActiva) {
      map.removeLayer(window.etiquetaActiva);
      window.etiquetaActiva = null;
    }
  }, 5000);
});

    tbody.appendChild(fila);
  });
}


</script>
<script>
// Función para arrastrar ventanas flotantes con límites de pantalla
function arrastrarVentana(event, ventana) {
  event.preventDefault();

  let posX = event.clientX;
  let posY = event.clientY;

  function mover(e) {
    const dx = e.clientX - posX;
    const dy = e.clientY - posY;

    const rect = ventana.getBoundingClientRect();
    let newLeft = rect.left + dx;
    let newTop = rect.top + dy;

    // Limitar dentro de la ventana del navegador
    const maxLeft = window.innerWidth - rect.width;
    const maxTop = window.innerHeight - rect.height;
    if (newLeft < 0) newLeft = 0;
    if (newTop < 0) newTop = 0;
    if (newLeft > maxLeft) newLeft = maxLeft;
    if (newTop > maxTop) newTop = maxTop;

    ventana.style.left = newLeft + "px";
    ventana.style.top = newTop + "px";

    posX = e.clientX;
    posY = e.clientY;
  }

  function soltar() {
    document.removeEventListener("mousemove", mover);
    document.removeEventListener("mouseup", soltar);
  }

  document.addEventListener("mousemove", mover);
  document.addEventListener("mouseup", soltar);
}
</script>
<!-- AQUI EMPIEZA LA FUNCION CONSULTA HISTORICA POR PUESTO -->
<div class="ventana-flotante" id="ventanaComparativaHistorica" style="display:none; left:420px; top:80px;">
 <div class="ventana-header">
    📊 Comparativa Histórica por Puesto
    <span class="cerrar" onclick="document.getElementById('ventanaComparativaHistorica').style.display='none'">✖</span>
</div> 
 <label for="selector-historico-puesto">Puesto:</label>
    <select id="selector-historico-puesto">
      <option value="A">Ayuntamiento</option>
      <option value="DL">Diputado Local</option>
      <option value="DF">Diputado Federal</option>
      <option value="G">Gobernador</option>
      <option value="S">Senador</option>
      <option value="P">Presidente</option>
    </select>
 

<div class="ventana-body">
<canvas height="240" id="graficaComparativaHistorica"></canvas>
<button class="exportar-btn" id="exportarComparativaHistorica">📥 Exportar PDF</button>
</div>
</div>


<!-- AQUI EMPIEZA LA FUNCION CRUCE DE PUESTOS POR AÑO -->
<div class="ventana-flotante" id="ventanaCrucePuestos" style="display:none; left:420px; top:380px;">
<div class="ventana-header">
    🔄 Cruce de Puestos por Año
    <span class="cerrar" onclick="document.getElementById('ventanaCrucePuestos').style.display='none'">✖</span>
</div>
<div class="ventana-body">
<canvas height="240" id="graficaCrucePuestos"></canvas>
<button class="exportar-btn" id="exportarCrucePuestos">📥 Exportar PDF</button>
</div>
</div>
<!-- AQUI TERMINA LA FUNCION CRUCE DE PUESTOS POR AÑO -->

<!-- === PANEL COMPARATIVA HISTÓRICA POR PARTIDO === -->
<div id="ventanaComparativaPartido">
  <div class="panel-comparativa-partido-header">
    <div class="titulo-panel">📈 Comparativa Histórica por Partido</div>
    <button class="btn-cerrar-partido" onclick="document.getElementById('ventanaComparativaPartido').style.display='none'">✖</button>
  </div>
  <div class="panel-comparativa-partido-cuerpo">
    <label for="selector-partido-comparativa">Selecciona un partido:</label>
    <select id="selector-partido-comparativa" class="selector-comparativa-partido">
      <option value="PAN">PAN</option>
      <option value="PRI">PRI</option>
      <option value="PVEM">PVEM</option>
      <option value="MORENA">MORENA</option>
    </select>

    <button class="btn-ejecutar-partido" onclick="ejecutarComparativaPorPartido()">Mostrar Gráfica</button>
    <div class="mensaje-error-partido" id="mensajeErrorPartido">⚠️ No hay datos disponibles para esta sección.</div>

    <div class="contenedor-grafica-partido">
      <canvas id="graficaComparativaPartido" width="350" height="240"></canvas>
    </div>
  </div>
</div>
<!-- === FIN PANEL COMPARATIVA HISTÓRICA POR PARTIDO === -->

<!-- BOTONES DE ACTIVACIÓN DE FUNCIONES NUEVAS -->
<script>
window.addEventListener("DOMContentLoaded", function() {
  const botones = document.querySelectorAll('.btn-consulta.visuales');
  if (botones.length > 2) {
    botones[2].onclick = ocultarElementosFlotantes;
  }
});
</script>
<!-- AQUI EMPIEZA LA FUNCION EJECUTARCOMPARATIVAHISTORICA -->

<script>
  // Permitir mover ventanas flotantes
  document.querySelectorAll('.ventana-flotante').forEach(ventana => {
    const header = ventana.querySelector('.ventana-header');
    if (header) {
      header.style.cursor = 'move';
      let offsetX, offsetY, isDragging = false;

      header.addEventListener('mousedown', (e) => {
        isDragging = true;
        const rect = ventana.getBoundingClientRect();
        offsetX = e.clientX - rect.left;
        offsetY = e.clientY - rect.top;
      });

      document.addEventListener('mousemove', (e) => {
        if (isDragging) {
          ventana.style.left = `${e.clientX - offsetX}px`;
          ventana.style.top = `${e.clientY - offsetY}px`;
        }
      });

      document.addEventListener('mouseup', () => {
        isDragging = false;
      });
    }
  });
</script>

<script>

function ejecutarComparativaHistorica() {
  const seccion = seccionActiva;
  if (!seccion || !datosElectorales || datosElectorales.length === 0) {
    alert("⚠️ No hay datos disponibles para esta sección.");
    return;
  }

  const datosSeccion = datosElectorales.find(d => d.SECCION === Number(seccion));

  if (!datosSeccion) {
    alert("⚠️ No se encontraron datos electorales para esta sección.");
    return;
  }

  const partidos = ["PAN", "PRI", "PVEM", "MORENA"];
  const anios = ["18", "21", "24"];
  const puesto = document.getElementById("selector-historico-puesto")?.value || "A";

  const datasets = partidos.map(partido => {
    const valores = anios.map(a => {
      const campo = `${a}${puesto}_${partido}`;
      const valor = datosSeccion[campo];
      return valor !== undefined ? valor : 0;
    });

    return {
      label: partido,
      data: valores,
      borderWidth: 2,
      fill: false
    };
  });

  const ctx = document.getElementById("graficaComparativaHistorica")?.getContext("2d");
  if (!ctx) {
    console.warn("⚠️ No se encontró el canvas para la gráfica.");
    return;
  }

  // Si ya existe la gráfica, destruirla
  if (window.graficaComparativaHistorica instanceof Chart) {
    window.graficaComparativaHistorica.destroy();
  }

  // Crear nueva gráfica
  window.graficaComparativaHistorica = new Chart(ctx, {
    type: 'line',
    data: {
      labels: anios.map(a => `20${a}`),
      datasets: datasets
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top' },
        title: { display: true, text: `Histórico por Puesto: ${puesto}` }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 100,
            callback: value => value.toLocaleString()
          }
        }
      }
    }
  });

    const contenedor = document.getElementById('ventanaComparativaHistorica');
    const resizeObserver = new ResizeObserver(() => {
      if (window.graficaComparativaHistorica) {
        window.graficaComparativaHistorica.resize();
      }
});
resizeObserver.observe(contenedor);

}
</script>
<!-- AQUI TERMINA LA FUNCION EJECUTARCOMPARATIVAHISTORICA -->

<script>
  document.getElementById('selector-historico-puesto').addEventListener('change', () => {
    ejecutarComparativaHistorica();
  });
</script>




<!-- AQUI EMPIEZA LA FUNCION EJECUTARCRUCEPUESTOSANIO -->
<script>
function ejecutarCrucePuestosAnio() {
  console.log("Sección activa:", seccion);
  if (!seccion) { alert('Selecciona una sección antes de ejecutar esta consulta.'); return; }
  console.log("Objeto props:", capasPorSeccion[seccion]);


  const ventana = document.getElementById("ventanaCrucePuestos");
  ventana.style.display = "block";

  const ctx = document.getElementById("graficaCrucePuestos").getContext("2d");
  if (window.graficaCrucePuestosObj) {
    window.graficaCrucePuestosObj.destroy();
  }

  let seccion = seccionActiva; // Usando variable global
if (!seccion) {
  alert("Selecciona una sección antes de ejecutar la consulta.");
  return;
}

  const anio = document.getElementById("selector-cruce-anio").value;
  const datos = capasPorSeccion[seccion].props;

  const puestos = ["A", "DL", "DF", "G", "P", "S"];
  const partidos = ["PAN", "PRI", "PVEM", "PT", "MC", "MORENA", "PES", "RSP", "FXM", "IND", "NA"];

  const datasets = partidos.map(partido => {
    return {
      label: partido,
      data: puestos.map(puesto => datos[`${anio}${puesto}_${partido}`] || 0),
      backgroundColor: 'rgba(0, 0, 255, 0.2)',
      borderColor: 'rgba(0, 0, 255, 1)',
      borderWidth: 1
    };
  });


  window.graficaCrucePuestosObj = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: puestos,
      datasets: datasets
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' },
        tooltip: { mode: 'index', intersect: false }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}
</script>
<!-- AQUI TERMINA LA FUNCION EJECUTARCRUCEPUESTOSANIO -->
<!-- VINCULACIÓN DE BOTONES A FUNCIONES DE CONSULTA -->
<script>
window.addEventListener('load', () => {
  const botones = document.querySelectorAll('.btn-consulta.comparativas');

  // Botón 0: Histórica por Puesto
  if (botones[0]) {
    botones[0].onclick = function () {
    // Cerrar otras ventanas flotantes
    document.querySelectorAll('.ventana-flotante').forEach(v => v.style.display = 'none');

    // Mostrar la ventana flotante correspondiente
    const ventana = document.getElementById('ventanaComparativaHistorica');
    if (ventana) ventana.style.display = 'block';
    else console.warn('❗ No se encontró la ventana con ID: ventanaComparativaHistorica');

    // Ejecutar función principal
    ejecutarComparativaHistorica();
  };

  }

  // Botón 1: Cruce de Puestos por Año
  if (botones[1]) {
    botones[1].onclick = function () {
      document.querySelectorAll('.ventana-flotante').forEach(v => v.style.display = 'none');
      ejecutarCrucePuestosAnio();
    };
  }

    // ✅ Botón 2: Comparativa Histórica por Partido
  if (botones[2]) {
    botones[2].onclick = function () {
      document.querySelectorAll('.ventana-flotante').forEach(v => v.style.display = 'none');
      ejecutarComparativaPorPartido();
    };
  }

  hacerVentanaPartidoMovible(); // Hacer la ventana movible

});
</script>

<div id="ventanaComparativaPartido" class="ventana-flotante" style="display: none;">
  <div class="panel-comparativa-partido-header">
    <span class="titulo-panel">📊 Comparativa Histórica por Partido</span>
    <button class="btn-cerrar-partido" onclick="document.getElementById('ventanaComparativaPartido').style.display='none'">✖</button>
  </div>

  <div class="panel-comparativa-partido-cuerpo">
    <label for="selectorPartido">Partido político:</label>
    <select id="selectorPartidoPartido" class="selector-comparativa-partido">
      <option value="PAN">PAN</option>
      <option value="PRI">PRI</option>
      <option value="PVEM">PVEM</option>
      <option value="MORENA">MORENA</option>
    </select>

    <label for="selectorAnioPartido">Año:</label>
    <select id="selectorAnioPartido" class="selector-comparativa-partido">
      <option value="18">2018</option>
      <option value="21">2021</option>
      <option value="24">2024</option>
    </select>

    <label for="selectorPuestoPartido">Puesto a comparar:</label>
    <select id="selectorPuestoPartido" class="selector-comparativa-partido">
      <option value="A">Ayuntamiento</option>
      <option value="DL">Diputado Local</option>
      <option value="DF">Diputado Federal</option>
      <option value="G">Gobernador</option>
      <option value="S">Senador</option>
      <option value="P">Presidente</option>
    </select>

    <button id="btnEjecutarComparativaPartido" class="btn-ejecutar-partido">📈 Ejecutar Comparativa</button>

    <div id="mensajeErrorComparativaPartido" class="mensaje-error-partido">Primero seleccione una sección en el mapa.</div>

    <div id="contenedorGraficaComparativaPartido" class="contenedor-grafica-partido"></div>
  </div>
</div>
<script>
      function ejecutarComparativaPorPartido() {
        const panel = document.getElementById('ventanaComparativaPartido');
        panel.style.display = 'block';

        const seccion = window.seccionActiva;
        const partido = document.getElementById('selector-partido-comparativa').value;
        const mensajeError = document.getElementById('mensajeErrorPartido');

        if (!seccion || !datosElectorales) {
          mensajeError.style.display = 'block';
          return;
        }

        // Buscar los datos de la sección activa
        const datos = datosElectorales.find(d => d.SECCION === parseInt(seccion));

        if (!datos) {
          mensajeError.style.display = 'block';
          return;
        }

        mensajeError.style.display = 'none';

        // Preparar datos para la gráfica
        const labels = ['2018', '2021', '2024'];
        const valores = [
          datos[`18A_${partido}`] || 0,
          datos[`21A_${partido}`] || 0,
          datos[`24A_${partido}`] || 0
        ];

        // Destruir gráfica anterior si existe
        if (window.graficaComparativaPartido) {
          window.graficaComparativaPartido.destroy();
        }

        const ctx = document.getElementById('graficaComparativaPartido').getContext('2d');
        window.graficaComparativaPartido = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: `Votos del ${partido}`,
              data: valores,
              borderColor: '#880e4f',
              backgroundColor: 'rgba(136, 14, 79, 0.2)',
              tension: 0.3,
              fill: true,
              pointRadius: 5,
              pointHoverRadius: 7
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: true },
              tooltip: { mode: 'index', intersect: false }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 50
                }
              }
            }
          }
        });
      }
</script>
<script>

// Permitir mover ventana flotante de Comparativa Histórica por Partido
function hacerVentanaPartidoMovible() {
  const ventana = document.getElementById('ventanaComparativaPartido');
  const header = ventana.querySelector('.panel-comparativa-partido-header');
  let offsetX = 0, offsetY = 0, isDragging = false;

  header.style.cursor = 'move';

  header.addEventListener('mousedown', function (e) {
    isDragging = true;
    offsetX = e.clientX - ventana.offsetLeft;
    offsetY = e.clientY - ventana.offsetTop;
    document.body.style.userSelect = 'none';
  });

  document.addEventListener('mousemove', function (e) {
    if (isDragging) {
      ventana.style.left = (e.clientX - offsetX) + 'px';
      ventana.style.top = (e.clientY - offsetY) + 'px';
    }
  });

  document.addEventListener('mouseup', function () {
    isDragging = false;
    document.body.style.userSelect = 'auto';
  });
}
</script>

<script>
  function ejecutarComparativaHistoricaPartido() {
    const seccionActiva = window.seccionActiva;
    const partidoSeleccionado = document.getElementById('selector-comparativa-partido')?.value;

    const contenedor = document.getElementById('graficaComparativaPartido');
    const mensajeError = document.getElementById('mensaje-error-partido');

    // Validar si hay sección y partido seleccionados
    if (!seccionActiva || !partidoSeleccionado) {
      mensajeError.style.display = 'block';
      mensajeError.textContent = 'Debe seleccionarse una sección y un partido válido.';
      return;
    }

    // Buscar datos de la sección activa
    const datosSeccion = datosElectorales.find(d => d.SECCION === parseInt(seccionActiva));
    if (!datosSeccion) {
      mensajeError.style.display = 'block';
      mensajeError.textContent = 'No hay datos disponibles para esta sección.';
      return;
    }

    mensajeError.style.display = 'none'; // Ocultar mensaje de error

    // Extraer votos por año para el partido seleccionado (puesto: Diputado Local)
    const votos = {
      '2018': datosSeccion[`18DL_${partidoSeleccionado}`] ?? 0,
      '2021': datosSeccion[`21DL_${partidoSeleccionado}`] ?? 0,
      '2024': datosSeccion[`24DL_${partidoSeleccionado}`] ?? 0,
      '2027': datosSeccion[`PROY_2027_DL_${partidoSeleccionado}`] ?? 0
    };


    
    const ctx = contenedor.getContext('2d');

    // Destruir gráfica anterior si existe
    if (window.graficaComparativaPartido) {
      window.graficaComparativaPartido.destroy();
    }

    // Crear nueva gráfica
    window.graficaComparativaPartido = new Chart(ctx, {
      type: 'line',
      data: {
        labels: Object.keys(votos),
        datasets: [{
          label: `Votos para ${partidoSeleccionado} (Diputado Local)`,
          data: Object.values(votos),
          borderColor: '#880e4f',
          backgroundColor: 'rgba(136, 14, 79, 0.1)',
          fill: true,
          tension: 0.3,
          pointRadius: 5,
          pointBackgroundColor: '#880e4f'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: true },
          tooltip: { mode: 'index', intersect: false }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function (value) {
                return value.toLocaleString(); // separador de miles
              }
            }
          }
        }
      }
    });
  }
</script>



<script>
  document.addEventListener('DOMContentLoaded', function () {
    const botonPartido = document.getElementById('btnEjecutarComparativaPartido');
    if (botonPartido) {
      botonPartido.addEventListener('click', function () {
        console.log('✅ Ejecutando gráfica COMPARATIVA HISTÓRICA POR PARTIDO');
        GraficaComparativaPartido(); // función correcta
      });
    } else {
      console.warn('⚠️ Botón no encontrado');
    }
  });
</script>




</body>
</html>
